<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Proposal Generator ‚Äî Kande VendTech</title>
  <style>
    :root { --accent:#3182ce; --bg:#f7fafc; --card:#fff; --text:#1a202c; --muted:#718096; --border:#e2e8f0; --success:#38a169; --purple:#6B2FA0; --gold:#D4A843; }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); line-height: 1.5; }
    .app { max-width: 1600px; margin: 0 auto; padding: 24px 20px 60px; }
    h1 { font-size: 1.5rem; font-weight: 700; margin-bottom: 4px; }
    .subtitle { color: var(--muted); font-size: 0.9rem; margin-bottom: 20px; }

    /* Layout */
    .gen-layout { display: grid; grid-template-columns: 420px 1fr; gap: 24px; align-items: start; }
    @media (max-width: 1100px) { .gen-layout { grid-template-columns: 1fr; } }

    /* Form panel */
    .form-panel { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 24px; position: sticky; top: 68px; max-height: calc(100vh - 84px); overflow-y: auto; }
    .form-panel h2 { font-size: 1.05rem; font-weight: 600; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
    .form-section { margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid var(--border); }
    .form-section:last-child { border-bottom: none; margin-bottom: 0; }
    .form-section h3 { font-size: 0.85rem; font-weight: 600; color: var(--purple); text-transform: uppercase; letter-spacing: 0.04em; margin-bottom: 12px; }

    .field { margin-bottom: 12px; }
    .field label { display: block; font-size: 0.8rem; font-weight: 600; color: var(--muted); margin-bottom: 4px; }
    .field input, .field select, .field textarea {
      width: 100%; padding: 8px 12px; border: 1px solid var(--border); border-radius: 8px;
      font-size: 0.88rem; font-family: inherit; background: #fff; color: var(--text); transition: border-color 0.2s;
    }
    .field input:focus, .field select:focus, .field textarea:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px rgba(49,130,206,0.1); }
    .field textarea { resize: vertical; min-height: 70px; }
    .field-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .field-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }

    /* CRM dropdown */
    .crm-select { margin-bottom: 20px; }
    .crm-select select { font-weight: 600; border-color: var(--purple); background: #faf5ff; }

    /* Action buttons */
    .actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 16px; }
    .btn { padding: 10px 20px; border: none; border-radius: 8px; font-size: 0.88rem; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 6px; transition: all 0.2s; }
    .btn-primary { background: var(--purple); color: #fff; }
    .btn-primary:hover { background: #5a2688; }
    .btn-pdf { background: var(--accent); color: #fff; }
    .btn-pdf:hover { background: #2c6cb0; }
    .btn-save { background: var(--success); color: #fff; }
    .btn-save:hover { background: #2f8a59; }
    .btn-outline { background: #fff; color: var(--text); border: 1px solid var(--border); }
    .btn-outline:hover { background: var(--bg); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }

    /* Toast */
    .toast { position: fixed; bottom: 24px; right: 24px; background: var(--success); color: #fff; padding: 12px 24px; border-radius: 10px; font-weight: 600; font-size: 0.9rem; z-index: 10000; box-shadow: 0 4px 20px rgba(0,0,0,0.15); transform: translateY(100px); opacity: 0; transition: all 0.3s; }
    .toast.show { transform: translateY(0); opacity: 1; }
    .toast.error { background: #e53e3e; }

    /* Preview panel */
    .preview-panel { background: var(--card); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
    .preview-header { display: flex; align-items: center; justify-content: space-between; padding: 12px 20px; border-bottom: 1px solid var(--border); background: #fafafa; }
    .preview-header h2 { font-size: 0.95rem; font-weight: 600; display: flex; align-items: center; gap: 8px; }
    .preview-tabs { display: flex; gap: 4px; }
    .preview-tab { padding: 5px 14px; border-radius: 6px; font-size: 0.8rem; font-weight: 500; cursor: pointer; background: transparent; border: 1px solid transparent; color: var(--muted); transition: all 0.15s; }
    .preview-tab.active { background: var(--accent); color: #fff; border-color: var(--accent); }
    .preview-tab:hover:not(.active) { background: var(--bg); }
    .preview-frame-wrap { position: relative; background: #E8E0EE; overflow: auto; }
    .preview-frame-wrap iframe { border: none; width: 100%; display: block; }

    /* Saved proposals list */
    .saved-list { margin-top: 20px; }
    .saved-item { display: flex; align-items: center; justify-content: space-between; padding: 10px 14px; background: #fafafa; border-radius: 8px; margin-bottom: 6px; font-size: 0.85rem; border: 1px solid var(--border); }
    .saved-item .name { font-weight: 600; }
    .saved-item .date { color: var(--muted); font-size: 0.78rem; }
    .saved-item .load-btn { font-size: 0.78rem; color: var(--accent); cursor: pointer; font-weight: 600; background: none; border: none; }

    /* Print styles ‚Äî hide everything except the preview */
    @media print {
      body { background: white !important; }
      .app > *:not(.gen-layout) { display: none !important; }
      .form-panel, .preview-header, #kv-nav, #kv-nav-mobile, .toast { display: none !important; }
      .gen-layout { display: block !important; }
      .preview-panel { border: none !important; box-shadow: none !important; }
      .preview-frame-wrap { overflow: visible !important; background: white !important; }
      .preview-frame-wrap iframe { display: none !important; }
      #print-target { display: block !important; }
    }
  </style>
</head>
<body>
<div class="app">
  <h1>üìù Proposal Generator</h1>
  <p class="subtitle">Create customized proposals from the template, preview live, generate PDF, and save to CRM.</p>

  <div class="gen-layout">
    <!-- LEFT: Form -->
    <div class="form-panel">
      <h2>üìã Proposal Details</h2>

      <!-- CRM Auto-populate -->
      <div class="crm-select">
        <div class="field">
          <label>Auto-populate from CRM</label>
          <select id="crmProspect" onchange="loadFromCRM()">
            <option value="">‚Äî Select a prospect ‚Äî</option>
          </select>
        </div>
      </div>

      <!-- Property Info -->
      <div class="form-section">
        <h3>üè¢ Property Information</h3>
        <div class="field">
          <label>Property Name *</label>
          <input type="text" id="propertyName" placeholder="The Elysian at Green Valley" oninput="updatePreview()">
        </div>
        <div class="field">
          <label>Property Address</label>
          <input type="text" id="propertyAddress" placeholder="1234 Green Valley Pkwy, Henderson, NV" oninput="updatePreview()">
        </div>
        <div class="field-row">
          <div class="field">
            <label>Property Type</label>
            <select id="propertyType" onchange="updatePreview()">
              <option value="luxury apartment community">Apartment</option>
              <option value="healthcare facility">Healthcare</option>
              <option value="office building">Office</option>
              <option value="senior living community">Senior Living</option>
              <option value="fitness center">Gym</option>
              <option value="hotel & hospitality venue">Hotel</option>
            </select>
          </div>
          <div class="field">
            <label>Units / Employees</label>
            <input type="number" id="unitCount" placeholder="250" oninput="updatePreview()">
          </div>
        </div>
      </div>

      <!-- Contact Info -->
      <div class="form-section">
        <h3>üë§ Contact</h3>
        <div class="field-row">
          <div class="field">
            <label>Contact Name</label>
            <input type="text" id="contactName" placeholder="Sarah Chen" oninput="updatePreview()">
          </div>
          <div class="field">
            <label>Title</label>
            <input type="text" id="contactTitle" placeholder="Property Manager" oninput="updatePreview()">
          </div>
        </div>
      </div>

      <!-- Machine Deployment -->
      <div class="form-section">
        <h3>ü§ñ Deployment</h3>
        <div class="field-row">
          <div class="field">
            <label>Machines Proposed</label>
            <input type="number" id="machineCount" value="2" min="1" max="20" oninput="updatePreview()">
          </div>
          <div class="field">
            <label>Revenue Share %</label>
            <input type="number" id="revenueShare" value="10" min="0" max="50" step="0.5" oninput="updatePreview()">
          </div>
        </div>
      </div>

      <!-- Revenue Projections -->
      <div class="form-section">
        <h3>üí∞ Monthly Revenue Projections</h3>
        <div class="field-row-3">
          <div class="field">
            <label>Conservative ($)</label>
            <input type="number" id="revConservative" placeholder="2400" oninput="updatePreview()">
          </div>
          <div class="field">
            <label>Target ($)</label>
            <input type="number" id="revTarget" placeholder="4000" oninput="updatePreview()">
          </div>
          <div class="field">
            <label>Optimistic ($)</label>
            <input type="number" id="revOptimistic" placeholder="6000" oninput="updatePreview()">
          </div>
        </div>
        <div class="field-row-3" style="margin-top:4px;">
          <div class="field">
            <label>Conservative Txns/Day</label>
            <input type="number" id="txnConservative" value="15" oninput="updatePreview()">
          </div>
          <div class="field">
            <label>Target Txns/Day</label>
            <input type="number" id="txnTarget" value="25" oninput="updatePreview()">
          </div>
          <div class="field">
            <label>Optimistic Txns/Day</label>
            <input type="number" id="txnOptimistic" value="40" oninput="updatePreview()">
          </div>
        </div>
        <div class="field">
          <label>Avg Transaction Value ($)</label>
          <input type="number" id="avgTransaction" value="3.75" step="0.25" oninput="updatePreview()">
        </div>
      </div>

      <!-- Custom Notes -->
      <div class="form-section">
        <h3>üìù Custom Notes</h3>
        <div class="field">
          <label>Notes (included in proposal)</label>
          <textarea id="customNotes" placeholder="Any custom messaging for this prospect..."></textarea>
        </div>
      </div>

      <!-- Actions -->
      <div class="actions">
        <button class="btn btn-pdf" onclick="generatePDF()">üñ®Ô∏è Generate PDF</button>
        <button class="btn btn-save" onclick="saveToCRM()">üíæ Save to CRM</button>
        <button class="btn btn-outline" onclick="resetForm()">üîÑ Reset</button>
      </div>

      <!-- Saved proposals -->
      <div class="saved-list" id="savedList"></div>
    </div>

    <!-- RIGHT: Preview -->
    <div class="preview-panel">
      <div class="preview-header">
        <h2>üëÅÔ∏è Live Preview</h2>
        <div class="preview-tabs">
          <div class="preview-tab active" onclick="setPreviewScale(0.55)">Fit</div>
          <div class="preview-tab" onclick="setPreviewScale(0.75)">75%</div>
          <div class="preview-tab" onclick="setPreviewScale(1)">100%</div>
        </div>
      </div>
      <div class="preview-frame-wrap" id="previewWrap" style="height: calc(100vh - 160px);">
        <iframe id="previewFrame" style="transform-origin: top left;"></iframe>
      </div>
    </div>
  </div>
</div>

<!-- Hidden print target -->
<div id="print-target" style="display:none;"></div>

<div class="toast" id="toast"></div>

<script>
// ===== State =====
let templateHTML = '';
let currentScale = 0.55;
let prospects = [];
let savedProposals = [];
let selectedProspectId = null;

// ===== Init =====
async function init() {
  await Promise.all([loadTemplate(), loadProspects(), loadSavedProposals()]);
  // Set default dates
  const today = new Date();
  const expiry = new Date(today);
  expiry.setDate(expiry.getDate() + 30);
  updatePreview();
}

// ===== Load template from the sales materials =====
async function loadTemplate() {
  try {
    const res = await fetch('/api/proposal-template');
    if (res.ok) {
      templateHTML = await res.text();
    } else {
      templateHTML = '<html><body><h1>Template not found</h1><p>Place proposal-template.html in sales/materials/</p></body></html>';
    }
  } catch (e) {
    templateHTML = '<html><body><h1>Error loading template</h1></body></html>';
  }
}

// ===== Load CRM prospects =====
async function loadProspects() {
  try {
    const res = await fetch('/api/prospects');
    prospects = await res.json();
    const sel = document.getElementById('crmProspect');
    prospects.sort((a, b) => a.name.localeCompare(b.name)).forEach(p => {
      const opt = document.createElement('option');
      opt.value = p.id;
      const badge = p.status === 'signed' ? '‚úÖ' : p.priority === 'hot' ? 'üî•' : p.priority === 'warm' ? 'üü†' : '';
      opt.textContent = `${badge} ${p.name}${p.property_type ? ' ‚Äî ' + p.property_type : ''}`;
      sel.appendChild(opt);
    });
  } catch (e) { console.error('Failed to load prospects:', e); }
}

// ===== Auto-populate from CRM =====
function loadFromCRM() {
  const id = parseInt(document.getElementById('crmProspect').value);
  if (!id) return;
  const p = prospects.find(pr => pr.id === id);
  if (!p) return;
  selectedProspectId = id;

  document.getElementById('propertyName').value = p.name || '';
  document.getElementById('propertyAddress').value = p.address || '';
  
  // Map property type
  const typeMap = {
    'apartments': 'luxury apartment community',
    'apartment': 'luxury apartment community',
    'multifamily': 'luxury apartment community',
    'healthcare': 'healthcare facility',
    'hospital': 'healthcare facility',
    'office': 'office building',
    'senior_living': 'senior living community',
    'senior living': 'senior living community',
    'gym': 'fitness center',
    'fitness': 'fitness center',
    'hotel': 'hotel & hospitality venue',
    'hospitality': 'hotel & hospitality venue'
  };
  const pt = (p.property_type || '').toLowerCase();
  const mapped = typeMap[pt] || typeMap[Object.keys(typeMap).find(k => pt.includes(k))] || '';
  if (mapped) {
    const sel = document.getElementById('propertyType');
    for (let i = 0; i < sel.options.length; i++) {
      if (sel.options[i].value === mapped) { sel.selectedIndex = i; break; }
    }
  }

  document.getElementById('unitCount').value = p.units || '';

  // Fill contact from primary contact
  const pc = p.primary_contact || (p.contacts && p.contacts[0]);
  if (pc) {
    if (typeof pc === 'string') {
      document.getElementById('contactName').value = pc;
    } else {
      document.getElementById('contactName').value = pc.name || '';
      document.getElementById('contactTitle').value = pc.role || pc.title || '';
    }
  }

  updatePreview();
  showToast('‚úÖ Loaded from CRM: ' + p.name);
}

// ===== Gather form data =====
function getFormData() {
  const share = parseFloat(document.getElementById('revenueShare').value) || 10;
  const machines = parseInt(document.getElementById('machineCount').value) || 2;
  const avgTxn = parseFloat(document.getElementById('avgTransaction').value) || 3.75;
  const conservative = parseFloat(document.getElementById('revConservative').value) || 0;
  const target = parseFloat(document.getElementById('revTarget').value) || 0;
  const optimistic = parseFloat(document.getElementById('revOptimistic').value) || 0;
  const txnCon = parseInt(document.getElementById('txnConservative').value) || 15;
  const txnTar = parseInt(document.getElementById('txnTarget').value) || 25;
  const txnOpt = parseInt(document.getElementById('txnOptimistic').value) || 40;

  // Auto-calc monthly gross if not manually entered
  const calcGross = (txns) => Math.round(txns * avgTxn * 30 * machines);
  const conGross = conservative || calcGross(txnCon);
  const tarGross = target || calcGross(txnTar);
  const optGross = optimistic || calcGross(txnOpt);

  const today = new Date();
  const expiry = new Date(today);
  expiry.setDate(expiry.getDate() + 30);
  const fmt = (d) => d.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
  const proposalNum = 'KVT-' + today.getFullYear() + '-' + String(Math.floor(Math.random() * 900) + 100);

  return {
    propertyName: document.getElementById('propertyName').value || '{{Property Name}}',
    propertyAddress: document.getElementById('propertyAddress').value || '',
    propertyType: document.getElementById('propertyType').value || 'luxury apartment community',
    unitCount: document.getElementById('unitCount').value || '',
    contactName: document.getElementById('contactName').value || '{{Property Contact Name}}',
    contactTitle: document.getElementById('contactTitle').value || '',
    machineCount: machines,
    revenueShare: share,
    kandeShare: 100 - share,
    proposalDate: fmt(today),
    expirationDate: fmt(expiry),
    proposalNumber: proposalNum,
    avgTransaction: avgTxn.toFixed(2),
    txnConservative: txnCon,
    txnTarget: txnTar,
    txnOptimistic: txnOpt,
    conservativeGross: conGross,
    targetGross: tarGross,
    optimisticGross: optGross,
    conservativeShare: Math.round(conGross * share / 100),
    targetShare: Math.round(tarGross * share / 100),
    optimisticShare: Math.round(optGross * share / 100),
    conservativeAnnual: Math.round(conGross * 12 * share / 100),
    targetAnnual: Math.round(tarGross * 12 * share / 100),
    optimisticAnnual: Math.round(optGross * 12 * share / 100),
    customNotes: document.getElementById('customNotes').value || ''
  };
}

// ===== Replace tokens in template =====
function fillTemplate(data) {
  let html = templateHTML;
  const currency = (n) => n.toLocaleString('en-US');

  const replacements = {
    '{{Property Name}}': data.propertyName,
    '{{Property Type}}': data.propertyType,
    '{{Property Contact Name}}': data.contactName,
    '{{Proposal Date}}': data.proposalDate,
    '{{Expiration Date}}': data.expirationDate,
    '{{Proposal Number}}': data.proposalNumber,
    '{{Revenue Share %}}': data.revenueShare,
    '{{Kande Share %}}': data.kandeShare,
    '{{Total Qty}}': data.machineCount,
    '{{Estimated Daily Transactions}}': data.txnTarget,
    '{{Avg Transaction}}': data.avgTransaction,
    '{{Conservative Daily Txns}}': data.txnConservative,
    '{{Moderate Daily Txns}}': data.txnTarget,
    '{{Optimistic Daily Txns}}': data.txnOptimistic,
    '{{Conservative Monthly Gross}}': currency(data.conservativeGross),
    '{{Moderate Monthly Gross}}': currency(data.targetGross),
    '{{Optimistic Monthly Gross}}': currency(data.optimisticGross),
    '{{Conservative Property Share}}': currency(data.conservativeShare),
    '{{Moderate Property Share}}': currency(data.targetShare),
    '{{Optimistic Property Share}}': currency(data.optimisticShare),
    '{{Conservative Annual}}': currency(data.conservativeAnnual),
    '{{Moderate Annual}}': currency(data.targetAnnual),
    '{{Optimistic Annual}}': currency(data.optimisticAnnual),
    // Defaults for fields not in the form
    '{{Term Length ‚Äî e.g., 3 years}}': '3 years',
    '{{Renewal Terms ‚Äî e.g., automatic 1-year renewals}}': 'automatic 1-year renewals',
    '{{Payment Frequency ‚Äî e.g., monthly, by the 15th of the following month}}': 'monthly, by the 15th of the following month',
    '{{Payment Frequency ‚Äî e.g., Monthly, by the 15th of the following month}}': 'Monthly, by the 15th of the following month',
    '{{Termination Notice ‚Äî e.g., 60 days}}': '60 days',
    '{{Exclusivity Terms ‚Äî e.g., Non-exclusive / Exclusive within designated areas}}': 'Non-exclusive',
    '{{Restock Frequency ‚Äî e.g., 2‚Äì3√ó per week minimum}}': '2‚Äì3√ó per week minimum',
    '{{Maintenance SLA ‚Äî e.g., 24 hours}}': '24 hours',
    '{{On-Site SLA ‚Äî e.g., 4 hours}}': '4 hours',
    '{{Required Space ‚Äî e.g., 3ft √ó 3ft}}': '3ft √ó 3ft',
    '{{Machine Dimensions ‚Äî e.g., 72"H √ó 26"W √ó 29"D}}': '72"H √ó 26"W √ó 29"D',
    '{{Capacity ‚Äî e.g., 150‚Äì200 items}}': '150‚Äì200 items',
    '{{CEO Bio ‚Äî e.g., Kurtis brings a background in operations management, technology, and entrepreneurship to Kande VendTech. Based in Las Vegas, he is personally involved in every property partnership, ensuring white-glove service from first conversation to ongoing operations.}}': 'Kurtis brings a background in operations management, technology, and entrepreneurship to Kande VendTech. Based in Las Vegas, he is personally involved in every property partnership, ensuring white-glove service from first conversation to ongoing operations.'
  };

  for (const [token, value] of Object.entries(replacements)) {
    html = html.split(token).join(value);
  }

  // Replace {{Qty}} tokens generically (for location table rows)
  html = html.split('{{Qty}}').join('1');

  return html;
}

// ===== Update preview =====
let previewTimeout;
function updatePreview() {
  clearTimeout(previewTimeout);
  previewTimeout = setTimeout(() => {
    const data = getFormData();
    const html = fillTemplate(data);
    const iframe = document.getElementById('previewFrame');
    iframe.srcdoc = html;
    applyScale(currentScale);
  }, 150);
}

// ===== Scale preview =====
function setPreviewScale(scale) {
  currentScale = scale;
  applyScale(scale);
  document.querySelectorAll('.preview-tab').forEach((t, i) => {
    t.classList.toggle('active', [0.55, 0.75, 1][i] === scale);
  });
}

function applyScale(scale) {
  const iframe = document.getElementById('previewFrame');
  const wrap = document.getElementById('previewWrap');
  // At 100% the template is 8.5in wide (816px)
  const templateWidth = 816;
  const availableWidth = wrap.clientWidth;
  
  if (scale === 0.55) {
    // Fit to container
    const fitScale = Math.min(availableWidth / templateWidth, 0.7);
    iframe.style.transform = `scale(${fitScale})`;
    iframe.style.width = templateWidth + 'px';
    iframe.style.height = '11000px'; // Tall enough for all pages
    wrap.style.height = Math.round(11000 * fitScale) + 'px';
  } else {
    iframe.style.transform = `scale(${scale})`;
    iframe.style.width = Math.round(templateWidth / scale) + 'px';
    iframe.style.height = Math.round(11000 / scale) + 'px';
    wrap.style.height = 'calc(100vh - 160px)';
  }
}

// ===== Generate PDF via print =====
function generatePDF() {
  const data = getFormData();
  const html = fillTemplate(data);
  const printWin = window.open('', '_blank');
  printWin.document.write(html);
  printWin.document.close();
  printWin.onload = () => {
    setTimeout(() => printWin.print(), 500);
  };
}

// ===== Save to CRM =====
async function saveToCRM() {
  const data = getFormData();
  if (!data.propertyName || data.propertyName === '{{Property Name}}') {
    showToast('‚ö†Ô∏è Enter a property name first', true);
    return;
  }

  const payload = {
    prospect_id: selectedProspectId || null,
    property_name: data.propertyName,
    property_address: data.propertyAddress,
    property_type: data.propertyType,
    unit_count: data.unitCount,
    contact_name: data.contactName,
    contact_title: data.contactTitle,
    machine_count: data.machineCount,
    revenue_share: data.revenueShare,
    revenue_conservative: data.conservativeGross,
    revenue_target: data.targetGross,
    revenue_optimistic: data.optimisticGross,
    avg_transaction: parseFloat(data.avgTransaction),
    txn_conservative: data.txnConservative,
    txn_target: data.txnTarget,
    txn_optimistic: data.txnOptimistic,
    custom_notes: data.customNotes,
    proposal_number: data.proposalNumber,
    proposal_date: data.proposalDate,
    expiration_date: data.expirationDate
  };

  try {
    const res = await fetch('/api/proposals', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    const result = await res.json();
    if (res.ok) {
      showToast('‚úÖ Proposal saved to CRM! #' + data.proposalNumber);
      await loadSavedProposals();
    } else {
      showToast('‚ùå ' + (result.error || 'Save failed'), true);
    }
  } catch (e) {
    showToast('‚ùå Network error', true);
  }
}

// ===== Load saved proposals =====
async function loadSavedProposals() {
  try {
    const res = await fetch('/api/proposals');
    savedProposals = await res.json();
    renderSavedList();
  } catch (e) { /* ignore */ }
}

function renderSavedList() {
  const el = document.getElementById('savedList');
  if (savedProposals.length === 0) { el.innerHTML = ''; return; }
  
  el.innerHTML = '<h3 style="font-size:0.85rem;font-weight:600;color:var(--purple);margin-bottom:8px;">üìÅ Saved Proposals (' + savedProposals.length + ')</h3>' +
    savedProposals.slice(0, 10).map(p => `
      <div class="saved-item">
        <div>
          <div class="name">${esc(p.property_name)}</div>
          <div class="date">${p.proposal_number || ''} ¬∑ ${new Date(p.created_at).toLocaleDateString()}</div>
        </div>
        <button class="load-btn" onclick="loadProposal(${p.id})">Load ‚Üí</button>
      </div>
    `).join('');
}

// ===== Load a saved proposal back into the form =====
async function loadProposal(id) {
  try {
    const res = await fetch('/api/proposals/' + id);
    const p = await res.json();
    if (!res.ok) return showToast('‚ùå Not found', true);

    document.getElementById('propertyName').value = p.property_name || '';
    document.getElementById('propertyAddress').value = p.property_address || '';
    document.getElementById('contactName').value = p.contact_name || '';
    document.getElementById('contactTitle').value = p.contact_title || '';
    document.getElementById('unitCount').value = p.unit_count || '';
    document.getElementById('machineCount').value = p.machine_count || 2;
    document.getElementById('revenueShare').value = p.revenue_share || 10;
    document.getElementById('revConservative').value = p.revenue_conservative || '';
    document.getElementById('revTarget').value = p.revenue_target || '';
    document.getElementById('revOptimistic').value = p.revenue_optimistic || '';
    document.getElementById('avgTransaction').value = p.avg_transaction || 3.75;
    document.getElementById('txnConservative').value = p.txn_conservative || 15;
    document.getElementById('txnTarget').value = p.txn_target || 25;
    document.getElementById('txnOptimistic').value = p.txn_optimistic || 40;
    document.getElementById('customNotes').value = p.custom_notes || '';
    selectedProspectId = p.prospect_id || null;

    // Set property type
    if (p.property_type) {
      const sel = document.getElementById('propertyType');
      for (let i = 0; i < sel.options.length; i++) {
        if (sel.options[i].value === p.property_type) { sel.selectedIndex = i; break; }
      }
    }

    // Set CRM dropdown
    if (p.prospect_id) {
      document.getElementById('crmProspect').value = p.prospect_id;
    }

    updatePreview();
    showToast('‚úÖ Loaded: ' + p.property_name);
  } catch (e) {
    showToast('‚ùå Error loading proposal', true);
  }
}

// ===== Reset =====
function resetForm() {
  document.getElementById('propertyName').value = '';
  document.getElementById('propertyAddress').value = '';
  document.getElementById('contactName').value = '';
  document.getElementById('contactTitle').value = '';
  document.getElementById('unitCount').value = '';
  document.getElementById('machineCount').value = 2;
  document.getElementById('revenueShare').value = 10;
  document.getElementById('revConservative').value = '';
  document.getElementById('revTarget').value = '';
  document.getElementById('revOptimistic').value = '';
  document.getElementById('avgTransaction').value = 3.75;
  document.getElementById('txnConservative').value = 15;
  document.getElementById('txnTarget').value = 25;
  document.getElementById('txnOptimistic').value = 40;
  document.getElementById('customNotes').value = '';
  document.getElementById('crmProspect').value = '';
  document.getElementById('propertyType').selectedIndex = 0;
  selectedProspectId = null;
  updatePreview();
}

// ===== Helpers =====
function esc(s) { return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

function showToast(msg, isError) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'toast show' + (isError ? ' error' : '');
  setTimeout(() => t.className = 'toast', 3000);
}

// ===== Kick off =====
init();

// Resize handler
window.addEventListener('resize', () => applyScale(currentScale));
</script>
<script src="/nav.js"></script>
</body>
</html>
