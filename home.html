<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-vend-32.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-vend.png">
  <title>Kande VendTech ‚Äî Executive Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg: #f8fafc; --card: #ffffff; --border: #e2e8f0; --text: #0f172a;
      --muted: #64748b; --accent: #3b82f6; --accent-light: #eff6ff;
      --green: #22c55e; --green-light: #f0fdf4;
      --amber: #f59e0b; --amber-light: #fffbeb;
      --red: #ef4444; --red-light: #fef2f2;
      --purple: #8b5cf6; --purple-light: #f5f3ff;
      --teal: #14b8a6; --teal-light: #f0fdfa;
      --radius: 12px;
      --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
      --shadow: 0 4px 12px rgba(0,0,0,0.06);
    }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); line-height: 1.5; }
    .dashboard { max-width: 1400px; margin: 0 auto; padding: 20px 24px 60px; }

    /* Welcome Banner */
    .welcome-banner {
      background: linear-gradient(135deg, #1e3a5f 0%, #2563eb 50%, #7c3aed 100%);
      border-radius: 16px; padding: 28px 32px; color: #fff; margin-bottom: 24px;
      position: relative; overflow: hidden; display: flex; justify-content: space-between; align-items: flex-start;
    }
    .welcome-banner::after {
      content: ''; position: absolute; top: -50%; right: -5%; width: 300px; height: 300px;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
      border-radius: 50%;
    }
    .welcome-left { position: relative; z-index: 1; }
    .welcome-banner h1 { font-size: 1.5rem; font-weight: 700; margin-bottom: 4px; }
    .welcome-banner .date { font-size: 0.88rem; opacity: 0.85; }
    .welcome-banner .sub { font-size: 0.82rem; opacity: 0.7; margin-top: 8px; }
    .weather-widget {
      position: relative; z-index: 1; text-align: right;
      background: rgba(255,255,255,0.12); border-radius: 12px; padding: 12px 16px;
      backdrop-filter: blur(8px);
    }
    .weather-widget .weather-temp { font-size: 1.8rem; font-weight: 700; line-height: 1; }
    .weather-widget .weather-desc { font-size: 0.78rem; opacity: 0.85; }
    .weather-widget .weather-loc { font-size: 0.72rem; opacity: 0.6; margin-top: 2px; }

    /* KPI Grid */
    .kpi-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 14px; margin-bottom: 24px; }
    .kpi-card {
      background: var(--card); border: 1px solid var(--border); border-radius: var(--radius);
      padding: 18px 20px; transition: all 0.2s; position: relative; overflow: hidden;
    }
    .kpi-card:hover { box-shadow: var(--shadow); transform: translateY(-1px); }
    .kpi-card .kpi-icon { font-size: 1.3rem; margin-bottom: 8px; }
    .kpi-card .kpi-value { font-size: 1.7rem; font-weight: 800; line-height: 1; }
    .kpi-card .kpi-label { font-size: 0.72rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.4px; font-weight: 600; margin-top: 4px; }
    .kpi-card .kpi-trend { font-size: 0.72rem; margin-top: 8px; font-weight: 600; display: flex; align-items: center; gap: 4px; }
    .kpi-card .kpi-trend.up { color: var(--green); }
    .kpi-card .kpi-trend.down { color: var(--red); }
    .kpi-card .kpi-trend.neutral { color: var(--muted); }
    .kpi-accent { position: absolute; top: 0; left: 0; width: 4px; height: 100%; }
    .kpi-accent.blue { background: var(--accent); }
    .kpi-accent.green { background: var(--green); }
    .kpi-accent.amber { background: var(--amber); }
    .kpi-accent.red { background: var(--red); }
    .kpi-accent.purple { background: var(--purple); }

    /* Main Grid Layout */
    .main-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 24px; }
    .main-grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 24px; }

    /* Cards */
    .card {
      background: var(--card); border: 1px solid var(--border); border-radius: var(--radius);
      padding: 20px 22px; transition: box-shadow 0.2s;
    }
    .card:hover { box-shadow: var(--shadow-sm); }
    .card-header {
      display: flex; align-items: center; justify-content: space-between; margin-bottom: 14px;
      padding-bottom: 12px; border-bottom: 1px solid var(--border);
    }
    .card-title { font-size: 0.9rem; font-weight: 700; display: flex; align-items: center; gap: 8px; }
    .card-badge {
      font-size: 0.68rem; font-weight: 700; padding: 2px 8px; border-radius: 10px;
      background: var(--red-light); color: var(--red);
    }
    .card-link { font-size: 0.75rem; color: var(--accent); text-decoration: none; font-weight: 600; }
    .card-link:hover { text-decoration: underline; }

    /* Priorities Section */
    .priorities-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 24px; }
    .priority-card { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 18px 20px; }
    .priority-card.urgent { border-left: 4px solid var(--red); }
    .priority-card.warning { border-left: 4px solid var(--amber); }
    .priority-card.info { border-left: 4px solid var(--accent); }
    .priority-title { font-size: 0.82rem; font-weight: 700; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
    .priority-count { font-size: 0.68rem; padding: 2px 8px; border-radius: 10px; background: var(--bg); }

    .priority-list { list-style: none; }
    .priority-item {
      display: flex; align-items: flex-start; gap: 10px; padding: 10px 0;
      border-bottom: 1px solid #f1f5f9; font-size: 0.82rem;
    }
    .priority-item:last-child { border-bottom: none; }
    .priority-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; margin-top: 5px; }
    .priority-dot.red { background: var(--red); }
    .priority-dot.amber { background: var(--amber); }
    .priority-dot.green { background: var(--green); }
    .priority-content { flex: 1; min-width: 0; }
    .priority-name { font-weight: 600; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .priority-meta { font-size: 0.72rem; color: var(--muted); margin-top: 2px; }
    .priority-empty { color: var(--muted); font-size: 0.82rem; padding: 16px 0; text-align: center; }

    /* Quick Actions */
    .quick-actions-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 24px; }
    .action-btn {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      padding: 20px 16px; background: var(--card); border: 1px solid var(--border);
      border-radius: var(--radius); text-decoration: none; color: var(--text);
      transition: all 0.2s; text-align: center; cursor: pointer;
    }
    .action-btn:hover { border-color: var(--accent); background: var(--accent-light); transform: translateY(-2px); box-shadow: var(--shadow); }
    .action-btn .action-icon { font-size: 1.6rem; margin-bottom: 8px; }
    .action-btn .action-label { font-size: 0.82rem; font-weight: 600; }
    .action-btn .action-desc { font-size: 0.7rem; color: var(--muted); margin-top: 4px; }

    /* Activity Feed */
    .activity-feed { list-style: none; max-height: 400px; overflow-y: auto; }
    .activity-item {
      display: flex; gap: 12px; padding: 12px 0; border-bottom: 1px solid #f8fafc; font-size: 0.82rem;
    }
    .activity-item:last-child { border-bottom: none; }
    .activity-icon {
      width: 36px; height: 36px; border-radius: 10px; display: flex; align-items: center;
      justify-content: center; font-size: 1rem; flex-shrink: 0; background: var(--bg);
    }
    .activity-icon.green { background: var(--green-light); }
    .activity-icon.blue { background: var(--accent-light); }
    .activity-icon.amber { background: var(--amber-light); }
    .activity-icon.red { background: var(--red-light); }
    .activity-icon.purple { background: var(--purple-light); }
    .activity-content { flex: 1; min-width: 0; }
    .activity-text { color: var(--text); }
    .activity-text strong { font-weight: 600; }
    .activity-time { font-size: 0.7rem; color: var(--muted); margin-top: 2px; }

    /* Charts */
    .charts-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 24px; }
    .chart-container { height: 180px; position: relative; }

    /* Alerts */
    .alerts-card { background: var(--amber-light); border: 1px solid #fde68a; }
    .alert-item {
      display: flex; align-items: center; gap: 10px; padding: 10px 0;
      border-bottom: 1px solid rgba(245,158,11,0.2); font-size: 0.82rem;
    }
    .alert-item:last-child { border-bottom: none; }
    .alert-icon { font-size: 1rem; }
    .alert-text { flex: 1; color: #92400e; }
    .alert-action { font-size: 0.72rem; color: var(--amber); font-weight: 600; cursor: pointer; }
    .alert-action:hover { text-decoration: underline; }

    /* Quick Links */
    .quick-links { display: flex; flex-wrap: wrap; gap: 10px; }
    .quick-link {
      display: inline-flex; align-items: center; gap: 6px; padding: 8px 14px;
      background: var(--bg); border-radius: 8px; color: var(--text);
      text-decoration: none; font-size: 0.78rem; font-weight: 600;
      transition: all 0.15s;
    }
    .quick-link:hover { background: var(--accent-light); color: var(--accent); }
    .quick-link .link-icon { font-size: 0.9rem; }

    /* Pipeline Mini */
    .pipeline-mini { display: flex; gap: 4px; align-items: flex-end; margin-top: 8px; }
    .pipeline-bar {
      flex: 1; background: var(--accent); border-radius: 4px 4px 0 0;
      min-height: 20px; position: relative; transition: all 0.3s;
    }
    .pipeline-bar:hover { opacity: 0.8; }
    .pipeline-bar .bar-label {
      position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%);
      font-size: 0.65rem; color: var(--muted); white-space: nowrap; padding-bottom: 4px;
    }
    .pipeline-bar .bar-count {
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
      font-size: 0.72rem; font-weight: 700; color: #fff;
    }

    /* Loading */
    .skeleton { background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: 6px; }
    @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

    /* Responsive */
    @media (max-width: 1100px) {
      .kpi-grid { grid-template-columns: repeat(3, 1fr); }
      .main-grid { grid-template-columns: 1fr; }
      .main-grid-3, .charts-grid, .priorities-grid { grid-template-columns: 1fr; }
      .quick-actions-grid { grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 700px) {
      .dashboard { padding: 16px; }
      .welcome-banner { flex-direction: column; gap: 16px; padding: 22px; }
      .welcome-banner h1 { font-size: 1.3rem; }
      .weather-widget { text-align: left; }
      .kpi-grid { grid-template-columns: repeat(2, 1fr); }
      .quick-actions-grid { grid-template-columns: 1fr 1fr; }
    }
    /* Action Items Command Center */
    .action-center { margin-bottom: 20px; }
    .action-center-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 14px; }
    .action-center-title { font-size: 1.1rem; font-weight: 700; display: flex; align-items: center; gap: 8px; }
    .action-badges { display: flex; gap: 8px; }
    .action-badge { font-size: 0.72rem; font-weight: 700; padding: 3px 10px; border-radius: 12px; }
    .action-badge.urgent { background: var(--red-light); color: var(--red); }
    .action-badge.active { background: var(--green-light); color: var(--green); }
    /* Sales Command Center ‚Äî Full Width */
    .sales-center { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px 24px; margin-bottom: 20px; }
    .sales-center-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px solid var(--border); }
    .sales-center-title { font-size: 1.05rem; font-weight: 700; display: flex; align-items: center; gap: 8px; }
    .sales-stats-row { display: flex; gap: 16px; margin-bottom: 18px; flex-wrap: wrap; }
    .sales-stat { display: flex; align-items: center; gap: 8px; padding: 8px 14px; background: var(--bg); border-radius: 10px; font-size: 0.78rem; }
    .sales-stat .stat-val { font-weight: 800; font-size: 1rem; }
    .sales-stat.green .stat-val { color: var(--green); }
    .sales-stat.blue .stat-val { color: var(--accent); }
    .sales-stat.amber .stat-val { color: var(--amber); }
    .sales-stat.red .stat-val { color: var(--red); }

    /* Tabs */
    .sales-tabs { display: flex; gap: 0; margin-bottom: 16px; border-bottom: 2px solid var(--border); }
    .sales-tab { padding: 8px 18px; font-size: 0.82rem; font-weight: 600; cursor: pointer; color: var(--muted); border-bottom: 2px solid transparent; margin-bottom: -2px; transition: all 0.15s; }
    .sales-tab:hover { color: var(--text); }
    .sales-tab.active { color: var(--accent); border-bottom-color: var(--accent); }
    .sales-tab-content { display: none; }
    .sales-tab-content.active { display: block; }

    /* Location Cards */
    .loc-card { border: 1px solid var(--border); border-radius: 10px; padding: 14px 18px; margin-bottom: 10px; transition: all 0.15s; cursor: pointer; }
    .loc-card:hover { box-shadow: var(--shadow-sm); border-color: #cbd5e1; }
    .loc-card.has-hot { border-left: 4px solid var(--red); }
    .loc-card.has-reply { border-left: 4px solid var(--green); }
    .loc-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
    .loc-name { font-size: 0.92rem; font-weight: 700; display: flex; align-items: center; gap: 8px; }
    .loc-name .loc-type { font-size: 0.68rem; font-weight: 500; color: var(--muted); background: var(--bg); padding: 2px 8px; border-radius: 6px; }
    .loc-stage { font-size: 0.7rem; font-weight: 600; padding: 3px 10px; border-radius: 12px; }
    .loc-stage.hot { background: var(--red-light); color: var(--red); }
    .loc-stage.warm { background: var(--amber-light); color: #b45309; }
    .loc-stage.new { background: var(--accent-light); color: var(--accent); }
    .loc-stage.replied { background: var(--green-light); color: #15803d; }
    .loc-stage.contract { background: #ecfdf5; color: #059669; border: 1px solid #a7f3d0; }
    .loc-stage.needs-email { background: #fef3c7; color: #b45309; border: 1px solid #fcd34d; }
    .loc-timeline { display: flex; flex-direction: column; gap: 4px; }
    .loc-event { display: flex; align-items: center; gap: 10px; font-size: 0.78rem; padding: 4px 0; }
    .loc-event-icon { width: 22px; text-align: center; flex-shrink: 0; }
    .loc-event-text { flex: 1; color: var(--text); }
    .loc-event-text strong { font-weight: 600; }
    .loc-event-date { font-size: 0.7rem; color: var(--muted); white-space: nowrap; flex-shrink: 0; }
    .loc-event-badge { font-size: 0.68rem; padding: 1px 7px; border-radius: 8px; font-weight: 600; flex-shrink: 0; }
    .loc-event-badge.opens { background: var(--accent-light); color: var(--accent); }
    .loc-event-badge.hot-opens { background: var(--red-light); color: var(--red); }
    .loc-event-badge.replied { background: var(--green-light); color: #15803d; }
    .loc-event-badge.bounced { background: #fef2f2; color: #991b1b; }
    /* Expandable email detail */
    .loc-email-detail { display: none; margin: 4px 0 6px 32px; padding: 8px 12px; background: var(--bg); border-radius: 8px; border: 1px solid var(--border); font-size: 0.75rem; }
    .loc-email-detail.open { display: block; }
    .loc-email-detail .email-row { display: flex; align-items: center; gap: 8px; padding: 4px 0; border-bottom: 1px solid #e2e8f0; }
    .loc-email-detail .email-row:last-child { border-bottom: none; }
    .loc-email-detail .email-subj { flex: 1; font-weight: 500; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .loc-email-detail .email-ts { color: var(--muted); white-space: nowrap; }

    /* Email Activity Table */
    .email-table { width: 100%; border-collapse: collapse; font-size: 0.82rem; }
    .email-table th { text-align: left; padding: 8px 10px; font-size: 0.72rem; text-transform: uppercase; letter-spacing: 0.3px; color: var(--muted); font-weight: 600; border-bottom: 1px solid var(--border); }
    .email-table td { padding: 10px 10px; border-bottom: 1px solid #f1f5f9; vertical-align: middle; }
    .email-table tr:hover { background: var(--bg); }
    .email-table tr:last-child td { border-bottom: none; }
    .email-status { display: inline-flex; align-items: center; gap: 5px; padding: 3px 10px; border-radius: 20px; font-size: 0.72rem; font-weight: 600; }
    .email-status.hot { background: var(--red-light); color: var(--red); }
    .email-status.opened { background: var(--accent-light); color: var(--accent); }
    .email-status.replied { background: var(--green-light); color: var(--green); }
    .email-status.sent { background: var(--bg); color: var(--muted); }
    .email-status.bounced { background: #fef2f2; color: #991b1b; }
    .email-opens { display: inline-flex; align-items: center; gap: 3px; font-weight: 600; }
    .email-opens.high { color: var(--red); }
    .email-opens.med { color: var(--amber); }
    .email-opens.low { color: var(--muted); }

    /* Activity Feed (redesigned) */
    .activity-feed-full { max-height: 400px; overflow-y: auto; }
    .activity-row { display: flex; align-items: center; gap: 12px; padding: 10px 8px; border-bottom: 1px solid #f1f5f9; font-size: 0.82rem; transition: background 0.1s; }
    .activity-row:hover { background: var(--bg); }
    .activity-row:last-child { border-bottom: none; }
    .activity-badge { display: inline-flex; align-items: center; justify-content: center; width: 30px; height: 30px; border-radius: 8px; font-size: 0.85rem; flex-shrink: 0; }
    .activity-badge.pop-in { background: var(--purple-light); }
    .activity-badge.email { background: var(--accent-light); }
    .activity-badge.call { background: var(--green-light); }
    .activity-badge.note { background: #f1f5f9; }
    .activity-badge.proposal { background: var(--amber-light); }
    .activity-badge.interested { background: var(--red-light); }
    .activity-info { flex: 1; min-width: 0; }
    .activity-info .act-title { font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .activity-info .act-meta { font-size: 0.72rem; color: var(--muted); margin-top: 1px; }
    .activity-date { font-size: 0.72rem; color: var(--muted); white-space: nowrap; flex-shrink: 0; }

    @media (max-width: 768px) {
      .sales-stats-row { gap: 8px; }
      .sales-stat { padding: 6px 10px; font-size: 0.72rem; }
      .email-table { font-size: 0.75rem; }
      .email-table th, .email-table td { padding: 8px 6px; }
    }
  </style>
</head>
<body>
<script src="/nav.js"></script>

<div class="dashboard">
  <!-- Welcome Banner with Weather -->
  <div class="welcome-banner">
    <div class="welcome-left">
      <h1 id="greeting">Good morning, Kurtis üëã</h1>
      <div class="date" id="today-date"></div>
      <div class="sub" id="greeting-sub">Let's build that vending empire today.</div>
    </div>
    <div class="weather-widget" id="weather-widget">
      <div class="weather-temp" id="weather-temp">‚Äî¬∞</div>
      <div class="weather-desc" id="weather-desc">Loading...</div>
      <div class="weather-loc">üìç Las Vegas, NV</div>
    </div>
  </div>

  <!-- SALES COMMAND CENTER ‚Äî Full Width -->
  <div class="sales-center" id="sales-center">
    <div class="sales-center-header">
      <div class="sales-center-title">üìä Sales Activity Center</div>
      <div class="sales-stats-row" id="sales-stats">
        <div class="sales-stat blue"><span class="stat-val" id="stat-emails">‚Äî</span> Emails Sent</div>
        <div class="sales-stat green"><span class="stat-val" id="stat-openrate">‚Äî%</span> Open Rate</div>
        <div class="sales-stat red"><span class="stat-val" id="stat-hot">‚Äî</span> Hot Leads</div>
        <div class="sales-stat amber"><span class="stat-val" id="stat-replied">‚Äî</span> Replied</div>
      </div>
    </div>

    <!-- Location Cards ‚Äî Grouped by Property -->
    <div id="location-cards">
      <div style="text-align:center;padding:24px;color:var(--muted);font-size:0.82rem;">Loading...</div>
    </div>
  </div>

  <!-- Kurtis To-Do List -->
  <div class="todo-section" style="background:#fff;border:1px solid #e2e8f0;border-radius:14px;padding:18px 22px;margin-bottom:20px;color:#1a202c;box-shadow:0 2px 8px rgba(0,0,0,0.06);">
    <h3 style="margin:0 0 14px 0;font-size:1.05rem;display:flex;align-items:center;gap:8px;font-weight:600;">
      üìã Priority Tasks
      <span style="font-size:0.75rem;opacity:0.8;font-weight:normal;margin-left:auto;">Updated Feb 10</span>
    </h3>
    <div style="display:flex;flex-direction:column;gap:8px;" id="todoList">
      <label style="display:flex;align-items:center;gap:10px;background:#f8fafc;padding:11px 14px;border-radius:10px;cursor:pointer;transition:background 0.2s;border:1px solid #e2e8f0;" onmouseover="this.style.background='#f1f5f9'" onmouseout="this.style.background='#f8fafc'">
        <input type="checkbox" id="todo1" onchange="saveTodos()" style="width:18px;height:18px;cursor:pointer;accent-color:#22c55e;">
        <span><strong>ESB Certification</strong> ‚Äî Follow up on unanswered application email</span>
      </label>
      <label style="display:flex;align-items:center;gap:10px;background:#f8fafc;padding:11px 14px;border-radius:10px;cursor:pointer;transition:background 0.2s;border:1px solid #e2e8f0;" onmouseover="this.style.background='#f1f5f9'" onmouseout="this.style.background='#f8fafc'">
        <input type="checkbox" id="todo2" onchange="saveTodos()" style="width:18px;height:18px;cursor:pointer;accent-color:#22c55e;">
        <span><strong>GBP Verification</strong> ‚Äî Get Google Business Profile verified for Kande VendTech</span>
      </label>
      <label style="display:flex;align-items:center;gap:10px;background:#f1f5f9;padding:11px 14px;border-radius:10px;cursor:pointer;opacity:0.6;border:1px solid #e2e8f0;">
        <input type="checkbox" id="todo3" checked disabled style="width:18px;height:18px;accent-color:#22c55e;">
        <span style="text-decoration:line-through;"><strong>Email Warmup</strong> ‚Äî Instantly.ai setup ‚úÖ Running (2-3 weeks)</span>
      </label>
      <label style="display:flex;align-items:center;gap:10px;background:#f8fafc;padding:11px 14px;border-radius:10px;cursor:pointer;transition:background 0.2s;border:1px solid #e2e8f0;" onmouseover="this.style.background='#f1f5f9'" onmouseout="this.style.background='#f8fafc'">
        <input type="checkbox" id="todo4" onchange="saveTodos()" style="width:18px;height:18px;cursor:pointer;accent-color:#22c55e;">
        <span><strong>First Location</strong> ‚Äî Close first signed location for machine placement</span>
      </label>
      <label style="display:flex;align-items:center;gap:10px;background:#f8fafc;padding:11px 14px;border-radius:10px;cursor:pointer;transition:background 0.2s;border:1px solid #e2e8f0;" onmouseover="this.style.background='#f1f5f9'" onmouseout="this.style.background='#f8fafc'">
        <input type="checkbox" id="todo5" onchange="saveTodos()" style="width:18px;height:18px;cursor:pointer;accent-color:#22c55e;">
        <span><strong>Pop-in Visits</strong> ‚Äî Do 5 pop-ins to hot prospects this week</span>
      </label>
      <label style="display:flex;align-items:center;gap:10px;background:#f8fafc;padding:11px 14px;border-radius:10px;cursor:pointer;transition:background 0.2s;border:1px solid #e2e8f0;" onmouseover="this.style.background='#f1f5f9'" onmouseout="this.style.background='#f8fafc'">
        <input type="checkbox" id="todo6" onchange="saveTodos()" style="width:18px;height:18px;cursor:pointer;accent-color:#22c55e;">
        <span><strong>Order Smart Cooler</strong> ‚Äî Order first SandStar AI cooler ($3,600)</span>
      </label>
    </div>
    <!-- Today's CRM Tasks (dynamic) -->
    <div id="todayTasksSection" style="margin-top:14px;padding-top:14px;border-top:1px solid #e2e8f0;">
      <div style="font-size:0.85rem;font-weight:600;margin-bottom:10px;color:#64748b;">üìÖ Today's Tasks</div>
      <div id="todayTasksList" style="display:flex;flex-direction:column;gap:6px;">
        <div style="opacity:0.7;font-size:0.85rem;padding:8px;">Loading tasks...</div>
      </div>
    </div>
  </div>
  <script>
    // Load/save todo checkboxes
    function saveTodos() {
      const todos = {};
      document.querySelectorAll('#todoList input[type="checkbox"]:not([disabled])').forEach(cb => {
        todos[cb.id] = cb.checked;
      });
      localStorage.setItem('vendtech_todos', JSON.stringify(todos));
    }
    function loadTodos() {
      try {
        const saved = JSON.parse(localStorage.getItem('vendtech_todos') || '{}');
        Object.keys(saved).forEach(id => {
          const cb = document.getElementById(id);
          if (cb) {
            cb.checked = saved[id];
            if (saved[id]) {
              cb.closest('label').style.opacity = '0.6';
              cb.closest('label').querySelector('span').style.textDecoration = 'line-through';
            }
          }
        });
      } catch(e) {}
    }
    
    // Load today's CRM tasks
    async function loadTodayTasks() {
      try {
        const res = await fetch('/api/crm-tasks');
        if (!res.ok) throw new Error('Failed to load tasks');
        const tasks = await res.json();
        const today = new Date().toISOString().split('T')[0];
        const todayTasks = tasks.filter(t => !t.completed && t.due_date && t.due_date.startsWith(today));
        const overdueTasks = tasks.filter(t => !t.completed && t.due_date && t.due_date < today);
        const allTasks = [...overdueTasks, ...todayTasks];
        
        const container = document.getElementById('todayTasksList');
        if (allTasks.length === 0) {
          container.innerHTML = '<div style="opacity:0.7;font-size:0.85rem;padding:8px;">‚ú® No tasks due today!</div>';
        } else {
          // Store tasks globally for popup access
          window.todayTasksData = allTasks;
          container.innerHTML = allTasks.slice(0, 5).map((t, idx) => {
            const isOverdue = t.due_date < today;
            const isPopIn = (t.category || '').toLowerCase().includes('pop') || (t.title || '').toLowerCase().includes('pop');
            return `<label style="display:flex;align-items:center;gap:10px;background:${isOverdue ? '#fef2f2' : '#f8fafc'};padding:9px 12px;border-radius:8px;cursor:pointer;font-size:0.9rem;border:1px solid ${isOverdue ? '#fecaca' : '#e2e8f0'};" onclick="completeTask(${t.id}, this, ${isPopIn}, ${t.prospect_id || 'null'})">
              <input type="checkbox" style="width:16px;height:16px;cursor:pointer;accent-color:#22c55e;">
              <span>${isOverdue ? '‚ö†Ô∏è ' : ''}${isPopIn ? 'üö∂ ' : ''}${t.title}${t.prospect_name ? ' <span style="opacity:0.7">(' + t.prospect_name + ')</span>' : ''}</span>
            </label>`;
          }).join('');
          if (allTasks.length > 5) {
            container.innerHTML += `<a href="/tasks" style="color:#3182ce;font-size:0.8rem;padding:6px;text-align:center;display:block;">+ ${allTasks.length - 5} more tasks ‚Üí</a>`;
          }
        }
      } catch(e) {
        document.getElementById('todayTasksList').innerHTML = '<div style="opacity:0.6;font-size:0.85rem;padding:8px;">Could not load tasks</div>';
      }
    }
    
    async function completeTask(id, el, isPopIn, prospectId) {
      // For pop-in tasks, show foot traffic popup first
      if (isPopIn) {
        showFootTrafficPopup(id, el, prospectId);
        return;
      }
      // Regular task completion
      try {
        await fetch('/api/crm-tasks/' + id + '/complete', { method: 'PUT' });
        el.style.opacity = '0.5';
        el.style.textDecoration = 'line-through';
        el.querySelector('input').checked = true;
      } catch(e) {}
    }
    
    function showFootTrafficPopup(taskId, el, prospectId) {
      // Create popup overlay
      const overlay = document.createElement('div');
      overlay.id = 'footTrafficOverlay';
      overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);z-index:9999;display:flex;align-items:center;justify-content:center;';
      overlay.innerHTML = `
        <div style="background:#fff;border-radius:16px;padding:24px;max-width:340px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
          <h3 style="margin:0 0 8px 0;font-size:1.1rem;color:#1a202c;">üö∂ Pop-In Complete!</h3>
          <p style="margin:0 0 16px 0;color:#64748b;font-size:0.9rem;">How busy was this location?</p>
          <label style="display:block;margin-bottom:12px;">
            <span style="font-size:0.85rem;color:#475569;font-weight:500;">Estimated foot traffic per day</span>
            <input type="number" id="footTrafficInput" placeholder="e.g., 500" min="0" style="width:100%;padding:12px;border:1px solid #e2e8f0;border-radius:8px;font-size:1rem;margin-top:6px;">
          </label>
          <label style="display:block;margin-bottom:16px;">
            <span style="font-size:0.85rem;color:#475569;font-weight:500;">Notes (optional)</span>
            <textarea id="popInNotes" placeholder="Any observations..." rows="2" style="width:100%;padding:10px;border:1px solid #e2e8f0;border-radius:8px;font-size:0.9rem;margin-top:6px;resize:none;"></textarea>
          </label>
          <div style="display:flex;gap:10px;">
            <button onclick="cancelFootTrafficPopup()" style="flex:1;padding:12px;border:1px solid #e2e8f0;border-radius:8px;background:#fff;color:#64748b;font-weight:500;cursor:pointer;">Cancel</button>
            <button onclick="submitFootTraffic(${taskId}, ${prospectId})" style="flex:1;padding:12px;border:none;border-radius:8px;background:#22c55e;color:#fff;font-weight:600;cursor:pointer;">Complete ‚úì</button>
          </div>
        </div>
      `;
      overlay.querySelector('#footTrafficInput').taskEl = el;
      document.body.appendChild(overlay);
      document.getElementById('footTrafficInput').focus();
    }
    
    function cancelFootTrafficPopup() {
      const overlay = document.getElementById('footTrafficOverlay');
      if (overlay) overlay.remove();
    }
    
    async function submitFootTraffic(taskId, prospectId) {
      const footTraffic = document.getElementById('footTrafficInput').value;
      const notes = document.getElementById('popInNotes').value;
      const el = document.getElementById('footTrafficInput').taskEl;
      
      try {
        // Complete the task
        await fetch('/api/crm-tasks/' + taskId + '/complete', { method: 'PUT' });
        
        // If we have a prospect, update their foot traffic estimate
        if (prospectId && footTraffic) {
          await fetch('/api/prospects/' + prospectId, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
              estimated_foot_traffic: parseInt(footTraffic),
              notes: notes ? (notes + ' (from pop-in)') : undefined
            })
          });
        }
        
        // Log as activity
        if (prospectId) {
          await fetch('/api/activities', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              prospect_id: prospectId,
              type: 'pop_in',
              notes: 'Foot traffic: ' + (footTraffic || 'not recorded') + (notes ? '. ' + notes : '')
            })
          });
        }
        
        // Update UI
        if (el) {
          el.style.opacity = '0.5';
          el.style.textDecoration = 'line-through';
          el.querySelector('input').checked = true;
        }
      } catch(e) {
        console.error('Error completing pop-in:', e);
      }
      
      cancelFootTrafficPopup();
    }
    
    document.addEventListener('DOMContentLoaded', () => {
      loadTodos();
      loadTodayTasks();
    });
  </script>

  <!-- KPI Summary Row -->
  <div class="kpi-grid">
    <div class="kpi-card">
      <div class="kpi-accent blue"></div>
      <div class="kpi-icon">üéØ</div>
      <div class="kpi-value" id="kpi-prospects">‚Äî</div>
      <div class="kpi-label">Total Prospects</div>
      <div class="kpi-trend neutral" id="kpi-prospects-trend">Loading...</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-accent red"></div>
      <div class="kpi-icon">üî•</div>
      <div class="kpi-value" id="kpi-hot">‚Äî</div>
      <div class="kpi-label">Hot Leads</div>
      <div class="kpi-trend neutral" id="kpi-hot-trend">Ready to close</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-accent green"></div>
      <div class="kpi-icon">‚úÖ</div>
      <div class="kpi-value" id="kpi-signed">‚Äî</div>
      <div class="kpi-label">Signed Deals</div>
      <div class="kpi-trend neutral" id="kpi-signed-trend">Contracts active</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-accent amber"></div>
      <div class="kpi-icon">üíµ</div>
      <div class="kpi-value" id="kpi-revenue">‚Äî</div>
      <div class="kpi-label">This Month</div>
      <div class="kpi-trend neutral" id="kpi-revenue-trend">Loading...</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-accent purple"></div>
      <div class="kpi-icon">üìä</div>
      <div class="kpi-value" id="kpi-pipeline">‚Äî</div>
      <div class="kpi-label">Pipeline Value</div>
      <div class="kpi-trend neutral" id="kpi-pipeline-trend">Potential revenue</div>
    </div>
  </div>

  <!-- Today's Priorities -->
  <div class="priorities-grid">
    <div class="priority-card urgent">
      <div class="priority-title">
        üö® Overdue Follow-ups
        <span class="priority-count" id="overdue-count">0</span>
      </div>
      <ul class="priority-list" id="overdue-list">
        <li class="priority-empty">Loading...</li>
      </ul>
    </div>
    <div class="priority-card warning">
      <div class="priority-title">
        üìÖ Scheduled Today
        <span class="priority-count" id="scheduled-count">0</span>
      </div>
      <ul class="priority-list" id="scheduled-list">
        <li class="priority-empty">Loading...</li>
      </ul>
    </div>
    <div class="priority-card info">
      <div class="priority-title">
        ‚úÖ Tasks Due Today
        <span class="priority-count" id="tasks-count">0</span>
      </div>
      <ul class="priority-list" id="tasks-list">
        <li class="priority-empty">Loading...</li>
      </ul>
    </div>
  </div>

  <!-- Quick Actions -->
  <div class="quick-actions-grid">
    <a class="action-btn" href="/crm#add">
      <span class="action-icon">‚ûï</span>
      <span class="action-label">Add Prospect</span>
      <span class="action-desc">New lead entry</span>
    </a>
    <a class="action-btn" href="/crm#activity">
      <span class="action-icon">üìç</span>
      <span class="action-label">Log Activity</span>
      <span class="action-desc">Pop-in, call, email</span>
    </a>
    <a class="action-btn" href="/proposal-generator">
      <span class="action-icon">üìù</span>
      <span class="action-label">Generate Proposal</span>
      <span class="action-desc">Create PDF proposal</span>
    </a>
    <a class="action-btn" href="/pipeline-board">
      <span class="action-icon">üîÄ</span>
      <span class="action-label">View Pipeline</span>
      <span class="action-desc">Kanban board</span>
    </a>
  </div>

  <!-- Activity Feed + Alerts -->
  <div class="main-grid">
    <div class="card">
      <div class="card-header">
        <span class="card-title">üì∞ Recent Activity</span>
        <a class="card-link" href="/crm">View All ‚Üí</a>
      </div>
      <ul class="activity-feed" id="activity-feed">
        <li class="priority-empty">Loading activity...</li>
      </ul>
    </div>

    <div class="card alerts-card" id="alerts-card" style="display:none;">
      <div class="card-header" style="border-bottom-color: rgba(245,158,11,0.3);">
        <span class="card-title">‚ö†Ô∏è Alerts & Notifications</span>
        <a class="card-link" href="/tasks" style="color: #b45309;">View All ‚Üí</a>
      </div>
      <div id="alerts-list"></div>
    </div>
  </div>

  <!-- Charts Section -->
  <div class="charts-grid">
    <div class="card">
      <div class="card-header">
        <span class="card-title">üîÄ Pipeline Funnel</span>
      </div>
      <div class="pipeline-mini" id="pipeline-funnel"></div>
    </div>
    <div class="card">
      <div class="card-header">
        <span class="card-title">üìà Activity Trend (7 days)</span>
      </div>
      <div class="chart-container">
        <canvas id="activity-chart"></canvas>
      </div>
    </div>
    <div class="card">
      <div class="card-header">
        <span class="card-title">üí∞ Revenue Trend</span>
      </div>
      <div class="chart-container">
        <canvas id="revenue-chart"></canvas>
      </div>
    </div>
  </div>

  <!-- Quick Links -->
  <div class="card">
    <div class="card-header">
      <span class="card-title">üîó Quick Links</span>
    </div>
    <div class="quick-links">
      <a class="quick-link" href="/crm"><span class="link-icon">üë•</span> CRM</a>
      <a class="quick-link" href="/pipeline-board"><span class="link-icon">üîÄ</span> Pipeline</a>
      <a class="quick-link" href="/tasks"><span class="link-icon">‚úÖ</span> Tasks</a>
      <a class="quick-link" href="/daily-planner"><span class="link-icon">üìÖ</span> Daily Planner</a>
      <a class="quick-link" href="/calendar"><span class="link-icon">üóìÔ∏è</span> Calendar</a>
      <a class="quick-link" href="/call-scripts"><span class="link-icon">üìû</span> Call Scripts</a>
      <a class="quick-link" href="/email-templates"><span class="link-icon">üìß</span> Email Templates</a>
      <a class="quick-link" href="/proposal-generator"><span class="link-icon">üìù</span> Proposals</a>
      <a class="quick-link" href="/contract-generator"><span class="link-icon">üìÑ</span> Contracts</a>
      <a class="quick-link" href="/fleet"><span class="link-icon">üè≠</span> Fleet</a>
      <a class="quick-link" href="/financials"><span class="link-icon">üíµ</span> Financials</a>
      <a class="quick-link" href="/analytics"><span class="link-icon">üìä</span> Analytics</a>
      <a class="quick-link" href="/competitors"><span class="link-icon">üîç</span> Competitors</a>
      <a class="quick-link" href="/playbook"><span class="link-icon">üìñ</span> Playbook</a>
    </div>
  </div>
</div>

<script>
(function() {
  'use strict';

  // --- Helpers ---
  function fmt(n) { return n >= 1000 ? (n/1000).toFixed(1) + 'k' : String(n); }
  function money(n) { return '$' + Number(n).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 }); }
  function timeAgo(d) {
    var diff = (Date.now() - new Date(d).getTime()) / 1000;
    if (diff < 60) return 'just now';
    if (diff < 3600) return Math.floor(diff/60) + 'm ago';
    if (diff < 86400) return Math.floor(diff/3600) + 'h ago';
    return Math.floor(diff/86400) + 'd ago';
  }
  function actIcon(type) {
    var map = { 
      call: 'üìû', email: 'üìß', pop_in: 'üìç', note: 'üìù', meeting: 'ü§ù', 
      proposal_sent: 'üìù', contract_signed: 'üìÑ', 'pop-in': 'üìç', task: '‚úÖ',
      'status-change': 'üîÑ', text: 'üí¨', linkedin: 'üíº', referral: 'ü§ù',
      site_survey: 'üìê', follow_up: 'üîî', voicemail: 'üì±'
    };
    return map[type] || 'üìå';
  }
  function actColor(type) {
    var map = { 
      call: 'blue', email: 'purple', pop_in: 'green', 'pop-in': 'green',
      meeting: 'amber', proposal_sent: 'amber', contract_signed: 'green',
      'status-change': 'blue', site_survey: 'green'
    };
    return map[type] || '';
  }

  // --- Greeting ---
  var hour = new Date().getHours();
  var greetText = hour < 12 ? 'Good morning' : hour < 17 ? 'Good afternoon' : 'Good evening';
  document.getElementById('greeting').textContent = greetText + ', Kurtis üëã';

  var subTexts = [
    "Let's build that vending empire today.",
    "Time to close some deals! üí™",
    "Your pipeline is waiting.",
    "Another day, another opportunity.",
    "Let's make moves today."
  ];
  document.getElementById('greeting-sub').textContent = subTexts[Math.floor(Math.random() * subTexts.length)];

  var now = new Date();
  var opts = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
  document.getElementById('today-date').textContent = now.toLocaleDateString('en-US', opts);
  var today = now.toISOString().split('T')[0];

  // --- Weather (Las Vegas) ---
  fetch('https://api.open-meteo.com/v1/forecast?latitude=36.17&longitude=-115.14&current=temperature_2m,weather_code&temperature_unit=fahrenheit&timezone=America/Los_Angeles')
    .then(function(r) { return r.json(); })
    .then(function(data) {
      if (data.current) {
        var temp = Math.round(data.current.temperature_2m);
        document.getElementById('weather-temp').textContent = temp + '¬∞F';
        var codes = {
          0: '‚òÄÔ∏è Clear', 1: 'üå§Ô∏è Mostly Clear', 2: '‚õÖ Partly Cloudy', 3: '‚òÅÔ∏è Cloudy',
          45: 'üå´Ô∏è Foggy', 48: 'üå´Ô∏è Rime Fog', 51: 'üåßÔ∏è Light Drizzle', 53: 'üåßÔ∏è Drizzle',
          55: 'üåßÔ∏è Heavy Drizzle', 61: 'üåßÔ∏è Light Rain', 63: 'üåßÔ∏è Rain', 65: 'üåßÔ∏è Heavy Rain',
          71: 'üå®Ô∏è Light Snow', 73: 'üå®Ô∏è Snow', 75: 'üå®Ô∏è Heavy Snow', 80: 'üå¶Ô∏è Showers',
          95: '‚õàÔ∏è Thunderstorm'
        };
        document.getElementById('weather-desc').textContent = codes[data.current.weather_code] || 'Clear';
      }
    })
    .catch(function() {
      document.getElementById('weather-temp').textContent = '‚Äî';
      document.getElementById('weather-desc').textContent = 'Unavailable';
    });

  // --- SALES COMMAND CENTER ---
  function toggleEmailDetail(id) {
    var el = document.getElementById(id);
    if (el) el.classList.toggle('open');
  }

  function formatDate(d) {
    if (!d) return '‚Äî';
    var dt = new Date(d);
    var now = new Date();
    var time = dt.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
    // Compare actual calendar dates (not hours)
    var dtDate = new Date(dt.getFullYear(), dt.getMonth(), dt.getDate());
    var nowDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    var dayDiff = Math.round((nowDate - dtDate) / (1000*60*60*24));
    if (dayDiff === 0) return 'Today ' + time;
    if (dayDiff === 1) return 'Yesterday ' + time;
    if (dayDiff < 7) return dayDiff + 'd ago ' + time;
    return dt.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ' ' + time;
  }

  // Load sales dashboard data ‚Äî grouped by location
  Promise.all([
    fetch('/api/sales-dashboard').then(r => r.ok ? r.json() : null),
    fetch('/api/action-items').then(r => r.ok ? r.json() : null),
    fetch('/api/prospects').then(r => r.ok ? r.json() : [])
  ]).then(function(results) {
    var sales = results[0];
    var actions = results[1];
    var prospects = results[2] || [];

    // Stats bar
    if (sales && sales.stats) {
      document.getElementById('stat-emails').textContent = sales.stats.total_emails || 0;
      document.getElementById('stat-openrate').textContent = sales.stats.open_rate || 0;
      document.getElementById('stat-hot').textContent = sales.stats.hot_leads || 0;
      document.getElementById('stat-replied').textContent = sales.stats.replied || 0;
    }

    // Group everything by prospect/location
    var locations = {};

    // Add email activity
    if (sales && sales.email_activity) {
      sales.email_activity.forEach(function(e) {
        var key = e.prospect_id;
        if (!locations[key]) locations[key] = { id: key, name: e.name, type: e.property_type, stage: e.pipeline_stage, events: [], emailStatus: 'sent', maxOpens: 0, hasReply: false, allEmails: [], pipelineStage: '', contractDate: null, latestActivity: null };
        locations[key].allEmails = e.all_emails || [];
        locations[key].openEvents = e.open_events || [];
        if (e.pipeline_card_stage) locations[key].pipelineStage = e.pipeline_card_stage;
        if (e.contract_sent_date) locations[key].contractDate = e.contract_sent_date;
        if (e.contract_stage_date && !locations[key].contractDate) locations[key].contractDate = e.contract_stage_date;
        if (e.latest_activity_date) locations[key].latestActivity = e.latest_activity_date;
        if (e.latest_action_type) locations[key].latestActionType = e.latest_action_type;
        if (e.status === 'needs_email') {
          locations[key].emailStatus = 'needs_email';
          locations[key].actionNeeded = e.action_needed;
          locations[key].recentPopIn = e.recent_pop_in;
          // Add action needed + pop-in as events instead of email
          if (e.action_needed) {
            locations[key].events.push({
              icon: '‚ú®', type: 'action',
              text: '<strong style="color:var(--red);">' + e.action_needed + '</strong>',
              detail: '',
              date: e.sent_at,
              isAction: true
            });
          }
          if (e.recent_pop_in) {
            locations[key].events.push({
              icon: 'üö∂', type: 'activity',
              text: '<strong>Pop-in visit</strong> ‚Äî ' + e.recent_pop_in.substring(0, 150),
              detail: '',
              date: e.sent_at
            });
          }
        } else {
          // Build open timestamps text (from Mixmax all_emails + Instantly open_events)
          var openTimestamps = [];
          // Instantly webhook open events (individual timestamps)
          if (e.open_events) {
            e.open_events.forEach(function(oe) {
              openTimestamps.push(oe.timestamp);
            });
          }
          // Mixmax per-email opens (last_opened timestamp)
          if (e.all_emails) {
            e.all_emails.forEach(function(em) {
              if (em.last_opened && !em.has_internal_opens) {
                openTimestamps.push(em.last_opened);
              }
            });
          }
          // Dedupe and sort newest first
          openTimestamps = openTimestamps.filter(function(v, i, a) { return a.indexOf(v) === i; })
            .sort(function(a, b) { return new Date(b) - new Date(a); });

          var opensText = '';
          if (openTimestamps.length > 0) {
            opensText = openTimestamps.slice(0, 5).map(function(ts) {
              return 'üëÅ ' + formatDate(ts);
            }).join('<br>');
          } else if (e.opens > 0) {
            // Fallback: Mixmax total count without exact timestamps
            var lastOpen = e.all_emails && e.all_emails.find(function(em) { return em.last_opened; });
            opensText = 'üëÅ Opened ' + e.opens + 'x' + (lastOpen ? ' ¬∑ Last: ' + formatDate(lastOpen.last_opened) : '');
          }

          locations[key].events.push({
            icon: 'üìß', type: 'email',
            text: '<strong>Email:</strong> ' + (e.subject || 'Follow-up') + (opensText ? '<div style="font-size:0.72rem;color:#059669;margin-top:3px;line-height:1.5;">' + opensText + '</div>' : ''),
            detail: e.email,
            date: e.sent_at,
            opens: e.opens,
            status: e.status,
            expandable: true,
            prospectId: e.prospect_id
          });
        }
        if (e.opens > locations[key].maxOpens) locations[key].maxOpens = e.opens;
        if (e.replied) locations[key].hasReply = true;
        if (e.status === 'replied') locations[key].emailStatus = 'replied';
        else if (e.status === 'hot' && locations[key].emailStatus !== 'replied') locations[key].emailStatus = 'hot';
        else if (e.status === 'opened' && locations[key].emailStatus !== 'replied' && locations[key].emailStatus !== 'hot') locations[key].emailStatus = 'opened';
      });
    }

    // Add activities
    if (sales && sales.recent_activities) {
      var actIcons = { 'pop-in': 'üö∂', 'pop_in': 'üö∂', 'email': 'üìß', 'call': 'üìû', 'note': 'üìù', 'proposal': 'üìã', 'interested': 'üî•', 'status_change': 'üîÑ', 'campaign_email': 'üì®' };
      sales.recent_activities.forEach(function(a) {
        var key = a.prospect_id;
        if (!locations[key]) locations[key] = { id: key, name: a.prospect_name, type: '', stage: '', events: [], emailStatus: '', maxOpens: 0, hasReply: false };
        // Skip internal/system activities
        var desc = (a.description || '').replace(/\s*‚Äî\s*$/, '').trim();
        var descLower = desc.toLowerCase();
        if (a.type === 'campaign_started' || a.type === 'campaign_launched') return;
        if (a.type === 'pipeline_move') return;
        // Hide status-change unless it has an "Action set:" directive
        if (a.type === 'status-change' && !descLower.includes('action set:')) return;
        // For status-changes with actions, extract just the action part
        if (a.type === 'status-change' && descLower.includes('action set:')) {
          var actionMatch = desc.match(/Action set:\s*(.+)/i);
          if (actionMatch) desc = actionMatch[1].trim();
          else return;
        }
        if (a.type === 'campaign_email') return;

        var icon = actIcons[a.type] || 'üìå';
        var label, detail;
        if (a.type === 'pop-in' || a.type === 'pop_in') {
          label = 'Pop-in visit';
          detail = desc.length > 120 ? desc.substring(0, 120) + '‚Ä¶' : desc;
        } else if (a.type === 'call') {
          label = 'Phone call';
          detail = desc.length > 120 ? desc.substring(0, 120) + '‚Ä¶' : desc;
        } else if (a.type === 'pipeline_move') {
          label = desc; detail = '';
        } else if (a.type === 'status-change') {
          label = desc; detail = '';
        } else if (a.type === 'email' || a.type === 'campaign_launched' || a.type === 'campaign_started') {
          label = desc.length > 100 ? desc.substring(0, 100) + '‚Ä¶' : desc;
          detail = '';
        } else {
          label = a.type || 'Activity';
          detail = desc.length > 120 ? desc.substring(0, 120) + '‚Ä¶' : desc;
        }
        locations[key].events.push({
          icon: icon, type: a.type,
          text: '<strong>' + label + '</strong>' + (detail ? ' ‚Äî ' + detail : ''),
          detail: a.created_by || 'Jordan',
          date: a.date
        });
      });
    }

    // Add action items
    if (actions && actions.action_items) {
      actions.action_items.forEach(function(item) {
        var key = item.prospect_id;
        if (!key) return;
        // Hide campaign follow-up reminders (system-generated)
        if (item.type === 'campaign_email') return;
        if (!locations[key]) locations[key] = { id: key, name: item.subtitle || 'Unknown', type: '', stage: '', events: [], emailStatus: '', maxOpens: 0, hasReply: false };
        var icon = item.type === 'hot_lead' ? 'üî•' : item.type === 'task_due' ? (item.priority === 'overdue' ? '‚ö†Ô∏è' : 'üìã') : 'üìå';
        var title = item.title || '';
        var isCallAction = title.toLowerCase().includes('call') || title.toLowerCase().includes('phone');
        var assignee = isCallAction ? ' <span style="font-size:0.68rem;color:var(--muted);font-weight:normal;">(Jordan)</span>' : '';
        locations[key].events.push({
          icon: icon, type: 'action',
          text: '<strong style="color:' + (isCallAction ? 'var(--muted)' : 'var(--red)') + ';">' + title + '</strong>' + assignee,
          detail: item.campaign_step || '',
          date: item.created_at,
          isAction: true
        });
      });
    }

    // Sort events within each location by date (newest first)
    Object.values(locations).forEach(function(loc) {
      // Sort: action items first, then by date newest-first
      loc.events.sort(function(a, b) {
        // Actions that need attention always on top
        if (a.isAction && !b.isAction) return -1;
        if (!a.isAction && b.isAction) return 1;
        return new Date(b.date || 0) - new Date(a.date || 0);
      });
      // Deduplicate similar events on same day
      var seen = {};
      loc.events = loc.events.filter(function(e) {
        var key = e.type + '|' + (e.date || '').split('T')[0];
        if (e.isAction) return true; // always show actions
        if (seen[key]) return false;
        seen[key] = true;
        return true;
      });
    });

    // Classify each location's primary action type
    // "CALL NOW" / "Call [name]" = Jordan's action ‚Üí bottom
    // "Email proposal" / "Send follow-up" = Kurtis's action ‚Üí top
    Object.values(locations).forEach(function(loc) {
      var actionEvents = loc.events.filter(function(e) { return e.isAction; });
      var hasCallAction = actionEvents.some(function(e) {
        var t = (e.text || '').toLowerCase();
        return t.includes('call now') || t.includes('call ') || t.includes('phone');
      });
      var hasEmailAction = actionEvents.some(function(e) {
        var t = (e.text || '').toLowerCase();
        return (t.includes('email proposal') || t.includes('send follow') || t.includes('send email') || t.includes('review &amp; send') || t.includes('review & send')) && !t.includes('call now');
      });
      // Call NOW takes priority as classification if present
      loc.actionType = hasEmailAction && !hasCallAction ? 'email' : hasCallAction ? 'call' : 'none';
    });

    // Build a lookup of prospect statuses to filter out stale/closed/lost
    var prospectStatusMap = {};
    if (prospects && prospects.length) {
      prospects.forEach(function(p) { prospectStatusMap[p.id] = (p.status || '').toLowerCase(); });
    }

    // Filter out stale, closed, and lost leads
    var hiddenStatuses = ['stale', 'closed', 'lost', 'dead'];
    var filteredLocations = Object.values(locations).filter(function(loc) {
      var status = prospectStatusMap[loc.id] || '';
      return hiddenStatuses.indexOf(status) === -1;
    });

    // Sort priority: 
    // 1. Kurtis actions (email/proposal/send) ‚Äî has actionType 'email'
    // 2. Cards with action items but no email type (generic actions)
    // 3. Cards with no action items (just pop-ins, needs email badge only)
    // 4. Jordan actions (call) at bottom
    var locList = filteredLocations.sort(function(a, b) {
      var aHasAction = a.events.some(function(e) { return e.isAction; });
      var bHasAction = b.events.some(function(e) { return e.isAction; });
      var aIsCall = a.actionType === 'call';
      var bIsCall = b.actionType === 'call';
      var aIsEmail = a.actionType === 'email';
      var bIsEmail = b.actionType === 'email';

      // Kurtis email/proposal actions first
      if (aIsEmail && !bIsEmail) return -1;
      if (!aIsEmail && bIsEmail) return 1;

      // Then other action items (send proposal, etc.) above no-action cards
      if (aHasAction && !bHasAction) return -1;
      if (!aHasAction && bHasAction) return 1;

      // Call actions last
      if (aIsCall && !bIsCall) return 1;
      if (!aIsCall && bIsCall) return -1;

      // Within same group: sort by most recent activity date
      var aDate = a.latestActivity ? new Date(a.latestActivity) : new Date(0);
      var bDate = b.latestActivity ? new Date(b.latestActivity) : new Date(0);
      return bDate - aDate;
    });

    // Render location cards
    var container = document.getElementById('location-cards');
    if (locList.length === 0) {
      container.innerHTML = '<div style="text-align:center;padding:24px;color:var(--muted);">No sales activity yet</div>';
    } else {
      container.innerHTML = locList.map(function(loc) {
        var isContract = loc.pipelineStage === 'contract_sent';
        var needsEmail = loc.emailStatus === 'needs_email';
        var cardClass = isContract ? 'has-reply' : loc.hasReply ? 'has-reply' : loc.emailStatus === 'hot' ? 'has-hot' : needsEmail ? 'has-hot' : '';
        var stageClass = isContract ? 'contract' : loc.hasReply ? 'replied' : loc.emailStatus === 'hot' ? 'hot' : needsEmail ? 'needs-email' : loc.maxOpens > 0 ? 'warm' : 'new';
        var contractDateStr = loc.contractDate ? ' ¬∑ Sent ' + formatDate(loc.contractDate) : '';
        var stageLabel = isContract ? 'üìÑ In Contract' + contractDateStr : loc.hasReply ? '‚úÖ Replied' : loc.emailStatus === 'hot' ? 'üî• Hot' : needsEmail ? '‚úâÔ∏è Needs Email' : loc.maxOpens > 0 ? 'üëÅ Opened' : 'üì§ Sent';

        var detailId = 'email-detail-' + loc.id;
        var eventsHtml = loc.events.slice(0, 6).map(function(e) {
          var badge = '';
          if (e.opens >= 3) badge = '<span class="loc-event-badge hot-opens">üî• ' + e.opens + ' opens</span>';
          else if (e.opens > 0) badge = '<span class="loc-event-badge opens">üëÅ ' + e.opens + ' opens</span>';
          if (e.status === 'replied') badge = '<span class="loc-event-badge replied">‚úÖ Replied</span>';
          if (e.status === 'bounced') badge = '<span class="loc-event-badge bounced">‚õî Bounced</span>';
          var clickAttr = e.expandable ? ' onclick="event.stopPropagation(); toggleEmailDetail(\'' + detailId + '\')" style="cursor:pointer;border-radius:6px;padding:4px 0;transition:background 0.1s;" onmouseover="this.style.background=\'var(--accent-light)\'" onmouseout="this.style.background=\'transparent\'"' : '';
          var expandIcon = e.expandable ? '<span style="font-size:0.68rem;color:var(--muted);margin-left:4px;">‚ñº</span>' : '';
          var html = '<div class="loc-event"' + clickAttr + '>' +
            '<div class="loc-event-icon">' + e.icon + '</div>' +
            '<div class="loc-event-text">' + e.text + expandIcon + '</div>' +
            badge +
            '<div class="loc-event-date">' + formatDate(e.date) + '</div>' +
          '</div>';

          // Add expandable detail panel for emails
          if (e.expandable && loc.allEmails && loc.allEmails.length > 0) {
            html += '<div class="loc-email-detail" id="' + detailId + '">';
            // Show individual open timestamps from Instantly webhooks
            if (loc.openEvents && loc.openEvents.length > 0) {
              html += '<div style="font-weight:600;margin-bottom:6px;color:var(--text);font-size:0.78rem;">üëÅ Open Timestamps</div>';
              html += loc.openEvents.slice(0, 10).map(function(oe) {
                var ts = new Date(oe.timestamp).toLocaleString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit', second: '2-digit', hour12: true });
                return '<div class="email-row"><div class="email-subj">üëÅ Opened' + (oe.subject ? ' ‚Äî ' + oe.subject : '') + '</div><div class="email-ts">' + ts + '</div></div>';
              }).join('');
              html += '<div style="border-top:1px solid var(--border);margin:8px 0;"></div>';
            }
            html += '<div style="font-weight:600;margin-bottom:6px;color:var(--text);font-size:0.78rem;">üìß All emails sent</div>';
            html += loc.allEmails.map(function(em) {
              var statusBadge = em.replied ? '<span class="loc-event-badge replied" style="font-size:0.65rem;">‚úÖ Replied</span>' :
                em.bounced ? '<span class="loc-event-badge bounced" style="font-size:0.65rem;">‚õî Bounced</span>' :
                em.opens >= 3 ? '<span class="loc-event-badge hot-opens" style="font-size:0.65rem;">üî• ' + em.opens + ' opens</span>' :
                em.opens > 0 ? '<span class="loc-event-badge opens" style="font-size:0.65rem;">üëÅ ' + em.opens + '</span>' :
                '<span style="color:var(--muted);font-size:0.65rem;">No opens</span>';
              var sentTs = em.sent_at ? new Date(em.sent_at).toLocaleString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit', hour12: true }) : '‚Äî';
              var lastOpenTs = em.last_opened ? '  ¬∑  Last opened: ' + new Date(em.last_opened).toLocaleString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit', hour12: true }) : '';
              var openedBy = em.last_event_by && em.last_event === 'opened' ? '  ¬∑  By: ' + em.last_event_by : '';
              return '<div class="email-row">' +
                '<div class="email-subj">' + (em.subject || 'Follow-up') + '</div>' +
                statusBadge +
                '<div class="email-ts">Sent ' + sentTs + lastOpenTs + openedBy + '</div>' +
              '</div>';
            }).join('');
            html += '</div>';
          }
          return html;
        }).join('');

        return '<div class="loc-card ' + cardClass + '" onclick="window.location.href=\'/prospect/' + loc.id + '\'">' +
          '<div class="loc-header">' +
            '<div class="loc-name">' + loc.name + (loc.type ? '<span class="loc-type">' + loc.type + '</span>' : '') + '</div>' +
            '<span class="loc-stage ' + stageClass + '">' + stageLabel + '</span>' +
          '</div>' +
          '<div class="loc-timeline">' + eventsHtml + '</div>' +
        '</div>';
      }).join('');
    }
  }).catch(function(e) {
    console.error('Sales center error:', e);
  });

  // --- Fetch all data ---
  Promise.all([
    fetch('/api/stats').then(r => r.ok ? r.json() : {}),
    fetch('/api/prospects').then(r => r.ok ? r.json() : []),
    fetch('/api/activities').then(r => r.ok ? r.json() : []),
    fetch('/api/crm-tasks').then(r => r.ok ? r.json() : []),
    fetch('/api/pipeline/cards').then(r => r.ok ? r.json() : []),
    fetch('/api/pipeline/stages').then(r => r.ok ? r.json() : []),
    fetch('/api/finances/summary').then(r => r.ok ? r.json() : {})
  ]).then(function(results) {
    var stats = results[0] || {};
    var prospects = results[1] || [];
    var activities = results[2] || [];
    var tasks = Array.isArray(results[3]) ? results[3] : (results[3].tasks || []);
    var pipelineCards = results[4] || [];
    var pipelineStages = results[5] || [];
    var finances = results[6] || {};

    // --- KPIs ---
    document.getElementById('kpi-prospects').textContent = fmt(prospects.length);
    document.getElementById('kpi-hot').textContent = fmt(prospects.filter(p => p.priority === 'hot').length);
    document.getElementById('kpi-signed').textContent = fmt(prospects.filter(p => p.status === 'signed').length);
    document.getElementById('kpi-revenue').textContent = money(finances.currentRevenue || 0);
    
    // Pipeline value estimate ($2K/month per prospect in advanced stages)
    var advancedStages = ['proposal_sent', 'negotiating', 'contract_sent'];
    var pipelineValue = pipelineCards.filter(c => advancedStages.includes(c.stage)).length * 24000;
    document.getElementById('kpi-pipeline').textContent = money(pipelineValue);
    
    // Trend calculations
    var weekAgo = new Date(now - 7 * 24 * 60 * 60 * 1000);
    var newThisWeek = prospects.filter(p => new Date(p.created_at) > weekAgo).length;
    document.getElementById('kpi-prospects-trend').innerHTML = newThisWeek > 0 
      ? '<span style="color:var(--green)">‚Üë ' + newThisWeek + ' this week</span>' 
      : 'No new this week';
    
    var weekActivities = activities.filter(a => new Date(a.created_at) > weekAgo).length;
    document.getElementById('kpi-hot-trend').innerHTML = weekActivities + ' activities this week';

    // Revenue trend
    if (finances.lastRevenue && finances.currentRevenue) {
      var revChange = ((finances.currentRevenue - finances.lastRevenue) / (finances.lastRevenue || 1) * 100).toFixed(0);
      var trendEl = document.getElementById('kpi-revenue-trend');
      if (revChange > 0) {
        trendEl.className = 'kpi-trend up';
        trendEl.innerHTML = '‚Üë ' + revChange + '% vs last month';
      } else if (revChange < 0) {
        trendEl.className = 'kpi-trend down';
        trendEl.innerHTML = '‚Üì ' + Math.abs(revChange) + '% vs last month';
      } else {
        trendEl.innerHTML = 'Same as last month';
      }
    }

    // --- Priorities: Overdue Follow-ups ---
    var overdue = prospects.filter(function(p) {
      var nextDate = p.next_action_date;
      return nextDate && nextDate < today && p.status !== 'signed' && p.status !== 'closed';
    }).sort((a, b) => (a.next_action_date || '').localeCompare(b.next_action_date || '')).slice(0, 3);

    document.getElementById('overdue-count').textContent = overdue.length;
    var overdueList = document.getElementById('overdue-list');
    if (overdue.length === 0) {
      overdueList.innerHTML = '<li class="priority-empty">üéâ No overdue follow-ups!</li>';
    } else {
      overdueList.innerHTML = overdue.map(function(p) {
        var daysOver = Math.floor((new Date(today) - new Date(p.next_action_date)) / 86400000);
        return '<li class="priority-item"><span class="priority-dot red"></span><div class="priority-content">' +
          '<div class="priority-name">' + p.name + '</div>' +
          '<div class="priority-meta">' + (p.next_action || 'Follow up') + ' ¬∑ ' + daysOver + ' day' + (daysOver > 1 ? 's' : '') + ' overdue</div>' +
          '</div></li>';
      }).join('');
    }

    // --- Priorities: Scheduled Today ---
    var scheduledToday = activities.filter(function(a) {
      var aDate = (a.scheduled_date || a.next_action_date || '').split('T')[0];
      return aDate === today;
    }).slice(0, 3);

    document.getElementById('scheduled-count').textContent = scheduledToday.length;
    var scheduledList = document.getElementById('scheduled-list');
    if (scheduledToday.length === 0) {
      scheduledList.innerHTML = '<li class="priority-empty">No activities scheduled today</li>';
    } else {
      scheduledList.innerHTML = scheduledToday.map(function(a) {
        var prospect = prospects.find(p => p.id === a.prospect_id);
        return '<li class="priority-item"><span class="priority-dot amber"></span><div class="priority-content">' +
          '<div class="priority-name">' + (prospect ? prospect.name : 'Unknown') + '</div>' +
          '<div class="priority-meta">' + (a.type || 'Activity') + ': ' + (a.description || '').slice(0, 40) + '</div>' +
          '</div></li>';
      }).join('');
    }

    // --- Priorities: Tasks Due Today ---
    var tasksDue = tasks.filter(function(t) {
      var due = (t.due_date || t.dueDate || '').split('T')[0];
      return due === today && t.status !== 'done' && t.status !== 'completed';
    }).slice(0, 3);

    document.getElementById('tasks-count').textContent = tasksDue.length;
    var tasksList = document.getElementById('tasks-list');
    if (tasksDue.length === 0) {
      tasksList.innerHTML = '<li class="priority-empty">üéâ No tasks due today!</li>';
    } else {
      tasksList.innerHTML = tasksDue.map(function(t) {
        return '<li class="priority-item"><span class="priority-dot green"></span><div class="priority-content">' +
          '<div class="priority-name">' + (t.title || t.name || 'Untitled') + '</div>' +
          '<div class="priority-meta">' + (t.category || 'Task') + '</div>' +
          '</div></li>';
      }).join('');
    }

    // --- Activity Feed ---
    var recentActivities = activities.slice(0, 10);
    var feed = document.getElementById('activity-feed');
    if (recentActivities.length === 0) {
      feed.innerHTML = '<li class="priority-empty">No recent activity</li>';
    } else {
      feed.innerHTML = recentActivities.map(function(a) {
        var prospect = prospects.find(p => p.id === a.prospect_id);
        var pName = prospect ? prospect.name : '';
        var desc = a.description || a.notes || a.type || '';
        var time = a.created_at || '';
        var iconColor = actColor(a.type);
        return '<li class="activity-item">' +
          '<div class="activity-icon ' + iconColor + '">' + actIcon(a.type) + '</div>' +
          '<div class="activity-content"><div class="activity-text">' + 
          (pName ? '<strong>' + pName + '</strong> ‚Äî ' : '') + desc.slice(0, 60) +
          '</div><div class="activity-time">' + timeAgo(time) + '</div></div></li>';
      }).join('');
    }

    // --- Alerts ---
    var alerts = [];
    // Overdue items
    if (overdue.length > 0) {
      alerts.push({ icon: 'üö®', text: overdue.length + ' overdue follow-up' + (overdue.length > 1 ? 's' : '') + ' need attention', action: 'View', href: '/crm' });
    }
    // Hot leads without recent activity
    var hotNoActivity = prospects.filter(function(p) {
      if (p.priority !== 'hot') return false;
      var lastAct = activities.filter(a => a.prospect_id === p.id).sort((a,b) => new Date(b.created_at) - new Date(a.created_at))[0];
      if (!lastAct) return true;
      var daysSince = (Date.now() - new Date(lastAct.created_at).getTime()) / 86400000;
      return daysSince > 3;
    });
    if (hotNoActivity.length > 0) {
      alerts.push({ icon: 'üî•', text: hotNoActivity.length + ' hot lead' + (hotNoActivity.length > 1 ? 's' : '') + ' need follow-up', action: 'View', href: '/crm?priority=hot' });
    }
    // Low pipeline
    if (pipelineCards.filter(c => c.stage === 'new_lead' || c.stage === 'contacted').length < 3) {
      alerts.push({ icon: 'üìä', text: 'Pipeline is low ‚Äî time for more prospecting!', action: 'Add', href: '/crm#add' });
    }

    var alertsCard = document.getElementById('alerts-card');
    var alertsList = document.getElementById('alerts-list');
    if (alerts.length > 0) {
      alertsCard.style.display = 'block';
      alertsList.innerHTML = alerts.slice(0, 3).map(function(a) {
        return '<div class="alert-item"><span class="alert-icon">' + a.icon + '</span>' +
          '<span class="alert-text">' + a.text + '</span>' +
          '<a class="alert-action" href="' + a.href + '">' + a.action + ' ‚Üí</a></div>';
      }).join('');
    }

    // --- Pipeline Funnel (use prospects status if pipeline is empty) ---
    var stageOrder = ['new_lead', 'contacted', 'pop_in_done', 'interested', 'site_survey', 'proposal_sent', 'negotiating', 'contract_sent', 'signed'];
    var stageCounts = {};
    
    // Use pipeline cards if available, otherwise use prospects by status
    if (pipelineCards && pipelineCards.length > 0) {
      pipelineCards.forEach(function(c) {
        var s = c.stage || 'new_lead';
        stageCounts[s] = (stageCounts[s] || 0) + 1;
      });
    } else if (prospects && prospects.length > 0) {
      // Map prospect status to pipeline stages
      var statusToStage = {
        'new': 'new_lead', 'hot': 'interested', 'warm': 'contacted', 'cold': 'new_lead',
        'contacted': 'contacted', 'interested': 'interested', 'proposal_sent': 'proposal_sent',
        'signed': 'signed', 'lost': 'new_lead'
      };
      prospects.forEach(function(p) {
        var status = (p.status || 'new').toLowerCase();
        var s = statusToStage[status] || 'new_lead';
        stageCounts[s] = (stageCounts[s] || 0) + 1;
      });
    }
    
    var maxCount = Math.max(1, ...Object.values(stageCounts));
    var funnelEl = document.getElementById('pipeline-funnel');
    
    var stageLabels = {
      new_lead: 'New', contacted: 'Contact', pop_in_done: 'Pop-in', interested: 'Interest',
      site_survey: 'Survey', proposal_sent: 'Proposal', negotiating: 'Negotiate', 
      contract_sent: 'Contract', signed: 'Signed'
    };
    
    funnelEl.innerHTML = stageOrder.map(function(s) {
      var count = stageCounts[s] || 0;
      var height = Math.max(30, (count / maxCount) * 100);
      var colors = ['#3b82f6', '#60a5fa', '#93c5fd', '#fbbf24', '#f59e0b', '#f97316', '#ef4444', '#22c55e', '#10b981'];
      var idx = stageOrder.indexOf(s);
      return '<div class="pipeline-bar" style="height:' + height + 'px;background:' + colors[idx] + '">' +
        '<span class="bar-label">' + (stageLabels[s] || s) + '</span>' +
        (count > 0 ? '<span class="bar-count">' + count + '</span>' : '') + '</div>';
    }).join('');

    // --- Activity Chart (7 days) ---
    var activityByDay = {};
    for (var i = 6; i >= 0; i--) {
      var d = new Date(now);
      d.setDate(d.getDate() - i);
      var key = d.toISOString().split('T')[0];
      activityByDay[key] = 0;
    }
    activities.forEach(function(a) {
      var d = (a.created_at || '').split('T')[0];
      if (activityByDay.hasOwnProperty(d)) activityByDay[d]++;
    });
    var labels = Object.keys(activityByDay).map(function(d) {
      return new Date(d + 'T12:00:00').toLocaleDateString('en-US', { weekday: 'short' });
    });
    
    new Chart(document.getElementById('activity-chart'), {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: 'Activities',
          data: Object.values(activityByDay),
          borderColor: '#3b82f6',
          backgroundColor: 'rgba(59,130,246,0.1)',
          fill: true,
          tension: 0.3,
          pointRadius: 4,
          pointBackgroundColor: '#3b82f6'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          y: { beginAtZero: true, ticks: { stepSize: 1 } },
          x: { grid: { display: false } }
        }
      }
    });

    // --- Revenue Chart ---
    var months = finances.months || {};
    var monthLabels = Object.keys(months).sort().slice(-6);
    var revenueData = monthLabels.map(function(m) { return months[m].revenue || 0; });
    
    if (monthLabels.length > 0) {
      new Chart(document.getElementById('revenue-chart'), {
        type: 'bar',
        data: {
          labels: monthLabels.map(function(m) {
            var [y, mo] = m.split('-');
            return new Date(y, parseInt(mo) - 1).toLocaleDateString('en-US', { month: 'short' });
          }),
          datasets: [{
            label: 'Revenue',
            data: revenueData,
            backgroundColor: '#22c55e',
            borderRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: { beginAtZero: true, ticks: { callback: function(v) { return '$' + (v >= 1000 ? (v/1000) + 'k' : v); } } },
            x: { grid: { display: false } }
          }
        }
      });
    } else {
      document.getElementById('revenue-chart').parentElement.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100%;color:var(--muted);font-size:0.85rem;">No revenue data yet</div>';
    }

  }).catch(function(err) {
    console.error('Dashboard load error:', err);
  });

})();
</script>
</body>
</html>
