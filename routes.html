<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-vend-32.png">
  <title>Kande VendTech ‚Äî Routes</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg: #f5f5f7; --card: #ffffff; --border: #e2e8f0; --text: #1a202c;
      --muted: #718096; --accent: #3182ce; --hot: #e53e3e; --warn: #dd6b20;
      --success: #38a169; --purple: #7b2cbf; --radius: 12px;
    }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }
    .app { max-width: 1600px; margin: 0 auto; padding: 20px; }

    .page-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; flex-wrap: wrap; gap: 12px; }
    .page-header h1 { font-size: 1.6rem; font-weight: 700; display: flex; align-items: center; gap: 10px; }
    .header-actions { display: flex; gap: 8px; flex-wrap: wrap; }

    .btn { display: inline-flex; align-items: center; gap: 6px; padding: 10px 18px; border-radius: 8px; border: 1px solid var(--border); background: var(--card); color: var(--text); font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.15s; }
    .btn:hover { background: #f0f4f8; }
    .btn-primary { background: var(--accent); color: #fff; border-color: var(--accent); }
    .btn-primary:hover { background: #2b6cb0; }
    .btn-success { background: var(--success); color: #fff; border-color: var(--success); }
    .btn-danger { background: var(--hot); color: #fff; border-color: var(--hot); }
    .btn-sm { padding: 6px 12px; font-size: 0.78rem; }

    .tab-bar { display: flex; gap: 4px; margin-bottom: 20px; background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 4px; }
    .tab-btn { padding: 8px 18px; border: none; background: none; border-radius: 8px; font-size: 0.85rem; font-weight: 600; cursor: pointer; color: var(--muted); transition: all 0.15s; }
    .tab-btn.active { background: var(--accent); color: #fff; }
    .tab-btn:hover:not(.active) { background: #f0f4f8; color: var(--text); }

    /* Map + Route Builder Layout */
    .route-layout { display: grid; grid-template-columns: 1fr 380px; gap: 20px; margin-bottom: 24px; }
    @media (max-width: 900px) { .route-layout { grid-template-columns: 1fr; } }

    #routeMap { height: 500px; border-radius: var(--radius); border: 1px solid var(--border); z-index: 1; }

    .route-sidebar { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; display: flex; flex-direction: column; max-height: 500px; }
    .sidebar-header { padding: 14px 16px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
    .sidebar-header h3 { font-size: 0.95rem; font-weight: 700; }
    .sidebar-body { flex: 1; overflow-y: auto; padding: 8px; }
    .sidebar-footer { padding: 12px; border-top: 1px solid var(--border); background: #fafbfc; }
    .sidebar-footer .route-summary { display: flex; gap: 16px; font-size: 0.82rem; }
    .sidebar-footer .route-summary span { font-weight: 700; }

    /* Stop Card (draggable) */
    .stop-card { display: flex; align-items: center; gap: 10px; padding: 10px 12px; border: 1px solid var(--border); border-radius: 8px; margin-bottom: 6px; background: var(--card); cursor: grab; transition: all 0.15s; user-select: none; }
    .stop-card:active { cursor: grabbing; }
    .stop-card.dragging { opacity: 0.4; background: #f0f4f8; }
    .stop-card.drop-target { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(49,130,206,0.2); }
    .stop-num { width: 26px; height: 26px; border-radius: 50%; background: var(--accent); color: #fff; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 0.75rem; flex-shrink: 0; }
    .stop-info { flex: 1; min-width: 0; }
    .stop-name { font-weight: 600; font-size: 0.82rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .stop-addr { font-size: 0.72rem; color: var(--muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .stop-meta { display: flex; gap: 6px; margin-top: 3px; }
    .stop-tag { font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; font-weight: 600; }
    .stop-tag.time { background: rgba(123,44,191,0.1); color: var(--purple); }
    .stop-tag.products { background: rgba(49,130,206,0.1); color: var(--accent); }
    .stop-actions { display: flex; flex-direction: column; gap: 4px; }
    .stop-actions button { background: none; border: none; cursor: pointer; font-size: 0.85rem; color: var(--muted); padding: 2px; }
    .stop-actions button:hover { color: var(--hot); }

    /* Template Cards */
    .template-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px; margin-bottom: 24px; }
    .template-card { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 18px; transition: all 0.15s; }
    .template-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.06); }
    .template-card h4 { font-size: 1rem; margin-bottom: 4px; }
    .template-card .desc { font-size: 0.82rem; color: var(--muted); margin-bottom: 10px; }
    .template-meta { display: flex; gap: 12px; font-size: 0.78rem; color: var(--muted); margin-bottom: 12px; }
    .template-meta span { display: flex; align-items: center; gap: 4px; }
    .template-actions { display: flex; gap: 8px; }

    /* Daily Route Sheet */
    .route-sheet { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; margin-bottom: 16px; }
    .sheet-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 8px; }
    .sheet-header h3 { font-size: 1.1rem; }
    .data-table { width: 100%; border-collapse: collapse; }
    .data-table th { background: #edf2f7; padding: 10px 14px; font-size: 0.75rem; text-transform: uppercase; color: var(--muted); font-weight: 700; text-align: left; }
    .data-table td { padding: 10px 14px; border-top: 1px solid var(--border); font-size: 0.85rem; }
    .data-table tr:hover td { background: #fafbfc; }

    /* Stats */
    .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; margin-bottom: 24px; }
    .stat-card { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px; text-align: center; }
    .stat-card .value { font-size: 1.8rem; font-weight: 800; }
    .stat-card .label { font-size: 0.75rem; color: var(--muted); text-transform: uppercase; margin-top: 4px; }
    .value.accent { color: var(--accent); }
    .value.success { color: var(--success); }
    .value.warn { color: var(--warn); }

    /* Modal */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); z-index: 1000; align-items: center; justify-content: center; }
    .modal-overlay.open { display: flex; }
    .modal { background: var(--card); border-radius: 16px; padding: 24px; width: 90%; max-width: 500px; box-shadow: 0 20px 60px rgba(0,0,0,0.15); }
    .modal h3 { font-size: 1.1rem; margin-bottom: 16px; }
    .form-group { margin-bottom: 14px; }
    .form-group label { display: block; font-size: 0.8rem; font-weight: 600; margin-bottom: 4px; color: var(--muted); }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 0.9rem; }
    .modal-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 16px; }

    .empty-state { text-align: center; padding: 40px; color: var(--muted); }
    .empty-state .icon { font-size: 2.5rem; margin-bottom: 8px; }
  </style>
</head>
<body>
  <script src="/nav.js"></script>
  <div class="app">
    <div class="page-header">
      <h1>üöõ Routes</h1>
      <div class="header-actions">
        <button class="btn btn-primary" onclick="openNewTemplate()">+ New Route Template</button>
        <button class="btn" onclick="generateDailySheet()">üìã Today's Sheet</button>
      </div>
    </div>

    <div class="stats-row">
      <div class="stat-card"><div class="value accent" id="statTemplates">0</div><div class="label">Route Templates</div></div>
      <div class="stat-card"><div class="value success" id="statTotalStops">0</div><div class="label">Total Stops</div></div>
      <div class="stat-card"><div class="value warn" id="statEstTime">0h</div><div class="label">Total Est. Time</div></div>
      <div class="stat-card"><div class="value accent" id="statAvgStops">0</div><div class="label">Avg Stops/Route</div></div>
    </div>

    <div class="tab-bar">
      <button class="tab-btn active" onclick="switchTab('map', this)">üó∫Ô∏è Map & Builder</button>
      <button class="tab-btn" onclick="switchTab('templates', this)">üìÅ Templates</button>
      <button class="tab-btn" onclick="switchTab('daily', this)">üìã Daily Sheet</button>
    </div>

    <!-- Map & Route Builder -->
    <div id="tab-map">
      <div class="route-layout">
        <div id="routeMap"></div>
        <div class="route-sidebar">
          <div class="sidebar-header">
            <h3>Route Builder</h3>
            <select id="templateSelect" style="font-size:0.8rem;padding:4px 8px;border:1px solid var(--border);border-radius:6px;" onchange="loadTemplate(this.value)">
              <option value="">‚Äî New Route ‚Äî</option>
            </select>
          </div>
          <div class="sidebar-body" id="stopsList"></div>
          <div class="sidebar-footer">
            <div class="route-summary">
              <div>Stops: <span id="summaryStops">0</span></div>
              <div>Drive: <span id="summaryDrive">0 min</span></div>
              <div>Service: <span id="summaryService">0 min</span></div>
              <div>Total: <span id="summaryTotal">0h 0m</span></div>
            </div>
            <div style="display:flex;gap:8px;margin-top:10px">
              <button class="btn btn-sm btn-primary" onclick="saveAsTemplate()" style="flex:1">üíæ Save Template</button>
              <button class="btn btn-sm btn-success" onclick="optimizeRoute()" style="flex:1">‚ö° Optimize</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Templates -->
    <div id="tab-templates" style="display:none">
      <div class="template-grid" id="templateGrid"></div>
    </div>

    <!-- Daily Route Sheet -->
    <div id="tab-daily" style="display:none">
      <div id="dailySheetContainer"></div>
    </div>
  </div>

  <!-- Save Template Modal -->
  <div class="modal-overlay" id="templateModal">
    <div class="modal">
      <h3 id="tmplModalTitle">Save Route Template</h3>
      <input type="hidden" id="editTemplateId">
      <div class="form-group">
        <label>Route Name</label>
        <input type="text" id="tmplName" placeholder="e.g., Henderson East Loop">
      </div>
      <div class="form-group">
        <label>Description</label>
        <textarea id="tmplDesc" rows="2" placeholder="Optional notes about this route..."></textarea>
      </div>
      <div class="form-group">
        <label>Days of Week</label>
        <div style="display:flex;gap:6px;flex-wrap:wrap;" id="tmplDays">
          <label style="font-size:0.82rem;display:flex;align-items:center;gap:4px"><input type="checkbox" value="Mon"> Mon</label>
          <label style="font-size:0.82rem;display:flex;align-items:center;gap:4px"><input type="checkbox" value="Tue"> Tue</label>
          <label style="font-size:0.82rem;display:flex;align-items:center;gap:4px"><input type="checkbox" value="Wed"> Wed</label>
          <label style="font-size:0.82rem;display:flex;align-items:center;gap:4px"><input type="checkbox" value="Thu"> Thu</label>
          <label style="font-size:0.82rem;display:flex;align-items:center;gap:4px"><input type="checkbox" value="Fri"> Fri</label>
          <label style="font-size:0.82rem;display:flex;align-items:center;gap:4px"><input type="checkbox" value="Sat"> Sat</label>
          <label style="font-size:0.82rem;display:flex;align-items:center;gap:4px"><input type="checkbox" value="Sun"> Sun</label>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn" onclick="closeTemplateModal()">Cancel</button>
        <button class="btn btn-primary" onclick="confirmSaveTemplate()">Save</button>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    let map, markers = [], routeLine;
    let machines = [];
    let currentStops = [];
    let templates = [];
    let dragSrcIdx = null;

    // Init map centered on Las Vegas/Henderson
    function initMap() {
      map = L.map('routeMap').setView([36.03, -115.05], 11);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
      }).addTo(map);
    }

    function switchTab(tab, btn) {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      ['map','templates','daily'].forEach(t => {
        document.getElementById('tab-' + t).style.display = t === tab ? '' : 'none';
      });
      if (tab === 'map') setTimeout(() => map.invalidateSize(), 100);
    }

    async function loadData() {
      try {
        const [machRes, tmplRes] = await Promise.all([
          fetch('/api/machines').then(r => r.json()),
          fetch('/api/routes/templates').then(r => r.json())
        ]);
        machines = Array.isArray(machRes) ? machRes : machRes.machines || [];
        templates = tmplRes.templates || [];
      } catch(e) { console.error('Load error:', e); machines = []; templates = []; }

      plotMachines();
      renderTemplateSelect();
      renderTemplateGrid();
      updateStats();
      if (templates.length > 0) generateDailySheet();
    }

    function plotMachines() {
      markers.forEach(m => map.removeLayer(m));
      markers = [];

      machines.forEach(m => {
        const lat = m.lat || (m.location && m.location.lat);
        const lng = m.lng || (m.location && m.location.lng);
        if (!lat || !lng) return;

        const isInRoute = currentStops.some(s => s.machine_id === m.id);
        const icon = L.divIcon({
          className: 'custom-marker',
          html: `<div style="width:28px;height:28px;border-radius:50%;background:${isInRoute ? '#3182ce' : '#718096'};color:#fff;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;border:2px solid #fff;box-shadow:0 2px 6px rgba(0,0,0,0.3)">${isInRoute ? currentStops.findIndex(s=>s.machine_id===m.id)+1 : '‚Ä¢'}</div>`,
          iconSize: [28, 28],
          iconAnchor: [14, 14]
        });

        const marker = L.marker([lat, lng], { icon }).addTo(map);
        marker.bindPopup(`
          <strong>${m.name || 'Machine ' + m.id}</strong><br>
          ${m.address || m.location_name || ''}<br>
          <button onclick="addStop(${m.id})" style="margin-top:6px;padding:4px 10px;background:#3182ce;color:#fff;border:none;border-radius:4px;cursor:pointer;font-size:0.8rem">
            ${isInRoute ? '‚úì In Route' : '+ Add to Route'}
          </button>
        `);
        markers.push(marker);
      });
    }

    function addStop(machineId) {
      if (currentStops.some(s => s.machine_id === machineId)) return;
      const m = machines.find(x => x.id === machineId);
      if (!m) return;

      const loc = m.location || {};
      currentStops.push({
        machine_id: m.id,
        machine_name: m.name || 'Machine ' + m.id,
        address: m.address || loc.address || '',
        lat: m.lat || loc.lat,
        lng: m.lng || loc.lng,
        est_service_time: 15,
        products_needed: [],
        notes: ''
      });

      renderStops();
      plotMachines();
      drawRouteLine();
      updateSummary();
    }

    function removeStop(idx) {
      currentStops.splice(idx, 1);
      renderStops();
      plotMachines();
      drawRouteLine();
      updateSummary();
    }

    function renderStops() {
      const list = document.getElementById('stopsList');
      if (currentStops.length === 0) {
        list.innerHTML = '<div class="empty-state"><div class="icon">üìç</div><p>Click machines on the map to build your route</p></div>';
        return;
      }

      list.innerHTML = currentStops.map((s, i) => `
        <div class="stop-card" draggable="true" data-idx="${i}"
          ondragstart="stopDragStart(event,${i})" ondragover="stopDragOver(event,${i})" 
          ondrop="stopDrop(event,${i})" ondragend="stopDragEnd(event)">
          <div class="stop-num">${i + 1}</div>
          <div class="stop-info">
            <div class="stop-name">${s.machine_name}</div>
            <div class="stop-addr">${s.address}</div>
            <div class="stop-meta">
              <span class="stop-tag time">‚è± ${s.est_service_time}m</span>
              ${i > 0 ? `<span class="stop-tag products">üöó ${estimateDriveTime(currentStops[i-1], s)}m drive</span>` : ''}
            </div>
          </div>
          <div class="stop-actions">
            <button onclick="removeStop(${i})" title="Remove">üóëÔ∏è</button>
          </div>
        </div>
      `).join('');
    }

    // Stop drag reordering
    function stopDragStart(e, idx) {
      dragSrcIdx = idx;
      e.target.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
    }
    function stopDragOver(e, idx) {
      e.preventDefault();
      const cards = document.querySelectorAll('.stop-card');
      cards.forEach(c => c.classList.remove('drop-target'));
      if (idx !== dragSrcIdx) e.currentTarget.classList.add('drop-target');
    }
    function stopDrop(e, idx) {
      e.preventDefault();
      if (dragSrcIdx === null || dragSrcIdx === idx) return;
      const item = currentStops.splice(dragSrcIdx, 1)[0];
      currentStops.splice(idx, 0, item);
      dragSrcIdx = null;
      renderStops();
      plotMachines();
      drawRouteLine();
      updateSummary();
    }
    function stopDragEnd(e) {
      document.querySelectorAll('.stop-card').forEach(c => c.classList.remove('dragging', 'drop-target'));
      dragSrcIdx = null;
    }

    function estimateDriveTime(from, to) {
      if (!from.lat || !from.lng || !to.lat || !to.lng) return 10;
      // Rough estimate: ~1 min per 0.5 miles, using haversine-ish
      const dLat = Math.abs(from.lat - to.lat);
      const dLng = Math.abs(from.lng - to.lng);
      const dist = Math.sqrt(dLat * dLat + dLng * dLng) * 69; // rough miles
      return Math.max(3, Math.round(dist * 2.5)); // ~2.5 min per mile in Vegas traffic
    }

    function drawRouteLine() {
      if (routeLine) map.removeLayer(routeLine);
      const coords = currentStops.filter(s => s.lat && s.lng).map(s => [s.lat, s.lng]);
      if (coords.length < 2) return;
      routeLine = L.polyline(coords, { color: '#3182ce', weight: 3, opacity: 0.7, dashArray: '8, 8' }).addTo(map);
      map.fitBounds(routeLine.getBounds().pad(0.1));
    }

    function updateSummary() {
      const stops = currentStops.length;
      let totalDrive = 0;
      let totalService = 0;

      currentStops.forEach((s, i) => {
        totalService += s.est_service_time || 15;
        if (i > 0) totalDrive += estimateDriveTime(currentStops[i - 1], s);
      });

      const total = totalDrive + totalService;
      document.getElementById('summaryStops').textContent = stops;
      document.getElementById('summaryDrive').textContent = totalDrive + ' min';
      document.getElementById('summaryService').textContent = totalService + ' min';
      document.getElementById('summaryTotal').textContent = `${Math.floor(total/60)}h ${total%60}m`;
    }

    function optimizeRoute() {
      if (currentStops.length < 3) return;
      // Simple nearest-neighbor optimization
      const optimized = [currentStops[0]];
      const remaining = currentStops.slice(1);

      while (remaining.length > 0) {
        const last = optimized[optimized.length - 1];
        let bestIdx = 0, bestDist = Infinity;
        remaining.forEach((s, i) => {
          const d = estimateDriveTime(last, s);
          if (d < bestDist) { bestDist = d; bestIdx = i; }
        });
        optimized.push(remaining.splice(bestIdx, 1)[0]);
      }

      currentStops = optimized;
      renderStops();
      plotMachines();
      drawRouteLine();
      updateSummary();
    }

    // Templates
    function renderTemplateSelect() {
      const sel = document.getElementById('templateSelect');
      sel.innerHTML = '<option value="">‚Äî New Route ‚Äî</option>' + templates.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
    }

    function loadTemplate(id) {
      if (!id) { currentStops = []; renderStops(); plotMachines(); drawRouteLine(); updateSummary(); return; }
      const tmpl = templates.find(t => String(t.id) === String(id));
      if (!tmpl) return;

      currentStops = (tmpl.stops || []).map(s => ({
        machine_id: s.machine_id,
        machine_name: s.machine_name || machines.find(m => m.id === s.machine_id)?.name || 'Machine ' + s.machine_id,
        address: s.address || machines.find(m => m.id === s.machine_id)?.address || '',
        lat: s.lat || machines.find(m => m.id === s.machine_id)?.lat,
        lng: s.lng || machines.find(m => m.id === s.machine_id)?.lng,
        est_service_time: s.est_service_time || 15,
        products_needed: s.products_needed || [],
        notes: s.notes || ''
      }));

      renderStops();
      plotMachines();
      drawRouteLine();
      updateSummary();
    }

    function renderTemplateGrid() {
      const grid = document.getElementById('templateGrid');
      if (templates.length === 0) {
        grid.innerHTML = '<div class="empty-state"><div class="icon">üìÅ</div><p>No route templates yet. Build a route on the map and save it!</p></div>';
        return;
      }

      grid.innerHTML = templates.map(t => {
        const stops = (t.stops || []).length;
        const estTime = t.est_time || stops * 20;
        const days = (t.days || []).join(', ') || 'Any day';
        return `
          <div class="template-card">
            <h4>${t.name}</h4>
            <p class="desc">${t.description || 'No description'}</p>
            <div class="template-meta">
              <span>üìç ${stops} stops</span>
              <span>‚è± ${Math.floor(estTime/60)}h ${estTime%60}m</span>
              <span>üìÖ ${days}</span>
            </div>
            <div class="template-actions">
              <button class="btn btn-sm btn-primary" onclick="loadTemplateAndSwitch(${t.id})">Open</button>
              <button class="btn btn-sm" onclick="duplicateTemplate(${t.id})">üìã Duplicate</button>
              <button class="btn btn-sm btn-danger" onclick="deleteTemplate(${t.id})">Delete</button>
            </div>
          </div>`;
      }).join('');
    }

    function loadTemplateAndSwitch(id) {
      document.getElementById('templateSelect').value = id;
      loadTemplate(id);
      switchTab('map', document.querySelector('.tab-btn'));
    }

    function openNewTemplate() {
      document.getElementById('tmplModalTitle').textContent = 'Save Route Template';
      document.getElementById('editTemplateId').value = '';
      document.getElementById('tmplName').value = '';
      document.getElementById('tmplDesc').value = '';
      document.querySelectorAll('#tmplDays input').forEach(cb => cb.checked = false);
      document.getElementById('templateModal').classList.add('open');
    }

    function saveAsTemplate() {
      if (currentStops.length === 0) { alert('Add stops to the route first!'); return; }
      const sel = document.getElementById('templateSelect');
      if (sel.value) {
        document.getElementById('editTemplateId').value = sel.value;
        const tmpl = templates.find(t => String(t.id) === sel.value);
        if (tmpl) {
          document.getElementById('tmplName').value = tmpl.name;
          document.getElementById('tmplDesc').value = tmpl.description || '';
          (tmpl.days || []).forEach(d => {
            const cb = document.querySelector(`#tmplDays input[value="${d}"]`);
            if (cb) cb.checked = true;
          });
        }
      }
      document.getElementById('templateModal').classList.add('open');
    }

    function closeTemplateModal() { document.getElementById('templateModal').classList.remove('open'); }

    async function confirmSaveTemplate() {
      const name = document.getElementById('tmplName').value.trim();
      if (!name) { alert('Route name required'); return; }

      const days = [];
      document.querySelectorAll('#tmplDays input:checked').forEach(cb => days.push(cb.value));

      const totalDrive = currentStops.reduce((sum, s, i) => i > 0 ? sum + estimateDriveTime(currentStops[i-1], s) : sum, 0);
      const totalService = currentStops.reduce((sum, s) => sum + (s.est_service_time || 15), 0);

      const data = {
        name,
        description: document.getElementById('tmplDesc').value,
        days,
        stops: currentStops,
        est_time: totalDrive + totalService,
        est_drive_time: totalDrive,
        est_service_time: totalService
      };

      const editId = document.getElementById('editTemplateId').value;
      const url = editId ? `/api/routes/templates/${editId}` : '/api/routes/templates';
      const method = editId ? 'PUT' : 'POST';

      await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
      closeTemplateModal();
      loadData();
    }

    async function deleteTemplate(id) {
      if (!confirm('Delete this route template?')) return;
      await fetch(`/api/routes/templates/${id}`, { method: 'DELETE' });
      loadData();
    }

    async function duplicateTemplate(id) {
      const tmpl = templates.find(t => t.id === id);
      if (!tmpl) return;
      await fetch('/api/routes/templates', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ...tmpl, id: undefined, name: tmpl.name + ' (Copy)' })
      });
      loadData();
    }

    function generateDailySheet() {
      switchTab('daily', document.querySelectorAll('.tab-btn')[2]);
      const container = document.getElementById('dailySheetContainer');
      const today = new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
      const dayName = new Date().toLocaleDateString('en-US', { weekday: 'short' });

      // Filter templates for today
      const todayTemplates = templates.filter(t => !t.days || t.days.length === 0 || t.days.includes(dayName));

      if (todayTemplates.length === 0) {
        container.innerHTML = `<div class="route-sheet"><div class="sheet-header"><h3>üìã Daily Route Sheet ‚Äî ${today}</h3></div><p style="color:var(--muted);text-align:center;padding:24px;">No routes scheduled for today.</p></div>`;
        return;
      }

      container.innerHTML = todayTemplates.map(tmpl => {
        const stops = tmpl.stops || [];
        return `<div class="route-sheet">
          <div class="sheet-header">
            <h3>üìã ${tmpl.name} ‚Äî ${today}</h3>
            <div>
              <button class="btn btn-sm" onclick="window.print()">üñ®Ô∏è Print</button>
            </div>
          </div>
          <div style="display:flex;gap:16px;margin-bottom:16px;font-size:0.85rem;">
            <span><strong>Stops:</strong> ${stops.length}</span>
            <span><strong>Est. Time:</strong> ${tmpl.est_time ? Math.floor(tmpl.est_time/60) + 'h ' + tmpl.est_time%60 + 'm' : '‚Äî'}</span>
            <span><strong>Driver:</strong> <em>Unassigned</em></span>
          </div>
          <table class="data-table">
            <thead>
              <tr><th>#</th><th>Machine</th><th>Address</th><th>Service Time</th><th>Products Needed</th><th>Notes</th><th>‚úì</th></tr>
            </thead>
            <tbody>
              ${stops.map((s, i) => `
                <tr>
                  <td><strong>${i + 1}</strong></td>
                  <td>${s.machine_name || 'Machine ' + s.machine_id}</td>
                  <td style="font-size:0.8rem;">${s.address || '‚Äî'}</td>
                  <td>${s.est_service_time || 15} min</td>
                  <td>${(s.products_needed || []).join(', ') || 'Standard mix'}</td>
                  <td style="font-size:0.8rem;">${s.notes || '‚Äî'}</td>
                  <td><input type="checkbox"></td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>`;
      }).join('');
    }

    function updateStats() {
      document.getElementById('statTemplates').textContent = templates.length;
      const totalStops = templates.reduce((s, t) => s + (t.stops || []).length, 0);
      document.getElementById('statTotalStops').textContent = totalStops;
      const totalTime = templates.reduce((s, t) => s + (t.est_time || 0), 0);
      document.getElementById('statEstTime').textContent = totalTime > 0 ? Math.floor(totalTime / 60) + 'h' : '0h';
      document.getElementById('statAvgStops').textContent = templates.length > 0 ? Math.round(totalStops / templates.length) : 0;
    }

    // Init
    initMap();
    loadData();
  </script>
</body>
</html>
