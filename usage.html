<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>API Usage ‚Äî Kande Mission Control</title>
  <link rel="icon" href="apple-touch-icon-vend.png" type="image/png">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="/nav.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f8f9fa;
      color: #1a1a1a;
      line-height: 1.5;
    }

    .container {
      max-width: 1200px;
      margin: 2rem auto;
      padding: 0 1.25rem;
    }

    .page-header {
      margin-bottom: 2rem;
    }
    .page-header h1 {
      font-size: 2rem;
      font-weight: 700;
      color: #111;
    }
    .page-header p {
      color: #6b7280;
      margin-top: 0.25rem;
      font-size: 0.95rem;
    }
    .updated-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      background: #e9f5e9;
      color: #2d7a2d;
      font-size: 0.78rem;
      font-weight: 500;
      padding: 0.2rem 0.7rem;
      border-radius: 999px;
      margin-top: 0.6rem;
    }
    .updated-badge.stale { background: #fff3cd; color: #856404; }
    .updated-badge.none  { background: #f3f4f6; color: #6b7280; }

    /* ‚îÄ‚îÄ Stat cards ‚îÄ‚îÄ */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }
    .stat-card {
      background: #fff;
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      padding: 1.25rem 1.5rem;
    }
    .stat-card .label {
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: #6b7280;
      margin-bottom: 0.4rem;
    }
    .stat-card .value {
      font-size: 2rem;
      font-weight: 700;
      color: #111;
      line-height: 1.1;
    }
    .stat-card .sub {
      font-size: 0.82rem;
      color: #9ca3af;
      margin-top: 0.25rem;
    }

    /* ‚îÄ‚îÄ Chart card ‚îÄ‚îÄ */
    .chart-card {
      background: #fff;
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      padding: 1.75rem;
      margin-bottom: 2rem;
    }
    .chart-card h2 {
      font-size: 1.1rem;
      font-weight: 600;
      color: #111;
      margin-bottom: 1.25rem;
    }
    .chart-wrap {
      position: relative;
      height: 340px;
    }

    /* ‚îÄ‚îÄ Breakdown table ‚îÄ‚îÄ */
    .breakdown-card {
      background: #fff;
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      padding: 1.75rem;
      margin-bottom: 2rem;
    }
    .breakdown-card h2 {
      font-size: 1.1rem;
      font-weight: 600;
      color: #111;
      margin-bottom: 1.25rem;
    }
    .breakdown-table {
      width: 100%;
      border-collapse: collapse;
    }
    .breakdown-table th {
      text-align: left;
      padding: 0.6rem 0.75rem;
      font-size: 0.78rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: #6b7280;
      border-bottom: 1px solid #e2e8f0;
    }
    .breakdown-table td {
      padding: 0.75rem 0.75rem;
      font-size: 0.9rem;
      border-bottom: 1px solid #f1f5f9;
    }
    .breakdown-table tr:last-child td { border-bottom: none; }
    .breakdown-table tr:hover td { background: #f9fafb; }

    .group-dot {
      display: inline-block;
      width: 10px; height: 10px;
      border-radius: 50%;
      margin-right: 0.5rem;
      vertical-align: middle;
    }

    /* ‚îÄ‚îÄ Cost note ‚îÄ‚îÄ */
    .cost-note {
      background: #f0f9ff;
      border: 1px solid #bae6fd;
      border-radius: 8px;
      padding: 1rem 1.25rem;
      font-size: 0.83rem;
      color: #075985;
      margin-bottom: 2rem;
    }
    .cost-note strong { font-weight: 600; }

    .no-data {
      text-align: center;
      padding: 3rem;
      color: #9ca3af;
      font-size: 0.95rem;
    }
  </style>
</head>
<body>

<div class="container">
  <div class="page-header">
    <h1>üìä API Usage &amp; Turn Tracker</h1>
    <p>Assistant turn counts across all session groups ‚Äî last 7 days (2-hour intervals)</p>
    <span class="updated-badge none" id="updated-badge">‚è≥ Loading...</span>
  </div>

  <!-- Summary stats -->
  <div class="stats-grid" id="stats-grid">
    <div class="stat-card"><div class="label">Turns Today</div><div class="value" id="stat-today">‚Äî</div><div class="sub">all groups</div></div>
    <div class="stat-card"><div class="label">7-Day Avg</div><div class="value" id="stat-7day">‚Äî</div><div class="sub">per day</div></div>
    <div class="stat-card"><div class="label">7-Day Total</div><div class="value" id="stat-30day">‚Äî</div><div class="sub">all groups</div></div>
    <div class="stat-card"><div class="label">Est. Daily Cost</div><div class="value" id="stat-cost">‚Äî</div><div class="sub">blended Opus+Sonnet</div></div>
  </div>

  <!-- Line chart -->
  <div class="chart-card">
    <h2>Turns by Group ‚Äî 2-Hour Intervals</h2>
    <div class="chart-wrap">
      <canvas id="turnsChart"></canvas>
    </div>
  </div>

  <!-- Per-group breakdown table -->
  <div class="breakdown-card">
    <h2>Group Breakdown</h2>
    <div id="breakdown-wrap">
      <p class="no-data">Loading data...</p>
    </div>
  </div>

  <!-- Cost methodology note -->
  <div class="cost-note">
    <strong>Cost estimation methodology:</strong>
    Opus 4 = $15/M input + $75/M output (avg 100K context/turn) ‚Üí ~$9.00/turn.
    Sonnet 4 = $3/M input + $15/M output (avg 80K context/turn) ‚Üí ~$1.44/turn.
    Main DM &amp; VendTech Group estimated as 60% Opus / 40% Sonnet. Cron Jobs &amp; Photo Booths as 100% Sonnet.
    Actual costs vary by context length.
  </div>
</div>

<script>
// ‚îÄ‚îÄ Config ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const COLORS = {
  'VendTech Group':   '#3b82f6',  // blue
  'Photo Booths Group': '#f59e0b', // amber
  'Main (DM)':        '#10b981',  // emerald
  'Cron Jobs':        '#8b5cf6',  // violet
};
const DEFAULT_COLOR = '#6b7280';

// Cost per turn (blended): Opus avg 100K ctx/turn, Sonnet 80K
// Opus: ($15 * 0.06 + $75 * 0.04) per turn = $0.90 + $3.00 = $3.90 avg ... 
// Actually: $15/M input * 100K = $1.50 input + $75/M output * 40K out ‚âà $3.00 ‚Üí $4.50 per turn Opus
// Sonnet: $3/M * 80K = $0.24 + $15/M * 32K out = $0.48 ‚Üí $0.72 per turn Sonnet
// Blended 60/40 for main sessions: 0.6*4.50 + 0.4*0.72 = $2.70 + $0.29 = $2.99
// Cron+PB (100% Sonnet): $0.72/turn
const COST_PER_TURN = {
  'VendTech Group':     2.99,
  'Photo Booths Group': 0.72,
  'Main (DM)':          2.99,
  'Cron Jobs':          0.72,
};
const DEFAULT_COST = 1.50;

// ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function todayStr() {
  return new Date().toISOString().slice(0, 10);
}

// Generate all 2-hour slot keys for the last 7 days (in local/LA time)
function last7DaySlots() {
  const slots = [];
  const now = new Date();
  for (let i = 6; i >= 0; i--) {
    const d = new Date(now);
    d.setDate(d.getDate() - i);
    const dateStr = d.toISOString().slice(0, 10);
    for (let h = 0; h < 24; h += 2) {
      slots.push(`${dateStr}T${String(h).padStart(2, '0')}`);
    }
  }
  return slots;
}

// Format a slot key as a human-readable label for major ticks
function slotLabel(slot) {
  const [datePart, hourPart] = slot.split('T');
  const h = parseInt(hourPart);
  if (h === 0) {
    const [, mm, dd] = datePart.split('-');
    return `${parseInt(mm)}/${parseInt(dd)}`;
  }
  if (h === 12) return '12p';
  return '';
}

function color(name) { return COLORS[name] || DEFAULT_COLOR; }

// ‚îÄ‚îÄ Render ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let chartInstance = null;

function render(data) {
  const sessions = data.sessions || [];
  const slots    = last7DaySlots();      // 84 slots
  const today    = todayStr();

  // Build lookup: group ‚Üí slot ‚Üí turns (supports both {slot:} and {date:} formats)
  const lookup = {};
  sessions.forEach(s => {
    lookup[s.name] = {};
    (s.data || []).forEach(d => {
      const key = d.slot || d.date;
      if (key) lookup[s.name][key] = d.turns;
    });
  });

  // Detect if data uses 2h slots or legacy daily format
  let isLegacy = true;
  for (const s of sessions) {
    const first = (s.data || [])[0];
    if (first && first.slot) { isLegacy = false; break; }
  }

  // Stats
  let turnsToday = 0, total7 = 0;
  sessions.forEach(s => {
    (s.data || []).forEach(d => {
      const key  = d.slot || d.date;
      total7 += d.turns;
      // For 2h slots: sum all slots that start with today
      if (key && key.startsWith(today)) turnsToday += d.turns;
    });
  });

  // 7-day average (per day)
  const dailyTotals = {};
  sessions.forEach(s => {
    (s.data || []).forEach(d => {
      const key = d.slot || d.date;
      const dayKey = key ? key.slice(0, 10) : null;
      if (dayKey) dailyTotals[dayKey] = (dailyTotals[dayKey] || 0) + d.turns;
    });
  });
  const numDays = Object.keys(dailyTotals).length || 1;
  const avg7 = Math.round(total7 / numDays);

  // Cost estimate (today)
  let costToday = 0;
  sessions.forEach(s => {
    let t = 0;
    (s.data || []).forEach(d => {
      const key = d.slot || d.date;
      if (key && key.startsWith(today)) t += d.turns;
    });
    costToday += t * (COST_PER_TURN[s.name] || DEFAULT_COST);
  });

  document.getElementById('stat-today').textContent = turnsToday.toLocaleString();
  document.getElementById('stat-7day').textContent = avg7.toLocaleString();
  document.getElementById('stat-30day').textContent = total7.toLocaleString();
  document.getElementById('stat-cost').textContent = `$${costToday.toFixed(2)}`;

  // Updated badge
  const badge = document.getElementById('updated-badge');
  if (data.updatedAt) {
    const ago = Math.round((Date.now() - new Date(data.updatedAt)) / 60000);
    const stale = ago > 60 * 24;
    badge.className = 'updated-badge' + (stale ? ' stale' : '');
    badge.textContent = `‚úì Updated ${ago < 60 ? ago + 'm ago' : Math.round(ago/60) + 'h ago'}`;
  } else {
    badge.className = 'updated-badge none';
    badge.textContent = 'No data yet ‚Äî run the extraction script';
  }

  // Chart datasets ‚Äî use 2h slots if available, fallback to legacy daily
  const xKeys = isLegacy ? [...new Set(sessions.flatMap(s => (s.data||[]).map(d => d.date)))].sort() : slots;
  const datasets = sessions.map(s => ({
    label: s.name,
    data: xKeys.map(slot => {
      if (isLegacy) return lookup[s.name]?.[slot] || 0;
      return lookup[s.name]?.[slot] || 0;
    }),
    borderColor: color(s.name),
    backgroundColor: color(s.name) + '18',
    borderWidth: 2,
    pointRadius: 0,
    pointHoverRadius: 4,
    tension: 0.3,
    fill: false,
  }));

  const ctx = document.getElementById('turnsChart').getContext('2d');
  if (chartInstance) chartInstance.destroy();
  chartInstance = new Chart(ctx, {
    type: 'line',
    data: {
      labels: xKeys.map(k => isLegacy ? k.slice(5) : slotLabel(k)),
      datasets,
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: {
          position: 'top',
          labels: { usePointStyle: true, pointStyleWidth: 10, padding: 18, font: { size: 12 } }
        },
        tooltip: {
          callbacks: {
            title: items => {
              const idx = items[0]?.dataIndex;
              if (idx == null) return '';
              const slot = xKeys[idx];
              if (isLegacy) return slot;
              const [d, h] = slot.split('T');
              const hr = parseInt(h);
              const ampm = hr >= 12 ? 'pm' : 'am';
              const h12 = hr === 0 ? 12 : hr > 12 ? hr - 12 : hr;
              return `${d} ${h12}${ampm}-${h12+2 > 12 ? h12+2-12 : h12+2}${hr+2 >= 12 ? 'pm' : 'am'}`;
            },
            label: ctx => ` ${ctx.dataset.label}: ${ctx.parsed.y} turns`
          }
        }
      },
      scales: {
        x: {
          grid: { color: '#f1f5f9' },
          ticks: {
            color: '#9ca3af', font: { size: 10 }, maxRotation: 0,
            autoSkip: false,
            callback: function(val, idx) {
              const label = this.getLabelForValue(idx);
              return label || null; // only show date boundaries and noon
            }
          }
        },
        y: {
          beginAtZero: true,
          grid: { color: '#f1f5f9' },
          ticks: { color: '#9ca3af', font: { size: 11 } },
          title: { display: true, text: 'Turns', color: '#9ca3af', font: { size: 11 } }
        }
      }
    }
  });

  // Breakdown table
  const wrap = document.getElementById('breakdown-wrap');
  if (!sessions.length) {
    wrap.innerHTML = '<p class="no-data">No data. Run the extraction script to populate.</p>';
    return;
  }

  const rows = sessions.map(s => {
    const vals = xKeys.map(k => lookup[s.name]?.[k] || 0);
    const sum7   = vals.reduce((a, b) => a + b, 0);
    let todayT = 0;
    (s.data || []).forEach(d => {
      const key = d.slot || d.date;
      if (key && key.startsWith(today)) todayT += d.turns;
    });
    const activeSlots = vals.filter(v => v > 0).length;
    const peak  = Math.max(...vals);
    const cost7 = sum7 * (COST_PER_TURN[s.name] || DEFAULT_COST);
    return `
      <tr>
        <td><span class="group-dot" style="background:${color(s.name)}"></span>${s.name}</td>
        <td>${todayT}</td>
        <td>${sum7.toLocaleString()}</td>
        <td>${activeSlots}</td>
        <td>${peak}</td>
        <td>$${cost7.toFixed(2)}</td>
      </tr>`;
  }).join('');

  wrap.innerHTML = `
    <table class="breakdown-table">
      <thead>
        <tr>
          <th>Group</th>
          <th>Today</th>
          <th>7-Day Total</th>
          <th>Active Slots</th>
          <th>Peak 2h</th>
          <th>Est. 7-Day Cost</th>
        </tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>`;
}

// ‚îÄ‚îÄ Fetch & go ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function load() {
  try {
    const res = await fetch('/api/usage/turns');
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    render(data);
  } catch (err) {
    console.error('Failed to load usage data:', err);
    document.getElementById('breakdown-wrap').innerHTML =
      `<p class="no-data">Failed to load data: ${err.message}</p>`;
    document.getElementById('updated-badge').textContent = '‚ö† Error loading data';
    document.getElementById('updated-badge').className = 'updated-badge stale';
  }
}

load();
// Auto-refresh every 5 min
setInterval(load, 5 * 60 * 1000);
</script>
</body>
</html>
