<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Email Templates | Kand√© VendTech</title>
  <link href="https://cdn.jsdelivr.net/npm/[email protected]/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/[email protected]/font/bootstrap-icons.css">
  <style>
    :root {
      --primary: #2563eb;
      --primary-dark: #1d4ed8;
      --success: #16a34a;
      --warning: #f59e0b;
      --danger: #dc2626;
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-500: #6b7280;
      --gray-700: #374151;
      --gray-900: #111827;
    }
    body { background: var(--gray-50); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
    .navbar { background: white; border-bottom: 1px solid var(--gray-200); }
    .navbar-brand { font-weight: 700; color: var(--primary) !important; }
    
    .sidebar {
      position: fixed;
      top: 56px;
      left: 0;
      width: 240px;
      height: calc(100vh - 56px);
      background: white;
      border-right: 1px solid var(--gray-200);
      overflow-y: auto;
      z-index: 100;
    }
    .sidebar-section { padding: 1rem; border-bottom: 1px solid var(--gray-100); }
    .sidebar-title { font-size: 0.75rem; font-weight: 600; color: var(--gray-500); text-transform: uppercase; margin-bottom: 0.5rem; }
    .sidebar-item {
      display: block;
      padding: 0.5rem 0.75rem;
      color: var(--gray-700);
      text-decoration: none;
      border-radius: 6px;
      font-size: 0.875rem;
      cursor: pointer;
    }
    .sidebar-item:hover { background: var(--gray-100); color: var(--gray-900); }
    .sidebar-item.active { background: #dbeafe; color: var(--primary); font-weight: 500; }
    
    .main-content { margin-left: 240px; padding: 1.5rem; min-height: calc(100vh - 56px); }
    
    .template-card {
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: 12px;
      padding: 1.25rem;
      margin-bottom: 1rem;
      transition: all 0.2s;
    }
    .template-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.08); border-color: var(--primary); }
    .template-card.selected { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37,99,235,0.15); }
    
    .badge-type { font-size: 0.7rem; padding: 0.25rem 0.5rem; border-radius: 4px; font-weight: 500; }
    .badge-apartment { background: #dbeafe; color: #1e40af; }
    .badge-office { background: #fef3c7; color: #92400e; }
    .badge-healthcare { background: #dcfce7; color: #166534; }
    .badge-warehouse { background: #f3e8ff; color: #6b21a8; }
    .badge-general { background: var(--gray-100); color: var(--gray-700); }
    
    .badge-stage { font-size: 0.65rem; padding: 0.2rem 0.4rem; border-radius: 3px; }
    .badge-initial { background: #bfdbfe; color: #1e3a8a; }
    .badge-followup { background: #fed7aa; color: #9a3412; }
    .badge-post { background: #bbf7d0; color: #14532d; }
    .badge-win-back { background: #fecaca; color: #991b1b; }
    
    .response-rate { font-size: 0.75rem; color: var(--gray-500); }
    .response-rate strong { color: var(--success); }
    
    .subject-line {
      font-weight: 600;
      color: var(--gray-900);
      margin-bottom: 0.5rem;
      font-size: 1rem;
    }
    .subject-variants { font-size: 0.8rem; color: var(--gray-500); margin-bottom: 0.75rem; }
    
    .email-preview {
      background: var(--gray-50);
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      padding: 1rem;
      font-size: 0.875rem;
      line-height: 1.6;
      white-space: pre-wrap;
      max-height: 200px;
      overflow-y: auto;
    }
    .email-preview .merge-field { background: #fef3c7; padding: 0.1rem 0.3rem; border-radius: 3px; font-weight: 500; }
    
    .context-note {
      background: #eff6ff;
      border-left: 3px solid var(--primary);
      padding: 0.75rem 1rem;
      font-size: 0.8rem;
      color: var(--gray-700);
      margin-top: 0.75rem;
      border-radius: 0 6px 6px 0;
    }
    
    .btn-action {
      padding: 0.4rem 0.75rem;
      font-size: 0.8rem;
      border-radius: 6px;
    }
    
    /* Editor Modal */
    .editor-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1050;
    }
    .editor-modal.show { display: flex; }
    .editor-content {
      background: white;
      border-radius: 12px;
      width: 90%;
      max-width: 800px;
      max-height: 90vh;
      overflow-y: auto;
      padding: 1.5rem;
    }
    .editor-textarea {
      width: 100%;
      min-height: 300px;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 0.875rem;
      padding: 1rem;
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      resize: vertical;
    }
    
    /* A/B Test Tracker */
    .ab-tracker {
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: 12px;
      padding: 1.25rem;
      margin-bottom: 1rem;
    }
    .ab-version {
      display: inline-flex;
      align-items: center;
      padding: 0.5rem 1rem;
      border: 2px solid var(--gray-200);
      border-radius: 8px;
      cursor: pointer;
      margin-right: 0.5rem;
      font-size: 0.875rem;
    }
    .ab-version.selected { border-color: var(--primary); background: #eff6ff; }
    .ab-version input { margin-right: 0.5rem; }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 0.75rem;
      margin-top: 1rem;
    }
    .stat-box {
      background: var(--gray-50);
      padding: 0.75rem;
      border-radius: 8px;
      text-align: center;
    }
    .stat-value { font-size: 1.5rem; font-weight: 700; color: var(--gray-900); }
    .stat-label { font-size: 0.7rem; color: var(--gray-500); text-transform: uppercase; }
    
    /* Sequence Builder */
    .sequence-builder { background: white; border: 1px solid var(--gray-200); border-radius: 12px; padding: 1.25rem; }
    .sequence-timeline {
      display: flex;
      align-items: flex-start;
      gap: 1rem;
      overflow-x: auto;
      padding: 1rem 0;
    }
    .sequence-day {
      min-width: 200px;
      background: var(--gray-50);
      border: 2px dashed var(--gray-300);
      border-radius: 10px;
      padding: 1rem;
      text-align: center;
    }
    .sequence-day.has-template {
      border-style: solid;
      border-color: var(--primary);
      background: #eff6ff;
    }
    .sequence-day-label { font-weight: 600; color: var(--gray-700); margin-bottom: 0.5rem; }
    .sequence-template {
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: 6px;
      padding: 0.5rem;
      font-size: 0.8rem;
      margin-top: 0.5rem;
      cursor: grab;
    }
    .sequence-template:active { cursor: grabbing; }
    
    /* Toast */
    .toast-container {
      position: fixed;
      bottom: 1rem;
      right: 1rem;
      z-index: 1100;
    }
    .custom-toast {
      background: var(--gray-900);
      color: white;
      padding: 0.75rem 1.25rem;
      border-radius: 8px;
      font-size: 0.875rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      animation: slideIn 0.3s ease;
    }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    
    /* Tabs */
    .view-tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
      border-bottom: 1px solid var(--gray-200);
      padding-bottom: 0.5rem;
    }
    .view-tab {
      padding: 0.5rem 1rem;
      border: none;
      background: none;
      color: var(--gray-500);
      font-weight: 500;
      cursor: pointer;
      border-radius: 6px;
    }
    .view-tab:hover { background: var(--gray-100); color: var(--gray-700); }
    .view-tab.active { background: var(--primary); color: white; }
    
    /* Sample Data */
    .sample-data {
      background: #fefce8;
      border: 1px solid #fef08a;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
    }
    .sample-input {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      margin-bottom: 0.5rem;
    }
    .sample-input label { font-size: 0.75rem; color: var(--gray-600); min-width: 100px; }
    .sample-input input { flex: 1; padding: 0.4rem 0.75rem; border: 1px solid var(--gray-200); border-radius: 6px; font-size: 0.875rem; }
    
    @media (max-width: 768px) {
      .sidebar { display: none; }
      .main-content { margin-left: 0; padding: 1rem; }
      .stats-grid { grid-template-columns: repeat(2, 1fr); }
      .sequence-timeline { flex-direction: column; }
      .sequence-day { min-width: 100%; }
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg sticky-top">
    <div class="container-fluid">
      <a class="navbar-brand" href="/home"><i class="bi bi-lightning-charge-fill"></i> Kand√© VendTech</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto">
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown">Sales</a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="/crm">CRM</a></li>
              <li><a class="dropdown-item" href="/pipeline">Pipeline</a></li>
              <li><a class="dropdown-item" href="/route-planner">Pop-In Tracker</a></li>
              <li><a class="dropdown-item active" href="/email-templates"><i class="bi bi-envelope"></i> Email Templates</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item" href="/resources">Sales Materials</a></li>
            </ul>
          </li>
          <li class="nav-item"><a class="nav-link" href="/finance">Finances</a></li>
          <li class="nav-item"><a class="nav-link" href="/todos">To-Do</a></li>
        </ul>
        <div class="d-flex align-items-center gap-2">
          <a href="/playbook" class="btn btn-outline-primary btn-sm"><i class="bi bi-book"></i> Playbook</a>
        </div>
      </div>
    </div>
  </nav>

  <!-- Sidebar -->
  <div class="sidebar">
    <div class="sidebar-section">
      <div class="sidebar-title">Property Type</div>
      <div class="sidebar-item active" data-filter="all">All Templates</div>
      <div class="sidebar-item" data-filter="apartment">üè¢ Apartments</div>
      <div class="sidebar-item" data-filter="office">üèõÔ∏è Offices</div>
      <div class="sidebar-item" data-filter="healthcare">üè• Healthcare</div>
      <div class="sidebar-item" data-filter="warehouse">üè≠ Warehouse/Industrial</div>
    </div>
    <div class="sidebar-section">
      <div class="sidebar-title">Stage</div>
      <div class="sidebar-item" data-filter="initial">üì® Initial Outreach</div>
      <div class="sidebar-item" data-filter="followup1">üîÑ Follow-Up #1</div>
      <div class="sidebar-item" data-filter="followup2">üîÑ Follow-Up #2</div>
      <div class="sidebar-item" data-filter="post-popin">üö∂ Post Pop-In</div>
      <div class="sidebar-item" data-filter="post-gift">üéÅ Post Gift Basket</div>
      <div class="sidebar-item" data-filter="winback">‚ôªÔ∏è Re-engagement</div>
    </div>
    <div class="sidebar-section">
      <div class="sidebar-title">Purpose</div>
      <div class="sidebar-item" data-filter="intro">üëã Introduction</div>
      <div class="sidebar-item" data-filter="value">üíé Value Prop</div>
      <div class="sidebar-item" data-filter="social">üåü Social Proof</div>
      <div class="sidebar-item" data-filter="urgency">‚è∞ Urgency</div>
      <div class="sidebar-item" data-filter="meeting">üìÖ Meeting Request</div>
      <div class="sidebar-item" data-filter="competitive">‚öîÔ∏è Competitive</div>
    </div>
    <div class="sidebar-section">
      <div class="sidebar-title">Tools</div>
      <div class="sidebar-item" onclick="showView('tracker')"><i class="bi bi-bar-chart"></i> A/B Test Tracker</div>
      <div class="sidebar-item" onclick="showView('sequence')"><i class="bi bi-diagram-3"></i> Sequence Builder</div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <!-- View Tabs -->
    <div class="view-tabs">
      <button class="view-tab active" onclick="showView('templates')">üìß Templates</button>
      <button class="view-tab" onclick="showView('tracker')">üìä A/B Tracker</button>
      <button class="view-tab" onclick="showView('sequence')">üîó Sequence Builder</button>
    </div>

    <!-- Templates View -->
    <div id="templates-view">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0"><i class="bi bi-envelope-paper"></i> Cold Email Templates</h4>
        <div class="d-flex gap-2">
          <input type="search" id="template-search" class="form-control form-control-sm" placeholder="Search templates..." style="width: 200px;">
          <button class="btn btn-primary btn-sm" onclick="createCustomTemplate()"><i class="bi bi-plus"></i> Custom</button>
        </div>
      </div>

      <!-- Sample Data for Preview -->
      <div class="sample-data">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <strong style="font-size: 0.875rem;"><i class="bi bi-person-fill"></i> Sample Data (for preview)</strong>
          <button class="btn btn-sm btn-outline-secondary" onclick="randomizeSample()"><i class="bi bi-shuffle"></i> Randomize</button>
        </div>
        <div class="row">
          <div class="col-md-4">
            <div class="sample-input">
              <label>First Name:</label>
              <input type="text" id="sample-first-name" value="Sarah" onchange="updatePreviews()">
            </div>
          </div>
          <div class="col-md-4">
            <div class="sample-input">
              <label>Property Name:</label>
              <input type="text" id="sample-property" value="The Elysian" onchange="updatePreviews()">
            </div>
          </div>
          <div class="col-md-4">
            <div class="sample-input">
              <label>Company:</label>
              <input type="text" id="sample-company" value="Greystar" onchange="updatePreviews()">
            </div>
          </div>
        </div>
      </div>

      <!-- Template Grid -->
      <div id="template-list"></div>
    </div>

    <!-- A/B Tracker View -->
    <div id="tracker-view" style="display: none;">
      <h4 class="mb-3"><i class="bi bi-bar-chart"></i> A/B Test Tracker</h4>
      <p class="text-muted mb-4">Track which email versions are performing. Log sends, opens, and responses manually.</p>
      
      <div class="ab-tracker">
        <h6>Select Template to Track</h6>
        <select id="track-template" class="form-select mb-3" style="max-width: 400px;">
          <option value="">Choose a template...</option>
        </select>
        
        <div class="row mb-3">
          <div class="col-md-6">
            <label class="ab-version selected">
              <input type="radio" name="ab-version" value="A" checked> Version A (Original)
            </label>
            <label class="ab-version">
              <input type="radio" name="ab-version" value="B"> Version B (Variant)
            </label>
          </div>
        </div>
        
        <div class="stats-grid">
          <div class="stat-box">
            <div class="stat-value" id="stat-sent">0</div>
            <div class="stat-label">Sent</div>
          </div>
          <div class="stat-box">
            <div class="stat-value" id="stat-opened">0</div>
            <div class="stat-label">Opened</div>
          </div>
          <div class="stat-box">
            <div class="stat-value" id="stat-replied">0</div>
            <div class="stat-label">Replied</div>
          </div>
          <div class="stat-box">
            <div class="stat-value" id="stat-rate">0%</div>
            <div class="stat-label">Response Rate</div>
          </div>
        </div>
        
        <div class="mt-3 d-flex gap-2">
          <button class="btn btn-outline-primary btn-sm" onclick="logSend()"><i class="bi bi-send"></i> Log Send</button>
          <button class="btn btn-outline-success btn-sm" onclick="logOpen()"><i class="bi bi-envelope-open"></i> Log Open</button>
          <button class="btn btn-outline-info btn-sm" onclick="logReply()"><i class="bi bi-reply"></i> Log Reply</button>
          <button class="btn btn-outline-danger btn-sm" onclick="resetStats()"><i class="bi bi-arrow-counterclockwise"></i> Reset</button>
        </div>
      </div>
      
      <h6 class="mt-4">Send History</h6>
      <div id="send-history" class="mt-2"></div>
    </div>

    <!-- Sequence Builder View -->
    <div id="sequence-view" style="display: none;">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0"><i class="bi bi-diagram-3"></i> Sequence Builder</h4>
        <div class="d-flex gap-2">
          <button class="btn btn-outline-primary btn-sm" onclick="exportToInstantly()"><i class="bi bi-download"></i> Export for Instantly.ai</button>
          <button class="btn btn-outline-secondary btn-sm" onclick="clearSequence()"><i class="bi bi-trash"></i> Clear</button>
        </div>
      </div>
      <p class="text-muted mb-4">Drag templates into sequence slots. Standard cadence: Day 1 ‚Üí Day 4 ‚Üí Day 10 ‚Üí Day 17 ‚Üí Day 30</p>
      
      <div class="sequence-builder">
        <h6>Current Sequence</h6>
        <div class="sequence-timeline" id="sequence-timeline">
          <div class="sequence-day" data-day="1" ondrop="dropTemplate(event)" ondragover="allowDrop(event)">
            <div class="sequence-day-label">Day 1</div>
            <small class="text-muted">Initial Outreach</small>
            <div class="slot-content"></div>
          </div>
          <div class="sequence-day" data-day="4" ondrop="dropTemplate(event)" ondragover="allowDrop(event)">
            <div class="sequence-day-label">Day 4</div>
            <small class="text-muted">First Follow-up</small>
            <div class="slot-content"></div>
          </div>
          <div class="sequence-day" data-day="10" ondrop="dropTemplate(event)" ondragover="allowDrop(event)">
            <div class="sequence-day-label">Day 10</div>
            <small class="text-muted">Value Prop</small>
            <div class="slot-content"></div>
          </div>
          <div class="sequence-day" data-day="17" ondrop="dropTemplate(event)" ondragover="allowDrop(event)">
            <div class="sequence-day-label">Day 17</div>
            <small class="text-muted">Social Proof</small>
            <div class="slot-content"></div>
          </div>
          <div class="sequence-day" data-day="30" ondrop="dropTemplate(event)" ondragover="allowDrop(event)">
            <div class="sequence-day-label">Day 30</div>
            <small class="text-muted">Final Touch</small>
            <div class="slot-content"></div>
          </div>
        </div>
        
        <h6 class="mt-4">Available Templates (drag to timeline)</h6>
        <div id="draggable-templates" class="d-flex flex-wrap gap-2 mt-2"></div>
      </div>
    </div>
  </div>

  <!-- Editor Modal -->
  <div class="editor-modal" id="editor-modal">
    <div class="editor-content">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0" id="editor-title">Edit Template</h5>
        <button class="btn btn-sm btn-outline-secondary" onclick="closeEditor()"><i class="bi bi-x-lg"></i></button>
      </div>
      <div class="mb-3">
        <label class="form-label">Subject Line</label>
        <input type="text" id="editor-subject" class="form-control">
      </div>
      <div class="mb-3">
        <label class="form-label">Email Body</label>
        <textarea id="editor-body" class="editor-textarea"></textarea>
      </div>
      <div class="mb-3">
        <label class="form-label">Merge Fields: <code>{{first_name}}</code> <code>{{property_name}}</code> <code>{{company}}</code></label>
      </div>
      <div class="d-flex gap-2">
        <button class="btn btn-primary" onclick="saveTemplate()"><i class="bi bi-check"></i> Save Changes</button>
        <button class="btn btn-outline-danger" onclick="resetTemplate()"><i class="bi bi-arrow-counterclockwise"></i> Reset to Default</button>
        <button class="btn btn-outline-secondary" onclick="closeEditor()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div class="toast-container" id="toast-container"></div>

  <script src="https://cdn.jsdelivr.net/npm/[email protected]/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // ===== EMAIL TEMPLATES DATA =====
    // Based on Skool community insights: 8-10 touches, never say "vending", gift baskets, "I'm local"
    const defaultTemplates = [
      // ===== APARTMENT TEMPLATES =====
      {
        id: 'apt-zero-cost',
        name: 'Zero Cost Amenity (Apartments)',
        propertyType: 'apartment',
        stage: 'initial',
        purpose: 'intro',
        responseRate: '15-20%',
        subject: 'Quick amenity upgrade for {{property_name}} (zero cost)',
        subjectVariants: [
          'Amenity idea for {{property_name}} residents',
          '{{first_name}} ‚Äî saw {{property_name}} and had an idea',
          'Resident perk that costs you nothing'
        ],
        body: `Hi {{first_name}},

I help properties like {{property_name}} add a modern smart market amenity that residents love ‚Äî at zero cost to you.

Here's the quick version:
‚Ä¢ We handle everything (equipment, stocking, maintenance)
‚Ä¢ You get happy residents + potential revenue share
‚Ä¢ Properties typically see a $54/month rent premium for units with this amenity

I'm local to Henderson and can stop by this week if you'd like to see how it works.

Worth a quick chat?

Kurtis
Kand√© VendTech
üìû (702) 555-0123`,
        context: 'Best for initial cold outreach to apartment property managers. The "zero cost" angle removes the biggest objection upfront. Mention being local ‚Äî that\'s your #1 advantage over national operators.'
      },
      {
        id: 'apt-rev-share',
        name: 'Revenue Share Opportunity (Apartments)',
        propertyType: 'apartment',
        stage: 'initial',
        purpose: 'value',
        responseRate: '12-18%',
        subject: 'Passive income idea for {{property_name}}',
        subjectVariants: [
          '{{first_name}} ‚Äî revenue opportunity for {{property_name}}',
          'Turn your common area into a revenue stream',
          'How {{property_name}} could earn $200-400/mo extra'
        ],
        body: `Hi {{first_name}},

What if your amenity space could generate $200-400/month in revenue share ‚Äî with zero effort on your end?

We place modern smart markets in luxury properties like {{property_name}}. You provide the space and outlet. We handle everything else.

How it works:
‚Üí Zero upfront cost to you
‚Üí Revenue share starts month 6 (3-5% of sales)
‚Üí 24/7 availability for residents (no staffing needed)
‚Üí I'm local ‚Äî you can actually reach me when needed

I'd love to show you what we've done at similar properties. Free to chat this week?

Kurtis
Kand√© VendTech`,
        context: 'Use when property manager seems financially motivated. Revenue share typically starts at month 6 to let you recoup equipment costs first.'
      },
      {
        id: 'apt-followup1',
        name: 'Soft Follow-up #1 (Apartments)',
        propertyType: 'apartment',
        stage: 'followup1',
        purpose: 'intro',
        responseRate: '8-12%',
        subject: 'Re: Quick amenity upgrade for {{property_name}}',
        subjectVariants: [
          'Following up ‚Äî {{property_name}} amenity',
          '{{first_name}}, circling back',
          'Still thinking about {{property_name}}'
        ],
        body: `Hi {{first_name}},

Just following up on my note about adding a smart market amenity to {{property_name}}.

I know you're busy ‚Äî here's the 30-second version:
‚Ä¢ Zero cost to you
‚Ä¢ Residents get 24/7 snacks, drinks, essentials
‚Ä¢ You get happier residents (and optional revenue share)

I'm in the area Thursday. Happy to stop by for 5 minutes to show you how it works ‚Äî no pressure.

Either way, let me know if this is something worth exploring.

Kurtis`,
        context: 'Send 3-4 days after initial email. Keep it short and offer an easy "yes" (quick in-person visit). The Skool community says it takes 8-10 touches ‚Äî don\'t give up!'
      },
      {
        id: 'apt-followup2',
        name: 'Value-Add Follow-up #2 (Apartments)',
        propertyType: 'apartment',
        stage: 'followup2',
        purpose: 'value',
        responseRate: '10-15%',
        subject: 'Thought you might find this interesting',
        subjectVariants: [
          '{{first_name}} ‚Äî quick data point',
          'What other properties are seeing',
          'Apartment amenity trends for 2026'
        ],
        body: `Hi {{first_name}},

Quick thought I wanted to share:

A recent NAA study found that apartments with modern refreshment amenities command $54/month higher rents on average.

For a 200-unit property, that's potentially $129K/year in additional revenue ‚Äî from a single amenity upgrade.

I'd love to show you how we've helped similar Henderson properties upgrade their amenity offering at zero cost.

Worth 10 minutes this week?

Kurtis
Kand√© VendTech`,
        context: 'Send 6-10 days after first follow-up. Lead with data/value, not another ask. Social proof and stats work well on this touch.'
      },
      
      // ===== OFFICE TEMPLATES =====
      {
        id: 'office-breakroom',
        name: 'Break Room Upgrade (Offices)',
        propertyType: 'office',
        stage: 'initial',
        purpose: 'intro',
        responseRate: '12-15%',
        subject: 'Break room upgrade for {{company}} ‚Äî no cost to you',
        subjectVariants: [
          '{{first_name}} ‚Äî employee perk idea',
          'Modern refreshment option for {{company}}',
          'Quick amenity upgrade for your team'
        ],
        body: `Hi {{first_name}},

I help companies like {{company}} upgrade their break room experience ‚Äî at zero cost.

Think modern smart market: premium snacks, drinks, and essentials available 24/7. No old-school machines, no stale chips.

What makes us different:
‚Ä¢ We stock based on YOUR team's preferences
‚Ä¢ Cashless, contactless ‚Äî like grabbing from your own fridge
‚Ä¢ I'm local (Henderson) ‚Äî real person, real service
‚Ä¢ You can subsidize items for employees if you want (great perk!)

Mind if I send over some photos of what this looks like?

Kurtis
Kand√© VendTech`,
        context: 'Best for office managers at companies with 50+ employees. Emphasize the modern experience vs old vending. Many offices will subsidize ‚Äî that\'s a great angle.'
      },
      {
        id: 'office-hr',
        name: 'Employee Satisfaction (HR Contacts)',
        propertyType: 'office',
        stage: 'initial',
        purpose: 'value',
        responseRate: '10-14%',
        subject: 'Easy employee perk (zero budget needed)',
        subjectVariants: [
          '{{first_name}} ‚Äî quick win for employee satisfaction',
          'Perk that doesn\'t require budget approval',
          'What employees actually want (hint: snacks)'
        ],
        body: `Hi {{first_name}},

Looking for an easy employee satisfaction win that doesn't require budget approval?

We set up modern smart markets in offices ‚Äî premium snacks, drinks, and essentials available 24/7. Employees love it. It costs you nothing.

Even better: we can set up subsidized pricing where {{company}} covers part of each purchase. Employees feel appreciated, morale goes up, you're the hero.

Takes 5 minutes to show you how it works. Interested?

Kurtis
Kand√© VendTech
P.S. We only work with one company per building ‚Äî first come, first served.`,
        context: 'Target HR managers and office administrators. Frame it as an employee satisfaction win. The subsidy option is a strong differentiator.'
      },
      {
        id: 'office-followup1',
        name: 'Gentle Nudge (Office Follow-up)',
        propertyType: 'office',
        stage: 'followup1',
        purpose: 'meeting',
        responseRate: '8-10%',
        subject: 'Re: Break room upgrade',
        subjectVariants: [
          'Circling back ‚Äî {{company}} break room',
          '{{first_name}}, quick follow-up',
          'Still interested in showing you this'
        ],
        body: `Hi {{first_name}},

Following up on my note about upgrading {{company}}'s break room.

Quick recap: modern smart market, zero cost to you, employees love it.

I'm in the area [DAY] ‚Äî happy to stop by for 5 minutes. Easier to show than explain.

Sound good?

Kurtis`,
        context: 'Keep follow-ups short. Offer a specific day to stop by. Pop-ins are 90% of successful placements per Skool community.'
      },

      // ===== HEALTHCARE TEMPLATES =====
      {
        id: 'health-staff',
        name: 'Staff Break Room (Healthcare)',
        propertyType: 'healthcare',
        stage: 'initial',
        purpose: 'intro',
        responseRate: '10-14%',
        subject: 'Refreshment solution for {{property_name}} staff',
        subjectVariants: [
          '{{first_name}} ‚Äî staff amenity idea',
          'Keep your team fueled (no cafeteria needed)',
          '24/7 refreshments for healthcare heroes'
        ],
        body: `Hi {{first_name}},

Healthcare staff work long, unpredictable hours. The cafeteria closes. The break room is sad.

We solve that with modern smart markets ‚Äî premium snacks, drinks, and essentials available 24/7 for staff.

Why it works for healthcare:
‚Ä¢ 24/7 availability (matches your shifts)
‚Ä¢ Healthy options alongside comfort food
‚Ä¢ No staffing or maintenance on your end
‚Ä¢ Zero cost to {{property_name}}

I work with several Henderson facilities and would love to show you what we've set up.

Worth a quick call?

Kurtis
Kand√© VendTech`,
        context: 'Healthcare is great because of 24/7 operations. Focus on staff (not patient areas initially). Healthy options matter here more than other verticals.'
      },
      {
        id: 'health-waiting',
        name: 'Waiting Area Solution (Healthcare)',
        propertyType: 'healthcare',
        stage: 'initial',
        purpose: 'value',
        responseRate: '8-12%',
        subject: 'Improve patient/visitor experience at {{property_name}}',
        subjectVariants: [
          'Waiting area amenity for {{property_name}}',
          '{{first_name}} ‚Äî idea for your lobby',
          'Small upgrade, big impact on experience'
        ],
        body: `Hi {{first_name}},

Long waits are stressful. Hungry, thirsty visitors make it worse.

We help facilities like {{property_name}} add a modern refreshment option to waiting areas ‚Äî improving the experience for patients and families.

It's simple:
‚Ä¢ Sleek, modern setup (not old-school)
‚Ä¢ Healthy options + comfort items
‚Ä¢ We handle everything
‚Ä¢ Zero cost to you

I'd love to show you what we've done at similar facilities. 10 minutes?

Kurtis
Kand√© VendTech`,
        context: 'Hospital ERs and waiting areas are Tier 1 locations per Skool. Stressed, captive audience. Zero competition usually. Big opportunity.'
      },

      // ===== WAREHOUSE/INDUSTRIAL TEMPLATES =====
      {
        id: 'warehouse-ops',
        name: 'Workforce Fuel (Warehouse/Industrial)',
        propertyType: 'warehouse',
        stage: 'initial',
        purpose: 'intro',
        responseRate: '15-20%',
        subject: 'Keep your crew fueled ‚Äî {{company}}',
        subjectVariants: [
          '{{first_name}} ‚Äî break room solution for {{company}}',
          'Your team deserves better than that old machine',
          'Modern refreshments for hard-working teams'
        ],
        body: `Hi {{first_name}},

Your team works hard. They deserve better than a half-stocked, broken-down machine with stale chips.

We set up modern smart markets for facilities like {{company}} ‚Äî energy drinks, filling snacks, cold drinks, and essentials available 24/7.

What we offer:
‚Ä¢ Products workers actually want (we ask them!)
‚Ä¢ Stocked consistently (I live in Henderson)
‚Ä¢ Zero cost to you
‚Ä¢ Easy card/phone payment (no coins needed)

I work with several distribution centers in the area. Happy to stop by and show you what we're doing.

Worth a quick look?

Kurtis
Kand√© VendTech`,
        context: 'Warehouse/industrial is Tier 1. Multi-shift operations = consistent demand. Energy drinks and filling snacks do great here. Mention you\'re local ‚Äî that matters.'
      },
      {
        id: 'warehouse-hr',
        name: 'Retention Perk (Warehouse HR)',
        propertyType: 'warehouse',
        stage: 'initial',
        purpose: 'value',
        responseRate: '12-16%',
        subject: 'Easy retention win for {{company}}',
        subjectVariants: [
          '{{first_name}} ‚Äî small perk, big impact',
          'What your team actually wants',
          'Workforce amenity that costs nothing'
        ],
        body: `Hi {{first_name}},

Retention is hard. Sometimes it's the little things that matter.

We help facilities like {{company}} set up modern break room amenities ‚Äî snacks, drinks, energy drinks, essentials. Workers love it. Costs you nothing.

Pro tip: some of our clients subsidize items (pay $0.50/drink toward employee purchases). Small gesture, huge morale boost.

I'd love to show you what we've done for similar Henderson facilities.

10 minutes this week?

Kurtis
Kand√© VendTech`,
        context: 'HR angle for industrial. Frame as retention/morale play. Subsidy option works well here ‚Äî even small amounts feel appreciated.'
      },

      // ===== POST-VISIT TEMPLATES =====
      {
        id: 'post-popin',
        name: 'Post Pop-In Follow-up',
        propertyType: 'general',
        stage: 'post-popin',
        purpose: 'meeting',
        responseRate: '25-35%',
        subject: 'Great meeting you, {{first_name}}!',
        subjectVariants: [
          'Thanks for your time today',
          'Following up from our chat',
          '{{first_name}} ‚Äî next steps'
        ],
        body: `Hi {{first_name}},

Great meeting you earlier! Thanks for taking a few minutes to chat.

As promised, here's a quick recap:
‚Ä¢ We'd bring a modern smart market to {{property_name}}
‚Ä¢ Zero cost to you ‚Äî we handle everything
‚Ä¢ Revenue share available after month 6

I'll put together a simple one-pager you can share with [regional/corporate] if needed.

What's the best next step from your end?

Kurtis
Kand√© VendTech
üìû (702) 555-0123`,
        context: 'Send same day after a pop-in visit. Strike while the iron is hot! Offer to provide materials they can forward up the chain ‚Äî PMs often need approval.'
      },
      {
        id: 'post-gift',
        name: 'Post Gift Basket Follow-up',
        propertyType: 'general',
        stage: 'post-gift',
        purpose: 'meeting',
        responseRate: '30-40%',
        subject: 'Hope you enjoyed the treats!',
        subjectVariants: [
          '{{first_name}} ‚Äî hope the snacks hit the spot',
          'Following up on the goodies',
          'Did the team enjoy the treats?'
        ],
        body: `Hi {{first_name}},

Hope you (and the team!) enjoyed the snacks I dropped off.

Those are actually samples of what we'd stock in a smart market at {{property_name}} ‚Äî residents/employees can grab items like that 24/7.

Thought it'd be easier to show than tell. üòä

Any interest in chatting more about how it would work?

Kurtis
Kand√© VendTech`,
        context: 'Gift baskets are the #1 recommended pop-in strategy from Skool. Send this 1-2 days after dropping off the basket. Response rates are high because you\'ve already built rapport.'
      },

      // ===== COMPETITIVE / WIN-BACK TEMPLATES =====
      {
        id: 'competitive',
        name: 'Competitive Displacement',
        propertyType: 'general',
        stage: 'initial',
        purpose: 'competitive',
        responseRate: '18-25%',
        subject: 'Noticed your current setup at {{property_name}}',
        subjectVariants: [
          '{{first_name}} ‚Äî upgrade from your current service?',
          'Better option for {{property_name}}',
          'Happy with your current refreshment service?'
        ],
        body: `Hi {{first_name}},

I noticed {{property_name}} has an older refreshment setup. Mind if I ask ‚Äî are you happy with the service?

I hear the same things from a lot of property managers:
‚Ä¢ "They never answer the phone"
‚Ä¢ "Machine is always broken"
‚Ä¢ "Same stale products for years"

If that sounds familiar, I'd love to show you what modern service looks like. I'm local (Henderson), I actually answer my phone, and I stock based on what YOUR residents/employees want.

Worth a 5-minute conversation?

Kurtis
Kand√© VendTech`,
        context: 'Use when you know they have a competitor. National operators have terrible service ‚Äî that\'s your angle. "I\'m local and I answer my phone" is huge.'
      },
      {
        id: 'winback',
        name: 'Re-engagement (Cold Leads)',
        propertyType: 'general',
        stage: 'winback',
        purpose: 'intro',
        responseRate: '8-12%',
        subject: 'Still thinking about {{property_name}}',
        subjectVariants: [
          '{{first_name}} ‚Äî circling back after a while',
          'Things changed since we last talked?',
          'Quick check-in from Kand√© VendTech'
        ],
        body: `Hi {{first_name}},

We chatted a while back about adding a smart market to {{property_name}}. Timing wasn't right then ‚Äî totally understand.

Just wanted to check in: has anything changed? New budget cycle, new priorities, new management?

If it's still not the right time, no worries. But if you're open to revisiting, I'd love to reconnect.

Either way, I'm here when you're ready.

Kurtis
Kand√© VendTech`,
        context: 'Use for leads that went cold 60-90+ days ago. No pressure approach. Sometimes timing just wasn\'t right before. 8-10 touches to close, remember!'
      },

      // ===== URGENCY / SCARCITY TEMPLATES =====
      {
        id: 'urgency',
        name: 'Scarcity / Urgency Close',
        propertyType: 'general',
        stage: 'followup2',
        purpose: 'urgency',
        responseRate: '10-15%',
        subject: 'Quick heads up ‚Äî {{property_name}}',
        subjectVariants: [
          '{{first_name}} ‚Äî one spot left in your area',
          'Before I reach out to other properties...',
          'Last call for {{property_name}}'
        ],
        body: `Hi {{first_name}},

Quick heads up: we only work with one property per immediate area to ensure top service, and we're almost at capacity in Henderson.

Before I reach out to other properties near {{property_name}}, wanted to give you first shot.

If the timing isn't right, totally understand ‚Äî just didn't want you to miss the window.

Let me know either way?

Kurtis
Kand√© VendTech`,
        context: 'Use sparingly and only if true. Scarcity works but don\'t abuse it. Best after 2-3 touches when they\'ve been warm but not committed.'
      },
      {
        id: 'social-proof',
        name: 'Social Proof / Reference Offer',
        propertyType: 'general',
        stage: 'followup2',
        purpose: 'social',
        responseRate: '12-18%',
        subject: 'What other Henderson properties are saying',
        subjectVariants: [
          '{{first_name}} ‚Äî hear it from them, not me',
          'Why [Similar Property] chose us',
          'Quick success story from your area'
        ],
        body: `Hi {{first_name}},

I know it's easy to tune out vendor emails. So instead of me telling you how great we are, let me offer this:

I'm happy to connect you with [2-3 property managers] in Henderson who work with us. They can tell you honestly what the experience has been like.

No sales pitch ‚Äî just a real conversation with real people.

Interested?

Kurtis
Kand√© VendTech`,
        context: 'Use after building up a few placements. References from peers are incredibly powerful. This works especially well for property managers who need to justify decisions.'
      },

      // ===== MEETING REQUEST =====
      {
        id: 'meeting-direct',
        name: 'Direct Meeting Request',
        propertyType: 'general',
        stage: 'followup1',
        purpose: 'meeting',
        responseRate: '10-14%',
        subject: '15 minutes this week?',
        subjectVariants: [
          '{{first_name}} ‚Äî quick coffee?',
          'Can I buy you a coffee?',
          '15 min call ‚Äî {{property_name}} amenity'
        ],
        body: `Hi {{first_name}},

I've sent a couple notes about adding a smart market to {{property_name}}. Don't want to keep clogging your inbox.

Here's a direct ask: can we do 15 minutes this week? In person or phone ‚Äî whatever's easier.

I'll show you exactly what we do, answer any questions, and if it's not a fit, I'll leave you alone. Fair?

Kurtis
Kand√© VendTech
üìû (702) 555-0123`,
        context: 'Use after 2-3 emails with no response. Direct ask with a clear time commitment. Offering to stop if not a fit reduces perceived risk.'
      }
    ];

    // ===== STATE =====
    let templates = [];
    let currentFilter = 'all';
    let editingTemplate = null;
    let abStats = {};
    let sequence = {};
    let sendHistory = [];

    // ===== INIT =====
    function init() {
      // Load custom templates from localStorage
      const saved = localStorage.getItem('vendtech_email_templates');
      if (saved) {
        const customTemplates = JSON.parse(saved);
        templates = defaultTemplates.map(t => {
          const custom = customTemplates.find(c => c.id === t.id);
          return custom ? { ...t, ...custom, isCustomized: true } : t;
        });
        // Add any fully custom templates
        const customOnly = customTemplates.filter(c => !defaultTemplates.find(d => d.id === c.id));
        templates = [...templates, ...customOnly];
      } else {
        templates = [...defaultTemplates];
      }

      // Load A/B stats
      const savedStats = localStorage.getItem('vendtech_ab_stats');
      if (savedStats) abStats = JSON.parse(savedStats);

      // Load sequence
      const savedSequence = localStorage.getItem('vendtech_email_sequence');
      if (savedSequence) sequence = JSON.parse(savedSequence);

      // Load send history
      const savedHistory = localStorage.getItem('vendtech_send_history');
      if (savedHistory) sendHistory = JSON.parse(savedHistory);

      renderTemplates();
      setupSidebar();
      populateTrackerDropdown();
      populateDraggableTemplates();
      loadSequenceFromStorage();
      renderSendHistory();
    }

    // ===== RENDER TEMPLATES =====
    function renderTemplates() {
      const container = document.getElementById('template-list');
      const search = document.getElementById('template-search').value.toLowerCase();
      
      let filtered = templates;
      
      // Apply filter
      if (currentFilter !== 'all') {
        filtered = filtered.filter(t => 
          t.propertyType === currentFilter ||
          t.stage === currentFilter ||
          t.purpose === currentFilter
        );
      }
      
      // Apply search
      if (search) {
        filtered = filtered.filter(t =>
          t.name.toLowerCase().includes(search) ||
          t.subject.toLowerCase().includes(search) ||
          t.body.toLowerCase().includes(search)
        );
      }

      container.innerHTML = filtered.map(t => renderTemplateCard(t)).join('');
    }

    function renderTemplateCard(template) {
      const sample = getSampleData();
      const previewBody = fillMergeFields(template.body, sample).substring(0, 300) + '...';
      const previewSubject = fillMergeFields(template.subject, sample);
      
      const typeBadge = {
        apartment: 'badge-apartment',
        office: 'badge-office',
        healthcare: 'badge-healthcare',
        warehouse: 'badge-warehouse',
        general: 'badge-general'
      }[template.propertyType] || 'badge-general';

      const stageBadge = {
        initial: 'badge-initial',
        followup1: 'badge-followup',
        followup2: 'badge-followup',
        'post-popin': 'badge-post',
        'post-gift': 'badge-post',
        winback: 'badge-win-back'
      }[template.stage] || 'badge-initial';

      const typeLabel = {
        apartment: 'üè¢ Apartment',
        office: 'üèõÔ∏è Office',
        healthcare: 'üè• Healthcare',
        warehouse: 'üè≠ Warehouse',
        general: 'üìß General'
      }[template.propertyType] || 'General';

      const stageLabel = {
        initial: 'Initial',
        followup1: 'Follow-up #1',
        followup2: 'Follow-up #2',
        'post-popin': 'Post Pop-In',
        'post-gift': 'Post Gift',
        winback: 'Re-engage'
      }[template.stage] || template.stage;

      return `
        <div class="template-card" data-id="${template.id}">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <div>
              <span class="badge badge-type ${typeBadge}">${typeLabel}</span>
              <span class="badge badge-type ${stageBadge} ms-1">${stageLabel}</span>
              ${template.isCustomized ? '<span class="badge bg-warning text-dark ms-1">Customized</span>' : ''}
            </div>
            <div class="response-rate">
              Expected: <strong>${template.responseRate}</strong> response
            </div>
          </div>
          
          <div class="subject-line">${previewSubject}</div>
          <div class="subject-variants">
            <i class="bi bi-shuffle"></i> Variants: ${template.subjectVariants.slice(0, 2).map(v => `"${fillMergeFields(v, sample)}"`).join(', ')}
          </div>
          
          <div class="email-preview">${highlightMergeFields(previewBody)}</div>
          
          <div class="context-note">
            <i class="bi bi-lightbulb"></i> <strong>When to use:</strong> ${template.context}
          </div>
          
          <div class="d-flex gap-2 mt-3">
            <button class="btn btn-primary btn-action" onclick="copyTemplate('${template.id}')">
              <i class="bi bi-clipboard"></i> Copy
            </button>
            <button class="btn btn-outline-primary btn-action" onclick="openInGmail('${template.id}')">
              <i class="bi bi-envelope"></i> Gmail
            </button>
            <button class="btn btn-outline-secondary btn-action" onclick="editTemplate('${template.id}')">
              <i class="bi bi-pencil"></i> Edit
            </button>
            <button class="btn btn-outline-secondary btn-action" onclick="showVariants('${template.id}')">
              <i class="bi bi-list"></i> All Subjects
            </button>
          </div>
        </div>
      `;
    }

    function getSampleData() {
      return {
        first_name: document.getElementById('sample-first-name')?.value || 'Sarah',
        property_name: document.getElementById('sample-property')?.value || 'The Elysian',
        company: document.getElementById('sample-company')?.value || 'Greystar'
      };
    }

    function fillMergeFields(text, data) {
      return text
        .replace(/\{\{first_name\}\}/g, data.first_name)
        .replace(/\{\{property_name\}\}/g, data.property_name)
        .replace(/\{\{company\}\}/g, data.company);
    }

    function highlightMergeFields(text) {
      return text
        .replace(/\{\{(\w+)\}\}/g, '<span class="merge-field">{{$1}}</span>');
    }

    function updatePreviews() {
      renderTemplates();
    }

    function randomizeSample() {
      const firstNames = ['Sarah', 'Mike', 'Jennifer', 'David', 'Lisa', 'Chris', 'Amanda', 'Robert'];
      const properties = ['The Elysian', 'Parkview Tower', 'Sunset Gardens', 'Metro Lofts', 'Highland Place', 'Vista Ridge'];
      const companies = ['Greystar', 'Lincoln Property', 'AvalonBay', 'Equity Residential', 'Camden'];
      
      document.getElementById('sample-first-name').value = firstNames[Math.floor(Math.random() * firstNames.length)];
      document.getElementById('sample-property').value = properties[Math.floor(Math.random() * properties.length)];
      document.getElementById('sample-company').value = companies[Math.floor(Math.random() * companies.length)];
      updatePreviews();
    }

    // ===== SIDEBAR =====
    function setupSidebar() {
      document.querySelectorAll('.sidebar-item[data-filter]').forEach(item => {
        item.addEventListener('click', () => {
          document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active'));
          item.classList.add('active');
          currentFilter = item.dataset.filter;
          renderTemplates();
        });
      });

      document.getElementById('template-search').addEventListener('input', renderTemplates);
    }

    // ===== TEMPLATE ACTIONS =====
    function copyTemplate(id) {
      const template = templates.find(t => t.id === id);
      const sample = getSampleData();
      const text = `Subject: ${fillMergeFields(template.subject, sample)}\n\n${fillMergeFields(template.body, sample)}`;
      
      navigator.clipboard.writeText(text).then(() => {
        showToast('‚úì Copied to clipboard!');
      });
    }

    function openInGmail(id) {
      const template = templates.find(t => t.id === id);
      const sample = getSampleData();
      const subject = encodeURIComponent(fillMergeFields(template.subject, sample));
      const body = encodeURIComponent(fillMergeFields(template.body, sample));
      
      window.open(`https://mail.google.com/mail/?view=cm&fs=1&su=${subject}&body=${body}`, '_blank');
    }

    function showVariants(id) {
      const template = templates.find(t => t.id === id);
      const sample = getSampleData();
      const variants = [template.subject, ...template.subjectVariants]
        .map(v => fillMergeFields(v, sample))
        .map((v, i) => `${i + 1}. ${v}`)
        .join('\n');
      
      alert(`Subject Line Variants:\n\n${variants}`);
    }

    function editTemplate(id) {
      editingTemplate = templates.find(t => t.id === id);
      document.getElementById('editor-title').textContent = `Edit: ${editingTemplate.name}`;
      document.getElementById('editor-subject').value = editingTemplate.subject;
      document.getElementById('editor-body').value = editingTemplate.body;
      document.getElementById('editor-modal').classList.add('show');
    }

    function closeEditor() {
      document.getElementById('editor-modal').classList.remove('show');
      editingTemplate = null;
    }

    function saveTemplate() {
      if (!editingTemplate) return;
      
      editingTemplate.subject = document.getElementById('editor-subject').value;
      editingTemplate.body = document.getElementById('editor-body').value;
      editingTemplate.isCustomized = true;
      
      // Save to localStorage
      const toSave = templates.map(t => ({
        id: t.id,
        subject: t.subject,
        body: t.body,
        isCustomized: t.isCustomized
      }));
      localStorage.setItem('vendtech_email_templates', JSON.stringify(toSave));
      
      closeEditor();
      renderTemplates();
      showToast('‚úì Template saved!');
    }

    function resetTemplate() {
      if (!editingTemplate) return;
      
      const original = defaultTemplates.find(t => t.id === editingTemplate.id);
      if (original) {
        editingTemplate.subject = original.subject;
        editingTemplate.body = original.body;
        editingTemplate.isCustomized = false;
        
        document.getElementById('editor-subject').value = original.subject;
        document.getElementById('editor-body').value = original.body;
        
        // Update localStorage
        const toSave = templates.map(t => ({
          id: t.id,
          subject: t.subject,
          body: t.body,
          isCustomized: t.isCustomized
        }));
        localStorage.setItem('vendtech_email_templates', JSON.stringify(toSave));
        
        renderTemplates();
        showToast('‚úì Reset to default!');
      }
    }

    function createCustomTemplate() {
      const newTemplate = {
        id: 'custom-' + Date.now(),
        name: 'Custom Template',
        propertyType: 'general',
        stage: 'initial',
        purpose: 'intro',
        responseRate: 'TBD',
        subject: 'Your subject line here',
        subjectVariants: ['Variant 1', 'Variant 2'],
        body: `Hi {{first_name}},

Your email body here.

{{property_name}} and {{company}} are available merge fields.

Best,
Kurtis`,
        context: 'Describe when to use this template.',
        isCustomized: true
      };
      
      templates.push(newTemplate);
      
      // Save to localStorage
      const toSave = templates.map(t => ({
        id: t.id,
        subject: t.subject,
        body: t.body,
        isCustomized: t.isCustomized,
        name: t.name,
        propertyType: t.propertyType,
        stage: t.stage,
        purpose: t.purpose,
        responseRate: t.responseRate,
        subjectVariants: t.subjectVariants,
        context: t.context
      }));
      localStorage.setItem('vendtech_email_templates', JSON.stringify(toSave));
      
      editTemplate(newTemplate.id);
    }

    // ===== VIEW SWITCHING =====
    function showView(view) {
      document.querySelectorAll('.view-tab').forEach(t => t.classList.remove('active'));
      document.querySelector(`.view-tab[onclick="showView('${view}')"]`).classList.add('active');
      
      document.getElementById('templates-view').style.display = view === 'templates' ? 'block' : 'none';
      document.getElementById('tracker-view').style.display = view === 'tracker' ? 'block' : 'none';
      document.getElementById('sequence-view').style.display = view === 'sequence' ? 'block' : 'none';
    }

    // ===== A/B TRACKER =====
    function populateTrackerDropdown() {
      const select = document.getElementById('track-template');
      select.innerHTML = '<option value="">Choose a template...</option>' +
        templates.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
      
      select.addEventListener('change', updateTrackerStats);
      
      // Version selection
      document.querySelectorAll('.ab-version').forEach(v => {
        v.addEventListener('click', function() {
          document.querySelectorAll('.ab-version').forEach(x => x.classList.remove('selected'));
          this.classList.add('selected');
          this.querySelector('input').checked = true;
          updateTrackerStats();
        });
      });
    }

    function getTrackerKey() {
      const templateId = document.getElementById('track-template').value;
      const version = document.querySelector('.ab-version.selected input').value;
      return templateId ? `${templateId}_${version}` : null;
    }

    function updateTrackerStats() {
      const key = getTrackerKey();
      const stats = key && abStats[key] ? abStats[key] : { sent: 0, opened: 0, replied: 0 };
      
      document.getElementById('stat-sent').textContent = stats.sent;
      document.getElementById('stat-opened').textContent = stats.opened;
      document.getElementById('stat-replied').textContent = stats.replied;
      document.getElementById('stat-rate').textContent = stats.sent > 0 
        ? Math.round((stats.replied / stats.sent) * 100) + '%'
        : '0%';
    }

    function logSend() {
      const key = getTrackerKey();
      if (!key) return showToast('Select a template first');
      
      if (!abStats[key]) abStats[key] = { sent: 0, opened: 0, replied: 0 };
      abStats[key].sent++;
      
      sendHistory.unshift({
        templateId: document.getElementById('track-template').value,
        version: document.querySelector('.ab-version.selected input').value,
        action: 'sent',
        timestamp: new Date().toISOString()
      });
      
      saveTrackerData();
      updateTrackerStats();
      renderSendHistory();
      showToast('‚úì Send logged');
    }

    function logOpen() {
      const key = getTrackerKey();
      if (!key) return showToast('Select a template first');
      
      if (!abStats[key]) abStats[key] = { sent: 0, opened: 0, replied: 0 };
      abStats[key].opened++;
      
      sendHistory.unshift({
        templateId: document.getElementById('track-template').value,
        version: document.querySelector('.ab-version.selected input').value,
        action: 'opened',
        timestamp: new Date().toISOString()
      });
      
      saveTrackerData();
      updateTrackerStats();
      renderSendHistory();
      showToast('‚úì Open logged');
    }

    function logReply() {
      const key = getTrackerKey();
      if (!key) return showToast('Select a template first');
      
      if (!abStats[key]) abStats[key] = { sent: 0, opened: 0, replied: 0 };
      abStats[key].replied++;
      
      sendHistory.unshift({
        templateId: document.getElementById('track-template').value,
        version: document.querySelector('.ab-version.selected input').value,
        action: 'replied',
        timestamp: new Date().toISOString()
      });
      
      saveTrackerData();
      updateTrackerStats();
      renderSendHistory();
      showToast('‚úì Reply logged!');
    }

    function resetStats() {
      const key = getTrackerKey();
      if (!key) return;
      
      delete abStats[key];
      saveTrackerData();
      updateTrackerStats();
      showToast('Stats reset');
    }

    function saveTrackerData() {
      localStorage.setItem('vendtech_ab_stats', JSON.stringify(abStats));
      localStorage.setItem('vendtech_send_history', JSON.stringify(sendHistory.slice(0, 100)));
    }

    function renderSendHistory() {
      const container = document.getElementById('send-history');
      const recent = sendHistory.slice(0, 10);
      
      if (recent.length === 0) {
        container.innerHTML = '<p class="text-muted">No sends logged yet.</p>';
        return;
      }
      
      container.innerHTML = `
        <table class="table table-sm">
          <thead><tr><th>Template</th><th>Version</th><th>Action</th><th>Time</th></tr></thead>
          <tbody>
            ${recent.map(h => {
              const template = templates.find(t => t.id === h.templateId);
              const actionIcon = { sent: 'üì§', opened: 'üì¨', replied: '‚úÖ' }[h.action];
              return `<tr>
                <td>${template?.name || h.templateId}</td>
                <td>${h.version}</td>
                <td>${actionIcon} ${h.action}</td>
                <td>${new Date(h.timestamp).toLocaleString()}</td>
              </tr>`;
            }).join('')}
          </tbody>
        </table>
      `;
    }

    // ===== SEQUENCE BUILDER =====
    function populateDraggableTemplates() {
      const container = document.getElementById('draggable-templates');
      container.innerHTML = templates.map(t => `
        <div class="sequence-template" draggable="true" ondragstart="dragTemplate(event)" data-id="${t.id}">
          ${t.name}
        </div>
      `).join('');
    }

    function dragTemplate(e) {
      e.dataTransfer.setData('text/plain', e.target.dataset.id);
    }

    function allowDrop(e) {
      e.preventDefault();
    }

    function dropTemplate(e) {
      e.preventDefault();
      const templateId = e.dataTransfer.getData('text/plain');
      const day = e.currentTarget.dataset.day;
      
      sequence[day] = templateId;
      localStorage.setItem('vendtech_email_sequence', JSON.stringify(sequence));
      
      updateSequenceUI();
    }

    function updateSequenceUI() {
      document.querySelectorAll('.sequence-day').forEach(dayEl => {
        const day = dayEl.dataset.day;
        const slotContent = dayEl.querySelector('.slot-content');
        
        if (sequence[day]) {
          const template = templates.find(t => t.id === sequence[day]);
          dayEl.classList.add('has-template');
          slotContent.innerHTML = `
            <div class="sequence-template">
              ${template?.name || sequence[day]}
              <button class="btn btn-sm btn-link text-danger p-0 ms-2" onclick="removeFromSequence('${day}')">√ó</button>
            </div>
          `;
        } else {
          dayEl.classList.remove('has-template');
          slotContent.innerHTML = '<small class="text-muted">Drop template here</small>';
        }
      });
    }

    function removeFromSequence(day) {
      delete sequence[day];
      localStorage.setItem('vendtech_email_sequence', JSON.stringify(sequence));
      updateSequenceUI();
    }

    function loadSequenceFromStorage() {
      updateSequenceUI();
    }

    function clearSequence() {
      sequence = {};
      localStorage.setItem('vendtech_email_sequence', JSON.stringify(sequence));
      updateSequenceUI();
      showToast('Sequence cleared');
    }

    function exportToInstantly() {
      const days = Object.keys(sequence).sort((a, b) => parseInt(a) - parseInt(b));
      
      if (days.length === 0) {
        showToast('Add templates to sequence first');
        return;
      }
      
      const sample = getSampleData();
      const instantly = days.map((day, index) => {
        const template = templates.find(t => t.id === sequence[day]);
        return {
          step: index + 1,
          wait_days: parseInt(day) - (index > 0 ? parseInt(days[index - 1]) : 0),
          subject: template ? fillMergeFields(template.subject, sample) : '',
          body: template ? fillMergeFields(template.body, sample) : ''
        };
      });
      
      const csv = 'Step,Wait Days,Subject,Body\n' + 
        instantly.map(s => `${s.step},${s.wait_days},"${s.subject.replace(/"/g, '""')}","${s.body.replace(/"/g, '""').replace(/\n/g, '\\n')}"`).join('\n');
      
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'email-sequence-instantly.csv';
      a.click();
      
      showToast('‚úì Exported for Instantly.ai');
    }

    // ===== TOAST =====
    function showToast(message) {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = 'custom-toast';
      toast.innerHTML = message;
      container.appendChild(toast);
      
      setTimeout(() => toast.remove(), 3000);
    }

    // Initialize
    init();
  </script>
</body>
</html>
