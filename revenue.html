<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-vend-32.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-vend.png">
  <title>Revenue Tracking ‚Äî Kande VendTech</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg: #f8fafc; --card: #ffffff; --border: #e2e8f0; --text: #0f172a;
      --muted: #64748b; --accent: #3b82f6; --accent-light: #eff6ff;
      --green: #22c55e; --green-light: #f0fdf4;
      --amber: #f59e0b; --amber-light: #fffbeb;
      --red: #ef4444; --red-light: #fef2f2;
      --purple: #8b5cf6; --purple-light: #f5f3ff;
      --teal: #14b8a6; --teal-light: #f0fdfa;
      --radius: 12px;
    }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }
    .app { max-width: 1400px; margin: 0 auto; padding: 24px 28px 60px; }

    /* Header */
    .page-header { margin-bottom: 28px; }
    .page-header h1 { font-size: 1.6rem; font-weight: 700; display: flex; align-items: center; gap: 10px; }
    .page-header p { color: var(--muted); font-size: 0.9rem; margin-top: 4px; }

    /* Tabs */
    .tabs { display: flex; gap: 4px; margin-bottom: 24px; border-bottom: 2px solid var(--border); flex-wrap: wrap; }
    .tab { padding: 12px 20px; cursor: pointer; font-weight: 600; color: var(--muted); border-bottom: 2px solid transparent; margin-bottom: -2px; transition: all 0.2s; background: none; border-top: none; border-left: none; border-right: none; font-size: 0.88rem; }
    .tab:hover { color: var(--accent); }
    .tab.active { color: var(--accent); border-bottom-color: var(--accent); }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* Stats Grid */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin-bottom: 28px; }
    .stat-card { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; transition: box-shadow 0.2s; }
    .stat-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.06); }
    .stat-card .stat-icon { font-size: 1.3rem; margin-bottom: 8px; }
    .stat-card .stat-label { font-size: 0.72rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; }
    .stat-card .stat-value { font-size: 1.6rem; font-weight: 800; margin-top: 4px; }
    .stat-card .stat-sub { font-size: 0.75rem; color: var(--muted); margin-top: 4px; }
    .stat-card.green .stat-value { color: var(--green); }
    .stat-card.amber .stat-value { color: var(--amber); }
    .stat-card.red .stat-value { color: var(--red); }
    .stat-card.purple .stat-value { color: var(--purple); }
    .stat-card.teal .stat-value { color: var(--teal); }

    /* Cards */
    .card { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 22px 24px; margin-bottom: 20px; }
    .card-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; flex-wrap: wrap; gap: 12px; }
    .card-title { font-size: 1rem; font-weight: 700; display: flex; align-items: center; gap: 8px; }
    .card-actions { display: flex; gap: 8px; flex-wrap: wrap; }

    /* Grid layouts */
    .grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
    .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }

    /* Buttons */
    .btn { padding: 8px 16px; border: none; border-radius: 8px; cursor: pointer; font-size: 0.85rem; font-weight: 600; transition: all 0.2s; display: inline-flex; align-items: center; gap: 6px; }
    .btn-primary { background: var(--accent); color: #fff; }
    .btn-primary:hover { background: #2563eb; }
    .btn-secondary { background: var(--card); color: var(--text); border: 1px solid var(--border); }
    .btn-secondary:hover { background: var(--bg); }
    .btn-success { background: var(--green); color: #fff; }
    .btn-sm { padding: 6px 12px; font-size: 0.8rem; }

    /* Tables */
    .table-container { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; }
    th { background: #f8fafc; padding: 12px 14px; text-align: left; font-size: 0.75rem; text-transform: uppercase; color: var(--muted); font-weight: 600; border-bottom: 1px solid var(--border); white-space: nowrap; cursor: pointer; }
    th:hover { background: #f1f5f9; }
    th.sorted-asc::after { content: ' ‚Üë'; }
    th.sorted-desc::after { content: ' ‚Üì'; }
    td { padding: 12px 14px; border-bottom: 1px solid var(--border); font-size: 0.88rem; }
    tr:last-child td { border-bottom: none; }
    tr:hover td { background: #fafbfc; }
    tr.clickable { cursor: pointer; }
    tr.clickable:hover td { background: var(--accent-light); }
    .text-right { text-align: right; }
    .text-center { text-align: center; }

    /* Badges */
    .badge { padding: 4px 10px; border-radius: 12px; font-size: 0.72rem; font-weight: 600; display: inline-block; }
    .badge-green { background: var(--green-light); color: var(--green); }
    .badge-amber { background: var(--amber-light); color: var(--amber); }
    .badge-red { background: var(--red-light); color: var(--red); }
    .badge-purple { background: var(--purple-light); color: var(--purple); }
    .badge-teal { background: var(--teal-light); color: var(--teal); }

    /* Charts */
    .chart-container { position: relative; height: 300px; }
    .chart-container.small { height: 220px; }

    /* Projection cards */
    .projection-card { background: linear-gradient(135deg, var(--accent-light) 0%, #fff 100%); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; text-align: center; }
    .projection-card .machines { font-size: 2rem; font-weight: 800; color: var(--accent); }
    .projection-card .label { font-size: 0.78rem; color: var(--muted); font-weight: 600; text-transform: uppercase; margin-top: 4px; }
    .projection-card .revenue { font-size: 1.4rem; font-weight: 700; color: var(--green); margin-top: 12px; }
    .projection-card .profit { font-size: 0.9rem; color: var(--muted); margin-top: 4px; }

    /* Commission table special styles */
    .commission-row.overdue { background: var(--red-light); }
    .commission-row.pending { background: var(--amber-light); }

    /* Empty state */
    .empty-state { text-align: center; padding: 48px 20px; color: var(--muted); }
    .empty-state .icon { font-size: 3rem; margin-bottom: 12px; }
    .empty-state p { font-size: 0.9rem; }

    /* Progress bar */
    .progress-bar { height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden; }
    .progress-fill { height: 100%; border-radius: 4px; transition: width 0.3s; }
    .progress-fill.green { background: var(--green); }
    .progress-fill.amber { background: var(--amber); }
    .progress-fill.red { background: var(--red); }

    /* Performance indicators */
    .perf-indicator { display: flex; align-items: center; gap: 8px; }
    .perf-dot { width: 10px; height: 10px; border-radius: 50%; }
    .perf-dot.excellent { background: var(--green); }
    .perf-dot.good { background: var(--teal); }
    .perf-dot.average { background: var(--amber); }
    .perf-dot.poor { background: var(--red); }

    /* Modal */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
    .modal-overlay.open { display: flex; }
    .modal { background: var(--card); border-radius: 16px; padding: 24px; max-width: 700px; width: 95%; max-height: 90vh; overflow-y: auto; }
    .modal h2 { font-size: 1.2rem; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
    .modal-close { position: absolute; top: 16px; right: 16px; background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--muted); }

    /* Responsive */
    @media (max-width: 900px) {
      .grid-2, .grid-3 { grid-template-columns: 1fr; }
      .stats-grid { grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 600px) {
      .app { padding: 16px; }
      .stats-grid { grid-template-columns: 1fr; }
      .tabs { gap: 0; }
      .tab { padding: 10px 14px; font-size: 0.82rem; }
    }
  </style>
</head>
<body>
<script src="/nav.js"></script>

<div class="app">
  <div class="page-header">
    <h1>üí∞ Revenue Tracking</h1>
    <p>Track revenue, commissions, and profitability across all machines</p>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab active" data-tab="overview">üìä Overview</button>
    <button class="tab" data-tab="machines">üè≠ By Machine</button>
    <button class="tab" data-tab="commissions">üí∏ Commissions</button>
    <button class="tab" data-tab="profitability">üìà Profitability</button>
    <button class="tab" data-tab="trends">üìâ Trends</button>
    <button class="tab" data-tab="projections">üîÆ Projections</button>
  </div>

  <!-- OVERVIEW TAB -->
  <div id="tab-overview" class="tab-content active">
    <!-- Revenue Overview Cards -->
    <div class="stats-grid">
      <div class="stat-card green">
        <div class="stat-icon">üìÖ</div>
        <div class="stat-label">This Month</div>
        <div class="stat-value" id="revenue-month">$0</div>
        <div class="stat-sub" id="revenue-month-change">‚Äî</div>
      </div>
      <div class="stat-card teal">
        <div class="stat-icon">üìÜ</div>
        <div class="stat-label">This Quarter</div>
        <div class="stat-value" id="revenue-quarter">$0</div>
        <div class="stat-sub" id="revenue-quarter-trans">0 transactions</div>
      </div>
      <div class="stat-card purple">
        <div class="stat-icon">üóìÔ∏è</div>
        <div class="stat-label">Year to Date</div>
        <div class="stat-value" id="revenue-ytd">$0</div>
        <div class="stat-sub" id="revenue-ytd-trans">0 transactions</div>
      </div>
      <div class="stat-card amber">
        <div class="stat-icon">üí∏</div>
        <div class="stat-label">Commissions Paid</div>
        <div class="stat-value" id="commissions-paid">$0</div>
        <div class="stat-sub" id="commissions-pending">$0 pending</div>
      </div>
      <div class="stat-card green">
        <div class="stat-icon">üìä</div>
        <div class="stat-label">Gross Profit</div>
        <div class="stat-value" id="gross-profit">$0</div>
        <div class="stat-sub" id="gross-margin">0% margin</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">üíµ</div>
        <div class="stat-label">Net Profit</div>
        <div class="stat-value" id="net-profit">$0</div>
        <div class="stat-sub" id="net-margin">After COGS, commissions, expenses</div>
      </div>
      <div class="stat-card teal">
        <div class="stat-icon">üè≠</div>
        <div class="stat-label">Revenue/Machine</div>
        <div class="stat-value" id="revenue-per-machine">$0</div>
        <div class="stat-sub" id="machines-deployed">0 machines deployed</div>
      </div>
      <div class="stat-card purple">
        <div class="stat-icon">üßæ</div>
        <div class="stat-label">Avg Transaction</div>
        <div class="stat-value" id="avg-transaction">$0</div>
        <div class="stat-sub" id="total-transactions">0 total transactions</div>
      </div>
    </div>

    <!-- Quick Summary Charts -->
    <div class="grid-2">
      <div class="card">
        <div class="card-header">
          <span class="card-title">üìä Monthly Revenue Trend</span>
        </div>
        <div class="chart-container">
          <canvas id="overview-revenue-chart"></canvas>
        </div>
      </div>
      <div class="card">
        <div class="card-header">
          <span class="card-title">ü•ß Revenue Breakdown</span>
        </div>
        <div class="chart-container">
          <canvas id="overview-breakdown-chart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- BY MACHINE TAB -->
  <div id="tab-machines" class="tab-content">
    <div class="card">
      <div class="card-header">
        <span class="card-title">üè≠ Revenue by Machine</span>
        <div class="card-actions">
          <select id="machine-period" class="btn btn-secondary btn-sm" onchange="loadMachineRevenue()">
            <option value="month">This Month</option>
            <option value="quarter">This Quarter</option>
            <option value="year">This Year</option>
            <option value="all">All Time</option>
          </select>
        </div>
      </div>
      <div class="table-container">
        <table id="machine-table">
          <thead>
            <tr>
              <th data-sort="name">Machine</th>
              <th data-sort="location">Location</th>
              <th data-sort="property">Property</th>
              <th data-sort="revenue" class="text-right">Revenue</th>
              <th data-sort="transactions" class="text-right">Transactions</th>
              <th data-sort="commission" class="text-right">Commission Owed</th>
              <th data-sort="performance" class="text-center">Performance</th>
            </tr>
          </thead>
          <tbody id="machine-tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- COMMISSIONS TAB -->
  <div id="tab-commissions" class="tab-content">
    <!-- Commission Summary -->
    <div class="stats-grid" style="grid-template-columns: repeat(4, 1fr);">
      <div class="stat-card green">
        <div class="stat-icon">‚úÖ</div>
        <div class="stat-label">Total Paid</div>
        <div class="stat-value" id="comm-total-paid">$0</div>
      </div>
      <div class="stat-card amber">
        <div class="stat-icon">‚è≥</div>
        <div class="stat-label">Pending</div>
        <div class="stat-value" id="comm-pending">$0</div>
      </div>
      <div class="stat-card red">
        <div class="stat-icon">‚ö†Ô∏è</div>
        <div class="stat-label">Overdue</div>
        <div class="stat-value" id="comm-overdue">$0</div>
      </div>
      <div class="stat-card purple">
        <div class="stat-icon">üìä</div>
        <div class="stat-label">Avg Commission %</div>
        <div class="stat-value" id="comm-avg-rate">0%</div>
      </div>
    </div>

    <div class="card">
      <div class="card-header">
        <span class="card-title">üí∏ Commission Calculator</span>
        <div class="card-actions">
          <button class="btn btn-primary btn-sm" onclick="generateCommissionReport()">üìÑ Generate Report</button>
        </div>
      </div>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Property</th>
              <th>Location</th>
              <th class="text-right">Monthly Revenue</th>
              <th class="text-center">Commission %</th>
              <th class="text-right">Amount Owed</th>
              <th class="text-center">Status</th>
              <th class="text-center">Actions</th>
            </tr>
          </thead>
          <tbody id="commission-tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- PROFITABILITY TAB -->
  <div id="tab-profitability" class="tab-content">
    <div class="grid-2">
      <!-- Revenue vs COGS -->
      <div class="card">
        <div class="card-header">
          <span class="card-title">üìä Revenue vs COGS</span>
        </div>
        <div class="chart-container">
          <canvas id="cogs-chart"></canvas>
        </div>
      </div>

      <!-- Margin by Category -->
      <div class="card">
        <div class="card-header">
          <span class="card-title">üì¶ Margin by Product Category</span>
        </div>
        <div class="chart-container">
          <canvas id="category-margin-chart"></canvas>
        </div>
      </div>
    </div>

    <div class="grid-2">
      <!-- Best Performing Products -->
      <div class="card">
        <div class="card-header">
          <span class="card-title">üèÜ Best Performing Products</span>
        </div>
        <div class="table-container">
          <table>
            <thead>
              <tr><th>Product</th><th>Category</th><th class="text-right">Revenue</th><th class="text-right">Margin</th></tr>
            </thead>
            <tbody id="best-products-tbody"></tbody>
          </table>
        </div>
      </div>

      <!-- Worst Performing Products -->
      <div class="card">
        <div class="card-header">
          <span class="card-title">‚ö†Ô∏è Underperforming Products</span>
        </div>
        <div class="table-container">
          <table>
            <thead>
              <tr><th>Product</th><th>Category</th><th class="text-right">Revenue</th><th class="text-right">Margin</th></tr>
            </thead>
            <tbody id="worst-products-tbody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="grid-2">
      <!-- Best Machines -->
      <div class="card">
        <div class="card-header">
          <span class="card-title">ü•á Top Performing Machines</span>
        </div>
        <div class="table-container">
          <table>
            <thead>
              <tr><th>Machine</th><th>Location</th><th class="text-right">Revenue</th><th class="text-right">Profit</th></tr>
            </thead>
            <tbody id="best-machines-tbody"></tbody>
          </table>
        </div>
      </div>

      <!-- Worst Machines -->
      <div class="card">
        <div class="card-header">
          <span class="card-title">üìâ Underperforming Machines</span>
        </div>
        <div class="table-container">
          <table>
            <thead>
              <tr><th>Machine</th><th>Location</th><th class="text-right">Revenue</th><th class="text-right">Status</th></tr>
            </thead>
            <tbody id="worst-machines-tbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- TRENDS TAB -->
  <div id="tab-trends" class="tab-content">
    <div class="card">
      <div class="card-header">
        <span class="card-title">üìà Monthly Revenue Trend</span>
        <div class="card-actions">
          <select id="trend-period" class="btn btn-secondary btn-sm" onchange="loadTrends()">
            <option value="6">Last 6 Months</option>
            <option value="12" selected>Last 12 Months</option>
            <option value="24">Last 24 Months</option>
          </select>
        </div>
      </div>
      <div class="chart-container" style="height: 350px;">
        <canvas id="revenue-trend-chart"></canvas>
      </div>
    </div>

    <div class="grid-2">
      <div class="card">
        <div class="card-header">
          <span class="card-title">üè¢ Revenue by Property Type</span>
        </div>
        <div class="chart-container">
          <canvas id="property-type-chart"></canvas>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <span class="card-title">üå°Ô∏è Seasonality Patterns</span>
        </div>
        <div class="chart-container">
          <canvas id="seasonality-chart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- PROJECTIONS TAB -->
  <div id="tab-projections" class="tab-content">
    <div class="card" style="margin-bottom: 24px;">
      <div class="card-header">
        <span class="card-title">üîÆ Financial Projections</span>
      </div>
      <p style="color: var(--muted); font-size: 0.88rem; margin-bottom: 20px;">
        Based on current performance metrics: <strong id="proj-avg-revenue">$0</strong> avg revenue/machine, 
        <strong id="proj-avg-margin">0%</strong> profit margin, 
        <strong id="proj-monthly-expenses">$0</strong> fixed monthly expenses.
      </p>

      <div class="grid-3" style="grid-template-columns: repeat(4, 1fr);">
        <div class="projection-card">
          <div class="machines">5</div>
          <div class="label">Machines</div>
          <div class="revenue" id="proj-5-revenue">$0/mo</div>
          <div class="profit" id="proj-5-profit">$0 profit</div>
        </div>
        <div class="projection-card">
          <div class="machines">10</div>
          <div class="label">Machines</div>
          <div class="revenue" id="proj-10-revenue">$0/mo</div>
          <div class="profit" id="proj-10-profit">$0 profit</div>
        </div>
        <div class="projection-card">
          <div class="machines">20</div>
          <div class="label">Machines</div>
          <div class="revenue" id="proj-20-revenue">$0/mo</div>
          <div class="profit" id="proj-20-profit">$0 profit</div>
        </div>
        <div class="projection-card">
          <div class="machines">30</div>
          <div class="label">Machines</div>
          <div class="revenue" id="proj-30-revenue">$0/mo</div>
          <div class="profit" id="proj-30-profit">$0 profit</div>
        </div>
      </div>
    </div>

    <div class="grid-2">
      <div class="card">
        <div class="card-header">
          <span class="card-title">üìä Projected Revenue Growth</span>
        </div>
        <div class="chart-container">
          <canvas id="projection-chart"></canvas>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <span class="card-title">‚öñÔ∏è Break-Even Analysis</span>
        </div>
        <div style="padding: 20px;">
          <div style="margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
              <span style="font-weight: 600;">Break-Even Point</span>
              <span id="breakeven-machines" style="font-weight: 700; color: var(--accent);">0 machines</span>
            </div>
            <div class="progress-bar" style="height: 12px;">
              <div class="progress-fill green" id="breakeven-progress" style="width: 0%;"></div>
            </div>
            <div style="display: flex; justify-content: space-between; margin-top: 4px; font-size: 0.75rem; color: var(--muted);">
              <span>Current: <span id="current-machines">0</span></span>
              <span>Target: <span id="target-machines">0</span></span>
            </div>
          </div>

          <div style="background: var(--bg); border-radius: 8px; padding: 16px;">
            <h4 style="font-size: 0.9rem; margin-bottom: 12px;">Key Assumptions</h4>
            <div style="display: grid; gap: 8px; font-size: 0.85rem;">
              <div style="display: flex; justify-content: space-between;">
                <span style="color: var(--muted);">Avg Revenue/Machine:</span>
                <span id="assumption-revenue">$2,000</span>
              </div>
              <div style="display: flex; justify-content: space-between;">
                <span style="color: var(--muted);">COGS (33%):</span>
                <span id="assumption-cogs">$660</span>
              </div>
              <div style="display: flex; justify-content: space-between;">
                <span style="color: var(--muted);">Avg Commission (4%):</span>
                <span id="assumption-commission">$80</span>
              </div>
              <div style="display: flex; justify-content: space-between;">
                <span style="color: var(--muted);">Monthly Fixed Costs:</span>
                <span id="assumption-fixed">$500</span>
              </div>
              <div style="display: flex; justify-content: space-between; padding-top: 8px; border-top: 1px solid var(--border);">
                <span style="font-weight: 600;">Net Profit/Machine:</span>
                <span style="font-weight: 700; color: var(--green);" id="assumption-net">$1,260</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Pipeline Impact -->
    <div class="card">
      <div class="card-header">
        <span class="card-title">üéØ Pipeline Revenue Impact</span>
      </div>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>Pipeline Stage</th>
              <th class="text-center">Count</th>
              <th class="text-right">Potential Revenue</th>
              <th class="text-center">Probability</th>
              <th class="text-right">Weighted Value</th>
            </tr>
          </thead>
          <tbody id="pipeline-impact-tbody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Machine Detail Modal -->
<div class="modal-overlay" id="machine-modal">
  <div class="modal">
    <h2 id="modal-machine-title">üè≠ Machine Details</h2>
    <div id="modal-machine-content"></div>
    <div style="margin-top: 20px; text-align: right;">
      <button class="btn btn-secondary" onclick="closeMachineModal()">Close</button>
    </div>
  </div>
</div>

<script>
// ===== DEMO DATA =====
// Realistic sample data until real machines are deployed
const DEMO_DATA = {
  machines: [
    { id: 1, name: 'Machine #001', location: 'The Elysian Apartments', property: 'Elysian Property Management', property_type: 'apartments', status: 'deployed', commission_rate: 0.04 },
    { id: 2, name: 'Machine #002', location: 'Henderson Rec Center', property: 'City of Henderson', property_type: 'recreation', status: 'deployed', commission_rate: 0.03 },
    { id: 3, name: 'Machine #003', location: 'Desert Springs Medical', property: 'Desert Springs Healthcare', property_type: 'healthcare', status: 'deployed', commission_rate: 0.05 },
    { id: 4, name: 'Machine #004', location: 'Prime Manufacturing', property: 'Prime Industries LLC', property_type: 'industrial', status: 'deployed', commission_rate: 0 },
    { id: 5, name: 'Machine #005', location: 'Sunset Tower Apartments', property: 'Greystar Properties', property_type: 'apartments', status: 'deployed', commission_rate: 0.04 }
  ],
  // Monthly revenue data (last 12 months)
  monthlyRevenue: [
    { month: '2025-03', machine_id: 1, revenue: 2450, transactions: 892, cogs: 808.50 },
    { month: '2025-03', machine_id: 2, revenue: 3200, transactions: 1180, cogs: 1056 },
    { month: '2025-03', machine_id: 3, revenue: 1890, transactions: 685, cogs: 623.70 },
    { month: '2025-03', machine_id: 4, revenue: 4100, transactions: 1520, cogs: 1353 },
    { month: '2025-03', machine_id: 5, revenue: 2780, transactions: 1020, cogs: 917.40 },
    { month: '2025-02', machine_id: 1, revenue: 2280, transactions: 830, cogs: 752.40 },
    { month: '2025-02', machine_id: 2, revenue: 2950, transactions: 1090, cogs: 973.50 },
    { month: '2025-02', machine_id: 3, revenue: 1750, transactions: 635, cogs: 577.50 },
    { month: '2025-02', machine_id: 4, revenue: 3850, transactions: 1425, cogs: 1270.50 },
    { month: '2025-02', machine_id: 5, revenue: 2550, transactions: 940, cogs: 841.50 },
    { month: '2025-01', machine_id: 1, revenue: 2100, transactions: 765, cogs: 693 },
    { month: '2025-01', machine_id: 2, revenue: 2680, transactions: 990, cogs: 884.40 },
    { month: '2025-01', machine_id: 3, revenue: 1620, transactions: 590, cogs: 534.60 },
    { month: '2025-01', machine_id: 4, revenue: 3500, transactions: 1295, cogs: 1155 },
    { month: '2025-01', machine_id: 5, revenue: 2350, transactions: 865, cogs: 775.50 },
    { month: '2024-12', machine_id: 1, revenue: 2650, transactions: 965, cogs: 874.50 },
    { month: '2024-12', machine_id: 2, revenue: 3450, transactions: 1275, cogs: 1138.50 },
    { month: '2024-12', machine_id: 3, revenue: 2050, transactions: 745, cogs: 676.50 },
    { month: '2024-12', machine_id: 4, revenue: 4350, transactions: 1610, cogs: 1435.50 },
    { month: '2024-12', machine_id: 5, revenue: 2920, transactions: 1075, cogs: 963.60 },
    { month: '2024-11', machine_id: 1, revenue: 2200, transactions: 800, cogs: 726 },
    { month: '2024-11', machine_id: 2, revenue: 2800, transactions: 1035, cogs: 924 },
    { month: '2024-11', machine_id: 3, revenue: 1680, transactions: 610, cogs: 554.40 },
    { month: '2024-11', machine_id: 4, revenue: 3650, transactions: 1350, cogs: 1204.50 },
    { month: '2024-11', machine_id: 5, revenue: 2480, transactions: 915, cogs: 818.40 },
    { month: '2024-10', machine_id: 1, revenue: 2050, transactions: 745, cogs: 676.50 },
    { month: '2024-10', machine_id: 2, revenue: 2550, transactions: 940, cogs: 841.50 },
    { month: '2024-10', machine_id: 3, revenue: 1550, transactions: 565, cogs: 511.50 },
    { month: '2024-10', machine_id: 4, revenue: 3400, transactions: 1260, cogs: 1122 },
    { month: '2024-10', machine_id: 5, revenue: 2300, transactions: 850, cogs: 759 }
  ],
  commissions: [
    { property: 'Elysian Property Management', location: 'The Elysian Apartments', rate: 0.04, monthlyRevenue: 2450, status: 'pending' },
    { property: 'City of Henderson', location: 'Henderson Rec Center', rate: 0.03, monthlyRevenue: 3200, status: 'paid' },
    { property: 'Desert Springs Healthcare', location: 'Desert Springs Medical', rate: 0.05, monthlyRevenue: 1890, status: 'overdue' },
    { property: 'Greystar Properties', location: 'Sunset Tower Apartments', rate: 0.04, monthlyRevenue: 2780, status: 'pending' }
  ],
  products: [
    { name: 'Celsius Energy', category: 'Energy', revenue: 4250, margin: 42 },
    { name: 'Smartwater 20oz', category: 'Drinks', revenue: 3180, margin: 48 },
    { name: 'Coke 20oz', category: 'Drinks', revenue: 2950, margin: 45 },
    { name: 'Joy Burst', category: 'Energy', revenue: 2720, margin: 40 },
    { name: 'Gatorade Cool Blue', category: 'Drinks', revenue: 2480, margin: 38 },
    { name: 'Snickers King Size', category: 'Candy', revenue: 1850, margin: 52 },
    { name: 'Doritos 1.75oz', category: 'Snacks', revenue: 1620, margin: 55 },
    { name: 'Tide Pods 3ct', category: 'Incidentals', revenue: 980, margin: 62 },
    { name: 'Phone Charger', category: 'Incidentals', revenue: 750, margin: 58 },
    { name: 'Diet Coke 20oz', category: 'Drinks', revenue: 680, margin: 45 }
  ],
  expenses: {
    monthly_fixed: 500,  // Software, insurance, misc
    cogs_rate: 0.33,
    avg_commission_rate: 0.04
  },
  pipeline: [
    { stage: 'Interested', count: 8, probability: 0.3 },
    { stage: 'Site Survey', count: 5, probability: 0.5 },
    { stage: 'Proposal Sent', count: 3, probability: 0.7 },
    { stage: 'Negotiating', count: 2, probability: 0.85 },
    { stage: 'Contract Sent', count: 1, probability: 0.95 }
  ]
};

// ===== HELPER FUNCTIONS =====
function formatCurrency(amount) {
  return '$' + (amount || 0).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
}

function formatPercent(value) {
  return (value * 100).toFixed(1) + '%';
}

function getCurrentMonth() {
  const now = new Date();
  return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
}

function getQuarterMonths() {
  const now = new Date();
  const quarter = Math.floor(now.getMonth() / 3);
  const months = [];
  for (let i = 0; i < 3; i++) {
    const m = quarter * 3 + i + 1;
    months.push(`${now.getFullYear()}-${String(m).padStart(2, '0')}`);
  }
  return months;
}

function getYTDMonths() {
  const now = new Date();
  const months = [];
  for (let i = 1; i <= now.getMonth() + 1; i++) {
    months.push(`${now.getFullYear()}-${String(i).padStart(2, '0')}`);
  }
  return months;
}

// ===== TAB SWITCHING =====
document.querySelectorAll('.tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
    
    // Load tab-specific data
    if (tab.dataset.tab === 'machines') loadMachineRevenue();
    if (tab.dataset.tab === 'commissions') loadCommissions();
    if (tab.dataset.tab === 'profitability') loadProfitability();
    if (tab.dataset.tab === 'trends') loadTrends();
    if (tab.dataset.tab === 'projections') loadProjections();
  });
});

// ===== LOAD OVERVIEW =====
function loadOverview() {
  const currentMonth = getCurrentMonth();
  const quarterMonths = getQuarterMonths();
  const ytdMonths = getYTDMonths();
  
  // Calculate metrics from demo data
  const monthData = DEMO_DATA.monthlyRevenue.filter(r => r.month === currentMonth);
  const quarterData = DEMO_DATA.monthlyRevenue.filter(r => quarterMonths.includes(r.month));
  const ytdData = DEMO_DATA.monthlyRevenue.filter(r => ytdMonths.includes(r.month));
  const lastMonthData = DEMO_DATA.monthlyRevenue.filter(r => r.month === '2025-02');
  
  const monthRevenue = monthData.reduce((s, r) => s + r.revenue, 0);
  const lastMonthRevenue = lastMonthData.reduce((s, r) => s + r.revenue, 0);
  const quarterRevenue = quarterData.reduce((s, r) => s + r.revenue, 0);
  const ytdRevenue = ytdData.reduce((s, r) => s + r.revenue, 0);
  
  const monthTrans = monthData.reduce((s, r) => s + r.transactions, 0);
  const quarterTrans = quarterData.reduce((s, r) => s + r.transactions, 0);
  const ytdTrans = ytdData.reduce((s, r) => s + r.transactions, 0);
  
  const monthCogs = monthData.reduce((s, r) => s + r.cogs, 0);
  const grossProfit = monthRevenue - monthCogs;
  const grossMargin = monthRevenue > 0 ? (grossProfit / monthRevenue) : 0;
  
  // Calculate commissions
  const commissionsPaid = DEMO_DATA.commissions.filter(c => c.status === 'paid')
    .reduce((s, c) => s + (c.monthlyRevenue * c.rate), 0);
  const commissionsPending = DEMO_DATA.commissions.filter(c => c.status !== 'paid')
    .reduce((s, c) => s + (c.monthlyRevenue * c.rate), 0);
  
  const netProfit = grossProfit - commissionsPending - DEMO_DATA.expenses.monthly_fixed;
  
  const deployedMachines = DEMO_DATA.machines.filter(m => m.status === 'deployed').length;
  const revenuePerMachine = deployedMachines > 0 ? monthRevenue / deployedMachines : 0;
  const avgTransaction = monthTrans > 0 ? monthRevenue / monthTrans : 0;
  
  // Month-over-month change
  const monthChange = lastMonthRevenue > 0 ? ((monthRevenue - lastMonthRevenue) / lastMonthRevenue) * 100 : 0;
  
  // Update UI
  document.getElementById('revenue-month').textContent = formatCurrency(monthRevenue);
  document.getElementById('revenue-month-change').textContent = monthChange >= 0 
    ? `‚Üë ${monthChange.toFixed(1)}% vs last month`
    : `‚Üì ${Math.abs(monthChange).toFixed(1)}% vs last month`;
  document.getElementById('revenue-month-change').style.color = monthChange >= 0 ? 'var(--green)' : 'var(--red)';
  
  document.getElementById('revenue-quarter').textContent = formatCurrency(quarterRevenue);
  document.getElementById('revenue-quarter-trans').textContent = `${quarterTrans.toLocaleString()} transactions`;
  
  document.getElementById('revenue-ytd').textContent = formatCurrency(ytdRevenue);
  document.getElementById('revenue-ytd-trans').textContent = `${ytdTrans.toLocaleString()} transactions`;
  
  document.getElementById('commissions-paid').textContent = formatCurrency(commissionsPaid);
  document.getElementById('commissions-pending').textContent = formatCurrency(commissionsPending) + ' pending';
  
  document.getElementById('gross-profit').textContent = formatCurrency(grossProfit);
  document.getElementById('gross-margin').textContent = formatPercent(grossMargin) + ' margin';
  
  document.getElementById('net-profit').textContent = formatCurrency(netProfit);
  document.getElementById('net-profit').parentElement.classList.toggle('green', netProfit > 0);
  document.getElementById('net-profit').parentElement.classList.toggle('red', netProfit < 0);
  
  document.getElementById('revenue-per-machine').textContent = formatCurrency(revenuePerMachine);
  document.getElementById('machines-deployed').textContent = `${deployedMachines} machines deployed`;
  
  document.getElementById('avg-transaction').textContent = '$' + avgTransaction.toFixed(2);
  document.getElementById('total-transactions').textContent = `${monthTrans.toLocaleString()} this month`;
  
  // Render charts
  renderOverviewCharts();
}

function renderOverviewCharts() {
  // Monthly Revenue Trend
  const months = [...new Set(DEMO_DATA.monthlyRevenue.map(r => r.month))].sort().slice(-6);
  const monthlyTotals = months.map(m => 
    DEMO_DATA.monthlyRevenue.filter(r => r.month === m).reduce((s, r) => s + r.revenue, 0)
  );
  
  const ctx1 = document.getElementById('overview-revenue-chart').getContext('2d');
  new Chart(ctx1, {
    type: 'line',
    data: {
      labels: months.map(m => {
        const [y, mo] = m.split('-');
        return new Date(y, mo - 1).toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
      }),
      datasets: [{
        label: 'Revenue',
        data: monthlyTotals,
        borderColor: '#22c55e',
        backgroundColor: 'rgba(34, 197, 94, 0.1)',
        fill: true,
        tension: 0.3
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        y: { 
          beginAtZero: true,
          ticks: { callback: v => '$' + (v/1000) + 'k' }
        }
      }
    }
  });
  
  // Revenue Breakdown by Property Type
  const byType = {};
  DEMO_DATA.machines.forEach(m => {
    const machineRevenue = DEMO_DATA.monthlyRevenue
      .filter(r => r.machine_id === m.id && r.month === getCurrentMonth())
      .reduce((s, r) => s + r.revenue, 0);
    byType[m.property_type] = (byType[m.property_type] || 0) + machineRevenue;
  });
  
  const ctx2 = document.getElementById('overview-breakdown-chart').getContext('2d');
  new Chart(ctx2, {
    type: 'doughnut',
    data: {
      labels: Object.keys(byType).map(t => t.charAt(0).toUpperCase() + t.slice(1)),
      datasets: [{
        data: Object.values(byType),
        backgroundColor: ['#3b82f6', '#22c55e', '#f59e0b', '#8b5cf6', '#14b8a6']
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: 'bottom' }
      }
    }
  });
}

// ===== MACHINE REVENUE =====
let machineSort = { col: 'revenue', dir: 'desc' };

function loadMachineRevenue() {
  const period = document.getElementById('machine-period').value;
  const currentMonth = getCurrentMonth();
  
  let filterMonths;
  if (period === 'month') filterMonths = [currentMonth];
  else if (period === 'quarter') filterMonths = getQuarterMonths();
  else if (period === 'year') filterMonths = getYTDMonths();
  else filterMonths = null; // all
  
  const machineData = DEMO_DATA.machines.map(m => {
    const revenueData = DEMO_DATA.monthlyRevenue.filter(r => 
      r.machine_id === m.id && (!filterMonths || filterMonths.includes(r.month))
    );
    const revenue = revenueData.reduce((s, r) => s + r.revenue, 0);
    const transactions = revenueData.reduce((s, r) => s + r.transactions, 0);
    const commission = revenue * m.commission_rate;
    
    // Performance rating based on VENDTECH-RULES.md thresholds
    let performance;
    const monthlyAvg = filterMonths ? revenue / filterMonths.length : revenue / 6;
    if (monthlyAvg >= 3000) performance = 'excellent';
    else if (monthlyAvg >= 2000) performance = 'good';
    else if (monthlyAvg >= 800) performance = 'average';
    else performance = 'poor';
    
    return { ...m, revenue, transactions, commission, performance, monthlyAvg };
  });
  
  // Sort
  machineData.sort((a, b) => {
    const dir = machineSort.dir === 'asc' ? 1 : -1;
    if (machineSort.col === 'revenue') return (a.revenue - b.revenue) * dir;
    if (machineSort.col === 'transactions') return (a.transactions - b.transactions) * dir;
    if (machineSort.col === 'commission') return (a.commission - b.commission) * dir;
    if (machineSort.col === 'name') return a.name.localeCompare(b.name) * dir;
    if (machineSort.col === 'location') return a.location.localeCompare(b.location) * dir;
    return 0;
  });
  
  const tbody = document.getElementById('machine-tbody');
  tbody.innerHTML = machineData.map(m => `
    <tr class="clickable" onclick="showMachineDetail(${m.id})">
      <td><strong>${m.name}</strong></td>
      <td>${m.location}</td>
      <td>${m.property}</td>
      <td class="text-right"><strong>${formatCurrency(m.revenue)}</strong></td>
      <td class="text-right">${m.transactions.toLocaleString()}</td>
      <td class="text-right">${m.commission_rate > 0 ? formatCurrency(m.commission) : '‚Äî'}</td>
      <td class="text-center">
        <div class="perf-indicator">
          <span class="perf-dot ${m.performance}"></span>
          <span>${m.performance.charAt(0).toUpperCase() + m.performance.slice(1)}</span>
        </div>
      </td>
    </tr>
  `).join('');
  
  // Add sort handlers
  document.querySelectorAll('#machine-table th[data-sort]').forEach(th => {
    th.onclick = () => {
      const col = th.dataset.sort;
      if (machineSort.col === col) machineSort.dir = machineSort.dir === 'asc' ? 'desc' : 'asc';
      else { machineSort.col = col; machineSort.dir = 'desc'; }
      document.querySelectorAll('#machine-table th').forEach(t => t.classList.remove('sorted-asc', 'sorted-desc'));
      th.classList.add(machineSort.dir === 'asc' ? 'sorted-asc' : 'sorted-desc');
      loadMachineRevenue();
    };
  });
}

function showMachineDetail(machineId) {
  const machine = DEMO_DATA.machines.find(m => m.id === machineId);
  if (!machine) return;
  
  const revenueHistory = DEMO_DATA.monthlyRevenue
    .filter(r => r.machine_id === machineId)
    .sort((a, b) => b.month.localeCompare(a.month))
    .slice(0, 6);
  
  const totalRevenue = revenueHistory.reduce((s, r) => s + r.revenue, 0);
  const avgMonthly = totalRevenue / revenueHistory.length;
  
  document.getElementById('modal-machine-title').textContent = `üè≠ ${machine.name}`;
  document.getElementById('modal-machine-content').innerHTML = `
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px;">
      <div>
        <p style="color: var(--muted); font-size: 0.8rem;">Location</p>
        <p style="font-weight: 600;">${machine.location}</p>
      </div>
      <div>
        <p style="color: var(--muted); font-size: 0.8rem;">Property</p>
        <p style="font-weight: 600;">${machine.property}</p>
      </div>
      <div>
        <p style="color: var(--muted); font-size: 0.8rem;">Avg Monthly Revenue</p>
        <p style="font-weight: 700; color: var(--green); font-size: 1.2rem;">${formatCurrency(avgMonthly)}</p>
      </div>
      <div>
        <p style="color: var(--muted); font-size: 0.8rem;">Commission Rate</p>
        <p style="font-weight: 600;">${machine.commission_rate > 0 ? formatPercent(machine.commission_rate) : 'None'}</p>
      </div>
    </div>
    <h4 style="margin-bottom: 12px;">Recent Revenue History</h4>
    <table style="width: 100%;">
      <thead>
        <tr><th>Month</th><th class="text-right">Revenue</th><th class="text-right">Transactions</th><th class="text-right">COGS</th></tr>
      </thead>
      <tbody>
        ${revenueHistory.map(r => `
          <tr>
            <td>${new Date(r.month + '-01').toLocaleDateString('en-US', { month: 'short', year: 'numeric' })}</td>
            <td class="text-right">${formatCurrency(r.revenue)}</td>
            <td class="text-right">${r.transactions}</td>
            <td class="text-right">${formatCurrency(r.cogs)}</td>
          </tr>
        `).join('')}
      </tbody>
    </table>
  `;
  document.getElementById('machine-modal').classList.add('open');
}

function closeMachineModal() {
  document.getElementById('machine-modal').classList.remove('open');
}

// ===== COMMISSIONS =====
function loadCommissions() {
  const commissions = DEMO_DATA.commissions;
  
  const totalPaid = commissions.filter(c => c.status === 'paid').reduce((s, c) => s + (c.monthlyRevenue * c.rate), 0);
  const pending = commissions.filter(c => c.status === 'pending').reduce((s, c) => s + (c.monthlyRevenue * c.rate), 0);
  const overdue = commissions.filter(c => c.status === 'overdue').reduce((s, c) => s + (c.monthlyRevenue * c.rate), 0);
  const avgRate = commissions.length > 0 ? commissions.reduce((s, c) => s + c.rate, 0) / commissions.length : 0;
  
  document.getElementById('comm-total-paid').textContent = formatCurrency(totalPaid);
  document.getElementById('comm-pending').textContent = formatCurrency(pending);
  document.getElementById('comm-overdue').textContent = formatCurrency(overdue);
  document.getElementById('comm-avg-rate').textContent = formatPercent(avgRate);
  
  const tbody = document.getElementById('commission-tbody');
  tbody.innerHTML = commissions.map(c => {
    const owed = c.monthlyRevenue * c.rate;
    return `
      <tr class="commission-row ${c.status}">
        <td><strong>${c.property}</strong></td>
        <td>${c.location}</td>
        <td class="text-right">${formatCurrency(c.monthlyRevenue)}</td>
        <td class="text-center">${formatPercent(c.rate)}</td>
        <td class="text-right"><strong>${formatCurrency(owed)}</strong></td>
        <td class="text-center">
          <span class="badge badge-${c.status === 'paid' ? 'green' : c.status === 'pending' ? 'amber' : 'red'}">
            ${c.status.charAt(0).toUpperCase() + c.status.slice(1)}
          </span>
        </td>
        <td class="text-center">
          ${c.status !== 'paid' ? `<button class="btn btn-success btn-sm" onclick="markCommissionPaid('${c.property}')">Mark Paid</button>` : '‚Äî'}
        </td>
      </tr>
    `;
  }).join('');
}

function markCommissionPaid(property) {
  const comm = DEMO_DATA.commissions.find(c => c.property === property);
  if (comm) {
    comm.status = 'paid';
    loadCommissions();
  }
}

function generateCommissionReport() {
  const commissions = DEMO_DATA.commissions;
  const report = commissions.map(c => ({
    Property: c.property,
    Location: c.location,
    'Monthly Revenue': formatCurrency(c.monthlyRevenue),
    'Commission Rate': formatPercent(c.rate),
    'Amount Owed': formatCurrency(c.monthlyRevenue * c.rate),
    Status: c.status
  }));
  
  // Create CSV
  const headers = Object.keys(report[0]);
  const csv = [
    headers.join(','),
    ...report.map(r => headers.map(h => `"${r[h]}"`).join(','))
  ].join('\n');
  
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `commission-report-${new Date().toISOString().split('T')[0]}.csv`;
  a.click();
}

// ===== PROFITABILITY =====
function loadProfitability() {
  // Revenue vs COGS Chart
  const months = [...new Set(DEMO_DATA.monthlyRevenue.map(r => r.month))].sort().slice(-6);
  const revenueByMonth = months.map(m => DEMO_DATA.monthlyRevenue.filter(r => r.month === m).reduce((s, r) => s + r.revenue, 0));
  const cogsByMonth = months.map(m => DEMO_DATA.monthlyRevenue.filter(r => r.month === m).reduce((s, r) => s + r.cogs, 0));
  
  const ctx1 = document.getElementById('cogs-chart').getContext('2d');
  new Chart(ctx1, {
    type: 'bar',
    data: {
      labels: months.map(m => {
        const [y, mo] = m.split('-');
        return new Date(y, mo - 1).toLocaleDateString('en-US', { month: 'short' });
      }),
      datasets: [
        { label: 'Revenue', data: revenueByMonth, backgroundColor: '#22c55e' },
        { label: 'COGS', data: cogsByMonth, backgroundColor: '#ef4444' }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: { y: { beginAtZero: true, ticks: { callback: v => '$' + (v/1000) + 'k' } } }
    }
  });
  
  // Category Margin Chart
  const categories = [...new Set(DEMO_DATA.products.map(p => p.category))];
  const categoryData = categories.map(cat => {
    const prods = DEMO_DATA.products.filter(p => p.category === cat);
    return prods.reduce((s, p) => s + p.margin, 0) / prods.length;
  });
  
  const ctx2 = document.getElementById('category-margin-chart').getContext('2d');
  new Chart(ctx2, {
    type: 'bar',
    data: {
      labels: categories,
      datasets: [{
        label: 'Avg Margin %',
        data: categoryData,
        backgroundColor: ['#3b82f6', '#22c55e', '#f59e0b', '#8b5cf6', '#14b8a6']
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      indexAxis: 'y',
      scales: { x: { beginAtZero: true, max: 100, ticks: { callback: v => v + '%' } } },
      plugins: { legend: { display: false } }
    }
  });
  
  // Best/Worst Products
  const sortedProducts = [...DEMO_DATA.products].sort((a, b) => b.revenue - a.revenue);
  
  document.getElementById('best-products-tbody').innerHTML = sortedProducts.slice(0, 5).map(p => `
    <tr>
      <td>${p.name}</td>
      <td><span class="badge badge-teal">${p.category}</span></td>
      <td class="text-right">${formatCurrency(p.revenue)}</td>
      <td class="text-right"><span style="color: var(--green);">${p.margin}%</span></td>
    </tr>
  `).join('');
  
  document.getElementById('worst-products-tbody').innerHTML = sortedProducts.slice(-5).reverse().map(p => `
    <tr>
      <td>${p.name}</td>
      <td><span class="badge badge-amber">${p.category}</span></td>
      <td class="text-right">${formatCurrency(p.revenue)}</td>
      <td class="text-right"><span style="color: ${p.margin < 40 ? 'var(--red)' : 'var(--amber)'};">${p.margin}%</span></td>
    </tr>
  `).join('');
  
  // Best/Worst Machines
  const currentMonth = getCurrentMonth();
  const machinePerf = DEMO_DATA.machines.map(m => {
    const data = DEMO_DATA.monthlyRevenue.filter(r => r.machine_id === m.id && r.month === currentMonth);
    const revenue = data.reduce((s, r) => s + r.revenue, 0);
    const cogs = data.reduce((s, r) => s + r.cogs, 0);
    const profit = revenue - cogs - (revenue * m.commission_rate);
    return { ...m, revenue, profit };
  }).sort((a, b) => b.revenue - a.revenue);
  
  document.getElementById('best-machines-tbody').innerHTML = machinePerf.slice(0, 3).map(m => `
    <tr>
      <td>${m.name}</td>
      <td>${m.location}</td>
      <td class="text-right">${formatCurrency(m.revenue)}</td>
      <td class="text-right"><span style="color: var(--green);">${formatCurrency(m.profit)}</span></td>
    </tr>
  `).join('');
  
  document.getElementById('worst-machines-tbody').innerHTML = machinePerf.slice(-2).reverse().map(m => `
    <tr>
      <td>${m.name}</td>
      <td>${m.location}</td>
      <td class="text-right">${formatCurrency(m.revenue)}</td>
      <td class="text-right">
        <span class="badge ${m.revenue < 800 ? 'badge-red' : m.revenue < 2000 ? 'badge-amber' : 'badge-green'}">
          ${m.revenue < 800 ? 'Pull Candidate' : m.revenue < 2000 ? 'Monitor' : 'OK'}
        </span>
      </td>
    </tr>
  `).join('');
}

// ===== TRENDS =====
let trendChart = null;
let propertyChart = null;
let seasonChart = null;

function loadTrends() {
  const months = parseInt(document.getElementById('trend-period').value);
  const allMonths = [...new Set(DEMO_DATA.monthlyRevenue.map(r => r.month))].sort();
  const displayMonths = allMonths.slice(-months);
  
  const revenueByMonth = displayMonths.map(m => 
    DEMO_DATA.monthlyRevenue.filter(r => r.month === m).reduce((s, r) => s + r.revenue, 0)
  );
  const profitByMonth = displayMonths.map(m => {
    const data = DEMO_DATA.monthlyRevenue.filter(r => r.month === m);
    const revenue = data.reduce((s, r) => s + r.revenue, 0);
    const cogs = data.reduce((s, r) => s + r.cogs, 0);
    return revenue - cogs;
  });
  
  // Destroy existing charts
  if (trendChart) trendChart.destroy();
  if (propertyChart) propertyChart.destroy();
  if (seasonChart) seasonChart.destroy();
  
  // Revenue Trend
  const ctx1 = document.getElementById('revenue-trend-chart').getContext('2d');
  trendChart = new Chart(ctx1, {
    type: 'line',
    data: {
      labels: displayMonths.map(m => {
        const [y, mo] = m.split('-');
        return new Date(y, mo - 1).toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
      }),
      datasets: [
        { label: 'Revenue', data: revenueByMonth, borderColor: '#22c55e', backgroundColor: 'rgba(34,197,94,0.1)', fill: true, tension: 0.3 },
        { label: 'Gross Profit', data: profitByMonth, borderColor: '#3b82f6', backgroundColor: 'rgba(59,130,246,0.1)', fill: true, tension: 0.3 }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: { y: { beginAtZero: true, ticks: { callback: v => '$' + (v/1000) + 'k' } } }
    }
  });
  
  // Revenue by Property Type
  const currentMonth = getCurrentMonth();
  const byType = {};
  DEMO_DATA.machines.forEach(m => {
    const rev = DEMO_DATA.monthlyRevenue
      .filter(r => r.machine_id === m.id && r.month === currentMonth)
      .reduce((s, r) => s + r.revenue, 0);
    byType[m.property_type] = (byType[m.property_type] || 0) + rev;
  });
  
  const ctx2 = document.getElementById('property-type-chart').getContext('2d');
  propertyChart = new Chart(ctx2, {
    type: 'pie',
    data: {
      labels: Object.keys(byType).map(t => t.charAt(0).toUpperCase() + t.slice(1)),
      datasets: [{ data: Object.values(byType), backgroundColor: ['#3b82f6', '#22c55e', '#f59e0b', '#8b5cf6', '#14b8a6'] }]
    },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
  });
  
  // Seasonality (aggregate by month of year)
  const seasonality = Array(12).fill(0);
  const seasonCounts = Array(12).fill(0);
  DEMO_DATA.monthlyRevenue.forEach(r => {
    const monthNum = parseInt(r.month.split('-')[1]) - 1;
    seasonality[monthNum] += r.revenue;
    seasonCounts[monthNum]++;
  });
  const avgSeasonality = seasonality.map((s, i) => seasonCounts[i] > 0 ? s / seasonCounts[i] : 0);
  
  const ctx3 = document.getElementById('seasonality-chart').getContext('2d');
  seasonChart = new Chart(ctx3, {
    type: 'bar',
    data: {
      labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
      datasets: [{
        label: 'Avg Revenue',
        data: avgSeasonality,
        backgroundColor: avgSeasonality.map(v => v > 12000 ? '#22c55e' : v > 10000 ? '#14b8a6' : '#f59e0b')
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: { y: { beginAtZero: true, ticks: { callback: v => '$' + (v/1000) + 'k' } } },
      plugins: { legend: { display: false } }
    }
  });
}

// ===== PROJECTIONS =====
let projectionChart = null;

function loadProjections() {
  // Calculate current metrics
  const currentMonth = getCurrentMonth();
  const deployedMachines = DEMO_DATA.machines.filter(m => m.status === 'deployed').length;
  const monthData = DEMO_DATA.monthlyRevenue.filter(r => r.month === currentMonth);
  const totalRevenue = monthData.reduce((s, r) => s + r.revenue, 0);
  const avgRevenuePerMachine = deployedMachines > 0 ? totalRevenue / deployedMachines : 2000; // Default assumption
  
  const cogsRate = DEMO_DATA.expenses.cogs_rate;
  const avgCommRate = DEMO_DATA.expenses.avg_commission_rate;
  const fixedCosts = DEMO_DATA.expenses.monthly_fixed;
  const profitMargin = 1 - cogsRate - avgCommRate;
  
  // Update assumptions display
  document.getElementById('proj-avg-revenue').textContent = formatCurrency(avgRevenuePerMachine);
  document.getElementById('proj-avg-margin').textContent = formatPercent(profitMargin);
  document.getElementById('proj-monthly-expenses').textContent = formatCurrency(fixedCosts);
  
  document.getElementById('assumption-revenue').textContent = formatCurrency(avgRevenuePerMachine);
  document.getElementById('assumption-cogs').textContent = formatCurrency(avgRevenuePerMachine * cogsRate);
  document.getElementById('assumption-commission').textContent = formatCurrency(avgRevenuePerMachine * avgCommRate);
  document.getElementById('assumption-fixed').textContent = formatCurrency(fixedCosts);
  document.getElementById('assumption-net').textContent = formatCurrency(avgRevenuePerMachine * profitMargin);
  
  // Calculate projections for 5, 10, 20, 30 machines
  [5, 10, 20, 30].forEach(count => {
    const monthlyRev = avgRevenuePerMachine * count;
    const monthlyProfit = (avgRevenuePerMachine * profitMargin * count) - fixedCosts;
    document.getElementById(`proj-${count}-revenue`).textContent = formatCurrency(monthlyRev) + '/mo';
    document.getElementById(`proj-${count}-profit`).textContent = formatCurrency(monthlyProfit) + ' profit';
  });
  
  // Break-even analysis
  const profitPerMachine = avgRevenuePerMachine * profitMargin;
  const breakEvenMachines = Math.ceil(fixedCosts / profitPerMachine);
  
  document.getElementById('breakeven-machines').textContent = `${breakEvenMachines} machines`;
  document.getElementById('current-machines').textContent = deployedMachines;
  document.getElementById('target-machines').textContent = breakEvenMachines;
  
  const progress = Math.min(100, (deployedMachines / breakEvenMachines) * 100);
  document.getElementById('breakeven-progress').style.width = progress + '%';
  document.getElementById('breakeven-progress').className = 'progress-fill ' + (progress >= 100 ? 'green' : progress >= 50 ? 'amber' : 'red');
  
  // Projection chart
  if (projectionChart) projectionChart.destroy();
  const machineScenarios = [1, 2, 3, 5, 8, 10, 15, 20, 25, 30];
  const revenues = machineScenarios.map(m => avgRevenuePerMachine * m);
  const profits = machineScenarios.map(m => (avgRevenuePerMachine * profitMargin * m) - fixedCosts);
  
  const ctx = document.getElementById('projection-chart').getContext('2d');
  projectionChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: machineScenarios.map(m => m + ' machines'),
      datasets: [
        { label: 'Monthly Revenue', data: revenues, borderColor: '#22c55e', backgroundColor: 'rgba(34,197,94,0.1)', fill: false, tension: 0.2 },
        { label: 'Monthly Profit', data: profits, borderColor: '#3b82f6', backgroundColor: 'rgba(59,130,246,0.1)', fill: false, tension: 0.2 }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: { y: { ticks: { callback: v => '$' + (v/1000) + 'k' } } }
    }
  });
  
  // Pipeline impact
  const pipelineData = DEMO_DATA.pipeline;
  document.getElementById('pipeline-impact-tbody').innerHTML = pipelineData.map(p => {
    const potentialRev = avgRevenuePerMachine * p.count;
    const weightedValue = potentialRev * p.probability;
    return `
      <tr>
        <td><strong>${p.stage}</strong></td>
        <td class="text-center">${p.count}</td>
        <td class="text-right">${formatCurrency(potentialRev)}/mo</td>
        <td class="text-center">${formatPercent(p.probability)}</td>
        <td class="text-right"><strong>${formatCurrency(weightedValue)}/mo</strong></td>
      </tr>
    `;
  }).join('');
  
  const totalWeighted = pipelineData.reduce((s, p) => s + (avgRevenuePerMachine * p.count * p.probability), 0);
  document.getElementById('pipeline-impact-tbody').innerHTML += `
    <tr style="background: var(--accent-light); font-weight: 700;">
      <td>Total Pipeline Value</td>
      <td class="text-center">${pipelineData.reduce((s, p) => s + p.count, 0)}</td>
      <td class="text-right">${formatCurrency(pipelineData.reduce((s, p) => s + avgRevenuePerMachine * p.count, 0))}/mo</td>
      <td></td>
      <td class="text-right">${formatCurrency(totalWeighted)}/mo</td>
    </tr>
  `;
}

// ===== INITIALIZATION =====
document.addEventListener('DOMContentLoaded', () => {
  loadOverview();
});

// Close modal on outside click
document.getElementById('machine-modal').addEventListener('click', (e) => {
  if (e.target.id === 'machine-modal') closeMachineModal();
});
</script>
</body>
</html>
