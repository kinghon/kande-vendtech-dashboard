<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-vend-32.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-vend.png">
  <title>Seasonal Trends ‚Äî Kande VendTech</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg: #f5f7fa;
      --card: #ffffff;
      --card-hover: #f7fafc;
      --border: #e2e8f0;
      --text: #1a202c;
      --muted: #718096;
      --accent: #3182ce;
      --accent-dim: rgba(49,130,206,0.1);
      --success: #38a169;
      --warn: #dd6b20;
      --hot: #e53e3e;
      --purple: #7b2cbf;
      --pink: #d53f8c;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    .top-nav {
      display: flex; align-items: center; gap: 10px; padding: 14px 24px;
      border-bottom: 1px solid var(--border); background: var(--card);
      flex-wrap: wrap; position: sticky; top: 0; z-index: 100;
    }
    .top-nav .logo { height: 36px; }
    .nav-brand { font-size: 0.9rem; font-weight: 600; color: var(--accent); margin-right: 8px; }
    .top-nav a { color: var(--muted); text-decoration: none; font-size: 0.82rem; font-weight: 500; padding: 5px 10px; border-radius: 6px; transition: all 0.2s; }
    .top-nav a:hover { color: var(--text); background: rgba(0,0,0,0.05); }
    .top-nav a.active { color: var(--accent); background: var(--accent-dim); }

    .container { max-width: 1360px; margin: 0 auto; padding: 32px 24px; }

    .page-header { margin-bottom: 32px; }
    .page-header h1 {
      font-size: 2rem; font-weight: 700;
      background: linear-gradient(90deg, var(--accent), var(--purple));
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      background-clip: text; margin-bottom: 6px;
    }
    .page-header p { color: var(--muted); font-size: 0.95rem; }

    /* Summary Cards */
    .summary-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 14px; margin-bottom: 32px;
    }
    .summary-card {
      background: var(--card); border: 1px solid var(--border); border-radius: 14px;
      padding: 20px; text-align: center; transition: all 0.2s;
    }
    .summary-card:hover { border-color: rgba(49,130,206,0.2); transform: translateY(-2px); }
    .summary-card .value { font-size: 2rem; font-weight: 700; line-height: 1.1; }
    .summary-card .label { font-size: 0.72rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.6px; font-weight: 600; margin-top: 6px; }
    .summary-card .sub { font-size: 0.78rem; color: var(--muted); margin-top: 4px; }
    .v-accent { color: var(--accent); }
    .v-success { color: var(--success); }
    .v-warn { color: var(--warn); }
    .v-hot { color: var(--hot); }
    .v-purple { color: var(--purple); }
    .v-pink { color: var(--pink); }

    /* Cards */
    .card {
      background: var(--card); border: 1px solid var(--border); border-radius: 14px;
      padding: 24px; margin-bottom: 20px;
    }
    .card h2 {
      font-size: 1.15rem; font-weight: 600; margin-bottom: 18px;
      display: flex; align-items: center; gap: 10px;
    }
    .card h2 .icon { font-size: 1.2rem; }

    /* Grids */
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
    .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 20px; }

    /* Chart containers */
    .chart-wrap { position: relative; width: 100%; min-height: 300px; }
    .chart-wrap canvas { width: 100% !important; }

    /* Prediction Banner */
    .prediction-banner {
      background: linear-gradient(135deg, rgba(49,130,206,0.1), rgba(167,139,250,0.1));
      border: 1px solid rgba(49,130,206,0.18); border-radius: 14px;
      padding: 24px 28px; margin-bottom: 24px;
      display: flex; align-items: center; gap: 20px; flex-wrap: wrap;
    }
    .prediction-icon { font-size: 2.5rem; }
    .prediction-content { flex: 1; min-width: 200px; }
    .prediction-content h3 { font-size: 1.1rem; font-weight: 600; margin-bottom: 4px; }
    .prediction-content p { color: var(--muted); font-size: 0.88rem; line-height: 1.5; }
    .prediction-value {
      font-size: 2.2rem; font-weight: 700; text-align: right; min-width: 120px;
    }
    .prediction-pct { font-size: 0.85rem; font-weight: 600; }
    .trend-up { color: var(--success); }
    .trend-down { color: var(--hot); }
    .confidence-badge {
      display: inline-block; padding: 3px 10px; border-radius: 12px;
      font-size: 0.7rem; font-weight: 600; text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .conf-high { background: rgba(52,211,153,0.15); color: var(--success); }
    .conf-medium { background: rgba(251,191,36,0.15); color: var(--warn); }
    .conf-low { background: rgba(248,113,113,0.15); color: var(--hot); }

    /* Season Cards */
    .season-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 14px;
    }
    .season-card {
      background: rgba(0,0,0,0.02); border: 1px solid var(--border);
      border-radius: 12px; padding: 18px; text-align: center; transition: all 0.2s;
    }
    .season-card:hover { border-color: rgba(49,130,206,0.2); }
    .season-emoji { font-size: 2rem; margin-bottom: 8px; }
    .season-name { font-size: 0.78rem; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }
    .season-avg { font-size: 1.6rem; font-weight: 700; }
    .season-index { font-size: 0.78rem; margin-top: 4px; }
    .season-months { font-size: 0.72rem; color: var(--muted); margin-top: 6px; }

    /* MoM Changes */
    .mom-list { display: flex; flex-direction: column; gap: 6px; max-height: 400px; overflow-y: auto; }
    .mom-item {
      display: flex; align-items: center; justify-content: space-between;
      padding: 10px 14px; background: rgba(0,0,0,0.02);
      border-radius: 8px; font-size: 0.85rem;
    }
    .mom-item:hover { background: rgba(0,0,0,0.04); }
    .mom-month { font-weight: 500; }
    .mom-change { font-weight: 700; }

    /* Empty State */
    .empty-state { text-align: center; padding: 60px 20px; color: var(--muted); }
    .empty-state .emoji { font-size: 3rem; margin-bottom: 12px; }
    .empty-state h3 { font-size: 1.2rem; color: var(--text); margin-bottom: 6px; }
    .empty-state p { font-size: 0.9rem; max-width: 400px; margin: 0 auto; }

    /* Loading */
    .loading { display: flex; align-items: center; justify-content: center; padding: 40px; color: var(--muted); gap: 10px; }
    .spinner { width: 20px; height: 20px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Insight Pill */
    .insight {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 8px 16px; background: var(--accent-dim);
      border: 1px solid rgba(49,130,206,0.15); border-radius: 20px;
      font-size: 0.82rem; color: var(--accent); font-weight: 500; margin-bottom: 20px;
    }

    /* Responsive */
    @media (max-width: 1024px) {
      .grid-2, .grid-3 { grid-template-columns: 1fr; }
    }
    @media (max-width: 768px) {
      .summary-grid { grid-template-columns: repeat(2, 1fr); }
      .container { padding: 20px 14px; }
      .page-header h1 { font-size: 1.5rem; }
      .prediction-banner { flex-direction: column; text-align: center; }
      .prediction-value { text-align: center; }
      .chart-wrap { min-height: 250px; }
    }
    @media (max-width: 480px) {
      .summary-grid { grid-template-columns: 1fr; }
      .season-grid { grid-template-columns: repeat(2, 1fr); }
    }
  </style>
</head>
<body>
  <nav class="top-nav">
    <a href="/"><img src="/logo.png" alt="Kande VendTech" class="logo" onerror="this.style.display='none'"></a>
    <span class="nav-brand">Seasonal Trends</span>
    <a href="/">Dashboard</a>
    <a href="/revenue">Revenue</a>
    <a href="/performance">Performance</a>
    <a href="/analytics">Analytics</a>
    <a href="/trends" class="active">Trends</a>
  </nav>

  <div class="container">
    <div class="page-header">
      <h1>üìâ Seasonal Trend Analysis</h1>
      <p>Revenue patterns, year-over-year comparison, and next-month predictions ‚Äî tuned for Las Vegas vending</p>
    </div>

    <div id="content">
      <div class="loading">
        <div class="spinner"></div>
        Loading trend data...
      </div>
    </div>
  </div>

  <script src="/nav.js"></script>
  <script>
    const MONTH_NAMES = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    const SEASON_META = {
      summer:      { emoji: '‚òÄÔ∏è', label: 'Summer', months: 'Jun ‚Äì Aug', desc: 'Peak heat ‚Üí high consumption' },
      holidays:    { emoji: 'üéÑ', label: 'Holidays', months: 'Nov ‚Äì Dec', desc: 'Tourism spike in Vegas' },
      postHoliday: { emoji: '‚ùÑÔ∏è', label: 'Post-Holiday', months: 'Jan ‚Äì Feb', desc: 'Potential slowdown' },
      spring:      { emoji: 'üå∏', label: 'Spring', months: 'Mar ‚Äì May', desc: 'Warming up, steady traffic' },
      fall:        { emoji: 'üçÇ', label: 'Fall', months: 'Sep ‚Äì Oct', desc: 'Transitional period' }
    };

    const YEAR_COLORS = [
      { border: '#3182ce', bg: 'rgba(49,130,206,0.12)' },
      { border: '#7b2cbf', bg: 'rgba(123,44,191,0.1)' },
      { border: '#d53f8c', bg: 'rgba(213,63,140,0.1)' },
      { border: '#dd6b20', bg: 'rgba(214,158,46,0.1)' },
      { border: '#38a169', bg: 'rgba(56,161,105,0.1)' }
    ];

    const PROP_COLORS = {
      apartments:    { border: '#3182ce', bg: 'rgba(49,130,206,0.12)' },
      senior_living: { border: '#7b2cbf', bg: 'rgba(123,44,191,0.1)' },
      healthcare:    { border: '#38a169', bg: 'rgba(56,161,105,0.1)' },
      industrial:    { border: '#dd6b20', bg: 'rgba(214,158,46,0.1)' },
      office:        { border: '#d53f8c', bg: 'rgba(213,63,140,0.1)' },
      unknown:       { border: '#64748b', bg: 'rgba(100,116,139,0.15)' }
    };

    function fmt$(n) {
      return '$' + (n || 0).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
    }

    function fmtPct(n) {
      const sign = n >= 0 ? '+' : '';
      return sign + n.toFixed(1) + '%';
    }

    function formatPropType(t) {
      const map = { apartments: 'Apartments', senior_living: 'Senior Living', healthcare: 'Healthcare', industrial: 'Industrial', office: 'Office', unknown: 'Unknown' };
      return map[t] || t.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
    }

    let charts = [];

    function destroyCharts() {
      charts.forEach(c => c.destroy());
      charts = [];
    }

    async function load() {
      try {
        const res = await fetch('/api/analytics/trends');
        const data = await res.json();
        render(data);
      } catch (e) {
        document.getElementById('content').innerHTML = `
          <div class="empty-state">
            <div class="emoji">‚ö†Ô∏è</div>
            <h3>Error Loading Data</h3>
            <p>${e.message}</p>
          </div>`;
      }
    }

    function render(data) {
      destroyCharts();
      const el = document.getElementById('content');

      if (data.totalMonths === 0) {
        el.innerHTML = `
          <div class="empty-state">
            <div class="emoji">üìâ</div>
            <h3>No Revenue Data Yet</h3>
            <p>Add revenue entries on the <a href="/revenue" style="color:var(--accent)">Revenue page</a> to see seasonal trends, year-over-year comparisons, and predictions.</p>
          </div>`;
        return;
      }

      let html = '';

      // === Prediction Banner ===
      if (data.prediction) {
        const p = data.prediction;
        const trendClass = p.direction === 'up' ? 'trend-up' : 'trend-down';
        const trendIcon = p.direction === 'up' ? 'üìà' : 'üìâ';
        const confClass = p.confidence === 'high' ? 'conf-high' : p.confidence === 'medium' ? 'conf-medium' : 'conf-low';
        const seasonInfo = SEASON_META[p.season] || {};

        html += `
          <div class="prediction-banner">
            <div class="prediction-icon">${trendIcon}</div>
            <div class="prediction-content">
              <h3>Next Month Prediction: ${MONTH_NAMES[p.monthNum - 1]} ${p.month.split('-')[0]}</h3>
              <p>Based on ${p.basis}. ${seasonInfo.desc || ''} 
                <span class="confidence-badge ${confClass}">${p.confidence} confidence</span>
              </p>
            </div>
            <div>
              <div class="prediction-value ${trendClass}">${fmt$(p.predicted)}</div>
              <div class="prediction-pct ${trendClass}">${fmtPct(p.pctChange)} vs last month</div>
            </div>
          </div>`;
      }

      // === Summary Cards ===
      const bestSeason = Object.entries(data.seasonalAvg)
        .filter(([_, v]) => v.count > 0)
        .sort((a, b) => b[1].average - a[1].average)[0];

      html += `
        <div class="summary-grid">
          <div class="summary-card">
            <div class="value v-accent">${fmt$(data.totalRevenue)}</div>
            <div class="label">Total Revenue</div>
            <div class="sub">${data.totalMonths} months tracked</div>
          </div>
          <div class="summary-card">
            <div class="value v-purple">${fmt$(data.overallAvg)}</div>
            <div class="label">Monthly Average</div>
          </div>
          <div class="summary-card">
            <div class="value v-success">${data.years.length}</div>
            <div class="label">Years of Data</div>
            <div class="sub">${data.years.join(', ')}</div>
          </div>
          <div class="summary-card">
            <div class="value v-warn">${bestSeason ? (SEASON_META[bestSeason[0]]?.emoji || '') : '‚Äî'}</div>
            <div class="label">Best Season</div>
            <div class="sub">${bestSeason ? SEASON_META[bestSeason[0]]?.label + ' ¬∑ ' + fmt$(bestSeason[1].average) + '/mo' : 'N/A'}</div>
          </div>
        </div>`;

      // === Main Revenue Trend Line Chart ===
      html += `
        <div class="card">
          <h2><span class="icon">üìä</span> Monthly Revenue Trend</h2>
          <div class="chart-wrap"><canvas id="trendChart"></canvas></div>
        </div>`;

      // === YoY Comparison + Property Breakdown ===
      html += `<div class="grid-2">`;

      html += `
        <div class="card">
          <h2><span class="icon">üìÖ</span> Year-over-Year Comparison</h2>
          <div class="chart-wrap"><canvas id="yoyChart"></canvas></div>
        </div>`;

      html += `
        <div class="card">
          <h2><span class="icon">üè¢</span> Revenue by Property Type</h2>
          <div class="chart-wrap"><canvas id="propChart"></canvas></div>
        </div>`;

      html += `</div>`;

      // === Seasonal Patterns ===
      html += `
        <div class="card">
          <h2><span class="icon">üå°Ô∏è</span> Seasonal Patterns ‚Äî Las Vegas Vending</h2>
          <div class="season-grid">`;

      const seasonOrder = ['spring', 'summer', 'fall', 'holidays', 'postHoliday'];
      seasonOrder.forEach(key => {
        const meta = SEASON_META[key];
        const avg = data.seasonalAvg[key] || { average: 0, count: 0 };
        const idx = data.seasonalIndices[key] || 1;
        const idxClass = idx >= 1.05 ? 'trend-up' : idx <= 0.95 ? 'trend-down' : '';
        const idxLabel = idx >= 1.05 ? '‚Üë Above avg' : idx <= 0.95 ? '‚Üì Below avg' : '‚Üí Average';

        html += `
          <div class="season-card">
            <div class="season-emoji">${meta.emoji}</div>
            <div class="season-name">${meta.label}</div>
            <div class="season-avg v-accent">${avg.count > 0 ? fmt$(avg.average) : '‚Äî'}</div>
            <div class="season-index ${idxClass}">${avg.count > 0 ? idxLabel + ' (' + (idx * 100).toFixed(0) + '%)' : 'No data'}</div>
            <div class="season-months">${meta.months} ¬∑ ${meta.desc}</div>
          </div>`;
      });

      html += `</div></div>`;

      // === MoM Changes + Seasonal Index Chart ===
      html += `<div class="grid-2">`;

      html += `
        <div class="card">
          <h2><span class="icon">üìà</span> Seasonal Index</h2>
          <div class="chart-wrap"><canvas id="seasonChart"></canvas></div>
        </div>`;

      html += `
        <div class="card">
          <h2><span class="icon">üîÑ</span> Month-over-Month Changes</h2>
          <div class="mom-list">`;

      const recentMom = [...(data.momChanges || [])].reverse().slice(0, 20);
      if (recentMom.length === 0) {
        html += `<div style="text-align:center;padding:20px;color:var(--muted)">Need at least 2 months for comparison</div>`;
      } else {
        recentMom.forEach(m => {
          const cls = m.direction === 'up' ? 'trend-up' : 'trend-down';
          const icon = m.direction === 'up' ? '‚ñ≤' : '‚ñº';
          html += `
            <div class="mom-item">
              <span class="mom-month">${m.month}</span>
              <span class="mom-change ${cls}">${icon} ${fmtPct(m.change)}</span>
            </div>`;
        });
      }

      html += `</div></div></div>`;

      el.innerHTML = html;

      // === Render Charts ===
      renderTrendChart(data);
      renderYoYChart(data);
      renderPropertyChart(data);
      renderSeasonChart(data);
    }

    function renderTrendChart(data) {
      const ctx = document.getElementById('trendChart')?.getContext('2d');
      if (!ctx || data.timeSeries.length === 0) return;

      const labels = data.timeSeries.map(t => {
        const [y, m] = t.month.split('-');
        return MONTH_NAMES[parseInt(m) - 1] + ' ' + y.slice(2);
      });

      const values = data.timeSeries.map(t => t.revenue);

      // Add prediction point
      const predLabels = [...labels];
      const predValues = [...values];
      const predictionLine = new Array(values.length).fill(null);

      if (data.prediction) {
        const [y, m] = data.prediction.month.split('-');
        predLabels.push(MONTH_NAMES[parseInt(m) - 1] + ' ' + y.slice(2) + ' ‚ü®est‚ü©');
        predValues.push(null);
        predictionLine[predictionLine.length - 1] = values[values.length - 1];
        predictionLine.push(data.prediction.predicted);
      }

      const chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: predLabels,
          datasets: [
            {
              label: 'Revenue',
              data: predValues.map((v, i) => i < values.length ? v : null),
              borderColor: '#3182ce',
              backgroundColor: 'rgba(49,130,206,0.1)',
              borderWidth: 2.5,
              fill: true,
              tension: 0.3,
              pointBackgroundColor: '#3182ce',
              pointBorderColor: '#ffffff',
              pointBorderWidth: 2,
              pointRadius: 4,
              pointHoverRadius: 7
            },
            {
              label: 'Predicted',
              data: predictionLine,
              borderColor: data.prediction?.direction === 'up' ? '#38a169' : '#e53e3e',
              borderWidth: 2.5,
              borderDash: [8, 4],
              fill: false,
              tension: 0,
              pointBackgroundColor: data.prediction?.direction === 'up' ? '#38a169' : '#e53e3e',
              pointBorderColor: '#ffffff',
              pointBorderWidth: 2,
              pointRadius: function(ctx) { return ctx.dataIndex === predictionLine.length - 1 ? 8 : 0; },
              pointHoverRadius: 10,
              pointStyle: 'star'
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          plugins: {
            legend: { labels: { color: '#e2e8f0', usePointStyle: true, padding: 16 } },
            tooltip: {
              backgroundColor: '#111118',
              borderColor: '#1e1e2e',
              borderWidth: 1,
              titleColor: '#e2e8f0',
              bodyColor: '#e2e8f0',
              callbacks: {
                label: ctx => ctx.dataset.label + ': ' + fmt$(ctx.parsed.y)
              }
            }
          },
          scales: {
            x: {
              ticks: { color: '#64748b', maxRotation: 45, font: { size: 11 } },
              grid: { color: 'rgba(0,0,0,0.04)' }
            },
            y: {
              ticks: { color: '#64748b', callback: v => fmt$(v), font: { size: 11 } },
              grid: { color: 'rgba(0,0,0,0.04)' }
            }
          }
        }
      });
      charts.push(chart);
    }

    function renderYoYChart(data) {
      const ctx = document.getElementById('yoyChart')?.getContext('2d');
      if (!ctx || data.years.length === 0) return;

      const datasets = data.years.map((year, i) => {
        const colors = YEAR_COLORS[i % YEAR_COLORS.length];
        return {
          label: year,
          data: data.byYear[year],
          borderColor: colors.border,
          backgroundColor: colors.bg,
          borderWidth: 2.5,
          fill: false,
          tension: 0.3,
          pointRadius: 4,
          pointHoverRadius: 7,
          pointBackgroundColor: colors.border,
          pointBorderColor: '#ffffff',
          pointBorderWidth: 2
        };
      });

      const chart = new Chart(ctx, {
        type: 'line',
        data: { labels: MONTH_NAMES, datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          plugins: {
            legend: { labels: { color: '#e2e8f0', usePointStyle: true, padding: 16 } },
            tooltip: {
              backgroundColor: '#111118',
              borderColor: '#1e1e2e',
              borderWidth: 1,
              titleColor: '#e2e8f0',
              bodyColor: '#e2e8f0',
              callbacks: {
                label: ctx => ctx.dataset.label + ': ' + fmt$(ctx.parsed.y)
              }
            }
          },
          scales: {
            x: { ticks: { color: '#64748b', font: { size: 11 } }, grid: { color: 'rgba(0,0,0,0.04)' } },
            y: { ticks: { color: '#64748b', callback: v => fmt$(v), font: { size: 11 } }, grid: { color: 'rgba(0,0,0,0.04)' } }
          }
        }
      });
      charts.push(chart);
    }

    function renderPropertyChart(data) {
      const ctx = document.getElementById('propChart')?.getContext('2d');
      if (!ctx) return;

      const types = Object.keys(data.propertyTimeSeries);
      if (types.length === 0) {
        ctx.canvas.parentNode.innerHTML = '<div style="text-align:center;padding:40px;color:var(--muted)">No property type data ‚Äî link locations to revenue entries</div>';
        return;
      }

      // Aggregate by property type for a bar chart
      const totals = {};
      types.forEach(pt => {
        totals[pt] = data.propertyTimeSeries[pt].reduce((s, m) => s + m.revenue, 0);
      });

      const sortedTypes = Object.entries(totals).sort((a, b) => b[1] - a[1]);

      const chart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: sortedTypes.map(([t]) => formatPropType(t)),
          datasets: [{
            label: 'Total Revenue',
            data: sortedTypes.map(([_, v]) => v),
            backgroundColor: sortedTypes.map(([t]) => (PROP_COLORS[t] || PROP_COLORS.unknown).bg),
            borderColor: sortedTypes.map(([t]) => (PROP_COLORS[t] || PROP_COLORS.unknown).border),
            borderWidth: 2,
            borderRadius: 8,
            maxBarThickness: 60
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: '#111118',
              borderColor: '#1e1e2e',
              borderWidth: 1,
              titleColor: '#e2e8f0',
              bodyColor: '#e2e8f0',
              callbacks: {
                label: ctx => fmt$(ctx.parsed.y)
              }
            }
          },
          scales: {
            x: { ticks: { color: '#64748b', font: { size: 11 } }, grid: { display: false } },
            y: { ticks: { color: '#64748b', callback: v => fmt$(v), font: { size: 11 } }, grid: { color: 'rgba(0,0,0,0.04)' } }
          }
        }
      });
      charts.push(chart);
    }

    function renderSeasonChart(data) {
      const ctx = document.getElementById('seasonChart')?.getContext('2d');
      if (!ctx) return;

      const order = ['spring', 'summer', 'fall', 'holidays', 'postHoliday'];
      const labels = order.map(k => SEASON_META[k].label);
      const indices = order.map(k => ((data.seasonalIndices[k] || 1) * 100).toFixed(0));
      const avgs = order.map(k => data.seasonalAvg[k]?.average || 0);

      const chart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [
            {
              label: 'Seasonal Index (%)',
              data: indices,
              backgroundColor: order.map(k => {
                const idx = data.seasonalIndices[k] || 1;
                if (idx >= 1.05) return 'rgba(52,211,153,0.3)';
                if (idx <= 0.95) return 'rgba(248,113,113,0.3)';
                return 'rgba(251,191,36,0.3)';
              }),
              borderColor: order.map(k => {
                const idx = data.seasonalIndices[k] || 1;
                if (idx >= 1.05) return '#38a169';
                if (idx <= 0.95) return '#e53e3e';
                return '#dd6b20';
              }),
              borderWidth: 2,
              borderRadius: 8,
              maxBarThickness: 60,
              yAxisID: 'y'
            },
            {
              label: 'Avg Revenue',
              data: avgs,
              type: 'line',
              borderColor: '#7b2cbf',
              backgroundColor: 'rgba(167,139,250,0.1)',
              borderWidth: 2.5,
              tension: 0.3,
              pointRadius: 5,
              pointBackgroundColor: '#7b2cbf',
              pointBorderColor: '#ffffff',
              pointBorderWidth: 2,
              fill: false,
              yAxisID: 'y1'
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { labels: { color: '#e2e8f0', usePointStyle: true, padding: 16 } },
            tooltip: {
              backgroundColor: '#111118',
              borderColor: '#1e1e2e',
              borderWidth: 1,
              titleColor: '#e2e8f0',
              bodyColor: '#e2e8f0',
              callbacks: {
                label: ctx => {
                  if (ctx.dataset.yAxisID === 'y1') return 'Avg: ' + fmt$(ctx.parsed.y);
                  return 'Index: ' + ctx.parsed.y + '%';
                }
              }
            },
            annotation: {
              annotations: {
                baseline: {
                  type: 'line',
                  yMin: 100, yMax: 100,
                  borderColor: 'rgba(0,0,0,0.1)',
                  borderWidth: 1,
                  borderDash: [6, 3]
                }
              }
            }
          },
          scales: {
            x: { ticks: { color: '#64748b', font: { size: 11 } }, grid: { display: false } },
            y: {
              position: 'left',
              ticks: { color: '#64748b', callback: v => v + '%', font: { size: 11 } },
              grid: { color: 'rgba(0,0,0,0.04)' },
              title: { display: true, text: 'Index (%)', color: '#64748b', font: { size: 11 } }
            },
            y1: {
              position: 'right',
              ticks: { color: '#7b2cbf', callback: v => fmt$(v), font: { size: 11 } },
              grid: { display: false },
              title: { display: true, text: 'Avg Revenue', color: '#7b2cbf', font: { size: 11 } }
            }
          }
        }
      });
      charts.push(chart);
    }

    load();
  </script>
</body>
</html>
