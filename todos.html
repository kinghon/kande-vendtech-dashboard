<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-vend-32.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-vend.png">
  <title>To-Do List ‚Äî Kande VendTech</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg: #f5f7fa; --card: #ffffff; --card-hover: #f7fafc; --border: #e2e8f0;
      --text: #1a202c; --muted: #718096; --accent: #3182ce; --accent-dim: rgba(49,130,206,0.1);
      --red: #e53e3e; --red-dim: rgba(229,62,62,0.1);
      --yellow: #d69e2e; --yellow-dim: rgba(214,158,46,0.1);
      --green: #38a169; --green-dim: rgba(56,161,105,0.1);
      --purple: #7b2cbf; --purple-dim: rgba(123,44,191,0.1);
      --radius: 12px;
    }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }
    .app { max-width: 1200px; margin: 0 auto; padding: 20px; }

    /* Header */
    .page-header { margin-bottom: 24px; }
    .page-header h1 { font-size: 1.8rem; font-weight: 700; background: linear-gradient(90deg, var(--accent), var(--purple)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 4px; }
    .page-header p { color: var(--muted); font-size: 0.9rem; }

    /* Stats Row */
    .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 12px; margin-bottom: 24px; }
    .stat-card { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px; text-align: center; transition: border-color 0.2s; }
    .stat-card:hover { border-color: var(--accent); }
    .stat-value { font-size: 2rem; font-weight: 700; }
    .stat-label { font-size: 0.72rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; margin-top: 2px; font-weight: 600; }
    .stat-accent { color: var(--accent); }
    .stat-yellow { color: var(--yellow); }
    .stat-green { color: var(--green); }
    .stat-red { color: var(--red); }
    .stat-purple { color: var(--purple); }

    /* Controls Row */
    .controls { display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
    .search-box { flex: 1; min-width: 200px; position: relative; }
    .search-box input { width: 100%; padding: 10px 14px 10px 38px; background: var(--card); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 0.9rem; outline: none; transition: border-color 0.2s; }
    .search-box input:focus { border-color: var(--accent); }
    .search-box input::placeholder { color: var(--muted); }
    .search-box .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--muted); font-size: 0.9rem; }
    .btn { padding: 10px 18px; border-radius: 8px; font-size: 0.85rem; font-weight: 600; cursor: pointer; border: 1px solid var(--border); transition: all 0.2s; white-space: nowrap; }
    .btn-primary { background: var(--accent); color: #000; border-color: var(--accent); }
    .btn-primary:hover { background: #2b6cb0; }
    .btn-ghost { background: transparent; color: var(--text); }
    .btn-ghost:hover { background: var(--card-hover); border-color: var(--accent); }
    .btn-sm { padding: 6px 12px; font-size: 0.78rem; }

    /* Filter Tabs */
    .filter-tabs { display: flex; gap: 4px; margin-bottom: 16px; flex-wrap: wrap; }
    .filter-tab { padding: 8px 16px; border-radius: 8px; font-size: 0.82rem; font-weight: 600; cursor: pointer; background: var(--card); border: 1px solid var(--border); color: var(--muted); transition: all 0.2s; }
    .filter-tab:hover { color: var(--text); border-color: #404040; }
    .filter-tab.active { background: var(--accent-dim); color: var(--accent); border-color: var(--accent); }
    .filter-tab .count { display: inline-block; background: var(--border); padding: 1px 7px; border-radius: 10px; font-size: 0.7rem; margin-left: 4px; }
    .filter-tab.active .count { background: rgba(49,130,206,0.18); }

    /* Inline Filters */
    .inline-filters { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
    .filter-select { padding: 7px 12px; background: var(--card); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 0.82rem; outline: none; cursor: pointer; }
    .filter-select:focus { border-color: var(--accent); }
    .filter-label { color: var(--muted); font-size: 0.78rem; font-weight: 600; }

    /* Task List */
    .task-list { display: flex; flex-direction: column; gap: 8px; margin-bottom: 24px; }
    .task-card { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px; transition: all 0.2s; cursor: pointer; }
    .task-card:hover { border-color: #404040; background: var(--card-hover); }
    .task-card.completed { opacity: 0.55; }
    .task-card.completed .task-title { text-decoration: line-through; color: var(--muted); }
    .task-card.overdue { border-left: 3px solid var(--red); }

    .task-top { display: flex; align-items: flex-start; gap: 12px; }
    .task-checkbox { width: 22px; height: 22px; border: 2px solid var(--border); border-radius: 6px; cursor: pointer; flex-shrink: 0; display: flex; align-items: center; justify-content: center; transition: all 0.2s; margin-top: 2px; background: transparent; color: transparent; font-size: 0.8rem; }
    .task-checkbox:hover { border-color: var(--accent); }
    .task-card.completed .task-checkbox { background: var(--green); border-color: var(--green); color: #fff; }
    .task-content { flex: 1; min-width: 0; }
    .task-title { font-weight: 600; font-size: 0.95rem; margin-bottom: 4px; line-height: 1.4; }
    .task-desc { color: var(--muted); font-size: 0.82rem; line-height: 1.5; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .task-meta { display: flex; align-items: center; gap: 8px; margin-top: 10px; flex-wrap: wrap; }
    .tag { padding: 3px 10px; border-radius: 20px; font-size: 0.72rem; font-weight: 600; }
    .tag-category { background: var(--accent-dim); color: var(--accent); }
    .tag-high { background: var(--red-dim); color: var(--red); }
    .tag-medium { background: var(--yellow-dim); color: var(--yellow); }
    .tag-low { background: var(--green-dim); color: var(--green); }
    .tag-status { background: var(--purple-dim); color: var(--purple); }
    .task-due { font-size: 0.78rem; color: var(--muted); margin-left: auto; white-space: nowrap; }
    .task-due.overdue { color: var(--red); font-weight: 600; }
    .task-due.soon { color: var(--yellow); }

    /* Expanded Details */
    .task-details { display: none; margin-top: 14px; padding-top: 14px; border-top: 1px solid var(--border); }
    .task-card.expanded .task-details { display: block; }
    .task-card.expanded .task-desc { -webkit-line-clamp: unset; }
    .detail-label { font-size: 0.72rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; margin-bottom: 4px; }
    .detail-notes { font-size: 0.85rem; color: var(--text); line-height: 1.6; margin-bottom: 12px; white-space: pre-wrap; }
    .detail-actions { display: flex; gap: 8px; flex-wrap: wrap; }

    /* Empty State */
    .empty-state { text-align: center; padding: 60px 20px; color: var(--muted); }
    .empty-state .icon { font-size: 3rem; margin-bottom: 12px; }
    .empty-state p { font-size: 0.95rem; }

    /* Modal */
    .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 10000; align-items: center; justify-content: center; padding: 20px; }
    .modal-overlay.open { display: flex; }
    .modal { background: var(--card); border: 1px solid var(--border); border-radius: 16px; width: 100%; max-width: 520px; max-height: 90vh; overflow-y: auto; }
    .modal-header { display: flex; align-items: center; justify-content: space-between; padding: 20px 24px 0; }
    .modal-header h2 { font-size: 1.2rem; font-weight: 700; }
    .modal-close { background: none; border: none; color: var(--muted); font-size: 1.5rem; cursor: pointer; padding: 4px; }
    .modal-close:hover { color: var(--text); }
    .modal-body { padding: 20px 24px; }
    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; font-size: 0.8rem; color: var(--muted); font-weight: 600; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
    .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 10px 14px; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 0.9rem; font-family: inherit; outline: none; transition: border-color 0.2s; }
    .form-group input:focus, .form-group textarea:focus, .form-group select:focus { border-color: var(--accent); }
    .form-group textarea { min-height: 80px; resize: vertical; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .modal-footer { display: flex; gap: 10px; justify-content: flex-end; padding: 0 24px 20px; }

    /* Section separator */
    .section-sep { display: flex; align-items: center; gap: 12px; margin: 28px 0 16px; }
    .section-sep span { font-size: 0.85rem; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; white-space: nowrap; }
    .section-sep::after { content: ''; flex: 1; height: 1px; background: var(--border); }

    /* Progress bar for overall completion */
    .progress-bar-container { margin-bottom: 24px; }
    .progress-label { display: flex; justify-content: space-between; font-size: 0.8rem; color: var(--muted); margin-bottom: 6px; }
    .progress-bar { height: 8px; background: var(--border); border-radius: 4px; overflow: hidden; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, var(--accent), var(--green)); border-radius: 4px; transition: width 0.5s; }

    @media (max-width: 640px) {
      .stats-row { grid-template-columns: repeat(2, 1fr); }
      .form-row { grid-template-columns: 1fr; }
      .controls { flex-direction: column; }
      .search-box { min-width: 100%; }
      .task-due { margin-left: 0; }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="page-header">
      <h1>üìã To-Do List</h1>
      <p>Track action items, priorities, and deadlines ‚Äî pre-loaded with startup checklist</p>
    </div>

    <!-- Stats -->
    <div class="stats-row" id="stats-row">
      <div class="stat-card"><div class="stat-value stat-accent" id="stat-total">0</div><div class="stat-label">Total Tasks</div></div>
      <div class="stat-card"><div class="stat-value stat-yellow" id="stat-pending">0</div><div class="stat-label">Pending</div></div>
      <div class="stat-card"><div class="stat-value stat-purple" id="stat-progress">0</div><div class="stat-label">In Progress</div></div>
      <div class="stat-card"><div class="stat-value stat-green" id="stat-completed">0</div><div class="stat-label">Completed</div></div>
      <div class="stat-card"><div class="stat-value stat-red" id="stat-overdue">0</div><div class="stat-label">Overdue</div></div>
    </div>

    <!-- Progress -->
    <div class="progress-bar-container">
      <div class="progress-label">
        <span>Overall Progress</span>
        <span id="progress-pct">0%</span>
      </div>
      <div class="progress-bar"><div class="progress-fill" id="progress-fill" style="width:0%"></div></div>
    </div>

    <!-- Controls -->
    <div class="controls">
      <div class="search-box">
        <span class="search-icon">üîç</span>
        <input type="text" id="search" placeholder="Search tasks...">
      </div>
      <button class="btn btn-primary" onclick="openModal()">Ôºã Add Task</button>
    </div>

    <!-- Tabs -->
    <div class="filter-tabs" id="filter-tabs">
      <div class="filter-tab active" data-filter="all">All <span class="count" id="count-all">0</span></div>
      <div class="filter-tab" data-filter="week">This Week <span class="count" id="count-week">0</span></div>
      <div class="filter-tab" data-filter="month">This Month <span class="count" id="count-month">0</span></div>
      <div class="filter-tab" data-filter="completed">Completed <span class="count" id="count-completed">0</span></div>
    </div>

    <!-- Inline Filters -->
    <div class="inline-filters">
      <span class="filter-label">Category:</span>
      <select class="filter-select" id="filter-category">
        <option value="">All Categories</option>
      </select>
      <span class="filter-label">Priority:</span>
      <select class="filter-select" id="filter-priority">
        <option value="">All Priorities</option>
        <option value="high">üî¥ High</option>
        <option value="medium">üü° Medium</option>
        <option value="low">üü¢ Low</option>
      </select>
      <span class="filter-label">Sort:</span>
      <select class="filter-select" id="sort-by">
        <option value="priority">Priority</option>
        <option value="due_date">Due Date</option>
        <option value="category">Category</option>
        <option value="title">Title</option>
      </select>
    </div>

    <!-- Active Tasks -->
    <div id="active-tasks" class="task-list"></div>

    <!-- Completed Section -->
    <div id="completed-section" style="display:none;">
      <div class="section-sep"><span>‚úÖ Completed</span></div>
      <div id="completed-tasks" class="task-list"></div>
    </div>
  </div>

  <!-- Add/Edit Modal -->
  <div class="modal-overlay" id="modal">
    <div class="modal">
      <div class="modal-header">
        <h2 id="modal-title">Add New Task</h2>
        <button class="modal-close" onclick="closeModal()">√ó</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="edit-id">
        <div class="form-group">
          <label>Title</label>
          <input type="text" id="form-title" placeholder="Task title...">
        </div>
        <div class="form-group">
          <label>Description</label>
          <textarea id="form-desc" placeholder="What needs to be done..."></textarea>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Category</label>
            <select id="form-category">
              <option value="Legal/Compliance">Legal/Compliance</option>
              <option value="Operations">Operations</option>
              <option value="Sales">Sales</option>
              <option value="Equipment">Equipment</option>
              <option value="Growth">Growth</option>
              <option value="Other">Other</option>
            </select>
          </div>
          <div class="form-group">
            <label>Priority</label>
            <select id="form-priority">
              <option value="high">üî¥ High</option>
              <option value="medium">üü° Medium</option>
              <option value="low">üü¢ Low</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Due Date</label>
            <input type="date" id="form-due">
          </div>
          <div class="form-group">
            <label>Status</label>
            <select id="form-status">
              <option value="pending">Pending</option>
              <option value="in_progress">In Progress</option>
              <option value="completed">Completed</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label>Notes</label>
          <textarea id="form-notes" placeholder="Additional notes..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveTask()">Save Task</button>
        <button class="btn btn-ghost" id="btn-delete" style="display:none;color:var(--red);border-color:var(--red);" onclick="deleteTask()">Delete</button>
      </div>
    </div>
  </div>

  <script>
    let todos = [];
    let activeFilter = 'all';

    // ‚îÄ‚îÄ‚îÄ API ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function fetchTodos() {
      try {
        const res = await fetch('/api/todos');
        todos = await res.json();
        render();
      } catch (e) { console.error('Failed to load todos:', e); }
    }

    async function apiSave(todo) {
      const isNew = !todo.id;
      const url = isNew ? '/api/todos' : `/api/todos/${todo.id}`;
      const method = isNew ? 'POST' : 'PUT';
      const res = await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(todo) });
      return res.json();
    }

    async function apiToggle(id) {
      const res = await fetch(`/api/todos/${id}/complete`, { method: 'PUT' });
      return res.json();
    }

    async function apiDelete(id) {
      await fetch(`/api/todos/${id}`, { method: 'DELETE' });
    }

    // ‚îÄ‚îÄ‚îÄ RENDERING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function render() {
      const search = document.getElementById('search').value.toLowerCase();
      const catFilter = document.getElementById('filter-category').value;
      const priFilter = document.getElementById('filter-priority').value;
      const sortBy = document.getElementById('sort-by').value;

      const now = new Date();
      now.setHours(0, 0, 0, 0);
      const weekEnd = new Date(now);
      weekEnd.setDate(weekEnd.getDate() + (7 - weekEnd.getDay()));
      const monthEnd = new Date(now.getFullYear(), now.getMonth() + 1, 0);

      // Populate category filter dynamically
      const categories = [...new Set(todos.map(t => t.category).filter(Boolean))].sort();
      const catSelect = document.getElementById('filter-category');
      const currentCat = catSelect.value;
      const existingOpts = new Set([...catSelect.options].map(o => o.value));
      categories.forEach(c => {
        if (!existingOpts.has(c)) {
          const opt = document.createElement('option');
          opt.value = c; opt.textContent = c;
          catSelect.appendChild(opt);
        }
      });
      catSelect.value = currentCat;

      // Filter
      let filtered = todos.filter(t => {
        if (search && !t.title.toLowerCase().includes(search) && !(t.description || '').toLowerCase().includes(search)) return false;
        if (catFilter && t.category !== catFilter) return false;
        if (priFilter && t.priority !== priFilter) return false;
        if (activeFilter === 'completed') return t.completed;
        if (activeFilter === 'week') {
          if (t.completed) return false;
          const due = t.due_date ? new Date(t.due_date + 'T00:00:00') : null;
          return due && due <= weekEnd;
        }
        if (activeFilter === 'month') {
          if (t.completed) return false;
          const due = t.due_date ? new Date(t.due_date + 'T00:00:00') : null;
          return due && due <= monthEnd;
        }
        return true; // 'all'
      });

      // Sort
      const priOrder = { high: 0, medium: 1, low: 2 };
      filtered.sort((a, b) => {
        if (sortBy === 'priority') return (priOrder[a.priority] ?? 2) - (priOrder[b.priority] ?? 2);
        if (sortBy === 'due_date') return (a.due_date || '9999') < (b.due_date || '9999') ? -1 : 1;
        if (sortBy === 'category') return (a.category || '').localeCompare(b.category || '');
        return (a.title || '').localeCompare(b.title || '');
      });

      const active = filtered.filter(t => !t.completed);
      const completed = filtered.filter(t => t.completed);

      // Stats
      const allActive = todos.filter(t => !t.completed);
      const overdue = allActive.filter(t => {
        if (!t.due_date) return false;
        return new Date(t.due_date + 'T00:00:00') < now;
      });
      document.getElementById('stat-total').textContent = todos.length;
      document.getElementById('stat-pending').textContent = todos.filter(t => !t.completed && t.status !== 'in_progress').length;
      document.getElementById('stat-progress').textContent = todos.filter(t => t.status === 'in_progress' && !t.completed).length;
      document.getElementById('stat-completed').textContent = todos.filter(t => t.completed).length;
      document.getElementById('stat-overdue').textContent = overdue.length;

      // Progress
      const pct = todos.length > 0 ? Math.round((todos.filter(t => t.completed).length / todos.length) * 100) : 0;
      document.getElementById('progress-pct').textContent = pct + '%';
      document.getElementById('progress-fill').style.width = pct + '%';

      // Tab counts
      document.getElementById('count-all').textContent = todos.length;
      document.getElementById('count-week').textContent = todos.filter(t => { if (t.completed) return false; const d = t.due_date ? new Date(t.due_date + 'T00:00:00') : null; return d && d <= weekEnd; }).length;
      document.getElementById('count-month').textContent = todos.filter(t => { if (t.completed) return false; const d = t.due_date ? new Date(t.due_date + 'T00:00:00') : null; return d && d <= monthEnd; }).length;
      document.getElementById('count-completed').textContent = todos.filter(t => t.completed).length;

      // Render active tasks
      const activeEl = document.getElementById('active-tasks');
      if (active.length === 0 && completed.length === 0) {
        activeEl.innerHTML = `<div class="empty-state"><div class="icon">üìã</div><p>No tasks match your filters</p></div>`;
      } else {
        activeEl.innerHTML = active.map(t => renderCard(t, now)).join('');
      }

      // Render completed
      const compSection = document.getElementById('completed-section');
      const compEl = document.getElementById('completed-tasks');
      if (completed.length > 0 && activeFilter !== 'completed') {
        compSection.style.display = 'block';
        compEl.innerHTML = completed.map(t => renderCard(t, now)).join('');
      } else if (activeFilter === 'completed') {
        compSection.style.display = 'none';
        activeEl.innerHTML = completed.map(t => renderCard(t, now)).join('');
      } else {
        compSection.style.display = 'none';
      }
    }

    function renderCard(t, now) {
      const isOverdue = !t.completed && t.due_date && new Date(t.due_date + 'T00:00:00') < now;
      const isSoon = !t.completed && t.due_date && !isOverdue && (new Date(t.due_date + 'T00:00:00') - now) < 3 * 24 * 60 * 60 * 1000;
      const priLabel = { high: 'üî¥ High', medium: 'üü° Medium', low: 'üü¢ Low' }[t.priority] || t.priority;
      const priClass = { high: 'tag-high', medium: 'tag-medium', low: 'tag-low' }[t.priority] || '';
      const dueLabel = t.due_date ? formatDate(t.due_date) : '';
      const dueClass = isOverdue ? 'overdue' : isSoon ? 'soon' : '';

      return `
        <div class="task-card ${t.completed ? 'completed' : ''} ${isOverdue ? 'overdue' : ''}" data-id="${t.id}" onclick="toggleExpand(this, event)">
          <div class="task-top">
            <button class="task-checkbox" onclick="toggleComplete(${t.id}, event)" title="${t.completed ? 'Mark incomplete' : 'Mark complete'}">${t.completed ? '‚úì' : ''}</button>
            <div class="task-content">
              <div class="task-title">${esc(t.title)}</div>
              <div class="task-desc">${esc(t.description || '')}</div>
              <div class="task-meta">
                <span class="tag tag-category">${esc(t.category || 'Other')}</span>
                <span class="tag ${priClass}">${priLabel}</span>
                ${t.status === 'in_progress' ? '<span class="tag tag-status">In Progress</span>' : ''}
                ${dueLabel ? `<span class="task-due ${dueClass}">${isOverdue ? '‚ö†Ô∏è ' : ''}${dueLabel}</span>` : ''}
              </div>
            </div>
          </div>
          <div class="task-details">
            ${t.notes ? `<div class="detail-label">Notes</div><div class="detail-notes">${esc(t.notes)}</div>` : ''}
            <div class="detail-actions">
              <button class="btn btn-sm btn-ghost" onclick="editTask(${t.id}, event)">‚úèÔ∏è Edit</button>
              <button class="btn btn-sm btn-ghost" onclick="setStatus(${t.id}, 'in_progress', event)" ${t.status === 'in_progress' ? 'style="color:var(--purple)"' : ''}>üîÑ In Progress</button>
              <button class="btn btn-sm btn-ghost" style="color:var(--red)" onclick="confirmDelete(${t.id}, event)">üóëÔ∏è Delete</button>
            </div>
          </div>
        </div>`;
    }

    function formatDate(dateStr) {
      const d = new Date(dateStr + 'T00:00:00');
      const now = new Date(); now.setHours(0,0,0,0);
      const diff = Math.ceil((d - now) / (1000 * 60 * 60 * 24));
      const formatted = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      if (diff < 0) return `${formatted} (${Math.abs(diff)}d overdue)`;
      if (diff === 0) return `${formatted} (Today)`;
      if (diff === 1) return `${formatted} (Tomorrow)`;
      if (diff <= 7) return `${formatted} (${diff}d)`;
      return formatted;
    }

    function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

    // ‚îÄ‚îÄ‚îÄ INTERACTIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function toggleExpand(el, e) {
      if (e.target.closest('.task-checkbox') || e.target.closest('.btn')) return;
      el.classList.toggle('expanded');
    }

    async function toggleComplete(id, e) {
      e.stopPropagation();
      const todo = todos.find(t => t.id === id);
      if (!todo) return;
      
      // If already completed, just uncomplete
      if (todo.completed) {
        const updated = await apiToggle(id);
        const idx = todos.findIndex(t => t.id === id);
        if (idx >= 0) todos[idx] = updated;
        render();
        return;
      }
      
      // Show completion modal
      document.getElementById('complete-modal').style.display = 'flex';
      document.getElementById('complete-task-id').value = id;
      document.getElementById('complete-task-name').textContent = todo.title;
      document.getElementById('complete-notes').value = '';
      document.getElementById('complete-next-action').value = '';
      document.getElementById('complete-followup-date').value = '';
      document.getElementById('complete-notes').focus();
    }

    async function submitCompletion() {
      const id = parseInt(document.getElementById('complete-task-id').value);
      const notes = document.getElementById('complete-notes').value;
      const nextAction = document.getElementById('complete-next-action').value;
      const followupDate = document.getElementById('complete-followup-date').value;
      
      // Complete the task
      const updated = await apiToggle(id);
      const idx = todos.findIndex(t => t.id === id);
      if (idx >= 0) {
        todos[idx] = updated;
        if (notes) todos[idx].completion_notes = notes;
        if (nextAction) todos[idx].next_action = nextAction;
        if (followupDate) todos[idx].followup_date = followupDate;
        await apiSave(todos[idx]);
      }

      // If there's a prospect, log the activity
      const todo = todos[idx];
      if (todo && todo.prospect_id) {
        try {
          await fetch(`/api/prospects/${todo.prospect_id}/activities`, {
            method: 'POST', headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ type: 'task_completed', description: `‚úÖ ${todo.title}${notes ? ' ‚Äî ' + notes : ''}`, next_action: nextAction || null })
          });
        } catch(e) {}
      }

      // Create follow-up task if next action selected
      if (nextAction && nextAction !== 'none') {
        const newTask = {
          title: nextAction === 'other' ? 'Follow up' : nextAction,
          description: notes ? 'Previous notes: ' + notes : '',
          category: todo ? todo.category : 'Sales',
          priority: 'high',
          due_date: followupDate || null,
          prospect_id: todo ? todo.prospect_id : null,
          prospect_name: todo ? todo.prospect_name : null,
          status: 'pending'
        };
        try {
          const res = await fetch('/api/todos', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(newTask) });
          const created = await res.json();
          todos.push(created);
        } catch(e) {}
      }

      closeCompleteModal();
      render();
    }

    function closeCompleteModal() {
      document.getElementById('complete-modal').style.display = 'none';
    }

    async function setStatus(id, status, e) {
      e.stopPropagation();
      const todo = todos.find(t => t.id === id);
      if (!todo) return;
      const updated = await apiSave({ ...todo, status });
      const idx = todos.findIndex(t => t.id === id);
      if (idx >= 0) todos[idx] = updated;
      render();
    }

    function editTask(id, e) {
      e.stopPropagation();
      const t = todos.find(t => t.id === id);
      if (!t) return;
      document.getElementById('modal-title').textContent = 'Edit Task';
      document.getElementById('edit-id').value = t.id;
      document.getElementById('form-title').value = t.title;
      document.getElementById('form-desc').value = t.description || '';
      document.getElementById('form-category').value = t.category || 'Other';
      document.getElementById('form-priority').value = t.priority || 'medium';
      document.getElementById('form-due').value = t.due_date || '';
      document.getElementById('form-status').value = t.status || 'pending';
      document.getElementById('form-notes').value = t.notes || '';
      document.getElementById('btn-delete').style.display = 'block';
      document.getElementById('modal').classList.add('open');
    }

    async function confirmDelete(id, e) {
      e.stopPropagation();
      if (!confirm('Delete this task?')) return;
      await apiDelete(id);
      todos = todos.filter(t => t.id !== id);
      render();
    }

    // ‚îÄ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function openModal() {
      document.getElementById('modal-title').textContent = 'Add New Task';
      document.getElementById('edit-id').value = '';
      document.getElementById('form-title').value = '';
      document.getElementById('form-desc').value = '';
      document.getElementById('form-category').value = 'Operations';
      document.getElementById('form-priority').value = 'medium';
      document.getElementById('form-due').value = '';
      document.getElementById('form-status').value = 'pending';
      document.getElementById('form-notes').value = '';
      document.getElementById('btn-delete').style.display = 'none';
      document.getElementById('modal').classList.add('open');
    }

    function closeModal() {
      document.getElementById('modal').classList.remove('open');
    }

    async function saveTask() {
      const title = document.getElementById('form-title').value.trim();
      if (!title) { alert('Title is required'); return; }
      const editId = document.getElementById('edit-id').value;
      const todo = {
        title,
        description: document.getElementById('form-desc').value.trim(),
        category: document.getElementById('form-category').value,
        priority: document.getElementById('form-priority').value,
        due_date: document.getElementById('form-due').value || null,
        status: document.getElementById('form-status').value,
        notes: document.getElementById('form-notes').value.trim()
      };
      if (editId) {
        todo.id = parseInt(editId);
        const existing = todos.find(t => t.id === todo.id);
        if (existing) todo.completed = existing.completed;
      }
      const saved = await apiSave(todo);
      if (editId) {
        const idx = todos.findIndex(t => t.id === parseInt(editId));
        if (idx >= 0) todos[idx] = saved;
      } else {
        todos.push(saved);
      }
      closeModal();
      render();
    }

    async function deleteTask() {
      const id = parseInt(document.getElementById('edit-id').value);
      if (!id || !confirm('Delete this task?')) return;
      await apiDelete(id);
      todos = todos.filter(t => t.id !== id);
      closeModal();
      render();
    }

    // ‚îÄ‚îÄ‚îÄ EVENT LISTENERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    document.getElementById('search').addEventListener('input', render);
    document.getElementById('filter-category').addEventListener('change', render);
    document.getElementById('filter-priority').addEventListener('change', render);
    document.getElementById('sort-by').addEventListener('change', render);

    document.querySelectorAll('.filter-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        activeFilter = tab.dataset.filter;
        render();
      });
    });

    // Close modal on overlay click
    document.getElementById('modal').addEventListener('click', e => {
      if (e.target === document.getElementById('modal')) closeModal();
    });

    // ESC to close modal
    document.addEventListener('keydown', e => {
      if (e.key === 'Escape') closeModal();
    });

    // ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    fetchTodos();
  </script>

  <!-- Completion Modal -->
  <div id="complete-modal" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.5); z-index:9999; align-items:center; justify-content:center; padding:20px;">
    <div style="background:#fff; border-radius:16px; padding:28px; max-width:480px; width:100%; box-shadow:0 20px 60px rgba(0,0,0,0.15);">
      <h3 style="margin-bottom:4px; font-size:1.1rem;">‚úÖ Task Completed</h3>
      <p id="complete-task-name" style="color:#718096; font-size:0.85rem; margin-bottom:20px;"></p>
      <input type="hidden" id="complete-task-id">
      
      <label style="font-size:0.8rem; font-weight:600; color:#4a5568; display:block; margin-bottom:6px;">Sales Notes</label>
      <textarea id="complete-notes" placeholder="What happened? Key details, outcomes, next steps..." style="width:100%; padding:10px 14px; border:1px solid #e2e8f0; border-radius:8px; font-size:0.88rem; resize:vertical; min-height:80px; margin-bottom:16px; font-family:inherit;"></textarea>
      
      <label style="font-size:0.8rem; font-weight:600; color:#4a5568; display:block; margin-bottom:6px;">Next Action</label>
      <select id="complete-next-action" style="width:100%; padding:10px 14px; border:1px solid #e2e8f0; border-radius:8px; font-size:0.88rem; margin-bottom:16px; background:#fff;">
        <option value="">No follow-up needed</option>
        <option value="Follow-up call">üìû Follow-up call</option>
        <option value="Follow-up email">üìß Follow-up email</option>
        <option value="Send proposal">üìÑ Send proposal</option>
        <option value="Schedule site survey">üìã Schedule site survey</option>
        <option value="Send contract">üìù Send contract</option>
        <option value="Pop-in visit">üö∂ Pop-in visit</option>
        <option value="Schedule meeting">ü§ù Schedule meeting</option>
        <option value="Check in with decision maker">üë§ Check in with decision maker</option>
        <option value="Research location">üîç Research location</option>
        <option value="other">‚úèÔ∏è Other</option>
      </select>

      <label style="font-size:0.8rem; font-weight:600; color:#4a5568; display:block; margin-bottom:6px;">Follow-up Date</label>
      <input type="date" id="complete-followup-date" style="width:100%; padding:10px 14px; border:1px solid #e2e8f0; border-radius:8px; font-size:0.88rem; margin-bottom:24px;">

      <div style="display:flex; gap:12px; justify-content:flex-end;">
        <button onclick="closeCompleteModal()" style="padding:10px 20px; border:1px solid #e2e8f0; border-radius:8px; background:#fff; font-size:0.85rem; font-weight:600; cursor:pointer;">Cancel</button>
        <button onclick="submitCompletion()" style="padding:10px 24px; border:none; border-radius:8px; background:#38a169; color:#fff; font-size:0.85rem; font-weight:600; cursor:pointer;">Complete & Save</button>
      </div>
    </div>
  </div>

  <script src="/nav.js"></script>
</body>
</html>
