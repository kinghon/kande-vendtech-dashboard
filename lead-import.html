<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-vend-32.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-vend.png">
  <title>Lead Import ‚Äî Kande VendTech</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg: #f5f7fa;
      --card: #ffffff;
      --card-hover: #f7fafc;
      --border: #e2e8f0;
      --text: #1a202c;
      --muted: #718096;
      --accent: #3182ce;
      --accent-dim: rgba(49,130,206,0.1);
      --success: #38a169;
      --warn: #dd6b20;
      --hot: #e53e3e;
      --purple: #7b2cbf;
      --pink: #d53f8c;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }
    .app { max-width: 1200px; margin: 0 auto; padding: 20px; }
    .header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 28px; flex-wrap: wrap; gap: 16px;
    }
    .header h1 {
      font-size: 1.5rem;
      background: linear-gradient(90deg, var(--accent), var(--purple));
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    }
    .header-sub { font-size: 0.85rem; color: var(--muted); margin-top: 4px; }

    /* Tabs */
    .tabs { display: flex; gap: 4px; margin-bottom: 24px; border-bottom: 1px solid var(--border); }
    .tab {
      padding: 12px 24px; cursor: pointer; color: var(--muted);
      font-size: 0.9rem; font-weight: 500; border-bottom: 2px solid transparent;
      transition: all 0.2s; background: none; border-top: none; border-left: none; border-right: none;
    }
    .tab:hover { color: var(--text); }
    .tab.active { color: var(--accent); border-bottom-color: var(--accent); }
    .tab-panel { display: none; }
    .tab-panel.active { display: block; }

    /* Card */
    .card {
      background: var(--card); border: 1px solid var(--border);
      border-radius: 12px; padding: 24px; margin-bottom: 20px;
    }
    .card h2 { font-size: 1.1rem; margin-bottom: 16px; color: var(--text); }
    .card h3 { font-size: 0.95rem; margin-bottom: 12px; color: var(--accent); }

    /* Form */
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .form-group { display: flex; flex-direction: column; gap: 6px; }
    .form-group.full { grid-column: 1 / -1; }
    .form-group label { font-size: 0.8rem; color: var(--muted); font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; }
    .form-group input, .form-group select, .form-group textarea {
      padding: 10px 14px; background: var(--bg); border: 1px solid var(--border);
      border-radius: 8px; color: var(--text); font-size: 0.9rem; transition: border-color 0.2s;
      font-family: inherit;
    }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
      outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-dim);
    }
    .form-group textarea { resize: vertical; min-height: 60px; }
    .form-group select { cursor: pointer; }

    /* Buttons */
    .btn {
      padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer;
      font-size: 0.9rem; font-weight: 600; transition: all 0.2s; display: inline-flex;
      align-items: center; gap: 8px;
    }
    .btn-primary { background: var(--accent); color: #ffffff; }
    .btn-primary:hover { opacity: 0.9; transform: translateY(-1px); }
    .btn-primary:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }
    .btn-secondary { background: var(--card-hover); color: var(--text); border: 1px solid var(--border); }
    .btn-secondary:hover { background: var(--border); }
    .btn-danger { background: var(--hot); color: #fff; }
    .btn-danger:hover { opacity: 0.9; }
    .btn-sm { padding: 6px 14px; font-size: 0.8rem; }
    .btn-group { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; }

    /* Drag & Drop Upload */
    .drop-zone {
      border: 2px dashed var(--border); border-radius: 12px; padding: 48px 24px;
      text-align: center; cursor: pointer; transition: all 0.3s;
      background: var(--card);
    }
    .drop-zone:hover, .drop-zone.dragover {
      border-color: var(--accent); background: var(--accent-dim);
    }
    .drop-zone-icon { font-size: 3rem; margin-bottom: 12px; }
    .drop-zone-text { font-size: 0.95rem; color: var(--text); margin-bottom: 4px; }
    .drop-zone-sub { font-size: 0.8rem; color: var(--muted); }
    .drop-zone input[type="file"] { display: none; }
    .file-info {
      display: flex; align-items: center; gap: 12px; padding: 12px 16px;
      background: var(--accent-dim); border-radius: 8px; margin-top: 16px;
      font-size: 0.85rem;
    }
    .file-info .file-name { flex: 1; color: var(--accent); font-weight: 500; }
    .file-info .file-remove { cursor: pointer; color: var(--hot); font-size: 1.1rem; }

    /* Preview Table */
    .preview-wrap {
      overflow-x: auto; margin-top: 16px; border-radius: 8px;
      border: 1px solid var(--border);
    }
    .preview-table {
      width: 100%; border-collapse: collapse; font-size: 0.82rem;
    }
    .preview-table th {
      background: var(--card-hover); color: var(--accent); padding: 10px 12px;
      text-align: left; font-weight: 600; text-transform: uppercase;
      letter-spacing: 0.5px; font-size: 0.72rem; position: sticky; top: 0;
    }
    .preview-table td {
      padding: 8px 12px; border-top: 1px solid var(--border); color: var(--text);
      max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }
    .preview-table tr:hover td { background: var(--card-hover); }
    .preview-table tr.duplicate td { background: rgba(251,191,36,0.08); }
    .preview-table tr.duplicate td:first-child::before { content: '‚ö†Ô∏è '; }

    /* Status badges */
    .badge {
      display: inline-flex; align-items: center; gap: 4px; padding: 3px 10px;
      border-radius: 20px; font-size: 0.72rem; font-weight: 600; text-transform: uppercase;
    }
    .badge-new { background: var(--accent-dim); color: var(--accent); }
    .badge-dup { background: rgba(251,191,36,0.15); color: var(--warn); }
    .badge-ok { background: rgba(52,211,153,0.15); color: var(--success); }
    .badge-err { background: rgba(248,113,113,0.15); color: var(--hot); }
    .badge-geo { background: rgba(167,139,250,0.15); color: var(--purple); }

    /* Geocoding status */
    .geo-status {
      display: flex; align-items: center; gap: 12px; padding: 14px 18px;
      background: var(--card); border: 1px solid var(--border); border-radius: 8px;
      margin-top: 16px; font-size: 0.85rem;
    }
    .geo-progress {
      flex: 1; height: 6px; background: var(--border); border-radius: 3px; overflow: hidden;
    }
    .geo-progress-bar {
      height: 100%; background: var(--accent); border-radius: 3px;
      transition: width 0.3s ease;
    }

    /* Stats row */
    .import-stats {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px; margin-bottom: 20px;
    }
    .import-stat {
      background: var(--card); border: 1px solid var(--border); border-radius: 10px;
      padding: 16px; text-align: center;
    }
    .import-stat-value { font-size: 1.8rem; font-weight: 700; }
    .import-stat-value.accent { color: var(--accent); }
    .import-stat-value.success { color: var(--success); }
    .import-stat-value.warn { color: var(--warn); }
    .import-stat-value.hot { color: var(--hot); }
    .import-stat-label { font-size: 0.72rem; color: var(--muted); margin-top: 4px; text-transform: uppercase; }

    /* Result message */
    .result-msg {
      padding: 16px 20px; border-radius: 8px; margin-top: 16px; font-size: 0.9rem;
      display: none;
    }
    .result-msg.success { display: block; background: rgba(52,211,153,0.12); color: var(--success); border: 1px solid rgba(52,211,153,0.3); }
    .result-msg.error { display: block; background: rgba(248,113,113,0.12); color: var(--hot); border: 1px solid rgba(248,113,113,0.3); }

    /* Template download */
    .template-link {
      display: inline-flex; align-items: center; gap: 6px; color: var(--accent);
      text-decoration: none; font-size: 0.85rem; margin-top: 8px;
    }
    .template-link:hover { text-decoration: underline; }

    /* Scrollable table container */
    .preview-container { max-height: 400px; overflow-y: auto; }
    .preview-container::-webkit-scrollbar { width: 6px; }
    .preview-container::-webkit-scrollbar-track { background: var(--bg); }
    .preview-container::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

    /* Toast */
    .toast {
      position: fixed; bottom: 24px; right: 24px; padding: 14px 24px;
      background: var(--card); border: 1px solid var(--border); border-radius: 10px;
      color: var(--text); font-size: 0.85rem; z-index: 10000;
      box-shadow: 0 8px 32px rgba(0,0,0,0.4); transform: translateY(100px);
      opacity: 0; transition: all 0.3s ease;
    }
    .toast.show { transform: translateY(0); opacity: 1; }

    @media (max-width: 768px) {
      .app { padding: 12px; }
      .form-grid { grid-template-columns: 1fr; }
      .header h1 { font-size: 1.2rem; }
      .tabs { overflow-x: auto; }
      .tab { padding: 10px 16px; font-size: 0.82rem; white-space: nowrap; }
      .import-stats { grid-template-columns: repeat(2, 1fr); }
      .drop-zone { padding: 32px 16px; }
      .preview-table { font-size: 0.75rem; }
    }
  </style>
</head>
<body>
  <script src="/nav.js"></script>
  <div class="app">
    <div class="header">
      <div>
        <h1>üì• Lead Import Tool</h1>
        <div class="header-sub">Bulk import prospects via CSV or add leads manually</div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab active" data-tab="csv">üìÅ CSV Import</button>
      <button class="tab" data-tab="manual">‚úèÔ∏è Manual Entry</button>
    </div>

    <!-- CSV Import Tab -->
    <div id="tab-csv" class="tab-panel active">
      <div class="card">
        <h2>Upload CSV File</h2>
        <p style="color: var(--muted); font-size: 0.85rem; margin-bottom: 16px;">
          Upload a CSV with columns: <code style="color: var(--accent);">name, address, phone, email, property_type, notes</code>
        </p>

        <div class="drop-zone" id="dropZone">
          <div class="drop-zone-icon">üìÑ</div>
          <div class="drop-zone-text">Drag & drop your CSV file here</div>
          <div class="drop-zone-sub">or click to browse ‚Ä¢ max 10MB</div>
          <input type="file" id="fileInput" accept=".csv,text/csv">
        </div>
        <div id="fileInfo" class="file-info" style="display: none;">
          <span>üìé</span>
          <span class="file-name" id="fileName"></span>
          <span class="file-remove" id="fileRemove" title="Remove file">‚úï</span>
        </div>

        <a href="#" class="template-link" id="downloadTemplate">‚¨áÔ∏è Download CSV template</a>
      </div>

      <!-- Preview Section (hidden until file parsed) -->
      <div id="previewSection" style="display: none;">
        <div class="import-stats" id="importStats"></div>

        <div class="card">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; flex-wrap: wrap; gap: 8px;">
            <h2>Import Preview</h2>
            <div style="display: flex; gap: 8px; align-items: center;">
              <label style="font-size: 0.8rem; color: var(--muted); display: flex; align-items: center; gap: 6px;">
                <input type="checkbox" id="skipDuplicates" checked> Skip duplicates
              </label>
              <label style="font-size: 0.8rem; color: var(--muted); display: flex; align-items: center; gap: 6px;">
                <input type="checkbox" id="geocodeOnImport" checked> Geocode addresses
              </label>
            </div>
          </div>

          <div class="preview-container">
            <div class="preview-wrap">
              <table class="preview-table" id="previewTable">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Address</th>
                    <th>Phone</th>
                    <th>Email</th>
                    <th>Type</th>
                    <th>Notes</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody id="previewBody"></tbody>
              </table>
            </div>
          </div>

          <div id="geoStatus" class="geo-status" style="display: none;">
            <span id="geoLabel">Geocoding...</span>
            <div class="geo-progress"><div class="geo-progress-bar" id="geoBar" style="width: 0%"></div></div>
            <span id="geoCount">0/0</span>
          </div>

          <div class="btn-group">
            <button class="btn btn-primary" id="importBtn" disabled>
              üì• Import Leads
            </button>
            <button class="btn btn-secondary" id="clearBtn">üóëÔ∏è Clear</button>
          </div>
        </div>

        <div id="resultMsg" class="result-msg"></div>
      </div>
    </div>

    <!-- Manual Entry Tab -->
    <div id="tab-manual" class="tab-panel">
      <div class="card">
        <h2>Add New Lead</h2>
        <form id="manualForm">
          <div class="form-grid">
            <div class="form-group">
              <label>Property Name *</label>
              <input type="text" id="m_name" required placeholder="e.g. Desert Oasis Apartments">
            </div>
            <div class="form-group">
              <label>Property Type</label>
              <select id="m_property_type">
                <option value="">Select type...</option>
                <option value="apartments">Apartments</option>
                <option value="senior_living">Senior Living</option>
                <option value="healthcare">Healthcare</option>
                <option value="industrial">Industrial</option>
                <option value="office">Office</option>
                <option value="hotel">Hotel</option>
                <option value="retail">Retail</option>
                <option value="other">Other</option>
              </select>
            </div>
            <div class="form-group full">
              <label>Address</label>
              <input type="text" id="m_address" placeholder="e.g. 1234 S Las Vegas Blvd, Las Vegas, NV 89104">
            </div>
            <div class="form-group">
              <label>Phone</label>
              <input type="tel" id="m_phone" placeholder="(702) 555-0123">
            </div>
            <div class="form-group">
              <label>Email</label>
              <input type="email" id="m_email" placeholder="manager@property.com">
            </div>
            <div class="form-group full">
              <label>Notes</label>
              <textarea id="m_notes" placeholder="Any notes about this lead..."></textarea>
            </div>
          </div>
          <div class="btn-group">
            <button type="submit" class="btn btn-primary">‚ûï Add Lead</button>
            <button type="reset" class="btn btn-secondary">Clear Form</button>
          </div>
        </form>
        <div id="manualResult" class="result-msg"></div>
      </div>

      <!-- Recent Imports -->
      <div class="card" id="recentCard">
        <h2>Recently Added</h2>
        <div id="recentList" style="color: var(--muted); font-size: 0.85rem;">
          Leads you add will appear here.
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <script>
    // ===== State =====
    let parsedLeads = [];
    let existingProspects = [];
    let recentlyAdded = [];

    // ===== Tab Switching =====
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
      });
    });

    // ===== Load Existing Prospects (for duplicate detection) =====
    async function loadExisting() {
      try {
        const res = await fetch('/api/prospects');
        existingProspects = await res.json();
      } catch (e) {
        console.error('Failed to load prospects:', e);
      }
    }
    loadExisting();

    // ===== CSV Template Download =====
    document.getElementById('downloadTemplate').addEventListener('click', (e) => {
      e.preventDefault();
      const csv = 'name,address,phone,email,property_type,notes\n' +
        '"Desert Oasis Apartments","1234 S Las Vegas Blvd, Las Vegas, NV 89104","(702) 555-0100","mgr@desertoasis.com","apartments","200 units, pool area"\n' +
        '"Sunrise Senior Living","5678 W Sahara Ave, Las Vegas, NV 89146","(702) 555-0200","info@sunrisesenior.com","senior_living","Memory care wing"\n';
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'lead-import-template.csv'; a.click();
      URL.revokeObjectURL(url);
      showToast('Template downloaded!');
    });

    // ===== Drag & Drop =====
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');

    dropZone.addEventListener('click', () => fileInput.click());
    dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('dragover');
      const file = e.dataTransfer.files[0];
      if (file) handleFile(file);
    });
    fileInput.addEventListener('change', (e) => {
      if (e.target.files[0]) handleFile(e.target.files[0]);
    });

    document.getElementById('fileRemove').addEventListener('click', () => {
      clearFile();
    });

    function handleFile(file) {
      if (!file.name.toLowerCase().endsWith('.csv')) {
        showToast('Please upload a CSV file', 'error');
        return;
      }
      if (file.size > 10 * 1024 * 1024) {
        showToast('File too large (max 10MB)', 'error');
        return;
      }
      document.getElementById('fileInfo').style.display = 'flex';
      document.getElementById('fileName').textContent = `${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
      
      const reader = new FileReader();
      reader.onload = (e) => parseCSV(e.target.result);
      reader.readAsText(file);
    }

    function clearFile() {
      fileInput.value = '';
      document.getElementById('fileInfo').style.display = 'none';
      document.getElementById('previewSection').style.display = 'none';
      parsedLeads = [];
    }

    // ===== CSV Parser =====
    function parseCSV(text) {
      const lines = text.split(/\r?\n/).filter(l => l.trim());
      if (lines.length < 2) {
        showToast('CSV must have a header row and at least one data row', 'error');
        return;
      }

      const headers = parseCSVLine(lines[0]).map(h => h.trim().toLowerCase().replace(/[^a-z_]/g, ''));
      const headerMap = {};
      const knownHeaders = ['name', 'address', 'phone', 'email', 'property_type', 'notes'];
      
      // Flexible header matching
      headers.forEach((h, i) => {
        if (h.includes('name') && !h.includes('type')) headerMap.name = i;
        else if (h.includes('address') || h.includes('addr') || h.includes('location')) headerMap.address = i;
        else if (h.includes('phone') || h.includes('tel')) headerMap.phone = i;
        else if (h.includes('email') || h.includes('mail')) headerMap.email = i;
        else if (h.includes('type') || h.includes('property') || h.includes('category')) headerMap.property_type = i;
        else if (h.includes('note') || h.includes('comment') || h.includes('desc')) headerMap.notes = i;
      });

      if (headerMap.name === undefined) {
        // Fallback: assume first 6 columns match CSV format
        knownHeaders.forEach((h, i) => { if (i < headers.length) headerMap[h] = i; });
      }

      parsedLeads = [];
      for (let i = 1; i < lines.length; i++) {
        const vals = parseCSVLine(lines[i]);
        if (vals.every(v => !v.trim())) continue; // skip empty rows

        const lead = {
          name: (vals[headerMap.name] || '').trim(),
          address: (vals[headerMap.address] || '').trim(),
          phone: (vals[headerMap.phone] || '').trim(),
          email: (vals[headerMap.email] || '').trim(),
          property_type: normalizePropertyType((vals[headerMap.property_type] || '').trim()),
          notes: (vals[headerMap.notes] || '').trim(),
          _row: i + 1,
          _duplicate: false,
          _dupReason: '',
          _geocoded: false,
          _lat: null,
          _lng: null
        };

        if (!lead.name && !lead.address) continue; // skip completely empty entries

        // Duplicate detection
        const dup = findDuplicate(lead);
        if (dup) {
          lead._duplicate = true;
          lead._dupReason = dup;
        }

        parsedLeads.push(lead);
      }

      renderPreview();
    }

    function parseCSVLine(line) {
      const result = [];
      let current = '';
      let inQuotes = false;
      for (let i = 0; i < line.length; i++) {
        const ch = line[i];
        if (inQuotes) {
          if (ch === '"' && line[i + 1] === '"') { current += '"'; i++; }
          else if (ch === '"') inQuotes = false;
          else current += ch;
        } else {
          if (ch === '"') inQuotes = true;
          else if (ch === ',') { result.push(current); current = ''; }
          else current += ch;
        }
      }
      result.push(current);
      return result;
    }

    function normalizePropertyType(type) {
      const t = type.toLowerCase().replace(/[\s-]+/g, '_');
      const map = {
        'apartment': 'apartments', 'apartments': 'apartments', 'apt': 'apartments',
        'senior': 'senior_living', 'senior_living': 'senior_living', 'assisted': 'senior_living',
        'healthcare': 'healthcare', 'medical': 'healthcare', 'hospital': 'healthcare', 'clinic': 'healthcare',
        'industrial': 'industrial', 'warehouse': 'industrial', 'factory': 'industrial',
        'office': 'office', 'commercial': 'office',
        'hotel': 'hotel', 'motel': 'hotel', 'hospitality': 'hotel',
        'retail': 'retail', 'shopping': 'retail', 'mall': 'retail'
      };
      return map[t] || type || '';
    }

    function findDuplicate(lead) {
      // Check against existing prospects
      for (const p of existingProspects) {
        if (lead.address && p.address && normalizeAddr(lead.address) === normalizeAddr(p.address))
          return `Address matches existing: "${p.name}"`;
        if (lead.name && p.name && lead.name.toLowerCase() === p.name.toLowerCase())
          return `Name matches existing: "${p.name}"`;
      }
      // Check within parsed batch
      for (const other of parsedLeads) {
        if (other === lead) continue;
        if (lead.address && other.address && normalizeAddr(lead.address) === normalizeAddr(other.address))
          return `Duplicate address in CSV (row ${other._row})`;
        if (lead.name && other.name && lead.name.toLowerCase() === other.name.toLowerCase())
          return `Duplicate name in CSV (row ${other._row})`;
      }
      return null;
    }

    function normalizeAddr(addr) {
      return addr.toLowerCase().replace(/[.,#\-]/g, '').replace(/\s+/g, ' ').trim();
    }

    // ===== Render Preview =====
    function renderPreview() {
      document.getElementById('previewSection').style.display = 'block';
      const body = document.getElementById('previewBody');
      body.innerHTML = '';

      const total = parsedLeads.length;
      const dups = parsedLeads.filter(l => l._duplicate).length;
      const newLeads = total - dups;
      const withAddress = parsedLeads.filter(l => l.address).length;

      document.getElementById('importStats').innerHTML = `
        <div class="import-stat">
          <div class="import-stat-value accent">${total}</div>
          <div class="import-stat-label">Total Rows</div>
        </div>
        <div class="import-stat">
          <div class="import-stat-value success">${newLeads}</div>
          <div class="import-stat-label">New Leads</div>
        </div>
        <div class="import-stat">
          <div class="import-stat-value warn">${dups}</div>
          <div class="import-stat-label">Duplicates</div>
        </div>
        <div class="import-stat">
          <div class="import-stat-value" style="color: var(--purple)">${withAddress}</div>
          <div class="import-stat-label">With Address</div>
        </div>
      `;

      parsedLeads.forEach((lead, i) => {
        const tr = document.createElement('tr');
        if (lead._duplicate) tr.classList.add('duplicate');
        
        const typeLabel = lead.property_type ? lead.property_type.replace(/_/g, ' ') : '-';
        const statusBadge = lead._duplicate
          ? `<span class="badge badge-dup" title="${lead._dupReason}">Duplicate</span>`
          : '<span class="badge badge-new">New</span>';

        tr.innerHTML = `
          <td>${escHtml(lead.name || '-')}</td>
          <td>${escHtml(lead.address || '-')}</td>
          <td>${escHtml(lead.phone || '-')}</td>
          <td>${escHtml(lead.email || '-')}</td>
          <td style="text-transform: capitalize">${escHtml(typeLabel)}</td>
          <td>${escHtml(lead.notes || '-')}</td>
          <td>${statusBadge}</td>
        `;
        body.appendChild(tr);
      });

      const importBtn = document.getElementById('importBtn');
      importBtn.disabled = newLeads === 0;
      importBtn.textContent = `üì• Import ${newLeads} Lead${newLeads !== 1 ? 's' : ''}`;
    }

    // ===== Import =====
    document.getElementById('importBtn').addEventListener('click', async () => {
      const skipDups = document.getElementById('skipDuplicates').checked;
      const doGeocode = document.getElementById('geocodeOnImport').checked;
      
      let leadsToImport = skipDups
        ? parsedLeads.filter(l => !l._duplicate)
        : [...parsedLeads];

      if (leadsToImport.length === 0) {
        showToast('No leads to import', 'error');
        return;
      }

      const importBtn = document.getElementById('importBtn');
      importBtn.disabled = true;
      importBtn.textContent = '‚è≥ Importing...';

      try {
        const res = await fetch('/api/prospects/import', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            leads: leadsToImport.map(l => ({
              name: l.name,
              address: l.address,
              phone: l.phone,
              email: l.email,
              property_type: l.property_type,
              notes: l.notes
            })),
            geocode: doGeocode
          })
        });

        const result = await res.json();
        
        if (result.error) throw new Error(result.error);

        const msg = document.getElementById('resultMsg');
        msg.className = 'result-msg success';
        msg.innerHTML = `
          ‚úÖ Successfully imported <strong>${result.imported}</strong> lead${result.imported !== 1 ? 's' : ''}
          ${result.duplicatesSkipped ? ` ‚Ä¢ ${result.duplicatesSkipped} duplicates skipped` : ''}
          ${result.geocoded ? ` ‚Ä¢ ${result.geocoded} addresses geocoded` : ''}
          <br><a href="/crm" style="color: var(--accent);">View in Sales CRM ‚Üí</a>
        `;

        showToast(`${result.imported} leads imported!`);
        
        // Refresh existing prospects list
        await loadExisting();

        importBtn.textContent = '‚úÖ Done!';
        setTimeout(() => { importBtn.textContent = 'üì• Import Leads'; importBtn.disabled = false; }, 2000);

      } catch (e) {
        const msg = document.getElementById('resultMsg');
        msg.className = 'result-msg error';
        msg.textContent = `‚ùå Import failed: ${e.message}`;
        importBtn.disabled = false;
        importBtn.textContent = 'üì• Import Leads';
      }
    });

    document.getElementById('clearBtn').addEventListener('click', clearFile);

    // ===== Manual Entry =====
    document.getElementById('manualForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const lead = {
        name: document.getElementById('m_name').value.trim(),
        address: document.getElementById('m_address').value.trim(),
        phone: document.getElementById('m_phone').value.trim(),
        email: document.getElementById('m_email').value.trim(),
        property_type: document.getElementById('m_property_type').value,
        notes: document.getElementById('m_notes').value.trim()
      };

      if (!lead.name) {
        showToast('Property name is required', 'error');
        return;
      }

      // Check for duplicates
      const dup = existingProspects.find(p =>
        (lead.address && p.address && normalizeAddr(lead.address) === normalizeAddr(p.address)) ||
        (lead.name && p.name && lead.name.toLowerCase() === p.name.toLowerCase())
      );
      
      if (dup && !confirm(`‚ö†Ô∏è Possible duplicate of "${dup.name}". Import anyway?`)) return;

      try {
        const res = await fetch('/api/prospects/import', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ leads: [lead], geocode: true })
        });

        const result = await res.json();
        if (result.error) throw new Error(result.error);

        const msg = document.getElementById('manualResult');
        msg.className = 'result-msg success';
        msg.innerHTML = `‚úÖ Added "<strong>${lead.name}</strong>" 
          ${result.geocoded ? '‚Ä¢ üìç Geocoded' : ''}
          <a href="/crm" style="color: var(--accent); margin-left: 8px;">View in CRM ‚Üí</a>`;

        // Add to recently added
        recentlyAdded.unshift(lead);
        renderRecent();

        // Refresh existing prospects
        await loadExisting();

        // Reset form
        document.getElementById('manualForm').reset();
        showToast(`"${lead.name}" added!`);

      } catch (e) {
        const msg = document.getElementById('manualResult');
        msg.className = 'result-msg error';
        msg.textContent = `‚ùå Failed: ${e.message}`;
      }
    });

    function renderRecent() {
      const el = document.getElementById('recentList');
      if (recentlyAdded.length === 0) {
        el.innerHTML = 'Leads you add will appear here.';
        return;
      }
      el.innerHTML = recentlyAdded.slice(0, 10).map(l => `
        <div style="padding: 10px 0; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
          <div>
            <strong>${escHtml(l.name)}</strong>
            <span style="color: var(--muted); margin-left: 8px; font-size: 0.8rem;">${escHtml(l.property_type || '-')}</span>
          </div>
          <span style="color: var(--muted); font-size: 0.8rem;">${escHtml(l.address || 'No address')}</span>
        </div>
      `).join('');
    }

    // ===== Utilities =====
    function escHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function showToast(msg, type = 'info') {
      const toast = document.getElementById('toast');
      toast.textContent = msg;
      toast.style.borderColor = type === 'error' ? 'var(--hot)' : 'var(--accent)';
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }
  </script>
</body>
</html>
