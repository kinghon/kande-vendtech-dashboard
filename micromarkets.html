<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-vend-32.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-vend.png">
  <title>Micro-Markets ‚Äî Kande VendTech</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg: #f5f7fa; --bg2: #edf2f7; --card: #ffffff; --card-hover: #f7fafc;
      --border: #e2e8f0; --border-light: #cbd5e0;
      --text: #1a202c; --muted: #718096; --dim: #a0aec0;
      --accent: #3182ce; --accent-dim: rgba(49,130,206,0.1); --accent-glow: rgba(49,130,206,0.15);
      --hot: #e53e3e; --hot-dim: rgba(229,62,62,0.1);
      --warn: #dd6b20; --warn-dim: rgba(221,107,32,0.1);
      --success: #38a169; --success-dim: rgba(56,161,105,0.1);
      --purple: #7b2cbf; --purple-dim: rgba(123,44,191,0.1);
    }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }
    .app { max-width: 1400px; margin: 0 auto; padding: 20px; }

    /* Header */
    .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 28px; flex-wrap: wrap; gap: 16px; }
    .page-header h1 { font-size: 1.8rem; font-weight: 700; background: linear-gradient(90deg, var(--accent), var(--purple)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; display: flex; align-items: center; gap: 12px; }
    .header-actions { display: flex; gap: 10px; flex-wrap: wrap; }

    /* Buttons */
    .btn { padding: 10px 20px; border-radius: 10px; border: 1px solid var(--border); background: var(--card); color: var(--text); font-size: 0.85rem; font-weight: 500; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 6px; }
    .btn:hover { border-color: var(--accent); color: var(--accent); }
    .btn-primary { background: var(--accent); color: #000; border-color: var(--accent); font-weight: 600; }
    .btn-primary:hover { background: #2b6cb0; box-shadow: 0 0 20px var(--accent-glow); }
    .btn-danger { color: var(--hot); border-color: var(--hot); }
    .btn-danger:hover { background: var(--hot); color: white; }
    .btn-sm { padding: 6px 12px; font-size: 0.78rem; border-radius: 8px; }
    .btn-ghost { background: transparent; border: none; color: var(--muted); }
    .btn-ghost:hover { color: var(--accent); }

    /* Stats Row */
    .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 14px; margin-bottom: 28px; }
    .stat-card { background: var(--card); border-radius: 14px; padding: 20px; border: 1px solid var(--border); transition: all 0.2s; }
    .stat-card:hover { border-color: var(--border-light); transform: translateY(-1px); }
    .stat-card .stat-label { font-size: 0.72rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; margin-bottom: 8px; }
    .stat-card .stat-value { font-size: 2rem; font-weight: 700; }
    .stat-card .stat-sub { font-size: 0.78rem; color: var(--dim); margin-top: 4px; }
    .stat-value.accent { color: var(--accent); }
    .stat-value.success { color: var(--success); }
    .stat-value.warn { color: var(--warn); }
    .stat-value.hot { color: var(--hot); }

    /* Tabs */
    .tabs { display: flex; gap: 4px; margin-bottom: 24px; border-bottom: 2px solid var(--border); overflow-x: auto; }
    .tab { padding: 12px 20px; font-size: 0.88rem; font-weight: 500; color: var(--muted); background: none; border: none; cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -2px; transition: all 0.2s; white-space: nowrap; }
    .tab:hover { color: var(--text); }
    .tab.active { color: var(--accent); border-bottom-color: var(--accent); }
    .tab .tab-badge { display: inline-flex; align-items: center; justify-content: center; min-width: 18px; height: 18px; padding: 0 5px; border-radius: 9px; font-size: 0.65rem; font-weight: 700; margin-left: 6px; }
    .tab-badge.info { background: var(--accent-dim); color: var(--accent); }

    /* Tab Content */
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* Search & Filter */
    .filter-bar { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
    .filter-bar input, .filter-bar select { padding: 9px 14px; border-radius: 10px; border: 1px solid var(--border); background: var(--card); color: var(--text); font-size: 0.85rem; font-family: inherit; }
    .filter-bar input { flex: 1; min-width: 200px; }
    .filter-bar input:focus, .filter-bar select:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-dim); }
    .filter-bar select { min-width: 140px; }

    /* Card Grid */
    .mm-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(360px, 1fr)); gap: 16px; }
    .mm-card { background: var(--card); border-radius: 14px; padding: 22px; border: 1px solid var(--border); transition: all 0.2s; cursor: pointer; position: relative; overflow: hidden; }
    .mm-card:hover { border-color: var(--accent); transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0,0,0,0.3); }
    .mm-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; }
    .mm-card.type-full::before { background: linear-gradient(90deg, var(--accent), var(--success)); }
    .mm-card.type-self::before { background: linear-gradient(90deg, var(--purple), var(--accent)); }
    .mm-card.type-hybrid::before { background: linear-gradient(90deg, var(--warn), var(--accent)); }

    .mm-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 14px; }
    .mm-name { font-size: 1.05rem; font-weight: 600; color: var(--text); }
    .mm-badge { padding: 3px 10px; border-radius: 8px; font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; }
    .badge-full { background: var(--success-dim); color: var(--success); }
    .badge-self { background: var(--purple-dim); color: var(--purple); }
    .badge-hybrid { background: var(--warn-dim); color: var(--warn); }

    .mm-details { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 14px; }
    .mm-detail { display: flex; flex-direction: column; }
    .mm-detail-label { font-size: 0.7rem; color: var(--dim); text-transform: uppercase; letter-spacing: 0.3px; font-weight: 600; margin-bottom: 2px; }
    .mm-detail-value { font-size: 0.88rem; color: var(--text); }

    .mm-equipment { display: flex; gap: 12px; padding: 12px; background: var(--bg2); border-radius: 10px; margin-bottom: 12px; }
    .mm-equip-item { flex: 1; text-align: center; }
    .mm-equip-value { font-size: 1.6rem; font-weight: 700; color: var(--accent); }
    .mm-equip-label { font-size: 0.7rem; color: var(--muted); margin-top: 2px; }

    .mm-categories { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 12px; }
    .mm-cat-tag { padding: 3px 10px; border-radius: 20px; font-size: 0.68rem; font-weight: 600; background: var(--accent-dim); color: var(--accent); }
    .mm-cat-tag.fresh { background: var(--success-dim); color: var(--success); }

    .mm-footer { display: flex; justify-content: space-between; align-items: center; padding-top: 12px; border-top: 1px solid var(--border); }
    .mm-revenue-target { font-size: 0.82rem; font-weight: 600; color: var(--success); }
    .mm-launch { font-size: 0.78rem; color: var(--muted); }
    .mm-actions { display: flex; gap: 4px; }

    /* Table */
    .table-wrap { overflow-x: auto; background: var(--card); border-radius: 14px; border: 1px solid var(--border); }
    table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
    th { text-align: left; padding: 14px 16px; font-weight: 600; color: var(--muted); border-bottom: 2px solid var(--border); font-size: 0.72rem; text-transform: uppercase; letter-spacing: 0.5px; cursor: pointer; user-select: none; white-space: nowrap; }
    th:hover { color: var(--accent); }
    td { padding: 12px 16px; border-bottom: 1px solid var(--border); }
    tr:hover { background: rgba(49,130,206,0.04); }
    tr:last-child td { border-bottom: none; }

    /* Inventory Overview */
    .inv-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 16px; }
    .inv-card { background: var(--card); border-radius: 14px; padding: 22px; border: 1px solid var(--border); text-align: center; }
    .inv-card:hover { border-color: var(--accent); }
    .inv-icon { font-size: 2.5rem; margin-bottom: 10px; }
    .inv-title { font-size: 1rem; font-weight: 600; margin-bottom: 6px; }
    .inv-desc { font-size: 0.78rem; color: var(--muted); line-height: 1.5; }
    .inv-count { font-size: 1.8rem; font-weight: 700; color: var(--accent); margin-top: 10px; }

    /* Modal */
    .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); z-index: 1000; justify-content: center; align-items: flex-start; padding: 60px 20px; overflow-y: auto; }
    .modal-overlay.show { display: flex; }
    .modal { background: var(--card); border-radius: 16px; padding: 28px; width: 100%; max-width: 640px; border: 1px solid var(--border); box-shadow: 0 20px 60px rgba(0,0,0,0.5); }
    .modal h2 { font-size: 1.2rem; font-weight: 600; margin-bottom: 24px; display: flex; align-items: center; gap: 10px; }
    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; font-size: 0.75rem; font-weight: 600; color: var(--muted); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.3px; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px 14px; border: 1px solid var(--border); border-radius: 10px; font-size: 0.9rem; font-family: inherit; background: var(--bg); color: var(--text); }
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-dim); }
    .form-group textarea { min-height: 80px; resize: vertical; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
    .form-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 14px; }
    .modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 24px; }

    /* Checkbox row */
    .checkbox-row { display: flex; flex-wrap: wrap; gap: 14px; padding: 8px 0; }
    .checkbox-item { display: flex; align-items: center; gap: 6px; font-size: 0.85rem; }
    .checkbox-item input[type=checkbox] { width: 18px; height: 18px; accent-color: var(--accent); }

    /* Empty */
    .empty-state { text-align: center; padding: 60px 20px; color: var(--muted); }
    .empty-state .empty-icon { font-size: 3rem; margin-bottom: 16px; }
    .empty-state p { font-size: 0.95rem; margin-bottom: 20px; }

    /* Responsive */
    @media (max-width: 768px) {
      .page-header h1 { font-size: 1.3rem; }
      .stats-row { grid-template-columns: repeat(2, 1fr); }
      .mm-grid { grid-template-columns: 1fr; }
      .inv-grid { grid-template-columns: 1fr; }
      .form-row, .form-row-3 { grid-template-columns: 1fr; }
      .mm-details { grid-template-columns: 1fr; }
      .filter-bar { flex-direction: column; }
      .filter-bar input { min-width: unset; }
    }
    @media (max-width: 480px) {
      .stats-row { grid-template-columns: 1fr; }
      .tabs { gap: 0; }
      .tab { padding: 10px 12px; font-size: 0.8rem; }
    }
  </style>
</head>
<body>
<div class="app">

  <!-- Header -->
  <div class="page-header">
    <h1>üè™ Micro-Markets</h1>
    <div class="header-actions">
      <button class="btn btn-primary" onclick="openModal()">+ New Micro-Market</button>
    </div>
  </div>

  <!-- Stats -->
  <div class="stats-row" id="statsRow">
    <div class="stat-card"><div class="stat-label">Total Micro-Markets</div><div class="stat-value accent" id="statTotal">0</div></div>
    <div class="stat-card"><div class="stat-label">Total Shelves</div><div class="stat-value accent" id="statShelves">0</div></div>
    <div class="stat-card"><div class="stat-label">Total Coolers</div><div class="stat-value accent" id="statCoolers">0</div></div>
    <div class="stat-card"><div class="stat-label">Fresh Food Locations</div><div class="stat-value success" id="statFresh">0</div></div>
    <div class="stat-card"><div class="stat-label">Revenue Target (Monthly)</div><div class="stat-value success" id="statRevTarget">$0</div></div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab active" data-tab="cards" onclick="switchTab('cards')">üè™ Markets</button>
    <button class="tab" data-tab="list" onclick="switchTab('list')">üìä List View</button>
    <button class="tab" data-tab="inventory" onclick="switchTab('inventory')">üì¶ Inventory Categories</button>
  </div>

  <!-- Cards Tab -->
  <div class="tab-content active" id="tab-cards">
    <div class="filter-bar">
      <input type="text" id="searchInput" placeholder="Search micro-markets..." oninput="renderCards()">
      <select id="filterType" onchange="renderCards()">
        <option value="">All Setup Types</option>
        <option value="Full Service">Full Service</option>
        <option value="Self-Service">Self-Service</option>
        <option value="Hybrid">Hybrid</option>
      </select>
      <select id="filterPayment" onchange="renderCards()">
        <option value="">All Payment Systems</option>
        <option value="Self-checkout kiosk">Self-checkout kiosk</option>
        <option value="Honor system">Honor system</option>
        <option value="App-based">App-based</option>
      </select>
      <select id="filterFresh" onchange="renderCards()">
        <option value="">Fresh Food: Any</option>
        <option value="yes">Fresh Food: Yes</option>
        <option value="no">Fresh Food: No</option>
      </select>
    </div>
    <div class="mm-grid" id="mmGrid"></div>
  </div>

  <!-- List Tab -->
  <div class="tab-content" id="tab-list">
    <div class="filter-bar">
      <input type="text" id="listSearch" placeholder="Search..." oninput="renderTable()">
    </div>
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Location</th>
            <th>Setup Type</th>
            <th>Shelves</th>
            <th>Coolers</th>
            <th>Payment</th>
            <th>Fresh Food</th>
            <th>Revenue Target</th>
            <th>Launch Date</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="mmTable"></tbody>
      </table>
    </div>
  </div>

  <!-- Inventory Categories Tab -->
  <div class="tab-content" id="tab-inventory">
    <div class="inv-grid" id="invGrid">
      <div class="inv-card">
        <div class="inv-icon">ü•ó</div>
        <div class="inv-title">Fresh Food</div>
        <div class="inv-desc">Sandwiches, salads, wraps, fruit. Requires daily restocking and temperature monitoring.</div>
        <div class="inv-count" id="invFreshCount">0 locations</div>
      </div>
      <div class="inv-card">
        <div class="inv-icon">ü•§</div>
        <div class="inv-title">Beverages</div>
        <div class="inv-desc">Water, soda, juice, energy drinks, coffee. Cooler-dependent inventory.</div>
        <div class="inv-count" id="invBevCount">‚Äî all locations</div>
      </div>
      <div class="inv-card">
        <div class="inv-icon">üçø</div>
        <div class="inv-title">Snacks</div>
        <div class="inv-desc">Chips, candy, crackers, granola bars, nuts. Shelf-stable, high margin.</div>
        <div class="inv-count" id="invSnackCount">‚Äî all locations</div>
      </div>
      <div class="inv-card">
        <div class="inv-icon">üß¥</div>
        <div class="inv-title">Sundries</div>
        <div class="inv-desc">OTC medicine, phone chargers, hygiene products. Convenience impulse buys.</div>
        <div class="inv-count" id="invSundryCount">‚Äî all locations</div>
      </div>
    </div>

    <div style="margin-top: 28px;">
      <h3 style="font-size:1.05rem;font-weight:600;margin-bottom:14px;color:var(--accent);">üìã Stocking Schedule Guide</h3>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Category</th>
              <th>Restock Frequency</th>
              <th>Avg Shelf Life</th>
              <th>Temperature</th>
              <th>Margin Range</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>ü•ó Fresh Food</td>
              <td style="color:var(--hot)">Daily</td>
              <td>1-3 days</td>
              <td>34-40¬∞F</td>
              <td>40-55%</td>
            </tr>
            <tr>
              <td>ü•§ Beverages</td>
              <td style="color:var(--warn)">2-3x / week</td>
              <td>6+ months</td>
              <td>36-45¬∞F</td>
              <td>35-50%</td>
            </tr>
            <tr>
              <td>üçø Snacks</td>
              <td style="color:var(--success)">Weekly</td>
              <td>3-12 months</td>
              <td>Room temp</td>
              <td>40-60%</td>
            </tr>
            <tr>
              <td>üß¥ Sundries</td>
              <td style="color:var(--success)">Bi-weekly</td>
              <td>1+ years</td>
              <td>Room temp</td>
              <td>50-70%</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

</div><!-- /app -->

<!-- Modal: Add/Edit Micro-Market -->
<div class="modal-overlay" id="modal">
  <div class="modal">
    <h2 id="modalTitle">üè™ New Micro-Market</h2>
    <input type="hidden" id="editId">

    <div class="form-group">
      <label>Linked Prospect / Location</label>
      <select id="fProspect">
        <option value="">‚Äî Select signed prospect ‚Äî</option>
      </select>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label>Setup Type</label>
        <select id="fSetupType">
          <option value="Full Service">Full Service</option>
          <option value="Self-Service">Self-Service</option>
          <option value="Hybrid">Hybrid</option>
        </select>
      </div>
      <div class="form-group">
        <label>Payment System</label>
        <select id="fPayment">
          <option value="Self-checkout kiosk">Self-checkout kiosk</option>
          <option value="Honor system">Honor system</option>
          <option value="App-based">App-based</option>
        </select>
      </div>
    </div>

    <div class="form-row-3">
      <div class="form-group">
        <label>Shelf Units</label>
        <input type="number" id="fShelves" min="0" value="0" placeholder="0">
      </div>
      <div class="form-group">
        <label>Cooler Units</label>
        <input type="number" id="fCoolers" min="0" value="0" placeholder="0">
      </div>
      <div class="form-group">
        <label>Monthly Revenue Target ($)</label>
        <input type="number" id="fRevTarget" min="0" step="100" value="0" placeholder="0">
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label>Launch Date</label>
        <input type="date" id="fLaunchDate">
      </div>
      <div class="form-group">
        <label>Fresh Food</label>
        <select id="fFreshFood">
          <option value="no">No</option>
          <option value="yes">Yes ‚Äî requires daily visits</option>
        </select>
      </div>
    </div>

    <div class="form-group">
      <label>Inventory Categories</label>
      <div class="checkbox-row">
        <label class="checkbox-item"><input type="checkbox" id="fCatFresh" value="fresh_food"> ü•ó Fresh Food</label>
        <label class="checkbox-item"><input type="checkbox" id="fCatBev" value="beverages" checked> ü•§ Beverages</label>
        <label class="checkbox-item"><input type="checkbox" id="fCatSnack" value="snacks" checked> üçø Snacks</label>
        <label class="checkbox-item"><input type="checkbox" id="fCatSundry" value="sundries"> üß¥ Sundries</label>
      </div>
    </div>

    <div class="form-group">
      <label>Notes</label>
      <textarea id="fNotes" placeholder="Setup details, special requirements, access info..."></textarea>
    </div>

    <div class="modal-actions">
      <button class="btn" onclick="closeModal()">Cancel</button>
      <button class="btn btn-danger" id="deleteBtn" style="display:none" onclick="deleteMM()">Delete</button>
      <button class="btn btn-primary" onclick="saveMM()">Save Micro-Market</button>
    </div>
  </div>
</div>

<script src="/nav.js"></script>
<script>
(function() {
  'use strict';

  let markets = [];
  let prospects = [];

  // ‚îÄ‚îÄ Load Data ‚îÄ‚îÄ
  async function loadData() {
    const [mmRes, pRes] = await Promise.all([
      fetch('/api/micromarkets'),
      fetch('/api/prospects')
    ]);
    markets = await mmRes.json();
    prospects = await pRes.json();
    populateProspectDropdown();
    updateStats();
    renderCards();
    renderTable();
    updateInventoryCounts();
  }

  function populateProspectDropdown() {
    const sel = document.getElementById('fProspect');
    const signed = prospects.filter(p => p.status === 'signed' || p.status === 'active');
    sel.innerHTML = '<option value="">‚Äî Select prospect/location ‚Äî</option>' +
      signed.map(p => `<option value="${p.id}">${p.name} (${p.property_type || 'N/A'})</option>`).join('');
  }

  // ‚îÄ‚îÄ Stats ‚îÄ‚îÄ
  function updateStats() {
    document.getElementById('statTotal').textContent = markets.length;
    document.getElementById('statShelves').textContent = markets.reduce((s, m) => s + (m.shelving_count || 0), 0);
    document.getElementById('statCoolers').textContent = markets.reduce((s, m) => s + (m.cooler_count || 0), 0);
    document.getElementById('statFresh').textContent = markets.filter(m => m.fresh_food === 'yes').length;
    const totalTarget = markets.reduce((s, m) => s + (m.monthly_revenue_target || 0), 0);
    document.getElementById('statRevTarget').textContent = '$' + totalTarget.toLocaleString();
  }

  // ‚îÄ‚îÄ Inventory Counts ‚îÄ‚îÄ
  function updateInventoryCounts() {
    const freshCount = markets.filter(m => m.fresh_food === 'yes' || (m.inventory_categories || []).includes('fresh_food')).length;
    document.getElementById('invFreshCount').textContent = freshCount + ' location' + (freshCount !== 1 ? 's' : '');
    document.getElementById('invBevCount').textContent = markets.length + ' location' + (markets.length !== 1 ? 's' : '');
    document.getElementById('invSnackCount').textContent = markets.length + ' location' + (markets.length !== 1 ? 's' : '');
    const sundryCount = markets.filter(m => (m.inventory_categories || []).includes('sundries')).length;
    document.getElementById('invSundryCount').textContent = sundryCount + ' location' + (sundryCount !== 1 ? 's' : '');
  }

  // ‚îÄ‚îÄ Filter helpers ‚îÄ‚îÄ
  function getFiltered() {
    const q = (document.getElementById('searchInput')?.value || '').toLowerCase();
    const typeF = document.getElementById('filterType')?.value || '';
    const payF = document.getElementById('filterPayment')?.value || '';
    const freshF = document.getElementById('filterFresh')?.value || '';

    return markets.filter(m => {
      const prospect = prospects.find(p => p.id === m.prospect_id);
      const name = prospect?.name || '';
      const matchQ = !q || name.toLowerCase().includes(q) || (m.notes || '').toLowerCase().includes(q) || (m.setup_type || '').toLowerCase().includes(q);
      const matchType = !typeF || m.setup_type === typeF;
      const matchPay = !payF || m.payment_system === payF;
      const matchFresh = !freshF || m.fresh_food === freshF;
      return matchQ && matchType && matchPay && matchFresh;
    });
  }

  // ‚îÄ‚îÄ Render Cards ‚îÄ‚îÄ
  window.renderCards = function() {
    const filtered = getFiltered();
    const grid = document.getElementById('mmGrid');

    if (filtered.length === 0) {
      grid.innerHTML = `<div class="empty-state" style="grid-column:1/-1"><div class="empty-icon">üè™</div><p>No micro-markets found</p><button class="btn btn-primary" onclick="openModal()">+ Add First Micro-Market</button></div>`;
      return;
    }

    grid.innerHTML = filtered.map(m => {
      const prospect = prospects.find(p => p.id === m.prospect_id);
      const name = prospect?.name || 'Unlinked Location';
      const typeClass = m.setup_type === 'Full Service' ? 'type-full' : m.setup_type === 'Self-Service' ? 'type-self' : 'type-hybrid';
      const badgeClass = m.setup_type === 'Full Service' ? 'badge-full' : m.setup_type === 'Self-Service' ? 'badge-self' : 'badge-hybrid';
      const cats = m.inventory_categories || [];
      const launchStr = m.launch_date ? new Date(m.launch_date + 'T00:00:00').toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : 'TBD';

      return `<div class="mm-card ${typeClass}" onclick="openModal(${m.id})">
        <div class="mm-header">
          <div class="mm-name">${esc(name)}</div>
          <span class="mm-badge ${badgeClass}">${esc(m.setup_type)}</span>
        </div>
        <div class="mm-equipment">
          <div class="mm-equip-item">
            <div class="mm-equip-value">${m.shelving_count || 0}</div>
            <div class="mm-equip-label">Shelves</div>
          </div>
          <div class="mm-equip-item">
            <div class="mm-equip-value">${m.cooler_count || 0}</div>
            <div class="mm-equip-label">Coolers</div>
          </div>
          <div class="mm-equip-item">
            <div class="mm-equip-value" style="font-size:1rem">${esc(m.payment_system || 'N/A')}</div>
            <div class="mm-equip-label">Payment</div>
          </div>
        </div>
        <div class="mm-categories">
          ${cats.includes('fresh_food') ? '<span class="mm-cat-tag fresh">ü•ó Fresh</span>' : ''}
          ${cats.includes('beverages') ? '<span class="mm-cat-tag">ü•§ Bev</span>' : ''}
          ${cats.includes('snacks') ? '<span class="mm-cat-tag">üçø Snacks</span>' : ''}
          ${cats.includes('sundries') ? '<span class="mm-cat-tag">üß¥ Sundries</span>' : ''}
          ${m.fresh_food === 'yes' ? '<span class="mm-cat-tag fresh">‚ö° Daily Restock</span>' : ''}
        </div>
        <div class="mm-footer">
          <div>
            <div class="mm-revenue-target">${m.monthly_revenue_target ? '$' + m.monthly_revenue_target.toLocaleString() + '/mo target' : 'No target set'}</div>
            <div class="mm-launch">Launch: ${launchStr}</div>
          </div>
          <div class="mm-actions">
            <button class="btn btn-sm btn-ghost" onclick="event.stopPropagation();openModal(${m.id})">‚úèÔ∏è</button>
          </div>
        </div>
      </div>`;
    }).join('');
  };

  // ‚îÄ‚îÄ Render Table ‚îÄ‚îÄ
  window.renderTable = function() {
    const q = (document.getElementById('listSearch')?.value || '').toLowerCase();
    const filtered = markets.filter(m => {
      const prospect = prospects.find(p => p.id === m.prospect_id);
      const name = prospect?.name || '';
      return !q || name.toLowerCase().includes(q) || (m.setup_type || '').toLowerCase().includes(q);
    });
    const tbody = document.getElementById('mmTable');
    if (filtered.length === 0) {
      tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;color:var(--muted);padding:40px">No micro-markets found</td></tr>';
      return;
    }
    tbody.innerHTML = filtered.map(m => {
      const prospect = prospects.find(p => p.id === m.prospect_id);
      const name = prospect?.name || 'Unlinked';
      const badgeClass = m.setup_type === 'Full Service' ? 'badge-full' : m.setup_type === 'Self-Service' ? 'badge-self' : 'badge-hybrid';
      const launchStr = m.launch_date || '‚Äî';
      return `<tr>
        <td style="font-weight:600">${esc(name)}</td>
        <td><span class="mm-badge ${badgeClass}">${esc(m.setup_type)}</span></td>
        <td>${m.shelving_count || 0}</td>
        <td>${m.cooler_count || 0}</td>
        <td>${esc(m.payment_system || '‚Äî')}</td>
        <td>${m.fresh_food === 'yes' ? '<span style="color:var(--success)">‚úì Yes</span>' : 'No'}</td>
        <td style="color:var(--success)">${m.monthly_revenue_target ? '$' + m.monthly_revenue_target.toLocaleString() : '‚Äî'}</td>
        <td>${launchStr}</td>
        <td><button class="btn btn-sm" onclick="openModal(${m.id})">Edit</button></td>
      </tr>`;
    }).join('');
  };

  // ‚îÄ‚îÄ Tabs ‚îÄ‚îÄ
  window.switchTab = function(tab) {
    document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tab));
    document.querySelectorAll('.tab-content').forEach(tc => tc.classList.toggle('active', tc.id === 'tab-' + tab));
  };

  // ‚îÄ‚îÄ Modal ‚îÄ‚îÄ
  window.openModal = function(id) {
    const modal = document.getElementById('modal');
    const m = id ? markets.find(x => x.id === id) : null;
    document.getElementById('modalTitle').textContent = m ? '‚úèÔ∏è Edit Micro-Market' : 'üè™ New Micro-Market';
    document.getElementById('editId').value = m ? m.id : '';
    document.getElementById('deleteBtn').style.display = m ? 'inline-flex' : 'none';

    document.getElementById('fProspect').value = m?.prospect_id || '';
    document.getElementById('fSetupType').value = m?.setup_type || 'Full Service';
    document.getElementById('fPayment').value = m?.payment_system || 'Self-checkout kiosk';
    document.getElementById('fShelves').value = m?.shelving_count || 0;
    document.getElementById('fCoolers').value = m?.cooler_count || 0;
    document.getElementById('fRevTarget').value = m?.monthly_revenue_target || 0;
    document.getElementById('fLaunchDate').value = m?.launch_date || '';
    document.getElementById('fFreshFood').value = m?.fresh_food || 'no';
    document.getElementById('fNotes').value = m?.notes || '';

    const cats = m?.inventory_categories || ['beverages', 'snacks'];
    document.getElementById('fCatFresh').checked = cats.includes('fresh_food');
    document.getElementById('fCatBev').checked = cats.includes('beverages');
    document.getElementById('fCatSnack').checked = cats.includes('snacks');
    document.getElementById('fCatSundry').checked = cats.includes('sundries');

    modal.classList.add('show');
  };

  window.closeModal = function() {
    document.getElementById('modal').classList.remove('show');
  };

  // ‚îÄ‚îÄ Save ‚îÄ‚îÄ
  window.saveMM = async function() {
    const id = document.getElementById('editId').value;
    const cats = [];
    if (document.getElementById('fCatFresh').checked) cats.push('fresh_food');
    if (document.getElementById('fCatBev').checked) cats.push('beverages');
    if (document.getElementById('fCatSnack').checked) cats.push('snacks');
    if (document.getElementById('fCatSundry').checked) cats.push('sundries');

    const body = {
      prospect_id: parseInt(document.getElementById('fProspect').value) || null,
      setup_type: document.getElementById('fSetupType').value,
      payment_system: document.getElementById('fPayment').value,
      shelving_count: parseInt(document.getElementById('fShelves').value) || 0,
      cooler_count: parseInt(document.getElementById('fCoolers').value) || 0,
      monthly_revenue_target: parseFloat(document.getElementById('fRevTarget').value) || 0,
      launch_date: document.getElementById('fLaunchDate').value || null,
      fresh_food: document.getElementById('fFreshFood').value,
      inventory_categories: cats,
      notes: document.getElementById('fNotes').value
    };

    const url = id ? '/api/micromarkets/' + id : '/api/micromarkets';
    const method = id ? 'PUT' : 'POST';

    await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
    closeModal();
    loadData();
  };

  // ‚îÄ‚îÄ Delete ‚îÄ‚îÄ
  window.deleteMM = async function() {
    const id = document.getElementById('editId').value;
    if (!id || !confirm('Delete this micro-market?')) return;
    await fetch('/api/micromarkets/' + id, { method: 'DELETE' });
    closeModal();
    loadData();
  };

  // ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ
  function esc(s) { const d = document.createElement('div'); d.textContent = s || ''; return d.innerHTML; }

  // close modal on overlay click
  document.getElementById('modal').addEventListener('click', function(e) {
    if (e.target === this) closeModal();
  });

  // ‚îÄ‚îÄ Init ‚îÄ‚îÄ
  loadData();
})();
</script>
</body>
</html>
