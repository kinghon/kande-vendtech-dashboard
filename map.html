<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Territory Map | Kande VendTech</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; height: 100vh; overflow: hidden; }
    
    /* Layout */
    .container { display: flex; height: 100vh; }
    #map { flex: 1; height: 100%; z-index: 1; }
    
    /* Sidebar */
    .sidebar { width: 320px; background: #1a1a2e; color: #fff; display: flex; flex-direction: column; transition: margin-left 0.3s; z-index: 1000; }
    .sidebar.collapsed { margin-left: -280px; }
    .sidebar-toggle { position: absolute; right: -40px; top: 10px; width: 40px; height: 40px; background: #1a1a2e; border: none; color: #fff; cursor: pointer; border-radius: 0 8px 8px 0; font-size: 18px; }
    .sidebar-header { padding: 16px; background: #16213e; border-bottom: 1px solid #0f3460; }
    .sidebar-header h1 { font-size: 18px; margin-bottom: 4px; }
    .sidebar-header p { font-size: 12px; color: #8892b0; }
    .sidebar-content { flex: 1; overflow-y: auto; padding: 16px; }
    
    /* Filters */
    .filter-section { margin-bottom: 20px; }
    .filter-section h3 { font-size: 12px; text-transform: uppercase; color: #8892b0; margin-bottom: 10px; letter-spacing: 1px; }
    .filter-group { display: flex; flex-wrap: wrap; gap: 6px; }
    .filter-btn { padding: 6px 12px; border: 1px solid #0f3460; background: transparent; color: #ccd6f6; border-radius: 16px; cursor: pointer; font-size: 12px; transition: all 0.2s; }
    .filter-btn:hover { border-color: #64ffda; }
    .filter-btn.active { background: #64ffda; color: #0a192f; border-color: #64ffda; }
    .filter-btn .count { margin-left: 4px; opacity: 0.7; }
    
    /* Legend */
    .legend { margin-bottom: 20px; }
    .legend-item { display: flex; align-items: center; gap: 8px; padding: 6px 0; font-size: 13px; }
    .legend-dot { width: 16px; height: 16px; border-radius: 50%; }
    .legend-dot.signed { background: #22c55e; }
    .legend-dot.hot { background: #ef4444; }
    .legend-dot.warm { background: #f59e0b; }
    .legend-dot.new { background: #3b82f6; }
    .legend-dot.lost { background: #6b7280; }
    .legend-dot.machine { background: #8b5cf6; border: 2px solid #fff; }
    
    /* Stats Panel */
    .stats-panel { background: #16213e; border-radius: 8px; padding: 12px; margin-bottom: 20px; }
    .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
    .stat-item { text-align: center; }
    .stat-value { font-size: 24px; font-weight: bold; color: #64ffda; }
    .stat-label { font-size: 11px; color: #8892b0; text-transform: uppercase; }
    
    /* Route Panel */
    .route-panel { background: #16213e; border-radius: 8px; padding: 12px; margin-top: auto; }
    .route-panel h3 { font-size: 14px; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
    .route-list { max-height: 150px; overflow-y: auto; }
    .route-item { display: flex; align-items: center; gap: 8px; padding: 6px; background: #0f3460; border-radius: 4px; margin-bottom: 4px; font-size: 12px; }
    .route-item .num { width: 20px; height: 20px; background: #64ffda; color: #0a192f; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0; }
    .route-item .name { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .route-item .remove { background: none; border: none; color: #ef4444; cursor: pointer; padding: 2px; }
    .route-info { font-size: 12px; color: #8892b0; margin: 10px 0; }
    .route-actions { display: flex; gap: 8px; }
    .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 500; transition: all 0.2s; }
    .btn-primary { background: #64ffda; color: #0a192f; }
    .btn-primary:hover { background: #4fd1c5; }
    .btn-secondary { background: #0f3460; color: #ccd6f6; }
    .btn-secondary:hover { background: #1a4a6e; }
    .btn-danger { background: #ef4444; color: #fff; }
    .btn-danger:hover { background: #dc2626; }
    
    /* Heatmap Toggle */
    .view-toggles { display: flex; gap: 8px; margin-bottom: 16px; }
    .view-toggle { flex: 1; padding: 10px; border: 1px solid #0f3460; background: transparent; color: #ccd6f6; border-radius: 6px; cursor: pointer; font-size: 12px; text-align: center; }
    .view-toggle.active { background: #0f3460; border-color: #64ffda; }
    
    /* Popup Styles */
    .leaflet-popup-content-wrapper { background: #1a1a2e; color: #fff; border-radius: 8px; }
    .leaflet-popup-tip { background: #1a1a2e; }
    .popup-content { min-width: 220px; }
    .popup-header { border-bottom: 1px solid #0f3460; padding-bottom: 8px; margin-bottom: 8px; }
    .popup-name { font-size: 16px; font-weight: bold; margin-bottom: 4px; }
    .popup-address { font-size: 12px; color: #8892b0; }
    .popup-meta { font-size: 12px; margin-bottom: 8px; }
    .popup-meta span { display: inline-block; padding: 2px 8px; border-radius: 12px; margin-right: 4px; margin-bottom: 4px; }
    .popup-meta .status-signed { background: #166534; }
    .popup-meta .status-hot { background: #991b1b; }
    .popup-meta .status-warm { background: #92400e; }
    .popup-meta .status-new { background: #1e40af; }
    .popup-meta .status-lost { background: #374151; }
    .popup-stats { display: flex; gap: 16px; margin-bottom: 10px; font-size: 12px; }
    .popup-stat { text-align: center; }
    .popup-stat-value { font-size: 18px; font-weight: bold; color: #64ffda; }
    .popup-stat-label { color: #8892b0; }
    .popup-actions { display: flex; gap: 6px; flex-wrap: wrap; }
    .popup-btn { padding: 6px 10px; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; text-decoration: none; display: inline-flex; align-items: center; gap: 4px; }
    .popup-btn-call { background: #22c55e; color: #fff; }
    .popup-btn-email { background: #3b82f6; color: #fff; }
    .popup-btn-view { background: #8b5cf6; color: #fff; }
    .popup-btn-route { background: #f59e0b; color: #000; }
    
    /* Mobile Responsive */
    @media (max-width: 768px) {
      .sidebar { 
        position: fixed; 
        left: 0; 
        top: 0; 
        bottom: 0; 
        z-index: 1000; 
        width: 85vw;
        max-width: 320px;
        transform: translateX(-100%);
        transition: transform 0.3s ease;
      }
      .sidebar.open { transform: translateX(0); }
      .sidebar.collapsed { margin-left: 0; transform: translateX(-100%); }
      .sidebar-toggle { display: none; }
      
      /* Mobile menu button */
      .mobile-menu-btn {
        display: flex !important;
        position: fixed;
        top: 10px;
        left: 10px;
        z-index: 999;
        width: 50px;
        height: 50px;
        background: #1a1a2e;
        border: 2px solid #64ffda;
        color: #64ffda;
        border-radius: 8px;
        font-size: 24px;
        cursor: pointer;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 10px rgba(0,0,0,0.3);
      }
      
      /* Overlay when sidebar open */
      .sidebar-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
        z-index: 999;
      }
      .sidebar-overlay.active { display: block; }
      
      /* Close button inside sidebar */
      .mobile-close-btn {
        display: block !important;
        position: absolute;
        top: 10px;
        right: 10px;
        width: 36px;
        height: 36px;
        background: #0f3460;
        border: none;
        color: #fff;
        border-radius: 50%;
        font-size: 20px;
        cursor: pointer;
        z-index: 1001;
      }
    }
    
    /* Hide mobile elements on desktop */
    .mobile-menu-btn { display: none; }
    .mobile-close-btn { display: none; }
    .sidebar-overlay { display: none; }
    
    /* Search */
    .search-box { position: relative; margin-bottom: 16px; }
    .search-input { width: 100%; padding: 10px 12px 10px 36px; border: 1px solid #0f3460; background: #0a192f; color: #fff; border-radius: 6px; font-size: 14px; }
    .search-input::placeholder { color: #8892b0; }
    .search-input:focus { outline: none; border-color: #64ffda; }
    .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #8892b0; }
    
    /* Loading */
    .loading { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #1a1a2e; color: #fff; padding: 20px 40px; border-radius: 8px; z-index: 2000; }
    
    /* Empty state */
    .empty-state { text-align: center; padding: 40px 20px; color: #8892b0; }
    .empty-state svg { width: 64px; height: 64px; margin-bottom: 16px; opacity: 0.5; }
    
    /* Coverage gaps */
    .coverage-section { margin-top: 16px; padding-top: 16px; border-top: 1px solid #0f3460; }
    .coverage-area { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; font-size: 12px; }
    .coverage-bar { width: 60px; height: 6px; background: #0f3460; border-radius: 3px; overflow: hidden; }
    .coverage-bar-fill { height: 100%; background: #64ffda; }
    .coverage-bar-fill.low { background: #ef4444; }
    .coverage-bar-fill.medium { background: #f59e0b; }
  </style>
</head>
<body>
  <!-- Mobile menu button -->
  <button class="mobile-menu-btn" onclick="openMobileSidebar()">‚ò∞</button>
  
  <!-- Overlay for mobile -->
  <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeMobileSidebar()"></div>
  
  <div class="container">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <button class="sidebar-toggle" onclick="toggleSidebar()">‚ò∞</button>
      <button class="mobile-close-btn" onclick="closeMobileSidebar()">‚úï</button>
      
      <div class="sidebar-header">
        <h1>üó∫Ô∏è Territory Map</h1>
        <p>Las Vegas / Henderson Area</p>
      </div>
      
      <div class="sidebar-content">
        <!-- Search -->
        <div class="search-box">
          <span class="search-icon">üîç</span>
          <input type="text" class="search-input" placeholder="Search prospects..." id="searchInput" oninput="filterMarkers()">
        </div>
        
        <!-- View Toggles -->
        <div class="view-toggles">
          <button class="view-toggle active" data-view="markers" onclick="setView('markers')">üìç Markers</button>
          <button class="view-toggle" data-view="heatmap" onclick="setView('heatmap')">üî• Heatmap</button>
          <button class="view-toggle" data-view="clusters" onclick="setView('clusters')">üéØ Clusters</button>
        </div>
        
        <!-- Stats Panel -->
        <div class="stats-panel">
          <div class="stats-grid">
            <div class="stat-item">
              <div class="stat-value" id="totalCount">0</div>
              <div class="stat-label">Total</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="signedCount">0</div>
              <div class="stat-label">Signed</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="pipelineCount">0</div>
              <div class="stat-label">Pipeline</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="hotCount">0</div>
              <div class="stat-label">Hot Leads</div>
            </div>
          </div>
        </div>
        
        <!-- Status Filters -->
        <div class="filter-section">
          <h3>Filter by Status</h3>
          <div class="filter-group" id="statusFilters">
            <button class="filter-btn active" data-filter="signed" onclick="toggleFilter(this, 'status')">üü¢ Signed <span class="count">0</span></button>
            <button class="filter-btn active" data-filter="hot" onclick="toggleFilter(this, 'status')">üî¥ Hot <span class="count">0</span></button>
            <button class="filter-btn active" data-filter="warm" onclick="toggleFilter(this, 'status')">üü° Warm <span class="count">0</span></button>
            <button class="filter-btn active" data-filter="new" onclick="toggleFilter(this, 'status')">üîµ New <span class="count">0</span></button>
            <button class="filter-btn" data-filter="lost" onclick="toggleFilter(this, 'status')">‚ö´ Lost <span class="count">0</span></button>
          </div>
        </div>
        
        <!-- Property Type Filters -->
        <div class="filter-section">
          <h3>Filter by Property Type</h3>
          <div class="filter-group" id="typeFilters">
            <!-- Populated dynamically -->
          </div>
        </div>
        
        <!-- Legend -->
        <div class="legend">
          <h3 style="font-size: 12px; text-transform: uppercase; color: #8892b0; margin-bottom: 10px; letter-spacing: 1px;">Legend</h3>
          <div class="legend-item"><div class="legend-dot signed"></div> Signed / Active</div>
          <div class="legend-item"><div class="legend-dot hot"></div> Hot Lead</div>
          <div class="legend-item"><div class="legend-dot warm"></div> Warm Lead</div>
          <div class="legend-item"><div class="legend-dot new"></div> New / Cold</div>
          <div class="legend-item"><div class="legend-dot lost"></div> Lost / Closed</div>
          <div class="legend-item"><div class="legend-dot machine"></div> Active Machine</div>
        </div>
        
        <!-- Coverage Gaps -->
        <div class="coverage-section" id="coverageSection">
          <h3 style="font-size: 12px; text-transform: uppercase; color: #8892b0; margin-bottom: 10px; letter-spacing: 1px;">Coverage by Area</h3>
          <div id="coverageList"></div>
        </div>
        
        <!-- Route Panel -->
        <div class="route-panel" id="routePanel" style="display: none;">
          <h3>üöó Route Planner</h3>
          <div class="route-list" id="routeList"></div>
          <div class="route-info" id="routeInfo">Click markers to add stops</div>
          <div class="route-actions">
            <button class="btn btn-primary" onclick="exportRoute()" id="exportBtn" disabled>Export to Google Maps</button>
            <button class="btn btn-danger" onclick="clearRoute()">Clear</button>
          </div>
        </div>
      </div>
    </aside>
    
    <!-- Map -->
    <div id="map"></div>
  </div>
  
  <div class="loading" id="loading">Loading map data...</div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
  <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
  <script>
    // State
    let map, markersLayer, clusterLayer, heatLayer;
    let allProspects = [];
    let allMachines = [];
    let allLocations = [];
    let activeFilters = { status: ['signed', 'hot', 'warm', 'new'], types: [] };
    let routeStops = [];
    let currentView = 'markers';
    
    // Colors
    const statusColors = {
      signed: '#22c55e',
      hot: '#ef4444',
      warm: '#f59e0b',
      new: '#3b82f6',
      active: '#22c55e',
      closed: '#6b7280',
      lost: '#6b7280'
    };
    
    // Initialize map
    function initMap() {
      // Center on Las Vegas / Henderson area
      map = L.map('map').setView([36.0395, -115.0680], 11);
      
      // Dark tile layer
      L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
        subdomains: 'abcd',
        maxZoom: 19
      }).addTo(map);
      
      // Create layers
      markersLayer = L.layerGroup().addTo(map);
      clusterLayer = L.markerClusterGroup({
        maxClusterRadius: 50,
        spiderfyOnMaxZoom: true,
        showCoverageOnHover: false,
        iconCreateFunction: function(cluster) {
          const count = cluster.getChildCount();
          let size = 'small';
          if (count > 10) size = 'medium';
          if (count > 25) size = 'large';
          return L.divIcon({
            html: `<div class="cluster-icon cluster-${size}">${count}</div>`,
            className: 'marker-cluster',
            iconSize: [40, 40]
          });
        }
      });
      
      // Add cluster styles
      const style = document.createElement('style');
      style.textContent = `
        .marker-cluster { background: rgba(100, 255, 218, 0.3); border-radius: 50%; }
        .cluster-icon { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%; font-weight: bold; color: #0a192f; }
        .cluster-small { background: rgba(100, 255, 218, 0.7); }
        .cluster-medium { background: rgba(245, 158, 11, 0.8); }
        .cluster-large { background: rgba(239, 68, 68, 0.8); }
      `;
      document.head.appendChild(style);
      
      loadData();
    }
    
    // Load data from API
    async function loadData() {
      try {
        const [prospectsRes, machinesRes, locationsRes] = await Promise.all([
          fetch('/api/prospects'),
          fetch('/api/machines'),
          fetch('/api/locations')
        ]);
        
        allProspects = await prospectsRes.json();
        allMachines = await machinesRes.json();
        allLocations = await locationsRes.json();
        
        updateFilters();
        updateStats();
        updateCoverage();
        renderMarkers();
        
        document.getElementById('loading').style.display = 'none';
      } catch (err) {
        console.error('Failed to load data:', err);
        document.getElementById('loading').textContent = 'Failed to load data. Please refresh.';
      }
    }
    
    // Update filter buttons with counts
    function updateFilters() {
      // Status counts
      const statusCounts = { signed: 0, hot: 0, warm: 0, new: 0, lost: 0 };
      allProspects.forEach(p => {
        const status = getProspectStatus(p);
        if (statusCounts[status] !== undefined) statusCounts[status]++;
      });
      
      document.querySelectorAll('#statusFilters .filter-btn').forEach(btn => {
        const filter = btn.dataset.filter;
        btn.querySelector('.count').textContent = statusCounts[filter] || 0;
      });
      
      // Property type filters
      const typeCounts = {};
      allProspects.forEach(p => {
        const type = p.property_type || 'Unknown';
        typeCounts[type] = (typeCounts[type] || 0) + 1;
      });
      
      const typeContainer = document.getElementById('typeFilters');
      typeContainer.innerHTML = '';
      
      Object.entries(typeCounts)
        .sort((a, b) => b[1] - a[1])
        .forEach(([type, count]) => {
          const btn = document.createElement('button');
          btn.className = 'filter-btn active';
          btn.dataset.filter = type;
          btn.onclick = () => toggleFilter(btn, 'type');
          btn.innerHTML = `${type} <span class="count">${count}</span>`;
          typeContainer.appendChild(btn);
          activeFilters.types.push(type);
        });
    }
    
    // Get prospect status for coloring
    function getProspectStatus(p) {
      if (p.status === 'signed' || p.status === 'active') return 'signed';
      if (p.status === 'closed' || p.status === 'lost') return 'lost';
      if (p.priority === 'hot') return 'hot';
      if (p.priority === 'warm') return 'warm';
      return 'new';
    }
    
    // Update stats panel
    function updateStats() {
      const visibleProspects = getFilteredProspects();
      document.getElementById('totalCount').textContent = visibleProspects.length;
      document.getElementById('signedCount').textContent = visibleProspects.filter(p => p.status === 'signed' || p.status === 'active').length;
      document.getElementById('pipelineCount').textContent = visibleProspects.filter(p => p.status !== 'signed' && p.status !== 'closed' && p.status !== 'lost').length;
      document.getElementById('hotCount').textContent = visibleProspects.filter(p => p.priority === 'hot').length;
    }
    
    // Update coverage analysis
    function updateCoverage() {
      // Define areas (simplified zones)
      const areas = {
        'Henderson': { bounds: [[35.95, -115.15], [36.08, -114.95]], count: 0, target: 20 },
        'Green Valley': { bounds: [[35.98, -115.12], [36.05, -115.02]], count: 0, target: 15 },
        'Summerlin': { bounds: [[36.12, -115.35], [36.22, -115.25]], count: 0, target: 15 },
        'Downtown LV': { bounds: [[36.15, -115.18], [36.20, -115.10]], count: 0, target: 10 },
        'North Las Vegas': { bounds: [[36.20, -115.20], [36.30, -115.05]], count: 0, target: 12 },
        'Enterprise': { bounds: [[35.95, -115.25], [36.05, -115.15]], count: 0, target: 10 }
      };
      
      allProspects.filter(p => p.lat && p.lng).forEach(p => {
        Object.entries(areas).forEach(([name, area]) => {
          if (p.lat >= area.bounds[0][0] && p.lat <= area.bounds[1][0] &&
              p.lng >= area.bounds[0][1] && p.lng <= area.bounds[1][1]) {
            area.count++;
          }
        });
      });
      
      const container = document.getElementById('coverageList');
      container.innerHTML = '';
      
      Object.entries(areas)
        .sort((a, b) => (a[1].count / a[1].target) - (b[1].count / b[1].target))
        .forEach(([name, area]) => {
          const pct = Math.min(100, Math.round((area.count / area.target) * 100));
          let fillClass = '';
          if (pct < 30) fillClass = 'low';
          else if (pct < 70) fillClass = 'medium';
          
          container.innerHTML += `
            <div class="coverage-area">
              <span>${name}</span>
              <span>${area.count}/${area.target}</span>
              <div class="coverage-bar">
                <div class="coverage-bar-fill ${fillClass}" style="width: ${pct}%"></div>
              </div>
            </div>
          `;
        });
    }
    
    // Get filtered prospects
    function getFilteredProspects() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      
      return allProspects.filter(p => {
        // Must have coordinates
        if (!p.lat || !p.lng) return false;
        
        // Status filter
        const status = getProspectStatus(p);
        if (!activeFilters.status.includes(status)) return false;
        
        // Type filter
        const type = p.property_type || 'Unknown';
        if (activeFilters.types.length > 0 && !activeFilters.types.includes(type)) return false;
        
        // Search filter
        if (searchTerm) {
          const searchable = `${p.name} ${p.address} ${p.property_type}`.toLowerCase();
          if (!searchable.includes(searchTerm)) return false;
        }
        
        return true;
      });
    }
    
    // Create marker icon
    function createMarkerIcon(status, isMachine = false) {
      const color = isMachine ? '#8b5cf6' : (statusColors[status] || '#3b82f6');
      const size = isMachine ? 28 : 24;
      
      return L.divIcon({
        className: 'custom-marker',
        html: `<div style="
          width: ${size}px;
          height: ${size}px;
          background: ${color};
          border: 3px solid #fff;
          border-radius: 50%;
          box-shadow: 0 2px 8px rgba(0,0,0,0.4);
          ${isMachine ? 'display: flex; align-items: center; justify-content: center; font-size: 12px;' : ''}
        ">${isMachine ? 'üè≠' : ''}</div>`,
        iconSize: [size, size],
        iconAnchor: [size/2, size/2],
        popupAnchor: [0, -size/2]
      });
    }
    
    // Render markers on map
    function renderMarkers() {
      // Clear existing
      markersLayer.clearLayers();
      clusterLayer.clearLayers();
      if (heatLayer) map.removeLayer(heatLayer);
      
      const prospects = getFilteredProspects();
      const heatData = [];
      
      prospects.forEach(p => {
        const status = getProspectStatus(p);
        const marker = L.marker([p.lat, p.lng], {
          icon: createMarkerIcon(status)
        });
        
        // Popup content
        const touchCount = p.activity_count || 0;
        const statusClass = `status-${status}`;
        const statusLabel = status.charAt(0).toUpperCase() + status.slice(1);
        
        marker.bindPopup(`
          <div class="popup-content">
            <div class="popup-header">
              <div class="popup-name">${escapeHtml(p.name)}</div>
              <div class="popup-address">${escapeHtml(p.address || 'No address')}</div>
            </div>
            <div class="popup-meta">
              <span class="${statusClass}">${statusLabel}</span>
              <span style="background: #0f3460">${escapeHtml(p.property_type || 'Unknown')}</span>
            </div>
            <div class="popup-stats">
              <div class="popup-stat">
                <div class="popup-stat-value">${touchCount}</div>
                <div class="popup-stat-label">Touches</div>
              </div>
              <div class="popup-stat">
                <div class="popup-stat-value">${p.units || '-'}</div>
                <div class="popup-stat-label">Units</div>
              </div>
            </div>
            <div class="popup-actions">
              ${p.phone ? `<a href="tel:${p.phone}" class="popup-btn popup-btn-call">üìû Call</a>` : ''}
              ${p.email || (p.contacts && p.contacts[0]?.email) ? `<a href="mailto:${p.email || p.contacts[0]?.email}" class="popup-btn popup-btn-email">‚úâÔ∏è Email</a>` : ''}
              <a href="/crm#prospect-${p.id}" class="popup-btn popup-btn-view">üëÅÔ∏è View</a>
              <button class="popup-btn popup-btn-route" onclick="addToRoute(${p.id})">‚ûï Route</button>
            </div>
          </div>
        `);
        
        // Add to appropriate layer
        if (currentView === 'clusters') {
          clusterLayer.addLayer(marker);
        } else {
          markersLayer.addLayer(marker);
        }
        
        // Add to heat data
        heatData.push([p.lat, p.lng, 0.5]);
      });
      
      // Add machines
      allMachines.filter(m => m.status === 'deployed').forEach(m => {
        const location = allLocations.find(l => l.id === m.location_id);
        if (!location) return;
        
        // Try to get coordinates from location or linked prospect
        let lat, lng;
        if (location.lat && location.lng) {
          lat = location.lat;
          lng = location.lng;
        } else {
          const prospect = allProspects.find(p => p.id === location.prospect_id);
          if (prospect?.lat && prospect?.lng) {
            lat = prospect.lat;
            lng = prospect.lng;
          }
        }
        
        if (!lat || !lng) return;
        
        const marker = L.marker([lat, lng], {
          icon: createMarkerIcon('machine', true)
        });
        
        marker.bindPopup(`
          <div class="popup-content">
            <div class="popup-header">
              <div class="popup-name">üè≠ ${escapeHtml(m.name)}</div>
              <div class="popup-address">${escapeHtml(location.name || 'Unknown location')}</div>
            </div>
            <div class="popup-meta">
              <span style="background: #8b5cf6">Machine</span>
              <span style="background: #22c55e">${m.status}</span>
            </div>
          </div>
        `);
        
        markersLayer.addLayer(marker);
      });
      
      // Handle heatmap view
      if (currentView === 'heatmap') {
        markersLayer.clearLayers();
        heatLayer = L.heatLayer(heatData, {
          radius: 25,
          blur: 15,
          maxZoom: 15,
          gradient: {
            0.0: '#3b82f6',
            0.3: '#22c55e',
            0.5: '#f59e0b',
            0.7: '#ef4444',
            1.0: '#dc2626'
          }
        }).addTo(map);
      }
      
      // Handle cluster view
      if (currentView === 'clusters') {
        map.addLayer(clusterLayer);
      }
      
      updateStats();
    }
    
    // Toggle filter
    function toggleFilter(btn, type) {
      btn.classList.toggle('active');
      const filter = btn.dataset.filter;
      
      if (type === 'status') {
        if (btn.classList.contains('active')) {
          if (!activeFilters.status.includes(filter)) activeFilters.status.push(filter);
        } else {
          activeFilters.status = activeFilters.status.filter(f => f !== filter);
        }
      } else {
        if (btn.classList.contains('active')) {
          if (!activeFilters.types.includes(filter)) activeFilters.types.push(filter);
        } else {
          activeFilters.types = activeFilters.types.filter(f => f !== filter);
        }
      }
      
      renderMarkers();
    }
    
    // Filter markers by search
    function filterMarkers() {
      renderMarkers();
    }
    
    // Toggle sidebar (desktop)
    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('collapsed');
    }
    
    // Mobile sidebar functions
    function openMobileSidebar() {
      document.getElementById('sidebar').classList.add('open');
      document.getElementById('sidebarOverlay').classList.add('active');
      document.body.style.overflow = 'hidden';
    }
    
    function closeMobileSidebar() {
      document.getElementById('sidebar').classList.remove('open');
      document.getElementById('sidebarOverlay').classList.remove('active');
      document.body.style.overflow = '';
    }
    
    // Set view mode
    function setView(view) {
      currentView = view;
      document.querySelectorAll('.view-toggle').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.view === view);
      });
      
      // Show/hide route panel in markers view
      document.getElementById('routePanel').style.display = view === 'markers' ? 'block' : 'none';
      
      renderMarkers();
    }
    
    // Route planning
    function addToRoute(prospectId) {
      if (routeStops.find(s => s.id === prospectId)) return;
      
      const prospect = allProspects.find(p => p.id === prospectId);
      if (!prospect) return;
      
      routeStops.push(prospect);
      updateRouteDisplay();
    }
    
    function removeFromRoute(prospectId) {
      routeStops = routeStops.filter(s => s.id !== prospectId);
      updateRouteDisplay();
    }
    
    function updateRouteDisplay() {
      const list = document.getElementById('routeList');
      const info = document.getElementById('routeInfo');
      const exportBtn = document.getElementById('exportBtn');
      
      if (routeStops.length === 0) {
        list.innerHTML = '';
        info.textContent = 'Click markers to add stops';
        exportBtn.disabled = true;
        return;
      }
      
      list.innerHTML = routeStops.map((stop, i) => `
        <div class="route-item">
          <span class="num">${i + 1}</span>
          <span class="name">${escapeHtml(stop.name)}</span>
          <button class="remove" onclick="removeFromRoute(${stop.id})">‚úï</button>
        </div>
      `).join('');
      
      // Calculate rough distance (straight line, not driving)
      let totalDist = 0;
      for (let i = 1; i < routeStops.length; i++) {
        totalDist += haversineDistance(
          routeStops[i-1].lat, routeStops[i-1].lng,
          routeStops[i].lat, routeStops[i].lng
        );
      }
      
      info.textContent = `${routeStops.length} stops ‚Ä¢ ~${totalDist.toFixed(1)} mi (straight line)`;
      exportBtn.disabled = false;
    }
    
    function clearRoute() {
      routeStops = [];
      updateRouteDisplay();
    }
    
    function exportRoute() {
      if (routeStops.length === 0) return;
      
      // Build Google Maps directions URL
      const origin = `${routeStops[0].lat},${routeStops[0].lng}`;
      const destination = `${routeStops[routeStops.length - 1].lat},${routeStops[routeStops.length - 1].lng}`;
      const waypoints = routeStops.slice(1, -1).map(s => `${s.lat},${s.lng}`).join('|');
      
      let url = `https://www.google.com/maps/dir/?api=1&origin=${origin}&destination=${destination}`;
      if (waypoints) url += `&waypoints=${encodeURIComponent(waypoints)}`;
      url += '&travelmode=driving';
      
      window.open(url, '_blank');
    }
    
    // Haversine distance calculation
    function haversineDistance(lat1, lon1, lat2, lon2) {
      const R = 3959; // Earth radius in miles
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }
    
    // Escape HTML
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // Initialize on load
    document.addEventListener('DOMContentLoaded', initMap);
  </script>
</body>
</html>
