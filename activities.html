<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Activity Log - Kande VendTech</title>
  <style>
    :root {
      --bg: #f7fafc;
      --card: #ffffff;
      --border: #e2e8f0;
      --text: #1a202c;
      --muted: #718096;
      --accent: #3182ce;
      --success: #38a169;
      --hot: #e53e3e;
      --warm: #dd6b20;
      --purple: #805ad5;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 16px;
    }
    .container { max-width: 960px; margin: 0 auto; }
    .header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 16px; flex-wrap: wrap; gap: 12px;
    }
    .header h1 { font-size: 1.4rem; }
    .back-link { color: var(--accent); text-decoration: none; font-size: 0.85rem; }
    .back-link:hover { text-decoration: underline; }

    .controls {
      display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; align-items: center;
    }
    .filter-btn {
      padding: 6px 14px; border-radius: 20px; border: 1px solid var(--border);
      background: var(--card); color: var(--muted); cursor: pointer;
      font-size: 0.8rem; transition: all 0.15s;
    }
    .filter-btn:hover, .filter-btn.active {
      border-color: var(--accent); color: var(--accent); background: rgba(49,130,206,0.08);
    }
    .search-input {
      padding: 6px 14px; border-radius: 8px; border: 1px solid var(--border);
      background: var(--card); color: var(--text); font-size: 0.85rem; min-width: 180px;
    }

    .summary-bar {
      display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap;
    }
    .summary-stat {
      background: var(--card); border: 1px solid var(--border); border-radius: 10px;
      padding: 10px 16px; text-align: center; flex: 1; min-width: 100px;
    }
    .summary-stat .val { font-size: 1.5rem; font-weight: 700; }
    .summary-stat .label { font-size: 0.7rem; color: var(--muted); margin-top: 2px; }

    .location-group {
      background: var(--card); border: 1px solid var(--border); border-radius: 12px;
      margin-bottom: 12px; overflow: hidden;
    }
    .location-header {
      display: flex; justify-content: space-between; align-items: center;
      padding: 12px 16px; cursor: pointer; gap: 10px; flex-wrap: wrap;
    }
    .location-header:hover { background: rgba(49,130,206,0.03); }
    .location-name { font-weight: 600; font-size: 1rem; color: var(--accent); }
    .location-meta { font-size: 0.78rem; color: var(--muted); }
    .event-count {
      padding: 3px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 600;
      background: rgba(128,90,213,0.1); color: var(--purple);
    }
    .location-events { display: none; border-top: 1px solid var(--border); }
    .location-group.open .location-events { display: block; }

    .event-row {
      display: flex; align-items: flex-start; gap: 10px; padding: 10px 16px;
      border-bottom: 1px solid rgba(0,0,0,0.04); font-size: 0.85rem;
    }
    .event-row:last-child { border-bottom: none; }
    .event-icon { font-size: 1rem; flex-shrink: 0; margin-top: 1px; }
    .event-body { flex: 1; min-width: 0; }
    .event-text { color: var(--text); line-height: 1.4; }
    .event-time { font-size: 0.72rem; color: var(--muted); margin-top: 2px; }
    .event-badge {
      display: inline-block; padding: 1px 8px; border-radius: 4px;
      font-size: 0.7rem; font-weight: 600; margin-right: 6px;
    }
    .badge-call { background: rgba(49,130,206,0.1); color: var(--accent); }
    .badge-pop-in { background: rgba(56,161,105,0.1); color: var(--success); }
    .badge-email { background: rgba(221,107,32,0.1); color: var(--warm); }
    .badge-todo { background: rgba(128,90,213,0.1); color: var(--purple); }
    .badge-note { background: rgba(49,130,206,0.08); color: #2b6cb0; }
    .badge-status { background: rgba(56,161,105,0.08); color: #276749; }

    .date-divider {
      padding: 8px 16px; background: var(--bg); font-size: 0.78rem;
      font-weight: 600; color: var(--muted); border-bottom: 1px solid var(--border);
    }
    .empty-state { text-align: center; padding: 40px 20px; color: var(--muted); }

    .time-section-header {
      display: flex; justify-content: space-between; align-items: center;
      padding: 10px 16px; margin: 16px 0 8px; border-radius: 10px; cursor: pointer;
      font-weight: 600; font-size: 0.9rem; transition: all 0.15s;
    }
    .time-section-header:first-child { margin-top: 0; }
    .time-section-header:hover { opacity: 0.85; }
    .time-section-header .arrow { font-size: 0.75rem; margin-right: 6px; }
    .time-section-header.recent { background: linear-gradient(135deg, var(--accent), #2b6cb0); color: #fff; }
    .time-section-header.week { background: linear-gradient(135deg, var(--purple), #6b46c1); color: #fff; }
    .time-section-header.older { background: linear-gradient(135deg, #718096, #4a5568); color: #fff; }
    .time-section-content { display: none; }
    .time-section-content.open { display: block; }

    @media (max-width: 600px) {
      .summary-bar { gap: 6px; }
      .summary-stat { padding: 8px 10px; }
      .summary-stat .val { font-size: 1.2rem; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üìä Activity Log</h1>
      <a href="/crm" class="back-link">‚Üê Back to CRM</a>
    </div>

    <div class="summary-bar" id="summaryBar">
      <div class="summary-stat"><div class="val" id="sumTotal">-</div><div class="label">Total Events</div></div>
      <div class="summary-stat"><div class="val" id="sumLocations">-</div><div class="label">Locations</div></div>
      <div class="summary-stat"><div class="val" style="color:var(--accent)" id="sumCalls">-</div><div class="label">üìû Calls</div></div>
      <div class="summary-stat"><div class="val" style="color:var(--success)" id="sumPopins">-</div><div class="label">üö∂ Pop-ins</div></div>
      <div class="summary-stat"><div class="val" style="color:var(--warm)" id="sumEmails">-</div><div class="label">üìß Emails</div></div>
      <div class="summary-stat"><div class="val" style="color:var(--purple)" id="sumNotes">-</div><div class="label">üìù Notes</div></div>
    </div>

    <div class="controls">
      <button class="filter-btn active" data-filter="all">All</button>
      <button class="filter-btn" data-filter="call">üìû Calls</button>
      <button class="filter-btn" data-filter="pop-in">üö∂ Pop-ins</button>
      <button class="filter-btn" data-filter="email">üìß Emails</button>
      <button class="filter-btn" data-filter="todo">‚úÖ To-Do</button>
      <button class="filter-btn" data-filter="note">üìù Notes</button>
      <button class="filter-btn" data-filter="status-change">üîÑ Status</button>
      <input type="text" class="search-input" id="search" placeholder="Search locations...">
    </div>

    <div id="activityList">
      <div class="empty-state">Loading...</div>
    </div>
  </div>

  <script>
    let allEvents = [];
    let prospects = {};
    let currentFilter = 'all';

    async function init() {
      const pRes = await fetch('/api/prospects');
      const pList = await pRes.json();
      pList.forEach(p => prospects[p.id] = p);

      // Build unified event list from all sources
      allEvents = [];

      pList.forEach(p => {
        // 1. Activities (calls, pop-ins, emails, status-changes, todo completions)
        (p.activities || []).forEach(a => {
          let category = a.type;
          let icon = 'üìã';
          let badgeClass = 'badge-call';
          let label = a.type;

          if (a.type === 'call') { icon = 'üìû'; badgeClass = 'badge-call'; label = 'Call'; }
          else if (a.type === 'pop-in') { icon = 'üö∂'; badgeClass = 'badge-pop-in'; label = 'Pop-in'; }
          else if (a.type === 'email') { icon = 'üìß'; badgeClass = 'badge-email'; label = 'Email'; }
          else if (a.type === 'status-change') { icon = 'üîÑ'; badgeClass = 'badge-status'; label = 'Status'; category = 'status-change'; }

          // Detect todo completions logged as activities
          if (a.description && a.description.includes('Completed from to-do list')) {
            icon = '‚úÖ'; badgeClass = 'badge-todo'; label = 'To-Do Completed'; category = 'todo';
          }

          let text = a.description || '';
          if (a.outcome) text += (text ? ' ‚Üí ' : '') + outcomeLabel(a.outcome);
          if (a.next_action) text += (text ? ' ¬∑ ' : '') + 'Next: ' + a.next_action;

          const desc = (a.description || '').trim();
          const isTodoComplete = desc.includes('Completed from to-do list');

          // ONLY show manually-entered activity types ‚Äî skip all agent/auto-generated ones
          const MANUAL_TYPES = ['call', 'pop-in', 'pop_in', 'email', 'note', 'other', 'meeting', 'visit'];
          if (!MANUAL_TYPES.includes((a.type || '').toLowerCase()) && !isTodoComplete) return;

          // Skip all agent-generated activities (Scout, Relay, Ralph, any bot)
          if (/^(Scout|Relay|Ralph|Clawd|Agent)\b/i.test(desc) || a.source === 'scout' || a.source === 'agent' || a.source === 'relay' || a.source === 'bot') return;

          // Skip auto-generated patterns
          if (/^Email \d+ (sent|drafted)/i.test(desc) || /Follow-up email drafted/i.test(desc)) return;

          // Skip empty activities (no description, outcome, or next action)
          if (!desc && !a.outcome && !a.next_action) return;

          allEvents.push({
            id: a.id,
            type: a.type,
            prospectId: p.id,
            prospectName: p.name,
            propertyType: p.property_type,
            category,
            icon,
            badgeClass,
            label,
            text: text || label,
            timestamp: new Date(a.created_at || a.activity_date || 0)
          });
        });

        // 2. Timestamped notes (Sales Notes & Kurtis Notes)
        extractNotes(p.id, p.name, p.property_type, p.kurtis_notes, 'üìù', 'Kurtis note');
        extractNotes(p.id, p.name, p.property_type, p.notes, 'üóíÔ∏è', 'Sales note');
      });

      // Sort all events by timestamp descending
      allEvents.sort((a, b) => b.timestamp - a.timestamp);

      render();
    }

    function extractNotes(prospectId, prospectName, propertyType, noteText, icon, prefix) {
      if (!noteText) return;
      noteText.split('\n').forEach(line => {
        const ts = parseNoteTimestamp(line);
        if (ts) {
          const content = line.replace(/^\[[^\]]+\]\s*/, '').substring(0, 120);
          if (content.trim() && !/^(Scout|Relay|Ralph|Clawd|Agent)\b/i.test(content)) {
            allEvents.push({
              prospectId,
              prospectName,
              propertyType,
              category: 'note',
              icon,
              badgeClass: 'badge-note',
              label: prefix,
              text: content,
              timestamp: ts
            });
          }
        }
      });
    }

    function parseNoteTimestamp(line) {
      // [MM/DD/YY, HH:MM AM/PM]
      const shortMatch = line.match(/^\[(\d{2})\/(\d{2})\/(\d{2}),?\s*(\d{1,2}):(\d{2})\s*(AM|PM)\]/i);
      if (shortMatch) {
        const [, mm, dd, yy, hr, min, ampm] = shortMatch;
        let hour = parseInt(hr);
        if (ampm.toUpperCase() === 'PM' && hour !== 12) hour += 12;
        if (ampm.toUpperCase() === 'AM' && hour === 12) hour = 0;
        return new Date(2000 + parseInt(yy), parseInt(mm) - 1, parseInt(dd), hour, parseInt(min));
      }
      // [YYYY-MM-DD ...]
      const isoMatch = line.match(/^\[(20\d{2}-\d{2}-\d{2}[^\]]*)\]/);
      if (isoMatch) return new Date(isoMatch[1]);
      return null;
    }

    function outcomeLabel(val) {
      const labels = { interested: 'Interested', thinking: 'Thinking about it', not_available: 'Not available', not_interested: 'Not interested', left_info: 'Left info' };
      return labels[val] || val;
    }

    function render() {
      const search = document.getElementById('search').value.toLowerCase();
      const now = Date.now();
      const cutoff48h = new Date(now - 2 * 86400000);
      const cutoff7d = new Date(now - 7 * 86400000);
      const cutoff14d = new Date(now - 14 * 86400000);

      // Filter by category and search
      let filtered = allEvents.filter(e => e.timestamp >= cutoff14d);
      if (currentFilter !== 'all') filtered = filtered.filter(e => e.category === currentFilter);
      if (search) filtered = filtered.filter(e => e.prospectName.toLowerCase().includes(search) || e.text.toLowerCase().includes(search));

      // Update summary (all 14 days)
      document.getElementById('sumTotal').textContent = filtered.length;
      document.getElementById('sumLocations').textContent = new Set(filtered.map(e => e.prospectId)).size;
      document.getElementById('sumCalls').textContent = filtered.filter(e => e.category === 'call').length;
      document.getElementById('sumPopins').textContent = filtered.filter(e => e.category === 'pop-in').length;
      document.getElementById('sumEmails').textContent = filtered.filter(e => e.category === 'email').length;
      document.getElementById('sumNotes').textContent = filtered.filter(e => e.category === 'note').length;

      if (filtered.length === 0) {
        document.getElementById('activityList').innerHTML = '<div class="empty-state"><h3>No activity found</h3><p style="margin-top:8px;">No activity in the last 14 days.</p></div>';
        return;
      }

      // Bucket events into 3 time periods
      const recent = filtered.filter(e => e.timestamp >= cutoff48h);
      const week = filtered.filter(e => e.timestamp < cutoff48h && e.timestamp >= cutoff7d);
      const older = filtered.filter(e => e.timestamp < cutoff7d && e.timestamp >= cutoff14d);

      let html = '';

      // Section 1: Last 48 Hours ‚Äî auto-expanded
      if (recent.length > 0) {
        html += `<div class="time-section-header recent" onclick="toggleSection('sec-recent')">
          <span><span class="arrow" id="arrow-sec-recent">‚ñº</span> Last 48 Hours</span>
          <span style="font-size:0.8rem;opacity:0.85;">${recent.length} event${recent.length > 1 ? 's' : ''}</span>
        </div>`;
        html += `<div class="time-section-content open" id="sec-recent">`;
        html += renderLocationGroups(recent, true);
        html += `</div>`;
      }

      // Section 2: Last 7 Days ‚Äî collapsed locations
      if (week.length > 0) {
        html += `<div class="time-section-header week" onclick="toggleSection('sec-week')">
          <span><span class="arrow" id="arrow-sec-week">‚ñ∂</span> Last 7 Days</span>
          <span style="font-size:0.8rem;opacity:0.85;">${week.length} event${week.length > 1 ? 's' : ''}</span>
        </div>`;
        html += `<div class="time-section-content" id="sec-week">`;
        html += renderLocationGroups(week, false);
        html += `</div>`;
      }

      // Section 3: Last 14 Days ‚Äî collapsed section
      if (older.length > 0) {
        html += `<div class="time-section-header older" onclick="toggleSection('sec-older')">
          <span><span class="arrow" id="arrow-sec-older">‚ñ∂</span> Last 14 Days</span>
          <span style="font-size:0.8rem;opacity:0.85;">${older.length} event${older.length > 1 ? 's' : ''}</span>
        </div>`;
        html += `<div class="time-section-content" id="sec-older">`;
        html += renderLocationGroups(older, false);
        html += `</div>`;
      }

      document.getElementById('activityList').innerHTML = html;
    }

    function renderLocationGroups(events, autoExpand) {
      const byLocation = {};
      events.forEach(e => {
        if (!byLocation[e.prospectId]) {
          byLocation[e.prospectId] = { name: e.prospectName, propertyType: e.propertyType, events: [] };
        }
        byLocation[e.prospectId].events.push(e);
      });

      const sorted = Object.entries(byLocation).sort((a, b) => {
        return b[1].events[0].timestamp - a[1].events[0].timestamp;
      });

      let html = '';
      sorted.forEach(([pid, group]) => {
        const uid = pid + '-' + (autoExpand ? 'r' : Math.random().toString(36).slice(2,6));
        const eventSummary = summarizeEvents(group.events);
        const mostRecent = group.events[0].timestamp;

        html += `<div class="location-group ${autoExpand ? 'open' : ''}" id="loc-${uid}">
          <div class="location-header" onclick="toggleLocation('${uid}')">
            <div>
              <span class="location-name">${esc(group.name)}</span>
              <span class="location-meta">${group.propertyType || ''} ¬∑ ${getTimeAgo(mostRecent)}</span>
            </div>
            <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap;">
              ${eventSummary}
              <span class="event-count">${group.events.length} event${group.events.length > 1 ? 's' : ''}</span>
            </div>
          </div>
          <div class="location-events">
            ${renderEvents(group.events)}
          </div>
        </div>`;
      });
      return html;
    }

    function summarizeEvents(events) {
      const counts = {};
      events.forEach(e => {
        const key = e.icon;
        counts[key] = (counts[key] || 0) + 1;
      });
      return Object.entries(counts).map(([icon, count]) =>
        `<span style="font-size:0.8rem;">${icon}${count > 1 ? '<span style="font-size:0.7rem;color:var(--muted);">√ó' + count + '</span>' : ''}</span>`
      ).join(' ');
    }

    function renderEvents(events) {
      // Group events by date
      const byDate = {};
      events.forEach(e => {
        const dateKey = e.timestamp.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
        if (!byDate[dateKey]) byDate[dateKey] = [];
        byDate[dateKey].push(e);
      });

      let html = '';
      Object.entries(byDate).forEach(([dateLabel, dateEvents]) => {
        html += `<div class="date-divider">${dateLabel} <span style="font-weight:normal;opacity:0.6;">(${dateEvents.length})</span></div>`;
        dateEvents.forEach(e => {
          html += `<div class="event-row" id="activity-row-${e.id}">
            <span class="event-icon">${e.icon}</span>
            <div class="event-body">
              <div class="event-text">
                <span class="event-badge ${e.badgeClass}">${e.label}</span>
                ${esc(e.text)}
              </div>
              <div class="event-time">${e.timestamp.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true })} ¬∑ ${getTimeAgo(e.timestamp)}</div>
            </div>
            <div class="event-actions" style="display:flex;gap:6px;flex-shrink:0;">
              <button onclick="editActivity(${e.id}, '${esc(e.text).replace(/'/g, "\\'")}', '${e.type}')" style="padding:4px 8px;border:1px solid #e2e8f0;border-radius:6px;background:#fff;cursor:pointer;font-size:0.7rem;color:#718096;" title="Edit">‚úèÔ∏è</button>
              <button onclick="deleteActivity(${e.id})" style="padding:4px 8px;border:1px solid #fed7d7;border-radius:6px;background:#fff7f7;cursor:pointer;font-size:0.7rem;color:#e53e3e;" title="Delete">üóëÔ∏è</button>
            </div>
          </div>`;
        });
      });
      return html;
    }

    function toggleLocation(pid) {
      document.getElementById('loc-' + pid)?.classList.toggle('open');
    }

    function toggleSection(id) {
      const el = document.getElementById(id);
      if (!el) return;
      el.classList.toggle('open');
      const arrow = document.getElementById('arrow-' + id);
      if (arrow) arrow.textContent = el.classList.contains('open') ? '‚ñº' : '‚ñ∂';
    }

    function getTimeAgo(date) {
      const diff = Date.now() - date.getTime();
      const mins = Math.floor(diff / 60000);
      if (mins < 1) return 'just now';
      if (mins < 60) return mins + 'm ago';
      const hours = Math.floor(mins / 60);
      if (hours < 24) return hours + 'h ago';
      const days = Math.floor(hours / 24);
      if (days === 1) return 'yesterday';
      return days + 'd ago';
    }

    function esc(s) {
      return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    // Filter buttons
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentFilter = btn.dataset.filter;
        render();
      });
    });
    document.getElementById('search').addEventListener('input', render);

    // Edit activity
    function editActivity(id, currentText, type) {
      const modal = document.createElement('div');
      modal.id = 'edit-activity-modal';
      modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:9999;display:flex;align-items:center;justify-content:center;padding:20px;';
      modal.innerHTML = `
        <div style="background:#fff;border-radius:16px;padding:24px;max-width:480px;width:100%;box-shadow:0 20px 60px rgba(0,0,0,0.2);">
          <h3 style="margin:0 0 16px 0;font-size:1.1rem;">‚úèÔ∏è Edit Activity</h3>
          <label style="font-size:0.8rem;font-weight:600;color:#4a5568;display:block;margin-bottom:6px;">Type</label>
          <select id="edit-activity-type" style="width:100%;padding:10px 14px;border:1px solid #e2e8f0;border-radius:8px;font-size:0.88rem;margin-bottom:16px;background:#fff;">
            <option value="call" ${type === 'call' ? 'selected' : ''}>üìû Call</option>
            <option value="pop-in" ${type === 'pop-in' ? 'selected' : ''}>üö∂ Pop-in</option>
            <option value="email" ${type === 'email' ? 'selected' : ''}>üìß Email</option>
            <option value="note" ${type === 'note' ? 'selected' : ''}>üìù Note</option>
            <option value="other" ${type === 'other' ? 'selected' : ''}>üìã Other</option>
          </select>
          <label style="font-size:0.8rem;font-weight:600;color:#4a5568;display:block;margin-bottom:6px;">Description</label>
          <textarea id="edit-activity-text" style="width:100%;padding:10px 14px;border:1px solid #e2e8f0;border-radius:8px;font-size:0.88rem;min-height:100px;resize:vertical;font-family:inherit;">${currentText.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</textarea>
          <div style="display:flex;gap:12px;justify-content:flex-end;margin-top:20px;">
            <button onclick="closeEditModal()" style="padding:10px 20px;border:1px solid #e2e8f0;border-radius:8px;background:#fff;font-size:0.85rem;font-weight:600;cursor:pointer;">Cancel</button>
            <button onclick="saveActivity(${id})" style="padding:10px 24px;border:none;border-radius:8px;background:#3182ce;color:#fff;font-size:0.85rem;font-weight:600;cursor:pointer;">Save Changes</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      document.getElementById('edit-activity-text').focus();
    }

    function closeEditModal() {
      const modal = document.getElementById('edit-activity-modal');
      if (modal) modal.remove();
    }

    async function saveActivity(id) {
      const type = document.getElementById('edit-activity-type').value;
      const description = document.getElementById('edit-activity-text').value;
      
      try {
        const res = await fetch('/api/activities/' + id, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ type, description })
        });
        if (res.ok) {
          closeEditModal();
          init(); // Reload activities
        } else {
          alert('Failed to save changes');
        }
      } catch(e) {
        alert('Error saving changes');
      }
    }

    // Delete activity
    async function deleteActivity(id) {
      if (!confirm('Delete this activity? This cannot be undone.')) return;
      
      try {
        const res = await fetch('/api/activities/' + id, { method: 'DELETE' });
        if (res.ok) {
          const row = document.getElementById('activity-row-' + id);
          if (row) {
            row.style.opacity = '0.5';
            row.style.textDecoration = 'line-through';
            setTimeout(() => row.remove(), 500);
          }
        } else {
          alert('Failed to delete activity');
        }
      } catch(e) {
        alert('Error deleting activity');
      }
    }

    init();
  </script>
</body>
</html>
