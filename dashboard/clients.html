<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kande Digital â€” Client Pipeline</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }

        :root {
            --bg:     #f8f9fa;
            --card:   #ffffff;
            --border: #e2e8f0;
            --text:   #1a1a1a;
            --muted:  #6b7280;
            --blue:   #3b82f6;
            --green:  #10b981;
            --amber:  #f59e0b;
            --red:    #ef4444;
            --purple: #7c3aed;
        }

        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }

        /* â”€â”€ Layout â”€â”€ */
        .layout { display: flex; min-height: 100vh; }

        .sidebar {
            width: 220px;
            background: var(--card);
            border-right: 1px solid var(--border);
            padding: 20px 0;
            position: fixed; top: 0; left: 0; bottom: 0;
            overflow-y: auto; z-index: 100;
        }
        .sidebar-brand { padding: 0 18px 18px; border-bottom: 1px solid var(--border); margin-bottom: 10px; }
        .sidebar-brand h2 { font-size: 1rem; color: var(--blue); font-weight: 700; }
        .sidebar-brand p  { font-size: 0.7rem; color: var(--muted); }
        .nav-sec { padding: 10px 18px 4px; font-size: 0.7rem; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: .05em; }
        .nav-link {
            display: flex; align-items: center; gap: 8px;
            padding: 8px 18px; color: var(--text); text-decoration: none;
            font-size: 0.875rem; border-left: 3px solid transparent; transition: all .15s;
        }
        .nav-link:hover  { background: var(--bg); }
        .nav-link.active { background: #eff6ff; color: var(--blue); border-left-color: var(--blue); font-weight: 600; }

        .main { margin-left: 220px; padding: 28px; flex: 1; }

        /* â”€â”€ Header â”€â”€ */
        .page-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 24px; }
        .page-title { font-size: 1.7rem; font-weight: 700; margin-bottom: 2px; }
        .page-sub { color: var(--muted); font-size: 0.875rem; }
        .btn { padding: 9px 18px; border: none; border-radius: 6px; font-size: 0.875rem; font-weight: 600; cursor: pointer; }
        .btn-primary { background: var(--blue); color: #fff; }
        .btn-primary:hover { background: #2563eb; }

        /* â”€â”€ Stats â”€â”€ */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 14px; margin-bottom: 24px; }
        .stat-card { background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 18px; text-align: center; }
        .stat-val { font-size: 2rem; font-weight: 700; }
        .stat-label { font-size: 0.75rem; color: var(--muted); margin-top: 4px; }
        .stat-card.highlight { border-color: var(--green); background: #f0fdf4; }
        .stat-card.highlight .stat-val { color: var(--green); }

        /* â”€â”€ Pipeline columns â”€â”€ */
        .pipeline { display: grid; grid-template-columns: repeat(4, 1fr); gap: 14px; margin-bottom: 28px; }
        .pipe-col { background: var(--card); border: 1px solid var(--border); border-radius: 10px; overflow: hidden; }
        .pipe-header { padding: 12px 14px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .pipe-title { font-size: 0.8rem; font-weight: 700; display: flex; align-items: center; gap: 6px; }
        .pipe-count { background: var(--border); color: var(--muted); border-radius: 12px; padding: 1px 8px; font-size: 0.7rem; font-weight: 700; }
        .pipe-body { padding: 10px; min-height: 80px; display: flex; flex-direction: column; gap: 8px; }
        .pipe-empty { font-size: 0.78rem; color: var(--muted); text-align: center; padding: 14px; font-style: italic; }

        .pipe-card { background: var(--bg); border: 1px solid var(--border); border-radius: 7px; padding: 11px; cursor: pointer; transition: all .15s; }
        .pipe-card:hover { border-color: var(--blue); box-shadow: 0 2px 6px rgba(0,0,0,.06); }
        .pipe-biz { font-weight: 600; font-size: 0.85rem; margin-bottom: 3px; }
        .pipe-meta { font-size: 0.75rem; color: var(--muted); }
        .pipe-score { display: inline-block; padding: 2px 7px; border-radius: 10px; font-size: 0.7rem; font-weight: 700; margin-top: 6px; }
        .score-poor   { background: #fee2e2; color: #991b1b; }
        .score-fair   { background: #fef3c7; color: #92400e; }
        .score-good   { background: #dcfce7; color: #166534; }
        .plan-badge   { display: inline-block; padding: 1px 7px; border-radius: 10px; font-size: 0.65rem; font-weight: 700; margin-left: 4px; }
        .plan-starter { background: #e0f2fe; color: #0369a1; }
        .plan-pro     { background: #ede9fe; color: #5b21b6; }

        /* â”€â”€ Full table view â”€â”€ */
        .section-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .section-title { font-size: 1rem; font-weight: 700; }
        .table-wrap { background: var(--card); border: 1px solid var(--border); border-radius: 10px; overflow: hidden; margin-bottom: 28px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.875rem; }
        thead { background: var(--bg); }
        th { padding: 12px 14px; text-align: left; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: .04em; color: var(--muted); border-bottom: 1px solid var(--border); }
        td { padding: 12px 14px; border-bottom: 1px solid var(--border); vertical-align: middle; }
        tr:last-child td { border-bottom: none; }
        tr:hover td { background: #fafbfc; }
        .biz-name { font-weight: 600; }
        .biz-type { font-size: 0.75rem; color: var(--muted); }

        .status-badge { padding: 3px 10px; border-radius: 12px; font-size: 0.7rem; font-weight: 700; display: inline-block; }
        .status-new       { background: #dbeafe; color: #1e40af; }
        .status-contacted { background: #fef3c7; color: #92400e; }
        .status-active    { background: #dcfce7; color: #166534; }
        .status-churned   { background: #fee2e2; color: #991b1b; }

        .status-select { padding: 3px 8px; border: 1px solid var(--border); border-radius: 6px; font-size: 0.78rem; background: var(--card); cursor: pointer; }

        .audit-bar { height: 6px; background: var(--border); border-radius: 3px; margin-top: 4px; }
        .audit-bar-fill { height: 100%; border-radius: 3px; }

        .empty-state { text-align: center; padding: 48px; color: var(--muted); }
        .empty-icon { font-size: 2.5rem; margin-bottom: 10px; }
        .empty-title { font-size: 1rem; font-weight: 600; margin-bottom: 6px; color: var(--text); }
        .empty-sub { font-size: 0.875rem; }

        /* â”€â”€ Modal â”€â”€ */
        .modal-bg { position: fixed; inset: 0; background: rgba(0,0,0,.5); display: none; align-items: center; justify-content: center; z-index: 500; }
        .modal-bg.open { display: flex; }
        .modal { background: var(--card); border-radius: 12px; padding: 28px; max-width: 580px; width: 95%; max-height: 85vh; overflow-y: auto; border: 1px solid var(--border); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 14px; border-bottom: 1px solid var(--border); }
        .modal-title { font-size: 1.1rem; font-weight: 700; }
        .modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--muted); }

        .detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-bottom: 18px; }
        .detail-item label { font-size: 0.7rem; font-weight: 700; color: var(--muted); text-transform: uppercase; letter-spacing: .04em; display: block; margin-bottom: 3px; }
        .detail-item .val { font-size: 0.9rem; color: var(--text); }

        .breakdown-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-bottom: 14px; }
        .breakdown-cell { text-align: center; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; padding: 8px 4px; }
        .breakdown-num { font-size: 1.1rem; font-weight: 700; }
        .breakdown-cat { font-size: 0.65rem; color: var(--muted); margin-top: 2px; text-transform: capitalize; }
        .rec-row { display: flex; align-items: flex-start; gap: 8px; padding: 7px 0; border-bottom: 1px solid var(--border); font-size: 0.85rem; }
        .rec-row:last-child { border-bottom: none; }
        .rec-badge { padding: 2px 8px; border-radius: 10px; font-size: 0.65rem; font-weight: 700; flex-shrink: 0; }
        .HIGH { background: #fee2e2; color: #991b1b; }
        .MEDIUM { background: #fef3c7; color: #92400e; }
        .LOW { background: #dcfce7; color: #166534; }

        .loading { text-align: center; padding: 40px; color: var(--muted); }
        @media (max-width: 900px) {
            .sidebar { display: none; }
            .main { margin-left: 0; padding: 15px; }
            .pipeline { grid-template-columns: 1fr 1fr; }
            .detail-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
<div class="layout">

    <nav class="sidebar">
        <div class="sidebar-brand">
            <h2>ğŸ—ï¸ Kande Digital</h2>
            <p>Blue Collar AI Platform</p>
        </div>
        <div class="nav-sec">Sales</div>
        <a href="/clients" class="nav-link active">ğŸ‘¥ Client Pipeline</a>
        <a href="/onboard" class="nav-link">ğŸ“ Onboard Client</a>
        <div class="nav-sec">Tools</div>
        <a href="/digital" class="nav-link">ğŸ”§ Tool Hub</a>
        <div class="nav-sec">Mission Control</div>
        <a href="/tasks"   class="nav-link">ğŸ“‹ Tasks</a>
        <a href="/team"    class="nav-link">ğŸ‘¥ Team</a>
        <a href="/"        class="nav-link">ğŸ  VendTech</a>
    </nav>

    <main class="main">
        <div class="page-header">
            <div>
                <h1 class="page-title">ğŸ‘¥ Client Pipeline</h1>
                <p class="page-sub">All Kande Digital onboarding submissions &amp; active clients</p>
            </div>
            <a href="/onboard" class="btn btn-primary">+ New Client</a>
        </div>

        <!-- Stats -->
        <div class="stats-grid" id="stats-grid">
            <div class="loading">Loadingâ€¦</div>
        </div>

        <!-- Pipeline view -->
        <div class="section-head">
            <div class="section-title">Pipeline View</div>
        </div>
        <div class="pipeline" id="pipeline">
            <div class="loading">Loading pipelineâ€¦</div>
        </div>

        <!-- Full table -->
        <div class="section-head">
            <div class="section-title">All Submissions</div>
            <span id="submission-count" style="font-size:0.8rem;color:var(--muted);"></span>
        </div>
        <div class="table-wrap">
            <table id="clients-table">
                <thead>
                    <tr>
                        <th>Business</th>
                        <th>Contact</th>
                        <th>Plan</th>
                        <th>Audit Score</th>
                        <th>Status</th>
                        <th>Submitted</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="clients-body">
                    <tr><td colspan="7" style="text-align:center;padding:40px;color:var(--muted);">Loadingâ€¦</td></tr>
                </tbody>
            </table>
        </div>
    </main>
</div>

<!-- Detail Modal -->
<div class="modal-bg" id="detail-modal">
    <div class="modal">
        <div class="modal-header">
            <div class="modal-title" id="modal-biz-name">Client Details</div>
            <button class="modal-close" onclick="closeModal()">Ã—</button>
        </div>
        <div id="modal-body">Loadingâ€¦</div>
    </div>
</div>

<script>
    const API_KEY = 'kande2026';
    let allSubmissions = [];
    let currentDetail  = null;

    // â”€â”€ Boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.addEventListener('DOMContentLoaded', loadClients);

    async function loadClients() {
        try {
            const res = await fetch('/api/digital/onboard/list', {
                headers: { 'x-api-key': API_KEY }
            });
            if (!res.ok) throw new Error(res.status);
            const data = await res.json();
            allSubmissions = data.submissions || [];
            renderStats(data.stats || {}, data.submissions || []);
            renderPipeline(data.submissions || []);
            renderTable(data.submissions || []);
        } catch (e) {
            document.getElementById('clients-body').innerHTML =
                `<tr><td colspan="7" style="text-align:center;padding:40px;color:var(--muted);">Failed to load clients â€” ${e.message}</td></tr>`;
        }
    }

    // â”€â”€ Stats â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderStats(stats, subs) {
        const avgScore = subs.length
            ? Math.round(subs.reduce((s, c) => s + (c.auditScore || c.initialAudit?.auditScore || 0), 0) / subs.length)
            : 0;
        const mrr = subs.filter(s => s.status === 'active').reduce((t, s) => t + (s.price || 0), 0);
        const proCount = subs.filter(s => s.plan === 'pro').length;

        document.getElementById('stats-grid').innerHTML = `
            <div class="stat-card">
                <div class="stat-val">${subs.length}</div>
                <div class="stat-label">Total Submissions</div>
            </div>
            <div class="stat-card">
                <div class="stat-val">${stats.new || 0}</div>
                <div class="stat-label">New Leads</div>
            </div>
            <div class="stat-card">
                <div class="stat-val">${stats.active || 0}</div>
                <div class="stat-label">Active Clients</div>
            </div>
            <div class="stat-card highlight">
                <div class="stat-val">$${mrr || (subs.filter(s=>s.status==='active').length * 199)}</div>
                <div class="stat-label">MRR</div>
            </div>
            <div class="stat-card">
                <div class="stat-val">${avgScore || 'â€”'}</div>
                <div class="stat-label">Avg Audit Score</div>
            </div>
            <div class="stat-card">
                <div class="stat-val">${proCount}</div>
                <div class="stat-label">Pro Plan</div>
            </div>
        `;
    }

    // â”€â”€ Pipeline â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const STATUSES = [
        { key: 'new',       label: 'New Leads',   dot: '#3b82f6' },
        { key: 'contacted', label: 'Contacted',    dot: '#f59e0b' },
        { key: 'active',    label: 'Active',       dot: '#10b981' },
        { key: 'churned',   label: 'Churned',      dot: '#ef4444' }
    ];

    function renderPipeline(subs) {
        document.getElementById('pipeline').innerHTML = STATUSES.map(s => {
            const cards = subs.filter(c => c.status === s.key);
            return `
                <div class="pipe-col">
                    <div class="pipe-header">
                        <span class="pipe-title">
                            <span style="width:8px;height:8px;border-radius:50%;background:${s.dot};display:inline-block;"></span>
                            ${s.label}
                        </span>
                        <span class="pipe-count">${cards.length}</span>
                    </div>
                    <div class="pipe-body">
                        ${cards.length ? cards.map(c => pipeCard(c)).join('') : '<div class="pipe-empty">Empty</div>'}
                    </div>
                </div>`;
        }).join('');
    }

    function pipeCard(c) {
        const score = c.auditScore || c.initialAudit?.auditScore || 0;
        const scoreClass = score < 45 ? 'score-poor' : score < 65 ? 'score-fair' : 'score-good';
        return `
            <div class="pipe-card" onclick="showDetail('${c.id}')">
                <div class="pipe-biz">${esc(c.business?.name || 'â€”')}</div>
                <div class="pipe-meta">${esc(c.business?.city || '')} Â· ${esc(c.business?.type || '')}</div>
                ${score ? `<span class="pipe-score ${scoreClass}">Score: ${score}</span>` : ''}
                <span class="plan-badge plan-${c.plan}">${c.plan}</span>
            </div>`;
    }

    // â”€â”€ Table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderTable(subs) {
        document.getElementById('submission-count').textContent = `${subs.length} submission${subs.length !== 1 ? 's' : ''}`;
        const tbody = document.getElementById('clients-body');

        if (!subs.length) {
            tbody.innerHTML = `
                <tr><td colspan="7">
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ“­</div>
                        <div class="empty-title">No submissions yet</div>
                        <div class="empty-sub">Share the <a href="/onboard" style="color:var(--blue);">onboarding link</a> to start getting clients.</div>
                    </div>
                </td></tr>`;
            return;
        }

        tbody.innerHTML = subs.map(c => {
            const score = c.auditScore || c.initialAudit?.auditScore || 0;
            const scoreClass = score < 45 ? 'score-poor' : score < 65 ? 'score-fair' : 'score-good';
            const barColor = score < 45 ? '#ef4444' : score < 65 ? '#f59e0b' : '#10b981';
            const date = new Date(c.submittedAt).toLocaleDateString('en-US', { month:'short', day:'numeric', year:'2-digit' });
            return `
                <tr>
                    <td>
                        <div class="biz-name">${esc(c.business?.name || 'â€”')}</div>
                        <div class="biz-type">${esc(c.business?.type || '')} Â· ${esc(c.business?.city || '')}</div>
                    </td>
                    <td>
                        <div>${esc(c.contact?.firstName || '')} ${esc(c.contact?.lastName || '')}</div>
                        <div style="font-size:0.75rem;color:var(--muted);">${esc(c.contact?.email || '')}</div>
                    </td>
                    <td><span class="plan-badge plan-${c.plan}" style="font-size:0.75rem;">${c.plan} Â· $${c.price}/mo</span></td>
                    <td>
                        ${score ? `
                            <span class="pipe-score ${scoreClass}">${score}</span>
                            <div class="audit-bar" style="width:80px;">
                                <div class="audit-bar-fill" style="width:${score}%;background:${barColor}"></div>
                            </div>` : '<span style="color:var(--muted);font-size:0.78rem;">Pending</span>'}
                    </td>
                    <td>
                        <select class="status-select" data-id="${c.id}" onchange="updateStatus(this)">
                            <option value="new"       ${c.status==='new'       ?'selected':''}>ğŸ”µ New</option>
                            <option value="contacted" ${c.status==='contacted' ?'selected':''}>ğŸŸ¡ Contacted</option>
                            <option value="active"    ${c.status==='active'    ?'selected':''}>ğŸŸ¢ Active</option>
                            <option value="churned"   ${c.status==='churned'   ?'selected':''}>ğŸ”´ Churned</option>
                        </select>
                    </td>
                    <td style="font-size:0.78rem;color:var(--muted);">${date}</td>
                    <td>
                        <button onclick="showDetail('${c.id}')" style="background:none;border:1px solid var(--border);border-radius:5px;padding:4px 10px;font-size:0.75rem;cursor:pointer;">View â†’</button>
                    </td>
                </tr>`;
        }).join('');
    }

    // â”€â”€ Status update â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function updateStatus(select) {
        const id     = select.dataset.id;
        const status = select.value;
        try {
            await fetch(`/api/digital/onboard/${id}/status`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json', 'x-api-key': API_KEY },
                body: JSON.stringify({ status })
            });
            const sub = allSubmissions.find(s => String(s.id) === String(id));
            if (sub) sub.status = status;
            renderPipeline(allSubmissions);
        } catch (e) {
            console.error('Status update failed:', e);
        }
    }

    // â”€â”€ Detail modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function showDetail(id) {
        const c = allSubmissions.find(s => String(s.id) === String(id));
        if (!c) return;
        currentDetail = c;

        document.getElementById('modal-biz-name').textContent =
            `${c.business?.name || 'Client'} â€” ${c.plan?.toUpperCase()} $${c.price}/mo`;

        const audit = c.initialAudit || {};
        const score = c.auditScore || audit.auditScore || 0;
        const bd    = audit.breakdown || {};
        const recs  = audit.recommendations || [];

        document.getElementById('modal-body').innerHTML = `
            <div class="detail-grid">
                <div class="detail-item"><label>Business</label><div class="val">${esc(c.business?.name)}</div></div>
                <div class="detail-item"><label>Type</label><div class="val">${esc(c.business?.type)}</div></div>
                <div class="detail-item"><label>City</label><div class="val">${esc(c.business?.city)}</div></div>
                <div class="detail-item"><label>Phone</label><div class="val">${esc(c.business?.phone || 'â€”')}</div></div>
                <div class="detail-item"><label>Website</label><div class="val">${c.business?.website ? `<a href="https://${c.business.website}" target="_blank" style="color:var(--blue);">${esc(c.business.website)}</a>` : 'â€”'}</div></div>
                <div class="detail-item"><label>GMB URL</label><div class="val">${c.business?.gmbUrl ? `<a href="${esc(c.business.gmbUrl)}" target="_blank" style="color:var(--blue);">View â†’</a>` : 'â€”'}</div></div>
                <div class="detail-item"><label>Contact</label><div class="val">${esc(c.contact?.firstName)} ${esc(c.contact?.lastName)}</div></div>
                <div class="detail-item"><label>Email</label><div class="val">${esc(c.contact?.email)}</div></div>
                <div class="detail-item"><label>Submitted</label><div class="val">${new Date(c.submittedAt).toLocaleString()}</div></div>
                <div class="detail-item"><label>Pain Point</label><div class="val" style="font-style:italic;color:var(--muted);">${esc(c.contact?.painPoint || 'Not provided')}</div></div>
            </div>

            ${score ? `
                <h4 style="font-size:0.85rem;font-weight:700;margin-bottom:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.04em;">GMB Audit Results</h4>
                <div class="breakdown-grid">
                    ${Object.entries(bd).map(([k,v]) => {
                        const s = v.score || 0;
                        const c = s < 45 ? '#ef4444' : s < 65 ? '#f59e0b' : '#10b981';
                        return `<div class="breakdown-cell"><div class="breakdown-num" style="color:${c}">${s}</div><div class="breakdown-cat">${k}</div></div>`;
                    }).join('')}
                </div>
                ${recs.length ? `
                    <h4 style="font-size:0.85rem;font-weight:700;margin-bottom:8px;color:var(--muted);text-transform:uppercase;letter-spacing:.04em;">Recommendations</h4>
                    <div>${recs.map(r => `<div class="rec-row"><span class="rec-badge ${r.priority}">${r.priority}</span><span>${esc(r.issue)}</span></div>`).join('')}</div>
                ` : ''}
            ` : '<p style="color:var(--muted);font-style:italic;">No audit data available yet.</p>'}
        `;

        document.getElementById('detail-modal').classList.add('open');
    }

    function closeModal() { document.getElementById('detail-modal').classList.remove('open'); }

    // â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function esc(s) {
        return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    document.getElementById('detail-modal').addEventListener('click', e => {
        if (e.target === e.currentTarget) closeModal();
    });
    document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });
</script>
</body>
</html>
