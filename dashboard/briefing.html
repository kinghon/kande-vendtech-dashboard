<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Morning Briefing ‚Äî Kande VendTech</title>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  :root {
    --bg: #f8f9fa;
    --card: #ffffff;
    --border: #e2e8f0;
    --text: #1a1a1a;
    --muted: #64748b;
    --accent: #3b82f6;
    --green: #10b981;
    --yellow: #f59e0b;
    --red: #ef4444;
    --orange: #f97316;
    --purple: #8b5cf6;
    --shadow: 0 1px 3px rgba(0,0,0,0.08);
    --shadow-md: 0 4px 12px rgba(0,0,0,0.10);
  }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }

  /* NAV */
  nav { background: var(--card); border-bottom: 1px solid var(--border); padding: 0 24px; height: 56px; display: flex; align-items: center; gap: 8px; position: sticky; top: 0; z-index: 100; box-shadow: var(--shadow); }
  .nav-logo { font-weight: 700; font-size: 1rem; color: var(--accent); margin-right: 8px; text-decoration: none; white-space: nowrap; }
  .nav-div  { width: 1px; height: 20px; background: var(--border); margin: 0 8px; }
  nav a { color: var(--muted); text-decoration: none; font-size: 0.875rem; padding: 6px 10px; border-radius: 6px; transition: all .15s; white-space: nowrap; }
  nav a:hover, nav a.active { background: #f1f5f9; color: var(--text); }
  .nav-badge { background: var(--red); color: #fff; font-size: 0.65rem; font-weight: 700; padding: 1px 5px; border-radius: 10px; margin-left: 3px; vertical-align: middle; }

  /* LAYOUT */
  .page { max-width: 1280px; margin: 0 auto; padding: 24px; }

  /* HEADER */
  .brief-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; flex-wrap: wrap; gap: 12px; }
  .brief-title  { font-size: 1.6rem; font-weight: 700; display: flex; align-items: center; gap: 10px; }
  .brief-meta   { font-size: 0.85rem; color: var(--muted); margin-top: 2px; }
  .brief-clock  { font-size: 1.5rem; font-weight: 700; color: var(--accent); font-variant-numeric: tabular-nums; }
  .refresh-btn  { padding: 8px 16px; border-radius: 8px; font-size: 0.8rem; font-weight: 600; border: 1px solid var(--border); background: var(--card); color: var(--muted); cursor: pointer; transition: all .15s; }
  .refresh-btn:hover { background: #f1f5f9; color: var(--text); }

  /* MARY BANNER */
  .mary-banner { border-radius: 10px; padding: 14px 20px; margin-bottom: 20px; display: flex; align-items: center; gap: 16px; }
  .mary-banner.ok       { background: #f0fdf4; border: 1px solid #bbf7d0; }
  .mary-banner.alert    { background: #fffbeb; border: 1px solid #fde68a; }
  .mary-banner.critical { background: #fff1f0; border: 1px solid #fecaca; animation: pulse-red 2s infinite; }
  @keyframes pulse-red { 0%,100%{ border-color:#fecaca; } 50%{ border-color:#f87171; } }
  .mary-icon   { font-size: 1.5rem; flex-shrink: 0; }
  .mary-title  { font-weight: 700; font-size: 0.95rem; }
  .mary-detail { font-size: 0.8rem; color: var(--muted); margin-top: 2px; }

  /* STATS ROW */
  .stats-row { display: grid; grid-template-columns: repeat(5, 1fr); gap: 14px; margin-bottom: 20px; }
  @media (max-width:900px) { .stats-row { grid-template-columns: repeat(3,1fr); } }
  @media (max-width:600px) { .stats-row { grid-template-columns: repeat(2,1fr); } }
  .stat { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 16px; box-shadow: var(--shadow); }
  .stat-label { font-size: 0.7rem; color: var(--muted); font-weight: 600; text-transform: uppercase; letter-spacing: .05em; margin-bottom: 6px; }
  .stat-value { font-size: 1.7rem; font-weight: 700; line-height: 1; }
  .stat-sub   { font-size: 0.72rem; color: var(--muted); margin-top: 4px; }
  .v-blue   { color: var(--accent); }
  .v-green  { color: var(--green); }
  .v-yellow { color: var(--yellow); }
  .v-red    { color: var(--red); }
  .v-purple { color: var(--purple); }

  /* MAIN GRID */
  .main-grid { display: grid; grid-template-columns: 1fr 360px; gap: 18px; }
  @media (max-width:1100px) { .main-grid { grid-template-columns: 1fr; } }

  /* SECTION */
  .section { background: var(--card); border: 1px solid var(--border); border-radius: 12px; box-shadow: var(--shadow); overflow: hidden; margin-bottom: 18px; }
  .sec-head { padding: 14px 18px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; gap: 8px; }
  .sec-title { font-weight: 700; font-size: 0.9rem; display: flex; align-items: center; gap: 7px; }
  .sec-body  { padding: 16px 18px; }
  .count-badge { background: var(--red); color: #fff; font-size: 0.65rem; font-weight: 700; padding: 1px 6px; border-radius: 10px; }
  .count-badge.yellow { background: var(--yellow); }
  .count-badge.blue { background: var(--accent); }

  /* ALERT ROWS */
  .alert-row { display: flex; align-items: flex-start; gap: 12px; padding: 11px 0; border-bottom: 1px solid #f1f5f9; }
  .alert-row:last-child { border-bottom: none; }
  .alert-dot  { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; margin-top: 5px; }
  .dot-red    { background: var(--red); }
  .dot-yellow { background: var(--yellow); }
  .dot-blue   { background: var(--accent); }
  .dot-green  { background: var(--green); }
  .alert-body { flex: 1; min-width: 0; }
  .alert-name { font-weight: 600; font-size: 0.875rem; color: var(--text); }
  .alert-msg  { font-size: 0.775rem; color: var(--muted); margin-top: 3px; line-height: 1.4; }
  .alert-tags { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 5px; }
  .tag { font-size: 0.67rem; font-weight: 600; padding: 1px 6px; border-radius: 6px; }
  .tag-red    { background: #fee2e2; color: #991b1b; }
  .tag-yellow { background: #fef3c7; color: #92400e; }
  .tag-blue   { background: #dbeafe; color: #1e40af; }
  .tag-green  { background: #d1fae5; color: #065f46; }
  .tag-purple { background: #ede9fe; color: #5b21b6; }

  /* ACTION ITEMS */
  .action-row { display: flex; align-items: flex-start; gap: 10px; padding: 10px 0; border-bottom: 1px solid #f1f5f9; }
  .action-row:last-child { border-bottom: none; }
  .action-num { width: 22px; height: 22px; border-radius: 50%; background: var(--accent); color: #fff; font-size: 0.7rem; font-weight: 700; display: flex; align-items: center; justify-content: center; flex-shrink: 0; margin-top: 1px; }
  .action-num.red    { background: var(--red); }
  .action-num.yellow { background: var(--yellow); }
  .action-num.green  { background: var(--green); }
  .action-num.purple { background: var(--purple); }
  .action-body { flex: 1; }
  .action-title  { font-weight: 600; font-size: 0.875rem; color: var(--text); }
  .action-detail { font-size: 0.775rem; color: var(--muted); margin-top: 3px; line-height: 1.5; }
  .action-meta   { font-size: 0.7rem; color: var(--muted); margin-top: 4px; }

  /* HOT LEAD ROWS */
  .lead-row { display: flex; align-items: flex-start; gap: 10px; padding: 10px 0; border-bottom: 1px solid #f1f5f9; }
  .lead-row:last-child { border-bottom: none; }
  .lead-rank { width: 26px; height: 26px; border-radius: 8px; background: #f1f5f9; font-size: 0.75rem; font-weight: 700; display: flex; align-items: center; justify-content: center; flex-shrink: 0; color: var(--muted); }
  .lead-rank.r1 { background: #fee2e2; color: var(--red); }
  .lead-rank.r2 { background: #fef3c7; color: #92400e; }
  .lead-rank.r3 { background: #fef3c7; color: #92400e; }
  .lead-body { flex: 1; }
  .lead-name   { font-weight: 600; font-size: 0.875rem; }
  .lead-detail { font-size: 0.775rem; color: var(--muted); margin-top: 3px; line-height: 1.4; }

  /* MINI STATS */
  .mini-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px; }
  .mini-stat { background: #f8f9fa; border: 1px solid var(--border); border-radius: 8px; padding: 12px; text-align: center; }
  .mini-label { font-size: 0.68rem; color: var(--muted); font-weight: 600; text-transform: uppercase; letter-spacing: .04em; margin-bottom: 4px; }
  .mini-value { font-size: 1.3rem; font-weight: 700; }

  /* NEW PROSPECTS */
  .prospect-row { display: flex; align-items: center; gap: 10px; padding: 8px 0; border-bottom: 1px solid #f1f5f9; font-size: 0.8rem; }
  .prospect-row:last-child { border-bottom: none; }
  .prospect-name { font-weight: 600; flex: 1; }
  .status-pill { font-size: 0.68rem; font-weight: 600; padding: 2px 7px; border-radius: 8px; white-space: nowrap; }
  .s-new        { background: #f1f5f9; color: #475569; }
  .s-active     { background: #d1fae5; color: #065f46; }
  .s-opening    { background: #fef3c7; color: #92400e; }
  .s-proposal   { background: #dbeafe; color: #1e40af; }

  /* FORECAST BAR */
  .tier-bar-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; font-size: 0.8rem; }
  .tier-bar-label { width: 100px; color: var(--muted); font-size: 0.75rem; }
  .tier-bar-track { flex: 1; height: 8px; background: #f1f5f9; border-radius: 4px; overflow: hidden; }
  .tier-bar-fill  { height: 100%; border-radius: 4px; transition: width .6s ease; }
  .tier-bar-val { font-weight: 600; width: 54px; text-align: right; }

  /* AGENT GRID */
  .agent-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
  .agent-card { background: #f8f9fa; border: 1px solid var(--border); border-radius: 8px; padding: 10px 12px; display: flex; align-items: center; gap: 8px; }
  .agent-dot  { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
  .agent-name { font-weight: 600; font-size: 0.775rem; color: var(--text); }
  .agent-status { font-size: 0.7rem; color: var(--muted); margin-top: 1px; }

  /* LOADING */
  .loading { text-align: center; padding: 24px; color: var(--muted); font-size: 0.8rem; }
  .spin { display: inline-block; width: 16px; height: 16px; border: 2px solid #e2e8f0; border-top-color: var(--accent); border-radius: 50%; animation: spin .7s linear infinite; margin-right: 6px; vertical-align: middle; }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* DIFF */
  .diff-row { display: flex; align-items: center; gap: 8px; padding: 8px 0; border-bottom: 1px solid #f1f5f9; font-size: 0.8rem; }
  .diff-row:last-child { border-bottom: none; }
  .diff-name  { font-weight: 600; flex: 1; }
  .diff-arrow { color: var(--green); font-weight: 700; font-size: 0.9rem; }

  .empty-state { text-align: center; padding: 20px; color: var(--muted); font-size: 0.8rem; }

  .footer { text-align: center; color: var(--muted); font-size: 0.72rem; padding: 20px 0 8px; }
</style>
</head>
<body>

<nav>
  <a href="/" class="nav-logo">‚ö° Kande</a>
  <div class="nav-div"></div>
  <a href="/briefing" class="active">Briefing</a>
  <a href="/account-tiers">Tiers</a>
  <a href="/scout-intel">Scout Intel</a>
  <div class="nav-div"></div>
  <a href="/team">Team</a>
  <a href="/tasks">Tasks</a>
  <a href="/calendar">Calendar</a>
  <a href="/office">Office</a>
</nav>

<div class="page">

  <!-- Header -->
  <div class="brief-header">
    <div>
      <div class="brief-title">‚òÄÔ∏è Morning Command Center</div>
      <div class="brief-meta" id="brief-date">Loading‚Ä¶</div>
    </div>
    <div style="display:flex;align-items:center;gap:14px;">
      <div class="brief-clock" id="live-clock">‚Äî</div>
      <button class="refresh-btn" onclick="loadAll()">‚Üª Refresh</button>
    </div>
  </div>

  <!-- Mary Status Banner -->
  <div class="mary-banner" id="mary-banner" style="display:none;"></div>

  <!-- Stats Row -->
  <div class="stats-row" id="stats-row">
    <div class="stat"><div class="stat-label">Pipeline Accounts</div><div class="stat-value v-blue" id="s-pipeline">‚Äî</div><div class="stat-sub">Proposal + Active + Negotiating</div></div>
    <div class="stat"><div class="stat-label">Phone Pivots Due</div><div class="stat-value v-red" id="s-pivots">‚Äî</div><div class="stat-sub">Overdue escalations</div></div>
    <div class="stat"><div class="stat-label">Hot Signals</div><div class="stat-value v-yellow" id="s-hot">‚Äî</div><div class="stat-sub">External opens / replies</div></div>
    <div class="stat"><div class="stat-label">Pipeline MRR</div><div class="stat-value v-green" id="s-mrr">‚Äî</div><div class="stat-sub">If all tagged accounts close</div></div>
    <div class="stat"><div class="stat-label">New This Week</div><div class="stat-value v-purple" id="s-new">‚Äî</div><div class="stat-sub">Added to CRM</div></div>
  </div>

  <div class="main-grid">

    <!-- Left column -->
    <div>

      <!-- URGENT: Engagement Alerts -->
      <div class="section">
        <div class="sec-head">
          <div class="sec-title">üö® Engagement Alerts <span class="count-badge" id="alert-count">‚Ä¶</span></div>
          <span style="font-size:0.72rem;color:var(--muted);">Phone pivots ¬∑ Hot opens ¬∑ Stale proposals</span>
        </div>
        <div class="sec-body" id="alerts-body">
          <div class="loading"><span class="spin"></span>Loading alerts‚Ä¶</div>
        </div>
      </div>

      <!-- Monday Action Items -->
      <div class="section">
        <div class="sec-head">
          <div class="sec-title">üìã Monday Action Items ‚Äî In Order</div>
          <span style="font-size:0.72rem;color:var(--muted);">Feb 23</span>
        </div>
        <div class="sec-body">
          <div class="action-row">
            <div class="action-num r1">1</div>
            <div class="action-body">
              <div class="action-title">Carnegie Heights / BWLiving (5050) ‚Äî Contract Stage</div>
              <div class="action-detail">Light nudge to Jeannie/Makenna: "Happy to answer logistics questions before you finalize." Map approver chain (who signs above Makenna?) BEFORE sending contract.</div>
              <div class="action-meta" style="color:var(--green);">üíé Portfolio Brand Program tier ¬∑ Negotiating</div>
            </div>
          </div>
          <div class="action-row">
            <div class="action-num r2">2</div>
            <div class="action-body">
              <div class="action-title">üìû Lyric / RPM Living (531) ‚Äî Call Mirtha Valenzuela</div>
              <div class="action-detail">8 external opens. RPM manages Lyric + Watermark ‚Äî portfolio play. Pitch as "branded resident amenity program" not "vending machine."</div>
              <div class="action-meta" style="color:var(--purple);">üíé Portfolio target ¬∑ Lyric + Watermark</div>
            </div>
          </div>
          <div class="action-row">
            <div class="action-num r2">3</div>
            <div class="action-body">
              <div class="action-title">üìû Ilumina (67) ‚Äî PHONE CALL. No More Delays.</div>
              <div class="action-detail">6 external opens over 28+ days. Email exhausted. This is MANDATORY. Proven interest, wrong approach. Call today.</div>
              <div class="action-meta" style="color:var(--red);">üö® 28 days overdue ¬∑ Email saturated</div>
            </div>
          </div>
          <div class="action-row">
            <div class="action-num">4</div>
            <div class="action-body">
              <div class="action-title">üìû High Line at Hughes (11) ‚Äî Call Peter/Jose</div>
              <div class="action-detail">9+ days stale. Was a HOT pop-in with full property walk. Jose was expected back 2/17 ‚Äî follow-up date MISSED.</div>
              <div class="action-meta">BH Living portfolio</div>
            </div>
          </div>
          <div class="action-row">
            <div class="action-num">5</div>
            <div class="action-body">
              <div class="action-title">üìû Oakmont of The Lakes (540) ‚Äî Resend + Call</div>
              <div class="action-detail">10+ days stale. No opens, no reply. Call daalgaard@oakmontmg.com after resending Instantly email.</div>
              <div class="action-meta">Senior living ¬∑ Strong vertical</div>
            </div>
          </div>
          <div class="action-row" style="border-bottom:none;">
            <div class="action-num">6</div>
            <div class="action-body">
              <div class="action-title">üîç Jade Apartments (29) ‚Äî Verify Contract Status</div>
              <div class="action-detail">Contract sent 10+ days ago. External PM re-engagement Feb 19 = possible re-open or renewal signal.</div>
              <div class="action-meta">Contract sent ¬∑ Verify signed vs. stalled</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Monday Call Sheet Panel -->
      <div class="section">
        <div class="sec-head">
          <div class="sec-title">üìû Prepared Call Sheet</div>
          <a href="/call-sheet" style="font-size:0.78rem;color:var(--accent);text-decoration:none;font-weight:600;">Open Full Sheet ‚Üí</a>
        </div>
        <div class="sec-body" id="call-sheet-body">
          <div class="loading"><span class="spin"></span>Loading...</div>
        </div>
      </div>

      <!-- Employer Segment Activation -->
      <div class="section">
        <div class="sec-head">
          <div class="sec-title">üè≠ Employer Segment ‚Äî This Week</div>
          <span class="count-badge yellow">NEW</span>
        </div>
        <div class="sec-body">
          <div style="font-size:0.78rem;color:var(--muted);margin-bottom:12px;padding:8px 10px;background:#fffbeb;border:1px solid #fde68a;border-radius:8px;">
            ‚ö†Ô∏è <strong>Different pitch track required.</strong> These are shift workers / break room amenities ‚Äî NOT residential amenity pitches. Wrong script = dead call.
          </div>
          <div class="action-row">
            <div class="action-num yellow">A</div>
            <div class="action-body">
              <div class="action-title">Gemma Las Vegas (4907) ‚Äî NOW LEASING üî•</div>
              <div class="action-detail">337 units confirmed NOW LEASING as of Feb 21. Call (725) 258-2560 ‚Äî 7-day vendor selection window open. Scout ‚Üí Relay same-day handoff.</div>
              <div class="action-meta" style="color:var(--red);">‚è± Window closes ~Feb 28</div>
            </div>
          </div>
          <div class="action-row">
            <div class="action-num">B</div>
            <div class="action-body">
              <div class="action-title">Paysign Inc (5571) ‚Äî 345 Employees, 2 Locations</div>
              <div class="action-detail">Never contacted. 345 employees across 2 Henderson locations. Call (702) 706-9901. Break room pitch: shift workers, high-volume throughput.</div>
            </div>
          </div>
          <div class="action-row">
            <div class="action-num">C</div>
            <div class="action-body">
              <div class="action-title">Rapid Response Monitoring (5879) ‚Äî 148 Employees, 24/7</div>
              <div class="action-detail">HOT new lead. Security call center, 3 shifts, GOED-approved 148 new jobs. Call (800) 558-7767. Scout researching facilities contact.</div>
              <div class="action-meta" style="color:var(--green);">New lead Feb 21 ¬∑ 24/7 = highest vending throughput</div>
            </div>
          </div>
          <div class="action-row" style="border-bottom:none;">
            <div class="action-num">D</div>
            <div class="action-body">
              <div class="action-title">TensorWave ‚Äî 100 Employees, $100M Funded</div>
              <div class="action-detail">AI company, phone approach only (tech vertical). Research operations/facilities contact before calling. Unclaimed vertical ‚Äî no Instantly sequence.</div>
              <div class="action-meta" style="color:var(--purple);">Phone only ¬∑ Tech vertical</div>
            </div>
          </div>
        </div>
      </div>

      <!-- CRM Status Changes -->
      <div class="section">
        <div class="sec-head">
          <div class="sec-title">üîÑ CRM Status Changes</div>
          <span style="font-size:0.72rem;color:var(--muted);">Since last snapshot</span>
        </div>
        <div class="sec-body" id="diff-body">
          <div class="loading"><span class="spin"></span>Checking‚Ä¶</div>
        </div>
      </div>

    </div><!-- /left -->

    <!-- Right column: sidebar -->
    <div>

      <!-- Hot Lead Priority -->
      <div class="section">
        <div class="sec-head">
          <div class="sec-title">‚ö° Hot Lead Priority</div>
          <span style="font-size:0.72rem;color:var(--muted);">Updated Feb 21</span>
        </div>
        <div class="sec-body">
          <div class="lead-row">
            <div class="lead-rank r1">1</div>
            <div class="lead-body">
              <div class="lead-name">Aspire / Ovation (116) üèÜ</div>
              <div class="lead-detail">Jennifer replied. In corporate training next week. 36 communities. <strong>Kurtis: tonight email required.</strong></div>
            </div>
          </div>
          <div class="lead-row">
            <div class="lead-rank r2">2</div>
            <div class="lead-body">
              <div class="lead-name">Carnegie Heights (5050) ü§ù</div>
              <div class="lead-detail">ED "loves it." Contract stage. Map approver chain first.</div>
            </div>
          </div>
          <div class="lead-row">
            <div class="lead-rank r2">3</div>
            <div class="lead-body">
              <div class="lead-name">Lyric / RPM Living (531)</div>
              <div class="lead-detail">8 external opens. Portfolio play ‚Äî Lyric + Watermark.</div>
            </div>
          </div>
          <div class="lead-row">
            <div class="lead-rank r2">4</div>
            <div class="lead-body">
              <div class="lead-name">Ilumina (67) üö®</div>
              <div class="lead-detail">6 external opens, 28 days overdue. CALL MONDAY.</div>
            </div>
          </div>
          <div class="lead-row">
            <div class="lead-rank">5</div>
            <div class="lead-body">
              <div class="lead-name">Gemma Las Vegas (4907)</div>
              <div class="lead-detail">NOW LEASING. 337 units. 7-day window.</div>
            </div>
          </div>
          <div class="lead-row">
            <div class="lead-rank">6</div>
            <div class="lead-body">
              <div class="lead-name">Jade Apartments (29)</div>
              <div class="lead-detail">Contract sent 10 days ago. Verify status.</div>
            </div>
          </div>
          <div class="lead-row">
            <div class="lead-rank">7</div>
            <div class="lead-body">
              <div class="lead-name">Paysign Inc (5571)</div>
              <div class="lead-detail">345 employees, 2 Henderson locations, never contacted.</div>
            </div>
          </div>
          <div class="lead-row" style="border-bottom:none;">
            <div class="lead-rank">8</div>
            <div class="lead-body">
              <div class="lead-name">Rapid Response (5879)</div>
              <div class="lead-detail">148 employees, 24/7. Scout researching contact.</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Pipeline MRR Forecast -->
      <div class="section">
        <div class="sec-head">
          <div class="sec-title">üíé Revenue Tier Forecast</div>
          <a href="/account-tiers" style="font-size:0.75rem;color:var(--accent);text-decoration:none;font-weight:600;">Tag accounts ‚Üí</a>
        </div>
        <div class="sec-body" id="tiers-body">
          <div class="loading"><span class="spin"></span>Loading‚Ä¶</div>
        </div>
      </div>

      <!-- New Prospects This Week -->
      <div class="section">
        <div class="sec-head">
          <div class="sec-title">üÜï New This Week</div>
          <span style="font-size:0.72rem;color:var(--muted);" id="new-count-label">‚Ä¶</span>
        </div>
        <div class="sec-body" id="new-prospects-body">
          <div class="loading"><span class="spin"></span>Loading‚Ä¶</div>
        </div>
      </div>

      <!-- Team Agent Status -->
      <div class="section">
        <div class="sec-head">
          <div class="sec-title">ü§ñ Agent Status</div>
          <a href="/office" style="font-size:0.75rem;color:var(--accent);text-decoration:none;font-weight:600;">Office view ‚Üí</a>
        </div>
        <div class="sec-body" id="agents-body">
          <div class="loading"><span class="spin"></span>Loading‚Ä¶</div>
        </div>
      </div>

    </div><!-- /right -->
  </div><!-- /main-grid -->

  <div class="footer">Morning Briefing ¬∑ Kande Mission Control ¬∑ Auto-refreshes every 5 minutes ¬∑ <span id="last-refresh">‚Äî</span></div>

</div><!-- /page -->

<script>
const KEY = 'kande2026';
const TIER_MRR = { standard: 400, custom: 700, portfolio: 12000 };

function fmtMrr(n) {
  if (!n) return '$0';
  if (n >= 1000000) return '$' + (n/1000000).toFixed(1) + 'M';
  if (n >= 1000) return '$' + (n/1000).toFixed(n % 1000 === 0 ? 0 : 1) + 'K';
  return '$' + n.toLocaleString();
}

function esc(s) {
  return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

function now_pt() {
  return new Date().toLocaleString('en-US', { timeZone: 'America/Los_Angeles', weekday:'long', month:'long', day:'numeric', year:'numeric' });
}

// Clock
function tickClock() {
  const t = new Date().toLocaleTimeString('en-US', { timeZone: 'America/Los_Angeles', hour:'numeric', minute:'2-digit', hour12: true });
  document.getElementById('live-clock').textContent = t;
}
setInterval(tickClock, 1000);
tickClock();
document.getElementById('brief-date').textContent = now_pt();

// Mary status
async function loadMary() {
  try {
    const r = await fetch('/api/monitoring/pb-inbox', { headers: { 'x-api-key': KEY } });
    const d = await r.json();
    const banner = document.getElementById('mary-banner');
    banner.style.display = 'flex';
    if (d.status === 'ok') {
      banner.className = 'mary-banner ok';
      banner.innerHTML = `<div class="mary-icon">‚úÖ</div><div><div class="mary-title">Mary is operational</div><div class="mary-detail">PB inbox file created today ¬∑ Gmail sync running normally</div></div>`;
    } else if (d.status === 'critical') {
      banner.className = 'mary-banner critical';
      banner.innerHTML = `<div class="mary-icon">üö®</div><div><div class="mary-title">CRITICAL: Mary offline for ${d.daysSinceLast} days ‚Äî March wedding season starts in ~8 days</div><div class="mary-detail">${esc(d.message)} ¬∑ Root cause diagnosis needed from Kurtis</div></div>`;
    } else {
      banner.className = 'mary-banner alert';
      banner.innerHTML = `<div class="mary-icon">‚ö†Ô∏è</div><div><div class="mary-title">Mary alert ‚Äî no inbox file for today</div><div class="mary-detail">${esc(d.message)}</div></div>`;
    }
  } catch (e) { /* silent fail on banner */ }
}

// Engagement alerts
async function loadAlerts() {
  const body = document.getElementById('alerts-body');
  try {
    const r = await fetch('/api/pipeline/engagement-alerts', { headers: { 'x-api-key': KEY } });
    const d = await r.json();
    const alerts = d.alerts || [];
    const stats  = d.stats  || {};

    document.getElementById('s-pivots').textContent = stats.needsPhonePivot || 0;
    document.getElementById('s-hot').textContent    = stats.hotLeads || 0;
    document.getElementById('alert-count').textContent = alerts.length;

    if (alerts.length === 0) {
      body.innerHTML = '<div class="empty-state">‚úÖ No active alerts ‚Äî pipeline is clean.</div>';
      return;
    }

    body.innerHTML = alerts.map(a => {
      const dotClass = a.level === 'urgent' ? 'dot-red' : a.level === 'hot' ? 'dot-yellow' : 'dot-blue';
      const tags = (a.tags || []).map(t => {
        const cls = t.toLowerCase().includes('urgent') || t.toLowerCase().includes('overdue') ? 'tag-red'
          : t.toLowerCase().includes('hot') || t.toLowerCase().includes('click') ? 'tag-yellow'
          : 'tag-blue';
        return `<span class="tag ${cls}">${esc(t)}</span>`;
      }).join('');
      return `<div class="alert-row">
        <div class="alert-dot ${dotClass}"></div>
        <div class="alert-body">
          <div class="alert-name">${esc(a.title || a.prospect)}</div>
          <div class="alert-msg">${esc(a.message || a.detail)}</div>
          ${tags ? `<div class="alert-tags">${tags}</div>` : ''}
        </div>
      </div>`;
    }).join('');
  } catch (e) {
    body.innerHTML = `<div style="color:var(--red);font-size:0.8rem;padding:8px;">Failed to load alerts: ${e.message}</div>`;
  }
}

// Account tiers
async function loadTiers() {
  const body = document.getElementById('tiers-body');
  try {
    const r = await fetch('/api/pipeline/account-tiers', { headers: { 'x-api-key': KEY } });
    const d = await r.json();
    const counts = d.counts || {};
    const mrr    = d.totalMrr || 0;
    const size   = d.pipelineSize || 0;

    document.getElementById('s-pipeline').textContent = size;
    document.getElementById('s-mrr').textContent = fmtMrr(mrr);

    const stdMrr  = (counts.standard  || 0) * 400;
    const custMrr = (counts.custom    || 0) * 700;
    const portMrr = (counts.portfolio || 0) * 12000;
    const maxMrr  = Math.max(stdMrr, custMrr, portMrr, 1);
    const unset   = counts.unset || 0;

    body.innerHTML = `
      <div class="mini-grid" style="margin-bottom:14px;">
        <div class="mini-stat"><div class="mini-label">Portfolio Progs</div><div class="mini-value v-purple">${counts.portfolio || 0}</div></div>
        <div class="mini-stat"><div class="mini-label">Custom Wrap</div><div class="mini-value v-yellow">${counts.custom || 0}</div></div>
        <div class="mini-stat"><div class="mini-label">Standard</div><div class="mini-value">${counts.standard || 0}</div></div>
        <div class="mini-stat"><div class="mini-label">Untagged</div><div class="mini-value v-red">${unset}</div></div>
      </div>
      <div class="tier-bar-row">
        <div class="tier-bar-label">Portfolio</div>
        <div class="tier-bar-track"><div class="tier-bar-fill" style="background:var(--purple);width:${portMrr/maxMrr*100}%;"></div></div>
        <div class="tier-bar-val v-purple">${fmtMrr(portMrr)}</div>
      </div>
      <div class="tier-bar-row">
        <div class="tier-bar-label">Custom Wrap</div>
        <div class="tier-bar-track"><div class="tier-bar-fill" style="background:var(--yellow);width:${custMrr/maxMrr*100}%;"></div></div>
        <div class="tier-bar-val v-yellow">${fmtMrr(custMrr)}</div>
      </div>
      <div class="tier-bar-row" style="margin-bottom:12px;">
        <div class="tier-bar-label">Standard</div>
        <div class="tier-bar-track"><div class="tier-bar-fill" style="background:#94a3b8;width:${stdMrr/maxMrr*100}%;"></div></div>
        <div class="tier-bar-val">${fmtMrr(stdMrr)}</div>
      </div>
      <div style="border-top:1px solid var(--border);padding-top:10px;display:flex;justify-content:space-between;font-size:0.8rem;">
        <span style="color:var(--muted);">Total if all close</span>
        <span style="font-weight:700;color:var(--green);">${fmtMrr(mrr)}</span>
      </div>
      ${unset > 0 ? `<div style="margin-top:8px;font-size:0.72rem;color:var(--muted);padding:6px 8px;background:#fffbeb;border-radius:6px;border:1px solid #fde68a;">‚ö†Ô∏è ${unset} accounts untagged ‚Äî <a href="/account-tiers" style="color:var(--accent);">tag them</a> to unlock full forecast</div>` : ''}
    `;
  } catch (e) {
    body.innerHTML = `<div style="color:var(--red);font-size:0.8rem;">Failed: ${e.message}</div>`;
  }
}

// New prospects
async function loadBriefing() {
  const body = document.getElementById('new-prospects-body');
  try {
    const r = await fetch('/api/briefing?period=daily', { headers: { 'x-api-key': KEY } });
    const d = await r.json();
    const newP = (d.newProspects || []).slice(0, 8);
    document.getElementById('s-new').textContent = newP.length;
    document.getElementById('new-count-label').textContent = `${newP.length} added`;

    if (newP.length === 0) {
      body.innerHTML = '<div class="empty-state">No new prospects added today.</div>';
      return;
    }
    const statusClass = s => ({ new:'s-new', active:'s-active', opening_soon:'s-opening', proposal_sent:'s-proposal' }[s] || 's-new');
    const statusLabel = s => ({ new:'New', active:'Active', opening_soon:'Opening Soon', proposal_sent:'Proposal Sent' }[s] || s);
    body.innerHTML = newP.map(p => `
      <div class="prospect-row">
        <div class="prospect-name">${esc(p.name)}</div>
        <span class="status-pill ${statusClass(p.status)}">${statusLabel(p.status)}</span>
      </div>`).join('');
  } catch (e) {
    body.innerHTML = `<div style="color:var(--red);font-size:0.8rem;">Failed: ${e.message}</div>`;
  }
}

// CRM diff
async function loadDiff() {
  const body = document.getElementById('diff-body');
  try {
    const r = await fetch('/api/crm/status-diff', { headers: { 'x-api-key': KEY } });
    const d = await r.json();
    const changes = d.changes || [];
    if (changes.length === 0) {
      body.innerHTML = `<div class="empty-state">‚úÖ No status changes since last snapshot<br><small style="color:var(--muted)">${esc(d.snapshotAge || '')}</small></div>`;
      return;
    }
    const statusLabel = s => ({ new:'New', active:'Active', opening_soon:'Opening Soon', contacted:'Contacted', proposal_sent:'Proposal Sent', negotiating:'Negotiating' }[s] || s);
    body.innerHTML = changes.map(c => `
      <div class="diff-row">
        <div class="diff-name">${esc(c.name)}</div>
        <div style="font-size:0.72rem;color:var(--muted);">${statusLabel(c.from)}</div>
        <div class="diff-arrow">‚Üí</div>
        <div style="font-size:0.72rem;font-weight:600;color:var(--green);">${statusLabel(c.to)}</div>
        ${c.alerted ? '<span style="font-size:0.65rem;color:var(--green);">üì°</span>' : ''}
      </div>`).join('');
    // Advance snapshot after viewing
    fetch('/api/crm/status-diff/snapshot', { method: 'POST', headers: { 'x-api-key': KEY } });
  } catch (e) {
    body.innerHTML = `<div style="color:var(--red);font-size:0.8rem;">Failed: ${e.message}</div>`;
  }
}

// Agent status
async function loadAgents() {
  const body = document.getElementById('agents-body');
  try {
    const r = await fetch('/api/team/status', { headers: { 'x-api-key': KEY } });
    const d = await r.json();
    const AGENTS = ['ralph', 'relay', 'scout', 'mary', 'clawd', 'pixel'];
    const stateColor = s => s === 'working' ? '#10b981' : s === 'error' ? '#ef4444' : '#94a3b8';

    body.innerHTML = `<div class="agent-grid">` + AGENTS.map(name => {
      const info = d[name] || {};
      const state = info.state || 'idle';
      const label = info.statusText || (state === 'working' ? 'Working' : 'Idle');
      return `<div class="agent-card">
        <div class="agent-dot" style="background:${stateColor(state)};"></div>
        <div>
          <div class="agent-name">${name.charAt(0).toUpperCase()+name.slice(1)}</div>
          <div class="agent-status">${esc(label.slice(0,22))}</div>
        </div>
      </div>`;
    }).join('') + `</div>`;
  } catch (e) {
    body.innerHTML = `<div style="font-size:0.8rem;color:var(--muted);">Agent status unavailable</div>`;
  }
}

async function loadCallSheet() {
  const el = document.getElementById('call-sheet-body');
  try {
    const r = await fetch('/api/pipeline/call-sheet', { headers: { 'x-api-key': KEY } });
    const data = await r.json();
    const sheet = (data.callSheet || []).slice(0, 5); // top 5
    const stats = data.stats || {};
    if (sheet.length === 0) {
      el.innerHTML = '<div style="color:var(--muted);font-size:0.82rem;padding:8px">No calls prepared yet. <a href="/call-sheet" style="color:var(--accent)">Open Call Sheet ‚Üí</a></div>';
      return;
    }
    const sigColor = { urgent: 'var(--red)', phone_pivot: 'var(--orange)', hot: 'var(--accent)', warm: 'var(--green)' };
    const sigLabel = { urgent: 'üö®', phone_pivot: 'üìû', hot: 'üî•', warm: 'üü°' };
    const rows = sheet.map(c => {
      const color = sigColor[c.engagement_signal] || 'var(--muted)';
      const sig = sigLabel[c.engagement_signal] || '';
      const checked = c.called ? '‚úÖ' : `<span style="color:${color};font-weight:700">${c.priority}</span>`;
      return `<div style="display:flex;align-items:center;gap:10px;padding:7px 0;border-bottom:1px solid var(--border);${c.called?'opacity:0.5':''}">
        <div style="width:24px;text-align:center;flex-shrink:0;">${checked}</div>
        <div style="flex:1;">
          <div style="font-size:0.82rem;font-weight:600;">${sig} ${c.prospect_name}</div>
          <div style="font-size:0.75rem;color:var(--muted);">${c.engagement_detail||''}</div>
        </div>
        ${c.phone ? `<a href="tel:${c.phone}" style="font-size:0.75rem;color:var(--green);text-decoration:none;flex-shrink:0;">üìû</a>` : ''}
      </div>`;
    }).join('');
    el.innerHTML = `
      <div style="display:flex;gap:16px;margin-bottom:10px;">
        <span style="font-size:0.82rem"><strong style="color:var(--orange)">${stats.pending||0}</strong> pending</span>
        <span style="font-size:0.82rem"><strong style="color:var(--green)">${stats.called||0}</strong> called</span>
        <span style="font-size:0.82rem"><strong style="color:var(--red)">${stats.hotPivots||0}</strong> must-call today</span>
      </div>
      ${rows}
      <div style="margin-top:8px;text-align:right"><a href="/call-sheet" style="font-size:0.78rem;color:var(--accent);font-weight:600;">Full prepared call sheet with openers & objections ‚Üí</a></div>`;
  } catch(e) {
    el.innerHTML = `<div style="color:var(--muted);font-size:0.82rem">Error: ${e.message}</div>`;
  }
}

async function loadAll() {
  await Promise.all([loadMary(), loadAlerts(), loadTiers(), loadBriefing(), loadDiff(), loadAgents(), loadCallSheet()]);
  document.getElementById('last-refresh').textContent = new Date().toLocaleTimeString('en-US', { timeZone: 'America/Los_Angeles', hour:'numeric', minute:'2-digit', hour12:true }) + ' PT';
}

// Auto-refresh every 5 minutes
loadAll();
setInterval(loadAll, 5 * 60 * 1000);
</script>
</body>
</html>
