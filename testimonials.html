<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Testimonials & Social Proof | Kande VendTech</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { 
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; 
      background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
      min-height: 100vh;
      color: #1e293b;
    }
    
    /* Navigation */
    .nav { 
      background: white; 
      padding: 1rem 2rem; 
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      display: flex; 
      align-items: center; 
      gap: 2rem;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .nav-brand { 
      font-weight: 700; 
      font-size: 1.25rem; 
      color: #0ea5e9;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .nav-links { display: flex; gap: 0.5rem; flex-wrap: wrap; }
    .nav-links a, .nav-dropdown { 
      color: #64748b; 
      text-decoration: none; 
      padding: 0.5rem 1rem; 
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 500;
      transition: all 0.2s;
    }
    .nav-links a:hover, .nav-dropdown:hover { background: #f1f5f9; color: #0ea5e9; }
    .nav-links a.active { background: #0ea5e9; color: white; }
    .nav-dropdown { position: relative; cursor: pointer; }
    .nav-dropdown-content {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      min-width: 180px;
      z-index: 1000;
      padding: 0.5rem 0;
    }
    .nav-dropdown:hover .nav-dropdown-content { display: block; }
    .nav-dropdown-content a { 
      display: block; 
      padding: 0.75rem 1rem;
      border-radius: 0;
    }
    .nav-right { margin-left: auto; display: flex; align-items: center; gap: 1rem; }
    
    /* Main Container */
    .container { max-width: 1400px; margin: 0 auto; padding: 2rem; }
    
    /* Page Header */
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 2rem;
      flex-wrap: wrap;
      gap: 1rem;
    }
    .page-title { 
      font-size: 2rem; 
      font-weight: 700; 
      color: #0f172a;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    .page-title i { color: #f59e0b; }
    .page-subtitle { color: #64748b; margin-top: 0.25rem; }
    
    /* Tabs */
    .tabs {
      display: flex;
      gap: 0.5rem;
      background: white;
      padding: 0.5rem;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      margin-bottom: 2rem;
      flex-wrap: wrap;
    }
    .tab {
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      font-size: 0.875rem;
      color: #64748b;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .tab:hover { background: #f1f5f9; }
    .tab.active { background: #0ea5e9; color: white; }
    .tab .badge {
      background: rgba(255,255,255,0.2);
      padding: 0.125rem 0.5rem;
      border-radius: 999px;
      font-size: 0.75rem;
    }
    .tab:not(.active) .badge { background: #e2e8f0; color: #64748b; }
    
    /* Stats Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }
    .stat-card {
      background: white;
      padding: 1.5rem;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      color: #0ea5e9;
    }
    .stat-value.gold { color: #f59e0b; }
    .stat-value.green { color: #10b981; }
    .stat-value.purple { color: #8b5cf6; }
    .stat-label {
      color: #64748b;
      font-size: 0.875rem;
      margin-top: 0.25rem;
    }
    .stat-icon {
      float: right;
      font-size: 2rem;
      opacity: 0.15;
    }
    
    /* Cards */
    .card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      overflow: hidden;
    }
    .card-header {
      padding: 1.25rem 1.5rem;
      border-bottom: 1px solid #e2e8f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
    }
    .card-title {
      font-size: 1.125rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .card-body { padding: 1.5rem; }
    
    /* Forms */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
    }
    .form-group { margin-bottom: 1rem; }
    .form-group.full-width { grid-column: 1 / -1; }
    .form-label {
      display: block;
      font-weight: 500;
      font-size: 0.875rem;
      margin-bottom: 0.5rem;
      color: #374151;
    }
    .form-input, .form-select, .form-textarea {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 0.9375rem;
      transition: all 0.2s;
      font-family: inherit;
    }
    .form-input:focus, .form-select:focus, .form-textarea:focus {
      outline: none;
      border-color: #0ea5e9;
      box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
    }
    .form-textarea { resize: vertical; min-height: 100px; }
    .form-checkbox {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      cursor: pointer;
    }
    .form-checkbox input { width: 1.25rem; height: 1.25rem; cursor: pointer; }
    
    /* Star Rating */
    .star-rating { display: flex; gap: 0.25rem; }
    .star-rating .star {
      font-size: 1.5rem;
      color: #d1d5db;
      cursor: pointer;
      transition: all 0.15s;
    }
    .star-rating .star:hover,
    .star-rating .star.active { color: #f59e0b; }
    .star-rating.readonly .star { cursor: default; }
    .star-display { color: #f59e0b; }
    .star-display .empty { color: #d1d5db; }
    
    /* Buttons */
    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      font-size: 0.875rem;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }
    .btn-primary { background: #0ea5e9; color: white; }
    .btn-primary:hover { background: #0284c7; }
    .btn-success { background: #10b981; color: white; }
    .btn-success:hover { background: #059669; }
    .btn-warning { background: #f59e0b; color: white; }
    .btn-warning:hover { background: #d97706; }
    .btn-secondary { background: #e2e8f0; color: #475569; }
    .btn-secondary:hover { background: #cbd5e1; }
    .btn-danger { background: #ef4444; color: white; }
    .btn-danger:hover { background: #dc2626; }
    .btn-sm { padding: 0.5rem 1rem; font-size: 0.8125rem; }
    .btn-icon { padding: 0.5rem; width: 2.25rem; height: 2.25rem; justify-content: center; }
    
    /* Testimonial Cards Grid */
    .testimonials-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 1.5rem;
    }
    .testimonial-card {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      position: relative;
      transition: all 0.2s;
    }
    .testimonial-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .testimonial-card.featured {
      border: 2px solid #f59e0b;
      background: linear-gradient(to bottom right, #fffbeb, white);
    }
    .testimonial-featured-badge {
      position: absolute;
      top: -8px;
      right: 1rem;
      background: #f59e0b;
      color: white;
      padding: 0.25rem 0.75rem;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    .testimonial-quote {
      font-size: 1rem;
      line-height: 1.6;
      color: #374151;
      margin-bottom: 1rem;
      font-style: italic;
    }
    .testimonial-quote::before { content: '"'; font-size: 1.5rem; color: #0ea5e9; }
    .testimonial-quote::after { content: '"'; font-size: 1.5rem; color: #0ea5e9; }
    .testimonial-meta {
      display: flex;
      align-items: center;
      gap: 1rem;
      border-top: 1px solid #e2e8f0;
      padding-top: 1rem;
    }
    .testimonial-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: linear-gradient(135deg, #0ea5e9, #8b5cf6);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 1.125rem;
    }
    .testimonial-info { flex: 1; }
    .testimonial-name { font-weight: 600; color: #0f172a; }
    .testimonial-role { font-size: 0.8125rem; color: #64748b; }
    .testimonial-property { font-size: 0.8125rem; color: #0ea5e9; }
    .testimonial-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
    }
    
    /* Filter Bar */
    .filter-bar {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
      align-items: center;
    }
    .filter-bar select { min-width: 150px; }
    
    /* Table */
    .table-container { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 0.875rem 1rem; text-align: left; }
    th { 
      background: #f8fafc; 
      font-weight: 600; 
      font-size: 0.8125rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #64748b;
    }
    td { border-bottom: 1px solid #e2e8f0; }
    tr:hover td { background: #f8fafc; }
    
    /* Status Badges */
    .badge {
      padding: 0.25rem 0.75rem;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 500;
    }
    .badge-success { background: #dcfce7; color: #166534; }
    .badge-warning { background: #fef3c7; color: #92400e; }
    .badge-danger { background: #fee2e2; color: #991b1b; }
    .badge-info { background: #dbeafe; color: #1e40af; }
    .badge-purple { background: #f3e8ff; color: #6b21a8; }
    
    /* Social Proof Stats Box */
    .proof-stats {
      background: linear-gradient(135deg, #0ea5e9, #8b5cf6);
      border-radius: 12px;
      padding: 2rem;
      color: white;
      text-align: center;
    }
    .proof-stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 2rem;
    }
    .proof-stat-value { font-size: 3rem; font-weight: 700; }
    .proof-stat-label { font-size: 0.875rem; opacity: 0.9; }
    
    /* Quote Graphic Preview */
    .quote-preview {
      background: linear-gradient(135deg, #1e3a5f 0%, #0f172a 100%);
      border-radius: 12px;
      padding: 2rem;
      color: white;
      max-width: 500px;
    }
    .quote-preview-text {
      font-size: 1.25rem;
      line-height: 1.6;
      font-style: italic;
      margin-bottom: 1.5rem;
    }
    .quote-preview-author { font-weight: 600; }
    .quote-preview-company { opacity: 0.8; font-size: 0.875rem; }
    .quote-preview-logo {
      margin-top: 1.5rem;
      padding-top: 1rem;
      border-top: 1px solid rgba(255,255,255,0.2);
      font-weight: 600;
      color: #0ea5e9;
    }
    
    /* NPS Gauge */
    .nps-gauge {
      text-align: center;
      padding: 2rem;
    }
    .nps-score {
      font-size: 5rem;
      font-weight: 700;
      background: linear-gradient(135deg, #10b981, #0ea5e9);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .nps-label { color: #64748b; margin-bottom: 1rem; }
    .nps-scale {
      display: flex;
      justify-content: space-between;
      background: #f1f5f9;
      border-radius: 8px;
      overflow: hidden;
      margin-top: 1rem;
    }
    .nps-segment {
      flex: 1;
      padding: 0.75rem;
      text-align: center;
      font-size: 0.8125rem;
    }
    .nps-detractors { background: #fee2e2; color: #991b1b; }
    .nps-passives { background: #fef3c7; color: #92400e; }
    .nps-promoters { background: #dcfce7; color: #166534; }
    
    /* Case Study Card */
    .case-study-card {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    .case-study-header {
      background: linear-gradient(135deg, #0ea5e9, #0284c7);
      color: white;
      padding: 1.5rem;
    }
    .case-study-body { padding: 1.5rem; }
    .case-study-section { margin-bottom: 1.5rem; }
    .case-study-section-title {
      font-weight: 600;
      color: #0ea5e9;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .metrics-row {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1rem;
      margin-top: 1rem;
    }
    .metric-box {
      background: #f8fafc;
      padding: 1rem;
      border-radius: 8px;
      text-align: center;
    }
    .metric-value { font-size: 1.5rem; font-weight: 700; color: #10b981; }
    .metric-label { font-size: 0.75rem; color: #64748b; }
    
    /* Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }
    .modal-overlay.active { display: flex; }
    .modal {
      background: white;
      border-radius: 12px;
      width: 100%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
    }
    .modal-header {
      padding: 1.25rem 1.5rem;
      border-bottom: 1px solid #e2e8f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .modal-title { font-weight: 600; font-size: 1.125rem; }
    .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: #64748b;
    }
    .modal-body { padding: 1.5rem; }
    .modal-footer {
      padding: 1rem 1.5rem;
      border-top: 1px solid #e2e8f0;
      display: flex;
      justify-content: flex-end;
      gap: 0.75rem;
    }
    
    /* Tab Panels */
    .tab-panel { display: none; }
    .tab-panel.active { display: block; }
    
    /* Toast */
    .toast {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      background: #0f172a;
      color: white;
      padding: 1rem 1.5rem;
      border-radius: 8px;
      z-index: 2000;
      transform: translateX(200%);
      transition: transform 0.3s;
    }
    .toast.show { transform: translateX(0); }
    .toast.success { background: #10b981; }
    .toast.error { background: #ef4444; }
    
    /* Email Template Preview */
    .email-template {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 1rem;
      font-family: monospace;
      font-size: 0.875rem;
      white-space: pre-wrap;
      max-height: 300px;
      overflow-y: auto;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .nav { padding: 1rem; flex-wrap: wrap; }
      .nav-links { display: none; }
      .container { padding: 1rem; }
      .page-header { flex-direction: column; }
      .tabs { overflow-x: auto; flex-wrap: nowrap; }
      .proof-stats-grid { grid-template-columns: 1fr; gap: 1rem; }
      .testimonials-grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav class="nav">
    <div class="nav-brand">
      <i class="fas fa-robot"></i>
      Kande VendTech
    </div>
    <div class="nav-links">
      <a href="/home">Home</a>
      <div class="nav-dropdown">
        <span><i class="fas fa-chart-line"></i> Sales <i class="fas fa-chevron-down" style="font-size:0.7rem"></i></span>
        <div class="nav-dropdown-content">
          <a href="/crm">CRM</a>
          <a href="/pipeline">Pipeline</a>
          <a href="/activities">Activities</a>
          <a href="/route-planner">Pop-Ins</a>
        </div>
      </div>
      <div class="nav-dropdown">
        <span><i class="fas fa-bullhorn"></i> Marketing <i class="fas fa-chevron-down" style="font-size:0.7rem"></i></span>
        <div class="nav-dropdown-content">
          <a href="/home">Dashboard</a>
          <a href="/testimonials" class="active">Testimonials</a>
          <a href="/seo">SEO Tracker</a>
        </div>
      </div>
      <a href="/operations">Operations</a>
      <a href="/finance">Finances</a>
    </div>
    <div class="nav-right">
      <button onclick="location.href='/api/auth/logout'" class="btn btn-secondary btn-sm">
        <i class="fas fa-sign-out-alt"></i> Logout
      </button>
    </div>
  </nav>

  <div class="container">
    <!-- Page Header -->
    <div class="page-header">
      <div>
        <h1 class="page-title"><i class="fas fa-star"></i> Testimonials & Social Proof</h1>
        <p class="page-subtitle">Collect, manage, and showcase customer feedback</p>
      </div>
      <button class="btn btn-primary" onclick="openModal('add-testimonial')">
        <i class="fas fa-plus"></i> Add Testimonial
      </button>
    </div>

    <!-- Stats -->
    <div class="stats-grid" id="stats-grid">
      <div class="stat-card">
        <i class="fas fa-quote-right stat-icon"></i>
        <div class="stat-value" id="stat-total">0</div>
        <div class="stat-label">Total Testimonials</div>
      </div>
      <div class="stat-card">
        <i class="fas fa-star stat-icon"></i>
        <div class="stat-value gold" id="stat-avg-rating">0</div>
        <div class="stat-label">Average Rating</div>
      </div>
      <div class="stat-card">
        <i class="fas fa-award stat-icon"></i>
        <div class="stat-value green" id="stat-featured">0</div>
        <div class="stat-label">Featured</div>
      </div>
      <div class="stat-card">
        <i class="fas fa-chart-line stat-icon"></i>
        <div class="stat-value purple" id="stat-nps">--</div>
        <div class="stat-label">NPS Score</div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <div class="tab active" data-tab="testimonials">
        <i class="fas fa-quote-left"></i> Testimonials
        <span class="badge" id="tab-count-testimonials">0</span>
      </div>
      <div class="tab" data-tab="requests">
        <i class="fas fa-envelope"></i> Review Requests
        <span class="badge" id="tab-count-requests">0</span>
      </div>
      <div class="tab" data-tab="social-proof">
        <i class="fas fa-trophy"></i> Social Proof Assets
      </div>
      <div class="tab" data-tab="nps">
        <i class="fas fa-poll"></i> NPS Tracking
      </div>
      <div class="tab" data-tab="case-studies">
        <i class="fas fa-file-alt"></i> Case Studies
        <span class="badge" id="tab-count-cases">0</span>
      </div>
    </div>

    <!-- Tab: Testimonials -->
    <div class="tab-panel active" id="panel-testimonials">
      <div class="filter-bar">
        <select class="form-select" id="filter-rating" onchange="loadTestimonials()">
          <option value="">All Ratings</option>
          <option value="5">5 Stars</option>
          <option value="4">4+ Stars</option>
          <option value="3">3+ Stars</option>
        </select>
        <select class="form-select" id="filter-type" onchange="loadTestimonials()">
          <option value="">All Property Types</option>
          <option value="apartments">Apartments</option>
          <option value="senior_living">Senior Living</option>
          <option value="healthcare">Healthcare</option>
          <option value="industrial">Industrial</option>
          <option value="office">Office</option>
          <option value="recreation">Recreation</option>
          <option value="other">Other</option>
        </select>
        <select class="form-select" id="filter-featured" onchange="loadTestimonials()">
          <option value="">All</option>
          <option value="true">Featured Only</option>
        </select>
      </div>
      <div class="testimonials-grid" id="testimonials-grid">
        <!-- Testimonial cards rendered here -->
      </div>
    </div>

    <!-- Tab: Review Requests -->
    <div class="tab-panel" id="panel-requests">
      <div class="card" style="margin-bottom: 1.5rem;">
        <div class="card-header">
          <h3 class="card-title"><i class="fas fa-paper-plane"></i> Request a Review</h3>
        </div>
        <div class="card-body">
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">Select Client</label>
              <select class="form-select" id="request-client">
                <option value="">Choose a client...</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Contact Email</label>
              <input type="email" class="form-input" id="request-email" placeholder="client@example.com">
            </div>
            <div class="form-group full-width">
              <label class="form-label">Google Review Link</label>
              <div style="display: flex; gap: 0.5rem;">
                <input type="text" class="form-input" id="google-review-link" value="https://g.page/r/YOUR_PLACE_ID/review" readonly>
                <button class="btn btn-secondary" onclick="copyToClipboard(document.getElementById('google-review-link').value)">
                  <i class="fas fa-copy"></i>
                </button>
              </div>
            </div>
            <div class="form-group full-width">
              <label class="form-label">Email Template</label>
              <div class="email-template" id="email-template">Subject: Quick favor â€” share your experience with Kande VendTech?

Hi [Name],

I hope you're doing well! It's been great working with [Property Name] over the past few months.

If you have a moment, would you mind leaving us a quick Google review? It really helps other property managers discover our services.

Here's the direct link: [Google Review Link]

Just a sentence or two about your experience would mean a lot to us!

Thanks so much,
Kurtis
Kande VendTech
(702) 555-0123</div>
            </div>
          </div>
          <div style="display: flex; gap: 0.75rem; margin-top: 1rem;">
            <button class="btn btn-primary" onclick="sendReviewRequest()">
              <i class="fas fa-paper-plane"></i> Log Request Sent
            </button>
            <button class="btn btn-secondary" onclick="copyEmailTemplate()">
              <i class="fas fa-copy"></i> Copy Email
            </button>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h3 class="card-title"><i class="fas fa-history"></i> Request History</h3>
        </div>
        <div class="card-body">
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Client</th>
                  <th>Email</th>
                  <th>Sent Date</th>
                  <th>Status</th>
                  <th>Follow-up</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="requests-table">
                <!-- Rows rendered here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Tab: Social Proof Assets -->
    <div class="tab-panel" id="panel-social-proof">
      <div class="proof-stats" style="margin-bottom: 2rem;">
        <h2 style="margin-bottom: 1.5rem;">Your Social Proof Stats</h2>
        <div class="proof-stats-grid">
          <div>
            <div class="proof-stat-value" id="proof-clients">0</div>
            <div class="proof-stat-label">Happy Clients</div>
          </div>
          <div>
            <div class="proof-stat-value" id="proof-years">1</div>
            <div class="proof-stat-label">Years Experience</div>
          </div>
          <div>
            <div class="proof-stat-value" id="proof-machines">0</div>
            <div class="proof-stat-label">Machines Deployed</div>
          </div>
        </div>
        <button class="btn btn-warning" style="margin-top: 1.5rem;" onclick="copyProofStats()">
          <i class="fas fa-copy"></i> Copy Stats for Proposals
        </button>
      </div>

      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 1.5rem;">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title"><i class="fas fa-image"></i> Quote Graphic Generator</h3>
          </div>
          <div class="card-body">
            <div class="form-group">
              <label class="form-label">Select Testimonial</label>
              <select class="form-select" id="quote-testimonial" onchange="updateQuotePreview()">
                <option value="">Choose a testimonial...</option>
              </select>
            </div>
            <div id="quote-preview-container" style="margin-top: 1rem;"></div>
            <div style="display: flex; gap: 0.75rem; margin-top: 1rem;">
              <button class="btn btn-primary" onclick="copyQuoteText()">
                <i class="fas fa-copy"></i> Copy Quote Text
              </button>
              <button class="btn btn-secondary" onclick="downloadQuoteGraphic()">
                <i class="fas fa-download"></i> Download Graphic
              </button>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h3 class="card-title"><i class="fas fa-clipboard-list"></i> Copy-Ready Snippets</h3>
          </div>
          <div class="card-body" id="snippets-container">
            <!-- Snippets rendered here -->
          </div>
        </div>
      </div>
    </div>

    <!-- Tab: NPS Tracking -->
    <div class="tab-panel" id="panel-nps">
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 1.5rem;">
        <div class="card">
          <div class="card-header">
            <h3 class="card-title"><i class="fas fa-poll-h"></i> Send NPS Survey</h3>
          </div>
          <div class="card-body">
            <div class="form-group">
              <label class="form-label">Select Client</label>
              <select class="form-select" id="nps-client">
                <option value="">Choose a client...</option>
              </select>
            </div>
            <p style="margin: 1rem 0; color: #64748b; font-size: 0.875rem;">
              "On a scale of 0-10, how likely are you to recommend Kande VendTech to a colleague?"
            </p>
            <div class="form-group">
              <label class="form-label">Their Score (0-10)</label>
              <input type="number" class="form-input" id="nps-score" min="0" max="10" placeholder="0-10">
            </div>
            <div class="form-group">
              <label class="form-label">Feedback (optional)</label>
              <textarea class="form-textarea" id="nps-feedback" placeholder="Any additional comments..."></textarea>
            </div>
            <button class="btn btn-primary" onclick="submitNPS()">
              <i class="fas fa-save"></i> Record Response
            </button>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <h3 class="card-title"><i class="fas fa-chart-pie"></i> Current NPS</h3>
          </div>
          <div class="card-body">
            <div class="nps-gauge">
              <div class="nps-score" id="nps-display">--</div>
              <div class="nps-label">Net Promoter Score</div>
              <div class="nps-scale">
                <div class="nps-segment nps-detractors">
                  <strong id="nps-detractors-pct">0%</strong><br>Detractors (0-6)
                </div>
                <div class="nps-segment nps-passives">
                  <strong id="nps-passives-pct">0%</strong><br>Passives (7-8)
                </div>
                <div class="nps-segment nps-promoters">
                  <strong id="nps-promoters-pct">0%</strong><br>Promoters (9-10)
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top: 1.5rem;">
        <div class="card-header">
          <h3 class="card-title"><i class="fas fa-history"></i> NPS Response History</h3>
        </div>
        <div class="card-body">
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Client</th>
                  <th>Score</th>
                  <th>Category</th>
                  <th>Feedback</th>
                </tr>
              </thead>
              <tbody id="nps-table">
                <!-- Rows rendered here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Tab: Case Studies -->
    <div class="tab-panel" id="panel-case-studies">
      <div style="display: flex; justify-content: flex-end; margin-bottom: 1.5rem;">
        <button class="btn btn-primary" onclick="openModal('add-case-study')">
          <i class="fas fa-plus"></i> Create Case Study
        </button>
      </div>
      <div class="testimonials-grid" id="case-studies-grid">
        <!-- Case study cards rendered here -->
      </div>
    </div>
  </div>

  <!-- Add Testimonial Modal -->
  <div class="modal-overlay" id="modal-add-testimonial">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Add Testimonial</h3>
        <button class="modal-close" onclick="closeModal('add-testimonial')">&times;</button>
      </div>
      <div class="modal-body">
        <form id="testimonial-form">
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">Property Name *</label>
              <input type="text" class="form-input" name="property_name" required placeholder="Sunset Apartments">
            </div>
            <div class="form-group">
              <label class="form-label">Property Type</label>
              <select class="form-select" name="property_type">
                <option value="">Select type...</option>
                <option value="apartments">Apartments</option>
                <option value="senior_living">Senior Living</option>
                <option value="healthcare">Healthcare</option>
                <option value="industrial">Industrial</option>
                <option value="office">Office</option>
                <option value="recreation">Recreation</option>
                <option value="other">Other</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Contact Name *</label>
              <input type="text" class="form-input" name="contact_name" required placeholder="Jane Smith">
            </div>
            <div class="form-group">
              <label class="form-label">Role/Title</label>
              <input type="text" class="form-input" name="contact_role" placeholder="Property Manager">
            </div>
            <div class="form-group full-width">
              <label class="form-label">Star Rating *</label>
              <div class="star-rating" id="rating-input">
                <i class="fas fa-star star" data-rating="1"></i>
                <i class="fas fa-star star" data-rating="2"></i>
                <i class="fas fa-star star" data-rating="3"></i>
                <i class="fas fa-star star" data-rating="4"></i>
                <i class="fas fa-star star" data-rating="5"></i>
              </div>
              <input type="hidden" name="rating" id="rating-value" value="5">
            </div>
            <div class="form-group full-width">
              <label class="form-label">Testimonial *</label>
              <textarea class="form-textarea" name="testimonial" required placeholder="What did they say about your service?"></textarea>
            </div>
            <div class="form-group">
              <label class="form-checkbox">
                <input type="checkbox" name="public_permission" checked>
                <span>Permission to use publicly</span>
              </label>
            </div>
            <div class="form-group">
              <label class="form-checkbox">
                <input type="checkbox" name="featured">
                <span>Mark as Featured</span>
              </label>
            </div>
            <div class="form-group full-width">
              <label class="form-label">Photo URL (optional)</label>
              <input type="text" class="form-input" name="photo_url" placeholder="https://...">
              <small style="color: #64748b;">Or upload later</small>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('add-testimonial')">Cancel</button>
        <button class="btn btn-primary" onclick="saveTestimonial()">
          <i class="fas fa-save"></i> Save Testimonial
        </button>
      </div>
    </div>
  </div>

  <!-- Add Case Study Modal -->
  <div class="modal-overlay" id="modal-add-case-study">
    <div class="modal" style="max-width: 700px;">
      <div class="modal-header">
        <h3 class="modal-title">Create Case Study</h3>
        <button class="modal-close" onclick="closeModal('add-case-study')">&times;</button>
      </div>
      <div class="modal-body">
        <form id="case-study-form">
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">Client/Property Name *</label>
              <input type="text" class="form-input" name="client_name" required>
            </div>
            <div class="form-group">
              <label class="form-label">Property Type</label>
              <select class="form-select" name="property_type">
                <option value="">Select...</option>
                <option value="apartments">Apartments</option>
                <option value="senior_living">Senior Living</option>
                <option value="healthcare">Healthcare</option>
                <option value="industrial">Industrial</option>
                <option value="office">Office</option>
              </select>
            </div>
            <div class="form-group full-width">
              <label class="form-label">The Challenge</label>
              <textarea class="form-textarea" name="challenge" placeholder="What problem were they facing?"></textarea>
            </div>
            <div class="form-group full-width">
              <label class="form-label">Our Solution</label>
              <textarea class="form-textarea" name="solution" placeholder="How did Kande VendTech help?"></textarea>
            </div>
            <div class="form-group full-width">
              <label class="form-label">The Results</label>
              <textarea class="form-textarea" name="results" placeholder="What outcomes did they achieve?"></textarea>
            </div>
            <div class="form-group">
              <label class="form-label">Metric 1 Label</label>
              <input type="text" class="form-input" name="metric1_label" placeholder="e.g., Monthly Revenue">
            </div>
            <div class="form-group">
              <label class="form-label">Metric 1 Value</label>
              <input type="text" class="form-input" name="metric1_value" placeholder="e.g., $2,400">
            </div>
            <div class="form-group">
              <label class="form-label">Metric 2 Label</label>
              <input type="text" class="form-input" name="metric2_label" placeholder="e.g., Resident Satisfaction">
            </div>
            <div class="form-group">
              <label class="form-label">Metric 2 Value</label>
              <input type="text" class="form-input" name="metric2_value" placeholder="e.g., 94%">
            </div>
            <div class="form-group">
              <label class="form-label">Metric 3 Label</label>
              <input type="text" class="form-input" name="metric3_label" placeholder="e.g., Setup Time">
            </div>
            <div class="form-group">
              <label class="form-label">Metric 3 Value</label>
              <input type="text" class="form-input" name="metric3_value" placeholder="e.g., 2 Days">
            </div>
            <div class="form-group full-width">
              <label class="form-label">Client Quote (optional)</label>
              <textarea class="form-textarea" name="quote" placeholder="A quote from the client..."></textarea>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('add-case-study')">Cancel</button>
        <button class="btn btn-primary" onclick="saveCaseStudy()">
          <i class="fas fa-save"></i> Save Case Study
        </button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <script>
    // State
    let testimonials = [];
    let reviewRequests = [];
    let npsResponses = [];
    let caseStudies = [];
    let clients = [];
    let editingId = null;

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      setupTabs();
      setupStarRating();
      loadAll();
    });

    // API Helpers
    async function api(endpoint, method = 'GET', data = null) {
      const opts = { method, headers: { 'Content-Type': 'application/json' } };
      if (data) opts.body = JSON.stringify(data);
      const res = await fetch(endpoint, opts);
      if (!res.ok) throw new Error(`API error: ${res.status}`);
      return res.json();
    }

    // Load all data
    async function loadAll() {
      try {
        [testimonials, reviewRequests, npsResponses, caseStudies, clients] = await Promise.all([
          api('/api/testimonials'),
          api('/api/review-requests'),
          api('/api/nps'),
          api('/api/case-studies'),
          api('/api/prospects?status=signed')
        ]);
        
        // Also get machines for proof stats
        const machines = await api('/api/machines');
        const deployedCount = machines.filter(m => m.status === 'deployed').length;
        
        updateStats(deployedCount);
        loadTestimonials();
        loadReviewRequests();
        loadNPS();
        loadCaseStudies();
        populateClientDropdowns();
        populateQuoteDropdown();
        loadSnippets();
      } catch (e) {
        console.error('Load error:', e);
        showToast('Error loading data', 'error');
      }
    }

    // Update stats
    function updateStats(machineCount = 0) {
      document.getElementById('stat-total').textContent = testimonials.length;
      const avgRating = testimonials.length > 0 
        ? (testimonials.reduce((s, t) => s + (t.rating || 5), 0) / testimonials.length).toFixed(1)
        : '0';
      document.getElementById('stat-avg-rating').textContent = avgRating;
      document.getElementById('stat-featured').textContent = testimonials.filter(t => t.featured).length;
      
      // NPS
      if (npsResponses.length > 0) {
        const promoters = npsResponses.filter(n => n.score >= 9).length;
        const detractors = npsResponses.filter(n => n.score <= 6).length;
        const nps = Math.round(((promoters - detractors) / npsResponses.length) * 100);
        document.getElementById('stat-nps').textContent = nps;
      }
      
      // Tab counts
      document.getElementById('tab-count-testimonials').textContent = testimonials.length;
      document.getElementById('tab-count-requests').textContent = reviewRequests.length;
      document.getElementById('tab-count-cases').textContent = caseStudies.length;
      
      // Proof stats
      document.getElementById('proof-clients').textContent = clients.length || testimonials.length;
      document.getElementById('proof-machines').textContent = machineCount;
    }

    // Tabs
    function setupTabs() {
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
          tab.classList.add('active');
          document.getElementById(`panel-${tab.dataset.tab}`).classList.add('active');
        });
      });
    }

    // Star rating input
    function setupStarRating() {
      const container = document.getElementById('rating-input');
      const input = document.getElementById('rating-value');
      
      container.querySelectorAll('.star').forEach(star => {
        star.addEventListener('click', () => {
          const rating = parseInt(star.dataset.rating);
          input.value = rating;
          updateStars(container, rating);
        });
        star.addEventListener('mouseenter', () => {
          updateStars(container, parseInt(star.dataset.rating));
        });
      });
      
      container.addEventListener('mouseleave', () => {
        updateStars(container, parseInt(input.value));
      });
      
      // Initialize
      updateStars(container, 5);
    }

    function updateStars(container, rating) {
      container.querySelectorAll('.star').forEach(star => {
        const r = parseInt(star.dataset.rating);
        star.classList.toggle('active', r <= rating);
      });
    }

    function renderStars(rating, readonly = true) {
      let html = '<span class="star-display">';
      for (let i = 1; i <= 5; i++) {
        html += `<i class="fas fa-star ${i <= rating ? '' : 'empty'}"></i>`;
      }
      return html + '</span>';
    }

    // Load testimonials
    function loadTestimonials() {
      const ratingFilter = document.getElementById('filter-rating').value;
      const typeFilter = document.getElementById('filter-type').value;
      const featuredFilter = document.getElementById('filter-featured').value;
      
      let filtered = [...testimonials];
      
      if (ratingFilter) {
        filtered = filtered.filter(t => t.rating >= parseInt(ratingFilter));
      }
      if (typeFilter) {
        filtered = filtered.filter(t => t.property_type === typeFilter);
      }
      if (featuredFilter === 'true') {
        filtered = filtered.filter(t => t.featured);
      }
      
      // Sort: featured first, then by date
      filtered.sort((a, b) => {
        if (a.featured && !b.featured) return -1;
        if (!a.featured && b.featured) return 1;
        return new Date(b.created_at) - new Date(a.created_at);
      });
      
      const grid = document.getElementById('testimonials-grid');
      
      if (filtered.length === 0) {
        grid.innerHTML = `
          <div style="grid-column: 1/-1; text-align: center; padding: 3rem; color: #64748b;">
            <i class="fas fa-quote-right" style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem;"></i>
            <p>No testimonials yet. Add your first one!</p>
          </div>
        `;
        return;
      }
      
      grid.innerHTML = filtered.map(t => `
        <div class="testimonial-card ${t.featured ? 'featured' : ''}">
          ${t.featured ? '<div class="testimonial-featured-badge"><i class="fas fa-star"></i> Featured</div>' : ''}
          <div style="margin-bottom: 0.5rem;">${renderStars(t.rating)}</div>
          <div class="testimonial-quote">${escapeHtml(t.testimonial)}</div>
          <div class="testimonial-meta">
            <div class="testimonial-avatar">${getInitials(t.contact_name)}</div>
            <div class="testimonial-info">
              <div class="testimonial-name">${escapeHtml(t.contact_name)}</div>
              <div class="testimonial-role">${escapeHtml(t.contact_role || '')}</div>
              <div class="testimonial-property">${escapeHtml(t.property_name)}</div>
            </div>
          </div>
          <div class="testimonial-actions">
            <button class="btn btn-sm btn-secondary" onclick="toggleFeatured(${t.id})">
              <i class="fas fa-star"></i> ${t.featured ? 'Unfeature' : 'Feature'}
            </button>
            <button class="btn btn-sm btn-secondary" onclick="editTestimonial(${t.id})">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn btn-sm btn-danger" onclick="deleteTestimonial(${t.id})">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>
      `).join('');
    }

    // Save testimonial
    async function saveTestimonial() {
      const form = document.getElementById('testimonial-form');
      const data = {
        property_name: form.property_name.value,
        property_type: form.property_type.value,
        contact_name: form.contact_name.value,
        contact_role: form.contact_role.value,
        rating: parseInt(document.getElementById('rating-value').value),
        testimonial: form.testimonial.value,
        public_permission: form.public_permission.checked,
        featured: form.featured.checked,
        photo_url: form.photo_url.value
      };
      
      if (!data.property_name || !data.contact_name || !data.testimonial) {
        showToast('Please fill in required fields', 'error');
        return;
      }
      
      try {
        if (editingId) {
          await api(`/api/testimonials/${editingId}`, 'PUT', data);
        } else {
          await api('/api/testimonials', 'POST', data);
        }
        closeModal('add-testimonial');
        form.reset();
        editingId = null;
        loadAll();
        showToast('Testimonial saved!', 'success');
      } catch (e) {
        showToast('Error saving testimonial', 'error');
      }
    }

    // Edit testimonial
    function editTestimonial(id) {
      const t = testimonials.find(x => x.id === id);
      if (!t) return;
      
      editingId = id;
      const form = document.getElementById('testimonial-form');
      form.property_name.value = t.property_name || '';
      form.property_type.value = t.property_type || '';
      form.contact_name.value = t.contact_name || '';
      form.contact_role.value = t.contact_role || '';
      form.testimonial.value = t.testimonial || '';
      form.public_permission.checked = t.public_permission !== false;
      form.featured.checked = t.featured || false;
      form.photo_url.value = t.photo_url || '';
      document.getElementById('rating-value').value = t.rating || 5;
      updateStars(document.getElementById('rating-input'), t.rating || 5);
      
      openModal('add-testimonial');
    }

    // Toggle featured
    async function toggleFeatured(id) {
      const t = testimonials.find(x => x.id === id);
      if (!t) return;
      
      try {
        await api(`/api/testimonials/${id}`, 'PUT', { featured: !t.featured });
        loadAll();
        showToast(t.featured ? 'Removed from featured' : 'Marked as featured!', 'success');
      } catch (e) {
        showToast('Error updating testimonial', 'error');
      }
    }

    // Delete testimonial
    async function deleteTestimonial(id) {
      if (!confirm('Delete this testimonial?')) return;
      try {
        await api(`/api/testimonials/${id}`, 'DELETE');
        loadAll();
        showToast('Testimonial deleted', 'success');
      } catch (e) {
        showToast('Error deleting testimonial', 'error');
      }
    }

    // Populate client dropdowns
    function populateClientDropdowns() {
      const signedProspects = clients.filter(c => c.status === 'signed');
      const options = signedProspects.map(c => `<option value="${c.id}" data-email="${c.email || ''}">${c.name}</option>`).join('');
      
      document.getElementById('request-client').innerHTML = '<option value="">Choose a client...</option>' + options;
      document.getElementById('nps-client').innerHTML = '<option value="">Choose a client...</option>' + options;
    }

    // Review Requests
    function loadReviewRequests() {
      const tbody = document.getElementById('requests-table');
      
      if (reviewRequests.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #64748b;">No review requests yet</td></tr>';
        return;
      }
      
      tbody.innerHTML = reviewRequests.map(r => {
        const daysSince = Math.floor((Date.now() - new Date(r.sent_date)) / (1000 * 60 * 60 * 24));
        const needsFollowup = r.status === 'sent' && daysSince >= 7;
        return `
          <tr>
            <td>${escapeHtml(r.client_name)}</td>
            <td>${escapeHtml(r.email)}</td>
            <td>${new Date(r.sent_date).toLocaleDateString()}</td>
            <td>
              <span class="badge ${r.status === 'received' ? 'badge-success' : r.status === 'sent' ? 'badge-info' : 'badge-warning'}">
                ${r.status}
              </span>
            </td>
            <td>${needsFollowup ? '<span class="badge badge-warning"><i class="fas fa-bell"></i> Follow up!</span>' : '-'}</td>
            <td>
              <button class="btn btn-sm btn-success" onclick="markReviewReceived(${r.id})" ${r.status === 'received' ? 'disabled' : ''}>
                <i class="fas fa-check"></i>
              </button>
              <button class="btn btn-sm btn-danger" onclick="deleteReviewRequest(${r.id})">
                <i class="fas fa-trash"></i>
              </button>
            </td>
          </tr>
        `;
      }).join('');
    }

    async function sendReviewRequest() {
      const clientSelect = document.getElementById('request-client');
      const email = document.getElementById('request-email').value;
      
      if (!clientSelect.value) {
        showToast('Please select a client', 'error');
        return;
      }
      
      try {
        await api('/api/review-requests', 'POST', {
          client_id: parseInt(clientSelect.value),
          client_name: clientSelect.options[clientSelect.selectedIndex].text,
          email: email || clientSelect.options[clientSelect.selectedIndex].dataset.email,
          status: 'sent'
        });
        loadAll();
        showToast('Review request logged!', 'success');
      } catch (e) {
        showToast('Error logging request', 'error');
      }
    }

    async function markReviewReceived(id) {
      try {
        await api(`/api/review-requests/${id}`, 'PUT', { status: 'received' });
        loadAll();
        showToast('Marked as received!', 'success');
      } catch (e) {
        showToast('Error updating request', 'error');
      }
    }

    async function deleteReviewRequest(id) {
      if (!confirm('Delete this request?')) return;
      try {
        await api(`/api/review-requests/${id}`, 'DELETE');
        loadAll();
        showToast('Request deleted', 'success');
      } catch (e) {
        showToast('Error deleting request', 'error');
      }
    }

    function copyEmailTemplate() {
      const template = document.getElementById('email-template').textContent;
      copyToClipboard(template);
    }

    // NPS
    function loadNPS() {
      const tbody = document.getElementById('nps-table');
      
      if (npsResponses.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #64748b;">No NPS responses yet</td></tr>';
        document.getElementById('nps-display').textContent = '--';
        return;
      }
      
      // Calculate NPS
      const promoters = npsResponses.filter(n => n.score >= 9).length;
      const passives = npsResponses.filter(n => n.score >= 7 && n.score <= 8).length;
      const detractors = npsResponses.filter(n => n.score <= 6).length;
      const total = npsResponses.length;
      
      const nps = Math.round(((promoters - detractors) / total) * 100);
      document.getElementById('nps-display').textContent = nps;
      document.getElementById('nps-promoters-pct').textContent = Math.round((promoters / total) * 100) + '%';
      document.getElementById('nps-passives-pct').textContent = Math.round((passives / total) * 100) + '%';
      document.getElementById('nps-detractors-pct').textContent = Math.round((detractors / total) * 100) + '%';
      
      tbody.innerHTML = npsResponses.sort((a, b) => new Date(b.created_at) - new Date(a.created_at)).map(n => {
        const category = n.score >= 9 ? 'Promoter' : n.score >= 7 ? 'Passive' : 'Detractor';
        const badgeClass = n.score >= 9 ? 'badge-success' : n.score >= 7 ? 'badge-warning' : 'badge-danger';
        return `
          <tr>
            <td>${new Date(n.created_at).toLocaleDateString()}</td>
            <td>${escapeHtml(n.client_name)}</td>
            <td><strong>${n.score}</strong></td>
            <td><span class="badge ${badgeClass}">${category}</span></td>
            <td>${escapeHtml(n.feedback || '-')}</td>
          </tr>
        `;
      }).join('');
    }

    async function submitNPS() {
      const clientSelect = document.getElementById('nps-client');
      const score = parseInt(document.getElementById('nps-score').value);
      const feedback = document.getElementById('nps-feedback').value;
      
      if (!clientSelect.value || isNaN(score) || score < 0 || score > 10) {
        showToast('Please select a client and enter a valid score (0-10)', 'error');
        return;
      }
      
      try {
        await api('/api/nps', 'POST', {
          client_id: parseInt(clientSelect.value),
          client_name: clientSelect.options[clientSelect.selectedIndex].text,
          score,
          feedback
        });
        document.getElementById('nps-score').value = '';
        document.getElementById('nps-feedback').value = '';
        loadAll();
        showToast('NPS response recorded!', 'success');
      } catch (e) {
        showToast('Error recording NPS', 'error');
      }
    }

    // Case Studies
    function loadCaseStudies() {
      const grid = document.getElementById('case-studies-grid');
      
      if (caseStudies.length === 0) {
        grid.innerHTML = `
          <div style="grid-column: 1/-1; text-align: center; padding: 3rem; color: #64748b;">
            <i class="fas fa-file-alt" style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem;"></i>
            <p>No case studies yet. Create your first one!</p>
          </div>
        `;
        return;
      }
      
      grid.innerHTML = caseStudies.map(cs => `
        <div class="case-study-card">
          <div class="case-study-header">
            <h3 style="margin-bottom: 0.25rem;">${escapeHtml(cs.client_name)}</h3>
            <small style="opacity: 0.8;">${escapeHtml(cs.property_type || 'Property')}</small>
          </div>
          <div class="case-study-body">
            ${cs.challenge ? `
              <div class="case-study-section">
                <div class="case-study-section-title"><i class="fas fa-exclamation-circle"></i> Challenge</div>
                <p style="color: #64748b; font-size: 0.875rem;">${escapeHtml(cs.challenge)}</p>
              </div>
            ` : ''}
            ${cs.solution ? `
              <div class="case-study-section">
                <div class="case-study-section-title"><i class="fas fa-lightbulb"></i> Solution</div>
                <p style="color: #64748b; font-size: 0.875rem;">${escapeHtml(cs.solution)}</p>
              </div>
            ` : ''}
            ${cs.results ? `
              <div class="case-study-section">
                <div class="case-study-section-title"><i class="fas fa-chart-line"></i> Results</div>
                <p style="color: #64748b; font-size: 0.875rem;">${escapeHtml(cs.results)}</p>
              </div>
            ` : ''}
            ${cs.metric1_label || cs.metric2_label || cs.metric3_label ? `
              <div class="metrics-row">
                ${cs.metric1_label ? `<div class="metric-box"><div class="metric-value">${escapeHtml(cs.metric1_value)}</div><div class="metric-label">${escapeHtml(cs.metric1_label)}</div></div>` : ''}
                ${cs.metric2_label ? `<div class="metric-box"><div class="metric-value">${escapeHtml(cs.metric2_value)}</div><div class="metric-label">${escapeHtml(cs.metric2_label)}</div></div>` : ''}
                ${cs.metric3_label ? `<div class="metric-box"><div class="metric-value">${escapeHtml(cs.metric3_value)}</div><div class="metric-label">${escapeHtml(cs.metric3_label)}</div></div>` : ''}
              </div>
            ` : ''}
            ${cs.quote ? `
              <div style="margin-top: 1rem; padding: 1rem; background: #f8fafc; border-radius: 8px; font-style: italic; color: #475569;">
                "${escapeHtml(cs.quote)}"
              </div>
            ` : ''}
          </div>
          <div style="padding: 0 1.5rem 1.5rem; display: flex; gap: 0.5rem;">
            <button class="btn btn-sm btn-secondary" onclick="copyCaseStudy(${cs.id})">
              <i class="fas fa-copy"></i> Copy
            </button>
            <button class="btn btn-sm btn-danger" onclick="deleteCaseStudy(${cs.id})">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>
      `).join('');
    }

    async function saveCaseStudy() {
      const form = document.getElementById('case-study-form');
      const data = {
        client_name: form.client_name.value,
        property_type: form.property_type.value,
        challenge: form.challenge.value,
        solution: form.solution.value,
        results: form.results.value,
        metric1_label: form.metric1_label.value,
        metric1_value: form.metric1_value.value,
        metric2_label: form.metric2_label.value,
        metric2_value: form.metric2_value.value,
        metric3_label: form.metric3_label.value,
        metric3_value: form.metric3_value.value,
        quote: form.quote.value
      };
      
      if (!data.client_name) {
        showToast('Please enter client name', 'error');
        return;
      }
      
      try {
        await api('/api/case-studies', 'POST', data);
        closeModal('add-case-study');
        form.reset();
        loadAll();
        showToast('Case study created!', 'success');
      } catch (e) {
        showToast('Error creating case study', 'error');
      }
    }

    function copyCaseStudy(id) {
      const cs = caseStudies.find(x => x.id === id);
      if (!cs) return;
      
      const text = `
${cs.client_name} Case Study

CHALLENGE:
${cs.challenge || 'N/A'}

SOLUTION:
${cs.solution || 'N/A'}

RESULTS:
${cs.results || 'N/A'}

KEY METRICS:
${cs.metric1_label ? `â€¢ ${cs.metric1_label}: ${cs.metric1_value}` : ''}
${cs.metric2_label ? `â€¢ ${cs.metric2_label}: ${cs.metric2_value}` : ''}
${cs.metric3_label ? `â€¢ ${cs.metric3_label}: ${cs.metric3_value}` : ''}

${cs.quote ? `"${cs.quote}"` : ''}
      `.trim();
      
      copyToClipboard(text);
    }

    async function deleteCaseStudy(id) {
      if (!confirm('Delete this case study?')) return;
      try {
        await api(`/api/case-studies/${id}`, 'DELETE');
        loadAll();
        showToast('Case study deleted', 'success');
      } catch (e) {
        showToast('Error deleting case study', 'error');
      }
    }

    // Social Proof Assets
    function populateQuoteDropdown() {
      const select = document.getElementById('quote-testimonial');
      select.innerHTML = '<option value="">Choose a testimonial...</option>' + 
        testimonials.filter(t => t.public_permission !== false).map(t => 
          `<option value="${t.id}">${t.contact_name} - ${t.property_name}</option>`
        ).join('');
    }

    function updateQuotePreview() {
      const select = document.getElementById('quote-testimonial');
      const container = document.getElementById('quote-preview-container');
      
      if (!select.value) {
        container.innerHTML = '';
        return;
      }
      
      const t = testimonials.find(x => x.id === parseInt(select.value));
      if (!t) return;
      
      container.innerHTML = `
        <div class="quote-preview" id="quote-graphic">
          <div class="quote-preview-text">"${escapeHtml(t.testimonial)}"</div>
          <div class="quote-preview-author">â€” ${escapeHtml(t.contact_name)}</div>
          <div class="quote-preview-company">${escapeHtml(t.contact_role || '')}${t.contact_role && t.property_name ? ', ' : ''}${escapeHtml(t.property_name)}</div>
          <div class="quote-preview-logo">KANDE VENDTECH</div>
        </div>
      `;
    }

    function copyQuoteText() {
      const select = document.getElementById('quote-testimonial');
      if (!select.value) {
        showToast('Please select a testimonial first', 'error');
        return;
      }
      
      const t = testimonials.find(x => x.id === parseInt(select.value));
      if (!t) return;
      
      const text = `"${t.testimonial}"\n\nâ€” ${t.contact_name}, ${t.contact_role || ''}, ${t.property_name}`;
      copyToClipboard(text);
    }

    function downloadQuoteGraphic() {
      showToast('Graphic download coming soon! For now, screenshot the preview.', 'info');
    }

    function copyProofStats() {
      const clients = document.getElementById('proof-clients').textContent;
      const years = document.getElementById('proof-years').textContent;
      const machines = document.getElementById('proof-machines').textContent;
      
      const text = `âœ… ${clients} Happy Clients | ðŸ† ${years} Years Experience | ðŸ¤– ${machines} Machines Deployed`;
      copyToClipboard(text);
    }

    function loadSnippets() {
      const container = document.getElementById('snippets-container');
      const featured = testimonials.filter(t => t.featured && t.public_permission !== false).slice(0, 3);
      
      if (featured.length === 0) {
        container.innerHTML = '<p style="color: #64748b;">Mark testimonials as featured to generate snippets</p>';
        return;
      }
      
      container.innerHTML = featured.map(t => `
        <div style="background: #f8fafc; padding: 1rem; border-radius: 8px; margin-bottom: 0.75rem;">
          <p style="font-style: italic; margin-bottom: 0.5rem;">"${escapeHtml(t.testimonial.substring(0, 150))}${t.testimonial.length > 150 ? '...' : ''}"</p>
          <small style="color: #64748b;">â€” ${escapeHtml(t.contact_name)}, ${escapeHtml(t.property_name)}</small>
          <button class="btn btn-sm btn-secondary" style="float: right;" onclick="copySnippet(${t.id})">
            <i class="fas fa-copy"></i>
          </button>
        </div>
      `).join('');
    }

    function copySnippet(id) {
      const t = testimonials.find(x => x.id === id);
      if (!t) return;
      copyToClipboard(`"${t.testimonial}" â€” ${t.contact_name}, ${t.property_name}`);
    }

    // Modals
    function openModal(name) {
      document.getElementById(`modal-${name}`).classList.add('active');
    }

    function closeModal(name) {
      document.getElementById(`modal-${name}`).classList.remove('active');
      if (name === 'add-testimonial') {
        editingId = null;
        document.getElementById('testimonial-form').reset();
        updateStars(document.getElementById('rating-input'), 5);
        document.getElementById('rating-value').value = 5;
      }
    }

    // Utilities
    function escapeHtml(str) {
      if (!str) return '';
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    function getInitials(name) {
      if (!name) return '?';
      return name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
    }

    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        showToast('Copied to clipboard!', 'success');
      }).catch(() => {
        showToast('Failed to copy', 'error');
      });
    }

    function showToast(message, type = 'info') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast show ${type}`;
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    // Close modals on overlay click
    document.querySelectorAll('.modal-overlay').forEach(overlay => {
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) {
          overlay.classList.remove('active');
        }
      });
    });
  </script>
</body>
</html>
