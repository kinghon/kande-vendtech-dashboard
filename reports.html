<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-vend-32.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-vend.png">
  <title>Reports ‚Äî Kande VendTech</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg: #f8fafc; --card: #ffffff; --border: #e2e8f0; --text: #0f172a;
      --muted: #64748b; --accent: #3b82f6; --accent-light: #eff6ff;
      --green: #22c55e; --green-light: #f0fdf4;
      --amber: #f59e0b; --amber-light: #fffbeb;
      --red: #ef4444; --red-light: #fef2f2;
      --purple: #8b5cf6; --purple-light: #f5f3ff;
      --radius: 12px;
    }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); }
    .dashboard { max-width: 1200px; margin: 0 auto; padding: 24px 28px 60px; }

    /* Page Header */
    .page-header {
      background: linear-gradient(135deg, #1e3a5f 0%, #2563eb 50%, #7c3aed 100%);
      border-radius: 16px; padding: 28px 36px; color: #fff; margin-bottom: 28px;
      position: relative; overflow: hidden;
    }
    .page-header::after {
      content: ''; position: absolute; top: -50%; right: -10%; width: 300px; height: 300px;
      background: radial-gradient(circle, rgba(255,255,255,0.08) 0%, transparent 70%);
      border-radius: 50%;
    }
    .page-header h1 { font-size: 1.5rem; font-weight: 700; margin-bottom: 4px; display: flex; align-items: center; gap: 12px; }
    .page-header p { font-size: 0.88rem; opacity: 0.85; }

    /* Grid Layout */
    .grid-3 { display: grid; grid-template-columns: 320px 1fr; gap: 24px; }
    @media (max-width: 900px) { .grid-3 { grid-template-columns: 1fr; } }

    /* Cards */
    .card {
      background: var(--card); border: 1px solid var(--border); border-radius: var(--radius);
      padding: 22px 24px;
    }
    .card-header {
      display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;
    }
    .card-title { font-size: 0.95rem; font-weight: 700; display: flex; align-items: center; gap: 8px; }

    /* Report Type Selector */
    .report-types { display: flex; flex-direction: column; gap: 8px; }
    .report-type-btn {
      display: flex; align-items: center; gap: 12px; padding: 14px 16px;
      background: var(--bg); border: 2px solid transparent; border-radius: 10px;
      cursor: pointer; transition: all 0.15s; text-align: left;
    }
    .report-type-btn:hover { border-color: var(--accent); background: var(--accent-light); }
    .report-type-btn.active { border-color: var(--accent); background: var(--accent-light); }
    .report-type-btn .rt-icon { font-size: 1.3rem; }
    .report-type-btn .rt-info { flex: 1; }
    .report-type-btn .rt-name { font-size: 0.88rem; font-weight: 600; color: var(--text); }
    .report-type-btn .rt-desc { font-size: 0.72rem; color: var(--muted); margin-top: 2px; }

    /* Form Controls */
    .form-group { margin-bottom: 18px; }
    .form-group label { display: block; font-size: 0.78rem; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    input[type="date"], select, input[type="text"] {
      width: 100%; padding: 10px 14px; font-size: 0.88rem; border: 1px solid var(--border);
      border-radius: 8px; background: var(--card); color: var(--text);
    }
    input:focus, select:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-light); }

    /* Checkboxes */
    .checkbox-group { display: flex; flex-wrap: wrap; gap: 8px; }
    .checkbox-item {
      display: flex; align-items: center; gap: 6px; padding: 8px 12px;
      background: var(--bg); border-radius: 6px; font-size: 0.82rem; cursor: pointer;
    }
    .checkbox-item:hover { background: var(--accent-light); }
    .checkbox-item input { width: 16px; height: 16px; accent-color: var(--accent); }

    /* Action Buttons */
    .btn-group { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 20px; }
    .btn {
      display: inline-flex; align-items: center; gap: 8px; padding: 12px 20px;
      font-size: 0.88rem; font-weight: 600; border-radius: 10px; cursor: pointer;
      transition: all 0.15s; border: none;
    }
    .btn-primary { background: var(--accent); color: #fff; }
    .btn-primary:hover { background: #2563eb; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(59,130,246,0.3); }
    .btn-secondary { background: var(--bg); color: var(--text); border: 1px solid var(--border); }
    .btn-secondary:hover { border-color: var(--accent); color: var(--accent); }
    .btn-success { background: var(--green); color: #fff; }
    .btn-success:hover { background: #16a34a; }

    /* Preview Section */
    .preview-section { margin-top: 24px; }
    .preview-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
    .preview-title { font-size: 1rem; font-weight: 700; }
    .preview-actions { display: flex; gap: 8px; }

    /* Report Preview */
    .report-preview {
      background: #fff; border: 1px solid var(--border); border-radius: var(--radius);
      min-height: 400px; padding: 32px; position: relative;
    }
    .report-preview.loading::after {
      content: 'Generating report...'; position: absolute; top: 50%; left: 50%;
      transform: translate(-50%, -50%); color: var(--muted); font-size: 0.9rem;
    }
    .report-preview .empty-state {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      min-height: 350px; color: var(--muted); text-align: center;
    }
    .report-preview .empty-state .icon { font-size: 3rem; margin-bottom: 12px; opacity: 0.5; }
    .report-preview .empty-state h3 { font-size: 1rem; font-weight: 600; margin-bottom: 4px; color: var(--text); }
    .report-preview .empty-state p { font-size: 0.85rem; }

    /* Report Content Styling */
    .report-content { font-size: 0.9rem; line-height: 1.6; }
    .report-content .report-title { font-size: 1.5rem; font-weight: 700; color: var(--text); margin-bottom: 4px; text-align: center; }
    .report-content .report-subtitle { font-size: 0.85rem; color: var(--muted); text-align: center; margin-bottom: 24px; }
    .report-content .report-logo { text-align: center; margin-bottom: 16px; }
    .report-content .report-logo img { height: 50px; }
    .report-content table { width: 100%; border-collapse: collapse; margin: 16px 0; }
    .report-content th { background: var(--bg); text-align: left; padding: 10px 12px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--muted); border-bottom: 2px solid var(--border); }
    .report-content td { padding: 10px 12px; border-bottom: 1px solid var(--border); }
    .report-content tr:hover td { background: var(--accent-light); }
    .report-content .summary-box { background: var(--bg); border-radius: 10px; padding: 16px 20px; margin: 16px 0; }
    .report-content .summary-row { display: flex; justify-content: space-between; margin-bottom: 8px; }
    .report-content .summary-row:last-child { margin-bottom: 0; font-weight: 700; border-top: 1px solid var(--border); padding-top: 8px; }
    .report-content .summary-label { color: var(--muted); }
    .report-content .summary-value { font-weight: 600; }
    .report-content .section-title { font-size: 1rem; font-weight: 700; margin: 24px 0 12px; padding-bottom: 8px; border-bottom: 2px solid var(--accent); }
    .report-content .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin: 16px 0; }
    .report-content .stat-item { background: var(--bg); border-radius: 10px; padding: 16px; text-align: center; }
    .report-content .stat-item .value { font-size: 1.5rem; font-weight: 800; color: var(--accent); }
    .report-content .stat-item .label { font-size: 0.72rem; color: var(--muted); text-transform: uppercase; margin-top: 4px; }

    /* Report History */
    .history-list { max-height: 300px; overflow-y: auto; }
    .history-item {
      display: flex; align-items: center; gap: 12px; padding: 12px 14px;
      border-bottom: 1px solid var(--border); cursor: pointer; transition: background 0.15s;
    }
    .history-item:hover { background: var(--accent-light); }
    .history-item:last-child { border-bottom: none; }
    .history-item .hi-icon { font-size: 1.2rem; }
    .history-item .hi-info { flex: 1; }
    .history-item .hi-name { font-size: 0.85rem; font-weight: 600; }
    .history-item .hi-meta { font-size: 0.72rem; color: var(--muted); }
    .history-item .hi-action { font-size: 0.75rem; color: var(--accent); font-weight: 600; }
    .history-empty { padding: 24px; text-align: center; color: var(--muted); font-size: 0.85rem; }

    /* Schedule Modal */
    .modal-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center;
      z-index: 1000; opacity: 0; visibility: hidden; transition: all 0.2s;
    }
    .modal-overlay.active { opacity: 1; visibility: visible; }
    .modal {
      background: var(--card); border-radius: 16px; width: 90%; max-width: 500px;
      padding: 28px; transform: scale(0.95); transition: transform 0.2s;
    }
    .modal-overlay.active .modal { transform: scale(1); }
    .modal-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
    .modal-title { font-size: 1.1rem; font-weight: 700; }
    .modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--muted); }
    .modal-close:hover { color: var(--text); }

    /* Print Styles */
    @media print {
      body { background: #fff; }
      .dashboard { padding: 0; max-width: none; }
      .page-header, .card:not(.preview-card), .btn-group, .preview-header, .preview-actions { display: none !important; }
      .grid-3 { display: block; }
      .report-preview { border: none; padding: 0; box-shadow: none; }
      .report-content { font-size: 11pt; }
      .report-content table { page-break-inside: avoid; }
    }

    /* Toast Notification */
    .toast {
      position: fixed; bottom: 24px; right: 24px; background: var(--text); color: #fff;
      padding: 14px 20px; border-radius: 10px; font-size: 0.88rem; font-weight: 500;
      transform: translateY(100px); opacity: 0; transition: all 0.3s;
      z-index: 1001;
    }
    .toast.show { transform: translateY(0); opacity: 1; }
    .toast.success { background: var(--green); }
    .toast.error { background: var(--red); }
  </style>
</head>
<body>
<script src="/nav.js"></script>

<div class="dashboard">
  <!-- Page Header -->
  <div class="page-header">
    <h1>üìä Reports</h1>
    <p>Generate and download comprehensive business reports</p>
  </div>

  <div class="grid-3">
    <!-- Left: Report Builder -->
    <div>
      <!-- Report Types -->
      <div class="card" style="margin-bottom: 20px;">
        <div class="card-header">
          <span class="card-title">üìã Report Type</span>
        </div>
        <div class="report-types" id="report-types">
          <button class="report-type-btn active" data-type="pipeline">
            <span class="rt-icon">üîÄ</span>
            <div class="rt-info">
              <div class="rt-name">Sales Pipeline</div>
              <div class="rt-desc">Prospects by stage and status</div>
            </div>
          </button>
          <button class="report-type-btn" data-type="activity">
            <span class="rt-icon">üìÖ</span>
            <div class="rt-info">
              <div class="rt-name">Activity Report</div>
              <div class="rt-desc">All activities by date range</div>
            </div>
          </button>
          <button class="report-type-btn" data-type="revenue">
            <span class="rt-icon">üí∞</span>
            <div class="rt-info">
              <div class="rt-name">Revenue Report</div>
              <div class="rt-desc">Revenue by location & period</div>
            </div>
          </button>
          <button class="report-type-btn" data-type="commission">
            <span class="rt-icon">ü§ù</span>
            <div class="rt-info">
              <div class="rt-name">Commission Report</div>
              <div class="rt-desc">Rev share calculations</div>
            </div>
          </button>
          <button class="report-type-btn" data-type="prospects">
            <span class="rt-icon">üìá</span>
            <div class="rt-info">
              <div class="rt-name">Prospect List Export</div>
              <div class="rt-desc">Full prospect data export</div>
            </div>
          </button>
          <button class="report-type-btn" data-type="machine">
            <span class="rt-icon">üè≠</span>
            <div class="rt-info">
              <div class="rt-name">Machine Performance</div>
              <div class="rt-desc">Sales & revenue by machine</div>
            </div>
          </button>
          <button class="report-type-btn" data-type="expense">
            <span class="rt-icon">üìâ</span>
            <div class="rt-info">
              <div class="rt-name">Expense Report</div>
              <div class="rt-desc">Costs and expenditures</div>
            </div>
          </button>
          <button class="report-type-btn" data-type="service">
            <span class="rt-icon">üîß</span>
            <div class="rt-info">
              <div class="rt-name">Service History</div>
              <div class="rt-desc">Restocks and maintenance</div>
            </div>
          </button>
        </div>
      </div>

      <!-- Filters -->
      <div class="card" style="margin-bottom: 20px;">
        <div class="card-header">
          <span class="card-title">üéõÔ∏è Filters</span>
        </div>
        
        <div class="form-group">
          <label>Date Range</label>
          <div class="form-row">
            <input type="date" id="date-from">
            <input type="date" id="date-to">
          </div>
        </div>

        <div class="form-group" id="filter-property-type">
          <label>Property Type</label>
          <select id="property-type">
            <option value="">All Types</option>
            <option value="apartments">Apartments</option>
            <option value="senior_living">Senior Living</option>
            <option value="healthcare">Healthcare</option>
            <option value="industrial">Industrial</option>
            <option value="office">Office</option>
          </select>
        </div>

        <div class="form-group" id="filter-status">
          <label>Status</label>
          <select id="status-filter">
            <option value="">All Statuses</option>
            <option value="new">New</option>
            <option value="active">Active</option>
            <option value="signed">Signed</option>
            <option value="closed">Closed</option>
          </select>
        </div>

        <div class="form-group" id="filter-machine" style="display:none;">
          <label>Machine</label>
          <select id="machine-filter">
            <option value="">All Machines</option>
          </select>
        </div>

        <div class="form-group" id="filter-columns" style="display:none;">
          <label>Include Columns</label>
          <div class="checkbox-group" id="column-checkboxes">
            <label class="checkbox-item"><input type="checkbox" value="name" checked> Name</label>
            <label class="checkbox-item"><input type="checkbox" value="address" checked> Address</label>
            <label class="checkbox-item"><input type="checkbox" value="phone" checked> Phone</label>
            <label class="checkbox-item"><input type="checkbox" value="email" checked> Email</label>
            <label class="checkbox-item"><input type="checkbox" value="status" checked> Status</label>
            <label class="checkbox-item"><input type="checkbox" value="property_type" checked> Type</label>
            <label class="checkbox-item"><input type="checkbox" value="units"> Units</label>
            <label class="checkbox-item"><input type="checkbox" value="notes"> Notes</label>
          </div>
        </div>

        <div class="btn-group">
          <button class="btn btn-primary" id="generate-btn">üìä Generate Report</button>
          <button class="btn btn-secondary" id="schedule-btn">‚è∞ Schedule</button>
        </div>
      </div>

      <!-- Report History -->
      <div class="card">
        <div class="card-header">
          <span class="card-title">üïê Recent Reports</span>
        </div>
        <div class="history-list" id="history-list">
          <div class="history-empty">No reports generated yet</div>
        </div>
      </div>
    </div>

    <!-- Right: Preview & Export -->
    <div>
      <div class="card preview-card">
        <div class="preview-header">
          <span class="preview-title" id="preview-title">Report Preview</span>
          <div class="preview-actions">
            <button class="btn btn-secondary" id="export-csv" disabled>üì• CSV</button>
            <button class="btn btn-secondary" id="export-excel" disabled>üìä Excel</button>
            <button class="btn btn-success" id="export-pdf" disabled>üìÑ PDF</button>
          </div>
        </div>
        <div class="report-preview" id="report-preview">
          <div class="empty-state">
            <div class="icon">üìä</div>
            <h3>Select a Report Type</h3>
            <p>Choose a report type and configure filters, then click Generate</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Schedule Modal -->
<div class="modal-overlay" id="schedule-modal">
  <div class="modal">
    <div class="modal-header">
      <span class="modal-title">‚è∞ Schedule Report</span>
      <button class="modal-close" id="close-modal">&times;</button>
    </div>
    <div class="form-group">
      <label>Frequency</label>
      <select id="schedule-frequency">
        <option value="weekly">Weekly (Every Monday)</option>
        <option value="monthly">Monthly (1st of month)</option>
        <option value="daily">Daily</option>
      </select>
    </div>
    <div class="form-group">
      <label>Email Recipients</label>
      <input type="text" id="schedule-email" placeholder="email@example.com">
    </div>
    <div class="form-group">
      <label>Include Format</label>
      <div class="checkbox-group">
        <label class="checkbox-item"><input type="checkbox" value="pdf" checked> PDF</label>
        <label class="checkbox-item"><input type="checkbox" value="csv"> CSV</label>
        <label class="checkbox-item"><input type="checkbox" value="excel"> Excel</label>
      </div>
    </div>
    <div class="btn-group" style="justify-content: flex-end;">
      <button class="btn btn-secondary" id="cancel-schedule">Cancel</button>
      <button class="btn btn-primary" id="save-schedule">Save Schedule</button>
    </div>
    <p style="font-size: 0.75rem; color: var(--muted); margin-top: 16px; text-align: center;">
      ‚ÑπÔ∏è Scheduled reports are a placeholder feature ‚Äî email delivery coming soon
    </p>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
(function() {
  'use strict';

  // State
  let currentReportType = 'pipeline';
  let reportData = null;
  let reportHistory = JSON.parse(localStorage.getItem('reportHistory') || '[]');

  // DOM Elements
  const reportTypeBtns = document.querySelectorAll('.report-type-btn');
  const generateBtn = document.getElementById('generate-btn');
  const scheduleBtn = document.getElementById('schedule-btn');
  const exportCsv = document.getElementById('export-csv');
  const exportExcel = document.getElementById('export-excel');
  const exportPdf = document.getElementById('export-pdf');
  const reportPreview = document.getElementById('report-preview');
  const previewTitle = document.getElementById('preview-title');
  const historyList = document.getElementById('history-list');
  const scheduleModal = document.getElementById('schedule-modal');
  const toast = document.getElementById('toast');

  // Initialize
  init();

  function init() {
    // Set default dates (last 30 days)
    const today = new Date();
    const thirtyDaysAgo = new Date(today - 30 * 24 * 60 * 60 * 1000);
    document.getElementById('date-to').value = today.toISOString().split('T')[0];
    document.getElementById('date-from').value = thirtyDaysAgo.toISOString().split('T')[0];

    // Event listeners
    reportTypeBtns.forEach(btn => {
      btn.addEventListener('click', () => selectReportType(btn.dataset.type));
    });

    generateBtn.addEventListener('click', generateReport);
    scheduleBtn.addEventListener('click', () => scheduleModal.classList.add('active'));
    document.getElementById('close-modal').addEventListener('click', () => scheduleModal.classList.remove('active'));
    document.getElementById('cancel-schedule').addEventListener('click', () => scheduleModal.classList.remove('active'));
    document.getElementById('save-schedule').addEventListener('click', saveSchedule);

    exportCsv.addEventListener('click', () => exportReport('csv'));
    exportExcel.addEventListener('click', () => exportReport('excel'));
    exportPdf.addEventListener('click', () => exportReport('pdf'));

    // Load machines for filter
    loadMachines();

    // Render history
    renderHistory();
  }

  function selectReportType(type) {
    currentReportType = type;
    reportTypeBtns.forEach(btn => btn.classList.toggle('active', btn.dataset.type === type));

    // Show/hide relevant filters
    const filterPropertyType = document.getElementById('filter-property-type');
    const filterStatus = document.getElementById('filter-status');
    const filterMachine = document.getElementById('filter-machine');
    const filterColumns = document.getElementById('filter-columns');

    filterPropertyType.style.display = ['pipeline', 'prospects', 'activity'].includes(type) ? 'block' : 'none';
    filterStatus.style.display = ['pipeline', 'prospects'].includes(type) ? 'block' : 'none';
    filterMachine.style.display = ['machine', 'service', 'revenue'].includes(type) ? 'block' : 'none';
    filterColumns.style.display = type === 'prospects' ? 'block' : 'none';
  }

  async function loadMachines() {
    try {
      const res = await fetch('/api/machines');
      const machines = await res.json();
      const select = document.getElementById('machine-filter');
      machines.forEach(m => {
        const opt = document.createElement('option');
        opt.value = m.id;
        opt.textContent = m.name || `Machine #${m.id}`;
        select.appendChild(opt);
      });
    } catch (e) { console.error('Failed to load machines:', e); }
  }

  async function generateReport() {
    const dateFrom = document.getElementById('date-from').value;
    const dateTo = document.getElementById('date-to').value;
    const propertyType = document.getElementById('property-type').value;
    const status = document.getElementById('status-filter').value;
    const machineId = document.getElementById('machine-filter').value;

    reportPreview.innerHTML = '<div class="empty-state"><div class="icon">‚è≥</div><h3>Generating Report...</h3></div>';

    try {
      let data;
      switch (currentReportType) {
        case 'pipeline':
          data = await fetchPipelineReport(dateFrom, dateTo, propertyType, status);
          break;
        case 'activity':
          data = await fetchActivityReport(dateFrom, dateTo, propertyType);
          break;
        case 'revenue':
          data = await fetchRevenueReport(dateFrom, dateTo, machineId);
          break;
        case 'commission':
          data = await fetchCommissionReport(dateFrom, dateTo);
          break;
        case 'prospects':
          data = await fetchProspectsReport(propertyType, status);
          break;
        case 'machine':
          data = await fetchMachineReport(dateFrom, dateTo, machineId);
          break;
        case 'expense':
          data = await fetchExpenseReport(dateFrom, dateTo);
          break;
        case 'service':
          data = await fetchServiceReport(dateFrom, dateTo, machineId);
          break;
      }

      reportData = data;
      renderReport(data);
      enableExports();
      addToHistory(currentReportType, dateFrom, dateTo);
      showToast('Report generated successfully', 'success');

    } catch (e) {
      console.error('Report generation failed:', e);
      reportPreview.innerHTML = '<div class="empty-state"><div class="icon">‚ùå</div><h3>Generation Failed</h3><p>' + e.message + '</p></div>';
      showToast('Failed to generate report', 'error');
    }
  }

  // Fetch functions for each report type
  async function fetchPipelineReport(from, to, propertyType, status) {
    const [prospects, activities] = await Promise.all([
      fetch('/api/prospects').then(r => r.json()),
      fetch('/api/activities').then(r => r.json())
    ]);

    let filtered = prospects;
    if (propertyType) filtered = filtered.filter(p => p.property_type === propertyType);
    if (status) filtered = filtered.filter(p => p.status === status);
    if (from) filtered = filtered.filter(p => p.created_at >= from);
    if (to) filtered = filtered.filter(p => p.created_at <= to + 'T23:59:59');

    const byStatus = { new: [], active: [], signed: [], closed: [] };
    filtered.forEach(p => {
      if (byStatus[p.status]) byStatus[p.status].push(p);
    });

    const byPropertyType = {};
    filtered.forEach(p => {
      const pt = p.property_type || 'Unknown';
      if (!byPropertyType[pt]) byPropertyType[pt] = 0;
      byPropertyType[pt]++;
    });

    return {
      type: 'pipeline',
      title: 'Sales Pipeline Report',
      dateRange: { from, to },
      summary: {
        total: filtered.length,
        new: byStatus.new.length,
        active: byStatus.active.length,
        signed: byStatus.signed.length,
        closed: byStatus.closed.length,
        conversionRate: filtered.length > 0 ? ((byStatus.signed.length / filtered.length) * 100).toFixed(1) : 0
      },
      byStatus,
      byPropertyType,
      prospects: filtered
    };
  }

  async function fetchActivityReport(from, to, propertyType) {
    const [activities, prospects] = await Promise.all([
      fetch('/api/activities').then(r => r.json()),
      fetch('/api/prospects').then(r => r.json())
    ]);

    const prospectMap = {};
    prospects.forEach(p => prospectMap[p.id] = p);

    let filtered = activities;
    if (from) filtered = filtered.filter(a => a.created_at >= from);
    if (to) filtered = filtered.filter(a => a.created_at <= to + 'T23:59:59');
    if (propertyType) {
      filtered = filtered.filter(a => {
        const p = prospectMap[a.prospect_id];
        return p && p.property_type === propertyType;
      });
    }

    const byType = {};
    filtered.forEach(a => {
      const t = a.type || 'other';
      if (!byType[t]) byType[t] = 0;
      byType[t]++;
    });

    return {
      type: 'activity',
      title: 'Activity Report',
      dateRange: { from, to },
      summary: {
        total: filtered.length,
        byType
      },
      activities: filtered.map(a => ({
        ...a,
        prospect_name: prospectMap[a.prospect_id]?.name || 'Unknown'
      })).sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
    };
  }

  async function fetchRevenueReport(from, to, machineId) {
    const [finances, locations, machines] = await Promise.all([
      fetch('/api/finances?type=revenue').then(r => r.json()),
      fetch('/api/locations').then(r => r.json()),
      fetch('/api/machines').then(r => r.json())
    ]);

    let filtered = finances;
    if (from) filtered = filtered.filter(f => f.month >= from.slice(0, 7));
    if (to) filtered = filtered.filter(f => f.month <= to.slice(0, 7));
    if (machineId) filtered = filtered.filter(f => f.machine_id === parseInt(machineId));

    const byMonth = {};
    const byLocation = {};
    let total = 0;

    filtered.forEach(f => {
      total += f.amount || 0;
      const month = f.month || 'Unknown';
      if (!byMonth[month]) byMonth[month] = 0;
      byMonth[month] += f.amount || 0;

      const loc = locations.find(l => l.id === f.location_id);
      const locName = loc?.name || 'Unknown';
      if (!byLocation[locName]) byLocation[locName] = 0;
      byLocation[locName] += f.amount || 0;
    });

    return {
      type: 'revenue',
      title: 'Revenue Report',
      dateRange: { from, to },
      summary: { total, recordCount: filtered.length },
      byMonth,
      byLocation,
      records: filtered
    };
  }

  async function fetchCommissionReport(from, to) {
    const [finances, locations, prospects] = await Promise.all([
      fetch('/api/finances?type=revenue').then(r => r.json()),
      fetch('/api/locations').then(r => r.json()),
      fetch('/api/prospects').then(r => r.json())
    ]);

    let filtered = finances;
    if (from) filtered = filtered.filter(f => f.month >= from.slice(0, 7));
    if (to) filtered = filtered.filter(f => f.month <= to.slice(0, 7));

    // Calculate commissions (default 5% rev share starting month 6)
    const locationRevenue = {};
    filtered.forEach(f => {
      const locId = f.location_id;
      if (!locationRevenue[locId]) locationRevenue[locId] = { total: 0, months: new Set() };
      locationRevenue[locId].total += f.amount || 0;
      if (f.month) locationRevenue[locId].months.add(f.month);
    });

    const commissions = Object.entries(locationRevenue).map(([locId, data]) => {
      const loc = locations.find(l => l.id === parseInt(locId));
      const prospect = prospects.find(p => p.id === loc?.prospect_id);
      const revShare = prospect?.rev_share || 0.05; // Default 5%
      const eligible = data.months.size >= 6;
      const commission = eligible ? data.total * revShare : 0;
      return {
        location_id: locId,
        location_name: loc?.name || prospect?.name || 'Unknown',
        revenue: data.total,
        months_active: data.months.size,
        rev_share_rate: revShare * 100,
        eligible,
        commission
      };
    }).sort((a, b) => b.commission - a.commission);

    const totalCommission = commissions.reduce((s, c) => s + c.commission, 0);
    const totalRevenue = commissions.reduce((s, c) => s + c.revenue, 0);

    return {
      type: 'commission',
      title: 'Commission Report',
      dateRange: { from, to },
      summary: { totalRevenue, totalCommission, locationCount: commissions.length },
      commissions
    };
  }

  async function fetchProspectsReport(propertyType, status) {
    const prospects = await fetch('/api/prospects').then(r => r.json());

    let filtered = prospects;
    if (propertyType) filtered = filtered.filter(p => p.property_type === propertyType);
    if (status) filtered = filtered.filter(p => p.status === status);

    // Get selected columns
    const columns = [];
    document.querySelectorAll('#column-checkboxes input:checked').forEach(cb => columns.push(cb.value));

    return {
      type: 'prospects',
      title: 'Prospect List Export',
      summary: { total: filtered.length, columns },
      columns,
      prospects: filtered
    };
  }

  async function fetchMachineReport(from, to, machineId) {
    const [machines, sales, restocks] = await Promise.all([
      fetch('/api/machines').then(r => r.json()),
      fetch('/api/sales').then(r => r.json()),
      fetch('/api/restocks').then(r => r.json())
    ]);

    let targetMachines = machines;
    if (machineId) targetMachines = machines.filter(m => m.id === parseInt(machineId));

    const machineData = targetMachines.map(m => {
      let machineSales = sales.filter(s => s.machine_id === m.id);
      if (from) machineSales = machineSales.filter(s => s.date >= from);
      if (to) machineSales = machineSales.filter(s => s.date <= to);

      const revenue = machineSales.reduce((s, sale) => s + (sale.total || 0), 0);
      const units = machineSales.reduce((s, sale) => s + (sale.quantity || 1), 0);
      const restockCount = restocks.filter(r => r.machine_id === m.id).length;

      return {
        id: m.id,
        name: m.name || `Machine #${m.id}`,
        status: m.status,
        location: m.location_name || 'Unassigned',
        revenue,
        units,
        restocks: restockCount,
        avg_per_sale: units > 0 ? (revenue / units).toFixed(2) : 0
      };
    }).sort((a, b) => b.revenue - a.revenue);

    const totalRevenue = machineData.reduce((s, m) => s + m.revenue, 0);
    const totalUnits = machineData.reduce((s, m) => s + m.units, 0);

    return {
      type: 'machine',
      title: 'Machine Performance Report',
      dateRange: { from, to },
      summary: { totalRevenue, totalUnits, machineCount: machineData.length },
      machines: machineData
    };
  }

  async function fetchExpenseReport(from, to) {
    const finances = await fetch('/api/finances?type=expense').then(r => r.json());

    let filtered = finances;
    if (from) filtered = filtered.filter(f => f.month >= from.slice(0, 7));
    if (to) filtered = filtered.filter(f => f.month <= to.slice(0, 7));

    const byCategory = {};
    const byMonth = {};
    let total = 0;

    filtered.forEach(f => {
      total += f.amount || 0;
      const cat = f.category || 'Other';
      if (!byCategory[cat]) byCategory[cat] = 0;
      byCategory[cat] += f.amount || 0;

      const month = f.month || 'Unknown';
      if (!byMonth[month]) byMonth[month] = 0;
      byMonth[month] += f.amount || 0;
    });

    return {
      type: 'expense',
      title: 'Expense Report',
      dateRange: { from, to },
      summary: { total, recordCount: filtered.length },
      byCategory,
      byMonth,
      records: filtered.sort((a, b) => (b.amount || 0) - (a.amount || 0))
    };
  }

  async function fetchServiceReport(from, to, machineId) {
    const [restocks, machines] = await Promise.all([
      fetch('/api/restocks').then(r => r.json()),
      fetch('/api/machines').then(r => r.json())
    ]);

    const machineMap = {};
    machines.forEach(m => machineMap[m.id] = m);

    let filtered = restocks;
    if (from) filtered = filtered.filter(r => r.created_at >= from);
    if (to) filtered = filtered.filter(r => r.created_at <= to + 'T23:59:59');
    if (machineId) filtered = filtered.filter(r => r.machine_id === parseInt(machineId));

    const byMachine = {};
    filtered.forEach(r => {
      const mId = r.machine_id;
      if (!byMachine[mId]) byMachine[mId] = { name: machineMap[mId]?.name || `Machine #${mId}`, count: 0 };
      byMachine[mId].count++;
    });

    return {
      type: 'service',
      title: 'Service History Report',
      dateRange: { from, to },
      summary: { total: filtered.length },
      byMachine: Object.values(byMachine).sort((a, b) => b.count - a.count),
      records: filtered.sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
    };
  }

  // Render report based on type
  function renderReport(data) {
    const dateStr = data.dateRange?.from && data.dateRange?.to 
      ? `${formatDate(data.dateRange.from)} ‚Äî ${formatDate(data.dateRange.to)}`
      : 'All Time';

    let html = `
      <div class="report-content">
        <div class="report-logo">
          <img src="/logo.png" alt="Kande VendTech" onerror="this.style.display='none'">
        </div>
        <div class="report-title">${data.title}</div>
        <div class="report-subtitle">Generated ${new Date().toLocaleDateString()} | ${dateStr}</div>
    `;

    switch (data.type) {
      case 'pipeline':
        html += renderPipelineReport(data);
        break;
      case 'activity':
        html += renderActivityReport(data);
        break;
      case 'revenue':
        html += renderRevenueReport(data);
        break;
      case 'commission':
        html += renderCommissionReport(data);
        break;
      case 'prospects':
        html += renderProspectsReport(data);
        break;
      case 'machine':
        html += renderMachineReport(data);
        break;
      case 'expense':
        html += renderExpenseReport(data);
        break;
      case 'service':
        html += renderServiceReport(data);
        break;
    }

    html += '</div>';
    reportPreview.innerHTML = html;
    previewTitle.textContent = data.title;
  }

  function renderPipelineReport(data) {
    return `
      <div class="stat-grid">
        <div class="stat-item"><div class="value">${data.summary.total}</div><div class="label">Total Prospects</div></div>
        <div class="stat-item"><div class="value">${data.summary.new}</div><div class="label">New</div></div>
        <div class="stat-item"><div class="value">${data.summary.active}</div><div class="label">Active</div></div>
        <div class="stat-item"><div class="value">${data.summary.signed}</div><div class="label">Signed</div></div>
        <div class="stat-item"><div class="value">${data.summary.closed}</div><div class="label">Closed</div></div>
        <div class="stat-item"><div class="value">${data.summary.conversionRate}%</div><div class="label">Conversion Rate</div></div>
      </div>
      <div class="section-title">By Property Type</div>
      <div class="summary-box">
        ${Object.entries(data.byPropertyType).map(([type, count]) => `
          <div class="summary-row">
            <span class="summary-label">${type.replace(/_/g, ' ')}</span>
            <span class="summary-value">${count}</span>
          </div>
        `).join('')}
      </div>
      <div class="section-title">Pipeline Detail</div>
      <table>
        <thead><tr><th>Name</th><th>Type</th><th>Status</th><th>Priority</th><th>Created</th></tr></thead>
        <tbody>
          ${data.prospects.slice(0, 50).map(p => `
            <tr>
              <td>${esc(p.name)}</td>
              <td>${p.property_type || '‚Äî'}</td>
              <td>${p.status || '‚Äî'}</td>
              <td>${p.priority || 'normal'}</td>
              <td>${formatDate(p.created_at)}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
      ${data.prospects.length > 50 ? `<p style="color:var(--muted);font-size:0.8rem;text-align:center;">Showing first 50 of ${data.prospects.length} records</p>` : ''}
    `;
  }

  function renderActivityReport(data) {
    return `
      <div class="stat-grid">
        <div class="stat-item"><div class="value">${data.summary.total}</div><div class="label">Total Activities</div></div>
        ${Object.entries(data.summary.byType).slice(0, 4).map(([type, count]) => `
          <div class="stat-item"><div class="value">${count}</div><div class="label">${type.replace(/_/g, ' ')}</div></div>
        `).join('')}
      </div>
      <div class="section-title">Activity Log</div>
      <table>
        <thead><tr><th>Date</th><th>Type</th><th>Prospect</th><th>Description</th></tr></thead>
        <tbody>
          ${data.activities.slice(0, 100).map(a => `
            <tr>
              <td>${formatDate(a.created_at)}</td>
              <td>${a.type || '‚Äî'}</td>
              <td>${esc(a.prospect_name)}</td>
              <td>${esc(a.description || '‚Äî')}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    `;
  }

  function renderRevenueReport(data) {
    return `
      <div class="stat-grid">
        <div class="stat-item"><div class="value">${money(data.summary.total)}</div><div class="label">Total Revenue</div></div>
        <div class="stat-item"><div class="value">${data.summary.recordCount}</div><div class="label">Records</div></div>
      </div>
      <div class="section-title">Revenue by Month</div>
      <div class="summary-box">
        ${Object.entries(data.byMonth).sort().reverse().map(([month, amt]) => `
          <div class="summary-row">
            <span class="summary-label">${month}</span>
            <span class="summary-value">${money(amt)}</span>
          </div>
        `).join('')}
      </div>
      <div class="section-title">Revenue by Location</div>
      <table>
        <thead><tr><th>Location</th><th>Revenue</th></tr></thead>
        <tbody>
          ${Object.entries(data.byLocation).sort((a,b) => b[1] - a[1]).map(([loc, amt]) => `
            <tr><td>${esc(loc)}</td><td>${money(amt)}</td></tr>
          `).join('')}
        </tbody>
      </table>
    `;
  }

  function renderCommissionReport(data) {
    return `
      <div class="stat-grid">
        <div class="stat-item"><div class="value">${money(data.summary.totalRevenue)}</div><div class="label">Total Revenue</div></div>
        <div class="stat-item"><div class="value">${money(data.summary.totalCommission)}</div><div class="label">Total Commissions</div></div>
        <div class="stat-item"><div class="value">${data.summary.locationCount}</div><div class="label">Locations</div></div>
      </div>
      <div class="section-title">Commission Details</div>
      <table>
        <thead><tr><th>Location</th><th>Revenue</th><th>Months</th><th>Rate</th><th>Eligible</th><th>Commission</th></tr></thead>
        <tbody>
          ${data.commissions.map(c => `
            <tr>
              <td>${esc(c.location_name)}</td>
              <td>${money(c.revenue)}</td>
              <td>${c.months_active}</td>
              <td>${c.rev_share_rate}%</td>
              <td>${c.eligible ? '‚úÖ' : '‚ùå (< 6 mo)'}</td>
              <td>${money(c.commission)}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
      <div class="summary-box" style="margin-top:20px;">
        <div class="summary-row"><span class="summary-label">Total Commissions Due</span><span class="summary-value">${money(data.summary.totalCommission)}</span></div>
      </div>
    `;
  }

  function renderProspectsReport(data) {
    const cols = data.columns;
    return `
      <div class="stat-grid">
        <div class="stat-item"><div class="value">${data.summary.total}</div><div class="label">Total Prospects</div></div>
      </div>
      <div class="section-title">Prospect List</div>
      <table>
        <thead><tr>${cols.map(c => `<th>${c.replace(/_/g, ' ')}</th>`).join('')}</tr></thead>
        <tbody>
          ${data.prospects.map(p => `
            <tr>${cols.map(c => `<td>${esc(p[c] || '‚Äî')}</td>`).join('')}</tr>
          `).join('')}
        </tbody>
      </table>
    `;
  }

  function renderMachineReport(data) {
    return `
      <div class="stat-grid">
        <div class="stat-item"><div class="value">${money(data.summary.totalRevenue)}</div><div class="label">Total Revenue</div></div>
        <div class="stat-item"><div class="value">${data.summary.totalUnits}</div><div class="label">Units Sold</div></div>
        <div class="stat-item"><div class="value">${data.summary.machineCount}</div><div class="label">Machines</div></div>
      </div>
      <div class="section-title">Machine Performance</div>
      <table>
        <thead><tr><th>Machine</th><th>Status</th><th>Location</th><th>Revenue</th><th>Units</th><th>Restocks</th><th>Avg/Sale</th></tr></thead>
        <tbody>
          ${data.machines.map(m => `
            <tr>
              <td>${esc(m.name)}</td>
              <td>${m.status}</td>
              <td>${esc(m.location)}</td>
              <td>${money(m.revenue)}</td>
              <td>${m.units}</td>
              <td>${m.restocks}</td>
              <td>${money(m.avg_per_sale)}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    `;
  }

  function renderExpenseReport(data) {
    return `
      <div class="stat-grid">
        <div class="stat-item"><div class="value">${money(data.summary.total)}</div><div class="label">Total Expenses</div></div>
        <div class="stat-item"><div class="value">${data.summary.recordCount}</div><div class="label">Records</div></div>
      </div>
      <div class="section-title">Expenses by Category</div>
      <div class="summary-box">
        ${Object.entries(data.byCategory).sort((a,b) => b[1] - a[1]).map(([cat, amt]) => `
          <div class="summary-row">
            <span class="summary-label">${cat}</span>
            <span class="summary-value">${money(amt)}</span>
          </div>
        `).join('')}
        <div class="summary-row"><span class="summary-label">Total</span><span class="summary-value">${money(data.summary.total)}</span></div>
      </div>
      <div class="section-title">Expense Details</div>
      <table>
        <thead><tr><th>Month</th><th>Category</th><th>Description</th><th>Amount</th></tr></thead>
        <tbody>
          ${data.records.slice(0, 50).map(r => `
            <tr>
              <td>${r.month || '‚Äî'}</td>
              <td>${r.category || '‚Äî'}</td>
              <td>${esc(r.description || '‚Äî')}</td>
              <td>${money(r.amount || 0)}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    `;
  }

  function renderServiceReport(data) {
    return `
      <div class="stat-grid">
        <div class="stat-item"><div class="value">${data.summary.total}</div><div class="label">Total Service Events</div></div>
      </div>
      <div class="section-title">Service by Machine</div>
      <div class="summary-box">
        ${data.byMachine.map(m => `
          <div class="summary-row">
            <span class="summary-label">${esc(m.name)}</span>
            <span class="summary-value">${m.count} restocks</span>
          </div>
        `).join('')}
      </div>
      <div class="section-title">Service History</div>
      <table>
        <thead><tr><th>Date</th><th>Machine</th><th>Status</th><th>Notes</th></tr></thead>
        <tbody>
          ${data.records.slice(0, 50).map(r => `
            <tr>
              <td>${formatDate(r.created_at)}</td>
              <td>Machine #${r.machine_id}</td>
              <td>${r.status || '‚Äî'}</td>
              <td>${esc(r.notes || '‚Äî')}</td>
            </tr>
          `).join('')}
        </tbody>
      </table>
    `;
  }

  // Export functions
  function enableExports() {
    exportCsv.disabled = false;
    exportExcel.disabled = false;
    exportPdf.disabled = false;
  }

  function exportReport(format) {
    if (!reportData) return;

    if (format === 'pdf') {
      window.print();
      return;
    }

    // Get data rows based on report type
    let rows = [];
    let headers = [];

    switch (reportData.type) {
      case 'pipeline':
      case 'prospects':
        headers = reportData.columns || ['name', 'address', 'phone', 'email', 'status', 'property_type'];
        rows = reportData.prospects.map(p => headers.map(h => p[h] || ''));
        break;
      case 'activity':
        headers = ['date', 'type', 'prospect', 'description'];
        rows = reportData.activities.map(a => [formatDate(a.created_at), a.type, a.prospect_name, a.description || '']);
        break;
      case 'revenue':
        headers = ['month', 'amount'];
        rows = Object.entries(reportData.byMonth).sort().map(([m, a]) => [m, a]);
        break;
      case 'commission':
        headers = ['location', 'revenue', 'months', 'rate', 'eligible', 'commission'];
        rows = reportData.commissions.map(c => [c.location_name, c.revenue, c.months_active, c.rev_share_rate + '%', c.eligible ? 'Yes' : 'No', c.commission]);
        break;
      case 'machine':
        headers = ['machine', 'status', 'location', 'revenue', 'units', 'restocks'];
        rows = reportData.machines.map(m => [m.name, m.status, m.location, m.revenue, m.units, m.restocks]);
        break;
      case 'expense':
        headers = ['month', 'category', 'description', 'amount'];
        rows = reportData.records.map(r => [r.month, r.category || '', r.description || '', r.amount]);
        break;
      case 'service':
        headers = ['date', 'machine_id', 'status', 'notes'];
        rows = reportData.records.map(r => [formatDate(r.created_at), r.machine_id, r.status || '', r.notes || '']);
        break;
    }

    if (format === 'csv') {
      downloadCSV(headers, rows, reportData.title);
    } else if (format === 'excel') {
      downloadExcel(headers, rows, reportData.title);
    }
  }

  function downloadCSV(headers, rows, title) {
    const escape = v => '"' + String(v).replace(/"/g, '""') + '"';
    const csv = [headers.join(','), ...rows.map(r => r.map(escape).join(','))].join('\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    downloadBlob(blob, title.replace(/\s+/g, '_') + '.csv');
  }

  function downloadExcel(headers, rows, title) {
    // Create simple HTML table that Excel can open
    let html = '<html><head><meta charset="utf-8"></head><body><table border="1">';
    html += '<tr>' + headers.map(h => '<th>' + esc(h) + '</th>').join('') + '</tr>';
    rows.forEach(r => {
      html += '<tr>' + r.map(c => '<td>' + esc(c) + '</td>').join('') + '</tr>';
    });
    html += '</table></body></html>';
    const blob = new Blob([html], { type: 'application/vnd.ms-excel' });
    downloadBlob(blob, title.replace(/\s+/g, '_') + '.xls');
  }

  function downloadBlob(blob, filename) {
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    showToast('Download started: ' + filename, 'success');
  }

  // History management
  function addToHistory(type, from, to) {
    const typeNames = {
      pipeline: 'Sales Pipeline', activity: 'Activity Report', revenue: 'Revenue Report',
      commission: 'Commission Report', prospects: 'Prospect List', machine: 'Machine Performance',
      expense: 'Expense Report', service: 'Service History'
    };
    const entry = {
      type,
      name: typeNames[type],
      dateRange: { from, to },
      generatedAt: new Date().toISOString()
    };
    reportHistory.unshift(entry);
    if (reportHistory.length > 20) reportHistory = reportHistory.slice(0, 20);
    localStorage.setItem('reportHistory', JSON.stringify(reportHistory));
    renderHistory();
  }

  function renderHistory() {
    if (reportHistory.length === 0) {
      historyList.innerHTML = '<div class="history-empty">No reports generated yet</div>';
      return;
    }
    historyList.innerHTML = reportHistory.map((h, i) => `
      <div class="history-item" data-index="${i}">
        <span class="hi-icon">üìÑ</span>
        <div class="hi-info">
          <div class="hi-name">${h.name}</div>
          <div class="hi-meta">${formatDate(h.generatedAt)} ‚Ä¢ ${h.dateRange?.from || 'All'} to ${h.dateRange?.to || 'All'}</div>
        </div>
        <span class="hi-action">Re-run ‚Üí</span>
      </div>
    `).join('');

    historyList.querySelectorAll('.history-item').forEach(item => {
      item.addEventListener('click', () => {
        const idx = parseInt(item.dataset.index);
        const h = reportHistory[idx];
        selectReportType(h.type);
        if (h.dateRange?.from) document.getElementById('date-from').value = h.dateRange.from;
        if (h.dateRange?.to) document.getElementById('date-to').value = h.dateRange.to;
        generateReport();
      });
    });
  }

  // Schedule placeholder
  function saveSchedule() {
    showToast('Schedule saved (email delivery coming soon)', 'success');
    scheduleModal.classList.remove('active');
  }

  // Helpers
  function formatDate(d) {
    if (!d) return '‚Äî';
    const date = new Date(d);
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
  }

  function money(n) {
    return '$' + Number(n || 0).toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
  }

  function esc(s) {
    if (!s) return '';
    return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
  }

  function showToast(msg, type) {
    toast.textContent = msg;
    toast.className = 'toast ' + (type || '') + ' show';
    setTimeout(() => toast.classList.remove('show'), 3000);
  }

})();
</script>
</body>
</html>
