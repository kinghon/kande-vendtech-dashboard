<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-vend-32.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-vend.png">
  <title>Client Portal ‚Äî Kande VendTech</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg: #f8fafc; --card: #ffffff; --border: #e2e8f0; --text: #1e293b;
      --muted: #64748b; --accent: #2563eb; --accent-light: #3b82f6; --hot: #dc2626;
      --warn: #f59e0b; --success: #10b981; --purple: #7c3aed;
      --gradient-start: #2563eb; --gradient-end: #7c3aed;
    }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }
    .app { max-width: 1100px; margin: 0 auto; padding: 24px 20px; }

    /* Login Screen */
    .login-screen { display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 20px; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); }
    .login-box { background: var(--card); border-radius: 20px; padding: 52px 44px; max-width: 440px; width: 100%; box-shadow: 0 20px 60px rgba(0,0,0,0.08); text-align: center; border: 1px solid var(--border); }
    .login-box img { height: 52px; margin-bottom: 24px; }
    .login-badge { display: inline-block; background: linear-gradient(135deg, var(--accent), var(--purple)); color: white; padding: 6px 18px; border-radius: 20px; font-size: 0.72rem; font-weight: 700; margin-bottom: 24px; letter-spacing: 1px; text-transform: uppercase; }
    .login-box h1 { font-size: 1.6rem; font-weight: 700; margin-bottom: 8px; color: var(--text); }
    .login-box p { color: var(--muted); font-size: 0.92rem; margin-bottom: 32px; line-height: 1.5; }
    .login-box input { width: 100%; padding: 16px 20px; border: 2px solid var(--border); border-radius: 12px; font-size: 1.15rem; text-align: center; letter-spacing: 4px; font-weight: 700; outline: none; transition: all 0.2s; text-transform: uppercase; }
    .login-box input:focus { border-color: var(--accent); box-shadow: 0 0 0 4px rgba(37,99,235,0.1); }
    .login-box .btn-login { width: 100%; padding: 16px; background: linear-gradient(135deg, var(--accent), var(--accent-light)); color: white; border: none; border-radius: 12px; font-size: 1rem; font-weight: 600; cursor: pointer; margin-top: 20px; transition: all 0.2s; box-shadow: 0 4px 14px rgba(37,99,235,0.3); }
    .login-box .btn-login:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(37,99,235,0.4); }
    .login-error { color: var(--hot); font-size: 0.85rem; margin-top: 16px; display: none; padding: 10px; background: rgba(220,38,38,0.08); border-radius: 8px; }
    .login-help { color: var(--muted); font-size: 0.8rem; margin-top: 24px; }
    .login-help a { color: var(--accent); text-decoration: none; }

    /* Demo Banner */
    .demo-banner { background: linear-gradient(135deg, #fef3c7, #fde68a); border: 1px solid #fbbf24; border-radius: 12px; padding: 14px 20px; margin-bottom: 24px; display: flex; align-items: center; gap: 12px; }
    .demo-banner .icon { font-size: 1.3rem; }
    .demo-banner .text { flex: 1; font-size: 0.85rem; color: #92400e; }
    .demo-banner .text strong { font-weight: 600; }

    /* Portal Header */
    .portal-header { margin-bottom: 32px; }
    .portal-header-top { display: flex; align-items: center; gap: 16px; margin-bottom: 20px; flex-wrap: wrap; }
    .portal-header-top img { height: 40px; }
    .portal-header-top .brand { font-size: 0.85rem; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; }
    .portal-header-top .spacer { flex: 1; }
    .btn-logout { padding: 8px 16px; border-radius: 8px; border: 1px solid var(--border); background: var(--card); color: var(--muted); font-size: 0.82rem; cursor: pointer; transition: all 0.2s; }
    .btn-logout:hover { border-color: var(--hot); color: var(--hot); }
    
    .welcome-section { background: linear-gradient(135deg, var(--accent), var(--purple)); border-radius: 20px; padding: 32px; color: white; position: relative; overflow: hidden; }
    .welcome-section::before { content: ''; position: absolute; right: -50px; top: -50px; width: 200px; height: 200px; background: rgba(255,255,255,0.1); border-radius: 50%; }
    .welcome-section::after { content: ''; position: absolute; right: 60px; bottom: -60px; width: 150px; height: 150px; background: rgba(255,255,255,0.05); border-radius: 50%; }
    .welcome-section h1 { font-size: 1.5rem; font-weight: 700; margin-bottom: 6px; position: relative; z-index: 1; }
    .welcome-section p { opacity: 0.9; font-size: 0.92rem; position: relative; z-index: 1; }
    .welcome-badge { display: inline-block; background: rgba(255,255,255,0.2); padding: 4px 12px; border-radius: 20px; font-size: 0.72rem; font-weight: 600; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px; }

    /* Property Info */
    .property-info { background: var(--card); border-radius: 16px; padding: 24px; border: 1px solid var(--border); margin-bottom: 24px; }
    .property-info h3 { font-size: 1rem; font-weight: 600; margin-bottom: 16px; color: var(--text); display: flex; align-items: center; gap: 8px; }
    .property-details { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; }
    .property-detail { display: flex; align-items: flex-start; gap: 12px; }
    .property-detail .icon { width: 36px; height: 36px; background: rgba(37,99,235,0.08); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1rem; flex-shrink: 0; }
    .property-detail .info { }
    .property-detail .label { font-size: 0.72rem; color: var(--muted); text-transform: uppercase; font-weight: 600; letter-spacing: 0.3px; margin-bottom: 2px; }
    .property-detail .value { font-size: 0.92rem; font-weight: 500; color: var(--text); }

    /* Stats Grid */
    .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 28px; }
    @media (max-width: 800px) { .stats-grid { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 500px) { .stats-grid { grid-template-columns: 1fr; } }
    .stat-card { background: var(--card); border-radius: 16px; padding: 24px; border: 1px solid var(--border); text-align: center; transition: all 0.2s; }
    .stat-card:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.06); }
    .stat-card .icon { font-size: 1.6rem; margin-bottom: 10px; }
    .stat-card .value { font-size: 1.8rem; font-weight: 700; line-height: 1.1; }
    .stat-card .label { font-size: 0.72rem; color: var(--muted); margin-top: 6px; text-transform: uppercase; font-weight: 600; letter-spacing: 0.3px; }
    .value.accent { color: var(--accent); }
    .value.success { color: var(--success); }
    .value.warn { color: var(--warn); }
    .value.hot { color: var(--hot); }

    /* Cards */
    .card { background: var(--card); border-radius: 16px; padding: 24px; border: 1px solid var(--border); margin-bottom: 20px; }
    .card h3 { font-size: 1rem; font-weight: 600; margin-bottom: 18px; display: flex; align-items: center; gap: 10px; }
    .card h3 .badge { font-size: 0.7rem; background: rgba(37,99,235,0.1); color: var(--accent); padding: 3px 10px; border-radius: 10px; font-weight: 600; }

    /* Grid layouts */
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    @media (max-width: 768px) { .grid-2 { grid-template-columns: 1fr; } }

    /* Machine Cards (Mobile-friendly) */
    .machine-card { background: #f8fafc; border-radius: 12px; padding: 16px; margin-bottom: 12px; border: 1px solid var(--border); }
    .machine-card:last-child { margin-bottom: 0; }
    .machine-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .machine-card-header h4 { font-size: 0.95rem; font-weight: 600; }
    .machine-card-details { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 0.82rem; }
    .machine-card-details .detail { }
    .machine-card-details .detail-label { color: var(--muted); font-size: 0.72rem; text-transform: uppercase; }
    .machine-card-details .detail-value { font-weight: 500; }

    /* Badges */
    .badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 0.72rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; }
    .badge-active { background: rgba(16,185,129,0.12); color: var(--success); }
    .badge-needs-service { background: rgba(245,158,11,0.12); color: var(--warn); }
    .badge-offline { background: rgba(100,116,139,0.12); color: var(--muted); }
    .badge-pending { background: rgba(245,158,11,0.12); color: var(--warn); }
    .badge-completed { background: rgba(16,185,129,0.12); color: var(--success); }

    /* Chart Container */
    .chart-container { position: relative; height: 220px; }
    .bar-chart { display: flex; align-items: flex-end; gap: 12px; height: 180px; padding: 0 10px; }
    .bar-group { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 6px; }
    .bar { width: 100%; max-width: 60px; background: linear-gradient(180deg, var(--accent), #60a5fa); border-radius: 8px 8px 0 0; transition: height 0.5s ease; min-height: 6px; position: relative; }
    .bar:hover { opacity: 0.85; }
    .bar-label { font-size: 0.72rem; color: var(--muted); text-align: center; font-weight: 500; }
    .bar-value { font-size: 0.75rem; font-weight: 700; color: var(--text); }
    .commission-bar { background: linear-gradient(180deg, var(--success), #34d399) !important; }

    /* Service Timeline */
    .service-timeline { }
    .service-item { display: flex; gap: 16px; padding: 14px 0; border-bottom: 1px solid #f1f5f9; }
    .service-item:last-child { border-bottom: none; }
    .service-icon { width: 40px; height: 40px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1rem; flex-shrink: 0; }
    .service-icon.restock { background: rgba(16,185,129,0.1); }
    .service-icon.maintenance { background: rgba(245,158,11,0.1); }
    .service-icon.scheduled { background: rgba(37,99,235,0.1); }
    .service-content { flex: 1; }
    .service-content h4 { font-size: 0.9rem; font-weight: 600; margin-bottom: 2px; }
    .service-content p { font-size: 0.82rem; color: var(--muted); }
    .service-date { font-size: 0.78rem; color: var(--muted); text-align: right; white-space: nowrap; }

    /* Contact Card */
    .contact-card { display: flex; align-items: center; gap: 16px; padding: 18px 0; border-bottom: 1px solid #f1f5f9; }
    .contact-card:last-child { border-bottom: none; }
    .contact-icon { width: 48px; height: 48px; background: rgba(37,99,235,0.08); border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 1.3rem; flex-shrink: 0; }
    .contact-info h4 { font-size: 0.92rem; font-weight: 600; margin-bottom: 2px; }
    .contact-info p { font-size: 0.85rem; color: var(--muted); }
    .contact-info a { color: var(--accent); text-decoration: none; font-weight: 500; }
    .contact-info a:hover { text-decoration: underline; }

    /* Empty state */
    .empty-state { text-align: center; padding: 40px 20px; color: var(--muted); }
    .empty-state .icon { font-size: 2.5rem; margin-bottom: 12px; opacity: 0.5; }
    .empty-state p { font-size: 0.9rem; }

    /* Footer */
    .portal-footer { text-align: center; padding: 32px 0 16px; color: var(--muted); font-size: 0.78rem; }
    .portal-footer a { color: var(--accent); text-decoration: none; font-weight: 600; }

    /* Loading */
    .loading { text-align: center; padding: 60px 20px; color: var(--muted); }
    .loading .spinner { width: 40px; height: 40px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 16px; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Next Restock Highlight */
    .next-restock { background: linear-gradient(135deg, rgba(37,99,235,0.05), rgba(124,58,237,0.05)); border: 1px solid rgba(37,99,235,0.15); border-radius: 12px; padding: 16px; margin-bottom: 16px; display: flex; align-items: center; gap: 14px; }
    .next-restock .icon { font-size: 1.5rem; }
    .next-restock .info { flex: 1; }
    .next-restock .label { font-size: 0.72rem; color: var(--muted); text-transform: uppercase; font-weight: 600; }
    .next-restock .date { font-size: 1.1rem; font-weight: 700; color: var(--accent); }
  </style>
</head>
<body>

<!-- ===== LOGIN SCREEN ===== -->
<div id="loginScreen" class="login-screen" style="display:none;">
  <div class="login-box">
    <img src="/logo.png" alt="Kande VendTech">
    <div class="login-badge">Client Portal</div>
    <h1>Welcome</h1>
    <p>Enter your access code to view your vending machine performance dashboard</p>
    <input type="text" id="accessCode" placeholder="ACCESS CODE" maxlength="12" autocomplete="off" onkeydown="if(event.key==='Enter')doLogin()">
    <button class="btn-login" onclick="doLogin()">Access Dashboard</button>
    <div class="login-error" id="loginError"></div>
    <p class="login-help">Don't have a code? <a href="mailto:kurtis@kandevendtech.com">Contact us</a></p>
  </div>
</div>

<!-- ===== LOADING ===== -->
<div id="loadingScreen" class="loading" style="display:none;">
  <div class="spinner"></div>
  <p>Loading your dashboard...</p>
</div>

<!-- ===== PORTAL DASHBOARD ===== -->
<div id="portalDashboard" class="app" style="display:none;">
  
  <!-- Demo Banner (shown only in demo mode) -->
  <div id="demoBanner" class="demo-banner" style="display:none;">
    <div class="icon">üìä</div>
    <div class="text"><strong>Sample Data</strong> ‚Äî This is demo data for illustration purposes. Your actual numbers will appear once your machine is live.</div>
  </div>

  <!-- Header -->
  <div class="portal-header">
    <div class="portal-header-top">
      <img src="/logo.png" alt="Kande VendTech">
      <span class="brand">Client Portal</span>
      <div class="spacer"></div>
      <button class="btn-logout" onclick="doLogout()">Sign Out</button>
    </div>
    
    <div class="welcome-section">
      <div class="welcome-badge">Your Smart Vending Partnership</div>
      <h1 id="welcomeName">Welcome</h1>
      <p id="welcomeSubtitle">Your vending machine performance at a glance</p>
    </div>
  </div>

  <!-- Property Info -->
  <div class="property-info" id="propertyInfo">
    <h3>üè¢ Property Details</h3>
    <div class="property-details">
      <div class="property-detail">
        <div class="icon">üìç</div>
        <div class="info">
          <div class="label">Address</div>
          <div class="value" id="propAddress">‚Äî</div>
        </div>
      </div>
      <div class="property-detail">
        <div class="icon">üìÖ</div>
        <div class="info">
          <div class="label">Installed</div>
          <div class="value" id="propInstalled">‚Äî</div>
        </div>
      </div>
      <div class="property-detail">
        <div class="icon">üõí</div>
        <div class="info">
          <div class="label">Products</div>
          <div class="value" id="propProducts">‚Äî</div>
        </div>
      </div>
      <div class="property-detail">
        <div class="icon">üí∞</div>
        <div class="info">
          <div class="label">Rev Share Rate</div>
          <div class="value" id="propRevShare">‚Äî</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Stats -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="icon">üíµ</div>
      <div class="value accent" id="statRevenue">$0</div>
      <div class="label">This Month Revenue</div>
    </div>
    <div class="stat-card">
      <div class="icon">ü§ù</div>
      <div class="value success" id="statCommission">$0</div>
      <div class="label">Your Earnings</div>
    </div>
    <div class="stat-card">
      <div class="icon">üõí</div>
      <div class="value" id="statTransactions">0</div>
      <div class="label">Transactions</div>
    </div>
    <div class="stat-card">
      <div class="icon">ü§ñ</div>
      <div class="value" id="statMachines">0</div>
      <div class="label">Active Machines</div>
    </div>
  </div>

  <!-- Charts Row -->
  <div class="grid-2">
    <div class="card">
      <h3>üìà Revenue Trend <span class="badge">Last 6 Months</span></h3>
      <div class="chart-container">
        <div class="bar-chart" id="revenueBars">
          <div class="empty-state"><div class="icon">üìä</div><p>Loading chart...</p></div>
        </div>
      </div>
    </div>
    <div class="card">
      <h3>üí∞ Your Earnings <span class="badge">Commission History</span></h3>
      <div class="chart-container">
        <div class="bar-chart" id="commissionBars">
          <div class="empty-state"><div class="icon">üìä</div><p>Loading chart...</p></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Service & Machines -->
  <div class="grid-2">
    <!-- Service History -->
    <div class="card">
      <h3>üîß Service History</h3>
      
      <div class="next-restock" id="nextRestockBox">
        <div class="icon">üì¶</div>
        <div class="info">
          <div class="label">Next Scheduled Restock</div>
          <div class="date" id="nextRestockDate">‚Äî</div>
        </div>
      </div>
      
      <div class="service-timeline" id="serviceTimeline">
        <div class="empty-state"><div class="icon">üîß</div><p>Service history will appear here</p></div>
      </div>
    </div>
    
    <!-- Machine Status -->
    <div class="card">
      <h3>ü§ñ Machine Status</h3>
      <div id="machineList">
        <div class="empty-state"><div class="icon">ü§ñ</div><p>Machine info loading...</p></div>
      </div>
    </div>
  </div>

  <!-- Contact -->
  <div class="card">
    <h3>üìû Your Vending Partner</h3>
    <div class="contact-card">
      <div class="contact-icon">üë§</div>
      <div class="contact-info">
        <h4>Kurtis Hon</h4>
        <p>Owner, Kande VendTech</p>
        <a href="tel:+17022551234">(702) 255-1234</a>
      </div>
    </div>
    <div class="contact-card">
      <div class="contact-icon">üìß</div>
      <div class="contact-info">
        <h4>Email Support</h4>
        <p>For general inquiries and service requests</p>
        <a href="mailto:kurtis@kandevendtech.com">kurtis@kandevendtech.com</a>
      </div>
    </div>
    <div class="contact-card">
      <div class="contact-icon">‚è∞</div>
      <div class="contact-info">
        <h4>Response Time</h4>
        <p>Machine issues: Within 4 hours during business hours<br>General inquiries: Within 24 hours</p>
      </div>
    </div>
  </div>

  <div class="portal-footer">
    Powered by <a href="https://kandevendtech.com" target="_blank">Kande VendTech</a> ‚Äî Smart Vending Solutions for Las Vegas Properties
  </div>
</div>

<script>
// ===== STATE =====
let clientToken = localStorage.getItem('cp_token');
let clientName = localStorage.getItem('cp_name') || 'Client';
let dashboardData = null;
let isDemo = false;

// ===== DEMO DATA =====
const DEMO_DATA = {
  clientName: 'Sunset Gardens Apartments',
  propertyAddress: '2847 Sunset Blvd, Henderson, NV 89052',
  installedDate: '2025-01-15',
  productCount: 42,
  commissionRate: 5,
  monthRevenue: 2847.50,
  commissionAmount: 142.38,
  transactions: 847,
  machineCount: 1,
  machines: [
    { id: 1, serial: 'KVT-001', model: 'SandStar AI Smart Cooler', location: 'Lobby ‚Äî Near Mailboxes', status: 'active', last_restock: '2025-01-28', installed_date: '2025-01-15' }
  ],
  monthlyHistory: [
    { month: '2024-08', revenue: 1245.00, commission: 62.25 },
    { month: '2024-09', revenue: 1678.50, commission: 83.93 },
    { month: '2024-10', revenue: 2134.00, commission: 106.70 },
    { month: '2024-11', revenue: 2456.75, commission: 122.84 },
    { month: '2024-12', revenue: 2689.25, commission: 134.46 },
    { month: '2025-01', revenue: 2847.50, commission: 142.38 }
  ],
  serviceHistory: [
    { type: 'scheduled', date: '2025-02-05', description: 'Scheduled restock', machine: 'KVT-001' },
    { type: 'restock', date: '2025-01-28', description: 'Full restock ‚Äî 38 items replaced', machine: 'KVT-001' },
    { type: 'restock', date: '2025-01-21', description: 'Restock ‚Äî 24 items, added new energy drinks', machine: 'KVT-001' },
    { type: 'maintenance', date: '2025-01-18', description: 'Card reader calibration', machine: 'KVT-001' },
    { type: 'restock', date: '2025-01-15', description: 'Initial stocking ‚Äî machine installed', machine: 'KVT-001' }
  ],
  nextRestock: '2025-02-05'
};

// ===== INIT =====
document.addEventListener('DOMContentLoaded', () => {
  // Check for URL token first (?token=xxx)
  const urlParams = new URLSearchParams(window.location.search);
  const urlToken = urlParams.get('token');
  const demoMode = urlParams.get('demo');
  
  if (demoMode === '1' || demoMode === 'true') {
    // Demo mode
    isDemo = true;
    showPortal();
    loadDemoData();
  } else if (urlToken) {
    // Auto-login with URL token
    showLoading();
    loginWithToken(urlToken);
  } else if (clientToken) {
    // Existing session
    showPortal();
    loadDashboard();
  } else {
    // Show login screen
    document.getElementById('loginScreen').style.display = 'flex';
  }
});

// ===== LOADING =====
function showLoading() {
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('loadingScreen').style.display = 'block';
  document.getElementById('portalDashboard').style.display = 'none';
}

// ===== URL TOKEN LOGIN =====
async function loginWithToken(token) {
  try {
    const res = await fetch('/api/client-portal/token-login?token=' + encodeURIComponent(token));
    const data = await res.json();
    
    if (data.success) {
      clientToken = data.sessionToken;
      clientName = data.clientName;
      localStorage.setItem('cp_token', clientToken);
      localStorage.setItem('cp_name', clientName);
      
      // Clean URL
      window.history.replaceState({}, '', '/client-portal');
      
      showPortal();
      loadDashboard();
    } else {
      // Invalid token ‚Äî show login
      document.getElementById('loadingScreen').style.display = 'none';
      document.getElementById('loginScreen').style.display = 'flex';
      document.getElementById('loginError').textContent = 'This link has expired or is invalid. Please enter your access code.';
      document.getElementById('loginError').style.display = 'block';
    }
  } catch (e) {
    console.error('Token login error:', e);
    document.getElementById('loadingScreen').style.display = 'none';
    document.getElementById('loginScreen').style.display = 'flex';
  }
}

// ===== CODE LOGIN =====
async function doLogin() {
  const code = document.getElementById('accessCode').value.trim();
  if (!code) return;
  const errEl = document.getElementById('loginError');
  errEl.style.display = 'none';
  
  try {
    const res = await fetch('/api/client-portal/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ code })
    });
    const data = await res.json();
    
    if (data.success) {
      clientToken = data.token;
      clientName = data.clientName;
      localStorage.setItem('cp_token', clientToken);
      localStorage.setItem('cp_name', clientName);
      showPortal();
      loadDashboard();
    } else {
      errEl.textContent = data.error || 'Invalid access code';
      errEl.style.display = 'block';
    }
  } catch (e) {
    errEl.textContent = 'Connection error. Please try again.';
    errEl.style.display = 'block';
  }
}

function doLogout() {
  localStorage.removeItem('cp_token');
  localStorage.removeItem('cp_name');
  clientToken = null;
  isDemo = false;
  document.getElementById('portalDashboard').style.display = 'none';
  document.getElementById('loginScreen').style.display = 'flex';
  document.getElementById('demoBanner').style.display = 'none';
}

// ===== API HELPER =====
async function apiFetch(url, opts = {}) {
  const headers = { 'Authorization': `Bearer ${clientToken}`, ...opts.headers };
  const res = await fetch(url, { ...opts, headers });
  if (res.status === 401) { doLogout(); return null; }
  return res.json();
}

// ===== SHOW PORTAL =====
function showPortal() {
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('loadingScreen').style.display = 'none';
  document.getElementById('portalDashboard').style.display = 'block';
}

// ===== LOAD DEMO DATA =====
function loadDemoData() {
  document.getElementById('demoBanner').style.display = 'flex';
  renderDashboard(DEMO_DATA);
}

// ===== LOAD REAL DASHBOARD =====
async function loadDashboard() {
  const data = await apiFetch('/api/client-portal/dashboard');
  if (!data) return;
  dashboardData = data;
  renderDashboard(data);
}

// ===== RENDER DASHBOARD =====
function renderDashboard(data) {
  // Welcome
  document.getElementById('welcomeName').textContent = 'Welcome, ' + (data.clientName || clientName);
  document.getElementById('welcomeSubtitle').textContent = data.propertyAddress || 'Your vending machine performance at a glance';
  
  // Property Info
  document.getElementById('propAddress').textContent = data.propertyAddress || data.machines?.[0]?.location || '‚Äî';
  document.getElementById('propInstalled').textContent = data.installedDate ? formatDate(data.installedDate) : (data.machines?.[0]?.installed_date ? formatDate(data.machines[0].installed_date) : '‚Äî');
  document.getElementById('propProducts').textContent = data.productCount ? data.productCount + ' items' : '40+ items';
  document.getElementById('propRevShare').textContent = (data.commissionRate || 5) + '%';
  
  // Stats
  document.getElementById('statRevenue').textContent = formatCurrency(data.monthRevenue || 0);
  document.getElementById('statCommission').textContent = formatCurrency(data.commissionAmount || 0);
  document.getElementById('statTransactions').textContent = (data.transactions || 0).toLocaleString();
  document.getElementById('statMachines').textContent = data.machineCount || data.machines?.length || 0;
  
  // Charts
  renderRevenueBars(data.monthlyHistory || []);
  renderCommissionBars(data.monthlyHistory || []);
  
  // Machines
  renderMachines(data.machines || []);
  
  // Service History
  renderServiceHistory(data.serviceHistory || data.recentRestocks || [], data.nextRestock || data.restockSchedule?.[0]?.scheduled_date);
}

function formatCurrency(val) {
  return '$' + (val || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function formatDate(dateStr) {
  if (!dateStr) return '‚Äî';
  const d = new Date(dateStr);
  return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}

// ===== RENDER REVENUE BARS =====
function renderRevenueBars(history) {
  const container = document.getElementById('revenueBars');
  if (!history.length) { 
    container.innerHTML = '<div class="empty-state"><div class="icon">üìà</div><p>Revenue data will appear here</p></div>'; 
    return; 
  }
  const maxRev = Math.max(...history.map(h => h.revenue), 1);
  container.innerHTML = history.map(h => {
    const pct = (h.revenue / maxRev) * 100;
    const monthName = new Date(h.month + '-01').toLocaleDateString('en-US', { month: 'short' });
    return `<div class="bar-group">
      <div class="bar-value">${formatCurrency(h.revenue)}</div>
      <div class="bar" style="height:${Math.max(pct, 5)}%"></div>
      <div class="bar-label">${monthName}</div>
    </div>`;
  }).join('');
}

// ===== RENDER COMMISSION BARS =====
function renderCommissionBars(history) {
  const container = document.getElementById('commissionBars');
  if (!history.length) { 
    container.innerHTML = '<div class="empty-state"><div class="icon">üí∞</div><p>Commission data will appear here</p></div>'; 
    return; 
  }
  const maxComm = Math.max(...history.map(h => h.commission || 0), 1);
  container.innerHTML = history.map(h => {
    const pct = ((h.commission || 0) / maxComm) * 100;
    const monthName = new Date(h.month + '-01').toLocaleDateString('en-US', { month: 'short' });
    return `<div class="bar-group">
      <div class="bar-value">${formatCurrency(h.commission || 0)}</div>
      <div class="bar commission-bar" style="height:${Math.max(pct, 5)}%"></div>
      <div class="bar-label">${monthName}</div>
    </div>`;
  }).join('');
}

// ===== RENDER MACHINES =====
function renderMachines(machines) {
  const container = document.getElementById('machineList');
  if (!machines.length) {
    container.innerHTML = '<div class="empty-state"><div class="icon">ü§ñ</div><p>Machine information will appear here</p></div>';
    return;
  }
  container.innerHTML = machines.map(m => {
    const statusClass = m.status === 'active' ? 'badge-active' : m.status === 'needs-service' ? 'badge-needs-service' : 'badge-offline';
    const statusLabel = m.status === 'active' ? 'Online' : m.status === 'needs-service' ? 'Needs Service' : 'Offline';
    return `<div class="machine-card">
      <div class="machine-card-header">
        <h4>${m.serial || 'Machine'}</h4>
        <span class="badge ${statusClass}">${statusLabel}</span>
      </div>
      <div class="machine-card-details">
        <div class="detail">
          <div class="detail-label">Model</div>
          <div class="detail-value">${m.model || 'SandStar AI'}</div>
        </div>
        <div class="detail">
          <div class="detail-label">Location</div>
          <div class="detail-value">${m.location || '‚Äî'}</div>
        </div>
        <div class="detail">
          <div class="detail-label">Installed</div>
          <div class="detail-value">${m.installed_date ? formatDate(m.installed_date) : '‚Äî'}</div>
        </div>
        <div class="detail">
          <div class="detail-label">Last Restock</div>
          <div class="detail-value">${m.last_restock ? formatDate(m.last_restock) : '‚Äî'}</div>
        </div>
      </div>
    </div>`;
  }).join('');
}

// ===== RENDER SERVICE HISTORY =====
function renderServiceHistory(history, nextRestock) {
  // Next restock
  const nextBox = document.getElementById('nextRestockBox');
  const nextDate = document.getElementById('nextRestockDate');
  if (nextRestock) {
    nextDate.textContent = formatDate(nextRestock);
    nextBox.style.display = 'flex';
  } else {
    nextBox.style.display = 'none';
  }
  
  // History timeline
  const container = document.getElementById('serviceTimeline');
  if (!history.length) {
    container.innerHTML = '<div class="empty-state"><div class="icon">üîß</div><p>Service history will appear here</p></div>';
    return;
  }
  
  container.innerHTML = history.slice(0, 8).map(item => {
    const iconClass = item.type === 'scheduled' ? 'scheduled' : item.type === 'maintenance' ? 'maintenance' : 'restock';
    const icon = item.type === 'scheduled' ? 'üìÖ' : item.type === 'maintenance' ? 'üîß' : 'üì¶';
    return `<div class="service-item">
      <div class="service-icon ${iconClass}">${icon}</div>
      <div class="service-content">
        <h4>${item.description || item.type}</h4>
        <p>${item.machine || '‚Äî'}${item.notes ? ' ‚Äî ' + item.notes : ''}</p>
      </div>
      <div class="service-date">${formatDate(item.date || item.service_date)}</div>
    </div>`;
  }).join('');
}
</script>
</body>
</html>
