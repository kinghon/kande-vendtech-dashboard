<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-vend-32.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-vend.png">
  <title>Notifications ‚Äî Kande VendTech</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg: #f8fafc; --card: #ffffff; --border: #e2e8f0; --text: #0f172a;
      --muted: #64748b; --accent: #3b82f6; --accent-light: #eff6ff;
      --green: #22c55e; --green-light: #dcfce7;
      --amber: #f59e0b; --amber-light: #fef3c7;
      --red: #ef4444; --red-light: #fee2e2;
      --purple: #8b5cf6; --purple-light: #f3e8ff;
      --blue: #3b82f6; --blue-light: #dbeafe;
      --orange: #f97316; --orange-light: #ffedd5;
      --radius: 12px;
    }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); }
    .container { max-width: 1200px; margin: 0 auto; padding: 24px 28px 60px; }

    /* Page Header */
    .page-header {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 24px; flex-wrap: wrap; gap: 16px;
    }
    .page-header h1 { font-size: 1.6rem; font-weight: 700; display: flex; align-items: center; gap: 10px; }
    .header-actions { display: flex; gap: 10px; align-items: center; }
    .btn {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 10px 18px; border-radius: 8px; font-size: 0.85rem; font-weight: 600;
      border: none; cursor: pointer; text-decoration: none; transition: all 0.15s;
    }
    .btn-primary { background: var(--accent); color: #fff; }
    .btn-primary:hover { background: #2563eb; }
    .btn-secondary { background: var(--card); color: var(--text); border: 1px solid var(--border); }
    .btn-secondary:hover { background: #f1f5f9; }
    .btn-icon { font-size: 1rem; }

    /* Summary Stats */
    .stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px; }
    .stat-card {
      background: var(--card); border: 1px solid var(--border); border-radius: var(--radius);
      padding: 18px 20px; transition: box-shadow 0.2s;
    }
    .stat-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.06); }
    .stat-card .stat-icon { font-size: 1.3rem; margin-bottom: 8px; }
    .stat-card .stat-value { font-size: 1.6rem; font-weight: 800; line-height: 1; }
    .stat-card .stat-label { font-size: 0.72rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; margin-top: 4px; }
    .stat-card.urgent { border-left: 4px solid var(--red); }
    .stat-card.warning { border-left: 4px solid var(--amber); }
    .stat-card.info { border-left: 4px solid var(--accent); }
    .stat-card.success { border-left: 4px solid var(--green); }

    /* Main Grid */
    .main-grid { display: grid; grid-template-columns: 1fr 320px; gap: 24px; }

    /* Activity Feed */
    .card {
      background: var(--card); border: 1px solid var(--border); border-radius: var(--radius);
      padding: 0; overflow: hidden;
    }
    .card-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 16px 20px; border-bottom: 1px solid var(--border);
    }
    .card-title { font-size: 0.95rem; font-weight: 700; display: flex; align-items: center; gap: 8px; }
    .card-body { padding: 0; }

    /* Filters */
    .filter-bar {
      display: flex; gap: 8px; padding: 12px 20px; background: #f8fafc; border-bottom: 1px solid var(--border);
      flex-wrap: wrap;
    }
    .filter-chip {
      padding: 6px 12px; border-radius: 20px; font-size: 0.78rem; font-weight: 600;
      background: var(--card); border: 1px solid var(--border); cursor: pointer;
      transition: all 0.15s;
    }
    .filter-chip:hover { border-color: var(--accent); color: var(--accent); }
    .filter-chip.active { background: var(--accent); color: #fff; border-color: var(--accent); }

    /* Notification List */
    .notification-list { list-style: none; max-height: 600px; overflow-y: auto; }
    .notification-item {
      display: flex; gap: 14px; padding: 16px 20px;
      border-bottom: 1px solid #f1f5f9; cursor: pointer;
      transition: background 0.15s;
    }
    .notification-item:hover { background: #fafbfc; }
    .notification-item.unread { background: var(--accent-light); }
    .notification-item.unread:hover { background: #e0edff; }
    .notification-item:last-child { border-bottom: none; }
    .notification-icon {
      width: 40px; height: 40px; border-radius: 10px;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.1rem; flex-shrink: 0;
    }
    .notification-icon.activity { background: var(--blue-light); }
    .notification-icon.overdue { background: var(--red-light); }
    .notification-icon.expiring { background: var(--amber-light); }
    .notification-icon.inventory { background: var(--orange-light); }
    .notification-icon.maintenance { background: var(--purple-light); }
    .notification-icon.goal { background: var(--green-light); }
    .notification-icon.new-lead { background: var(--blue-light); }
    .notification-content { flex: 1; min-width: 0; }
    .notification-title { font-size: 0.88rem; font-weight: 600; margin-bottom: 4px; }
    .notification-desc { font-size: 0.8rem; color: var(--muted); line-height: 1.4; }
    .notification-meta { display: flex; align-items: center; gap: 10px; margin-top: 8px; flex-wrap: wrap; }
    .notification-time { font-size: 0.72rem; color: var(--muted); }
    .notification-priority {
      font-size: 0.68rem; font-weight: 700; padding: 2px 8px; border-radius: 4px;
      text-transform: uppercase;
    }
    .notification-priority.high { background: var(--red-light); color: var(--red); }
    .notification-priority.medium { background: var(--amber-light); color: var(--amber); }
    .notification-priority.low { background: #f1f5f9; color: var(--muted); }
    .notification-actions { display: flex; gap: 6px; margin-top: 10px; }
    .action-btn {
      padding: 5px 10px; border-radius: 6px; font-size: 0.72rem; font-weight: 600;
      border: 1px solid var(--border); background: var(--card); cursor: pointer;
      transition: all 0.15s; text-decoration: none; color: var(--text);
    }
    .action-btn:hover { background: #f1f5f9; border-color: #cbd5e1; }
    .action-btn.primary { background: var(--accent); color: #fff; border-color: var(--accent); }
    .action-btn.primary:hover { background: #2563eb; }
    .action-btn.dismiss { color: var(--muted); }
    .action-btn.dismiss:hover { color: var(--red); }

    /* Empty State */
    .empty-state {
      padding: 48px 24px; text-align: center; color: var(--muted);
    }
    .empty-state .empty-icon { font-size: 3rem; margin-bottom: 12px; opacity: 0.4; }
    .empty-state p { font-size: 0.9rem; }

    /* Sidebar */
    .sidebar-section { margin-bottom: 20px; }
    .sidebar-card {
      background: var(--card); border: 1px solid var(--border); border-radius: var(--radius);
      padding: 16px 18px; margin-bottom: 16px;
    }
    .sidebar-title { font-size: 0.82rem; font-weight: 700; margin-bottom: 14px; display: flex; align-items: center; gap: 8px; }
    
    /* Category Stats */
    .category-list { list-style: none; }
    .category-item {
      display: flex; align-items: center; justify-content: space-between;
      padding: 8px 0; border-bottom: 1px solid #f1f5f9; font-size: 0.82rem;
    }
    .category-item:last-child { border-bottom: none; }
    .category-label { display: flex; align-items: center; gap: 8px; }
    .category-dot { width: 10px; height: 10px; border-radius: 3px; }
    .category-count { font-weight: 700; color: var(--text); }

    /* Settings Panel */
    .settings-toggle {
      display: flex; align-items: center; justify-content: space-between;
      padding: 10px 0; border-bottom: 1px solid #f1f5f9; font-size: 0.82rem;
    }
    .settings-toggle:last-child { border-bottom: none; }
    .toggle-switch {
      position: relative; width: 40px; height: 22px;
      background: #e2e8f0; border-radius: 12px; cursor: pointer;
      transition: background 0.2s;
    }
    .toggle-switch::after {
      content: ''; position: absolute; top: 2px; left: 2px;
      width: 18px; height: 18px; background: #fff; border-radius: 50%;
      transition: transform 0.2s; box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    .toggle-switch.on { background: var(--accent); }
    .toggle-switch.on::after { transform: translateX(18px); }

    /* Threshold Settings */
    .threshold-setting {
      display: flex; align-items: center; gap: 10px;
      padding: 10px 0; border-bottom: 1px solid #f1f5f9; font-size: 0.82rem;
    }
    .threshold-setting:last-child { border-bottom: none; }
    .threshold-setting label { flex: 1; }
    .threshold-input {
      width: 60px; padding: 6px 10px; border: 1px solid var(--border);
      border-radius: 6px; font-size: 0.82rem; text-align: center;
    }
    .threshold-unit { color: var(--muted); font-size: 0.78rem; }

    /* Loading */
    .skeleton { background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: 6px; }
    @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

    /* Snooze Modal */
    .modal-overlay {
      display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;
    }
    .modal-overlay.open { display: flex; }
    .modal-content {
      background: var(--card); border-radius: var(--radius); padding: 24px;
      max-width: 400px; width: 90%; box-shadow: 0 20px 40px rgba(0,0,0,0.2);
    }
    .modal-title { font-size: 1.1rem; font-weight: 700; margin-bottom: 16px; }
    .modal-body { margin-bottom: 20px; }
    .snooze-options { display: flex; flex-direction: column; gap: 8px; }
    .snooze-option {
      padding: 12px 16px; border: 1px solid var(--border); border-radius: 8px;
      cursor: pointer; font-size: 0.88rem; transition: all 0.15s;
    }
    .snooze-option:hover { border-color: var(--accent); background: var(--accent-light); }
    .modal-actions { display: flex; justify-content: flex-end; gap: 10px; }

    /* Toast */
    .toast {
      position: fixed; bottom: 24px; right: 24px; padding: 14px 20px;
      background: #1e293b; color: #fff; border-radius: 10px;
      font-size: 0.88rem; font-weight: 500; z-index: 10001;
      transform: translateY(100px); opacity: 0; transition: all 0.3s;
    }
    .toast.show { transform: translateY(0); opacity: 1; }
    .toast.success { background: var(--green); }
    .toast.error { background: var(--red); }

    /* Responsive */
    @media (max-width: 900px) {
      .stats-row { grid-template-columns: repeat(2, 1fr); }
      .main-grid { grid-template-columns: 1fr; }
    }
    @media (max-width: 600px) {
      .container { padding: 16px; }
      .page-header { flex-direction: column; align-items: flex-start; }
      .stats-row { grid-template-columns: 1fr 1fr; }
      .filter-bar { padding: 12px; }
    }
  </style>
</head>
<body>
<script src="/nav.js"></script>

<div class="container">
  <!-- Page Header -->
  <div class="page-header">
    <h1>üîî Notifications Center</h1>
    <div class="header-actions">
      <button class="btn btn-secondary" onclick="markAllRead()">
        <span class="btn-icon">‚úì</span> Mark All Read
      </button>
      <button class="btn btn-secondary" onclick="toggleSettings()">
        <span class="btn-icon">‚öôÔ∏è</span> Settings
      </button>
    </div>
  </div>

  <!-- Summary Stats -->
  <div class="stats-row">
    <div class="stat-card urgent">
      <div class="stat-icon">üö®</div>
      <div class="stat-value" id="stat-unread">‚Äî</div>
      <div class="stat-label">Unread Alerts</div>
    </div>
    <div class="stat-card warning">
      <div class="stat-icon">‚è∞</div>
      <div class="stat-value" id="stat-overdue">‚Äî</div>
      <div class="stat-label">Overdue Follow-ups</div>
    </div>
    <div class="stat-card info">
      <div class="stat-icon">üìã</div>
      <div class="stat-value" id="stat-attention">‚Äî</div>
      <div class="stat-label">Need Attention</div>
    </div>
    <div class="stat-card success">
      <div class="stat-icon">üéØ</div>
      <div class="stat-value" id="stat-today">‚Äî</div>
      <div class="stat-label">Today's Activity</div>
    </div>
  </div>

  <!-- Main Content Grid -->
  <div class="main-grid">
    <!-- Activity Feed -->
    <div class="card">
      <div class="card-header">
        <span class="card-title">üì∞ Activity & Alerts</span>
        <select id="sort-select" onchange="sortNotifications()" style="padding:6px 12px;border:1px solid var(--border);border-radius:6px;font-size:0.82rem;">
          <option value="newest">Newest First</option>
          <option value="oldest">Oldest First</option>
          <option value="priority">Priority</option>
        </select>
      </div>
      <div class="filter-bar">
        <span class="filter-chip active" data-filter="all" onclick="filterNotifications('all', this)">All</span>
        <span class="filter-chip" data-filter="activity" onclick="filterNotifications('activity', this)">üìç Activities</span>
        <span class="filter-chip" data-filter="overdue" onclick="filterNotifications('overdue', this)">‚è∞ Overdue</span>
        <span class="filter-chip" data-filter="expiring" onclick="filterNotifications('expiring', this)">üìÑ Contracts</span>
        <span class="filter-chip" data-filter="inventory" onclick="filterNotifications('inventory', this)">üì¶ Inventory</span>
        <span class="filter-chip" data-filter="maintenance" onclick="filterNotifications('maintenance', this)">üîß Maintenance</span>
        <span class="filter-chip" data-filter="goal" onclick="filterNotifications('goal', this)">üéØ Goals</span>
        <span class="filter-chip" data-filter="new-lead" onclick="filterNotifications('new-lead', this)">‚ú® New Leads</span>
      </div>
      <div class="card-body">
        <ul class="notification-list" id="notification-list">
          <li class="empty-state">
            <div class="empty-icon">üîî</div>
            <p>Loading notifications...</p>
          </li>
        </ul>
      </div>
    </div>

    <!-- Sidebar -->
    <div class="sidebar-section">
      <!-- Alerts by Category -->
      <div class="sidebar-card">
        <div class="sidebar-title">üìä Alerts by Category</div>
        <ul class="category-list" id="category-list">
          <li class="category-item">
            <span class="category-label"><span class="category-dot" style="background:var(--red)"></span> Overdue</span>
            <span class="category-count" id="cat-overdue">‚Äî</span>
          </li>
          <li class="category-item">
            <span class="category-label"><span class="category-dot" style="background:var(--amber)"></span> Expiring Contracts</span>
            <span class="category-count" id="cat-expiring">‚Äî</span>
          </li>
          <li class="category-item">
            <span class="category-label"><span class="category-dot" style="background:var(--orange)"></span> Low Inventory</span>
            <span class="category-count" id="cat-inventory">‚Äî</span>
          </li>
          <li class="category-item">
            <span class="category-label"><span class="category-dot" style="background:var(--purple)"></span> Maintenance</span>
            <span class="category-count" id="cat-maintenance">‚Äî</span>
          </li>
          <li class="category-item">
            <span class="category-label"><span class="category-dot" style="background:var(--green)"></span> Goals</span>
            <span class="category-count" id="cat-goal">‚Äî</span>
          </li>
          <li class="category-item">
            <span class="category-label"><span class="category-dot" style="background:var(--blue)"></span> New Leads</span>
            <span class="category-count" id="cat-new-lead">‚Äî</span>
          </li>
        </ul>
      </div>

      <!-- Settings Panel -->
      <div class="sidebar-card" id="settings-panel" style="display:none;">
        <div class="sidebar-title">‚öôÔ∏è Notification Settings</div>
        
        <div style="font-size:0.75rem;color:var(--muted);text-transform:uppercase;font-weight:600;margin:12px 0 8px;">Alert Types</div>
        <div class="settings-toggle">
          <label>Overdue Follow-ups</label>
          <div class="toggle-switch on" data-setting="show_overdue" onclick="toggleSetting(this)"></div>
        </div>
        <div class="settings-toggle">
          <label>Expiring Contracts</label>
          <div class="toggle-switch on" data-setting="show_expiring" onclick="toggleSetting(this)"></div>
        </div>
        <div class="settings-toggle">
          <label>Low Inventory</label>
          <div class="toggle-switch on" data-setting="show_inventory" onclick="toggleSetting(this)"></div>
        </div>
        <div class="settings-toggle">
          <label>Maintenance Due</label>
          <div class="toggle-switch on" data-setting="show_maintenance" onclick="toggleSetting(this)"></div>
        </div>
        <div class="settings-toggle">
          <label>Goals Alerts</label>
          <div class="toggle-switch on" data-setting="show_goals" onclick="toggleSetting(this)"></div>
        </div>
        <div class="settings-toggle">
          <label>New Leads</label>
          <div class="toggle-switch on" data-setting="show_new_leads" onclick="toggleSetting(this)"></div>
        </div>

        <div style="font-size:0.75rem;color:var(--muted);text-transform:uppercase;font-weight:600;margin:16px 0 8px;">Thresholds</div>
        <div class="threshold-setting">
          <label>Overdue after</label>
          <input type="number" class="threshold-input" id="threshold-overdue" value="7" min="1" max="90" onchange="saveThreshold('overdue', this.value)">
          <span class="threshold-unit">days</span>
        </div>
        <div class="threshold-setting">
          <label>Contract expiry alert</label>
          <input type="number" class="threshold-input" id="threshold-expiring" value="30" min="7" max="180" onchange="saveThreshold('expiring', this.value)">
          <span class="threshold-unit">days</span>
        </div>
        <div class="threshold-setting">
          <label>Low inventory at</label>
          <input type="number" class="threshold-input" id="threshold-inventory" value="20" min="5" max="50" onchange="saveThreshold('inventory', this.value)">
          <span class="threshold-unit">%</span>
        </div>

        <div style="font-size:0.75rem;color:var(--muted);text-transform:uppercase;font-weight:600;margin:16px 0 8px;">Email Notifications</div>
        <div class="settings-toggle">
          <label>Daily Digest</label>
          <div class="toggle-switch" data-setting="email_daily" onclick="toggleSetting(this)"></div>
        </div>
        <div class="settings-toggle">
          <label>Urgent Alerts Only</label>
          <div class="toggle-switch" data-setting="email_urgent" onclick="toggleSetting(this)"></div>
        </div>
        <p style="font-size:0.72rem;color:var(--muted);margin-top:12px;">üìß Email notifications coming soon</p>
      </div>

      <!-- Quick Actions -->
      <div class="sidebar-card">
        <div class="sidebar-title">‚ö° Quick Actions</div>
        <div style="display:flex;flex-direction:column;gap:8px;">
          <a href="/follow-ups" class="action-btn" style="text-align:center;display:block;">View All Follow-ups</a>
          <a href="/contracts" class="action-btn" style="text-align:center;display:block;">Manage Contracts</a>
          <a href="/inventory" class="action-btn" style="text-align:center;display:block;">Check Inventory</a>
          <a href="/crm" class="action-btn" style="text-align:center;display:block;">Go to CRM</a>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Snooze Modal -->
<div class="modal-overlay" id="snooze-modal">
  <div class="modal-content">
    <div class="modal-title">‚è∞ Snooze Notification</div>
    <div class="modal-body">
      <p style="font-size:0.88rem;color:var(--muted);margin-bottom:16px;">Remind me about this later:</p>
      <div class="snooze-options">
        <div class="snooze-option" onclick="snoozeFor(1)">In 1 hour</div>
        <div class="snooze-option" onclick="snoozeFor(4)">In 4 hours</div>
        <div class="snooze-option" onclick="snoozeFor(24)">Tomorrow</div>
        <div class="snooze-option" onclick="snoozeFor(72)">In 3 days</div>
        <div class="snooze-option" onclick="snoozeFor(168)">Next week</div>
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn btn-secondary" onclick="closeSnoozeModal()">Cancel</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
(function() {
  'use strict';

  let notifications = [];
  let currentFilter = 'all';
  let currentSort = 'newest';
  let settings = {
    show_overdue: true,
    show_expiring: true,
    show_inventory: true,
    show_maintenance: true,
    show_goals: true,
    show_new_leads: true,
    email_daily: false,
    email_urgent: false,
    threshold_overdue: 7,
    threshold_expiring: 30,
    threshold_inventory: 20
  };
  let snoozeTargetId = null;

  // Load settings from localStorage
  function loadSettings() {
    try {
      const saved = localStorage.getItem('vendtech_notification_settings');
      if (saved) {
        settings = { ...settings, ...JSON.parse(saved) };
        // Apply settings to UI
        document.querySelectorAll('.toggle-switch').forEach(toggle => {
          const key = toggle.dataset.setting;
          if (key && settings[key]) toggle.classList.add('on');
          else if (key) toggle.classList.remove('on');
        });
        document.getElementById('threshold-overdue').value = settings.threshold_overdue;
        document.getElementById('threshold-expiring').value = settings.threshold_expiring;
        document.getElementById('threshold-inventory').value = settings.threshold_inventory;
      }
    } catch (e) { console.error('Error loading settings:', e); }
  }

  function saveSettings() {
    try {
      localStorage.setItem('vendtech_notification_settings', JSON.stringify(settings));
    } catch (e) { console.error('Error saving settings:', e); }
  }

  // Time ago helper
  function timeAgo(date) {
    if (!date) return '';
    const diff = (Date.now() - new Date(date).getTime()) / 1000;
    if (diff < 60) return 'just now';
    if (diff < 3600) return Math.floor(diff / 60) + 'm ago';
    if (diff < 86400) return Math.floor(diff / 3600) + 'h ago';
    if (diff < 604800) return Math.floor(diff / 86400) + 'd ago';
    return new Date(date).toLocaleDateString();
  }

  // Get icon for notification type
  function getTypeIcon(type) {
    const icons = {
      activity: 'üìç',
      overdue: '‚è∞',
      expiring: 'üìÑ',
      inventory: 'üì¶',
      maintenance: 'üîß',
      goal: 'üéØ',
      'new-lead': '‚ú®',
      call: 'üìû',
      email: 'üìß',
      'pop-in': 'üìç',
      'pop_in': 'üìç',
      'stage-change': 'üîÄ',
      note: 'üìù'
    };
    return icons[type] || 'üîî';
  }

  // Render notification item
  function renderNotification(n) {
    const icon = getTypeIcon(n.type);
    const isUnread = !n.read;
    const priorityClass = n.priority || 'low';
    
    return `
      <li class="notification-item ${isUnread ? 'unread' : ''}" data-id="${n.id}" data-type="${n.type}">
        <div class="notification-icon ${n.type}">${icon}</div>
        <div class="notification-content">
          <div class="notification-title">${escapeHtml(n.title)}</div>
          <div class="notification-desc">${escapeHtml(n.description || '')}</div>
          <div class="notification-meta">
            <span class="notification-time">${timeAgo(n.created_at)}</span>
            ${n.priority && n.priority !== 'low' ? `<span class="notification-priority ${priorityClass}">${priorityClass}</span>` : ''}
          </div>
          <div class="notification-actions">
            ${n.prospect_id ? `<a href="/crm#prospect-${n.prospect_id}" class="action-btn primary">View</a>` : ''}
            ${n.link ? `<a href="${n.link}" class="action-btn primary">View</a>` : ''}
            <button class="action-btn" onclick="snoozeNotification(${n.id}, event)">Snooze</button>
            <button class="action-btn dismiss" onclick="dismissNotification(${n.id}, event)">Dismiss</button>
          </div>
        </div>
      </li>
    `;
  }

  // Escape HTML
  function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  // Load notifications
  window.loadNotifications = async function() {
    try {
      const res = await fetch('/api/notifications?' + new URLSearchParams({
        threshold_overdue: settings.threshold_overdue,
        threshold_expiring: settings.threshold_expiring
      }));
      if (!res.ok) throw new Error('Failed to load notifications');
      const data = await res.json();
      notifications = data.notifications || [];
      
      // Update stats
      document.getElementById('stat-unread').textContent = data.stats?.unread || 0;
      document.getElementById('stat-overdue').textContent = data.stats?.overdue || 0;
      document.getElementById('stat-attention').textContent = data.stats?.attention || 0;
      document.getElementById('stat-today').textContent = data.stats?.today || 0;
      
      // Update category counts
      document.getElementById('cat-overdue').textContent = data.stats?.by_type?.overdue || 0;
      document.getElementById('cat-expiring').textContent = data.stats?.by_type?.expiring || 0;
      document.getElementById('cat-inventory').textContent = data.stats?.by_type?.inventory || 0;
      document.getElementById('cat-maintenance').textContent = data.stats?.by_type?.maintenance || 0;
      document.getElementById('cat-goal').textContent = data.stats?.by_type?.goal || 0;
      document.getElementById('cat-new-lead').textContent = data.stats?.by_type?.['new-lead'] || 0;
      
      renderNotifications();
      
      // Update nav bell badge
      updateNavBadge(data.stats?.unread || 0);
      
    } catch (e) {
      console.error('Error loading notifications:', e);
      document.getElementById('notification-list').innerHTML = `
        <li class="empty-state">
          <div class="empty-icon">‚ö†Ô∏è</div>
          <p>Failed to load notifications</p>
        </li>
      `;
    }
  };

  // Render notification list
  function renderNotifications() {
    let filtered = [...notifications];
    
    // Filter by type
    if (currentFilter !== 'all') {
      filtered = filtered.filter(n => n.type === currentFilter);
    }
    
    // Filter by settings
    filtered = filtered.filter(n => {
      if (n.type === 'overdue' && !settings.show_overdue) return false;
      if (n.type === 'expiring' && !settings.show_expiring) return false;
      if (n.type === 'inventory' && !settings.show_inventory) return false;
      if (n.type === 'maintenance' && !settings.show_maintenance) return false;
      if (n.type === 'goal' && !settings.show_goals) return false;
      if (n.type === 'new-lead' && !settings.show_new_leads) return false;
      return true;
    });
    
    // Sort
    if (currentSort === 'newest') {
      filtered.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
    } else if (currentSort === 'oldest') {
      filtered.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));
    } else if (currentSort === 'priority') {
      const priorityOrder = { high: 0, medium: 1, low: 2 };
      filtered.sort((a, b) => (priorityOrder[a.priority] || 2) - (priorityOrder[b.priority] || 2));
    }
    
    const list = document.getElementById('notification-list');
    if (filtered.length === 0) {
      list.innerHTML = `
        <li class="empty-state">
          <div class="empty-icon">‚ú®</div>
          <p>No notifications in this category</p>
        </li>
      `;
    } else {
      list.innerHTML = filtered.map(renderNotification).join('');
    }
  }

  // Filter notifications
  window.filterNotifications = function(filter, el) {
    currentFilter = filter;
    document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
    el.classList.add('active');
    renderNotifications();
  };

  // Sort notifications
  window.sortNotifications = function() {
    currentSort = document.getElementById('sort-select').value;
    renderNotifications();
  };

  // Mark all as read
  window.markAllRead = async function() {
    try {
      await fetch('/api/notifications/mark-all-read', { method: 'POST' });
      notifications.forEach(n => n.read = true);
      renderNotifications();
      document.getElementById('stat-unread').textContent = '0';
      updateNavBadge(0);
      showToast('All notifications marked as read', 'success');
    } catch (e) {
      showToast('Failed to mark as read', 'error');
    }
  };

  // Dismiss notification
  window.dismissNotification = async function(id, event) {
    event.stopPropagation();
    try {
      await fetch(`/api/notifications/${id}/dismiss`, { method: 'POST' });
      notifications = notifications.filter(n => n.id !== id);
      renderNotifications();
      loadNotifications(); // Refresh stats
      showToast('Notification dismissed');
    } catch (e) {
      showToast('Failed to dismiss', 'error');
    }
  };

  // Snooze notification
  window.snoozeNotification = function(id, event) {
    event.stopPropagation();
    snoozeTargetId = id;
    document.getElementById('snooze-modal').classList.add('open');
  };

  window.snoozeFor = async function(hours) {
    if (!snoozeTargetId) return;
    try {
      await fetch(`/api/notifications/${snoozeTargetId}/snooze`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ hours })
      });
      notifications = notifications.filter(n => n.id !== snoozeTargetId);
      renderNotifications();
      closeSnoozeModal();
      showToast(`Snoozed for ${hours < 24 ? hours + ' hours' : Math.floor(hours/24) + ' days'}`);
    } catch (e) {
      showToast('Failed to snooze', 'error');
    }
  };

  window.closeSnoozeModal = function() {
    document.getElementById('snooze-modal').classList.remove('open');
    snoozeTargetId = null;
  };

  // Toggle settings panel
  window.toggleSettings = function() {
    const panel = document.getElementById('settings-panel');
    panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
  };

  // Toggle setting
  window.toggleSetting = function(el) {
    el.classList.toggle('on');
    const key = el.dataset.setting;
    settings[key] = el.classList.contains('on');
    saveSettings();
    renderNotifications();
  };

  // Save threshold
  window.saveThreshold = function(type, value) {
    settings[`threshold_${type}`] = parseInt(value) || 7;
    saveSettings();
    loadNotifications(); // Reload with new threshold
  };

  // Update nav badge
  function updateNavBadge(count) {
    // Find or create badge element in nav
    let badge = document.querySelector('#kv-notification-badge');
    if (!badge) {
      const navRight = document.querySelector('#kv-topnav .kv-nav-right');
      if (navRight) {
        const bellContainer = document.createElement('a');
        bellContainer.href = '/notifications';
        bellContainer.id = 'kv-notification-bell';
        bellContainer.style.cssText = 'position:relative;display:flex;align-items:center;margin-right:8px;font-size:1.2rem;text-decoration:none;';
        bellContainer.innerHTML = 'üîî';
        
        badge = document.createElement('span');
        badge.id = 'kv-notification-badge';
        badge.style.cssText = 'position:absolute;top:-4px;right:-6px;background:#ef4444;color:#fff;font-size:0.65rem;font-weight:700;padding:2px 5px;border-radius:10px;min-width:16px;text-align:center;';
        bellContainer.appendChild(badge);
        
        navRight.insertBefore(bellContainer, navRight.firstChild);
      }
    }
    
    if (badge) {
      if (count > 0) {
        badge.textContent = count > 99 ? '99+' : count;
        badge.style.display = 'block';
      } else {
        badge.style.display = 'none';
      }
    }
  }

  // Show toast
  function showToast(message, type = '') {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.className = 'toast ' + type;
    setTimeout(() => toast.classList.add('show'), 10);
    setTimeout(() => toast.classList.remove('show'), 3000);
  }

  // Initialize
  loadSettings();
  loadNotifications();
  
  // Refresh every 60 seconds
  setInterval(loadNotifications, 60000);

})();
</script>
</body>
</html>
