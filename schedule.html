<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-vend-32.png">
  <title>Kande VendTech ‚Äî Schedule</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg: #f5f5f7; --card: #ffffff; --border: #e2e8f0; --text: #1a202c;
      --muted: #718096; --accent: #3182ce; --hot: #e53e3e; --warn: #dd6b20;
      --success: #38a169; --purple: #7b2cbf; --radius: 12px;
    }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }
    .app { max-width: 1400px; margin: 0 auto; padding: 20px; }

    /* Header */
    .page-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; flex-wrap: wrap; gap: 12px; }
    .page-header h1 { font-size: 1.6rem; font-weight: 700; display: flex; align-items: center; gap: 10px; }
    .header-actions { display: flex; gap: 8px; flex-wrap: wrap; }

    /* Buttons */
    .btn { display: inline-flex; align-items: center; gap: 6px; padding: 10px 18px; border-radius: 8px; border: 1px solid var(--border); background: var(--card); color: var(--text); font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.15s; }
    .btn:hover { background: #f0f4f8; }
    .btn-primary { background: var(--accent); color: #fff; border-color: var(--accent); }
    .btn-primary:hover { background: #2b6cb0; }
    .btn-success { background: var(--success); color: #fff; border-color: var(--success); }
    .btn-danger { background: var(--hot); color: #fff; border-color: var(--hot); }
    .btn-sm { padding: 6px 12px; font-size: 0.78rem; }

    /* Week Navigation */
    .week-nav { display: flex; align-items: center; gap: 16px; margin-bottom: 20px; }
    .week-nav .week-label { font-size: 1.1rem; font-weight: 600; min-width: 220px; text-align: center; }
    .week-nav .btn { padding: 8px 14px; }

    /* Tabs */
    .tab-bar { display: flex; gap: 4px; margin-bottom: 20px; background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 4px; }
    .tab-btn { padding: 8px 18px; border: none; background: none; border-radius: 8px; font-size: 0.85rem; font-weight: 600; cursor: pointer; color: var(--muted); transition: all 0.15s; }
    .tab-btn.active { background: var(--accent); color: #fff; }
    .tab-btn:hover:not(.active) { background: #f0f4f8; color: var(--text); }

    /* Calendar Grid */
    .calendar-grid { display: grid; grid-template-columns: 120px repeat(7, 1fr); gap: 1px; background: var(--border); border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; margin-bottom: 24px; }
    .cal-header { background: #edf2f7; padding: 10px 8px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: var(--muted); text-align: center; }
    .cal-header.today { background: rgba(49,130,206,0.1); color: var(--accent); }
    .cal-label { background: var(--card); padding: 10px 12px; font-size: 0.82rem; font-weight: 600; display: flex; align-items: flex-start; flex-direction: column; gap: 4px; min-height: 80px; }
    .cal-label .role-tag { font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; font-weight: 600; }
    .role-driver { background: rgba(49,130,206,0.1); color: var(--accent); }
    .role-packer { background: rgba(123,44,191,0.1); color: var(--purple); }

    .cal-cell { background: var(--card); padding: 6px; min-height: 80px; position: relative; transition: background 0.15s; }
    .cal-cell:hover { background: #fafbfc; }
    .cal-cell.dragover { background: rgba(49,130,206,0.06); outline: 2px dashed var(--accent); outline-offset: -2px; }
    .cal-cell.today { background: rgba(49,130,206,0.03); }
    .cal-cell.conflict { background: rgba(229,62,62,0.05); }

    /* Shift Chips */
    .shift-chip { padding: 5px 8px; border-radius: 6px; font-size: 0.72rem; font-weight: 600; margin-bottom: 3px; cursor: grab; user-select: none; display: flex; align-items: center; justify-content: space-between; gap: 4px; transition: all 0.15s; }
    .shift-chip:active { cursor: grabbing; opacity: 0.8; }
    .shift-chip.driver-shift { background: rgba(49,130,206,0.12); color: #2b6cb0; border-left: 3px solid var(--accent); }
    .shift-chip.packer-shift { background: rgba(123,44,191,0.12); color: #6b21a8; border-left: 3px solid var(--purple); }
    .shift-chip.route-shift { background: rgba(56,161,105,0.12); color: #276749; border-left: 3px solid var(--success); }
    .shift-chip.off-shift { background: #f7fafc; color: var(--muted); border-left: 3px solid var(--border); }
    .shift-chip .shift-del { background: none; border: none; cursor: pointer; font-size: 0.8rem; color: inherit; opacity: 0.5; padding: 0 2px; }
    .shift-chip .shift-del:hover { opacity: 1; }
    .conflict-badge { position: absolute; top: 4px; right: 4px; width: 8px; height: 8px; border-radius: 50%; background: var(--hot); }

    .add-shift-btn { width: 100%; padding: 4px; border: 1px dashed var(--border); border-radius: 4px; background: none; color: var(--muted); font-size: 0.7rem; cursor: pointer; margin-top: 2px; }
    .add-shift-btn:hover { background: #f7fafc; border-color: var(--accent); color: var(--accent); }

    /* Stats Row */
    .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-bottom: 24px; }
    .stat-card { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px; }
    .stat-card .value { font-size: 1.8rem; font-weight: 800; }
    .stat-card .label { font-size: 0.75rem; color: var(--muted); text-transform: uppercase; margin-top: 4px; }
    .stat-card .value.accent { color: var(--accent); }
    .stat-card .value.success { color: var(--success); }
    .stat-card .value.warn { color: var(--warn); }
    .stat-card .value.danger { color: var(--hot); }

    /* Route Assignments Table */
    .data-table { width: 100%; border-collapse: collapse; background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; margin-bottom: 24px; }
    .data-table th { background: #edf2f7; padding: 10px 14px; font-size: 0.75rem; text-transform: uppercase; color: var(--muted); font-weight: 700; text-align: left; }
    .data-table td { padding: 10px 14px; border-top: 1px solid var(--border); font-size: 0.85rem; }
    .data-table tr:hover td { background: #fafbfc; }

    /* Modal */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); z-index: 1000; align-items: center; justify-content: center; }
    .modal-overlay.open { display: flex; }
    .modal { background: var(--card); border-radius: 16px; padding: 24px; width: 90%; max-width: 480px; box-shadow: 0 20px 60px rgba(0,0,0,0.15); }
    .modal h3 { font-size: 1.1rem; margin-bottom: 16px; }
    .form-group { margin-bottom: 14px; }
    .form-group label { display: block; font-size: 0.8rem; font-weight: 600; margin-bottom: 4px; color: var(--muted); }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 0.9rem; background: var(--card); }
    .form-group select { cursor: pointer; }
    .modal-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 16px; }

    /* Packer Schedule */
    .packer-link { display: flex; align-items: center; gap: 8px; padding: 12px 16px; background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); margin-bottom: 8px; }
    .packer-link .arrow { color: var(--muted); font-size: 1.2rem; }
    .packer-link .info { flex: 1; }
    .packer-link .info strong { font-size: 0.9rem; }
    .packer-link .info span { display: block; font-size: 0.78rem; color: var(--muted); }
    .packer-link .badge { padding: 4px 10px; border-radius: 6px; font-size: 0.75rem; font-weight: 600; }
    .badge-pending { background: rgba(221,107,32,0.1); color: var(--warn); }
    .badge-ready { background: rgba(56,161,105,0.1); color: var(--success); }

    @media (max-width: 900px) {
      .calendar-grid { grid-template-columns: 80px repeat(7, 1fr); font-size: 0.75rem; }
      .cal-label { padding: 6px; font-size: 0.72rem; }
      .shift-chip { font-size: 0.65rem; padding: 3px 5px; }
    }
    @media (max-width: 600px) {
      .calendar-grid { grid-template-columns: 60px repeat(7, 1fr); }
      .cal-header { padding: 6px 4px; font-size: 0.65rem; }
    }
  </style>
</head>
<body>
  <script src="/nav.js"></script>
  <div class="app">
    <div class="page-header">
      <h1>üìÖ Schedule</h1>
      <div class="header-actions">
        <button class="btn btn-primary" onclick="openAddShift()">+ Add Shift</button>
        <button class="btn" onclick="publishWeek()">üì§ Publish Week</button>
      </div>
    </div>

    <!-- Stats -->
    <div class="stats-row" id="schedStats">
      <div class="stat-card"><div class="value accent" id="statShifts">0</div><div class="label">Shifts This Week</div></div>
      <div class="stat-card"><div class="value success" id="statRoutes">0</div><div class="label">Routes Assigned</div></div>
      <div class="stat-card"><div class="value warn" id="statUnassigned">0</div><div class="label">Unassigned Routes</div></div>
      <div class="stat-card"><div class="value danger" id="statConflicts">0</div><div class="label">Conflicts</div></div>
    </div>

    <!-- Week Nav -->
    <div class="week-nav">
      <button class="btn btn-sm" onclick="changeWeek(-1)">‚Üê Prev</button>
      <div class="week-label" id="weekLabel">Loading...</div>
      <button class="btn btn-sm" onclick="changeWeek(1)">Next ‚Üí</button>
      <button class="btn btn-sm" onclick="goToday()">Today</button>
    </div>

    <!-- Tabs -->
    <div class="tab-bar">
      <button class="tab-btn active" data-tab="calendar" onclick="switchTab('calendar', this)">Calendar</button>
      <button class="tab-btn" data-tab="routes" onclick="switchTab('routes', this)">Route Assignments</button>
      <button class="tab-btn" data-tab="packer" onclick="switchTab('packer', this)">Packer Schedule</button>
    </div>

    <!-- Calendar View -->
    <div id="tab-calendar">
      <div class="calendar-grid" id="calGrid"></div>
    </div>

    <!-- Route Assignments View -->
    <div id="tab-routes" style="display:none">
      <table class="data-table" id="routeAssignTable">
        <thead>
          <tr>
            <th>Date</th>
            <th>Driver</th>
            <th>Route</th>
            <th>Stops</th>
            <th>Est. Time</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="routeAssignBody"></tbody>
      </table>
    </div>

    <!-- Packer Schedule View -->
    <div id="tab-packer" style="display:none">
      <p style="color:var(--muted); margin-bottom:16px; font-size:0.9rem;">Packers prepare inventory the night before drivers deliver. Shifts auto-linked to next-day routes.</p>
      <div id="packerList"></div>
    </div>
  </div>

  <!-- Add/Edit Shift Modal -->
  <div class="modal-overlay" id="shiftModal">
    <div class="modal">
      <h3 id="modalTitle">Add Shift</h3>
      <input type="hidden" id="editShiftId">
      <div class="form-group">
        <label>Staff Member</label>
        <select id="shiftStaff"></select>
      </div>
      <div class="form-group">
        <label>Type</label>
        <select id="shiftType">
          <option value="driver">üöê Driver Shift</option>
          <option value="packer">üì¶ Packer Shift</option>
          <option value="off">üèñÔ∏è Day Off</option>
        </select>
      </div>
      <div class="form-group">
        <label>Date</label>
        <input type="date" id="shiftDate">
      </div>
      <div class="form-group">
        <label>Start Time</label>
        <input type="time" id="shiftStart" value="08:00">
      </div>
      <div class="form-group">
        <label>End Time</label>
        <input type="time" id="shiftEnd" value="16:00">
      </div>
      <div class="form-group" id="routeAssignGroup">
        <label>Assign Route</label>
        <select id="shiftRoute"><option value="">‚Äî No route ‚Äî</option></select>
      </div>
      <div class="form-group">
        <label>Notes</label>
        <textarea id="shiftNotes" rows="2" placeholder="Optional notes..."></textarea>
      </div>
      <div class="modal-actions">
        <button class="btn" onclick="closeModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveShift()">Save Shift</button>
      </div>
    </div>
  </div>

  <script>
    const API = '/api/schedule';
    let currentWeekStart = getWeekStart(new Date());
    let shifts = [];
    let staffList = [];
    let routeTemplates = [];

    function getWeekStart(d) {
      const dt = new Date(d);
      const day = dt.getDay();
      dt.setDate(dt.getDate() - day);
      dt.setHours(0,0,0,0);
      return dt;
    }

    function formatDate(d) {
      return d.toISOString().split('T')[0];
    }

    function getWeekDates() {
      const dates = [];
      for (let i = 0; i < 7; i++) {
        const d = new Date(currentWeekStart);
        d.setDate(d.getDate() + i);
        dates.push(d);
      }
      return dates;
    }

    function changeWeek(dir) {
      currentWeekStart.setDate(currentWeekStart.getDate() + (dir * 7));
      loadSchedule();
    }

    function goToday() {
      currentWeekStart = getWeekStart(new Date());
      loadSchedule();
    }

    function switchTab(tab, btn) {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      ['calendar','routes','packer'].forEach(t => {
        document.getElementById('tab-' + t).style.display = t === tab ? '' : 'none';
      });
    }

    async function loadSchedule() {
      const start = formatDate(currentWeekStart);
      const end = formatDate(new Date(currentWeekStart.getTime() + 6 * 86400000));
      const wlabel = document.getElementById('weekLabel');
      wlabel.textContent = `${new Date(start).toLocaleDateString('en-US', {month:'short',day:'numeric'})} ‚Äì ${new Date(end).toLocaleDateString('en-US', {month:'short',day:'numeric',year:'numeric'})}`;

      try {
        const [shiftsRes, staffRes, templatesRes] = await Promise.all([
          fetch(`${API}/shifts?start=${start}&end=${end}`).then(r=>r.json()),
          fetch(`${API}/staff`).then(r=>r.json()),
          fetch('/api/routes/templates').then(r=>r.json())
        ]);
        shifts = shiftsRes.shifts || [];
        staffList = staffRes.staff || [];
        routeTemplates = templatesRes.templates || [];
      } catch(e) {
        console.error('Load error:', e);
        shifts = []; staffList = []; routeTemplates = [];
      }

      renderCalendar();
      renderRouteAssignments();
      renderPackerSchedule();
      updateStats();
      populateStaffSelect();
      populateRouteSelect();
    }

    function updateStats() {
      document.getElementById('statShifts').textContent = shifts.length;
      const routeShifts = shifts.filter(s => s.route_id);
      document.getElementById('statRoutes').textContent = routeShifts.length;
      
      const driverShifts = shifts.filter(s => s.type === 'driver' && !s.route_id);
      document.getElementById('statUnassigned').textContent = driverShifts.length;

      // Detect conflicts (same person, same date, overlapping times)
      let conflicts = 0;
      for (let i = 0; i < shifts.length; i++) {
        for (let j = i + 1; j < shifts.length; j++) {
          if (shifts[i].staff_id === shifts[j].staff_id &&
              shifts[i].date === shifts[j].date &&
              shifts[i].type !== 'off' && shifts[j].type !== 'off') {
            if (timeOverlaps(shifts[i], shifts[j])) conflicts++;
          }
        }
      }
      document.getElementById('statConflicts').textContent = conflicts;
    }

    function timeOverlaps(a, b) {
      const aStart = a.start_time || '00:00';
      const aEnd = a.end_time || '23:59';
      const bStart = b.start_time || '00:00';
      const bEnd = b.end_time || '23:59';
      return aStart < bEnd && bStart < aEnd;
    }

    function renderCalendar() {
      const grid = document.getElementById('calGrid');
      const dates = getWeekDates();
      const today = formatDate(new Date());
      const dayNames = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];

      // Build headers
      let html = '<div class="cal-header"></div>';
      dates.forEach((d, i) => {
        const isToday = formatDate(d) === today;
        html += `<div class="cal-header${isToday ? ' today' : ''}">${dayNames[i]}<br>${d.getMonth()+1}/${d.getDate()}</div>`;
      });

      // Build rows for each staff member
      staffList.forEach(staff => {
        const roleClass = staff.role === 'packer' ? 'role-packer' : 'role-driver';
        html += `<div class="cal-label">
          <span>${staff.name}</span>
          <span class="role-tag ${roleClass}">${staff.role || 'driver'}</span>
        </div>`;

        dates.forEach(d => {
          const dateStr = formatDate(d);
          const isToday = dateStr === today;
          const cellShifts = shifts.filter(s => s.staff_id === staff.id && s.date === dateStr);
          const hasConflict = cellShifts.length > 1 && cellShifts.filter(s => s.type !== 'off').length > 1;

          html += `<div class="cal-cell${isToday ? ' today' : ''}${hasConflict ? ' conflict' : ''}" 
            data-staff="${staff.id}" data-date="${dateStr}"
            ondragover="onDragOver(event)" ondrop="onDrop(event)" ondragleave="onDragLeave(event)">`;
          
          if (hasConflict) html += '<div class="conflict-badge" title="Double-booked!"></div>';
          
          cellShifts.forEach(s => {
            const chipClass = s.type === 'off' ? 'off-shift' : s.type === 'packer' ? 'packer-shift' : s.route_id ? 'route-shift' : 'driver-shift';
            const label = s.type === 'off' ? 'OFF' : s.route_name ? `üöõ ${s.route_name}` : s.type === 'packer' ? 'üì¶ Pack' : 'üöê Drive';
            const time = s.start_time && s.end_time ? `${s.start_time}-${s.end_time}` : '';
            html += `<div class="shift-chip ${chipClass}" draggable="true" 
              ondragstart="onDragStart(event, ${s.id})" data-shift-id="${s.id}" 
              onclick="editShift(${s.id})" title="${s.notes || ''}">
              <span>${label}${time ? ' ' + time : ''}</span>
              <button class="shift-del" onclick="event.stopPropagation();deleteShift(${s.id})">√ó</button>
            </div>`;
          });

          html += `<button class="add-shift-btn" onclick="openAddShift('${staff.id}','${dateStr}')">+</button>`;
          html += '</div>';
        });
      });

      grid.innerHTML = html;
    }

    function renderRouteAssignments() {
      const tbody = document.getElementById('routeAssignBody');
      const dates = getWeekDates();
      const rows = [];

      dates.forEach(d => {
        const dateStr = formatDate(d);
        const dayShifts = shifts.filter(s => s.date === dateStr && s.type === 'driver');
        dayShifts.forEach(s => {
          const staff = staffList.find(st => st.id === s.staff_id);
          rows.push({
            date: dateStr,
            driver: staff ? staff.name : 'Unknown',
            route: s.route_name || '‚Äî',
            stops: s.route_stops || 0,
            est_time: s.route_est_time ? `${s.route_est_time} min` : '‚Äî',
            status: s.status || 'scheduled',
            id: s.id
          });
        });
      });

      tbody.innerHTML = rows.length ? rows.map(r => `
        <tr>
          <td>${new Date(r.date + 'T12:00').toLocaleDateString('en-US', {weekday:'short',month:'short',day:'numeric'})}</td>
          <td>${r.driver}</td>
          <td>${r.route}</td>
          <td>${r.stops}</td>
          <td>${r.est_time}</td>
          <td><span style="color:${r.status==='completed'?'var(--success)':r.status==='in_progress'?'var(--accent)':'var(--muted)'}">${r.status}</span></td>
          <td><button class="btn btn-sm" onclick="editShift(${r.id})">Edit</button></td>
        </tr>
      `).join('') : '<tr><td colspan="7" style="text-align:center;color:var(--muted);padding:24px">No driver shifts this week. Add some!</td></tr>';
    }

    function renderPackerSchedule() {
      const container = document.getElementById('packerList');
      const dates = getWeekDates();
      let html = '';

      dates.forEach(d => {
        const dateStr = formatDate(d);
        const nextDay = new Date(d); nextDay.setDate(nextDay.getDate() + 1);
        const nextDateStr = formatDate(nextDay);

        // Packer shifts for this evening
        const packerShifts = shifts.filter(s => s.date === dateStr && s.type === 'packer');
        // Driver routes for tomorrow
        const tomorrowRoutes = shifts.filter(s => s.date === nextDateStr && s.type === 'driver' && s.route_id);

        if (packerShifts.length > 0 || tomorrowRoutes.length > 0) {
          html += `<div style="margin-bottom:16px">
            <div style="font-weight:600; margin-bottom:8px; font-size:0.9rem;">${new Date(dateStr + 'T12:00').toLocaleDateString('en-US', {weekday:'long',month:'short',day:'numeric'})} Evening</div>`;
          
          if (tomorrowRoutes.length === 0) {
            html += '<div class="packer-link"><span class="info"><span>No routes scheduled for tomorrow</span></span></div>';
          } else {
            tomorrowRoutes.forEach(r => {
              const driver = staffList.find(st => st.id === r.staff_id);
              const hasPacker = packerShifts.length > 0;
              html += `<div class="packer-link">
                <span class="arrow">üì¶</span>
                <span class="info">
                  <strong>Pack for: ${r.route_name || 'Route'} ‚Üí ${driver ? driver.name : 'TBD'}</strong>
                  <span>${r.route_stops || '?'} stops ¬∑ Delivery ${nextDateStr}</span>
                </span>
                <span class="badge ${hasPacker ? 'badge-ready' : 'badge-pending'}">${hasPacker ? '‚úì Packer assigned' : '‚ö† Need packer'}</span>
              </div>`;
            });
          }

          packerShifts.forEach(p => {
            const staff = staffList.find(st => st.id === p.staff_id);
            html += `<div class="packer-link">
              <span class="arrow">üë§</span>
              <span class="info">
                <strong>${staff ? staff.name : 'TBD'}</strong>
                <span>${p.start_time || '17:00'} ‚Äì ${p.end_time || '21:00'}</span>
              </span>
            </div>`;
          });

          html += '</div>';
        }
      });

      container.innerHTML = html || '<p style="color:var(--muted);text-align:center;padding:32px">No packer shifts scheduled this week.</p>';
    }

    // Drag & Drop
    let dragShiftId = null;
    function onDragStart(e, shiftId) {
      dragShiftId = shiftId;
      e.dataTransfer.effectAllowed = 'move';
      e.target.style.opacity = '0.5';
    }
    function onDragOver(e) {
      e.preventDefault();
      e.currentTarget.classList.add('dragover');
    }
    function onDragLeave(e) {
      e.currentTarget.classList.remove('dragover');
    }
    async function onDrop(e) {
      e.preventDefault();
      e.currentTarget.classList.remove('dragover');
      if (!dragShiftId) return;

      const cell = e.currentTarget;
      const newStaffId = parseInt(cell.dataset.staff);
      const newDate = cell.dataset.date;

      try {
        await fetch(`${API}/shifts/${dragShiftId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ staff_id: newStaffId, date: newDate })
        });
        loadSchedule();
      } catch(err) {
        alert('Failed to move shift');
      }
      dragShiftId = null;
    }

    // Staff & route dropdowns
    function populateStaffSelect() {
      const sel = document.getElementById('shiftStaff');
      sel.innerHTML = staffList.map(s => `<option value="${s.id}">${s.name} (${s.role || 'driver'})</option>`).join('');
    }
    function populateRouteSelect() {
      const sel = document.getElementById('shiftRoute');
      sel.innerHTML = '<option value="">‚Äî No route ‚Äî</option>' + routeTemplates.map(t => `<option value="${t.id}">${t.name} (${(t.stops||[]).length} stops)</option>`).join('');
    }

    // Modal
    function openAddShift(staffId, date) {
      document.getElementById('modalTitle').textContent = 'Add Shift';
      document.getElementById('editShiftId').value = '';
      if (staffId) document.getElementById('shiftStaff').value = staffId;
      if (date) document.getElementById('shiftDate').value = date;
      else document.getElementById('shiftDate').value = formatDate(new Date());
      document.getElementById('shiftStart').value = '08:00';
      document.getElementById('shiftEnd').value = '16:00';
      document.getElementById('shiftType').value = 'driver';
      document.getElementById('shiftRoute').value = '';
      document.getElementById('shiftNotes').value = '';
      document.getElementById('shiftModal').classList.add('open');
    }

    function editShift(id) {
      const shift = shifts.find(s => s.id === id);
      if (!shift) return;
      document.getElementById('modalTitle').textContent = 'Edit Shift';
      document.getElementById('editShiftId').value = id;
      document.getElementById('shiftStaff').value = shift.staff_id;
      document.getElementById('shiftDate').value = shift.date;
      document.getElementById('shiftStart').value = shift.start_time || '08:00';
      document.getElementById('shiftEnd').value = shift.end_time || '16:00';
      document.getElementById('shiftType').value = shift.type;
      document.getElementById('shiftRoute').value = shift.route_id || '';
      document.getElementById('shiftNotes').value = shift.notes || '';
      document.getElementById('shiftModal').classList.add('open');
    }

    function closeModal() { document.getElementById('shiftModal').classList.remove('open'); }

    async function saveShift() {
      const editId = document.getElementById('editShiftId').value;
      const data = {
        staff_id: parseInt(document.getElementById('shiftStaff').value),
        type: document.getElementById('shiftType').value,
        date: document.getElementById('shiftDate').value,
        start_time: document.getElementById('shiftStart').value,
        end_time: document.getElementById('shiftEnd').value,
        route_id: document.getElementById('shiftRoute').value || null,
        notes: document.getElementById('shiftNotes').value
      };

      // Get route info if assigned
      if (data.route_id) {
        const tmpl = routeTemplates.find(t => String(t.id) === String(data.route_id));
        if (tmpl) {
          data.route_name = tmpl.name;
          data.route_stops = (tmpl.stops || []).length;
          data.route_est_time = tmpl.est_time || (tmpl.stops || []).length * 20;
        }
      }

      try {
        const url = editId ? `${API}/shifts/${editId}` : `${API}/shifts`;
        const method = editId ? 'PUT' : 'POST';
        const res = await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
        const result = await res.json();
        if (result.conflict) {
          if (!confirm(`‚ö†Ô∏è Conflict: ${result.conflict}. Save anyway?`)) return;
          data.force = true;
          await fetch(url, { method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
        }
        closeModal();
        loadSchedule();
      } catch(e) { alert('Error saving shift'); }
    }

    async function deleteShift(id) {
      if (!confirm('Delete this shift?')) return;
      await fetch(`${API}/shifts/${id}`, { method: 'DELETE' });
      loadSchedule();
    }

    async function publishWeek() {
      const start = formatDate(currentWeekStart);
      if (confirm(`Publish schedule for week of ${start}? This will notify all staff.`)) {
        await fetch(`${API}/publish`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ week_start: start }) });
        alert('‚úÖ Schedule published!');
      }
    }

    // Type change handler - show/hide route assignment
    document.getElementById('shiftType').addEventListener('change', function() {
      document.getElementById('routeAssignGroup').style.display = this.value === 'driver' ? '' : 'none';
    });

    // Init
    loadSchedule();
  </script>
</body>
</html>
