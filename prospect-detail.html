<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-sales-32.png">
  <title>Prospect Detail ‚Äî Kande VendTech</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg: #f8fafc;
      --card: #ffffff;
      --border: #e2e8f0;
      --text: #1e293b;
      --muted: #64748b;
      --accent: #3b82f6;
      --hot: #ef4444;
      --warm: #f59e0b;
      --success: #10b981;
      --purple: #8b5cf6;
    }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }
    .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
    
    /* Header */
    .header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 24px; flex-wrap: wrap; gap: 16px; }
    .header-left { flex: 1; min-width: 300px; }
    .breadcrumb { font-size: 0.85rem; color: var(--muted); margin-bottom: 8px; }
    .breadcrumb a { color: var(--accent); text-decoration: none; }
    .breadcrumb a:hover { text-decoration: underline; }
    .property-name { font-size: 2rem; font-weight: 700; margin-bottom: 8px; display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
    .property-meta { display: flex; gap: 16px; color: var(--muted); font-size: 0.95rem; flex-wrap: wrap; align-items: center; }
    .property-meta a { color: var(--accent); text-decoration: none; }
    .property-meta a:hover { text-decoration: underline; }
    
    /* Badges */
    .badge { padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; }
    .badge-hot { background: rgba(239,68,68,0.15); color: var(--hot); }
    .badge-warm { background: rgba(245,158,11,0.15); color: var(--warm); }
    .badge-new { background: rgba(59,130,246,0.15); color: var(--accent); }
    .badge-signed { background: rgba(16,185,129,0.15); color: var(--success); }
    .badge-closed { background: rgba(100,116,139,0.15); color: var(--muted); }
    
    /* Score circle */
    .score-circle { width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1rem; border: 3px solid; }
    .score-high { background: rgba(16,185,129,0.1); border-color: var(--success); color: var(--success); }
    .score-med { background: rgba(245,158,11,0.1); border-color: var(--warm); color: var(--warm); }
    .score-low { background: rgba(239,68,68,0.1); border-color: var(--hot); color: var(--hot); }
    
    /* Quick Actions */
    .quick-actions { display: flex; gap: 8px; flex-wrap: wrap; }
    .action-btn { padding: 10px 16px; border-radius: 8px; font-size: 0.9rem; font-weight: 500; cursor: pointer; border: 1px solid var(--border); background: var(--card); color: var(--text); transition: all 0.2s; display: flex; align-items: center; gap: 6px; }
    .action-btn:hover { border-color: var(--accent); color: var(--accent); }
    .action-btn.primary { background: var(--accent); color: white; border-color: var(--accent); }
    .action-btn.primary:hover { opacity: 0.9; }
    .action-btn.success { background: var(--success); color: white; border-color: var(--success); }
    
    /* Grid Layout */
    .main-grid { display: grid; grid-template-columns: 1fr 380px; gap: 24px; }
    @media (max-width: 1100px) { .main-grid { grid-template-columns: 1fr; } }
    
    /* Cards */
    .card { background: var(--card); border-radius: 12px; border: 1px solid var(--border); overflow: hidden; }
    .card-header { padding: 16px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: #fafbfc; }
    .card-title { font-size: 1rem; font-weight: 600; display: flex; align-items: center; gap: 8px; }
    .card-body { padding: 20px; }
    .card-body.no-pad { padding: 0; }
    
    /* Stats Row */
    .stats-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 16px; margin-bottom: 24px; }
    .stat-box { background: var(--card); border-radius: 12px; padding: 16px; text-align: center; border: 1px solid var(--border); }
    .stat-value { font-size: 1.8rem; font-weight: 700; }
    .stat-value.accent { color: var(--accent); }
    .stat-value.success { color: var(--success); }
    .stat-value.warn { color: var(--warm); }
    .stat-value.hot { color: var(--hot); }
    .stat-label { font-size: 0.75rem; color: var(--muted); margin-top: 4px; }
    
    /* Pipeline Progression */
    .pipeline-bar { display: flex; gap: 4px; margin-bottom: 16px; }
    .pipeline-stage { flex: 1; height: 8px; border-radius: 4px; background: #e2e8f0; position: relative; transition: all 0.3s; }
    .pipeline-stage.completed { background: var(--success); }
    .pipeline-stage.current { background: var(--accent); animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
    .stage-info { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 8px; }
    .current-stage { font-weight: 600; color: var(--accent); }
    .days-in-stage { font-size: 0.85rem; color: var(--muted); }
    .stage-history { margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border); }
    .stage-history-item { display: flex; gap: 12px; padding: 8px 0; font-size: 0.85rem; }
    .stage-history-date { color: var(--muted); min-width: 80px; }
    
    /* Touch Counter */
    .touch-counter { margin-bottom: 20px; }
    .touch-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .touch-count { font-size: 2rem; font-weight: 700; }
    .touch-target { font-size: 0.9rem; color: var(--muted); }
    .touch-bar { height: 12px; background: #e2e8f0; border-radius: 6px; overflow: hidden; }
    .touch-fill { height: 100%; background: linear-gradient(90deg, var(--accent), var(--purple)); transition: width 0.5s ease; }
    .touch-recommendation { margin-top: 12px; padding: 12px; background: rgba(59,130,246,0.08); border-radius: 8px; border-left: 3px solid var(--accent); font-size: 0.9rem; }
    
    /* Contact Cards */
    .contact-list { display: flex; flex-direction: column; gap: 12px; }
    .contact-card { padding: 14px; background: #fafbfc; border-radius: 8px; border: 1px solid var(--border); }
    .contact-card.primary { border-left: 3px solid var(--accent); background: rgba(59,130,246,0.04); }
    .contact-name { font-weight: 600; display: flex; align-items: center; gap: 8px; }
    .contact-role { font-size: 0.85rem; color: var(--muted); margin-top: 2px; }
    .contact-links { display: flex; gap: 12px; margin-top: 8px; flex-wrap: wrap; }
    .contact-link { font-size: 0.85rem; color: var(--accent); text-decoration: none; display: flex; align-items: center; gap: 4px; }
    .contact-link:hover { text-decoration: underline; }
    
    /* Activity Timeline */
    .timeline { position: relative; padding-left: 24px; }
    .timeline::before { content: ''; position: absolute; left: 8px; top: 0; bottom: 0; width: 2px; background: var(--border); }
    .timeline-item { position: relative; padding-bottom: 20px; }
    .timeline-item:last-child { padding-bottom: 0; }
    .timeline-dot { position: absolute; left: -20px; top: 4px; width: 12px; height: 12px; border-radius: 50%; background: var(--accent); border: 2px solid white; box-shadow: 0 0 0 2px var(--border); }
    .timeline-dot.call { background: var(--accent); }
    .timeline-dot.pop-in, .timeline-dot.pop_in { background: var(--success); }
    .timeline-dot.email { background: var(--warm); }
    .timeline-dot.proposal { background: var(--purple); }
    .timeline-dot.gift, .timeline-dot.gift_basket { background: #ec4899; }
    .timeline-dot.status-change, .timeline-dot.pipeline_move { background: #6366f1; }
    .timeline-header { display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 8px; margin-bottom: 4px; }
    .timeline-type { font-weight: 600; font-size: 0.9rem; text-transform: capitalize; }
    .timeline-date { font-size: 0.8rem; color: var(--muted); }
    .timeline-desc { font-size: 0.9rem; color: var(--text); line-height: 1.5; }
    .timeline-outcome { margin-top: 6px; padding: 6px 10px; background: rgba(59,130,246,0.08); border-radius: 6px; font-size: 0.85rem; display: inline-block; }
    
    /* Notes Section */
    .notes-section { margin-bottom: 16px; }
    .notes-label { font-size: 0.85rem; font-weight: 600; margin-bottom: 6px; display: flex; align-items: center; gap: 6px; }
    .notes-label.sales { color: var(--accent); }
    .notes-label.internal { color: var(--warm); }
    .notes-textarea { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; font-family: inherit; font-size: 0.9rem; min-height: 80px; resize: vertical; background: #fafbfc; }
    .notes-textarea:focus { outline: none; border-color: var(--accent); background: white; }
    .auto-save-indicator { font-size: 0.75rem; color: var(--success); margin-top: 4px; opacity: 0; transition: opacity 0.3s; }
    .auto-save-indicator.show { opacity: 1; }
    
    /* Related Data Lists */
    .related-item { padding: 12px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 8px; }
    .related-item:last-child { border-bottom: none; }
    .related-item:hover { background: #fafbfc; }
    .related-main { flex: 1; }
    .related-title { font-weight: 500; font-size: 0.9rem; }
    .related-meta { font-size: 0.8rem; color: var(--muted); margin-top: 2px; }
    .related-status { padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; }
    .status-delivered { background: rgba(16,185,129,0.15); color: var(--success); }
    .status-planned { background: rgba(245,158,11,0.15); color: var(--warm); }
    .status-pending { background: rgba(100,116,139,0.15); color: var(--muted); }
    .status-sent { background: rgba(139,92,246,0.15); color: var(--purple); }
    
    /* Task List */
    .task-item { padding: 12px; border-bottom: 1px solid var(--border); display: flex; align-items: flex-start; gap: 12px; }
    .task-item:last-child { border-bottom: none; }
    .task-checkbox { width: 20px; height: 20px; border-radius: 4px; border: 2px solid var(--border); cursor: pointer; flex-shrink: 0; margin-top: 2px; }
    .task-checkbox:hover { border-color: var(--accent); }
    .task-checkbox.completed { background: var(--success); border-color: var(--success); }
    .task-content { flex: 1; }
    .task-title { font-size: 0.9rem; }
    .task-title.completed { text-decoration: line-through; color: var(--muted); }
    .task-due { font-size: 0.8rem; color: var(--muted); margin-top: 2px; }
    .task-due.overdue { color: var(--hot); font-weight: 600; }
    
    /* Empty States */
    .empty-state { padding: 30px; text-align: center; color: var(--muted); }
    .empty-state-icon { font-size: 2rem; margin-bottom: 8px; }
    
    /* Add Activity Form */
    .add-activity-form { padding: 16px; background: #fafbfc; border-top: 1px solid var(--border); }
    .form-row { display: flex; gap: 12px; margin-bottom: 12px; flex-wrap: wrap; }
    .form-group { flex: 1; min-width: 150px; }
    .form-label { font-size: 0.8rem; color: var(--muted); margin-bottom: 4px; display: block; }
    .form-input, .form-select, .form-textarea { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-family: inherit; font-size: 0.9rem; }
    .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--accent); }
    .form-textarea { min-height: 60px; resize: vertical; }
    
    /* Loading */
    .loading { display: flex; align-items: center; justify-content: center; padding: 60px; color: var(--muted); }
    
    /* Mobile */
    @media (max-width: 768px) {
      .property-name { font-size: 1.5rem; }
      .quick-actions { flex-wrap: wrap; }
      .action-btn { flex: 1; min-width: 140px; justify-content: center; }
      .stats-row { grid-template-columns: repeat(2, 1fr); }
    }
  </style>
</head>
<body>
  <div class="container" id="app">
    <div class="loading">Loading prospect...</div>
  </div>

  <script>
    let prospect = null;
    let prospectId = null;
    let pipelineCard = null;
    let giftBaskets = [];
    let proposals = [];
    let contracts = [];
    let tasks = [];
    let saveTimer = null;

    const PIPELINE_STAGES = [
      { id: 'new_lead', label: 'New Lead', order: 0, emoji: 'üÜï' },
      { id: 'contacted', label: 'Contacted', order: 1, emoji: 'üìß' },
      { id: 'pop_in_done', label: 'Outreach', order: 2, emoji: 'üì£' },
      { id: 'interested', label: 'Interested', order: 3, emoji: 'üëÄ' },
      { id: 'site_survey', label: 'Site Survey', order: 4, emoji: 'üìã' },
      { id: 'proposal_sent', label: 'Proposal', order: 5, emoji: 'üìù' },
      { id: 'negotiating', label: 'Negotiating', order: 6, emoji: 'ü§ù' },
      { id: 'contract_sent', label: 'Contract', order: 7, emoji: 'üìÑ' },
      { id: 'signed', label: 'Signed', order: 8, emoji: '‚úÖ' },
      { id: 'onboarding', label: 'Onboarding', order: 9, emoji: 'üîß' },
      { id: 'machine_placed', label: 'Machine Placed', order: 10, emoji: 'üè≠' },
      { id: 'active_client', label: 'Active', order: 11, emoji: 'üíö' }
    ];

    // Extract prospect ID from URL
    const pathParts = window.location.pathname.split('/');
    prospectId = parseInt(pathParts[pathParts.length - 1]);

    async function loadData() {
      if (!prospectId || isNaN(prospectId)) {
        document.getElementById('app').innerHTML = '<div class="loading">Invalid prospect ID</div>';
        return;
      }

      try {
        // Load prospect with contacts and activities
        const prospectRes = await fetch(`/api/prospects/${prospectId}`);
        if (!prospectRes.ok) throw new Error('Prospect not found');
        prospect = await prospectRes.json();
        document.title = `${prospect.name} ‚Äî Kande VendTech`;

        // Load related data in parallel
        const [pipelineRes, basketsRes, proposalsRes, contractsRes, tasksRes] = await Promise.all([
          fetch('/api/pipeline/cards'),
          fetch(`/api/gift-baskets?prospect_id=${prospectId}`),
          fetch('/api/proposals'),
          fetch(`/api/contracts?prospect_id=${prospectId}`),
          fetch(`/api/crm-tasks?prospect_id=${prospectId}`)
        ]);

        const pipelineData = await pipelineRes.json();
        // Find this prospect's pipeline card
        if (pipelineData.cards) {
          for (const stage of Object.keys(pipelineData.cards)) {
            const card = pipelineData.cards[stage].find(c => c.prospect_id === prospectId);
            if (card) { pipelineCard = card; break; }
          }
        }

        giftBaskets = (await basketsRes.json()).filter(b => b.prospect_id === prospectId);
        proposals = (await proposalsRes.json()).filter(p => p.prospect_id === prospectId);
        contracts = await contractsRes.json();
        tasks = await tasksRes.json();

        render();
      } catch (err) {
        console.error(err);
        document.getElementById('app').innerHTML = `<div class="loading">Error: ${err.message}</div>`;
      }
    }

    function esc(str) {
      if (!str) return '';
      return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    function formatDate(dateStr) {
      if (!dateStr) return '';
      const d = new Date(dateStr);
      return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }

    function formatDateTime(dateStr) {
      if (!dateStr) return '';
      const d = new Date(dateStr);
      return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric', hour: 'numeric', minute: '2-digit' });
    }

    function daysSince(dateStr) {
      if (!dateStr) return null;
      const d = new Date(dateStr);
      const now = new Date();
      return Math.floor((now - d) / (1000 * 60 * 60 * 24));
    }

    function getBadgeClass(p) {
      if (p.status === 'signed') return 'signed';
      if (p.status === 'closed') return 'closed';
      if (p.priority === 'hot') return 'hot';
      if (p.priority === 'warm') return 'warm';
      return 'new';
    }

    function getBadgeLabel(p) {
      if (p.status === 'signed') return '‚úÖ Signed';
      if (p.status === 'closed') return '‚õî Closed';
      if (p.priority === 'hot') return 'üî• Hot';
      if (p.priority === 'warm') return 'üü° Warm';
      return 'üÜï New';
    }

    function getScoreClass(score) {
      if (score >= 70) return 'score-high';
      if (score >= 40) return 'score-med';
      return 'score-low';
    }

    function countTouches() {
      if (!prospect.activities) return 0;
      const touchTypes = ['call', 'phone', 'pop_in', 'pop-in', 'email', 'meeting', 'visit', 'proposal', 'thank_you', 'outreach'];
      return prospect.activities.filter(a => touchTypes.includes((a.type || '').toLowerCase())).length;
    }

    function getRecommendedNextAction() {
      const activities = prospect.activities || [];
      if (activities.length === 0) return { action: 'üö∂ Schedule pop-in visit', reason: 'No activities yet ‚Äî start the 8-10 touch journey' };
      
      const recent = activities.slice(0, 5);
      const lastType = recent[0]?.type?.toLowerCase();
      const daysSinceLastActivity = daysSince(recent[0]?.created_at) || 0;
      const touchCount = countTouches();

      if (touchCount < 3 && lastType !== 'pop-in' && lastType !== 'pop_in') {
        return { action: 'üö∂ Pop-in with gift basket', reason: 'Early stage ‚Äî pop-ins build relationships fast' };
      }
      if (lastType === 'pop-in' || lastType === 'pop_in') {
        return { action: '‚úâÔ∏è Send follow-up email', reason: 'Follow up pop-in within 3 days to stay top of mind' };
      }
      if (lastType === 'email' && daysSinceLastActivity >= 3) {
        return { action: 'üìû Follow-up call', reason: 'Email sent, time for a personal call' };
      }
      if (touchCount >= 6 && touchCount < 8) {
        return { action: 'üìù Send proposal', reason: 'Near the close ‚Äî present formal proposal' };
      }
      if (daysSinceLastActivity > 7) {
        return { action: 'üìû Check-in call', reason: `${daysSinceLastActivity} days since last activity ‚Äî re-engage` };
      }
      return { action: 'üö∂ Another pop-in', reason: '8-10 touches to close ‚Äî keep the momentum' };
    }

    function render() {
      const contacts = prospect.contacts || [];
      const activities = (prospect.activities || []).sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
      const primaryContact = contacts.find(c => c.is_primary) || contacts[0];
      const touchCount = countTouches();
      const qualScore = pipelineCard?.qualification_score || calculateScore();
      const recommendation = getRecommendedNextAction();
      const daysAdded = daysSince(prospect.created_at);
      const lastActivityDate = activities[0]?.created_at;
      const daysLastActivity = daysSince(lastActivityDate);
      const currentStage = pipelineCard?.stage || 'new_lead';
      const currentStageObj = PIPELINE_STAGES.find(s => s.id === currentStage) || PIPELINE_STAGES[0];
      const daysInStage = pipelineCard ? daysSince(pipelineCard.entered_stage_at) : daysAdded;

      document.getElementById('app').innerHTML = `
        <!-- Header -->
        <div class="header">
          <div class="header-left">
            <div class="breadcrumb"><a href="/crm">‚Üê Back to CRM</a> / Prospect Detail</div>
            <h1 class="property-name">
              ${esc(prospect.name)}
              <span class="badge badge-${getBadgeClass(prospect)}">${getBadgeLabel(prospect)}</span>
              <div class="score-circle ${getScoreClass(qualScore)}" title="Qualification Score">${qualScore}</div>
            </h1>
            <div class="property-meta">
              ${prospect.property_type ? `<span>üè¢ ${esc(prospect.property_type)}</span>` : ''}
              ${prospect.units ? `<span>üìä ${esc(prospect.units)} units</span>` : ''}
              ${prospect.address ? `<span>üìç <a href="https://maps.google.com/?q=${encodeURIComponent(prospect.address)}" target="_blank">${esc(prospect.address)}</a></span>` : ''}
            </div>
          </div>
          <div class="quick-actions">
            ${primaryContact?.phone ? `<a href="tel:${primaryContact.phone}" class="action-btn">üìû Call</a>` : ''}
            ${primaryContact?.email ? `<a href="mailto:${primaryContact.email}" class="action-btn">‚úâÔ∏è Email</a>` : ''}
            <button class="action-btn" onclick="openAddActivity()">üìù Log Activity</button>
            <a href="/gift-baskets?prospect_id=${prospectId}" class="action-btn">üéÅ Gift Basket</a>
            <a href="/proposal-generator?prospect_id=${prospectId}" class="action-btn primary">üìÑ Proposal</a>
          </div>
        </div>

        <!-- Quick Stats -->
        <div class="stats-row">
          <div class="stat-box">
            <div class="stat-value accent">${touchCount}</div>
            <div class="stat-label">Total Touches</div>
          </div>
          <div class="stat-box">
            <div class="stat-value ${daysLastActivity > 7 ? 'warn' : ''}">${daysLastActivity !== null ? daysLastActivity : '‚Äî'}</div>
            <div class="stat-label">Days Since Activity</div>
          </div>
          <div class="stat-box">
            <div class="stat-value">${activities.length}</div>
            <div class="stat-label">Total Activities</div>
          </div>
          <div class="stat-box">
            <div class="stat-value">${daysAdded || 0}</div>
            <div class="stat-label">Days Since Added</div>
          </div>
          <div class="stat-box">
            <div class="stat-value success">${giftBaskets.filter(b => b.status === 'delivered').length}</div>
            <div class="stat-label">Gift Baskets Sent</div>
          </div>
          <div class="stat-box">
            <div class="stat-value">${proposals.length}</div>
            <div class="stat-label">Proposals</div>
          </div>
        </div>

        <div class="main-grid">
          <!-- Left Column -->
          <div class="left-col">
            <!-- Touch Counter & Progress -->
            <div class="card" style="margin-bottom: 24px;">
              <div class="card-header">
                <div class="card-title">üéØ Touch Progress</div>
                <span style="font-size: 0.85rem; color: var(--muted);">8-10 touches to close</span>
              </div>
              <div class="card-body">
                <div class="touch-counter">
                  <div class="touch-header">
                    <span class="touch-count">${touchCount}<span style="font-size: 1rem; color: var(--muted);"> / 10</span></span>
                    <span class="touch-target">${touchCount >= 8 ? '‚úÖ Ready to close!' : `${10 - touchCount} more touches needed`}</span>
                  </div>
                  <div class="touch-bar">
                    <div class="touch-fill" style="width: ${Math.min(100, (touchCount / 10) * 100)}%;"></div>
                  </div>
                </div>
                <div class="touch-recommendation">
                  <strong>üí° Recommended:</strong> ${recommendation.action}<br>
                  <span style="color: var(--muted); font-size: 0.85rem;">${recommendation.reason}</span>
                </div>
              </div>
            </div>

            <!-- Pipeline Progression -->
            <div class="card" style="margin-bottom: 24px;">
              <div class="card-header">
                <div class="card-title">üìä Pipeline Stage</div>
              </div>
              <div class="card-body">
                <div class="pipeline-bar">
                  ${PIPELINE_STAGES.slice(0, 9).map(s => `
                    <div class="pipeline-stage ${s.order < currentStageObj.order ? 'completed' : ''} ${s.id === currentStage ? 'current' : ''}" 
                         title="${s.emoji} ${s.label}"></div>
                  `).join('')}
                </div>
                <div class="stage-info">
                  <div>
                    <span class="current-stage">${currentStageObj.emoji} ${currentStageObj.label}</span>
                  </div>
                  <div class="days-in-stage">${daysInStage || 0} days in this stage</div>
                </div>
                ${renderStageHistory()}
              </div>
            </div>

            <!-- Activity Timeline -->
            <div class="card" style="margin-bottom: 24px;">
              <div class="card-header">
                <div class="card-title">üìÖ Activity Timeline</div>
                <button class="action-btn" style="padding: 6px 12px; font-size: 0.85rem;" onclick="openAddActivity()">+ Add</button>
              </div>
              <div class="card-body ${activities.length === 0 ? '' : 'no-pad'}" style="${activities.length > 0 ? 'padding: 20px;' : ''}">
                ${activities.length === 0 ? `
                  <div class="empty-state">
                    <div class="empty-state-icon">üìù</div>
                    <div>No activities yet ‚Äî log your first pop-in!</div>
                  </div>
                ` : `
                  <div class="timeline">
                    ${activities.slice(0, 20).map(a => `
                      <div class="timeline-item">
                        <div class="timeline-dot ${(a.type || '').toLowerCase().replace(/ /g, '-')}"></div>
                        <div class="timeline-header">
                          <span class="timeline-type">${getActivityIcon(a.type)} ${formatActivityType(a.type)}</span>
                          <span class="timeline-date">${formatDateTime(a.created_at)}</span>
                        </div>
                        <div class="timeline-desc">${esc(a.description || 'No description')}</div>
                        ${a.outcome ? `<div class="timeline-outcome">Outcome: ${formatOutcome(a.outcome)}</div>` : ''}
                        ${a.next_action ? `<div style="margin-top: 6px; font-size: 0.85rem; color: var(--accent);">‚Üí Next: ${esc(a.next_action)}</div>` : ''}
                      </div>
                    `).join('')}
                  </div>
                  ${activities.length > 20 ? `<div style="padding: 16px; text-align: center; color: var(--muted); font-size: 0.9rem;">+ ${activities.length - 20} more activities</div>` : ''}
                `}
              </div>
              ${renderAddActivityForm()}
            </div>
          </div>

          <!-- Right Column (Sidebar) -->
          <div class="right-col">
            <!-- Contacts -->
            <div class="card" style="margin-bottom: 20px;">
              <div class="card-header">
                <div class="card-title">üë§ Contacts</div>
                <button class="action-btn" style="padding: 4px 10px; font-size: 0.8rem;" onclick="openAddContact()">+ Add</button>
              </div>
              <div class="card-body">
                ${contacts.length === 0 ? `
                  <div class="empty-state">
                    <div class="empty-state-icon">üë§</div>
                    <div>No contacts yet</div>
                  </div>
                ` : `
                  <div class="contact-list">
                    ${contacts.map(c => `
                      <div class="contact-card ${c.is_primary ? 'primary' : ''}">
                        <div class="contact-name">
                          ${c.is_primary ? '‚≠ê ' : ''}${esc(c.name)}
                        </div>
                        ${c.role ? `<div class="contact-role">${esc(c.role)}</div>` : ''}
                        <div class="contact-links">
                          ${c.phone ? `<a href="tel:${c.phone}" class="contact-link">üìû ${esc(c.phone)}</a>` : ''}
                          ${c.email ? `<a href="mailto:${c.email}" class="contact-link">‚úâÔ∏è ${esc(c.email)}</a>` : ''}
                        </div>
                      </div>
                    `).join('')}
                  </div>
                `}
              </div>
            </div>

            <!-- Notes -->
            <div class="card" style="margin-bottom: 20px;">
              <div class="card-header">
                <div class="card-title">üìù Notes</div>
              </div>
              <div class="card-body">
                <div class="notes-section">
                  <label class="notes-label sales">üíº Sales Notes</label>
                  <textarea class="notes-textarea" id="salesNotes" placeholder="Notes visible to sales team..."
                    onkeyup="autoSaveNotes('notes')">${esc(prospect.notes || '')}</textarea>
                  <div class="auto-save-indicator" id="salesSaveIndicator">‚úì Saved</div>
                </div>
                <div class="notes-section">
                  <label class="notes-label internal">üîí Internal Notes</label>
                  <textarea class="notes-textarea" id="internalNotes" placeholder="Private notes (Kurtis only)..."
                    onkeyup="autoSaveNotes('kurtis_notes')">${esc(prospect.kurtis_notes || '')}</textarea>
                  <div class="auto-save-indicator" id="internalSaveIndicator">‚úì Saved</div>
                </div>
              </div>
            </div>

            <!-- Tasks -->
            <div class="card" style="margin-bottom: 20px;">
              <div class="card-header">
                <div class="card-title">‚úÖ Tasks</div>
                <span style="font-size: 0.85rem; color: var(--muted);">${tasks.filter(t => !t.completed).length} open</span>
              </div>
              <div class="card-body no-pad">
                ${tasks.length === 0 ? `
                  <div class="empty-state" style="padding: 20px;">
                    <div>No tasks</div>
                  </div>
                ` : `
                  ${tasks.slice(0, 8).map(t => {
                    const isOverdue = !t.completed && t.due_date && t.due_date < new Date().toISOString().split('T')[0];
                    return `
                      <div class="task-item">
                        <div class="task-checkbox ${t.completed ? 'completed' : ''}" onclick="toggleTask(${t.id})"></div>
                        <div class="task-content">
                          <div class="task-title ${t.completed ? 'completed' : ''}">${esc(t.title)}</div>
                          ${t.due_date ? `<div class="task-due ${isOverdue ? 'overdue' : ''}">${isOverdue ? '‚ö†Ô∏è Overdue: ' : ''}${formatDate(t.due_date)}</div>` : ''}
                        </div>
                      </div>
                    `;
                  }).join('')}
                `}
              </div>
            </div>

            <!-- Gift Baskets -->
            <div class="card" style="margin-bottom: 20px;">
              <div class="card-header">
                <div class="card-title">üéÅ Gift Baskets</div>
                <a href="/gift-baskets?prospect_id=${prospectId}" style="font-size: 0.85rem; color: var(--accent);">View All</a>
              </div>
              <div class="card-body no-pad">
                ${giftBaskets.length === 0 ? `
                  <div class="empty-state" style="padding: 20px;">
                    <div>No gift baskets yet</div>
                    <a href="/gift-baskets?prospect_id=${prospectId}" style="color: var(--accent); font-size: 0.9rem;">+ Plan one</a>
                  </div>
                ` : `
                  ${giftBaskets.slice(0, 5).map(b => `
                    <div class="related-item">
                      <div class="related-main">
                        <div class="related-title">${esc(b.name || 'Gift Basket')}</div>
                        <div class="related-meta">${formatDate(b.delivered_at || b.planned_date || b.created_at)}</div>
                      </div>
                      <span class="related-status status-${b.status}">${b.status}</span>
                    </div>
                  `).join('')}
                `}
              </div>
            </div>

            <!-- Proposals -->
            <div class="card" style="margin-bottom: 20px;">
              <div class="card-header">
                <div class="card-title">üìÑ Proposals</div>
              </div>
              <div class="card-body no-pad">
                ${proposals.length === 0 ? `
                  <div class="empty-state" style="padding: 20px;">
                    <div>No proposals yet</div>
                    <a href="/proposal-generator?prospect_id=${prospectId}" style="color: var(--accent); font-size: 0.9rem;">+ Generate one</a>
                  </div>
                ` : `
                  ${proposals.map(p => `
                    <div class="related-item">
                      <div class="related-main">
                        <div class="related-title">${esc(p.proposal_number || 'Proposal')}</div>
                        <div class="related-meta">${p.machine_count || '?'} machines ‚Ä¢ ${p.revenue_share || '?'}% share ‚Ä¢ ${formatDate(p.created_at)}</div>
                      </div>
                      <span class="related-status status-sent">Sent</span>
                    </div>
                  `).join('')}
                `}
              </div>
            </div>

            <!-- Contract -->
            ${contracts.length > 0 ? `
              <div class="card">
                <div class="card-header">
                  <div class="card-title">üìë Contract</div>
                </div>
                <div class="card-body no-pad">
                  ${contracts.map(c => `
                    <div class="related-item">
                      <div class="related-main">
                        <div class="related-title">${c.revenue_share_percent || '?'}% Revenue Share</div>
                        <div class="related-meta">
                          ${formatDate(c.start_date)} ‚Äî ${formatDate(c.end_date)}
                          ${c.monthly_revenue ? ` ‚Ä¢ $${c.monthly_revenue}/mo` : ''}
                        </div>
                      </div>
                      <span class="related-status status-delivered">Active</span>
                    </div>
                  `).join('')}
                </div>
              </div>
            ` : ''}
          </div>
        </div>
      `;
    }

    function calculateScore() {
      let score = 0;
      const units = parseInt(prospect.units) || 0;
      if (units >= 200) score += 30;
      else if (units >= 100) score += 20;
      else if (units >= 50) score += 10;
      if (prospect.property_type) {
        const pt = prospect.property_type.toLowerCase();
        if (pt.includes('apartment') || pt.includes('senior') || pt.includes('industrial')) score += 20;
        else if (pt.includes('office') || pt.includes('healthcare')) score += 15;
      }
      if (countTouches() >= 5) score += 15;
      if (prospect.status === 'signed') score += 25;
      else if (prospect.priority === 'hot') score += 10;
      return Math.min(100, score);
    }

    function renderStageHistory() {
      // Look for pipeline_move activities
      const moves = (prospect.activities || [])
        .filter(a => a.type === 'pipeline_move')
        .slice(0, 5);
      
      if (moves.length === 0) return '';
      
      return `
        <div class="stage-history">
          <div style="font-size: 0.85rem; font-weight: 600; color: var(--muted); margin-bottom: 8px;">Stage History</div>
          ${moves.map(m => `
            <div class="stage-history-item">
              <span class="stage-history-date">${formatDate(m.created_at)}</span>
              <span>${esc(m.description)}</span>
            </div>
          `).join('')}
        </div>
      `;
    }

    function getActivityIcon(type) {
      const icons = {
        'call': 'üìû', 'phone': 'üìû', 'pop-in': 'üö∂', 'pop_in': 'üö∂',
        'email': '‚úâÔ∏è', 'proposal': 'üìÑ', 'meeting': 'ü§ù',
        'gift_basket': 'üéÅ', 'gift': 'üéÅ', 'visit': 'üö∂',
        'status-change': 'üîÑ', 'pipeline_move': 'üìä', 'thank_you': 'üíå',
        'outreach': 'üì£', 'site_survey': 'üìã'
      };
      return icons[(type || '').toLowerCase()] || 'üìù';
    }

    function formatActivityType(type) {
      const labels = {
        'pop-in': 'Pop-In', 'pop_in': 'Pop-In', 'call': 'Call', 'phone': 'Phone Call',
        'email': 'Email', 'proposal': 'Proposal', 'meeting': 'Meeting',
        'gift_basket': 'Gift Basket', 'pipeline_move': 'Stage Change',
        'status-change': 'Status Change', 'thank_you': 'Thank You Card'
      };
      return labels[(type || '').toLowerCase()] || type;
    }

    function formatOutcome(outcome) {
      const labels = {
        'interested': 'üëç Interested', 'thinking': 'ü§î Thinking', 'not_available': 'üìµ Not Available',
        'not_interested': 'üëé Not Interested', 'left_info': 'üìã Left Info'
      };
      return labels[outcome] || outcome;
    }

    function renderAddActivityForm() {
      return `
        <div class="add-activity-form" id="addActivityForm" style="display: none;">
          <div style="font-weight: 600; margin-bottom: 12px;">Log New Activity</div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Type</label>
              <select class="form-select" id="activityType">
                <option value="pop-in">üö∂ Pop-In</option>
                <option value="call">üìû Call</option>
                <option value="email">‚úâÔ∏è Email</option>
                <option value="meeting">ü§ù Meeting</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Date</label>
              <input type="date" class="form-input" id="activityDate" value="${new Date().toISOString().split('T')[0]}">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">What happened?</label>
            <textarea class="form-textarea" id="activityDesc" placeholder="Describe the activity..."></textarea>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Outcome</label>
              <select class="form-select" id="activityOutcome">
                <option value="">Select...</option>
                <option value="interested">Interested</option>
                <option value="thinking">Thinking about it</option>
                <option value="not_available">Not available</option>
                <option value="left_info">Left information</option>
                <option value="not_interested">Not interested</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Next Action</label>
              <input type="text" class="form-input" id="nextAction" placeholder="e.g., Follow up call">
            </div>
          </div>
          <div style="display: flex; gap: 12px; justify-content: flex-end;">
            <button class="action-btn" onclick="closeAddActivity()">Cancel</button>
            <button class="action-btn primary" onclick="saveActivity()">Save Activity</button>
          </div>
        </div>
      `;
    }

    function openAddActivity() {
      document.getElementById('addActivityForm').style.display = 'block';
    }

    function closeAddActivity() {
      document.getElementById('addActivityForm').style.display = 'none';
    }

    async function saveActivity() {
      const type = document.getElementById('activityType').value;
      const date = document.getElementById('activityDate').value;
      const description = document.getElementById('activityDesc').value;
      const outcome = document.getElementById('activityOutcome').value;
      const nextAction = document.getElementById('nextAction').value;

      if (!description.trim()) {
        alert('Please enter a description');
        return;
      }

      try {
        await fetch(`/api/prospects/${prospectId}/activities`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            type,
            description,
            outcome: outcome || null,
            next_action: nextAction || null,
            created_at: date ? new Date(date + 'T12:00:00').toISOString() : undefined
          })
        });
        closeAddActivity();
        loadData(); // Refresh
      } catch (err) {
        alert('Error saving activity: ' + err.message);
      }
    }

    function openAddContact() {
      const name = prompt('Contact name:');
      if (!name) return;
      const role = prompt('Role/Title:');
      const phone = prompt('Phone number:');
      const email = prompt('Email:');
      
      saveContact({ name, role, phone, email });
    }

    async function saveContact(contact) {
      try {
        await fetch(`/api/prospects/${prospectId}/contacts`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(contact)
        });
        loadData();
      } catch (err) {
        alert('Error saving contact: ' + err.message);
      }
    }

    async function toggleTask(taskId) {
      try {
        const task = tasks.find(t => t.id === taskId);
        await fetch(`/api/crm-tasks/${taskId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ completed: !task.completed, completed_at: task.completed ? null : new Date().toISOString() })
        });
        loadData();
      } catch (err) {
        console.error('Error toggling task:', err);
      }
    }

    function autoSaveNotes(field) {
      clearTimeout(saveTimer);
      saveTimer = setTimeout(() => {
        const value = field === 'notes' 
          ? document.getElementById('salesNotes').value 
          : document.getElementById('internalNotes').value;
        
        fetch(`/api/prospects/${prospectId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ [field]: value })
        }).then(() => {
          const indicator = field === 'notes' ? 'salesSaveIndicator' : 'internalSaveIndicator';
          const el = document.getElementById(indicator);
          el.classList.add('show');
          setTimeout(() => el.classList.remove('show'), 2000);
        });
      }, 1000);
    }

    // Initialize
    loadData();
  </script>
</body>
</html>
