<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kande AI Agent Team â€” Command Center</title>
<style>
  *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
  :root{
    --bg:#0b0e14;--surface:#131720;--card:#1a1f2e;--card-hover:#1e2438;
    --border:#2a3041;--text:#e2e8f0;--text-dim:#8896ab;--text-muted:#5a6578;
    --accent:#6366f1;--green:#22c55e;--red:#ef4444;--amber:#f59e0b;
    --purple:#8b5cf6;--blue:#3b82f6;--pink:#ec4899;
    --radius:12px;--radius-sm:8px;
  }
  body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);line-height:1.5;min-height:100vh}
  
  /* Layout */
  .app{display:grid;grid-template-columns:1fr 360px;grid-template-rows:auto auto 1fr auto;min-height:100vh}
  .header{grid-column:1/-1;padding:20px 32px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);background:var(--surface)}
  .metrics-bar{grid-column:1/-1;padding:16px 32px;display:flex;gap:16px;border-bottom:1px solid var(--border);background:var(--surface)}
  .main{padding:28px 32px;overflow-y:auto;max-height:calc(100vh - 200px)}
  .sidebar{border-left:1px solid var(--border);background:var(--surface);display:flex;flex-direction:column;overflow:hidden;max-height:calc(100vh - 200px)}
  .footer{grid-column:1/-1;padding:16px 32px;border-top:1px solid var(--border);background:var(--surface)}

  /* Header */
  .header-left{display:flex;align-items:center;gap:16px}
  .header-title{font-size:22px;font-weight:700;letter-spacing:-0.3px}
  .header-subtitle{font-size:13px;color:var(--text-dim);text-transform:uppercase;letter-spacing:1.5px;margin-top:2px}
  .status-badge{display:inline-flex;align-items:center;gap:8px;background:#16a34a18;border:1px solid #16a34a40;padding:6px 16px;border-radius:20px;font-size:12px;font-weight:600;color:var(--green);letter-spacing:0.8px;text-transform:uppercase}
  .status-badge .dot{width:8px;height:8px;border-radius:50%;background:var(--green);animation:pulse-dot 2s ease-in-out infinite}
  .header-right{display:flex;align-items:center;gap:16px}
  .header-time{font-size:13px;color:var(--text-dim);font-variant-numeric:tabular-nums}

  /* View Toggle */
  .view-toggle{display:flex;gap:4px;background:var(--bg);border-radius:24px;padding:3px;border:1px solid var(--border)}
  .view-toggle-btn{padding:6px 18px;border-radius:20px;border:2px solid transparent;background:transparent;color:var(--text-dim);font-size:13px;font-weight:600;cursor:pointer;transition:all 0.25s;font-family:inherit;white-space:nowrap}
  .view-toggle-btn:hover{color:var(--text);background:var(--card)}
  .view-toggle-btn.active{background:var(--card);color:var(--text);border-color:var(--accent);box-shadow:0 0 12px -3px var(--accent)}

  /* Metrics */
  .metric-card{flex:1;background:var(--card);border:1px solid var(--border);border-radius:var(--radius-sm);padding:14px 18px;display:flex;flex-direction:column;gap:4px}
  .metric-label{font-size:11px;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);font-weight:600}
  .metric-value{font-size:28px;font-weight:700;font-variant-numeric:tabular-nums}
  .metric-value.green{color:var(--green)}.metric-value.blue{color:var(--blue)}.metric-value.amber{color:var(--amber)}.metric-value.purple{color:var(--purple)}

  /* Team Groups */
  .team-groups{display:flex;flex-direction:column;gap:20px}
  .team-group{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden}
  .team-group-header{padding:14px 20px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border)}
  .team-group-name{font-size:14px;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:var(--text-dim)}
  .team-group-count{font-size:12px;color:var(--text-muted);background:var(--card);padding:2px 10px;border-radius:10px}
  .team-group-agents{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:1px;background:var(--border)}

  /* Agent Cards */
  .agent-card{background:var(--card);padding:16px 20px;cursor:pointer;transition:background 0.2s,box-shadow 0.3s;position:relative;overflow:hidden}
  .agent-card:hover{background:var(--card-hover)}
  .agent-card.running{animation:glow-pulse 3s ease-in-out infinite}
  .agent-card.expanded .agent-expand{display:block}
  .agent-top{display:flex;align-items:flex-start;gap:12px}
  .agent-dot{width:10px;height:10px;border-radius:50%;margin-top:5px;flex-shrink:0;transition:background 0.3s}
  .agent-dot.active{background:var(--green);box-shadow:0 0 8px var(--green)}
  .agent-dot.idle{background:var(--text-muted)}
  .agent-dot.meeting{background:var(--amber);box-shadow:0 0 8px var(--amber);animation:pulse-dot 1.5s ease-in-out infinite}
  .agent-info{flex:1;min-width:0}
  .agent-name-row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .agent-name{font-size:15px;font-weight:700}
  .agent-role{font-size:12px;color:var(--text-dim)}
  .agent-model{font-size:11px;font-family:'SF Mono',Monaco,'Cascadia Code',monospace;color:var(--text-muted);background:var(--bg);padding:2px 8px;border-radius:4px;margin-top:4px;display:inline-block}
  .agent-activity{font-size:13px;color:var(--text-dim);margin-top:8px;line-height:1.4;display:flex;align-items:flex-start;gap:6px}
  .agent-activity .activity-icon{flex-shrink:0;margin-top:1px}
  .meeting-badge{display:inline-flex;align-items:center;gap:4px;font-size:11px;background:#f59e0b20;color:var(--amber);border:1px solid #f59e0b40;padding:2px 8px;border-radius:4px;font-weight:600;margin-left:auto}
  .agent-expand{display:none;margin-top:12px;padding-top:12px;border-top:1px solid var(--border);font-size:13px;color:var(--text-dim);line-height:1.6;max-height:150px;overflow-y:auto}
  .agent-expand pre{font-family:'SF Mono',Monaco,monospace;font-size:12px;white-space:pre-wrap;word-break:break-word;color:var(--text-muted);background:var(--bg);padding:10px;border-radius:6px;margin-top:6px}
  .agent-color-bar{position:absolute;left:0;top:0;bottom:0;width:3px}

  /* Sidebar */
  .sidebar-header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
  .sidebar-title{font-size:14px;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:var(--text-dim)}
  .sidebar-live{display:flex;align-items:center;gap:6px;font-size:11px;color:var(--green);font-weight:600}
  .sidebar-live .dot{width:6px;height:6px;border-radius:50%;background:var(--green);animation:pulse-dot 2s ease-in-out infinite}
  .activity-feed{flex:1;overflow-y:auto;padding:8px 0}
  .activity-item{padding:10px 20px;border-bottom:1px solid var(--border);transition:background 0.2s}
  .activity-item:hover{background:var(--card)}
  .activity-item.new{animation:fade-in 0.4s ease}
  .activity-time{font-size:11px;color:var(--text-muted);font-variant-numeric:tabular-nums;font-family:'SF Mono',Monaco,monospace}
  .activity-agent{font-size:12px;font-weight:600;margin-top:2px}
  .activity-text{font-size:13px;color:var(--text-dim);margin-top:2px;line-height:1.4}
  .activity-empty{padding:40px 20px;text-align:center;color:var(--text-muted);font-size:13px}

  /* Footer / Schedule */
  .footer-title{font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:var(--text-muted);margin-bottom:10px}
  .schedule-items{display:flex;gap:16px;overflow-x:auto;padding-bottom:4px}
  .schedule-item{display:flex;align-items:center;gap:10px;background:var(--card);border:1px solid var(--border);border-radius:var(--radius-sm);padding:10px 16px;white-space:nowrap;min-width:200px}
  .schedule-time{font-size:12px;font-weight:700;color:var(--accent);font-variant-numeric:tabular-nums}
  .schedule-label{font-size:13px;color:var(--text-dim)}
  .schedule-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}

  /* Office View */
  .view-container{display:none}
  .view-container.active{display:block}
  #office-view{padding:0;position:relative}
  #office-canvas{display:block;width:100%;height:100%;background:#0f1117}

  /* Animations */
  @keyframes pulse-dot{0%,100%{opacity:1}50%{opacity:0.4}}
  @keyframes glow-pulse{0%,100%{box-shadow:inset 0 0 0 1px transparent}50%{box-shadow:inset 0 0 0 1px var(--glow-color,var(--accent)),0 0 20px -5px var(--glow-color,var(--accent))}}
  @keyframes fade-in{from{opacity:0;transform:translateY(-8px)}to{opacity:1;transform:translateY(0)}}

  /* Scrollbar */
  ::-webkit-scrollbar{width:6px}
  ::-webkit-scrollbar-track{background:transparent}
  ::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
  ::-webkit-scrollbar-thumb:hover{background:var(--text-muted)}

  /* Responsive */
  @media(max-width:900px){
    .app{grid-template-columns:1fr;grid-template-rows:auto auto 1fr auto auto}
    .sidebar{max-height:350px;border-left:none;border-top:1px solid var(--border)}
    .metrics-bar{flex-wrap:wrap}
    .metric-card{min-width:140px}
    .team-group-agents{grid-template-columns:1fr}
  }
</style>
</head>
<body>

<div class="app">
  <!-- Header -->
  <header class="header">
    <div class="header-left">
      <div>
        <div class="header-title">ğŸ¢ Kande AI Agent Team</div>
        <div class="header-subtitle">Command Center</div>
      </div>
      <div class="view-toggle">
        <button class="view-toggle-btn active" data-view="dashboard" onclick="switchView('dashboard')">ğŸ“Š Dashboard</button>
        <button class="view-toggle-btn" data-view="office" onclick="switchView('office')">ğŸ¢ Office</button>
      </div>
    </div>
    <div class="header-right">
      <div class="status-badge"><span class="dot"></span> Operational</div>
      <div class="header-time" id="clock"></div>
    </div>
  </header>

  <!-- Metrics Bar -->
  <div class="metrics-bar">
    <div class="metric-card">
      <div class="metric-label">Runs Today</div>
      <div class="metric-value green" id="m-runs">â€”</div>
    </div>
    <div class="metric-card">
      <div class="metric-label">Leads Found</div>
      <div class="metric-value blue" id="m-leads">â€”</div>
    </div>
    <div class="metric-card">
      <div class="metric-label">Emails Drafted</div>
      <div class="metric-value amber" id="m-emails">â€”</div>
    </div>
    <div class="metric-card">
      <div class="metric-label">Features Shipped</div>
      <div class="metric-value purple" id="m-features">â€”</div>
    </div>
  </div>

  <!-- Main Content: Dashboard View -->
  <main class="main">
    <div id="dashboard-view" class="view-container active">
      <div class="team-groups" id="team-groups"></div>
    </div>
    <div id="office-view" class="view-container">
      <canvas id="office-canvas"></canvas>
    </div>
  </main>

  <!-- Activity Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-title">Activity Feed</div>
      <div class="sidebar-live"><span class="dot"></span> Live</div>
    </div>
    <div class="activity-feed" id="activity-feed">
      <div class="activity-empty">Connecting to activity feedâ€¦</div>
    </div>
  </aside>

  <!-- Footer / Schedule -->
  <footer class="footer">
    <div class="footer-title">ğŸ“… Upcoming Schedule</div>
    <div class="schedule-items" id="schedule-items">
      <div class="schedule-item">
        <div class="schedule-dot" style="background:var(--purple)"></div>
        <div class="schedule-time">09:00</div>
        <div class="schedule-label">Morning Standup</div>
      </div>
      <div class="schedule-item">
        <div class="schedule-dot" style="background:var(--blue)"></div>
        <div class="schedule-time">11:00</div>
        <div class="schedule-label">Scout Research Sprint</div>
      </div>
      <div class="schedule-item">
        <div class="schedule-dot" style="background:var(--green)"></div>
        <div class="schedule-time">14:00</div>
        <div class="schedule-label">Sales Pipeline Review</div>
      </div>
      <div class="schedule-item">
        <div class="schedule-dot" style="background:var(--pink)"></div>
        <div class="schedule-time">16:00</div>
        <div class="schedule-label">Ops Check-in</div>
      </div>
    </div>
  </footer>
</div>

<script>
// â”€â”€ Agent Definitions â”€â”€
const TEAMS = [
  {
    name: 'Leadership',
    agents: [
      { id:'kurtis', name:'Kurtis', role:'CEO', model:'Human', color:'#f59e0b' },
      { id:'clawd',  name:'Clawd',  role:'Chief of Staff', model:'claude-opus-4-6', color:'#8b5cf6' },
    ]
  },
  {
    name: 'Research Team',
    agents: [
      { id:'scout', name:'Scout', role:'Research Agent', model:'claude-sonnet-4', color:'#3b82f6' },
    ]
  },
  {
    name: 'Sales Team',
    agents: [
      { id:'relay', name:'Relay', role:'Sales Ops Agent', model:'claude-sonnet-4', color:'#22c55e' },
    ]
  },
  {
    name: 'Engineering Team',
    agents: [
      { id:'ralph', name:'Ralph', role:'Engineering Agent', model:'claude-sonnet-4', color:'#f59e0b' },
    ]
  },
  {
    name: 'Operations Team',
    agents: [
      { id:'mary', name:'Mary', role:'PB Ops Agent', model:'claude-sonnet-4', color:'#ec4899' },
    ]
  },
];

// â”€â”€ State â”€â”€
let agentStates = {};
let activityItems = [];
let expandedAgent = null;
let currentView = localStorage.getItem('teamView') || 'dashboard';

// â”€â”€ Initialize defaults â”€â”€
TEAMS.forEach(t => t.agents.forEach(a => {
  agentStates[a.id] = { status:'idle', activity:'Waiting for tasksâ€¦', inMeeting:false, recentOutput:'' };
}));

// â”€â”€ View Toggle â”€â”€
function switchView(view) {
  currentView = view;
  localStorage.setItem('teamView', view);
  document.querySelectorAll('.view-toggle-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.view === view);
  });
  document.querySelectorAll('.view-container').forEach(el => el.classList.remove('active'));
  document.getElementById(view + '-view').classList.add('active');
  if (view === 'office') {
    resizeOfficeCanvas();
  }
}

// Restore saved view
if (currentView !== 'dashboard') {
  requestAnimationFrame(() => switchView(currentView));
}

// â”€â”€ Clock â”€â”€
function updateClock() {
  const now = new Date();
  document.getElementById('clock').textContent = now.toLocaleString('en-US', {
    weekday:'short', month:'short', day:'numeric',
    hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:true
  });
}
setInterval(updateClock, 1000);
updateClock();

// â”€â”€ Render Teams â”€â”€
function renderTeams() {
  const container = document.getElementById('team-groups');
  container.innerHTML = TEAMS.map(team => {
    const totalAgents = team.agents.length;
    const activeCount = team.agents.filter(a => agentStates[a.id]?.status === 'active' || agentStates[a.id]?.status === 'running').length;
    return `
      <div class="team-group">
        <div class="team-group-header">
          <div class="team-group-name">${team.name}</div>
          <div class="team-group-count">${activeCount}/${totalAgents} active</div>
        </div>
        <div class="team-group-agents">
          ${team.agents.map(a => renderAgentCard(a)).join('')}
        </div>
      </div>
    `;
  }).join('');

  container.querySelectorAll('.agent-card').forEach(card => {
    card.addEventListener('click', () => {
      const id = card.dataset.agentId;
      if (expandedAgent === id) {
        expandedAgent = null;
        card.classList.remove('expanded');
      } else {
        container.querySelectorAll('.agent-card.expanded').forEach(c => c.classList.remove('expanded'));
        expandedAgent = id;
        card.classList.add('expanded');
      }
    });
  });
}

function renderAgentCard(agent) {
  const state = agentStates[agent.id] || {};
  const isActive = state.status === 'active' || state.status === 'running';
  const isRunning = state.status === 'running';
  const inMeeting = state.inMeeting;
  const dotClass = inMeeting ? 'meeting' : (isActive ? 'active' : 'idle');
  const isExpanded = expandedAgent === agent.id;

  return `
    <div class="agent-card ${isRunning ? 'running' : ''} ${isExpanded ? 'expanded' : ''}"
         data-agent-id="${agent.id}"
         style="--glow-color:${agent.color}">
      <div class="agent-color-bar" style="background:${agent.color}"></div>
      <div class="agent-top">
        <div class="agent-dot ${dotClass}"></div>
        <div class="agent-info">
          <div class="agent-name-row">
            <span class="agent-name" style="color:${agent.color}">${agent.name}</span>
            <span class="agent-role">${agent.role}</span>
            ${inMeeting ? '<span class="meeting-badge">ğŸ“ In Standup</span>' : ''}
          </div>
          <div class="agent-model">${agent.model}</div>
          <div class="agent-activity">
            <span class="activity-icon">${isActive ? 'âš¡' : 'ğŸ’¤'}</span>
            <span>${escapeHtml(state.activity || 'Idle')}</span>
          </div>
        </div>
      </div>
      <div class="agent-expand">
        <strong>Recent Output</strong>
        <pre>${escapeHtml(state.recentOutput || 'No recent output.')}</pre>
      </div>
    </div>
  `;
}

// â”€â”€ Render Activity Feed â”€â”€
function renderActivityFeed() {
  const feed = document.getElementById('activity-feed');
  if (!activityItems.length) {
    feed.innerHTML = '<div class="activity-empty">No activity yet.</div>';
    return;
  }
  feed.innerHTML = activityItems.slice(0, 50).map((item, i) => `
    <div class="activity-item ${i === 0 ? 'new' : ''}">
      <div class="activity-time">${item.time}</div>
      <div class="activity-agent" style="color:${getAgentColor(item.agent)}">${item.agent}</div>
      <div class="activity-text">${escapeHtml(item.text)}</div>
    </div>
  `).join('');
}

// â”€â”€ Update Metrics â”€â”€
function updateMetrics(data) {
  if (!data) return;
  if (data.runsToday != null) document.getElementById('m-runs').textContent = data.runsToday;
  if (data.leadsFound != null) document.getElementById('m-leads').textContent = data.leadsFound;
  if (data.emailsDrafted != null) document.getElementById('m-emails').textContent = data.emailsDrafted;
  if (data.featuresShipped != null) document.getElementById('m-features').textContent = data.featuresShipped;
}

// â”€â”€ API Polling â”€â”€
async function fetchTeamStatus() {
  try {
    const res = await fetch('/api/team/status');
    if (!res.ok) throw new Error(res.status);
    const data = await res.json();
    // API returns flat object: { scout: {...}, relay: {...}, metrics: {...} }
    // Map API fields (state/statusText/lastActivity) to page fields (status/activity/recentOutput)
    const knownAgents = ['kurtis','clawd','scout','relay','ralph','mary'];
    for (const id of knownAgents) {
      if (data[id]) {
        const s = data[id];
        agentStates[id] = {
          ...agentStates[id],
          status: s.state || agentStates[id]?.status || 'idle',
          activity: s.statusText || s.lastActivity || agentStates[id]?.activity || 'Idle',
          recentOutput: s.lastActivity || agentStates[id]?.recentOutput || '',
          inMeeting: s.state === 'meeting'
        };
      }
    }
    if (data.metrics) {
      updateMetrics({
        runsToday: data.metrics.totalRuns || 0,
        leadsFound: data.metrics.leadsFound || 0,
        emailsDrafted: data.metrics.emailsDrafted || 0,
        featuresShipped: data.metrics.featuresShipped || 0
      });
    }
    renderTeams();
    updateOfficeAgentStates();
  } catch (e) {
    useDemoData();
    renderTeams();
    updateOfficeAgentStates();
  }
}

async function fetchActivity() {
  try {
    const res = await fetch('/api/team/activity');
    if (!res.ok) throw new Error(res.status);
    const data = await res.json();
    // API returns { activities: [...] } with timestamp (ISO) and agent (lowercase)
    // Page expects { time, agent (capitalized), text }
    const items = data.activities || data.items || [];
    if (items.length) {
      activityItems = items.map(item => ({
        time: item.time || formatActivityTime(item.timestamp),
        agent: item.agent ? item.agent.charAt(0).toUpperCase() + item.agent.slice(1) : 'System',
        text: item.text || ''
      }));
      renderActivityFeed();
    }
  } catch (e) {
    useDemoActivity();
    renderActivityFeed();
  }
}

function formatActivityTime(iso) {
  if (!iso) return '';
  try {
    const d = new Date(iso);
    return d.toLocaleTimeString('en-US', { hour:'2-digit', minute:'2-digit', hour12:true });
  } catch { return ''; }
}

// â”€â”€ Demo Data â”€â”€
function useDemoData() {
  agentStates.kurtis = { status:'active', activity:'Reviewing daily priorities', inMeeting:false, recentOutput:'Approved Q2 sales strategy.\nSet target: 15 new vending locations by March.' };
  agentStates.clawd = { status:'running', activity:'Coordinating morning standup across all teams', inMeeting:false, recentOutput:'Standup summary: 3 agents active, 2 pending tasks.\nDeployed team.html update.\nNext: check email pipeline.' };
  agentStates.scout = { status:'running', activity:'Researching warehouse districts in North Las Vegas', inMeeting:false, recentOutput:'Found 4 potential locations:\n- Cheyenne Commerce Center (12 units)\n- Craig Industrial Park (8 units)\n- Losee & Ann intersection (6 units)\nScoring by PEOPLE frameworkâ€¦' };
  agentStates.relay = { status:'active', activity:'Following up on 3 warm leads', inMeeting:false, recentOutput:'Lead #842: Sent pricing sheet, awaiting response.\nLead #845: Scheduled site visit for Thursday.\nLead #847: Draft follow-up ready for review.' };
  agentStates.ralph = { status:'running', activity:'Fixing mobile responsive layout on CRM', inMeeting:false, recentOutput:'Bug fix: map pins not loading on Safari.\nCommit: a3f82c1 "Fix Safari WebGL context"\nDeployed to staging.' };
  agentStates.mary = { status:'active', activity:'Confirming Saturday event staffing', inMeeting:false, recentOutput:'Event #PB-2026-0089: Staff confirmed (2/2)\nEquipment check: âœ… Ring light, âœ… Printer\nClient: awaiting final headcount.' };
  updateMetrics({ runsToday: 47, leadsFound: 12, emailsDrafted: 8, featuresShipped: 3 });
}

function useDemoActivity() {
  const now = new Date();
  const fmt = (minAgo) => {
    const d = new Date(now - minAgo * 60000);
    return d.toLocaleTimeString('en-US', { hour:'2-digit', minute:'2-digit', hour12:true });
  };
  activityItems = [
    { time:fmt(1),  agent:'Clawd',  text:'Completed morning standup coordination' },
    { time:fmt(3),  agent:'Scout',  text:'Found 4 potential locations in North Las Vegas' },
    { time:fmt(5),  agent:'Ralph',  text:'Deployed Safari WebGL fix to staging' },
    { time:fmt(8),  agent:'Relay',  text:'Sent pricing sheet to lead #842' },
    { time:fmt(12), agent:'Mary',   text:'Confirmed staff for Saturday event PB-2026-0089' },
    { time:fmt(18), agent:'Scout',  text:'Completed Henderson warehouse district scan' },
    { time:fmt(25), agent:'Clawd',  text:'Updated MEMORY.md with Q2 strategy notes' },
    { time:fmt(30), agent:'Ralph',  text:'Committed map pin clustering optimization' },
    { time:fmt(35), agent:'Relay',  text:'Drafted follow-up for lead #847' },
    { time:fmt(42), agent:'Mary',   text:'Sent equipment checklist to Saturday crew' },
    { time:fmt(50), agent:'Clawd',  text:'Reviewed and merged Scout research findings' },
    { time:fmt(58), agent:'Scout',  text:'Started PEOPLE scoring for new prospects' },
    { time:fmt(65), agent:'Ralph',  text:'Opened PR #127: Mobile CRM responsive fixes' },
    { time:fmt(70), agent:'Relay',  text:'Updated CRM with 3 new lead entries' },
    { time:fmt(80), agent:'Mary',   text:'Processed incoming inquiry via website form' },
  ];
}

// â”€â”€ Helpers â”€â”€
function escapeHtml(str) {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

function getAgentColor(name) {
  const colors = { Kurtis:'#f59e0b', Clawd:'#8b5cf6', Scout:'#3b82f6', Relay:'#22c55e', Ralph:'#f59e0b', Mary:'#ec4899' };
  return colors[name] || 'var(--text)';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ OFFICE VIEW â€” Animated Canvas â”€â”€
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const canvas = document.getElementById('office-canvas');
const ctx = canvas.getContext('2d');
let cW = 0, cH = 0;
let officeFrame = 0;
let standupTimer = 0;
const STANDUP_INTERVAL = 10800; // ~3 min at 60fps
const STANDUP_DURATION = 900;  // ~15s at 60fps

// Agent definitions for office
const officeAgents = {
  kurtis: { emoji:'ğŸ‘‘', name:'Kurtis', color:'#f59e0b', bg:'#451a03', state:'idle' },
  clawd:  { emoji:'ğŸ§ ', name:'Clawd',  color:'#8b5cf6', bg:'#2e1065', state:'idle' },
  scout:  { emoji:'ğŸ”­', name:'Scout',  color:'#3b82f6', bg:'#172554', state:'idle' },
  relay:  { emoji:'ğŸ“¡', name:'Relay',  color:'#22c55e', bg:'#052e16', state:'idle' },
  ralph:  { emoji:'ğŸ”§', name:'Ralph',  color:'#f59e0b', bg:'#451a03', state:'idle' },
  mary:   { emoji:'ğŸ“‹', name:'Mary',   color:'#ec4899', bg:'#500724', state:'idle' },
};

// Speech bubble pools
const chatPools = {
  kurtis: ["Revenue looking goodâ€¦", "Let's ship faster", "How's the pipeline?", "Q2 targets are set", "Great work team!", "Let's review leads"],
  clawd:  ["Coordinating tasksâ€¦", "Memory updated âœ“", "Deploying nowâ€¦", "All agents online", "Standup in 5â€¦", "Checking heartbeats"],
  scout:  ["Found a hot leadâ€¦", "Scanning Hendersonâ€¦", "PEOPLE score: 8.2", "New warehouse area!", "4 prospects found", "Research complete âœ“"],
  relay:  ["3 more opens today", "Follow-up sent âœ“", "Lead #847 is warm", "Pricing sheet ready", "CRM updated", "Pipeline looking good"],
  ralph:  ["Bug fix deployed âœ“", "PR merged!", "Refactoring CRMâ€¦", "Safari fix in prod", "Tests passing âœ“", "New feature live!"],
  mary:   ["Event confirmed âœ“", "Staff: 2/2 locked", "Equipment checked", "Client happy!", "Schedule updated", "Invoice sent âœ“"],
};

// Furniture definitions (computed relative to canvas)
let furniture = [];
let waterCoolerPos = { x: 0, y: 0 };
let meetingRoomPos = { x: 0, y: 0 };

function computeLayout() {
  const w = cW, h = cH;
  const pad = 30;
  const fw = (w - pad * 2) / 4; // quarter width
  const fh = (h - pad * 2) / 4; // quarter height

  furniture = [
    { label: "CEO's Office",     x: w*0.42, y: pad+10,        w: fw*0.9, h: fh*0.7, homeFor: 'kurtis' },
    { label: "Chief of Staff",   x: w*0.42, y: pad+fh*0.85,   w: fw*0.9, h: fh*0.7, homeFor: 'clawd' },
    { label: "Research Lab",     x: pad+10, y: pad+fh*0.3,    w: fw*0.95,h: fh*0.9, homeFor: 'scout' },
    { label: "Sales Ops",        x: pad+fw*1.05, y: h*0.45,   w: fw*0.9, h: fh*0.8, homeFor: 'relay' },
    { label: "Engineering",      x: w-pad-fw*1.9, y: h*0.45,  w: fw*0.9, h: fh*0.8, homeFor: 'ralph' },
    { label: "PB Operations",    x: w-pad-fw*0.95,y: pad+fh*0.3, w: fw*0.95,h: fh*0.9, homeFor: 'mary' },
    { label: "Meeting Room",     x: w*0.30, y: h-pad-fh*0.95, w: fw*1.5, h: fh*0.85 },
    { label: "Water Cooler",     x: pad+10, y: h-pad-fh*0.65, w: fw*0.6, h: fh*0.55 },
  ];

  waterCoolerPos = { x: furniture[7].x + furniture[7].w/2, y: furniture[7].y + furniture[7].h/2 };
  meetingRoomPos = { x: furniture[6].x + furniture[6].w/2, y: furniture[6].y + furniture[6].h/2 };

  // Set agent home positions
  for (const f of furniture) {
    if (f.homeFor && officeAgents[f.homeFor]) {
      const ag = officeAgents[f.homeFor];
      const hx = f.x + f.w/2;
      const hy = f.y + f.h/2 + 5;
      ag.homeX = hx;
      ag.homeY = hy;
      if (ag.x === undefined) { ag.x = hx; ag.y = hy; }
      ag.targetX = ag.targetX || hx;
      ag.targetY = ag.targetY || hy;
    }
  }
}

// Initialize agent positions & timers
function initOfficeAgents() {
  for (const [id, ag] of Object.entries(officeAgents)) {
    ag.x = ag.homeX || cW/2;
    ag.y = ag.homeY || cH/2;
    ag.targetX = ag.x;
    ag.targetY = ag.y;
    ag.wanderTimer = Math.floor(Math.random() * 200) + 200;
    ag.bubble = null;
    ag.bubbleTimer = 0;
    ag.bobPhase = Math.random() * Math.PI * 2;
    ag.glowPhase = Math.random() * Math.PI * 2;
    ag.inStandup = false;
    ag.atWaterCooler = false;
  }
}

function updateOfficeAgentStates() {
  // Build status data from agentStates and pass to real state handler
  const statusData = {};
  for (const [id, s] of Object.entries(agentStates)) {
    if (!s) continue;
    statusData[id] = {
      state: (s.status === 'running' || s.status === 'active') ? 'running'
           : (s.status === 'meeting' || s.status === 'standup') ? 'meeting'
           : (s.status === 'discussion' || s.status === 'water-cooler') ? 'discussion'
           : 'idle',
      lastActivity: s.activity || s.statusText || null
    };
  }
  applyAgentStateFromAPI(statusData);
}

function resizeOfficeCanvas() {
  const container = document.getElementById('office-view');
  const mainEl = document.querySelector('.main');
  if (!container || !mainEl) return;
  const rect = mainEl.getBoundingClientRect();
  cW = rect.width - 60; // account for padding
  cH = rect.height - 10;
  if (cW < 200) cW = 200;
  if (cH < 200) cH = 200;
  canvas.width = cW * devicePixelRatio;
  canvas.height = cH * devicePixelRatio;
  canvas.style.width = cW + 'px';
  canvas.style.height = cH + 'px';
  ctx.setTransform(devicePixelRatio, 0, 0, devicePixelRatio, 0, 0);
  computeLayout();
}

window.addEventListener('resize', () => {
  if (currentView === 'office') resizeOfficeCanvas();
});

// â”€â”€ Drawing helpers â”€â”€
function roundRect(x, y, w, h, r) {
  ctx.beginPath();
  ctx.moveTo(x+r, y);
  ctx.lineTo(x+w-r, y);
  ctx.arcTo(x+w, y, x+w, y+r, r);
  ctx.lineTo(x+w, y+h-r);
  ctx.arcTo(x+w, y+h, x+w-r, y+h, r);
  ctx.lineTo(x+r, y+h);
  ctx.arcTo(x, y+h, x, y+h-r, r);
  ctx.lineTo(x, y+r);
  ctx.arcTo(x, y, x+r, y, r);
  ctx.closePath();
}

function drawGrid() {
  ctx.strokeStyle = '#1a1d27';
  ctx.lineWidth = 0.5;
  const step = 40;
  for (let x = 0; x < cW; x += step) {
    ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, cH); ctx.stroke();
  }
  for (let y = 0; y < cH; y += step) {
    ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(cW, y); ctx.stroke();
  }
}

function drawFurniture() {
  for (const f of furniture) {
    // Shadow
    ctx.fillStyle = 'rgba(0,0,0,0.3)';
    roundRect(f.x+3, f.y+3, f.w, f.h, 10);
    ctx.fill();

    // Body
    ctx.fillStyle = '#181c28';
    ctx.strokeStyle = '#2a3041';
    ctx.lineWidth = 1.5;
    roundRect(f.x, f.y, f.w, f.h, 10);
    ctx.fill();
    ctx.stroke();

    // Label
    ctx.fillStyle = '#4a5568';
    ctx.font = '11px -apple-system, BlinkMacSystemFont, sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText(f.label, f.x + f.w/2, f.y + 18);
  }
}

function drawConnectionLines() {
  const kurtis = officeAgents.kurtis;
  const clawd = officeAgents.clawd;
  if (!kurtis || !clawd) return;

  // Kurtis â†’ Clawd
  drawDashedLine(kurtis, clawd, clawd.state === 'running' ? 0.4 : 0.12);

  // Clawd â†’ each agent
  for (const [id, ag] of Object.entries(officeAgents)) {
    if (id === 'kurtis' || id === 'clawd') continue;
    const opacity = ag.state === 'running' ? 0.4 : 0.1;
    drawDashedLine(clawd, ag, opacity);

    // Particle for running agents
    if (ag.state === 'running') {
      const t = (officeFrame * 0.015) % 1;
      const px = clawd.x + (ag.x - clawd.x) * t;
      const py = clawd.y + (ag.y - clawd.y) * t;
      ctx.fillStyle = ag.color;
      ctx.beginPath();
      ctx.arc(px, py, 3, 0, Math.PI * 2);
      ctx.fill();
      ctx.fillStyle = ag.color + '60';
      ctx.beginPath();
      ctx.arc(px, py, 6, 0, Math.PI * 2);
      ctx.fill();
    }
  }
}

function drawDashedLine(a, b, opacity) {
  ctx.save();
  ctx.strokeStyle = `rgba(99, 102, 241, ${opacity})`;
  ctx.lineWidth = 1.5;
  ctx.setLineDash([6, 6]);
  ctx.lineDashOffset = -officeFrame * 0.5;
  ctx.beginPath();
  ctx.moveTo(a.x, a.y);
  ctx.lineTo(b.x, b.y);
  ctx.stroke();
  ctx.setLineDash([]);
  ctx.restore();
}

function drawAgent(ag) {
  // Only bob when actively working, still when idle
  const bobY = ag.state === 'running' ? Math.sin(officeFrame * 0.04 + ag.bobPhase) * 2 : 0;
  const dx = ag.x;
  const dy = ag.y + bobY;
  const r = 18;

  // Shadow ellipse
  ctx.fillStyle = 'rgba(0,0,0,0.35)';
  ctx.beginPath();
  ctx.ellipse(dx, dy + r + 6, r * 0.8, 4, 0, 0, Math.PI * 2);
  ctx.fill();

  // Glow ring for running agents
  if (ag.state === 'running') {
    ag.glowPhase += 0.04;
    const glowSize = r + 6 + Math.sin(ag.glowPhase) * 3;
    ctx.strokeStyle = ag.color + '50';
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.arc(dx, dy, glowSize, 0, Math.PI * 2);
    ctx.stroke();

    // Spinning arc
    const arcStart = officeFrame * 0.06;
    ctx.strokeStyle = ag.color + 'aa';
    ctx.lineWidth = 2.5;
    ctx.beginPath();
    ctx.arc(dx, dy, r + 8, arcStart, arcStart + 1.2);
    ctx.stroke();
  }

  // Circle body
  ctx.fillStyle = ag.bg;
  ctx.strokeStyle = ag.color + '80';
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.arc(dx, dy, r, 0, Math.PI * 2);
  ctx.fill();
  ctx.stroke();

  // Emoji
  ctx.font = '18px serif';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.fillText(ag.emoji, dx, dy + 1);

  // Name
  ctx.fillStyle = '#e2e8f0';
  ctx.font = 'bold 11px -apple-system, BlinkMacSystemFont, sans-serif';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'top';
  ctx.fillText(ag.name, dx, dy + r + 10);

  // Speech bubble
  if (ag.bubble && ag.bubbleTimer > 0) {
    const alpha = Math.min(1, ag.bubbleTimer / 30);
    drawBubble(dx, dy - r - 28, ag.bubble, alpha);
  }
}

function drawBubble(x, y, text, alpha) {
  ctx.save();
  ctx.globalAlpha = alpha;

  // Truncate text
  let display = text.length > 28 ? text.slice(0, 26) + 'â€¦' : text;
  ctx.font = '11px -apple-system, BlinkMacSystemFont, sans-serif';
  const tw = ctx.measureText(display).width;
  const bw = tw + 16;
  const bh = 24;
  const bx = x - bw/2;
  const by = y - bh;

  // Background
  ctx.fillStyle = '#1e2438';
  ctx.strokeStyle = '#3a4560';
  ctx.lineWidth = 1;
  roundRect(bx, by, bw, bh, 6);
  ctx.fill();
  ctx.stroke();

  // Pointer triangle
  ctx.fillStyle = '#1e2438';
  ctx.beginPath();
  ctx.moveTo(x - 5, by + bh);
  ctx.lineTo(x + 5, by + bh);
  ctx.lineTo(x, by + bh + 6);
  ctx.closePath();
  ctx.fill();

  // Text
  ctx.fillStyle = '#c8d0e0';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.fillText(display, x, by + bh/2);

  ctx.restore();
}

// â”€â”€ Agent behavior update â”€â”€
// REAL behavior only â€” agents move ONLY when actually working or in a real meeting.
// No random wandering. No fake water cooler chats. Office reflects actual state.
function updateAgents() {
  for (const [id, ag] of Object.entries(officeAgents)) {
    // Lerp toward target
    ag.x += (ag.targetX - ag.x) * 0.03;
    ag.y += (ag.targetY - ag.y) * 0.03;

    // State-driven positioning (no random movement)
    if (ag.state === 'running') {
      // Running agents: at their desk, working
      ag.targetX = ag.homeX;
      ag.targetY = ag.homeY;
    } else if (ag.state === 'meeting' || ag.inStandup) {
      // In a real meeting: positioned at meeting room (set by API update)
    } else if (ag.state === 'discussion') {
      // In a real water cooler discussion (set by API update)
    } else {
      // Idle: stay at desk, no movement
      ag.targetX = ag.homeX;
      ag.targetY = ag.homeY;
      ag.atWaterCooler = false;
    }

    // Bubble timer
    if (ag.bubbleTimer > 0) ag.bubbleTimer--;
    if (ag.bubbleTimer <= 0) ag.bubble = null;
  }
}

// Called when API returns agent status updates â€” triggers real movement
function applyAgentStateFromAPI(statusData) {
  for (const [id, data] of Object.entries(statusData)) {
    const ag = officeAgents[id];
    if (!ag) continue;

    const prevState = ag.state;
    ag.state = data.state || 'idle';

    // Show activity text as speech bubble when state changes
    if (data.lastActivity && ag.state === 'running' && prevState !== 'running') {
      ag.bubble = data.lastActivity.substring(0, 28);
      ag.bubbleTimer = 300;
    }

    // Move to meeting room if in standup/meeting
    if (ag.state === 'meeting') {
      ag.inStandup = true;
      const idx = Object.keys(officeAgents).indexOf(id);
      ag.targetX = meetingRoomPos.x + (idx - 2.5) * 30;
      ag.targetY = meetingRoomPos.y + (Math.random() - 0.5) * 20;
      if (!ag.bubble) { ag.bubble = 'ğŸ“‹ Standup'; ag.bubbleTimer = 200; }
    } else if (prevState === 'meeting') {
      ag.inStandup = false;
      ag.targetX = ag.homeX;
      ag.targetY = ag.homeY;
    }

    // Move to water cooler if in discussion
    if (ag.state === 'discussion') {
      ag.targetX = waterCoolerPos.x + (Math.random() - 0.5) * 40;
      ag.targetY = waterCoolerPos.y + (Math.random() - 0.5) * 30;
      ag.atWaterCooler = true;
      if (data.lastActivity) { ag.bubble = data.lastActivity.substring(0, 28); ag.bubbleTimer = 300; }
    } else if (prevState === 'discussion') {
      ag.atWaterCooler = false;
      ag.targetX = ag.homeX;
      ag.targetY = ag.homeY;
    }
  }
}

// â”€â”€ Main render loop â”€â”€
function renderOffice() {
  officeFrame++;

  // Clear
  ctx.fillStyle = '#0f1117';
  ctx.fillRect(0, 0, cW, cH);

  drawGrid();
  drawFurniture();
  drawConnectionLines();

  updateAgents();

  // Draw agents (sorted by Y for depth)
  const sorted = Object.values(officeAgents).sort((a, b) => a.y - b.y);
  for (const ag of sorted) {
    drawAgent(ag);
  }

  requestAnimationFrame(renderOffice);
}

// â”€â”€ Bootstrap office â”€â”€
resizeOfficeCanvas();
initOfficeAgents();
renderOffice();

// â”€â”€ Init â”€â”€
fetchTeamStatus();
fetchActivity();
setInterval(fetchTeamStatus, 15000);
setInterval(fetchActivity, 15000);
</script>
</body>
</html>
