<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Kande VendTech | Quick Actions</title>
  <link rel="manifest" href="/manifest.json">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --primary: #2563eb;
      --primary-dark: #1d4ed8;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --hot: #ef4444;
      --warm: #f59e0b;
      --bg: #0f172a;
      --card: #1e293b;
      --card-hover: #334155;
      --text: #f1f5f9;
      --text-muted: #94a3b8;
      --border: #334155;
      --radius: 16px;
      --safe-bottom: env(safe-area-inset-bottom, 0);
    }
    html, body { 
      height: 100%; 
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro', 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--text);
      overflow-x: hidden;
      -webkit-tap-highlight-color: transparent;
    }
    body { padding-bottom: calc(20px + var(--safe-bottom)); }
    
    /* Header */
    .header {
      position: sticky;
      top: 0;
      z-index: 100;
      background: linear-gradient(135deg, var(--bg) 0%, #1e293b 100%);
      padding: 16px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--border);
    }
    .header h1 { font-size: 20px; font-weight: 700; }
    .header .subtitle { font-size: 12px; color: var(--text-muted); }
    .sync-status { 
      font-size: 11px; 
      padding: 4px 10px; 
      border-radius: 20px;
      background: var(--card);
    }
    .sync-status.online { color: var(--success); }
    .sync-status.offline { color: var(--warning); }
    
    /* Main container */
    .container { padding: 16px; max-width: 500px; margin: 0 auto; }
    
    /* Stats bar */
    .stats-bar {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }
    .stat-card {
      background: var(--card);
      border-radius: var(--radius);
      padding: 16px 12px;
      text-align: center;
    }
    .stat-value { 
      font-size: 28px; 
      font-weight: 700;
      line-height: 1;
    }
    .stat-value.hot { color: var(--hot); }
    .stat-value.success { color: var(--success); }
    .stat-label { 
      font-size: 11px; 
      color: var(--text-muted);
      margin-top: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    /* Section titles */
    .section-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin: 24px 0 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .section-title::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--border);
    }
    
    /* Quick action buttons */
    .actions-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
    }
    .action-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 10px;
      background: var(--card);
      border: none;
      border-radius: var(--radius);
      padding: 24px 16px;
      min-height: 110px;
      cursor: pointer;
      transition: all 0.15s ease;
      -webkit-user-select: none;
      user-select: none;
    }
    .action-btn:active { 
      transform: scale(0.96);
      background: var(--card-hover);
    }
    .action-btn .icon { 
      font-size: 32px; 
      line-height: 1;
    }
    .action-btn .label { 
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
    }
    .action-btn.primary { background: var(--primary); }
    .action-btn.primary:active { background: var(--primary-dark); }
    .action-btn.success { background: var(--success); }
    .action-btn.warning { background: var(--warning); }
    
    /* Today's agenda */
    .agenda-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .agenda-item {
      background: var(--card);
      border-radius: var(--radius);
      padding: 16px;
      display: flex;
      align-items: center;
      gap: 14px;
    }
    .agenda-icon {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      flex-shrink: 0;
    }
    .agenda-icon.pop-in { background: rgba(37, 99, 235, 0.2); }
    .agenda-icon.call { background: rgba(16, 185, 129, 0.2); }
    .agenda-info { flex: 1; min-width: 0; }
    .agenda-name { 
      font-weight: 600; 
      font-size: 15px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .agenda-meta { 
      font-size: 12px; 
      color: var(--text-muted);
      margin-top: 2px;
    }
    .agenda-actions {
      display: flex;
      gap: 8px;
    }
    .agenda-btn {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      border: none;
      background: var(--border);
      color: var(--text);
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .agenda-btn:active { background: var(--card-hover); }
    .agenda-btn.nav { background: rgba(37, 99, 235, 0.3); }
    .agenda-btn.phone { background: rgba(16, 185, 129, 0.3); }
    
    /* Nearby prospects */
    .nearby-item {
      background: var(--card);
      border-radius: var(--radius);
      padding: 16px;
      margin-bottom: 10px;
    }
    .nearby-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    .nearby-name { font-weight: 600; font-size: 15px; }
    .nearby-distance { 
      font-size: 12px;
      color: var(--primary);
      background: rgba(37, 99, 235, 0.15);
      padding: 4px 10px;
      border-radius: 20px;
    }
    .nearby-address { font-size: 13px; color: var(--text-muted); margin-bottom: 10px; }
    .nearby-actions { display: flex; gap: 8px; }
    .nearby-action {
      flex: 1;
      padding: 10px;
      border-radius: 10px;
      border: none;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    .nearby-action.log { background: var(--primary); color: white; }
    .nearby-action.nav { background: var(--border); color: var(--text); }
    
    /* Recent activity */
    .activity-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 0;
      border-bottom: 1px solid var(--border);
    }
    .activity-item:last-child { border-bottom: none; }
    .activity-icon {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      background: var(--card);
    }
    .activity-info { flex: 1; }
    .activity-desc { font-size: 14px; }
    .activity-time { font-size: 11px; color: var(--text-muted); }
    
    /* Modal */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
      align-items: flex-end;
      justify-content: center;
    }
    .modal-overlay.active { display: flex; }
    .modal {
      background: var(--card);
      border-radius: 24px 24px 0 0;
      width: 100%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      padding: 24px;
      padding-bottom: calc(24px + var(--safe-bottom));
      animation: slideUp 0.25s ease;
    }
    @keyframes slideUp {
      from { transform: translateY(100%); }
      to { transform: translateY(0); }
    }
    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }
    .modal-title { font-size: 20px; font-weight: 700; }
    .modal-close {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: none;
      background: var(--border);
      color: var(--text);
      font-size: 20px;
      cursor: pointer;
    }
    
    /* Form elements */
    .form-group { margin-bottom: 16px; }
    .form-label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      color: var(--text-muted);
      margin-bottom: 8px;
    }
    .form-select, .form-input, .form-textarea {
      width: 100%;
      padding: 14px 16px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--bg);
      color: var(--text);
      font-size: 16px;
      -webkit-appearance: none;
    }
    .form-select { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='%2394a3b8' viewBox='0 0 24 24'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; background-size: 24px; }
    .form-textarea { min-height: 100px; resize: vertical; }
    .form-input:focus, .form-textarea:focus, .form-select:focus {
      outline: none;
      border-color: var(--primary);
    }
    
    /* Outcome buttons */
    .outcome-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }
    .outcome-btn {
      padding: 14px;
      border-radius: 12px;
      border: 2px solid var(--border);
      background: transparent;
      color: var(--text);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s;
    }
    .outcome-btn.selected {
      border-color: var(--primary);
      background: rgba(37, 99, 235, 0.15);
    }
    .outcome-btn:active { transform: scale(0.98); }
    
    /* Submit button */
    .submit-btn {
      width: 100%;
      padding: 16px;
      border-radius: 12px;
      border: none;
      background: var(--primary);
      color: white;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      margin-top: 20px;
    }
    .submit-btn:active { background: var(--primary-dark); }
    .submit-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    
    /* Duration input */
    .duration-row {
      display: flex;
      gap: 10px;
    }
    .duration-btn {
      flex: 1;
      padding: 12px;
      border-radius: 10px;
      border: 2px solid var(--border);
      background: transparent;
      color: var(--text);
      font-size: 14px;
      cursor: pointer;
    }
    .duration-btn.selected {
      border-color: var(--primary);
      background: rgba(37, 99, 235, 0.15);
    }
    
    /* Empty state */
    .empty-state {
      text-align: center;
      padding: 32px 16px;
      color: var(--text-muted);
    }
    .empty-state .icon { font-size: 48px; margin-bottom: 12px; }
    
    /* Priority badge */
    .priority-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 6px;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
    }
    .priority-badge.hot { background: rgba(239, 68, 68, 0.2); color: var(--hot); }
    .priority-badge.warm { background: rgba(245, 158, 11, 0.2); color: var(--warm); }
    
    /* Loading spinner */
    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      display: inline-block;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    /* Toast notification */
    .toast {
      position: fixed;
      bottom: calc(20px + var(--safe-bottom));
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--card);
      color: var(--text);
      padding: 14px 24px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      z-index: 2000;
      opacity: 0;
      transition: all 0.3s ease;
    }
    .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
    .toast.success { background: var(--success); }
    .toast.error { background: var(--danger); }
    
    /* Streak */
    .streak-badge {
      display: flex;
      align-items: center;
      gap: 6px;
      background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%);
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 700;
    }
    
    /* Search filter */
    .search-filter {
      position: relative;
      margin-bottom: 12px;
    }
    .search-filter input {
      width: 100%;
      padding: 12px 16px 12px 44px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--text);
      font-size: 15px;
    }
    .search-filter::before {
      content: 'üîç';
      position: absolute;
      left: 16px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 16px;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div>
      <h1>Quick Actions</h1>
      <div class="subtitle" id="dateDisplay">Loading...</div>
    </div>
    <div style="display: flex; align-items: center; gap: 12px;">
      <div class="streak-badge" id="streakBadge" style="display: none;">
        <span>üî•</span><span id="streakCount">0</span> day streak
      </div>
      <span class="sync-status online" id="syncStatus">‚óè Online</span>
    </div>
  </header>
  
  <div class="container">
    <!-- Stats at a glance -->
    <div class="stats-bar">
      <div class="stat-card">
        <div class="stat-value" id="todayCount">0</div>
        <div class="stat-label">Today</div>
      </div>
      <div class="stat-card">
        <div class="stat-value hot" id="hotCount">0</div>
        <div class="stat-label">Hot Leads</div>
      </div>
      <div class="stat-card">
        <div class="stat-value success" id="weekCount">0</div>
        <div class="stat-label">This Week</div>
      </div>
    </div>
    
    <!-- Quick Actions -->
    <div class="section-title">Quick Actions</div>
    <div class="actions-grid">
      <button class="action-btn primary" onclick="openModal('pop-in')">
        <span class="icon">üìç</span>
        <span class="label">Log Pop-In</span>
      </button>
      <button class="action-btn" onclick="openModal('call')">
        <span class="icon">üìû</span>
        <span class="label">Log Call</span>
      </button>
      <button class="action-btn" onclick="openModal('email')">
        <span class="icon">üìß</span>
        <span class="label">Send Email</span>
      </button>
      <button class="action-btn success" onclick="openModal('gift')">
        <span class="icon">üéÅ</span>
        <span class="label">Gift Basket</span>
      </button>
      <button class="action-btn" onclick="openModal('photo')">
        <span class="icon">üì∏</span>
        <span class="label">Take Photo</span>
      </button>
      <button class="action-btn" onclick="openModal('note')">
        <span class="icon">üìù</span>
        <span class="label">Quick Note</span>
      </button>
    </div>
    
    <!-- Today's Agenda -->
    <div class="section-title">Today's Agenda</div>
    <div class="agenda-list" id="agendaList">
      <div class="empty-state">
        <div class="icon">üìÖ</div>
        <p>No scheduled activities today</p>
      </div>
    </div>
    
    <!-- Nearby Prospects -->
    <div class="section-title" id="nearbyTitle" style="display: none;">Nearby Prospects</div>
    <div id="nearbyList"></div>
    
    <!-- Recent Activity -->
    <div class="section-title">Recent Activity</div>
    <div id="recentActivity">
      <div class="empty-state">
        <div class="icon">üìã</div>
        <p>No recent activity</p>
      </div>
    </div>
  </div>
  
  <!-- Modal Overlay -->
  <div class="modal-overlay" id="modalOverlay" onclick="closeModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h2 class="modal-title" id="modalTitle">Log Activity</h2>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      <div id="modalContent"></div>
    </div>
  </div>
  
  <!-- Toast -->
  <div class="toast" id="toast"></div>

<script>
// State
let prospects = [];
let activities = [];
let userLocation = null;
let selectedOutcome = null;
let selectedDuration = null;

// Cache keys
const CACHE_KEY = 'vendtech_mobile_cache';
const CACHE_EXPIRY = 5 * 60 * 1000; // 5 minutes

// Initialize
document.addEventListener('DOMContentLoaded', init);

async function init() {
  updateDateDisplay();
  await loadData();
  updateStats();
  renderAgenda();
  renderRecentActivity();
  requestLocation();
  checkStreak();
  
  // Sync indicator
  window.addEventListener('online', () => updateSyncStatus(true));
  window.addEventListener('offline', () => updateSyncStatus(false));
  updateSyncStatus(navigator.onLine);
}

function updateDateDisplay() {
  const now = new Date();
  const options = { weekday: 'long', month: 'short', day: 'numeric' };
  document.getElementById('dateDisplay').textContent = now.toLocaleDateString('en-US', options);
}

function updateSyncStatus(online) {
  const el = document.getElementById('syncStatus');
  if (online) {
    el.className = 'sync-status online';
    el.textContent = '‚óè Online';
  } else {
    el.className = 'sync-status offline';
    el.textContent = '‚óã Offline';
  }
}

// Data loading with cache
async function loadData() {
  // Try cache first
  const cached = localStorage.getItem(CACHE_KEY);
  if (cached) {
    try {
      const data = JSON.parse(cached);
      if (Date.now() - data.timestamp < CACHE_EXPIRY) {
        prospects = data.prospects || [];
        activities = data.activities || [];
      }
    } catch (e) {}
  }
  
  // Fetch fresh data
  if (navigator.onLine) {
    try {
      const [pRes, aRes] = await Promise.all([
        fetch('/api/prospects'),
        fetch('/api/activities')
      ]);
      if (pRes.ok) prospects = await pRes.json();
      if (aRes.ok) activities = await aRes.json();
      
      // Update cache
      localStorage.setItem(CACHE_KEY, JSON.stringify({
        prospects,
        activities,
        timestamp: Date.now()
      }));
    } catch (e) {
      console.error('Failed to load data:', e);
    }
  }
}

function updateStats() {
  const today = new Date().toISOString().split('T')[0];
  const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
  
  const todayActivities = activities.filter(a => a.created_at?.startsWith(today));
  const weekActivities = activities.filter(a => a.created_at >= weekAgo);
  const hotProspects = prospects.filter(p => p.priority === 'hot');
  
  document.getElementById('todayCount').textContent = todayActivities.length;
  document.getElementById('hotCount').textContent = hotProspects.length;
  document.getElementById('weekCount').textContent = weekActivities.length;
}

function checkStreak() {
  // Calculate activity streak
  const sortedDates = [...new Set(activities.map(a => a.created_at?.split('T')[0]).filter(Boolean))].sort().reverse();
  let streak = 0;
  const today = new Date();
  
  for (let i = 0; i < 30; i++) {
    const checkDate = new Date(today);
    checkDate.setDate(checkDate.getDate() - i);
    const dateStr = checkDate.toISOString().split('T')[0];
    if (sortedDates.includes(dateStr)) {
      streak++;
    } else if (i > 0) {
      break;
    }
  }
  
  if (streak > 1) {
    document.getElementById('streakBadge').style.display = 'flex';
    document.getElementById('streakCount').textContent = streak;
  }
}

function renderAgenda() {
  const today = new Date().toISOString().split('T')[0];
  
  // Find prospects with scheduled follow-ups today
  const agenda = prospects
    .filter(p => p.next_action_date?.startsWith(today))
    .sort((a, b) => (a.next_action_date || '').localeCompare(b.next_action_date || ''));
  
  const container = document.getElementById('agendaList');
  
  if (agenda.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="icon">üìÖ</div>
        <p>No scheduled activities today</p>
      </div>
    `;
    return;
  }
  
  container.innerHTML = agenda.map(p => {
    const isCall = p.next_action?.toLowerCase().includes('call');
    const iconClass = isCall ? 'call' : 'pop-in';
    const icon = isCall ? 'üìû' : 'üìç';
    const mapsUrl = p.address ? `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(p.address)}` : null;
    const phone = p.phone || p.contact_phone;
    
    return `
      <div class="agenda-item">
        <div class="agenda-icon ${iconClass}">${icon}</div>
        <div class="agenda-info">
          <div class="agenda-name">
            ${p.name}
            ${p.priority === 'hot' ? '<span class="priority-badge hot">HOT</span>' : ''}
            ${p.priority === 'warm' ? '<span class="priority-badge warm">WARM</span>' : ''}
          </div>
          <div class="agenda-meta">${p.next_action || 'Follow up'}</div>
        </div>
        <div class="agenda-actions">
          ${mapsUrl ? `<a href="${mapsUrl}" target="_blank" class="agenda-btn nav">üó∫Ô∏è</a>` : ''}
          ${phone ? `<a href="tel:${phone}" class="agenda-btn phone">üìû</a>` : ''}
        </div>
      </div>
    `;
  }).join('');
}

function requestLocation() {
  if ('geolocation' in navigator) {
    navigator.geolocation.getCurrentPosition(
      pos => {
        userLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };
        renderNearbyProspects();
      },
      err => console.log('Location unavailable'),
      { enableHighAccuracy: false, timeout: 10000 }
    );
  }
}

function renderNearbyProspects() {
  if (!userLocation) return;
  
  // Calculate distances and sort
  const withDistance = prospects
    .filter(p => p.lat && p.lng && p.status !== 'closed' && p.status !== 'signed')
    .map(p => ({
      ...p,
      distance: getDistanceMiles(userLocation.lat, userLocation.lng, p.lat, p.lng)
    }))
    .sort((a, b) => a.distance - b.distance)
    .slice(0, 5);
  
  if (withDistance.length === 0) return;
  
  document.getElementById('nearbyTitle').style.display = 'flex';
  const container = document.getElementById('nearbyList');
  
  container.innerHTML = withDistance.map(p => {
    const mapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(p.address || p.name)}`;
    return `
      <div class="nearby-item">
        <div class="nearby-header">
          <span class="nearby-name">
            ${p.name}
            ${p.priority === 'hot' ? '<span class="priority-badge hot">HOT</span>' : ''}
          </span>
          <span class="nearby-distance">${p.distance.toFixed(1)} mi</span>
        </div>
        <div class="nearby-address">${p.address || 'No address'}</div>
        <div class="nearby-actions">
          <button class="nearby-action log" onclick="quickLogPopIn(${p.id})">üìç Log Visit</button>
          <a href="${mapsUrl}" target="_blank" class="nearby-action nav">üó∫Ô∏è Navigate</a>
        </div>
      </div>
    `;
  }).join('');
}

function getDistanceMiles(lat1, lon1, lat2, lon2) {
  const R = 3959; // Earth radius in miles
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
    Math.sin(dLon/2) * Math.sin(dLon/2);
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

function renderRecentActivity() {
  const recent = activities
    .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))
    .slice(0, 5);
  
  if (recent.length === 0) return;
  
  const container = document.getElementById('recentActivity');
  container.innerHTML = recent.map(a => {
    const prospect = prospects.find(p => p.id === a.prospect_id);
    const icon = getActivityIcon(a.type);
    const time = formatTimeAgo(a.created_at);
    
    return `
      <div class="activity-item">
        <div class="activity-icon">${icon}</div>
        <div class="activity-info">
          <div class="activity-desc">${a.type} - ${prospect?.name || 'Unknown'}</div>
          <div class="activity-time">${time}</div>
        </div>
      </div>
    `;
  }).join('');
}

function getActivityIcon(type) {
  const icons = {
    'pop_in': 'üìç', 'pop-in': 'üìç', 'visit': 'üìç',
    'call': 'üìû', 'phone': 'üìû',
    'email': 'üìß',
    'gift': 'üéÅ', 'gift_basket': 'üéÅ',
    'note': 'üìù',
    'photo': 'üì∏',
    'proposal': 'üìÑ',
    'meeting': 'ü§ù'
  };
  return icons[type?.toLowerCase()] || 'üìã';
}

function formatTimeAgo(dateStr) {
  const date = new Date(dateStr);
  const now = new Date();
  const diff = now - date;
  const mins = Math.floor(diff / 60000);
  const hours = Math.floor(diff / 3600000);
  const days = Math.floor(diff / 86400000);
  
  if (mins < 1) return 'Just now';
  if (mins < 60) return `${mins}m ago`;
  if (hours < 24) return `${hours}h ago`;
  if (days < 7) return `${days}d ago`;
  return date.toLocaleDateString();
}

// Modal handling
function openModal(type) {
  selectedOutcome = null;
  selectedDuration = null;
  
  const titles = {
    'pop-in': 'üìç Log Pop-In',
    'call': 'üìû Log Call',
    'email': 'üìß Send Email',
    'gift': 'üéÅ Gift Basket',
    'photo': 'üì∏ Take Photo',
    'note': 'üìù Quick Note'
  };
  
  document.getElementById('modalTitle').textContent = titles[type] || 'Log Activity';
  document.getElementById('modalContent').innerHTML = getModalContent(type);
  document.getElementById('modalOverlay').classList.add('active');
  
  // Focus first input
  setTimeout(() => {
    const input = document.querySelector('.modal input, .modal select');
    if (input) input.focus();
  }, 100);
}

function closeModal(event) {
  if (event && event.target !== event.currentTarget) return;
  document.getElementById('modalOverlay').classList.remove('active');
}

function getModalContent(type) {
  const prospectOptions = prospects
    .filter(p => p.status !== 'closed')
    .sort((a, b) => {
      const priority = { hot: 0, warm: 1, normal: 2 };
      return (priority[a.priority] || 2) - (priority[b.priority] || 2);
    })
    .map(p => `<option value="${p.id}">${p.name}${p.priority === 'hot' ? ' üî•' : p.priority === 'warm' ? ' üü†' : ''}</option>`)
    .join('');
  
  const prospectSelect = `
    <div class="form-group">
      <div class="search-filter">
        <input type="text" placeholder="Search prospects..." oninput="filterProspects(this.value)">
      </div>
      <select class="form-select" id="prospectId" required>
        <option value="">Select prospect...</option>
        ${prospectOptions}
      </select>
    </div>
  `;
  
  if (type === 'pop-in') {
    return `
      ${prospectSelect}
      <div class="form-group">
        <label class="form-label">Outcome</label>
        <div class="outcome-grid">
          <button type="button" class="outcome-btn" onclick="selectOutcome(this, 'interested')">üòä Interested</button>
          <button type="button" class="outcome-btn" onclick="selectOutcome(this, 'not_available')">üö´ Not Available</button>
          <button type="button" class="outcome-btn" onclick="selectOutcome(this, 'follow_up')">üìÖ Follow Up</button>
          <button type="button" class="outcome-btn" onclick="selectOutcome(this, 'not_interested')">üëé Not Interested</button>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Notes</label>
        <textarea class="form-textarea" id="notes" placeholder="What happened? Who did you talk to?"></textarea>
      </div>
      <button class="submit-btn" onclick="submitActivity('pop_in')">Log Pop-In</button>
    `;
  }
  
  if (type === 'call') {
    return `
      ${prospectSelect}
      <div class="form-group">
        <label class="form-label">Duration</label>
        <div class="duration-row">
          <button type="button" class="duration-btn" onclick="selectDuration(this, 5)">5 min</button>
          <button type="button" class="duration-btn" onclick="selectDuration(this, 10)">10 min</button>
          <button type="button" class="duration-btn" onclick="selectDuration(this, 15)">15 min</button>
          <button type="button" class="duration-btn" onclick="selectDuration(this, 30)">30+ min</button>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Outcome</label>
        <div class="outcome-grid">
          <button type="button" class="outcome-btn" onclick="selectOutcome(this, 'connected')">‚úÖ Connected</button>
          <button type="button" class="outcome-btn" onclick="selectOutcome(this, 'voicemail')">üì´ Voicemail</button>
          <button type="button" class="outcome-btn" onclick="selectOutcome(this, 'call_back')">üìû Call Back</button>
          <button type="button" class="outcome-btn" onclick="selectOutcome(this, 'no_answer')">‚ùå No Answer</button>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Notes</label>
        <textarea class="form-textarea" id="notes" placeholder="Key points from the call..."></textarea>
      </div>
      <button class="submit-btn" onclick="submitActivity('call')">Log Call</button>
    `;
  }
  
  if (type === 'email') {
    return `
      ${prospectSelect}
      <div class="form-group">
        <label class="form-label">Email Template</label>
        <select class="form-select" id="template">
          <option value="intro">Introduction</option>
          <option value="follow_up">Follow Up</option>
          <option value="proposal">Proposal</option>
          <option value="thank_you">Thank You</option>
          <option value="custom">Custom</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Subject</label>
        <input type="text" class="form-input" id="subject" placeholder="Email subject...">
      </div>
      <div class="form-group">
        <label class="form-label">Notes</label>
        <textarea class="form-textarea" id="notes" placeholder="Key points to include..."></textarea>
      </div>
      <button class="submit-btn" onclick="submitActivity('email')">Log Email Sent</button>
    `;
  }
  
  if (type === 'gift') {
    return `
      ${prospectSelect}
      <div class="form-group">
        <label class="form-label">Gift Type</label>
        <select class="form-select" id="giftType">
          <option value="snack_basket">üß∫ Snack Basket ($5)</option>
          <option value="premium_basket">üéÅ Premium Basket ($15)</option>
          <option value="branded_items">üëï Branded Items</option>
          <option value="other">üì¶ Other</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">Delivered To</label>
        <input type="text" class="form-input" id="deliveredTo" placeholder="Person's name...">
      </div>
      <div class="form-group">
        <label class="form-label">Notes</label>
        <textarea class="form-textarea" id="notes" placeholder="Their reaction, follow-up needed..."></textarea>
      </div>
      <button class="submit-btn" onclick="submitActivity('gift_basket')">Log Gift Basket</button>
    `;
  }
  
  if (type === 'photo') {
    return `
      ${prospectSelect}
      <div class="form-group">
        <label class="form-label">Photo (Coming Soon)</label>
        <div style="background: var(--bg); border-radius: 12px; padding: 40px; text-align: center;">
          <div style="font-size: 48px; margin-bottom: 12px;">üì∏</div>
          <p style="color: var(--text-muted);">Photo capture will be available in a future update</p>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Notes</label>
        <textarea class="form-textarea" id="notes" placeholder="What are you photographing?"></textarea>
      </div>
      <button class="submit-btn" disabled>Take Photo (Coming Soon)</button>
    `;
  }
  
  if (type === 'note') {
    return `
      ${prospectSelect}
      <div class="form-group">
        <label class="form-label">Note</label>
        <textarea class="form-textarea" id="notes" placeholder="Quick note about this prospect..." style="min-height: 150px;"></textarea>
      </div>
      <button class="submit-btn" onclick="submitActivity('note')">Save Note</button>
    `;
  }
  
  return '<p>Unknown action</p>';
}

function filterProspects(query) {
  const select = document.getElementById('prospectId');
  const options = select.querySelectorAll('option');
  const q = query.toLowerCase();
  
  options.forEach(opt => {
    if (!opt.value) return; // Keep placeholder
    opt.style.display = opt.textContent.toLowerCase().includes(q) ? '' : 'none';
  });
}

function selectOutcome(btn, value) {
  document.querySelectorAll('.outcome-btn').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
  selectedOutcome = value;
}

function selectDuration(btn, value) {
  document.querySelectorAll('.duration-btn').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
  selectedDuration = value;
}

async function submitActivity(type) {
  const prospectId = document.getElementById('prospectId')?.value;
  const notes = document.getElementById('notes')?.value || '';
  
  if (!prospectId) {
    showToast('Please select a prospect', 'error');
    return;
  }
  
  const activity = {
    type,
    description: notes,
    outcome: selectedOutcome,
    duration: selectedDuration,
    created_at: new Date().toISOString()
  };
  
  // Add extra fields based on type
  if (type === 'email') {
    activity.template = document.getElementById('template')?.value;
    activity.subject = document.getElementById('subject')?.value;
  }
  if (type === 'gift_basket') {
    activity.gift_type = document.getElementById('giftType')?.value;
    activity.delivered_to = document.getElementById('deliveredTo')?.value;
  }
  
  // Optimistic UI update
  activities.unshift({ ...activity, prospect_id: parseInt(prospectId), id: Date.now() });
  updateStats();
  renderRecentActivity();
  
  // Save to server
  try {
    const res = await fetch(`/api/prospects/${prospectId}/activities`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(activity)
    });
    
    if (res.ok) {
      showToast('Activity logged! üéâ', 'success');
      
      // Update prospect priority if interested
      if (selectedOutcome === 'interested') {
        await fetch(`/api/prospects/${prospectId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ priority: 'hot' })
        });
      }
      
      // Refresh data
      await loadData();
      updateStats();
      renderAgenda();
      renderRecentActivity();
    } else {
      // Queue for later sync
      queueOfflineActivity(prospectId, activity);
      showToast('Saved offline - will sync later', 'warning');
    }
  } catch (e) {
    queueOfflineActivity(prospectId, activity);
    showToast('Saved offline - will sync later', 'warning');
  }
  
  closeModal();
}

function quickLogPopIn(prospectId) {
  openModal('pop-in');
  setTimeout(() => {
    document.getElementById('prospectId').value = prospectId;
  }, 50);
}

function queueOfflineActivity(prospectId, activity) {
  const queue = JSON.parse(localStorage.getItem('vendtech_offline_queue') || '[]');
  queue.push({ prospectId, activity, timestamp: Date.now() });
  localStorage.setItem('vendtech_offline_queue', JSON.stringify(queue));
}

// Sync offline queue when back online
window.addEventListener('online', async () => {
  const queue = JSON.parse(localStorage.getItem('vendtech_offline_queue') || '[]');
  if (queue.length === 0) return;
  
  for (const item of queue) {
    try {
      await fetch(`/api/prospects/${item.prospectId}/activities`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(item.activity)
      });
    } catch (e) {}
  }
  
  localStorage.removeItem('vendtech_offline_queue');
  showToast(`Synced ${queue.length} offline activities`, 'success');
  await loadData();
  updateStats();
});

function showToast(message, type = '') {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.className = 'toast ' + type;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 3000);
}
</script>
</body>
</html>
