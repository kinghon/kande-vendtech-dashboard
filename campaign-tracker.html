<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Email Campaign Tracker ‚Äî Kande VendTech</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'Inter', -apple-system, sans-serif; background: #f8f9fa; color: #1a1a1a; min-height: 100vh; }
  a { color: #2563eb; text-decoration: none; }
  a:hover { text-decoration: underline; }

  .header { background: #fff; padding: 20px 30px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
  .header h1 { font-size: 22px; font-weight: 700; color: #111; }
  .header .back { color: #666; font-size: 14px; }

  .stats-bar { display: flex; gap: 16px; padding: 16px 30px; background: #fff; border-bottom: 1px solid #e2e8f0; flex-wrap: wrap; }
  .stat { background: #f1f5f9; border-radius: 8px; padding: 12px 20px; min-width: 120px; }
  .stat .label { font-size: 11px; color: #666; text-transform: uppercase; letter-spacing: 0.5px; }
  .stat .value { font-size: 24px; font-weight: 700; margin-top: 2px; color: #111; }
  .stat .value.green { color: #16a34a; }
  .stat .value.blue { color: #2563eb; }
  .stat .value.gold { color: #d97706; }
  .stat .value.red { color: #dc2626; }

  .table-wrap { padding: 20px 30px; overflow-x: auto; }
  table { width: 100%; border-collapse: collapse; font-size: 13px; min-width: 1100px; }
  thead th { background: #f1f5f9; color: #555; font-weight: 600; text-transform: uppercase; font-size: 11px; letter-spacing: 0.5px; padding: 10px 8px; text-align: left; position: sticky; top: 0; border-bottom: 2px solid #e2e8f0; }
  tbody tr { border-bottom: 1px solid #e8ecf1; }
  tbody tr:hover { background: #f1f5f9; }
  td { padding: 10px 8px; vertical-align: middle; }
  td.lead-name { font-weight: 600; max-width: 180px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  td.email-addr { font-size: 11px; color: #888; max-width: 200px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

  .email-cell { text-align: center; min-width: 90px; border-radius: 4px; padding: 6px 4px; }
  .email-cell.sent { background: #dbeafe; color: #1d4ed8; }
  .email-cell.opened { background: #dcfce7; color: #15803d; }
  .email-cell.scheduled { background: #f1f5f9; color: #999; }
  .email-cell.bounced { background: #fee2e2; color: #dc2626; }
  .email-cell.replied { background: #fef3c7; color: #b45309; }
  .email-cell .icon { font-size: 16px; display: block; }
  .email-cell .ts { font-size: 10px; margin-top: 2px; display: block; opacity: 0.7; }

  .status-badge { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 600; }
  .status-badge.active { background: #dcfce7; color: #15803d; }
  .status-badge.paused { background: #fef3c7; color: #b45309; }
  .status-badge.replied { background: #fef3c7; color: #b45309; }
  .status-badge.bounced { background: #fee2e2; color: #dc2626; }
  .status-badge.completed { background: #dbeafe; color: #1d4ed8; }

  .loading { text-align: center; padding: 60px; color: #888; font-size: 16px; }
  .refresh-btn { background: #2563eb; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; }
  .refresh-btn:hover { background: #1d4ed8; }

  .opens-row td { padding: 0 8px 10px; background: #f8fdf8; }
  .opens-detail { font-size: 11px; color: #555; padding: 8px 12px; background: #fff; border: 1px solid #e2e8f0; border-radius: 6px; }
  .opens-detail .open-event { display: flex; align-items: center; gap: 8px; padding: 3px 0; border-bottom: 1px solid #f1f5f9; }
  .opens-detail .open-event:last-child { border-bottom: none; }
  .opens-detail .open-ts { color: #2563eb; font-weight: 500; min-width: 120px; }
  .opens-detail .open-subject { color: #888; }
  .opens-detail .open-count { color: #16a34a; font-weight: 600; }
  .opens-toggle { cursor: pointer; }
  .opens-toggle:hover { text-decoration: underline; }
  .no-opens { color: #aaa; font-style: italic; }

  @media (max-width: 768px) {
    .header { padding: 14px 16px; }
    .stats-bar { padding: 12px 16px; }
    .table-wrap { padding: 12px 16px; }
  }
</style>
</head>
<body>

<div class="header">
  <h1>üìß Email Campaign Tracker</h1>
  <div>
    <a href="/" class="back">‚Üê Dashboard</a>
    &nbsp;&nbsp;
    <button class="refresh-btn" onclick="loadData()">üîÑ Refresh</button>
  </div>
</div>

<div class="stats-bar" id="statsBar">
  <div class="stat"><div class="label">Total Leads</div><div class="value blue" id="statLeads">‚Äî</div></div>
  <div class="stat"><div class="label">Email 0 Sent</div><div class="value" id="statSent">‚Äî</div></div>
  <div class="stat"><div class="label">Opened</div><div class="value green" id="statOpened">‚Äî</div></div>
  <div class="stat"><div class="label">Open Rate</div><div class="value green" id="statOpenRate">‚Äî</div></div>
  <div class="stat"><div class="label">Replied</div><div class="value gold" id="statReplied">‚Äî</div></div>
  <div class="stat"><div class="label">Bounced</div><div class="value red" id="statBounced">‚Äî</div></div>
</div>

<div class="table-wrap">
  <div class="loading" id="loading">Loading campaign data...</div>
  <table id="campaignTable" style="display:none;">
    <thead>
      <tr>
        <th>Lead</th>
        <th>Contact</th>
        <th>Email</th>
        <th>Email 0<br><span style="font-weight:400;text-transform:none;font-size:10px;">Proposal</span></th>
        <th>Email 1<br><span style="font-weight:400;text-transform:none;font-size:10px;">Day 3</span></th>
        <th>Email 2<br><span style="font-weight:400;text-transform:none;font-size:10px;">Day 7</span></th>
        <th>Email 3<br><span style="font-weight:400;text-transform:none;font-size:10px;">Day 14</span></th>
        <th>Email 4<br><span style="font-weight:400;text-transform:none;font-size:10px;">Day 21</span></th>
        <th>Email 5<br><span style="font-weight:400;text-transform:none;font-size:10px;">Day 30</span></th>
        <th>Opens</th>
        <th>Status</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>
</div>

<script>
const API = '';
const API_KEY = 'kande2026';
const headers = { 'x-api-key': API_KEY };

// Campaign leads (hardcoded IDs for the active Instantly campaign)
const CAMPAIGN_LEADS = [
  { pid: 15, name: 'Ainsley at The Collective', contact: 'Linigar Jimenez', email: 'linigar.jimenez@cushwake.com' },
  { pid: 11, name: 'High Line at Hughes Center', contact: 'Peter Torres', email: 'peter.torres@livebh.com' },
  { pid: 35, name: 'Elysian at The Palms', contact: 'Jose Garcia', email: 'elysianpalmsmgr@cushwake.com' },
  { pid: 539, name: 'Atria Seville', contact: 'Markie Hamlin', email: 'markie.hamlin@atriaseniorliving.com' },
  { pid: 145, name: 'Las Ventanas at Summerlin', contact: 'Randy Fuller', email: 'randy.fuller@humangood.org' },
  { pid: 43, name: 'Auric Symphony Park', contact: 'Kayla Jackson', email: 'kayla.jackson@marc-taylor.com' },
  { pid: 156, name: 'Fora', contact: 'James Gonzalez', email: 'manager@foravegas.com' },
  { pid: 110, name: 'Mera 55+', contact: 'Micheline Dundas', email: 'micheline.dundas@sparrowliving.com' },
  { pid: 124, name: 'Society', contact: 'Property Manager', email: 'society@westcorpmg.com', mgmtCo: 'Westcorp Management Group' },
  { pid: 64, name: 'Constellation', contact: 'Property Manager', email: 'constellationmgr@greystar.com', mgmtCo: 'Greystar' },
  { pid: 92, name: 'Dune', contact: 'Property Manager', email: 'dune@westcorpmg.com', mgmtCo: 'Westcorp Management Group' },
  { pid: 67, name: 'Ilumina at Raiders Way', contact: 'Property Manager', email: 'iluminaonraidersway@knck.io', mgmtCo: 'Knck.io' },
  { pid: 130, name: 'Dig This', contact: 'Ed Mumm', email: 'ed@digthis.info' },
  { pid: 1, name: 'Siegel Select', contact: 'Nicole Marshall', email: 'flamingo.manager@siegelselect.com' },
  { pid: 95, name: 'Empire', contact: 'Property Manager', email: 'empireassist@westcorpmg.com', mgmtCo: 'Westcorp Management Group' },
  { pid: 116, name: 'Aspire', contact: 'Property Manager', email: 'aspiresunridgeheights@ovationco.com', mgmtCo: 'Ovation Co' },
  { pid: 98, name: 'Evolve', contact: 'Property Manager', email: 'evolveassist@westcorpmg.com', mgmtCo: 'Westcorp Management Group' },
  { pid: 32, name: 'Aura Vegas', contact: 'F. Santiago', email: 'fsantiago@foreproperty.com', mgmtCo: 'Fore Property Co' },
  { pid: 113, name: 'Domain', contact: 'Property Manager', email: 'domainmgr@cushwake.com', mgmtCo: 'Cushman & Wakefield' },
  { pid: 104, name: 'Marlowe', contact: 'Property Manager', email: 'marloweslv@greystar.com', mgmtCo: 'Greystar' },
];

const STEP_DELAYS = [0, 3, 7, 14, 21, 30]; // days after email 0

// Internal domains to exclude (Jordan, Kurtis, etc.)
const INTERNAL_DOMAINS = ['kandevendtech.com', 'kandevendtech.co', 'kandephotobooths.com'];
function isInternal(email) {
  if (!email) return false;
  return INTERNAL_DOMAINS.some(d => email.toLowerCase().endsWith('@' + d));
}

function fmtDate(d) {
  if (!d) return '';
  const dt = new Date(d);
  return `${dt.getMonth()+1}/${dt.getDate()}`;
}

function fmtDateTime(d) {
  if (!d) return '';
  const dt = new Date(d);
  return `${dt.getMonth()+1}/${dt.getDate()} ${dt.getHours()}:${String(dt.getMinutes()).padStart(2,'0')}`;
}

function fmtFullDateTime(d) {
  if (!d) return '';
  const dt = new Date(d);
  const h = dt.getHours();
  const ampm = h >= 12 ? 'PM' : 'AM';
  const h12 = h % 12 || 12;
  return `${dt.getMonth()+1}/${dt.getDate()} ${h12}:${String(dt.getMinutes()).padStart(2,'0')} ${ampm}`;
}

function toggleOpens(pid) {
  const row = document.getElementById('opens-' + pid);
  if (row) row.style.display = row.style.display === 'none' ? 'table-row' : 'none';
}

function makeCell(step, tracking, email0SentDate) {
  const div = document.createElement('td');
  
  // For email 0, check Mixmax/activity tracking
  if (step === 0) {
    const t = tracking.find(t => !t._is_followup);
    if (!t) {
      // Check if email 0 was sent based on activities
      if (email0SentDate) {
        div.className = 'email-cell sent';
        div.innerHTML = `<span class="icon">‚úÖ</span><span class="ts">${fmtDate(email0SentDate)}</span>`;
      } else {
        div.className = 'email-cell scheduled';
        div.innerHTML = `<span class="icon">‚è≥</span>`;
      }
      return div;
    }
    
    if (t.was_bounced) {
      div.className = 'email-cell bounced';
      div.innerHTML = `<span class="icon">‚ùå</span><span class="ts">Bounced</span>`;
    } else if (t.was_replied) {
      div.className = 'email-cell replied';
      div.innerHTML = `<span class="icon">üí¨</span><span class="ts">${fmtDate(t.sent_at)}</span>`;
    } else if (t.num_opens > 0 || t._adjusted_opens > 0) {
      const opens = t._adjusted_opens || t.num_opens;
      div.className = 'email-cell opened';
      div.innerHTML = `<span class="icon">üì© ${opens}x</span><span class="ts">${fmtDate(t.sent_at)}</span>`;
    } else {
      div.className = 'email-cell sent';
      div.innerHTML = `<span class="icon">‚úÖ</span><span class="ts">${fmtDate(t.sent_at)}</span>`;
    }
    return div;
  }

  // For follow-up emails (1-5), calculate scheduled date from email 0
  if (!email0SentDate) {
    div.className = 'email-cell scheduled';
    div.innerHTML = `<span class="icon">‚Äî</span>`;
    return div;
  }

  const scheduledDate = new Date(new Date(email0SentDate).getTime() + STEP_DELAYS[step] * 24*60*60*1000);
  const now = new Date();
  
  // Check if there's tracking for this follow-up step
  const followups = tracking.filter(t => t._is_followup);
  const stepTrack = followups.find(t => t._step === step);

  if (stepTrack) {
    if (stepTrack.was_bounced) {
      div.className = 'email-cell bounced';
      div.innerHTML = `<span class="icon">‚ùå</span><span class="ts">Bounced</span>`;
    } else if (stepTrack.was_replied) {
      div.className = 'email-cell replied';
      div.innerHTML = `<span class="icon">üí¨</span><span class="ts">${fmtDate(stepTrack.sent_at)}</span>`;
    } else if (stepTrack.num_opens > 0) {
      div.className = 'email-cell opened';
      div.innerHTML = `<span class="icon">üì©</span><span class="ts">${fmtDate(stepTrack.sent_at)}</span>`;
    } else {
      div.className = 'email-cell sent';
      div.innerHTML = `<span class="icon">‚úÖ</span><span class="ts">${fmtDate(stepTrack.sent_at)}</span>`;
    }
  } else if (scheduledDate <= now) {
    // Should have been sent by now (Instantly handles it)
    div.className = 'email-cell scheduled';
    div.innerHTML = `<span class="icon">‚è≥</span><span class="ts">${fmtDate(scheduledDate)}</span>`;
  } else {
    div.className = 'email-cell scheduled';
    div.innerHTML = `<span class="icon">‚è≥</span><span class="ts">${fmtDate(scheduledDate)}</span>`;
  }
  return div;
}

async function loadData() {
  document.getElementById('loading').style.display = 'block';
  document.getElementById('campaignTable').style.display = 'none';

  try {
    const [prospectsRes, activitiesRes, eventsRes] = await Promise.all([
      fetch('/api/prospects', { headers }),
      fetch('/api/activities?limit=1000', { headers }),
      fetch('/api/instantly-events', { headers }).catch(() => ({ ok: false }))
    ]);
    
    const prospects = await prospectsRes.json();
    const activities = await activitiesRes.json();
    const allEvents = eventsRes.ok ? await eventsRes.json() : [];

    const prospectMap = {};
    prospects.forEach(p => prospectMap[p.id] = p);

    let totalSent = 0, totalOpened = 0, totalReplied = 0, totalBounced = 0;

    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = '';

    for (const lead of CAMPAIGN_LEADS) {
      const p = prospectMap[lead.pid] || {};
      const tracking = p.email_tracking || [];

      // Enrich contact name from CRM if available
      if (lead.contact === 'Property Manager' || lead.contact === 'Manager') {
        // Check prospect contacts
        const contacts = p.contacts || [];
        const primaryContact = contacts.find(c => c.is_primary) || contacts[0];
        if (primaryContact && primaryContact.name && primaryContact.name !== 'Manager') {
          lead.contact = primaryContact.name;
          lead.mgmtCo = null; // Clear mgmt co since we have a real name
        } else if (p.contact_name && p.contact_name !== 'Manager') {
          lead.contact = p.contact_name;
          lead.mgmtCo = null;
        }
      }
      
      // Find email 0 sent date from activities or tracking
      let email0SentDate = null;
      const emailActivities = activities.filter(a => 
        a.prospect_id === lead.pid && 
        (a.type === 'email') && 
        (a.description || '').toLowerCase().includes('email 0')
      );
      if (emailActivities.length > 0) {
        email0SentDate = emailActivities[0].date || emailActivities[0].created_at;
      }
      // Also check tracking
      if (!email0SentDate && tracking.length > 0) {
        const firstSent = tracking.find(t => t.sent_at);
        if (firstSent) email0SentDate = firstSent.sent_at;
      }
      // Also check for "Sent Proposal" activity
      if (!email0SentDate) {
        const proposalAct = activities.find(a => 
          a.prospect_id === lead.pid && 
          a.type === 'email' && 
          ((a.description || '').toLowerCase().includes('sent proposal') || (a.description || '').toLowerCase().includes('proposal'))
        );
        if (proposalAct) email0SentDate = proposalAct.date || proposalAct.created_at;
      }

      // Determine status
      let status = 'active';
      const hasReply = tracking.some(t => t.was_replied);
      const hasBounce = tracking.some(t => t.was_bounced);
      const hasOpen = tracking.some(t => (t.num_opens || 0) > 0 && !t.last_event_is_internal);
      
      if (hasReply) { status = 'replied'; totalReplied++; }
      else if (hasBounce) { status = 'bounced'; totalBounced++; }
      
      if (email0SentDate || tracking.length > 0) totalSent++;
      if (hasOpen) totalOpened++;

      const tr = document.createElement('tr');
      
      // Lead name
      const tdName = document.createElement('td');
      tdName.className = 'lead-name';
      tdName.innerHTML = `<a href="/prospect/${lead.pid}">${lead.name}</a>`;
      tr.appendChild(tdName);

      // Contact
      const tdContact = document.createElement('td');
      if (lead.mgmtCo && lead.contact === 'Property Manager') {
        tdContact.innerHTML = '<span style="color:#64748b;">PM</span> <span style="font-size:11px;color:#94a3b8;">(' + lead.mgmtCo + ')</span>';
      } else {
        tdContact.textContent = lead.contact;
      }
      tdContact.style.fontSize = '12px';
      tr.appendChild(tdContact);

      // Email
      const tdEmail = document.createElement('td');
      tdEmail.className = 'email-addr';
      tdEmail.textContent = lead.email;
      tr.appendChild(tdEmail);

      // Email steps 0-5
      for (let step = 0; step <= 5; step++) {
        tr.appendChild(makeCell(step, tracking, email0SentDate));
      }

      // Opens column ‚Äî individual timestamped opens (exclude internal/Jordan)
      const tdOpens = document.createElement('td');
      // Collect opens from prospect.email_events + instantlyEvents
      const prospectEvents = (p.email_events || []).filter(e => e.type === 'email_opened');
      const instantlyEvts = allEvents.filter(e => e.prospect_id === lead.pid && e.event_type === 'email_opened' && !isInternal(e.opener_email));
      // Merge & dedupe by timestamp
      const allOpens = [];
      const seenTs = new Set();
      [...prospectEvents, ...instantlyEvts].forEach(e => {
        const ts = e.timestamp;
        if (!ts || seenTs.has(ts)) return;
        if (isInternal(e.opener_email)) return; // exclude Jordan/team
        seenTs.add(ts);
        allOpens.push({ timestamp: ts, subject: e.subject || '', opener: e.opener_email || '' });
      });
      // Also count from tracking num_opens if no individual events
      const trackingOpens = tracking.reduce((s, t) => s + (t._adjusted_opens || t.num_opens || 0), 0);
      
      allOpens.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
      const openCount = allOpens.length || trackingOpens;
      
      if (openCount > 0) {
        tdOpens.innerHTML = `<span class="opens-toggle open-count" onclick="toggleOpens(${lead.pid})" title="Click to see details">üëÅ ${openCount}x</span>`;
        tdOpens.style.textAlign = 'center';
      } else {
        tdOpens.innerHTML = '<span class="no-opens">0</span>';
        tdOpens.style.textAlign = 'center';
      }
      tr.appendChild(tdOpens);

      // Status badge
      const tdStatus = document.createElement('td');
      tdStatus.innerHTML = `<span class="status-badge ${status}">${status}</span>`;
      tr.appendChild(tdStatus);

      tbody.appendChild(tr);

      // Expandable opens detail row
      if (allOpens.length > 0) {
        const opensRow = document.createElement('tr');
        opensRow.id = 'opens-' + lead.pid;
        opensRow.className = 'opens-row';
        opensRow.style.display = 'none';
        const opensCell = document.createElement('td');
        opensCell.colSpan = 12;
        let opensHtml = '<div class="opens-detail"><strong>üìä Email Opens (excluding internal team)</strong>';
        allOpens.forEach((o, i) => {
          opensHtml += `<div class="open-event">
            <span class="open-count">#${i + 1}</span>
            <span class="open-ts">${fmtFullDateTime(o.timestamp)}</span>
            <span class="open-subject">${o.subject ? o.subject.substring(0, 60) : ''}</span>
          </div>`;
        });
        opensHtml += '</div>';
        opensCell.innerHTML = opensHtml;
        opensRow.appendChild(opensCell);
        tbody.appendChild(opensRow);
      }
    }

    // Update stats
    document.getElementById('statLeads').textContent = CAMPAIGN_LEADS.length;
    document.getElementById('statSent').textContent = totalSent;
    document.getElementById('statOpened').textContent = totalOpened;
    document.getElementById('statOpenRate').textContent = totalSent > 0 ? Math.round(totalOpened / totalSent * 100) + '%' : '‚Äî';
    document.getElementById('statReplied').textContent = totalReplied;
    document.getElementById('statBounced').textContent = totalBounced;

    document.getElementById('loading').style.display = 'none';
    document.getElementById('campaignTable').style.display = 'table';
  } catch (err) {
    document.getElementById('loading').textContent = 'Error loading data: ' + err.message;
  }
}

loadData();
// Auto-refresh every 5 minutes
setInterval(loadData, 5 * 60 * 1000);
</script>
</body>
</html>
