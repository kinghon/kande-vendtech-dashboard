<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-vend-32.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-vend.png">
  <title>Route Planner ‚Äî Kande VendTech</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg: #f5f7fa; --card: #ffffff; --card-hover: #f7fafc; --border: #e2e8f0;
      --text: #1a202c; --muted: #718096; --accent: #3182ce; --accent-dim: rgba(49,130,206,0.1);
      --success: #38a169; --warn: #dd6b20; --hot: #e53e3e; --purple: #7b2cbf;
    }
    html, body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); overflow-x: hidden; width: 100%; max-width: 100vw; }
    body.kv-nav-active { padding-top: 0 !important; }

    .app { display: flex; height: 100vh; max-width: 100vw; overflow-x: hidden; padding-top: 52px; }

    /* ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ */
    .sidebar {
      width: 400px; background: var(--card); border-right: 1px solid var(--border);
      display: flex; flex-direction: column; overflow: hidden; flex-shrink: 0;
    }
    .sidebar-header {
      padding: 16px 18px; border-bottom: 1px solid var(--border);
      background: linear-gradient(135deg, rgba(49,130,206,0.08), rgba(123,44,191,0.06));
    }
    .sidebar-header h2 { font-size: 1.1rem; display: flex; align-items: center; gap: 8px; }
    .sidebar-header h2 span { background: linear-gradient(90deg, var(--accent), var(--purple)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .sidebar-subtitle { font-size: 0.78rem; color: var(--muted); margin-top: 4px; }
    .sidebar-content { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; }
    .sidebar-content::-webkit-scrollbar { width: 6px; }
    .sidebar-content::-webkit-scrollbar-track { background: transparent; }
    .sidebar-content::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

    /* ‚îÄ‚îÄ Sections ‚îÄ‚îÄ */
    .section { padding: 16px 18px; border-bottom: 1px solid var(--border); }
    .section-title { font-size: 0.78rem; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px; display: flex; align-items: center; gap: 6px; }

    /* Start location */
    .start-row { display: flex; gap: 8px; }
    .start-row input {
      flex: 1; padding: 10px 14px; border-radius: 8px; border: 1px solid var(--border);
      background: var(--bg); color: var(--text); font-size: 0.85rem; outline: none;
      transition: border-color 0.2s;
    }
    .start-row input:focus { border-color: var(--accent); }
    .icon-btn {
      width: 40px; height: 40px; border-radius: 8px; border: 1px solid var(--border);
      background: var(--bg); color: var(--accent); cursor: pointer; font-size: 1.1rem;
      display: flex; align-items: center; justify-content: center; transition: all 0.2s;
    }
    .icon-btn:hover { background: var(--accent-dim); border-color: var(--accent); }

    /* Search & filter */
    .search-row { display: flex; gap: 8px; margin-bottom: 10px; }
    .search-row input, .search-row select {
      padding: 8px 12px; border-radius: 8px; border: 1px solid var(--border);
      background: var(--bg); color: var(--text); font-size: 0.82rem; outline: none;
    }
    .search-row input { flex: 1; }
    .search-row input:focus { border-color: var(--accent); }
    .search-row select { min-width: 100px; }

    .select-all-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .select-all-row label { font-size: 0.8rem; color: var(--muted); cursor: pointer; display: flex; align-items: center; gap: 6px; }
    .select-all-row .count { font-size: 0.75rem; color: var(--accent); }

    /* Location list */
    .location-list { max-height: 320px; overflow-y: auto; }
    .location-list::-webkit-scrollbar { width: 5px; }
    .location-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

    .loc-item {
      display: flex; align-items: center; gap: 10px; padding: 10px 8px;
      border-radius: 8px; cursor: pointer; transition: background 0.15s;
      border-bottom: 1px solid rgba(0,0,0,0.03);
    }
    .loc-item:hover { background: var(--card-hover); }
    .loc-item input[type=checkbox] {
      accent-color: var(--accent); width: 16px; height: 16px; cursor: pointer;
    }
    .loc-info { flex: 1; min-width: 0; }
    .loc-name { font-size: 0.85rem; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .loc-address { font-size: 0.72rem; color: var(--muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .loc-badge {
      padding: 2px 8px; border-radius: 10px; font-size: 0.68rem; font-weight: 600;
      white-space: nowrap; flex-shrink: 0;
    }
    .loc-badge.signed { background: rgba(34,197,94,0.15); color: var(--success); }
    .loc-badge.machines { background: var(--accent-dim); color: var(--accent); }

    /* Selected stops */
    .stop-list { min-height: 40px; }
    .stop-item {
      display: flex; align-items: center; gap: 10px; padding: 10px 8px;
      border-radius: 8px; background: var(--bg); margin-bottom: 6px;
      border: 1px solid var(--border); transition: all 0.2s;
    }
    .stop-item:hover { border-color: rgba(49,130,206,0.2); }
    .stop-num {
      width: 28px; height: 28px; border-radius: 50%; background: var(--accent);
      color: var(--bg); display: flex; align-items: center; justify-content: center;
      font-size: 0.78rem; font-weight: 800; flex-shrink: 0;
    }
    .stop-info { flex: 1; min-width: 0; }
    .stop-name { font-size: 0.85rem; font-weight: 500; }
    .stop-addr { font-size: 0.72rem; color: var(--muted); }
    .stop-remove {
      background: none; border: none; color: var(--hot); cursor: pointer;
      font-size: 1.1rem; padding: 4px; opacity: 0.6; transition: opacity 0.15s;
    }
    .stop-remove:hover { opacity: 1; }

    .empty-stops { text-align: center; padding: 20px; color: var(--muted); font-size: 0.82rem; }

    /* Action buttons */
    .action-group { display: flex; flex-direction: column; gap: 8px; }
    .btn {
      padding: 12px 16px; border-radius: 10px; border: none; font-size: 0.88rem;
      font-weight: 600; cursor: pointer; transition: all 0.2s; text-align: center;
      display: flex; align-items: center; justify-content: center; gap: 8px;
    }
    .btn-primary { background: var(--accent); color: #ffffff; }
    .btn-primary:hover { opacity: 0.9; transform: translateY(-1px); }
    .btn-primary:disabled { opacity: 0.3; cursor: not-allowed; transform: none; }
    .btn-secondary { background: var(--bg); color: var(--text); border: 1px solid var(--border); }
    .btn-secondary:hover { border-color: var(--accent); color: var(--accent); }
    .btn-success { background: rgba(34,197,94,0.15); color: var(--success); border: 1px solid rgba(34,197,94,0.3); }
    .btn-success:hover { background: rgba(34,197,94,0.25); }
    .btn-warn { background: rgba(245,158,11,0.15); color: var(--warn); border: 1px solid rgba(245,158,11,0.3); }
    .btn-warn:hover { background: rgba(245,158,11,0.25); }
    .btn-sm { padding: 8px 12px; font-size: 0.8rem; }
    .nav-btns { display: flex; gap: 8px; }
    .nav-btns .btn { flex: 1; }

    /* Route summary */
    .route-summary {
      background: linear-gradient(135deg, rgba(49,130,206,0.08), rgba(123,44,191,0.06));
      border-radius: 10px; padding: 14px; border: 1px solid var(--border);
    }
    .summary-title { font-size: 0.82rem; font-weight: 600; color: var(--accent); margin-bottom: 10px; display: flex; align-items: center; gap: 6px; }
    .summary-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .summary-stat { text-align: center; }
    .summary-stat .val { font-size: 1.3rem; font-weight: 700; }
    .summary-stat .val.accent { color: var(--accent); }
    .summary-stat .val.success { color: var(--success); }
    .summary-stat .val.warn { color: var(--warn); }
    .summary-stat .label { font-size: 0.7rem; color: var(--muted); margin-top: 2px; }

    /* Directions panel */
    .directions-panel { margin-top: 12px; }
    .direction-step {
      display: flex; gap: 10px; padding: 8px 0;
      border-bottom: 1px solid rgba(0,0,0,0.04); font-size: 0.82rem;
    }
    .direction-step:last-child { border-bottom: none; }
    .dir-icon { font-size: 1rem; flex-shrink: 0; width: 24px; text-align: center; }
    .dir-text { flex: 1; color: var(--text); line-height: 1.4; }
    .dir-dist { color: var(--muted); font-size: 0.75rem; flex-shrink: 0; text-align: right; }

    /* ‚îÄ‚îÄ Map ‚îÄ‚îÄ */
    .map-container { flex: 1; position: relative; }
    #map { width: 100%; height: 100%; background: var(--bg); }

    /* Leaflet dark theme overrides */
    .leaflet-popup-content-wrapper {
      background: var(--card); color: var(--text); border-radius: 10px;
      border: 1px solid var(--border); box-shadow: 0 8px 24px rgba(0,0,0,0.5);
    }
    .leaflet-popup-tip { background: var(--card); }
    .leaflet-popup-close-button { color: var(--muted) !important; }
    .leaflet-control-zoom a {
      background: var(--card) !important; color: var(--text) !important;
      border-color: var(--border) !important;
    }
    .leaflet-control-zoom a:hover { background: var(--card-hover) !important; }
    .leaflet-control-attribution { background: rgba(10,10,10,0.8) !important; color: var(--muted) !important; }
    .leaflet-control-attribution a { color: var(--accent) !important; }

    .popup-title { font-size: 0.9rem; font-weight: 700; margin-bottom: 4px; }
    .popup-addr { font-size: 0.78rem; color: var(--muted); margin-bottom: 6px; }
    .popup-machines { font-size: 0.78rem; color: var(--accent); margin-bottom: 4px; }
    .popup-btn {
      display: inline-block; padding: 4px 10px; border-radius: 6px; font-size: 0.72rem;
      text-decoration: none; cursor: pointer; margin-top: 6px; margin-right: 4px;
      border: 1px solid var(--border); color: var(--accent); background: var(--bg);
      transition: all 0.15s;
    }
    .popup-btn:hover { background: var(--accent-dim); border-color: var(--accent); }

    /* Loading */
    .loading-overlay {
      position: absolute; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(10,10,10,0.9); display: flex; align-items: center;
      justify-content: center; z-index: 2000;
    }
    .loading-overlay.hidden { display: none; }
    .loading-spinner { text-align: center; }
    .loading-spinner .icon { font-size: 2rem; animation: pulse 1.5s infinite; }
    .loading-spinner .text { font-size: 0.9rem; color: var(--muted); margin-top: 8px; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }

    /* Map legend */
    .map-legend {
      position: absolute; bottom: 20px; left: 20px; background: var(--card);
      border: 1px solid var(--border); border-radius: 10px; padding: 12px 16px;
      z-index: 1000; font-size: 0.75rem; box-shadow: 0 4px 16px rgba(0,0,0,0.4);
    }
    .legend-title { font-weight: 600; color: var(--muted); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.3px; font-size: 0.68rem; }
    .legend-item { display: flex; align-items: center; gap: 6px; margin: 4px 0; }
    .legend-dot { width: 10px; height: 10px; border-radius: 50%; }

    /* Responsive */
    @media (max-width: 900px) {
      .app { flex-direction: column-reverse; }
      .sidebar { width: 100%; max-height: 50vh; }
      .map-container { width: 100%; height: 50vh; }
      .map-legend { font-size: 0.65rem; padding: 6px 10px; bottom: 8px; left: 8px; }
      .summary-grid { grid-template-columns: 1fr 1fr; }
      .nav-btns { flex-direction: column; }
    }
    @media (max-width: 500px) {
      .sidebar { max-height: 55vh; }
      .map-container { height: 45vh; }
      .section { padding: 12px 14px; }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="sidebar">
      <div class="sidebar-header">
        <h2>üöõ <span>Restock Route Planner</span></h2>
        <div class="sidebar-subtitle">Select locations, optimize your route, and navigate</div>
      </div>

      <div class="sidebar-content">
        <!-- Start Location -->
        <div class="section">
          <div class="section-title">üìç Starting Location</div>
          <div class="start-row">
            <input type="text" id="startAddress" placeholder="Detecting your location...">
            <button class="icon-btn" onclick="useCurrentLocation()" title="Use current GPS">üìç</button>
          </div>
        </div>

        <!-- Location Selection -->
        <div class="section">
          <div class="section-title">üè¢ Select Restock Locations</div>
          <div class="search-row">
            <input type="text" id="locSearch" placeholder="Search locations..." oninput="renderLocationList()">
            <select id="locFilter" onchange="renderLocationList()">
              <option value="all">All Signed</option>
              <option value="with-machines">With Machines</option>
            </select>
          </div>
          <div class="select-all-row">
            <label><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"> Select All Visible</label>
            <span class="count" id="selectedCount">0 selected</span>
          </div>
          <div class="location-list" id="locationList"></div>
        </div>

        <!-- Selected Route Stops -->
        <div class="section">
          <div class="section-title">üó∫Ô∏è Route Stops <span id="stopCount" style="color:var(--accent);">(0)</span></div>
          <div class="stop-list" id="stopList">
            <div class="empty-stops">Select locations above to build your route</div>
          </div>
        </div>

        <!-- Actions -->
        <div class="section">
          <div class="action-group">
            <button class="btn btn-primary" id="btnOptimize" onclick="optimizeRoute()" disabled>
              üß† Optimize Route
            </button>
            <button class="btn btn-secondary" onclick="clearRoute()">üóëÔ∏è Clear Route</button>
          </div>
        </div>

        <!-- Route Summary (shown after optimization) -->
        <div class="section" id="summarySection" style="display:none;">
          <div class="route-summary">
            <div class="summary-title">üìä Route Summary</div>
            <div class="summary-grid">
              <div class="summary-stat">
                <div class="val accent" id="sumStops">0</div>
                <div class="label">Stops</div>
              </div>
              <div class="summary-stat">
                <div class="val success" id="sumDistance">‚Äî</div>
                <div class="label">Total Distance</div>
              </div>
              <div class="summary-stat">
                <div class="val warn" id="sumTime">‚Äî</div>
                <div class="label">Drive Time</div>
              </div>
              <div class="summary-stat">
                <div class="val accent" id="sumMachines">0</div>
                <div class="label">Machines</div>
              </div>
            </div>
          </div>

          <!-- Navigation buttons -->
          <div class="nav-btns" style="margin-top: 12px;">
            <button class="btn btn-success btn-sm" onclick="openGoogleMaps()">
              üó∫Ô∏è Google Maps
            </button>
            <button class="btn btn-warn btn-sm" onclick="openAppleMaps()">
              üçé Apple Maps
            </button>
          </div>

          <!-- Turn-by-turn directions -->
          <div class="directions-panel" id="directionsPanel"></div>
        </div>
      </div>
    </div>

    <div class="map-container">
      <div id="map"></div>
      <div class="map-legend">
        <div class="legend-title">Legend</div>
        <div class="legend-item"><div class="legend-dot" style="background:var(--accent)"></div> Selected Stop</div>
        <div class="legend-item"><div class="legend-dot" style="background:#38a169"></div> Available Location</div>
        <div class="legend-item"><div class="legend-dot" style="background:var(--muted)"></div> Not Selected</div>
      </div>
      <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner">
          <div class="icon">üöõ</div>
          <div class="text">Loading locations...</div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    /* ‚îÄ‚îÄ State ‚îÄ‚îÄ */
    let prospects = [];
    let locations = [];
    let machines = [];
    let selectedIds = new Set(); // prospect IDs
    let routeStops = [];         // ordered after optimization
    let markers = {};
    let routeLayer = null;
    let map;
    let startCoord = null;
    let lastRouteData = null;

    /* ‚îÄ‚îÄ Map init ‚îÄ‚îÄ */
    map = L.map('map', { zoomControl: true }).setView([36.12, -115.17], 12);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      attribution: '¬© OpenStreetMap ¬© CARTO', maxZoom: 20, subdomains: 'abcd'
    }).addTo(map);

    /* ‚îÄ‚îÄ Marker helpers ‚îÄ‚îÄ */
    function createIcon(color, size) {
      size = size || 24;
      return L.divIcon({
        className: '',
        html: `<div style="width:${size}px;height:${size}px;border-radius:50%;background:${color};border:2.5px solid rgba(0,0,0,0.7);box-shadow:0 2px 8px rgba(0,0,0,0.5);transition:transform 0.2s;"></div>`,
        iconSize: [size, size], iconAnchor: [size/2, size/2], popupAnchor: [0, -(size/2 + 2)]
      });
    }

    function createNumberIcon(num, color) {
      return L.divIcon({
        className: '',
        html: `<div style="width:34px;height:34px;border-radius:50%;background:${color};border:3px solid rgba(0,0,0,0.7);box-shadow:0 3px 10px rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;font-weight:800;font-size:14px;color:#0a0a0a;">${num}</div>`,
        iconSize: [34, 34], iconAnchor: [17, 17], popupAnchor: [0, -19]
      });
    }

    /* ‚îÄ‚îÄ Data loading ‚îÄ‚îÄ */
    async function loadData() {
      try {
        const [pRes, lRes, mRes] = await Promise.all([
          fetch('/api/prospects').then(r => r.json()),
          fetch('/api/locations').then(r => r.json()),
          fetch('/api/machines').then(r => r.json())
        ]);
        prospects = pRes;
        locations = lRes;
        machines = mRes;

        renderLocationList();
        renderMarkers();
        document.getElementById('loadingOverlay').classList.add('hidden');
      } catch (e) {
        console.error('Load failed:', e);
        document.getElementById('loadingOverlay').innerHTML =
          '<div class="loading-spinner"><div class="icon">‚ùå</div><div class="text">Failed to load data</div></div>';
      }
    }

    /* Get signed prospects with lat/lng */
    function getSignedLocations() {
      return prospects.filter(p => {
        return p.status === 'signed' && p.lat && p.lng;
      });
    }

    /* Get machine count for a prospect */
    function getMachineCount(prospectId) {
      // Check through locations linked to this prospect
      const prospectLocations = locations.filter(l => l.prospect_id === prospectId);
      let count = 0;
      prospectLocations.forEach(loc => {
        count += machines.filter(m => m.location_id === loc.id && m.status === 'deployed').length;
      });
      return count;
    }

    /* ‚îÄ‚îÄ Location List ‚îÄ‚îÄ */
    function renderLocationList() {
      const container = document.getElementById('locationList');
      const search = (document.getElementById('locSearch')?.value || '').toLowerCase();
      const filter = document.getElementById('locFilter')?.value || 'all';

      let locs = getSignedLocations();

      // Search filter
      if (search) {
        locs = locs.filter(p =>
          p.name.toLowerCase().includes(search) ||
          (p.address || '').toLowerCase().includes(search)
        );
      }

      // Machine filter
      if (filter === 'with-machines') {
        locs = locs.filter(p => getMachineCount(p.id) > 0);
      }

      // Sort: selected first, then by name
      locs.sort((a, b) => {
        const aS = selectedIds.has(a.id) ? 0 : 1;
        const bS = selectedIds.has(b.id) ? 0 : 1;
        if (aS !== bS) return aS - bS;
        return a.name.localeCompare(b.name);
      });

      container.innerHTML = locs.map(p => {
        const checked = selectedIds.has(p.id);
        const mc = getMachineCount(p.id);
        return `<div class="loc-item" onclick="toggleLocation(${p.id})">
          <input type="checkbox" ${checked ? 'checked' : ''} onclick="event.stopPropagation();toggleLocation(${p.id})">
          <div class="loc-info">
            <div class="loc-name">${p.name}</div>
            <div class="loc-address">${p.address || 'No address'}</div>
          </div>
          ${mc > 0 ? `<span class="loc-badge machines">${mc} üè≠</span>` : ''}
          <span class="loc-badge signed">Signed</span>
        </div>`;
      }).join('') || '<div class="empty-stops">No signed locations found</div>';

      updateSelectedCount();
    }

    function toggleLocation(prospectId) {
      if (selectedIds.has(prospectId)) {
        selectedIds.delete(prospectId);
      } else {
        selectedIds.add(prospectId);
      }
      renderLocationList();
      renderStopList();
      renderMarkers();
      updateOptimizeButton();
    }

    function toggleSelectAll() {
      const search = (document.getElementById('locSearch')?.value || '').toLowerCase();
      const filter = document.getElementById('locFilter')?.value || 'all';
      let locs = getSignedLocations();
      if (search) locs = locs.filter(p => p.name.toLowerCase().includes(search) || (p.address || '').toLowerCase().includes(search));
      if (filter === 'with-machines') locs = locs.filter(p => getMachineCount(p.id) > 0);

      const allSelected = locs.every(p => selectedIds.has(p.id));
      locs.forEach(p => {
        if (allSelected) selectedIds.delete(p.id);
        else selectedIds.add(p.id);
      });

      document.getElementById('selectAll').checked = !allSelected;
      renderLocationList();
      renderStopList();
      renderMarkers();
      updateOptimizeButton();
    }

    function updateSelectedCount() {
      document.getElementById('selectedCount').textContent = `${selectedIds.size} selected`;
      document.getElementById('stopCount').textContent = `(${selectedIds.size})`;
    }

    function updateOptimizeButton() {
      document.getElementById('btnOptimize').disabled = selectedIds.size < 2;
    }

    /* ‚îÄ‚îÄ Stop List ‚îÄ‚îÄ */
    function renderStopList() {
      const container = document.getElementById('stopList');

      // Use routeStops if we have an optimized route, otherwise build from selected
      const stops = routeStops.length > 0 ? routeStops :
        getSignedLocations().filter(p => selectedIds.has(p.id));

      if (stops.length === 0) {
        container.innerHTML = '<div class="empty-stops">Select locations above to build your route</div>';
        return;
      }

      container.innerHTML = stops.map((p, i) => `
        <div class="stop-item">
          <div class="stop-num">${i + 1}</div>
          <div class="stop-info">
            <div class="stop-name">${p.name}</div>
            <div class="stop-addr">${p.address || 'No address'}</div>
          </div>
          <button class="stop-remove" onclick="removeStop(${p.id})" title="Remove">‚úï</button>
        </div>
      `).join('');
    }

    function removeStop(prospectId) {
      selectedIds.delete(prospectId);
      routeStops = routeStops.filter(s => s.id !== prospectId);
      renderLocationList();
      renderStopList();
      renderMarkers();
      updateOptimizeButton();
    }

    function clearRoute() {
      selectedIds.clear();
      routeStops = [];
      lastRouteData = null;
      if (routeLayer) { map.removeLayer(routeLayer); routeLayer = null; }
      document.getElementById('summarySection').style.display = 'none';
      document.getElementById('directionsPanel').innerHTML = '';
      renderLocationList();
      renderStopList();
      renderMarkers();
      updateOptimizeButton();
    }

    /* ‚îÄ‚îÄ Markers ‚îÄ‚îÄ */
    function renderMarkers() {
      Object.values(markers).forEach(m => map.removeLayer(m));
      markers = {};
      const bounds = [];

      const signed = getSignedLocations();
      signed.forEach(p => {
        const isSelected = selectedIds.has(p.id);
        const routeIdx = routeStops.findIndex(s => s.id === p.id);
        let icon;

        if (routeStops.length > 0 && routeIdx >= 0) {
          icon = createNumberIcon(routeIdx + 1, '#3182ce');
        } else if (isSelected) {
          icon = createIcon('#3182ce', 28);
        } else {
          icon = createIcon('#38a169', 20);
        }

        const mc = getMachineCount(p.id);
        const popup = `<div style="min-width:200px;">
          <div class="popup-title">${p.name}</div>
          <div class="popup-addr">üìç ${p.address || 'No address'}</div>
          ${mc > 0 ? `<div class="popup-machines">üè≠ ${mc} machine${mc > 1 ? 's' : ''} deployed</div>` : ''}
          ${p.primary_contact ? `<div style="font-size:0.78rem;margin-bottom:4px;"><strong>Contact:</strong> ${p.primary_contact}</div>` : ''}
          ${p.phone ? `<div style="font-size:0.78rem;margin-bottom:4px;">üìû <a href="tel:${p.phone}" style="color:var(--accent);">${p.phone}</a></div>` : ''}
          <div>
            <a class="popup-btn" href="#" onclick="event.preventDefault();toggleLocation(${p.id});return false;">
              ${isSelected ? '‚úï Remove' : '+ Add to Route'}
            </a>
          </div>
        </div>`;

        const marker = L.marker([p.lat, p.lng], { icon }).addTo(map).bindPopup(popup, { maxWidth: 280 });
        markers[p.id] = marker;
        bounds.push([p.lat, p.lng]);
      });

      if (bounds.length > 0) map.fitBounds(bounds, { padding: [40, 40] });
    }

    /* ‚îÄ‚îÄ Route Optimization ‚îÄ‚îÄ */
    async function optimizeRoute() {
      if (selectedIds.size < 2) return;

      const btn = document.getElementById('btnOptimize');
      btn.disabled = true;
      btn.innerHTML = '‚è≥ Optimizing...';

      try {
        const stops = getSignedLocations().filter(p => selectedIds.has(p.id));
        let coords = [];

        // Geocode start address if provided
        const startAddr = document.getElementById('startAddress').value.trim();
        startCoord = null;
        if (startAddr) {
          try {
            const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(startAddr)}&limit=1`, {
              headers: { 'User-Agent': 'KandeVendTech/1.0' }
            });
            const data = await res.json();
            if (data.length > 0) {
              startCoord = { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) };
              coords.push(`${startCoord.lng},${startCoord.lat}`);
            }
          } catch(e) { console.warn('Geocode failed for start:', e); }
        }

        // Add stop coords
        stops.forEach(s => coords.push(`${s.lng},${s.lat}`));

        const coordStr = coords.join(';');
        const sourceParam = startCoord ? '&source=first' : '';

        // Use OSRM trip service for TSP optimization
        const url = `https://router.project-osrm.org/trip/v1/driving/${coordStr}?overview=full&geometries=geojson&steps=true${sourceParam}&roundtrip=false&destination=last`;

        let res = await fetch(url);
        let data = await res.json();

        if (data.code === 'Ok' && data.trips && data.trips[0]) {
          const trip = data.trips[0];
          const waypoints = data.waypoints;
          const offset = startCoord ? 1 : 0;

          // Reorder stops based on OSRM's optimized waypoint order
          const reordered = [];
          const wpOrder = waypoints.slice(offset).map((wp, i) => ({
            origIdx: i,
            optIdx: wp.waypoint_index - offset
          })).sort((a, b) => a.optIdx - b.optIdx);

          wpOrder.forEach(wp => {
            if (stops[wp.origIdx]) reordered.push(stops[wp.origIdx]);
          });

          routeStops = reordered;
          lastRouteData = trip;
          displayRoute(trip);
        } else {
          // Fallback: use route service (no optimization, just routing)
          const routeUrl = `https://router.project-osrm.org/route/v1/driving/${coordStr}?overview=full&geometries=geojson&steps=true`;
          res = await fetch(routeUrl);
          data = await res.json();

          if (data.code === 'Ok' && data.routes && data.routes[0]) {
            // Use nearest-neighbor for ordering
            routeStops = nearestNeighborSort(stops, startCoord);
            lastRouteData = data.routes[0];
            displayRoute(data.routes[0]);
          } else {
            alert('Could not calculate route. Check that all locations have valid addresses.');
          }
        }
      } catch (e) {
        console.error('Route optimization failed:', e);
        alert('Route optimization failed. Please try again.');
      }

      btn.disabled = selectedIds.size < 2;
      btn.innerHTML = 'üß† Optimize Route';
    }

    /* Nearest-neighbor TSP approximation */
    function nearestNeighborSort(stops, startPt) {
      if (stops.length <= 1) return [...stops];
      const sorted = [];
      const remaining = [...stops];

      // Start from point closest to start (or first stop)
      if (startPt) {
        remaining.sort((a, b) => {
          const dA = Math.pow(a.lat - startPt.lat, 2) + Math.pow(a.lng - startPt.lng, 2);
          const dB = Math.pow(b.lat - startPt.lat, 2) + Math.pow(b.lng - startPt.lng, 2);
          return dA - dB;
        });
      }

      sorted.push(remaining.shift());
      while (remaining.length > 0) {
        const last = sorted[sorted.length - 1];
        let closestIdx = 0, closestDist = Infinity;
        for (let i = 0; i < remaining.length; i++) {
          const d = Math.pow(remaining[i].lat - last.lat, 2) + Math.pow(remaining[i].lng - last.lng, 2);
          if (d < closestDist) { closestDist = d; closestIdx = i; }
        }
        sorted.push(remaining.splice(closestIdx, 1)[0]);
      }
      return sorted;
    }

    /* Display route on map */
    function displayRoute(route) {
      if (routeLayer) map.removeLayer(routeLayer);
      routeLayer = L.layerGroup();

      // Draw route polyline
      const coords = route.geometry.coordinates.map(c => [c[1], c[0]]);
      L.polyline(coords, {
        color: '#3182ce', weight: 4, opacity: 0.8,
        dashArray: null, lineCap: 'round', lineJoin: 'round'
      }).addTo(routeLayer);

      // Route glow effect
      L.polyline(coords, {
        color: '#3182ce', weight: 10, opacity: 0.15
      }).addTo(routeLayer);

      // Start marker
      if (startCoord) {
        L.marker([startCoord.lat, startCoord.lng], {
          icon: createNumberIcon('üè†', '#38a169')
        }).addTo(routeLayer).bindPopup('<div class="popup-title">üè† Start</div>');
      }

      // Numbered stop markers
      routeStops.forEach((s, i) => {
        const mc = getMachineCount(s.id);
        const popup = `<div style="min-width:200px;">
          <div class="popup-title">Stop ${i + 1}: ${s.name}</div>
          <div class="popup-addr">üìç ${s.address || ''}</div>
          ${mc > 0 ? `<div class="popup-machines">üè≠ ${mc} machine${mc > 1 ? 's' : ''}</div>` : ''}
          ${s.primary_contact ? `<div style="font-size:0.78rem;">Contact: ${s.primary_contact}</div>` : ''}
          ${s.phone ? `<div style="font-size:0.78rem;">üìû <a href="tel:${s.phone}" style="color:#3182ce;">${s.phone}</a></div>` : ''}
        </div>`;

        L.marker([s.lat, s.lng], { icon: createNumberIcon(i + 1, '#3182ce') })
          .addTo(routeLayer).bindPopup(popup, { maxWidth: 280 });
      });

      routeLayer.addTo(map);
      map.fitBounds(coords, { padding: [50, 50] });

      // Update summary
      const distMiles = (route.distance / 1609.34).toFixed(1);
      const totalMachines = routeStops.reduce((sum, s) => sum + getMachineCount(s.id), 0);

      document.getElementById('sumStops').textContent = routeStops.length;
      document.getElementById('sumDistance').textContent = `${distMiles} mi`;
      document.getElementById('sumTime').textContent = formatDuration(route.duration);
      document.getElementById('sumMachines').textContent = totalMachines;
      document.getElementById('summarySection').style.display = 'block';

      // Render turn-by-turn directions
      renderDirections(route);

      // Update stop list with optimized order
      renderStopList();

      // Remove old markers that overlap with route markers
      Object.values(markers).forEach(m => map.removeLayer(m));
      markers = {};
    }

    function formatDuration(seconds) {
      const hrs = Math.floor(seconds / 3600);
      const mins = Math.floor((seconds % 3600) / 60);
      if (hrs > 0) return `${hrs}h ${mins}m`;
      return `${mins} min`;
    }

    /* ‚îÄ‚îÄ Turn-by-turn Directions ‚îÄ‚îÄ */
    function renderDirections(route) {
      const panel = document.getElementById('directionsPanel');
      if (!route.legs) {
        panel.innerHTML = '';
        return;
      }

      let html = '<div class="section-title" style="margin-top:12px;">üìã Turn-by-Turn Directions</div>';
      let stepNum = 0;

      route.legs.forEach((leg, legIdx) => {
        // Leg header
        const legLabel = startCoord && legIdx === 0 ? 'From Start' : 
          `To Stop ${startCoord ? legIdx : legIdx + 1}`;
        const legDist = (leg.distance / 1609.34).toFixed(1);
        const legTime = formatDuration(leg.duration);
        
        html += `<div style="font-size:0.78rem;font-weight:600;color:var(--accent);padding:8px 0 4px;border-top:1px solid var(--border);margin-top:8px;">
          ${legLabel} ‚Äî ${legDist} mi, ${legTime}
        </div>`;

        if (leg.steps) {
          leg.steps.forEach(step => {
            stepNum++;
            const icon = getManeuverIcon(step.maneuver?.type, step.maneuver?.modifier);
            const dist = step.distance > 0 ? `${(step.distance / 1609.34).toFixed(1)} mi` : '';
            const streetName = step.name || '';

            if (step.maneuver?.type === 'depart' || step.maneuver?.type === 'arrive') {
              html += `<div class="direction-step">
                <div class="dir-icon">${step.maneuver?.type === 'depart' ? 'üöó' : 'üèÅ'}</div>
                <div class="dir-text">${step.maneuver?.type === 'depart' ? 'Depart' : 'Arrive'}${streetName ? ' on ' + streetName : ''}</div>
                <div class="dir-dist">${dist}</div>
              </div>`;
            } else {
              html += `<div class="direction-step">
                <div class="dir-icon">${icon}</div>
                <div class="dir-text">${formatInstruction(step)}</div>
                <div class="dir-dist">${dist}</div>
              </div>`;
            }
          });
        }
      });

      panel.innerHTML = html;
    }

    function getManeuverIcon(type, modifier) {
      if (type === 'turn' || type === 'new name' || type === 'end of road') {
        if (modifier?.includes('left')) return '‚¨ÖÔ∏è';
        if (modifier?.includes('right')) return '‚û°Ô∏è';
        if (modifier?.includes('straight')) return '‚¨ÜÔ∏è';
        if (modifier?.includes('uturn')) return '‚Ü©Ô∏è';
      }
      if (type === 'merge') return 'üîÄ';
      if (type === 'on ramp' || type === 'off ramp') return 'üõ£Ô∏è';
      if (type === 'fork') return 'üî±';
      if (type === 'roundabout' || type === 'rotary') return 'üîÑ';
      if (type === 'continue') return '‚¨ÜÔ∏è';
      return '‚¨ÜÔ∏è';
    }

    function formatInstruction(step) {
      const type = step.maneuver?.type || '';
      const mod = step.maneuver?.modifier || '';
      const name = step.name || 'the road';
      
      if (type === 'turn') {
        return `Turn ${mod} onto ${name}`;
      }
      if (type === 'new name') {
        return `Continue onto ${name}`;
      }
      if (type === 'merge') {
        return `Merge ${mod} onto ${name}`;
      }
      if (type === 'on ramp') {
        return `Take the ramp onto ${name}`;
      }
      if (type === 'off ramp') {
        return `Exit onto ${name}`;
      }
      if (type === 'fork') {
        return `Keep ${mod} onto ${name}`;
      }
      if (type === 'roundabout' || type === 'rotary') {
        return `At the roundabout, take exit onto ${name}`;
      }
      if (type === 'end of road') {
        return `At end of road, turn ${mod} onto ${name}`;
      }
      if (type === 'continue') {
        return `Continue on ${name}`;
      }
      return `Continue on ${name}`;
    }

    /* ‚îÄ‚îÄ Navigation Links ‚îÄ‚îÄ */
    function openGoogleMaps() {
      if (routeStops.length === 0) return;

      // Google Maps directions URL
      // Origin = start coord or first stop
      // Destination = last stop
      // Waypoints = intermediate stops
      let url = 'https://www.google.com/maps/dir/';

      if (startCoord) {
        url += `${startCoord.lat},${startCoord.lng}/`;
      }

      routeStops.forEach(s => {
        url += `${s.lat},${s.lng}/`;
      });

      window.open(url, '_blank');
    }

    function openAppleMaps() {
      if (routeStops.length === 0) return;

      // Apple Maps directions URL
      // saddr = starting address
      // daddr = destination (last stop)
      // waypoints via + separator
      let url = 'https://maps.apple.com/?';

      if (startCoord) {
        url += `saddr=${startCoord.lat},${startCoord.lng}&`;
      }

      // daddr supports multiple waypoints with "+" separator
      const daddr = routeStops.map(s => `${s.lat},${s.lng}`).join('+to:');
      url += `daddr=${daddr}&dirflg=d`;

      window.open(url, '_blank');
    }

    /* ‚îÄ‚îÄ Current location ‚îÄ‚îÄ */
    function useCurrentLocation() {
      if (!navigator.geolocation) {
        document.getElementById('startAddress').placeholder = 'Geolocation not available';
        return;
      }
      document.getElementById('startAddress').value = '';
      document.getElementById('startAddress').placeholder = 'Detecting...';

      navigator.geolocation.getCurrentPosition(async pos => {
        const lat = pos.coords.latitude, lng = pos.coords.longitude;
        try {
          const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`, {
            headers: { 'User-Agent': 'KandeVendTech/1.0' }
          });
          const data = await res.json();
          document.getElementById('startAddress').value =
            data.display_name?.split(',').slice(0, 3).join(',') || `${lat.toFixed(5)}, ${lng.toFixed(5)}`;
        } catch (e) {
          document.getElementById('startAddress').value = `${lat.toFixed(5)}, ${lng.toFixed(5)}`;
        }
      }, () => {
        document.getElementById('startAddress').placeholder = 'Could not detect ‚Äî enter address';
      }, { enableHighAccuracy: true, timeout: 10000 });
    }

    // Auto-detect on load
    useCurrentLocation();

    /* ‚îÄ‚îÄ Init ‚îÄ‚îÄ */
    loadData();
  </script>
  <script src="/nav.js"></script>
</body>
</html>
