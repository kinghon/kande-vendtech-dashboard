<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-vend-32.png">
  <title>Kande VendTech ‚Äî Operations</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg: #f5f5f7; --card: #ffffff; --border: #e2e8f0; --text: #1a202c;
      --muted: #718096; --accent: #3182ce; --hot: #e53e3e; --warn: #dd6b20;
      --success: #38a169; --purple: #7b2cbf; --radius: 12px;
    }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }
    .app { max-width: 1400px; margin: 0 auto; padding: 20px; }

    .page-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; flex-wrap: wrap; gap: 12px; }
    .page-header h1 { font-size: 1.6rem; font-weight: 700; display: flex; align-items: center; gap: 10px; }
    .page-header .date { font-size: 0.9rem; color: var(--muted); font-weight: 400; }
    .header-actions { display: flex; gap: 8px; }
    .btn { display: inline-flex; align-items: center; gap: 6px; padding: 10px 18px; border-radius: 8px; border: 1px solid var(--border); background: var(--card); color: var(--text); font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.15s; }
    .btn:hover { background: #f0f4f8; }
    .btn-primary { background: var(--accent); color: #fff; border-color: var(--accent); }
    .btn-sm { padding: 6px 12px; font-size: 0.78rem; }

    /* Hero Stats */
    .hero-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 28px; }
    .hero-card { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; position: relative; overflow: hidden; }
    .hero-card::after { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; }
    .hero-card.routes::after { background: var(--accent); }
    .hero-card.revenue::after { background: var(--success); }
    .hero-card.alerts::after { background: var(--hot); }
    .hero-card.packing::after { background: var(--purple); }
    .hero-card .value { font-size: 2.2rem; font-weight: 800; margin-bottom: 4px; }
    .hero-card .label { font-size: 0.8rem; color: var(--muted); }
    .hero-card .detail { font-size: 0.78rem; color: var(--muted); margin-top: 8px; }
    .hero-card .value.accent { color: var(--accent); }
    .hero-card .value.success { color: var(--success); }
    .hero-card .value.danger { color: var(--hot); }
    .hero-card .value.purple { color: var(--purple); }

    /* Grid Layout */
    .ops-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px; }
    @media (max-width: 900px) { .ops-grid { grid-template-columns: 1fr; } }

    /* Section Card */
    .section-card { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; }
    .section-header { padding: 14px 18px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
    .section-header h3 { font-size: 0.95rem; font-weight: 700; display: flex; align-items: center; gap: 8px; }
    .section-body { padding: 12px 18px; max-height: 400px; overflow-y: auto; }

    /* Route Status Cards */
    .route-status { display: flex; align-items: center; gap: 12px; padding: 10px 0; border-bottom: 1px solid var(--border); }
    .route-status:last-child { border-bottom: none; }
    .route-status .status-icon { width: 36px; height: 36px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1rem; flex-shrink: 0; }
    .status-icon.in-progress { background: rgba(49,130,206,0.1); }
    .status-icon.completed { background: rgba(56,161,105,0.1); }
    .status-icon.scheduled { background: rgba(113,128,150,0.1); }
    .route-status .info { flex: 1; }
    .route-status .info h4 { font-size: 0.85rem; font-weight: 600; }
    .route-status .info span { font-size: 0.75rem; color: var(--muted); }
    .progress-bar { width: 80px; height: 6px; background: #edf2f7; border-radius: 3px; overflow: hidden; }
    .progress-fill { height: 100%; border-radius: 3px; background: var(--accent); transition: width 0.3s; }
    .progress-fill.done { background: var(--success); }

    /* Machine Alert Cards */
    .alert-item { display: flex; align-items: center; gap: 10px; padding: 10px 0; border-bottom: 1px solid var(--border); }
    .alert-item:last-child { border-bottom: none; }
    .alert-icon { width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; flex-shrink: 0; }
    .alert-icon.low-stock { background: rgba(221,107,32,0.1); }
    .alert-icon.error { background: rgba(229,62,62,0.1); }
    .alert-icon.offline { background: rgba(113,128,150,0.1); }
    .alert-item .info { flex: 1; }
    .alert-item .info h4 { font-size: 0.82rem; font-weight: 600; }
    .alert-item .info span { font-size: 0.72rem; color: var(--muted); }
    .alert-severity { padding: 3px 8px; border-radius: 4px; font-size: 0.65rem; font-weight: 700; text-transform: uppercase; }
    .sev-high { background: rgba(229,62,62,0.1); color: var(--hot); }
    .sev-medium { background: rgba(221,107,32,0.1); color: var(--warn); }
    .sev-low { background: rgba(113,128,150,0.1); color: var(--muted); }

    /* Driver Map */
    #driverMap { height: 300px; border-radius: 0 0 var(--radius) var(--radius); z-index: 1; }

    /* Activity Feed */
    .activity-item { display: flex; gap: 10px; padding: 8px 0; border-bottom: 1px solid var(--border); font-size: 0.82rem; }
    .activity-item:last-child { border-bottom: none; }
    .activity-time { color: var(--muted); font-size: 0.72rem; white-space: nowrap; min-width: 50px; }
    .activity-text { flex: 1; }

    /* Packing Status */
    .pack-item { display: flex; align-items: center; gap: 12px; padding: 10px 0; border-bottom: 1px solid var(--border); }
    .pack-item:last-child { border-bottom: none; }
    .pack-item .info { flex: 1; }
    .pack-item .info h4 { font-size: 0.85rem; font-weight: 600; }
    .pack-item .info span { font-size: 0.75rem; color: var(--muted); }
    .pack-progress { width: 120px; }
    .pack-bar { height: 8px; background: #edf2f7; border-radius: 4px; overflow: hidden; margin-bottom: 2px; }
    .pack-bar-fill { height: 100%; background: var(--purple); border-radius: 4px; }
    .pack-pct { font-size: 0.72rem; color: var(--muted); text-align: right; }

    /* Revenue Snapshot */
    .rev-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border); }
    .rev-row:last-child { border-bottom: none; }
    .rev-row .label { font-size: 0.85rem; }
    .rev-row .val { font-weight: 700; }
    .rev-row .val.up { color: var(--success); }
    .rev-row .val.down { color: var(--hot); }

    .empty-state { text-align: center; padding: 24px; color: var(--muted); font-size: 0.85rem; }
    .refresh-note { text-align: center; color: var(--muted); font-size: 0.75rem; margin-top: 16px; }
  </style>
</head>
<body>
  <script src="/nav.js"></script>
  <div class="app">
    <div class="page-header">
      <h1>üìä Operations <span class="date" id="todayDate"></span></h1>
      <div class="header-actions">
        <button class="btn" onclick="loadOps()">üîÑ Refresh</button>
        <button class="btn btn-primary" onclick="location.href='/schedule'">üìÖ Schedule</button>
        <button class="btn" onclick="location.href='/routes'">üöõ Routes</button>
        <button class="btn" onclick="location.href='/warehouse'">üè≠ Warehouse</button>
      </div>
    </div>

    <!-- Hero Stats -->
    <div class="hero-stats">
      <div class="hero-card routes">
        <div class="value accent" id="heroRoutes">0/0</div>
        <div class="label">Routes Completed</div>
        <div class="detail" id="heroRoutesDetail">‚Äî</div>
      </div>
      <div class="hero-card revenue">
        <div class="value success" id="heroRevenue">$0</div>
        <div class="label">Today's Revenue</div>
        <div class="detail" id="heroRevenueDetail">‚Äî</div>
      </div>
      <div class="hero-card alerts">
        <div class="value danger" id="heroAlerts">0</div>
        <div class="label">Active Alerts</div>
        <div class="detail" id="heroAlertsDetail">‚Äî</div>
      </div>
      <div class="hero-card packing">
        <div class="value purple" id="heroPacking">‚Äî</div>
        <div class="label">Tomorrow's Packing</div>
        <div class="detail" id="heroPackingDetail">‚Äî</div>
      </div>
    </div>

    <!-- Main Grid -->
    <div class="ops-grid">
      <!-- Today's Routes -->
      <div class="section-card">
        <div class="section-header">
          <h3>üöõ Today's Routes</h3>
          <button class="btn btn-sm" onclick="location.href='/routes'">View All</button>
        </div>
        <div class="section-body" id="routesStatus"></div>
      </div>

      <!-- Machine Alerts -->
      <div class="section-card">
        <div class="section-header">
          <h3>‚ö†Ô∏è Machines Needing Attention</h3>
          <span class="btn btn-sm" id="alertCount">0</span>
        </div>
        <div class="section-body" id="machineAlerts"></div>
      </div>

      <!-- Driver Locations -->
      <div class="section-card" style="grid-column: span 2">
        <div class="section-header">
          <h3>üìç Driver Locations</h3>
          <span style="font-size:0.75rem;color:var(--muted)" id="lastGPS">Last updated: ‚Äî</span>
        </div>
        <div id="driverMap"></div>
      </div>

      <!-- Packing Status -->
      <div class="section-card">
        <div class="section-header">
          <h3>üì¶ Tomorrow's Packing</h3>
          <button class="btn btn-sm" onclick="location.href='/warehouse'">Warehouse</button>
        </div>
        <div class="section-body" id="packingStatus"></div>
      </div>

      <!-- Revenue Snapshot -->
      <div class="section-card">
        <div class="section-header">
          <h3>üí∞ Revenue Snapshot</h3>
        </div>
        <div class="section-body" id="revenueSnapshot"></div>
      </div>

      <!-- Activity Feed -->
      <div class="section-card" style="grid-column: span 2">
        <div class="section-header">
          <h3>üìù Activity Feed</h3>
        </div>
        <div class="section-body" id="activityFeed" style="max-height:300px"></div>
      </div>
    </div>

    <div class="refresh-note">Auto-refreshes every 60 seconds ¬∑ Data from today <span id="refreshTime"></span></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    let driverMap;
    let driverMarkers = [];

    document.getElementById('todayDate').textContent = '‚Äî ' + new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

    function initDriverMap() {
      driverMap = L.map('driverMap').setView([36.03, -115.05], 11);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap'
      }).addTo(driverMap);
    }

    async function loadOps() {
      try {
        const data = await fetch('/api/operations/dashboard').then(r => r.json());
        renderRoutesStatus(data.routes || {});
        renderMachineAlerts(data.alerts || []);
        renderDriverLocations(data.drivers || []);
        renderPackingStatus(data.packing || []);
        renderRevenueSnapshot(data.revenue || {});
        renderActivityFeed(data.activities || []);
        updateHeroStats(data);
      } catch(e) {
        console.error('Operations load error:', e);
      }
      document.getElementById('refreshTime').textContent = '¬∑ ' + new Date().toLocaleTimeString();
    }

    function updateHeroStats(data) {
      const routes = data.routes || {};
      const completed = routes.completed || 0;
      const total = routes.total || 0;
      const inProgress = routes.in_progress || 0;

      document.getElementById('heroRoutes').textContent = `${completed}/${total}`;
      document.getElementById('heroRoutesDetail').textContent = inProgress > 0 ? `${inProgress} in progress` : total > 0 ? 'All scheduled' : 'No routes today';

      const rev = data.revenue || {};
      document.getElementById('heroRevenue').textContent = '$' + (rev.today || 0).toLocaleString();
      const trend = rev.vs_yesterday || 0;
      document.getElementById('heroRevenueDetail').textContent = trend >= 0 ? `‚Üë $${trend} vs yesterday` : `‚Üì $${Math.abs(trend)} vs yesterday`;

      const alerts = (data.alerts || []).length;
      document.getElementById('heroAlerts').textContent = alerts;
      const high = (data.alerts || []).filter(a => a.severity === 'high').length;
      document.getElementById('heroAlertsDetail').textContent = high > 0 ? `${high} high priority` : alerts > 0 ? 'All medium/low' : 'All systems normal ‚úì';

      const packing = data.packing || [];
      if (packing.length > 0) {
        const totalItems = packing.reduce((s, p) => s + (p.total_items || 0), 0);
        const packedItems = packing.reduce((s, p) => s + (p.packed_items || 0), 0);
        const pct = totalItems > 0 ? Math.round(packedItems / totalItems * 100) : 0;
        document.getElementById('heroPacking').textContent = pct + '%';
        document.getElementById('heroPackingDetail').textContent = `${packedItems}/${totalItems} items packed`;
      } else {
        document.getElementById('heroPacking').textContent = '‚Äî';
        document.getElementById('heroPackingDetail').textContent = 'No packing lists';
      }
    }

    function renderRoutesStatus(routes) {
      const container = document.getElementById('routesStatus');
      const items = routes.items || [];

      if (items.length === 0) {
        container.innerHTML = '<div class="empty-state">No routes scheduled today</div>';
        return;
      }

      container.innerHTML = items.map(r => {
        const pct = r.total_stops > 0 ? Math.round((r.completed_stops || 0) / r.total_stops * 100) : 0;
        const statusClass = r.status === 'completed' ? 'completed' : r.status === 'in_progress' ? 'in-progress' : 'scheduled';
        const icon = r.status === 'completed' ? '‚úÖ' : r.status === 'in_progress' ? 'üöõ' : 'üìã';
        return `<div class="route-status">
          <div class="status-icon ${statusClass}">${icon}</div>
          <div class="info">
            <h4>${r.route_name || 'Route'}</h4>
            <span>${r.driver_name || 'Unassigned'} ¬∑ ${r.completed_stops || 0}/${r.total_stops || 0} stops</span>
          </div>
          <div>
            <div class="progress-bar"><div class="progress-fill ${pct===100?'done':''}" style="width:${pct}%"></div></div>
            <div style="font-size:0.7rem;text-align:right;color:var(--muted);margin-top:2px;">${pct}%</div>
          </div>
        </div>`;
      }).join('');
    }

    function renderMachineAlerts(alerts) {
      const container = document.getElementById('machineAlerts');
      document.getElementById('alertCount').textContent = alerts.length;

      if (alerts.length === 0) {
        container.innerHTML = '<div class="empty-state">‚úÖ All machines operating normally</div>';
        return;
      }

      container.innerHTML = alerts.map(a => {
        const iconClass = a.type === 'error' ? 'error' : a.type === 'offline' ? 'offline' : 'low-stock';
        const icon = a.type === 'error' ? '‚ùå' : a.type === 'offline' ? 'üì°' : 'üì¶';
        const sevClass = a.severity === 'high' ? 'sev-high' : a.severity === 'medium' ? 'sev-medium' : 'sev-low';
        return `<div class="alert-item">
          <div class="alert-icon ${iconClass}">${icon}</div>
          <div class="info">
            <h4>${a.machine_name || 'Machine'}</h4>
            <span>${a.description || a.type}</span>
          </div>
          <span class="alert-severity ${sevClass}">${a.severity || 'medium'}</span>
        </div>`;
      }).join('');
    }

    function renderDriverLocations(drivers) {
      driverMarkers.forEach(m => driverMap.removeLayer(m));
      driverMarkers = [];

      if (drivers.length === 0) {
        document.getElementById('lastGPS').textContent = 'No active drivers';
        return;
      }

      drivers.forEach(d => {
        if (!d.lat || !d.lng) return;
        const icon = L.divIcon({
          className: 'driver-marker',
          html: `<div style="width:36px;height:36px;border-radius:50%;background:${d.status==='active'?'#3182ce':'#718096'};color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;border:3px solid #fff;box-shadow:0 2px 8px rgba(0,0,0,0.3)">${(d.name||'?').charAt(0)}</div>`,
          iconSize: [36, 36],
          iconAnchor: [18, 18]
        });
        const marker = L.marker([d.lat, d.lng], { icon }).addTo(driverMap);
        marker.bindPopup(`<strong>${d.name}</strong><br>${d.status || 'active'}<br>Last: ${d.last_checkin || '‚Äî'}`);
        driverMarkers.push(marker);
      });

      const bounds = L.latLngBounds(drivers.filter(d => d.lat && d.lng).map(d => [d.lat, d.lng]));
      if (bounds.isValid()) driverMap.fitBounds(bounds.pad(0.3));
      document.getElementById('lastGPS').textContent = 'Last updated: ' + new Date().toLocaleTimeString();
    }

    function renderPackingStatus(packing) {
      const container = document.getElementById('packingStatus');
      if (packing.length === 0) {
        container.innerHTML = '<div class="empty-state">No packing lists for tomorrow</div>';
        return;
      }

      container.innerHTML = packing.map(p => {
        const pct = p.total_items > 0 ? Math.round((p.packed_items || 0) / p.total_items * 100) : 0;
        return `<div class="pack-item">
          <div class="info">
            <h4>üì¶ ${p.route_name || 'Route'}</h4>
            <span>${p.packed_items || 0}/${p.total_items || 0} items ¬∑ ${p.packer || 'No packer assigned'}</span>
          </div>
          <div class="pack-progress">
            <div class="pack-bar"><div class="pack-bar-fill" style="width:${pct}%"></div></div>
            <div class="pack-pct">${pct}%</div>
          </div>
        </div>`;
      }).join('');
    }

    function renderRevenueSnapshot(rev) {
      const container = document.getElementById('revenueSnapshot');
      const rows = [
        { label: "Today's Sales", val: '$' + (rev.today || 0).toLocaleString(), cls: '' },
        { label: 'Yesterday', val: '$' + (rev.yesterday || 0).toLocaleString(), cls: '' },
        { label: 'This Week', val: '$' + (rev.week || 0).toLocaleString(), cls: '' },
        { label: 'This Month', val: '$' + (rev.month || 0).toLocaleString(), cls: '' },
        { label: 'Transactions Today', val: (rev.transactions_today || 0).toLocaleString(), cls: '' },
        { label: 'Avg per Machine', val: '$' + (rev.avg_per_machine || 0).toFixed(0), cls: '' }
      ];

      container.innerHTML = rows.map(r => `
        <div class="rev-row">
          <span class="label">${r.label}</span>
          <span class="val ${r.cls}">${r.val}</span>
        </div>
      `).join('');
    }

    function renderActivityFeed(activities) {
      const container = document.getElementById('activityFeed');
      if (activities.length === 0) {
        container.innerHTML = '<div class="empty-state">No activity today yet</div>';
        return;
      }

      container.innerHTML = activities.slice(0, 30).map(a => {
        const time = a.time ? new Date(a.time).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }) : '';
        return `<div class="activity-item">
          <span class="activity-time">${time}</span>
          <span class="activity-text">${a.icon || 'üìù'} ${a.text}</span>
        </div>`;
      }).join('');
    }

    // Init
    initDriverMap();
    loadOps();

    // Auto-refresh every 60s
    setInterval(loadOps, 60000);
  </script>
</body>
</html>
